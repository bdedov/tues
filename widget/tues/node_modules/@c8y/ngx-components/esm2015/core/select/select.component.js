import * as tslib_1 from "tslib";
import { BsDropdownDirective } from 'ngx-bootstrap/dropdown';
import { gettext } from '../i18n/gettext';
import { Component, EventEmitter, HostListener, Input, Output, ViewChild } from '@angular/core';
let SelectComponent = class SelectComponent {
    constructor() {
        this.placeholder = gettext('Select item');
        this.applyLabel = gettext('Apply');
        this.onChange = new EventEmitter();
        this.textFilter = '';
        this.labelText = '';
        this.isOpen = false;
        this.filteredItems = [];
        this.searchFilter = null;
        this.sizeToShowFilter = 5;
        this.labelsForSelectAll = {
            all: gettext('All'),
            allFiltered: gettext('All filtered')
        };
        this.showAllLabel = false;
        this.itemsSelected = new Set();
        this.stopClicks = false;
    }
    preventClick(evt) {
        if (this.stopClicks) {
            evt.stopPropagation();
        }
        this.stopClicks = this.isOpen;
    }
    isOpenChange(isOpen) {
        this.isOpen = isOpen;
        if (isOpen) {
            this.updateSelected();
            this.searchFilter = null;
        }
        else {
            this.stopClicks = false;
        }
    }
    outterSelected(item) {
        const { selected } = this;
        let isSelected = () => false;
        if (typeof selected === 'function') {
            isSelected = selected;
        }
        else if (Array.isArray(selected)) {
            isSelected = (i) => selected.indexOf(i) > -1;
        }
        return isSelected(item);
    }
    isSelected(item) {
        return this.itemsSelected.has(item);
    }
    isAllItemsSelected() {
        return this.itemsSelected.size === this.items.length;
    }
    isAllFilteredSelected() {
        return this.itemsSelected.size === this.filteredItems.length;
    }
    applyChanges() {
        const selected = Array.from(this.itemsSelected.values());
        this.onChange.emit(selected);
        this.dropdown.hide();
    }
    selectAll(checked) {
        this.filteredItems.forEach(item => this.onChangeItem(checked, item));
    }
    onChangeItem(checked, item) {
        if (checked) {
            this.itemsSelected.add(item);
        }
        else {
            this.itemsSelected.delete(item);
        }
    }
    updateFiltered(term) {
        if (term) {
            const search = new RegExp(term, 'i');
            this.filteredItems = this.items.filter(({ name }) => search.test(name));
        }
        else {
            this.filteredItems = this.items;
        }
    }
    getSelectAllToggleStatus() {
        const label = this.getLabel();
        const checked = this.isAllSelected();
        const indeterminate = !checked && this.itemsSelected.size > 0;
        return { label, checked, indeterminate };
    }
    ngOnChanges(changes) {
        if (this.isOpen) {
            return;
        }
        if (changes.items || changes.selected || changes.applyLabel) {
            this.updateSelected();
            this.updateLabel();
            this.showAllLabel = this.isAllItemsSelected();
        }
    }
    updateLabel() {
        const outterSelected = this.items.filter(i => this.outterSelected(i));
        if (typeof this.selectedLabel === 'string') {
            this.labelText = this.selectedLabel;
        }
        else if (typeof this.selectedLabel === 'function') {
            this.labelText = this.selectedLabel(outterSelected);
        }
        else {
            this.labelText = outterSelected.map(({ name }) => name).join(', ');
        }
    }
    updateSelected() {
        const { itemsSelected, items } = this;
        itemsSelected.clear();
        items.forEach(item => {
            if (this.outterSelected(item)) {
                itemsSelected.add(item);
            }
        });
        this.filteredItems = items;
    }
    isAllSelected() {
        if (this.getLabel() === this.labelsForSelectAll.allFiltered) {
            return this.isAllFilteredSelected();
        }
        else {
            return this.isAllItemsSelected();
        }
    }
    getLabel() {
        return this.searchFilter ? this.labelsForSelectAll.allFiltered : this.labelsForSelectAll.all;
    }
};
tslib_1.__decorate([
    Input()
], SelectComponent.prototype, "placeholder", void 0);
tslib_1.__decorate([
    Input()
], SelectComponent.prototype, "selectedLabel", void 0);
tslib_1.__decorate([
    Input()
], SelectComponent.prototype, "applyLabel", void 0);
tslib_1.__decorate([
    Input()
], SelectComponent.prototype, "items", void 0);
tslib_1.__decorate([
    Input()
], SelectComponent.prototype, "selected", void 0);
tslib_1.__decorate([
    Output()
], SelectComponent.prototype, "onChange", void 0);
tslib_1.__decorate([
    ViewChild(BsDropdownDirective, { static: false })
], SelectComponent.prototype, "dropdown", void 0);
tslib_1.__decorate([
    HostListener('click', ['$event'])
], SelectComponent.prototype, "preventClick", null);
SelectComponent = tslib_1.__decorate([
    Component({
        selector: 'c8y-select',
        template: "<div\n  class=\"c8y-child-assets-selector  dropdown fit-h\"\n  (isOpenChange)=\"isOpenChange($event)\"\n  dropdown\n  #dropdown\n>\n  <button\n    type=\"button\"\n    class=\"btn dropdown-toggle c8y-dropdown\"\n    title=\"{{ labelText || placeholder | translate }}\"\n    dropdownToggle\n  >\n    <span class=\"text-truncate\" *ngIf=\"labelText\">\n      <ng-container *ngIf=\"showAllLabel\">{{ 'All' | translate }}</ng-container>\n      <ng-container *ngIf=\"!showAllLabel\">{{ labelText | translate }}</ng-container>\n    </span>\n    <span class=\"text-truncate text-muted\" *ngIf=\"!labelText\">\n      {{ placeholder | translate }}\n    </span>\n  </button>\n\n  <ul class=\"dropdown-menu multiselect-container\" *dropdownMenu>\n    <li *ngIf=\"items.length > sizeToShowFilter\" class=\"multiselect-item\">\n      <div class=\"input-group input-group-search\">\n        <input\n          type=\"search\"\n          class=\"form-control\"\n          placeholder=\"{{ 'Filter' | translate }}\u2026\"\n          (keyup)=\"updateFiltered($event.target.value)\"\n          [(ngModel)]=\"searchFilter\"\n        />\n        <span class=\"input-group-addon\">\n          <i class=\"fa fa-search\" *ngIf=\"!textFilter\"></i>\n          <i class=\"fa fa-times text-muted\" *ngIf=\"textFilter\" (click)=\"textFilter = ''\"></i>\n        </span>\n      </div>\n    </li>\n\n    <li class=\"multiselect-item\">\n      <label\n        [title]=\"getSelectAllToggleStatus().label\"\n        class=\"c8y-checkbox input-sm\"\n        ng-click=\"vm.toggleSelectAll(); $event.preventDefault()\"\n      >\n        <input\n          type=\"checkbox\"\n          [checked]=\"getSelectAllToggleStatus().checked\"\n          (change)=\"selectAll($event.target.checked)\"\n          [indeterminate]=\"getSelectAllToggleStatus().indeterminate\"\n          style=\"margin-top:0;\"\n        />\n        <span></span>\n        <span class=\"label-text \">\n          {{ getSelectAllToggleStatus().label }}\n        </span>\n      </label>\n    </li>\n\n    <li class=\"multiselect-item-container\">\n      <ul class=\"list-unstyled\">\n        <li class=\"multiselect-item\" *ngFor=\"let item of filteredItems\">\n          <label title=\"{{ item.name | translate }}\" class=\"c8y-checkbox input-sm text-truncate\">\n            <input\n              type=\"checkbox\"\n              [checked]=\"isSelected(item)\"\n              (change)=\"onChangeItem($event.target.checked, item)\"\n              style=\"margin-top:0\"\n            />\n            <span></span>\n            <span class=\"label-text \">\n              {{ item.name | translate }}\n            </span>\n          </label>\n        </li>\n      </ul>\n    </li>\n    <li class=\"divider\"></li>\n    <li>\n      <button\n        title=\"{{ applyLabel | translate }}\"\n        class=\"btn btn-primary btn-block\"\n        (click)=\"applyChanges()\"\n      >\n        {{ applyLabel | translate }}\n      </button>\n    </li>\n  </ul>\n</div>\n"
    })
], SelectComponent);
export { SelectComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL3NlbGVjdC9zZWxlY3QuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM3RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDMUMsT0FBTyxFQUNMLFNBQVMsRUFDVCxZQUFZLEVBQ1osWUFBWSxFQUNaLEtBQUssRUFFTCxNQUFNLEVBRU4sU0FBUyxFQUNWLE1BQU0sZUFBZSxDQUFDO0FBZXZCLElBQWEsZUFBZSxHQUE1QixNQUFhLGVBQWU7SUFKNUI7UUFLVyxnQkFBVyxHQUFXLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUU3QyxlQUFVLEdBQVcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBR3JDLGFBQVEsR0FBeUIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUU5RCxlQUFVLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLGNBQVMsR0FBRyxFQUFFLENBQUM7UUFDZixXQUFNLEdBQUcsS0FBSyxDQUFDO1FBQ2Ysa0JBQWEsR0FBVyxFQUFFLENBQUM7UUFDM0IsaUJBQVksR0FBRyxJQUFJLENBQUM7UUFDWCxxQkFBZ0IsR0FBVyxDQUFDLENBQUM7UUFDdEMsdUJBQWtCLEdBQVE7WUFDeEIsR0FBRyxFQUFFLE9BQU8sQ0FBQyxLQUFLLENBQUM7WUFDbkIsV0FBVyxFQUFFLE9BQU8sQ0FBQyxjQUFjLENBQUM7U0FDckMsQ0FBQztRQUNGLGlCQUFZLEdBQUcsS0FBSyxDQUFDO1FBQ2Isa0JBQWEsR0FBYyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3JDLGVBQVUsR0FBRyxLQUFLLENBQUM7SUEwSDdCLENBQUM7SUF2SEMsWUFBWSxDQUFDLEdBQUc7UUFDZCxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFD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Q0FBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQzttREFNakM7QUE1QlUsZUFBZTtJQUozQixTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsWUFBWTtRQUN0Qix5N0ZBQXNDO0tBQ3ZDLENBQUM7R0FDVyxlQUFlLENBOEkzQjtTQTlJWSxlQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQnNEcm9wZG93bkRpcmVjdGl2ZSB9IGZyb20gJ25neC1ib290c3RyYXAvZHJvcGRvd24nO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJy4uL2kxOG4vZ2V0dGV4dCc7XG5pbXBvcnQge1xuICBDb21wb25lbnQsXG4gIEV2ZW50RW1pdHRlcixcbiAgSG9zdExpc3RlbmVyLFxuICBJbnB1dCxcbiAgT25DaGFuZ2VzLFxuICBPdXRwdXQsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIFZpZXdDaGlsZFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuZXhwb3J0IGludGVyZmFjZSBJdGVtIHtcbiAgbmFtZTogc3RyaW5nO1xuICBfc2VsZWN0ZWQ/OiBib29sZWFuO1xuICBba2V5OiBzdHJpbmddOiBhbnk7XG59XG5cbmV4cG9ydCB0eXBlIHNlbGVjdGVkRnVuY3Rpb24gPSAoaXRlbTogSXRlbSkgPT4gYm9vbGVhbjtcbmV4cG9ydCB0eXBlIHNlbGVjdGVkTGFiZWxGdW5jdGlvbiA9IChpdGVtczogSXRlbVtdKSA9PiBzdHJpbmc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1zZWxlY3QnLFxuICB0ZW1wbGF0ZVVybDogJy4vc2VsZWN0LmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBTZWxlY3RDb21wb25lbnQgaW1wbGVtZW50cyBPbkNoYW5nZXMge1xuICBASW5wdXQoKSBwbGFjZWhvbGRlcjogc3RyaW5nID0gZ2V0dGV4dCgnU2VsZWN0IGl0ZW0nKTtcbiAgQElucHV0KCkgc2VsZWN0ZWRMYWJlbDogc3RyaW5nIHwgc2VsZWN0ZWRMYWJlbEZ1bmN0aW9uO1xuICBASW5wdXQoKSBhcHBseUxhYmVsOiBzdHJpbmcgPSBnZXR0ZXh0KCdBcHBseScpO1xuICBASW5wdXQoKSBpdGVtczogSXRlbVtdO1xuICBASW5wdXQoKSBzZWxlY3RlZDogSXRlbVtdIHwgc2VsZWN0ZWRGdW5jdGlvbjtcbiAgQE91dHB1dCgpIG9uQ2hhbmdlOiBFdmVudEVtaXR0ZXI8SXRlbVtdPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQFZpZXdDaGlsZChCc0Ryb3Bkb3duRGlyZWN0aXZlLCB7IHN0YXRpYzogZmFsc2UgfSkgZHJvcGRvd246IEJzRHJvcGRvd25EaXJlY3RpdmU7XG4gIHRleHRGaWx0ZXIgPSAnJztcbiAgbGFiZWxUZXh0ID0gJyc7XG4gIGlzT3BlbiA9IGZhbHNlO1xuICBmaWx0ZXJlZEl0ZW1zOiBJdGVtW10gPSBbXTtcbiAgc2VhcmNoRmlsdGVyID0gbnVsbDtcbiAgcmVhZG9ubHkgc2l6ZVRvU2hvd0ZpbHRlcjogbnVtYmVyID0gNTtcbiAgbGFiZWxzRm9yU2VsZWN0QWxsOiBhbnkgPSB7XG4gICAgYWxsOiBnZXR0ZXh0KCdBbGwnKSxcbiAgICBhbGxGaWx0ZXJlZDogZ2V0dGV4dCgnQWxsIGZpbHRlcmVkJylcbiAgfTtcbiAgc2hvd0FsbExhYmVsID0gZmFsc2U7XG4gIHByaXZhdGUgaXRlbXNTZWxlY3RlZDogU2V0PEl0ZW0+ID0gbmV3IFNldCgpO1xuICBwcml2YXRlIHN0b3BDbGlja3MgPSBmYWxzZTtcblxuICBASG9zdExpc3RlbmVyKCdjbGljaycsIFsnJGV2ZW50J10pXG4gIHByZXZlbnRDbGljayhldnQpIHtcbiAgICBpZiAodGhpcy5zdG9wQ2xpY2tzKSB7XG4gICAgICBldnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgfVxuICAgIHRoaXMuc3RvcENsaWNrcyA9IHRoaXMuaXNPcGVuO1xuICB9XG5cbiAgaXNPcGVuQ2hhbmdlKGlzT3BlbjogYm9vbGVhbikge1xuICAgIHRoaXMuaXNPcGVuID0gaXNPcGVuO1xuICAgIGlmIChpc09wZW4pIHtcbiAgICAgIHRoaXMudXBkYXRlU2VsZWN0ZWQoKTtcbiAgICAgIHRoaXMuc2VhcmNoRmlsdGVyID0gbnVsbDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zdG9wQ2xpY2tzID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgb3V0dGVyU2VsZWN0ZWQoaXRlbTogSXRlbSkge1xuICAgIGNvbnN0IHsgc2VsZWN0ZWQgfSA9IHRoaXM7XG4gICAgbGV0IGlzU2VsZWN0ZWQ6IGFueSA9ICgpID0+IGZhbHNlO1xuICAgIGlmICh0eXBlb2Ygc2VsZWN0ZWQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGlzU2VsZWN0ZWQgPSBzZWxlY3RlZDtcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoc2VsZWN0ZWQpKSB7XG4gICAgICBpc1NlbGVjdGVkID0gKGk6IEl0ZW0pID0+IHNlbGVjdGVkLmluZGV4T2YoaSkgPiAtMTtcbiAgICB9XG4gICAgcmV0dXJuIGlzU2VsZWN0ZWQoaXRlbSk7XG4gIH1cblxuICBpc1NlbGVjdGVkKGl0ZW06IEl0ZW0pIHtcbiAgICByZXR1cm4gdGhpcy5pdGVtc1NlbGVjdGVkLmhhcyhpdGVtKTtcbiAgfVxuXG4gIGlzQWxsSXRlbXNTZWxlY3RlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5pdGVtc1NlbGVjdGVkLnNpemUgPT09IHRoaXMuaXRlbXMubGVuZ3RoO1xuICB9XG5cbiAgaXNBbGxGaWx0ZXJlZFNlbGVjdGVkKCkge1xuICAgIHJldHVybiB0aGlzLml0ZW1zU2VsZWN0ZWQuc2l6ZSA9PT0gdGhpcy5maWx0ZXJlZEl0ZW1zLmxlbmd0aDtcbiAgfVxuXG4gIGFwcGx5Q2hhbmdlcygpIHtcbiAgICBjb25zdCBzZWxlY3RlZCA9IEFycmF5LmZyb20odGhpcy5pdGVtc1NlbGVjdGVkLnZhbHVlcygpKTtcbiAgICB0aGlzLm9uQ2hhbmdlLmVtaXQoc2VsZWN0ZWQpO1xuICAgIHRoaXMuZHJvcGRvd24uaGlkZSgpO1xuICB9XG5cbiAgc2VsZWN0QWxsKGNoZWNrZWQ6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmZpbHRlcmVkSXRlbXMuZm9yRWFjaChpdGVtID0+IHRoaXMub25DaGFuZ2VJdGVtKGNoZWNrZWQsIGl0ZW0pKTtcbiAgfVxuXG4gIG9uQ2hhbmdlSXRlbShjaGVja2VkOiBib29sZWFuLCBpdGVtOiBJdGVtKSB7XG4gICAgaWYgKGNoZWNrZWQpIHtcbiAgICAgIHRoaXMuaXRlbXNTZWxlY3RlZC5hZGQoaXRlbSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaXRlbXNTZWxlY3RlZC5kZWxldGUoaXRlbSk7XG4gICAgfVxuICB9XG5cbiAgdXBkYXRlRmlsdGVyZWQodGVybTogc3RyaW5nKSB7XG4gICAgaWYgKHRlcm0pIHtcbiAgICAgIGNvbnN0IHNlYXJjaCA9IG5ldyBSZWdFeHAodGVybSwgJ2knKTtcbiAgICAgIHRoaXMuZmlsdGVyZWRJdGVtcyA9IHRoaXMuaXRlbXMuZmlsdGVyKCh7IG5hbWUgfSkgPT4gc2VhcmNoLnRlc3QobmFtZSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmZpbHRlcmVkSXRlbXMgPSB0aGlzLml0ZW1zO1xuICAgIH1cbiAgfVxuXG4gIGdldFNlbGVjdEFsbFRvZ2dsZVN0YXR1cygpIHtcbiAgICBjb25zdCBsYWJlbCA9IHRoaXMuZ2V0TGFiZWwoKTtcbiAgICBjb25zdCBjaGVja2VkID0gdGhpcy5pc0FsbFNlbGVjdGVkKCk7XG4gICAgY29uc3QgaW5kZXRlcm1pbmF0ZSA9ICFjaGVja2VkICYmIHRoaXMuaXRlbXNTZWxlY3RlZC5zaXplID4gMDtcblxuICAgIHJldHVybiB7IGxhYmVsLCBjaGVja2VkLCBpbmRldGVybWluYXRlfTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAodGhpcy5pc09wZW4pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGNoYW5nZXMuaXRlbXMgfHwgY2hhbmdlcy5zZWxlY3RlZCB8fCBjaGFuZ2VzLmFwcGx5TGFiZWwpIHtcbiAgICAgIHRoaXMudXBkYXRlU2VsZWN0ZWQoKTtcbiAgICAgIHRoaXMudXBkYXRlTGFiZWwoKTtcbiAgICAgIHRoaXMuc2hvd0FsbExhYmVsID0gdGhpcy5pc0FsbEl0ZW1zU2VsZWN0ZWQoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUxhYmVsKCkge1xuICAgIGNvbnN0IG91dHRlclNlbGVjdGVkID0gdGhpcy5pdGVtcy5maWx0ZXIoaSA9PiB0aGlzLm91dHRlclNlbGVjdGVkKGkpKTtcbiAgICBpZiAodHlwZW9mIHRoaXMuc2VsZWN0ZWRMYWJlbCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHRoaXMubGFiZWxUZXh0ID0gdGhpcy5zZWxlY3RlZExhYmVsO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHRoaXMuc2VsZWN0ZWRMYWJlbCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhpcy5sYWJlbFRleHQgPSB0aGlzLnNlbGVjdGVkTGFiZWwob3V0dGVyU2VsZWN0ZWQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxhYmVsVGV4dCA9IG91dHRlclNlbGVjdGVkLm1hcCgoeyBuYW1lIH0pID0+IG5hbWUpLmpvaW4oJywgJyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVTZWxlY3RlZCgpIHtcbiAgICBjb25zdCB7IGl0ZW1zU2VsZWN0ZWQsIGl0ZW1zIH0gPSB0aGlzO1xuICAgIGl0ZW1zU2VsZWN0ZWQuY2xlYXIoKTtcbiAgICBpdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgaWYgKHRoaXMub3V0dGVyU2VsZWN0ZWQoaXRlbSkpIHtcbiAgICAgICAgaXRlbXNTZWxlY3RlZC5hZGQoaXRlbSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5maWx0ZXJlZEl0ZW1zID0gaXRlbXM7XG4gIH1cblxuICBwcml2YXRlIGlzQWxsU2VsZWN0ZWQoKSB7XG4gICAgaWYgKHRoaXMuZ2V0TGFiZWwoKSA9PT0gdGhpcy5sYWJlbHNGb3JTZWxlY3RBbGwuYWxsRmlsdGVyZWQpIHtcbiAgICAgIHJldHVybiB0aGlzLmlzQWxsRmlsdGVyZWRTZWxlY3RlZCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5pc0FsbEl0ZW1zU2VsZWN0ZWQoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldExhYmVsKCkge1xuICAgIHJldHVybiB0aGlzLnNlYXJjaEZpbHRlciA/IHRoaXMubGFiZWxzRm9yU2VsZWN0QWxsLmFsbEZpbHRlcmVkIDogdGhpcy5sYWJlbHNGb3JTZWxlY3RBbGwuYWxsO1xuICB9XG59XG4iXX0=