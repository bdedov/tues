import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { InventoryService, IManagedObject, OperationStatus, IOperation } from '@c8y/client';
import { gettext } from '@c8y/ngx-components';
import { RepositoryService } from '../repository.service';
import { AlertService } from '@c8y/ngx-components';
import { DeviceConfigurationOperation } from '../repository.model';
import { DeviceConfigurationService } from './device-configuration.service';
let TextBasedConfigurationComponent = class TextBasedConfigurationComponent {
    constructor(route, alertService, repositoryService, deviceConfigurationService, inventoryService) {
        this.route = route;
        this.alertService = alertService;
        this.repositoryService = repositoryService;
        this.deviceConfigurationService = deviceConfigurationService;
        this.inventoryService = inventoryService;
        this.reloadingConfig = false;
        this.savingConfig = false;
    }
    ngOnInit() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.device = this.route.snapshot.parent.data.contextData;
            yield this.loadOperation();
            this.showTextBasedConfigReload = this.deviceConfigurationService.hasAnySupportedOperation(this.device, [DeviceConfigurationOperation.SEND_CONFIG]);
            this.showTextBasedConfigSave = this.deviceConfigurationService.hasAnySupportedOperation(this.device, [DeviceConfigurationOperation.CONFIG]);
            if (this.device.c8y_Configuration && this.device.c8y_Configuration.config) {
                this.config = this.device.c8y_Configuration.config;
            }
        });
    }
    loadOperation() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const operation = yield this.repositoryService.getLastConfigUpdateOperation(this.device.id);
            if (operation !== null) {
                this.repositoryService.observeOperation(operation).subscribe(operationUpdate => {
                    this.latestOperation = operationUpdate;
                });
            }
        });
    }
    reloadConfiguration() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.reloadingConfig = true;
            const operationCfg = yield this.repositoryService.createTextBasedConfigurationReloadOperation(this.device);
            try {
                this.repositoryService
                    .createObservedOperation(operationCfg)
                    .subscribe(operationUpdate => this.onOperationReloadSuccess(operationUpdate), operationUpdate => this.onOperationReloadError(operationUpdate), () => this.onOperationReloadComplete());
            }
            catch (ex) {
                this.alertService.addServerFailure(ex);
            }
        });
    }
    updateConfiguration(config) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.savingConfig = true;
            const operationCfg = yield this.repositoryService.createTextBasedConfigurationUpdateOperation(this.device, config);
            try {
                this.repositoryService
                    .createObservedOperation(operationCfg)
                    .subscribe(operationUpdate => this.onOperationUpdateSuccess(operationUpdate), operationUpdate => this.onOperationUpdateError(operationUpdate), () => this.onOperationUpdateComplete());
            }
            catch (ex) {
                this.alertService.addServerFailure(ex);
            }
        });
    }
    onOperationReloadSuccess(operationUpdate) {
        this.latestOperation = operationUpdate;
        if (operationUpdate.status === OperationStatus.PENDING) {
            this.alertService.success(gettext('Configuration will be reloaded.'));
        }
    }
    onOperationReloadError(operationUpdate) {
        this.latestOperation = operationUpdate;
        this.reloadingConfig = false;
    }
    onOperationReloadComplete() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            yield this.loadDevice();
            this.config = this.device.c8y_Configuration.config;
            this.reloadingConfig = false;
        });
    }
    onOperationUpdateSuccess(operationUpdate) {
        this.latestOperation = operationUpdate;
        if (operationUpdate.status === OperationStatus.PENDING) {
            this.alertService.success(gettext('Configuration will be updated.'));
        }
    }
    onOperationUpdateError(operationUpdate) {
        this.latestOperation = operationUpdate;
        this.savingConfig = false;
    }
    onOperationUpdateComplete() {
        this.device.c8y_Configuration.config = this.config;
        this.savingConfig = false;
    }
    loadDevice() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.device = (yield this.inventoryService.detail(this.device.id, { withChildren: false })).data;
        });
    }
};
TextBasedConfigurationComponent.ctorParameters = () => [
    { type: ActivatedRoute },
    { type: AlertService },
    { type: RepositoryService },
    { type: DeviceConfigurationService },
    { type: InventoryService }
];
TextBasedConfigurationComponent = tslib_1.__decorate([
    Component({
        selector: 'c8y-text-based-configuration',
        template: "<div class=\"d-flex d-col fit-v\">\n  <fieldset *ngIf=\"latestOperation !== undefined\" class=\"card-block bg-gray-white fit-h\">\n    <div class=\"content-flex-50\">\n      <c8y-single-operation [operation]=\"latestOperation\" class=\"flex-grow\"></c8y-single-operation>\n      <div class=\"flex-item-right d-flex\">\n        <button\n          title=\"{{ 'Get snapshot from device' | translate }}\"\n          type=\"button\"\n          class=\"btn btn-default btn-sm flex-item-v-center m-t-8 m-b-8\"\n          *ngIf=\"showTextBasedConfigReload\"\n          (click)=\"reloadConfiguration()\"\n          [disabled]=\"reloadingConfig || savingConfig\"\n        >\n          <i\n            c8yIcon=\"refresh\"\n            *ngIf=\"reloadingConfig\"\n            class=\"m-r-4\"\n            [ngClass]=\"{ 'fa-spin': reloadingConfig }\"\n          ></i>\n          <i c8yIcon=\"download\" *ngIf=\"!reloadingConfig\" class=\"m-r-4\"></i>\n\n          {{ 'Get snapshot from device' | translate }}\n        </button>\n      </div>\n    </div>\n  </fieldset>\n  <div class=\"card-block flex-grow\">\n    <textarea\n      [(ngModel)]=\"config\"\n      style=\"height: 100%;\"\n      class=\"form-control\"\n      [disabled]=\"reloadingConfig || savingConfig\"\n      c8y-spellcheck=\"false\"\n    ></textarea>\n  </div>\n  <div class=\"card-footer fit-h separator\" *ngIf=\"showTextBasedConfigSave\">\n    <button\n      type=\"button\"\n      (click)=\"updateConfiguration(config)\"\n      [disabled]=\"reloadingConfig || savingConfig\"\n      class=\"btn btn-primary\"\n      [ngClass]=\"{ 'btn-pending': savingConfig }\"\n    >\n      <span title=\"{{ 'Send' | translate }}\" *ngIf=\"!savingConfig\">\n        {{ 'Send configuration to device' | translate }}\n      </span>\n      <span title=\"{{ 'Sending' | translate }}\u2026\" *ngIf=\"savingConfig\">\n        {{ 'Sending' | translate }}\u2026</span\n      >\n    </button>\n  </div>\n</div>\n"
    })
], TextBasedConfigurationComponent);
export { TextBasedConfigurationComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dC1iYXNlZC1jb25maWd1cmF0aW9uLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvcmVwb3NpdG9yeS8iLCJzb3VyY2VzIjpbImNvbmZpZ3VyYXRpb24tZGV2aWNlLXRhYi90ZXh0LWJhc2VkLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBQ2xELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsY0FBYyxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDNUYsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzFELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQU01RSxJQUFhLCtCQUErQixHQUE1QyxNQUFhLCtCQUErQjtJQVMxQyxZQUNVLEtBQXFCLEVBQ3JCLFlBQTBCLEVBQzFCLGlCQUFvQyxFQUNwQywwQkFBc0QsRUFDdEQsZ0JBQWtDO1FBSmxDLFVBQUssR0FBTCxLQUFLLENBQWdCO1FBQ3JCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMsK0JBQTBCLEdBQTFCLDBCQUEwQixDQUE0QjtRQUN0RCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBVDVDLG9CQUFlLEdBQUcsS0FBSyxDQUFDO1FBQ3hCLGlCQUFZLEdBQUcsS0FBSyxDQUFDO0lB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QUssQ0FBQztJQUM1QixDQUFDO0lBRWEsVUFBVTs7WUFDdEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ25HLENBQUM7S0FBQTtDQUNGLENBQUE7O1lBM0drQixjQUFjO1lBQ1AsWUFBWTtZQUNQLGlCQUFpQjtZQUNSLDBCQUEwQjtZQUNwQyxnQkFBZ0I7O0FBZGpDLCtCQUErQjtJQUozQyxTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsOEJBQThCO1FBQ3hDLHE2REFBd0Q7S0FDekQsQ0FBQztHQUNXLCtCQUErQixDQXFIM0M7U0FySFksK0JBQStCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IEludmVudG9yeVNlcnZpY2UsIElNYW5hZ2VkT2JqZWN0LCBPcGVyYXRpb25TdGF0dXMsIElPcGVyYXRpb24gfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5U2VydmljZSB9IGZyb20gJy4uL3JlcG9zaXRvcnkuc2VydmljZSc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IERldmljZUNvbmZpZ3VyYXRpb25PcGVyYXRpb24gfSBmcm9tICcuLi9yZXBvc2l0b3J5Lm1vZGVsJztcbmltcG9ydCB7IERldmljZUNvbmZpZ3VyYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9kZXZpY2UtY29uZmlndXJhdGlvbi5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXRleHQtYmFzZWQtY29uZmlndXJhdGlvbicsXG4gIHRlbXBsYXRlVXJsOiAnLi90ZXh0LWJhc2VkLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFRleHRCYXNlZENvbmZpZ3VyYXRpb25Db21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0O1xuICBsYXRlc3RPcGVyYXRpb246IElPcGVyYXRpb247XG4gIHNob3dUZXh0QmFzZWRDb25maWdSZWxvYWQ6IGJvb2xlYW47XG4gIHNob3dUZXh0QmFzZWRDb25maWdTYXZlOiBib29sZWFuO1xuICByZWxvYWRpbmdDb25maWcgPSBmYWxzZTtcbiAgc2F2aW5nQ29uZmlnID0gZmFsc2U7XG4gIGNvbmZpZzogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcm91dGU6IEFjdGl2YXRlZFJvdXRlLFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5U2VydmljZTogUmVwb3NpdG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBkZXZpY2VDb25maWd1cmF0aW9uU2VydmljZTogRGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlXG4gICkge31cblxuICBhc3luYyBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmRldmljZSA9IHRoaXMucm91dGUuc25hcHNob3QucGFyZW50LmRhdGEuY29udGV4dERhdGE7XG4gICAgYXdhaXQgdGhpcy5sb2FkT3BlcmF0aW9uKCk7XG4gICAgdGhpcy5zaG93VGV4dEJhc2VkQ29uZmlnUmVsb2FkID0gdGhpcy5kZXZpY2VDb25maWd1cmF0aW9uU2VydmljZS5oYXNBbnlTdXBwb3J0ZWRPcGVyYXRpb24oXG4gICAgICB0aGlzLmRldmljZSxcbiAgICAgIFtEZXZpY2VDb25maWd1cmF0aW9uT3BlcmF0aW9uLlNFTkRfQ09ORklHXVxuICAgICk7XG4gICAgdGhpcy5zaG93VGV4dEJhc2VkQ29uZmlnU2F2ZSA9IHRoaXMuZGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2UuaGFzQW55U3VwcG9ydGVkT3BlcmF0aW9uKFxuICAgICAgdGhpcy5kZXZpY2UsXG4gICAgICBbRGV2aWNlQ29uZmlndXJhdGlvbk9wZXJhdGlvbi5DT05GSUddXG4gICAgKTtcbiAgICBpZiAodGhpcy5kZXZpY2UuYzh5X0NvbmZpZ3VyYXRpb24gJiYgdGhpcy5kZXZpY2UuYzh5X0NvbmZpZ3VyYXRpb24uY29uZmlnKSB7XG4gICAgICB0aGlzLmNvbmZpZyA9IHRoaXMuZGV2aWNlLmM4eV9Db25maWd1cmF0aW9uLmNvbmZpZztcbiAgICB9XG4gIH1cblxuICBhc3luYyBsb2FkT3BlcmF0aW9uKCkge1xuICAgIGNvbnN0IG9wZXJhdGlvbiA9IGF3YWl0IHRoaXMucmVwb3NpdG9yeVNlcnZpY2UuZ2V0TGFzdENvbmZpZ1VwZGF0ZU9wZXJhdGlvbih0aGlzLmRldmljZS5pZCk7XG4gICAgaWYgKG9wZXJhdGlvbiAhPT0gbnVsbCkge1xuICAgICAgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5vYnNlcnZlT3BlcmF0aW9uKG9wZXJhdGlvbikuc3Vic2NyaWJlKG9wZXJhdGlvblVwZGF0ZSA9PiB7XG4gICAgICAgIHRoaXMubGF0ZXN0T3BlcmF0aW9uID0gb3BlcmF0aW9uVXBkYXRlO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVsb2FkQ29uZmlndXJhdGlvbigpIHtcbiAgICB0aGlzLnJlbG9hZGluZ0NvbmZpZyA9IHRydWU7XG4gICAgY29uc3Qgb3BlcmF0aW9uQ2ZnID0gYXdhaXQgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5jcmVhdGVUZXh0QmFzZWRDb25maWd1cmF0aW9uUmVsb2FkT3BlcmF0aW9uKFxuICAgICAgdGhpcy5kZXZpY2VcbiAgICApO1xuICAgIHRyeSB7XG4gICAgICB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlXG4gICAgICAgIC5jcmVhdGVPYnNlcnZlZE9wZXJhdGlvbihvcGVyYXRpb25DZmcpXG4gICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgb3BlcmF0aW9uVXBkYXRlID0+IHRoaXMub25PcGVyYXRpb25SZWxvYWRTdWNjZXNzKG9wZXJhdGlvblVwZGF0ZSksXG4gICAgICAgICAgb3BlcmF0aW9uVXBkYXRlID0+IHRoaXMub25PcGVyYXRpb25SZWxvYWRFcnJvcihvcGVyYXRpb25VcGRhdGUpLFxuICAgICAgICAgICgpID0+IHRoaXMub25PcGVyYXRpb25SZWxvYWRDb21wbGV0ZSgpXG4gICAgICAgICk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoZXgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZUNvbmZpZ3VyYXRpb24oY29uZmlnKSB7XG4gICAgdGhpcy5zYXZpbmdDb25maWcgPSB0cnVlO1xuICAgIGNvbnN0IG9wZXJhdGlvbkNmZyA9IGF3YWl0IHRoaXMucmVwb3NpdG9yeVNlcnZpY2UuY3JlYXRlVGV4dEJhc2VkQ29uZmlndXJhdGlvblVwZGF0ZU9wZXJhdGlvbihcbiAgICAgIHRoaXMuZGV2aWNlLFxuICAgICAgY29uZmlnXG4gICAgKTtcbiAgICB0cnkge1xuICAgICAgdGhpcy5yZXBvc2l0b3J5U2VydmljZVxuICAgICAgICAuY3JlYXRlT2JzZXJ2ZWRPcGVyYXRpb24ob3BlcmF0aW9uQ2ZnKVxuICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgIG9wZXJhdGlvblVwZGF0ZSA9PiB0aGlzLm9uT3BlcmF0aW9uVXBkYXRlU3VjY2VzcyhvcGVyYXRpb25VcGRhdGUpLFxuICAgICAgICAgIG9wZXJhdGlvblVwZGF0ZSA9PiB0aGlzLm9uT3BlcmF0aW9uVXBkYXRlRXJyb3Iob3BlcmF0aW9uVXBkYXRlKSxcbiAgICAgICAgICAoKSA9PiB0aGlzLm9uT3BlcmF0aW9uVXBkYXRlQ29tcGxldGUoKVxuICAgICAgICApO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGV4KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uT3BlcmF0aW9uUmVsb2FkU3VjY2VzcyhvcGVyYXRpb25VcGRhdGUpIHtcbiAgICB0aGlzLmxhdGVzdE9wZXJhdGlvbiA9IG9wZXJhdGlvblVwZGF0ZTtcbiAgICBpZiAob3BlcmF0aW9uVXBkYXRlLnN0YXR1cyA9PT0gT3BlcmF0aW9uU3RhdHVzLlBFTkRJTkcpIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnN1Y2Nlc3MoZ2V0dGV4dCgnQ29uZmlndXJhdGlvbiB3aWxsIGJlIHJlbG9hZGVkLicpKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uT3BlcmF0aW9uUmVsb2FkRXJyb3Iob3BlcmF0aW9uVXBkYXRlKSB7XG4gICAgdGhpcy5sYXRlc3RPcGVyYXRpb24gPSBvcGVyYXRpb25VcGRhdGU7XG4gICAgdGhpcy5yZWxvYWRpbmdDb25maWcgPSBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgb25PcGVyYXRpb25SZWxvYWRDb21wbGV0ZSgpIHtcbiAgICBhd2FpdCB0aGlzLmxvYWREZXZpY2UoKTtcbiAgICB0aGlzLmNvbmZpZyA9IHRoaXMuZGV2aWNlLmM4eV9Db25maWd1cmF0aW9uLmNvbmZpZztcbiAgICB0aGlzLnJlbG9hZGluZ0NvbmZpZyA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBvbk9wZXJhdGlvblVwZGF0ZVN1Y2Nlc3Mob3BlcmF0aW9uVXBkYXRlKSB7XG4gICAgdGhpcy5sYXRlc3RPcGVyYXRpb24gPSBvcGVyYXRpb25VcGRhdGU7XG4gICAgaWYgKG9wZXJhdGlvblVwZGF0ZS5zdGF0dXMgPT09IE9wZXJhdGlvblN0YXR1cy5QRU5ESU5HKSB7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5zdWNjZXNzKGdldHRleHQoJ0NvbmZpZ3VyYXRpb24gd2lsbCBiZSB1cGRhdGVkLicpKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uT3BlcmF0aW9uVXBkYXRlRXJyb3Iob3BlcmF0aW9uVXBkYXRlKSB7XG4gICAgdGhpcy5sYXRlc3RPcGVyYXRpb24gPSBvcGVyYXRpb25VcGRhdGU7XG4gICAgdGhpcy5zYXZpbmdDb25maWcgPSBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgb25PcGVyYXRpb25VcGRhdGVDb21wbGV0ZSgpIHtcbiAgICB0aGlzLmRldmljZS5jOHlfQ29uZmlndXJhdGlvbi5jb25maWcgPSB0aGlzLmNvbmZpZztcbiAgICB0aGlzLnNhdmluZ0NvbmZpZyA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkRGV2aWNlKCkge1xuICAgIHRoaXMuZGV2aWNlID0gKGF3YWl0IHRoaXMuaW52ZW50b3J5U2VydmljZS5kZXRhaWwodGhpcy5kZXZpY2UuaWQsIHsgd2l0aENoaWxkcmVuOiBmYWxzZSB9KSkuZGF0YTtcbiAgfVxufVxuIl19