import * as tslib_1 from "tslib";
import { Component, OnInit, ViewChildren, QueryList, Input, Output, EventEmitter, ViewChild, OnChanges, ChangeDetectorRef } from '@angular/core';
import { Router } from '@angular/router';
import { OpcuaService } from './opcuaService';
import { AlertService, gettext } from '@c8y/ngx-components';
import { find, assign, omit, findIndex, pick, get } from 'lodash';
import { OpcuaDeviceProtocolMapping } from './opcua-device-protocol-mapping.component';
let OpcuaDeviceProtocolDetailComponent = class OpcuaDeviceProtocolDetailComponent {
    constructor(changeDetectorRef, opcuaService, alertService, router) {
        this.changeDetectorRef = changeDetectorRef;
        this.opcuaService = opcuaService;
        this.alertService = alertService;
        this.router = router;
        this.initialModel = {
            id: '',
            fieldbusType: 'opcuaV2',
            description: '',
            unit: '',
            fieldbusVersion: 4,
            name: '',
            referencedServerId: '',
            referencedRootNodeId: '',
            subscriptionType: {
                type: 'None'
            },
            mappings: [],
            overriddenSubscriptions: [],
            applyConstraints: {
                browsePathMatchesRegex: '',
                matchesNodeIds: [],
                serverObjectHasFragment: '',
                matchesServerIds: []
            },
            enabled: ''
        };
        this.isLoaded = true;
        this.getParentAttr = key => get(this.model, key);
    }
    ngAfterContentChecked() {
        this.changeDetectorRef.detectChanges();
    }
    getMapping() {
        return this.model.mappings;
    }
    getEmptyMappingObject() {
        return {
            id: 'new',
            browsePath: []
        };
    }
    getOverriddenSubscriptionsByPath(browsePath) {
        return find(this.model.overriddenSubscriptions, { browsePath });
    }
    getStructuredResource(resource) {
        const overriddenSubscriptions = this.getOverriddenSubscriptionsByPath(resource.browsePath);
        let result = assign({}, resource);
        if (overriddenSubscriptions) {
            result = assign({}, resource, { subscriptionType: overriddenSubscriptions.subscriptionType });
        }
        return result;
    }
    ngOnInit() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const id = this.opcuaService.getId();
            if (id) {
                const res = yield this.opcuaService.getDeviceProtocol(id);
                if (res && res.status !== 200) {
                    const data = res.json ? yield res.json() : undefined;
                    this.alertService.addServerFailure({ data, res });
                    this.isLoaded = false;
                }
                else {
                    const data = yield res.json();
                    if (data && data.applyConstraints === null) {
                        delete data.applyConstraints;
                    }
                    if (data && data.subscriptionType === null) {
                        delete data.subscriptionType;
                    }
                    this.model = assign(this.initialModel, data);
                    if (!this.model.mappings) {
                        this.model.mappings = [];
                    }
                    this.model = assign(this.initialModel, this.updateViableMapping(data));
                    this.isLoaded = false;
                }
            }
        });
    }
    updateViableMapping(model) {
        const { mappings } = model;
        let result = [];
        if (mappings) {
            result = mappings.map((item, i) => {
                return assign(item, { id: i });
            });
        }
        return assign(model, { mappings: result });
    }
    trackByIndex(index) {
        return index;
    }
    addVariable() {
        this.model.mappings.push(this.getEmptyMappingObject());
    }
    updateVariable(mappingObject) {
        const { mappings } = this.model;
        const index = findIndex(mappings, { id: mappingObject.id });
        mappings.splice(index, 1);
        if (mappingObject.id === 'new') {
            mappingObject.id = mappings.length;
        }
        mappings.push(mappingObject);
    }
    removeVariable(mappingObject) {
        const { mappings } = this.model;
        const index = findIndex(mappings, { id: mappingObject.id });
        mappings.splice(index, 1);
    }
    actionHandler(actionObject) {
        switch (actionObject.action) {
            case 'save':
                this.updateVariable(actionObject.data);
                break;
            case 'delete':
                this.removeVariable(actionObject.data);
                break;
        }
    }
    extractOverridSubscriptionType(_mapping) {
        const overriddenSubscriptions = [];
        const variableMapping = [];
        _mapping.forEach(element => {
            if (element.id !== 'new') {
                if (element.subscriptionType) {
                    overriddenSubscriptions.push(assign({ browsePath: element.browsePath }, { subscriptionType: element.subscriptionType }));
                }
                variableMapping.push(omit(element, ['subscriptionType']));
            }
        });
        return [variableMapping, overriddenSubscriptions];
    }
    prepareRequestJson(_model) {
        let requestJson = {};
        const [mappings, overriddenSubscriptions] = this.extractOverridSubscriptionType(_model.mappings);
        requestJson = assign(requestJson, pick(_model, Object.keys(this.initialModel)), {
            mappings,
            overriddenSubscriptions
        });
        return requestJson;
    }
    save() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const res = yield this.opcuaService.updateDeviceProtocol(this.prepareRequestJson(this.model));
                if (res && res.status === 200) {
                    this.router.navigate(['deviceprotocols']);
                    this.alertService.success(gettext('Device protocol saved.'));
                }
                else {
                    this.alertService.addServerFailure({ res });
                }
            }
            catch (ex) {
                this.alertService.danger(gettext('Failed to save. Try again.'));
            }
        });
    }
    canSave(deviceTypeForm) {
        if (this.instanceList) {
            const activeInstances = this.instanceList.filter(item => item.isActive());
            if (activeInstances.length > 0) {
                return true;
            }
        }
        return !deviceTypeForm.form.valid;
    }
};
OpcuaDeviceProtocolDetailComponent.ctorParameters = () => [
    { type: ChangeDetectorRef },
    { type: OpcuaService },
    { type: AlertService },
    { type: Router }
];
tslib_1.__decorate([
    ViewChildren(OpcuaDeviceProtocolMapping)
], OpcuaDeviceProtocolDetailComponent.prototype, "instanceList", void 0);
OpcuaDeviceProtocolDetailComponent = tslib_1.__decorate([
    Component({
        selector: 'opcua-device-protocol-detail',
        template: "<c8y-title *ngIf=\"!isLoaded\">{{ model.name }}</c8y-title>\n<div>\n  <form #deviceTypeForm=\"ngForm\" name=\"detailForm\" *ngIf=\"!isLoaded\">\n    <opcua-device-protocol-description [model]=\"model\"></opcua-device-protocol-description>\n    <div class=\"card m-b-4\">\n      <div class=\"card-header separator\">\n        <h4 translate>Variables</h4>\n      </div>\n      <div class=\"list-group\" *ngIf=\"model.mappings.length > 0\" ngModelGroup=\"variable\">\n        <opcua-device-protocol-mapping\n          *ngFor=\"let resource of getMapping(); trackBy: trackByIndex; let i = index\"\n          [index]=\"i\"\n          [referencedServerId]=\"model.referencedServerId\"\n          [referencedRootNodeId]=\"model.referencedRootNodeId\"\n          [resource]=\"getStructuredResource(resource)\"\n          [getParentAttr]=\"getParentAttr\"\n          (onAction)=\"actionHandler($event)\"\n        >\n        </opcua-device-protocol-mapping>\n      </div>\n      <div class=\"card-block\">\n        <div class=\"c8y-empty-state text-left\" *ngIf=\"model.mappings.length === 0\">\n          <h1 c8yIcon=\"sliders\"></h1>\n          <p translate>No variables to display. Click below to add.</p>\n        </div>\n        <button\n          title=\"{{ 'Add variable' | translate }}\"\n          class=\"btn-add-block addVariableBtn\"\n          (click)=\"addVariable()\"\n        >\n          <i c8yIcon=\"plus-circle\"></i> {{ 'Add variable' | translate }}\n        </button>\n      </div>\n    </div>\n    <div class=\"card m-b-4\">\n      <div class=\"card-header separator\">\n        <h4 translate>Data reporting</h4>\n      </div>\n      <div class=\"card-block\" ngModelGroup=\"subscription\">\n        <opcua-device-protocol-data-reporting\n          [groupName]=\"'subscription'\"\n          [model]=\"model\"\n        ></opcua-device-protocol-data-reporting>\n      </div>\n    </div>\n    <div class=\"card\">\n      <div class=\"card-header separator\">\n        <h4 translate>Auto apply constraints</h4>\n      </div>\n      <div class=\"card-block overflow-visible\" ngModelGroup=\"autoApply\">\n        <opcua-auto-apply [model]=\"model\"></opcua-auto-apply>\n      </div>\n    </div>\n\n    <span>\n      <div class=\"text-center page-footer m-t-16\">\n        <div class=\"btn-save-wrapper animated\">\n          <button\n            title=\"{{ 'Save' | translate }}\"\n            id=\"deviceTypeSave\"\n            class=\"btn btn-primary\"\n            (click)=\"save()\"\n            [disabled]=\"canSave(deviceTypeForm)\"\n            translate\n          >\n            Save\n          </button>\n        </div>\n      </div>\n    </span>\n  </form>\n</div>\n"
    })
], OpcuaDeviceProtocolDetailComponent);
export { OpcuaDeviceProtocolDetailComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtZGV2aWNlLXByb3RvY29sLWRldGFpbC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL3Byb3RvY29sLW9wY3VhLyIsInNvdXJjZXMiOlsib3BjdWEtZGV2aWNlLXByb3RvY29sLWRldGFpbC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsTUFBTSxFQUNOLFlBQVksRUFDWixTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBQ1osU0FBUyxFQUNULFNBQVMsRUFDVCxpQkFBaUIsRUFDbEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU5QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRTVELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFTLEdBQUcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUN6RSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQztBQU12RixJQUFhLGtDQUFrQyxHQUEvQyxNQUFhLGtDQUFrQztJQStCN0MsWUFDVSxpQkFBb0MsRUFDcEMsWUFBMEIsRUFDMUIsWUFBMEIsRUFDMUIsTUFBYztRQUhkLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQWhDeEIsaUJBQVksR0FBb0I7WUFDOUIsRUFBRSxFQUFFLEVBQUU7WUFDTixZQUFZLEVBQUUsU0FBUztZQUN2QixXQUFXLEVBQUUsRUFBRTtZQUNmLElBQUks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LENBQUMsQ0FBQyxDQUFDO2lCQUM5RDtxQkFBTTtvQkFDTCxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztpQkFDN0M7YUFDRjtZQUFDLE9BQU8sRUFBRSxFQUFFO2dCQUNYLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDLENBQUM7YUFDakU7UUFDSCxDQUFDO0tBQUE7SUFFRCxPQUFPLENBQUMsY0FBYztRQUNwQixJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDckIsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztZQUUxRSxJQUFJLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUM5QixPQUFPLElBQUksQ0FBQzthQUNiO1NBQ0Y7UUFDRCxPQUFPLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDcEMsQ0FBQztDQUNGLENBQUE7O1lBcEs4QixpQkFBaUI7WUFDdEIsWUFBWTtZQUNaLFlBQVk7WUFDbEIsTUFBTTs7QUFsQ2tCO0lBQXpDLFlBQVksQ0FBQywwQkFBMEIsQ0FBQzt3RUFBcUQ7QUFEbkYsa0NBQWtDO0lBSjlDLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSw4QkFBOEI7UUFDeEMsd29GQUFrRDtLQUNuRCxDQUFDO0dBQ1csa0NBQWtDLENBb005QztTQXBNWSxrQ0FBa0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIE9uSW5pdCxcbiAgVmlld0NoaWxkcmVuLFxuICBRdWVyeUxpc3QsXG4gIElucHV0LFxuICBPdXRwdXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgVmlld0NoaWxkLFxuICBPbkNoYW5nZXMsXG4gIENoYW5nZURldGVjdG9yUmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IE9wY3VhU2VydmljZSB9IGZyb20gJy4vb3BjdWFTZXJ2aWNlJztcbmltcG9ydCB7IE5nRm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSwgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgT3BjdWFEZXZpY2VUeXBlIH0gZnJvbSAnLi9vcGN1YS1wcm90b2NvbC1kZXZpY2UtdHlwZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgZmluZCwgYXNzaWduLCBvbWl0LCBmaW5kSW5kZXgsIHBpY2ssIHVuc2V0LCBnZXQgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgT3BjdWFEZXZpY2VQcm90b2NvbE1hcHBpbmcgfSBmcm9tICcuL29wY3VhLWRldmljZS1wcm90b2NvbC1tYXBwaW5nLmNvbXBvbmVudCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ29wY3VhLWRldmljZS1wcm90b2NvbC1kZXRhaWwnLFxuICB0ZW1wbGF0ZVVybDogJy4vb3BjdWEtZGV2aWNlLXByb3RvY29sLWRldGFpbC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBPcGN1YURldmljZVByb3RvY29sRGV0YWlsQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgQFZpZXdDaGlsZHJlbihPcGN1YURldmljZVByb3RvY29sTWFwcGluZykgaW5zdGFuY2VMaXN0OiBRdWVyeUxpc3Q8T3BjdWFEZXZpY2VQcm90b2NvbE1hcHBpbmc+O1xuXG4gIGluaXRpYWxNb2RlbDogT3BjdWFEZXZpY2VUeXBlID0ge1xuICAgIGlkOiAnJyxcbiAgICBmaWVsZGJ1c1R5cGU6ICdvcGN1YVYyJyxcbiAgICBkZXNjcmlwdGlvbjogJycsXG4gICAgdW5pdDogJycsXG4gICAgZmllbGRidXNWZXJzaW9uOiA0LFxuICAgIG5hbWU6ICcnLFxuICAgIHJlZmVyZW5jZWRTZXJ2ZXJJZDogJycsXG4gICAgcmVmZXJlbmNlZFJvb3ROb2RlSWQ6ICcnLFxuICAgIHN1YnNjcmlwdGlvblR5cGU6IHtcbiAgICAgIHR5cGU6ICdOb25lJ1xuICAgIH0sXG4gICAgbWFwcGluZ3M6IFtdLFxuICAgIG92ZXJyaWRkZW5TdWJzY3JpcHRpb25zOiBbXSxcbiAgICBhcHBseUNvbnN0cmFpbnRzOiB7XG4gICAgICBicm93c2VQYXRoTWF0Y2hlc1JlZ2V4OiAnJyxcbiAgICAgIG1hdGNoZXNOb2RlSWRzOiBbXSxcbiAgICAgIHNlcnZlck9iamVjdEhhc0ZyYWdtZW50OiAnJyxcbiAgICAgIG1hdGNoZXNTZXJ2ZXJJZHM6IFtdXG4gICAgfSxcbiAgICBlbmFibGVkOiAnJ1xuICB9O1xuXG4gIG1vZGVsOiBhbnk7XG4gIHNlcnZlcjogYW55O1xuICBzZWxlY3RlZE5vZGU6IGFueTtcbiAgaXNMb2FkZWQgPSB0cnVlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY2hhbmdlRGV0ZWN0b3JSZWY6IENoYW5nZURldGVjdG9yUmVmLFxuICAgIHByaXZhdGUgb3BjdWFTZXJ2aWNlOiBPcGN1YVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhbGVydFNlcnZpY2U6IEFsZXJ0U2VydmljZSxcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyXG4gICkge31cblxuICBuZ0FmdGVyQ29udGVudENoZWNrZWQoKSB7XG4gICAgdGhpcy5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBnZXRQYXJlbnRBdHRyID0ga2V5ID0+IGdldCh0aGlzLm1vZGVsLCBrZXkpO1xuXG4gIGdldE1hcHBpbmcoKSB7XG4gICAgcmV0dXJuIHRoaXMubW9kZWwubWFwcGluZ3M7XG4gIH1cblxuICBnZXRFbXB0eU1hcHBpbmdPYmplY3QoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGlkOiAnbmV3JyxcbiAgICAgIGJyb3dzZVBhdGg6IFtdXG4gICAgfTtcbiAgfVxuXG4gIGdldE92ZXJyaWRkZW5TdWJzY3JpcHRpb25zQnlQYXRoKGJyb3dzZVBhdGgpIHtcbiAgICByZXR1cm4gZmluZCh0aGlzLm1vZGVsLm92ZXJyaWRkZW5TdWJzY3JpcHRpb25zLCB7IGJyb3dzZVBhdGggfSk7XG4gIH1cblxuICBnZXRTdHJ1Y3R1cmVkUmVzb3VyY2UocmVzb3VyY2UpIHtcbiAgICBjb25zdCBvdmVycmlkZGVuU3Vic2NyaXB0aW9ucyA9IHRoaXMuZ2V0T3ZlcnJpZGRlblN1YnNjcmlwdGlvbnNCeVBhdGgocmVzb3VyY2UuYnJvd3NlUGF0aCk7XG4gICAgbGV0IHJlc3VsdCA9IGFzc2lnbih7fSwgcmVzb3VyY2UpO1xuICAgIGlmIChvdmVycmlkZGVuU3Vic2NyaXB0aW9ucykge1xuICAgICAgcmVzdWx0ID0gYXNzaWduKHt9LCByZXNvdXJjZSwgeyBzdWJzY3JpcHRpb25UeXBlOiBvdmVycmlkZGVuU3Vic2NyaXB0aW9ucy5zdWJzY3JpcHRpb25UeXBlIH0pO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgYXN5bmMgbmdPbkluaXQoKSB7XG4gICAgY29uc3QgaWQgPSB0aGlzLm9wY3VhU2VydmljZS5nZXRJZCgpO1xuICAgIGlmIChpZCkge1xuICAgICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5vcGN1YVNlcnZpY2UuZ2V0RGV2aWNlUHJvdG9jb2woaWQpO1xuICAgICAgaWYgKHJlcyAmJiByZXMuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgY29uc3QgZGF0YSA9IHJlcy5qc29uID8gYXdhaXQgcmVzLmpzb24oKSA6IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZSh7IGRhdGEsIHJlcyB9KTtcbiAgICAgICAgdGhpcy5pc0xvYWRlZCA9IGZhbHNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcy5qc29uKCk7XG4gICAgICAgIGlmIChkYXRhICYmIGRhdGEuYXBwbHlDb25zdHJhaW50cyA9PT0gbnVsbCkge1xuICAgICAgICAgIGRlbGV0ZSBkYXRhLmFwcGx5Q29uc3RyYWludHM7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5zdWJzY3JpcHRpb25UeXBlID09PSBudWxsKSB7XG4gICAgICAgICAgZGVsZXRlIGRhdGEuc3Vic2NyaXB0aW9uVHlwZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1vZGVsID0gYXNzaWduKHRoaXMuaW5pdGlhbE1vZGVsLCBkYXRhKTtcbiAgICAgICAgaWYgKCF0aGlzLm1vZGVsLm1hcHBpbmdzKSB7XG4gICAgICAgICAgdGhpcy5tb2RlbC5tYXBwaW5ncyA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubW9kZWwgPSBhc3NpZ24odGhpcy5pbml0aWFsTW9kZWwsIHRoaXMudXBkYXRlVmlhYmxlTWFwcGluZyhkYXRhKSk7XG4gICAgICAgIHRoaXMuaXNMb2FkZWQgPSBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICB1cGRhdGVWaWFibGVNYXBwaW5nKG1vZGVsKSB7XG4gICAgY29uc3QgeyBtYXBwaW5ncyB9ID0gbW9kZWw7XG4gICAgbGV0IHJlc3VsdCA9IFtdO1xuICAgIGlmIChtYXBwaW5ncykge1xuICAgICAgcmVzdWx0ID0gbWFwcGluZ3MubWFwKChpdGVtLCBpKSA9PiB7XG4gICAgICAgIHJldHVybiBhc3NpZ24oaXRlbSwgeyBpZDogaSB9KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gYXNzaWduKG1vZGVsLCB7IG1hcHBpbmdzOiByZXN1bHQgfSk7XG4gIH1cblxuICB0cmFja0J5SW5kZXgoaW5kZXg6IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIGluZGV4O1xuICB9XG5cbiAgYWRkVmFyaWFibGUoKSB7XG4gICAgdGhpcy5tb2RlbC5tYXBwaW5ncy5wdXNoKHRoaXMuZ2V0RW1wdHlNYXBwaW5nT2JqZWN0KCkpO1xuICB9XG5cbiAgdXBkYXRlVmFyaWFibGUobWFwcGluZ09iamVjdCkge1xuICAgIGNvbnN0IHsgbWFwcGluZ3MgfSA9IHRoaXMubW9kZWw7XG4gICAgY29uc3QgaW5kZXggPSBmaW5kSW5kZXgobWFwcGluZ3MsIHsgaWQ6IG1hcHBpbmdPYmplY3QuaWQgfSk7XG4gICAgbWFwcGluZ3Muc3BsaWNlKGluZGV4LCAxKTtcbiAgICBpZiAobWFwcGluZ09iamVjdC5pZCA9PT0gJ25ldycpIHtcbiAgICAgIG1hcHBpbmdPYmplY3QuaWQgPSBtYXBwaW5ncy5sZW5ndGg7XG4gICAgfVxuICAgIG1hcHBpbmdzLnB1c2gobWFwcGluZ09iamVjdCk7XG4gIH1cblxuICByZW1vdmVWYXJpYWJsZShtYXBwaW5nT2JqZWN0KSB7XG4gICAgY29uc3QgeyBtYXBwaW5ncyB9ID0gdGhpcy5tb2RlbDtcbiAgICBjb25zdCBpbmRleCA9IGZpbmRJbmRleChtYXBwaW5ncywgeyBpZDogbWFwcGluZ09iamVjdC5pZCB9KTtcbiAgICBtYXBwaW5ncy5zcGxpY2UoaW5kZXgsIDEpO1xuICB9XG5cbiAgYWN0aW9uSGFuZGxlcihhY3Rpb25PYmplY3QpIHtcbiAgICBzd2l0Y2ggKGFjdGlvbk9iamVjdC5hY3Rpb24pIHtcbiAgICAgIGNhc2UgJ3NhdmUnOlxuICAgICAgICB0aGlzLnVwZGF0ZVZhcmlhYmxlKGFjdGlvbk9iamVjdC5kYXRhKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdkZWxldGUnOlxuICAgICAgICB0aGlzLnJlbW92ZVZhcmlhYmxlKGFjdGlvbk9iamVjdC5kYXRhKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgZXh0cmFjdE92ZXJyaWRTdWJzY3JpcHRpb25UeXBlKF9tYXBwaW5nKSB7XG4gICAgY29uc3Qgb3ZlcnJpZGRlblN1YnNjcmlwdGlvbnMgPSBbXTtcbiAgICBjb25zdCB2YXJpYWJsZU1hcHBpbmcgPSBbXTtcbiAgICBfbWFwcGluZy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgICAgaWYgKGVsZW1lbnQuaWQgIT09ICduZXcnKSB7XG4gICAgICAgIGlmIChlbGVtZW50LnN1YnNjcmlwdGlvblR5cGUpIHtcbiAgICAgICAgICBvdmVycmlkZGVuU3Vic2NyaXB0aW9ucy5wdXNoKFxuICAgICAgICAgICAgYXNzaWduKFxuICAgICAgICAgICAgICB7IGJyb3dzZVBhdGg6IGVsZW1lbnQuYnJvd3NlUGF0aCB9LFxuICAgICAgICAgICAgICB7IHN1YnNjcmlwdGlvblR5cGU6IGVsZW1lbnQuc3Vic2NyaXB0aW9uVHlwZSB9XG4gICAgICAgICAgICApXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICB2YXJpYWJsZU1hcHBpbmcucHVzaChvbWl0KGVsZW1lbnQsIFsnc3Vic2NyaXB0aW9uVHlwZSddKSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIFt2YXJpYWJsZU1hcHBpbmcsIG92ZXJyaWRkZW5TdWJzY3JpcHRpb25zXTtcbiAgfVxuXG4gIHByZXBhcmVSZXF1ZXN0SnNvbihfbW9kZWwpIHtcbiAgICBsZXQgcmVxdWVzdEpzb24gPSB7fTtcbiAgICBjb25zdCBbbWFwcGluZ3MsIG92ZXJyaWRkZW5TdWJzY3JpcHRpb25zXSA9IHRoaXMuZXh0cmFjdE92ZXJyaWRTdWJzY3JpcHRpb25UeXBlKFxuICAgICAgX21vZGVsLm1hcHBpbmdzXG4gICAgKTtcbiAgICByZXF1ZXN0SnNvbiA9IGFzc2lnbihyZXF1ZXN0SnNvbiwgcGljayhfbW9kZWwsIE9iamVjdC5rZXlzKHRoaXMuaW5pdGlhbE1vZGVsKSksIHtcbiAgICAgIG1hcHBpbmdzLFxuICAgICAgb3ZlcnJpZGRlblN1YnNjcmlwdGlvbnNcbiAgICB9KTtcbiAgICByZXR1cm4gcmVxdWVzdEpzb247XG4gIH1cblxuICBhc3luYyBzYXZlKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLm9wY3VhU2VydmljZS51cGRhdGVEZXZpY2VQcm90b2NvbCh0aGlzLnByZXBhcmVSZXF1ZXN0SnNvbih0aGlzLm1vZGVsKSk7XG5cbiAgICAgIGlmIChyZXMgJiYgcmVzLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnZGV2aWNlcHJvdG9jb2xzJ10pO1xuICAgICAgICB0aGlzLmFsZXJ0U2VydmljZS5zdWNjZXNzKGdldHRleHQoJ0RldmljZSBwcm90b2NvbCBzYXZlZC4nKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKHsgcmVzIH0pO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5kYW5nZXIoZ2V0dGV4dCgnRmFpbGVkIHRvIHNhdmUuIFRyeSBhZ2Fpbi4nKSk7XG4gICAgfVxuICB9XG5cbiAgY2FuU2F2ZShkZXZpY2VUeXBlRm9ybSkge1xuICAgIGlmICh0aGlzLmluc3RhbmNlTGlzdCkge1xuICAgICAgY29uc3QgYWN0aXZlSW5zdGFuY2VzID0gdGhpcy5pbnN0YW5jZUxpc3QuZmlsdGVyKGl0ZW0gPT4gaXRlbS5pc0FjdGl2ZSgpKTtcblxuICAgICAgaWYgKGFjdGl2ZUluc3RhbmNlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gIWRldmljZVR5cGVGb3JtLmZvcm0udmFsaWQ7XG4gIH1cbn1cbiJdfQ==