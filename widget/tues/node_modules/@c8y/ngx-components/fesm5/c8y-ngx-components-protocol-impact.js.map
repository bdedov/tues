{"version":3,"file":"c8y-ngx-components-protocol-impact.js","sources":["ng://@c8y/ngx-components/protocol-impact/impact-subscription.service.ts","ng://@c8y/ngx-components/protocol-impact/refresh-action.component.ts","ng://@c8y/ngx-components/protocol-impact/impact-action.factory.ts","ng://@c8y/ngx-components/protocol-impact/impact-protocol.module.ts","ng://@c8y/ngx-components/protocol-impact/c8y-ngx-components-protocol-impact.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { FetchClient, IFetchOptions, IFetchResponse } from '@c8y/client';\n\n@Injectable()\nexport class ImpactSubscriptionService {\n  private readonly microserviceUrl: string = '/service/impact';\n  private readonly header: any = { 'Content-Type': 'application/json' };\n\n  constructor(private client: FetchClient) {}\n\n  refreshDeviceResources(deviceId: string | number): Promise<IFetchResponse> {\n    const options: IFetchOptions = {\n      method: 'PUT',\n      headers: this.header\n    };\n    return this.client.fetch(`${this.microserviceUrl}/refresh/${deviceId}`, options);\n  }\n}\n","import { Component, OnInit, TemplateRef, ViewChild, ViewContainerRef } from '@angular/core';\nimport { Router } from '@angular/router';\nimport { IFetchResponse } from '@c8y/client';\nimport { AlertService, gettext } from '@c8y/ngx-components';\nimport { ImpactSubscriptionService } from './impact-subscription.service';\n\n@Component({\n  selector: 'c8y-impact-refresh-action',\n  templateUrl: './refresh-action.component.html'\n})\nexport class RefreshActionComponent implements OnInit {\n  @ViewChild('templateCopy', { read: TemplateRef, static: true }) templateCopy;\n  requestInProgress: boolean;\n\n  constructor(\n    private vcRef: ViewContainerRef,\n    private router: Router,\n    private impactService: ImpactSubscriptionService,\n    private alert: AlertService\n  ) {}\n\n  ngOnInit() {\n    this.vcRef.createEmbeddedView(this.templateCopy);\n  }\n\n  async refresh() {\n    // TODO This is only a dirty hack to retrieve deviceId from URL;\n    // In fact contextData should be provided for this component by a resolver?\n    const url: string =\n      this.router &&\n      this.router.routerState &&\n      this.router.routerState.snapshot &&\n      this.router.routerState.snapshot.url;\n    const deviceId: string = url && (/^\\/device\\/(\\d+)\\/.*$/gi.exec(url) || [])[1];\n\n    if (deviceId) {\n      this.requestInProgress = true;\n      try {\n        const res: IFetchResponse = await this.impactService.refreshDeviceResources(deviceId);\n        if (res && res.status !== 200) {\n          const data = res.json ? await res.json() : undefined;\n          this.alert.addServerFailure({ data, res });\n        } else {\n          this.alert.success(gettext('Device resource refresh scheduled.'));\n        }\n      } catch (ex) {\n        this.alert.addServerFailure(ex);\n      }\n      this.requestInProgress = false;\n    } else {\n      this.alert.danger(gettext('Could not find device ID in URL.'));\n    }\n  }\n}\n","import { Injectable } from '@angular/core';\nimport { ActivatedRoute } from '@angular/router';\nimport { ApplicationService } from '@c8y/client';\nimport { ActionBarFactory, ActionBarItem } from '@c8y/ngx-components';\nimport { get } from 'lodash-es';\nimport { RefreshActionComponent } from './refresh-action.component';\n\n@Injectable()\nexport class ImpactActionFactory implements ActionBarFactory {\n  private static readonly applicationName = 'impact';\n\n  constructor(private applicationService: ApplicationService) {}\n\n  async get(activeRoute?: ActivatedRoute) {\n    const actions: ActionBarItem[] = [];\n\n    const data =\n      !activeRoute.parent || activeRoute.snapshot.data.context\n        ? activeRoute.snapshot.data\n        : activeRoute.parent.snapshot.data;\n    const { contextData } = data;\n\n    const isDeviceInfoTab: boolean = get(activeRoute, 'snapshot.url[0].path') === 'device-info';\n\n    const showRefreshActionButton: boolean =\n      isDeviceInfoTab &&\n      contextData &&\n      contextData.c8y_ImpactResourceInfo &&\n      /* call application service only for relevant devices to reduce number of service calls! */\n      (await this.applicationService.isAvailable(ImpactActionFactory.applicationName)).data;\n\n    if (showRefreshActionButton) {\n      actions.push({\n        priority: 500,\n        placement: 'right',\n        template: RefreshActionComponent\n      } as ActionBarItem);\n    }\n\n    return actions;\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { CoreModule, HOOK_ACTION_BAR } from '@c8y/ngx-components';\nimport { ImpactActionFactory } from './impact-action.factory';\nimport { ImpactSubscriptionService } from './impact-subscription.service';\nimport { RefreshActionComponent } from './refresh-action.component';\n\n@NgModule({\n  declarations: [RefreshActionComponent],\n  imports: [CoreModule],\n  providers: [\n    ImpactSubscriptionService,\n    { provide: HOOK_ACTION_BAR, useClass: ImpactActionFactory, multi: true }\n  ],\n  entryComponents: [RefreshActionComponent]\n})\nexport class ImpactProtocolModule {}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":["tslib_1.__decorate"],"mappings":"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"}