import * as tslib_1 from "tslib";
import { Component, Input } from '@angular/core';
import { IManagedObject, InventoryService } from '@c8y/client';
import { gettext } from '@c8y/ngx-components';
var OpcuaAutoApplySettingsComponent = /** @class */ (function () {
    function OpcuaAutoApplySettingsComponent(inventoryService) {
        this.inventoryService = inventoryService;
        this.opcuaServers = [];
        this.selected = [];
        this.constraints = {
            browsePathMatchesRegex: '',
            matchesNodeIds: [],
            serverObjectHasFragment: '',
            matchesServerIds: []
        };
        this.placeholderSelectServerIds = gettext('Select server IDs from list');
    }
    OpcuaAutoApplySettingsComponent.prototype.ngOnInit = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data, matchesServerIds;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.inventoryService.list({
                            pageSize: 1000,
                            withTotalPages: true,
                            type: 'c8y_OpcuaServer'
                        })];
                    case 1:
                        data = (_a.sent()).data;
                        this.opcuaServers = data;
                        this.selected = [];
                        matchesServerIds = this.constraints.matchesServerIds;
                        data.forEach(function (server) {
                            if (matchesServerIds &&
                                matchesServerIds.length > 0 &&
                                matchesServerIds.find(function (itemId) { return itemId === server.id; })) {
                                _this.selected.push(server);
                            }
                        });
                        return [2 /*return*/];
                }
            });
        });
    };
    Object.defineProperty(OpcuaAutoApplySettingsComponent.prototype, "model", {
        get: function () {
            return this._model;
        },
        set: function (model) {
            if (model && model.applyConstraints) {
                this.constraints = model.applyConstraints;
            }
            this._model = model;
        },
        enumerable: true,
        configurable: true
    });
    OpcuaAutoApplySettingsComponent.prototype.serverIdsSelected = function (items) {
        if (this.constraints) {
            this.constraints.matchesServerIds = items.map(function (item) { return item.id; });
        }
        this.selected = items;
    };
    OpcuaAutoApplySettingsComponent.prototype.onChangeNodeId = function (event) {
        if (event.target.checked) {
            this.showRootNodes = true;
            this.add();
        }
        else {
            this.showRootNodes = false;
            this.constraints.matchesNodeIds = [];
        }
    };
    OpcuaAutoApplySettingsComponent.prototype.onChangeShowServerIds = function (event) {
        if (!event.target.checked) {
            this.constraints.matchesServerIds = [];
            this.showServerIds = false;
            this.selected = [];
        }
        else {
            this.showServerIds = true;
        }
    };
    OpcuaAutoApplySettingsComponent.prototype.onChangeShowBrowsePath = function (event) {
        if (!event.target.checked) {
            this.constraints.browsePathMatchesRegex = '';
            this.showBrowsePath = false;
        }
        else {
            this.showBrowsePath = true;
        }
    };
    OpcuaAutoApplySettingsComponent.prototype.onChangeShowServerFragment = function (event) {
        if (!event.target.checked) {
            this.constraints.serverObjectHasFragment = '';
            this.showServerFragment = false;
        }
        else {
            this.showServerFragment = true;
        }
    };
    OpcuaAutoApplySettingsComponent.prototype.add = function () {
        this.constraints.matchesNodeIds.push('');
    };
    OpcuaAutoApplySettingsComponent.prototype.remove = function (index) {
        this.constraints.matchesNodeIds.splice(index, 1);
    };
    OpcuaAutoApplySettingsComponent.prototype.trackByFn = function (index, item) {
        return index;
    };
    OpcuaAutoApplySettingsComponent.ctorParameters = function () { return [
        { type: InventoryService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], OpcuaAutoApplySettingsComponent.prototype, "model", null);
    OpcuaAutoApplySettingsComponent = tslib_1.__decorate([
        Component({
            selector: 'opcua-auto-apply',
            template: "<div class=\"row\">\n  <div class=\"col-md-4\">\n    <p translate>\n      Specifying auto-apply constraints allows you to limit the scope where the device protocols are\n      applied, for example by specifying a set of possible servers or node IDs.\n    </p>\n    <p translate>\n      If no constraints are set, device protocols are applied at any fitting location on the OPC UA\n      server.\n    </p>\n  </div>\n\n  <div class=\"col-md-6\">\n    <ul class=\"list-group\" style=\"box-shadow: none;\">\n      <!-- Limit device type to a set of servers -->\n      <li class=\"list-group-item\">\n        <label\n          title=\"{{ 'Limit device protocol to a set of servers' | translate }}\"\n          class=\"c8y-checkbox\"\n        >\n          <input\n            type=\"checkbox\"\n            [checked]=\"\n              constraints.matchesServerIds !== null && constraints.matchesServerIds.length > 0\n            \"\n            (change)=\"onChangeShowServerIds($event)\"\n          />\n          <span></span>\n          <span class=\"m-l-8\">\n            {{ 'Limit device protocol to a set of servers' | translate }}\n          </span>\n        </label>\n        <div\n          class=\"collapse\"\n          [collapse]=\"\n            (!showServerIds &&\n              (constraints.matchesServerIds !== null && constraints.matchesServerIds.length < 1)) ||\n            (!showServerIds && constraints.matchesServerIds === null)\n          \"\n        >\n          <c8y-form-group class=\"m-t-8 m-b-8\">\n            <c8y-select\n              [items]=\"opcuaServers\"\n              [selected]=\"selected\"\n              [placeholder]=\"placeholderSelectServerIds\"\n              (onChange)=\"serverIdsSelected($event)\"\n            >\n            </c8y-select>\n          </c8y-form-group>\n        </div>\n      </li>\n      <!-- Limit device type scope in the address space -->\n      <li class=\"list-group-item\">\n        <label\n          title=\"{{ 'Limit device protocol scope in the address space' | translate }}\"\n          class=\"c8y-checkbox\"\n        >\n          <input\n            type=\"checkbox\"\n            [checked]=\"\n              constraints.browsePathMatchesRegex !== null &&\n              constraints.browsePathMatchesRegex.length > 0\n            \"\n            (change)=\"onChangeShowBrowsePath($event)\"\n          />\n          <span></span>\n          <span class=\"m-l-8\">\n            {{ 'Limit device protocol scope in the address space' | translate }}\n          </span>\n        </label>\n        <div\n          class=\"collapse\"\n          [isAnimated]=\"true\"\n          [collapse]=\"\n            (!showBrowsePath &&\n              constraints.browsePathMatchesRegex !== null &&\n              constraints.browsePathMatchesRegex.length < 1) ||\n            (!showBrowsePath && constraints.browsePathMatchesRegex === null)\n          \"\n        >\n          <c8y-form-group class=\"m-t-8 m-b-8\">\n            <input\n              name=\"browsePath\"\n              type=\"text\"\n              class=\"form-control\"\n              placeholder=\"{{ 'e.g.' | translate }} /objects/devices/.*\"\n              [(ngModel)]=\"constraints.browsePathMatchesRegex\"\n              ngDefaultControl\n            />\n          </c8y-form-group>\n        </div>\n      </li>\n      <!-- Limit device type to servers with a certain fragment-->\n      <li class=\"list-group-item\">\n        <label\n          title=\"{{ 'Limit device protocol to servers with a certain fragment' | translate }}\"\n          class=\"c8y-checkbox\"\n        >\n          <input\n            type=\"checkbox\"\n            [checked]=\"constraints.serverObjectHasFragment !== null && constraints.serverObjectHasFragment.length > 0\"\n            (change)=\"onChangeShowServerFragment($event)\"\n          />\n          <span></span>\n          <span class=\"m-l-8\">\n            {{ 'Limit device protocol to servers with a certain fragment' | translate }}\n          </span>\n        </label>\n        <div\n          class=\"collapse\"\n          [isAnimated]=\"true\"\n          [collapse]=\"(!showServerFragment && constraints.serverObjectHasFragment !== null && constraints.serverObjectHasFragment.length < 1) || (!showServerFragment && constraints.serverObjectHasFragment === null)\"\n        >\n          <c8y-form-group class=\"m-t-8 m-b-8\">\n            <input\n              name=\"serverFragment\"\n              type=\"text\"\n              class=\"form-control\"\n              placeholder=\"{{ 'e.g.' | translate }} c8y_SomeServerMarker\"\n              [(ngModel)]=\"constraints.serverObjectHasFragment\"\n              ngDefaultControl\n            />\n          </c8y-form-group>\n        </div>\n      </li>\n      <!-- Limit device type to a specific root node ID -->\n      <li class=\"list-group-item\">\n        <label\n          title=\"{{ 'Limit device protocol to specific root nodes ID' | translate }}\"\n          class=\"c8y-checkbox\"\n        >\n          <input\n            type=\"checkbox\"\n            [checked]=\"constraints.matchesNodeIds !== null && constraints.matchesNodeIds.length > 0\"\n            (change)=\"onChangeNodeId($event)\"\n          />\n          <span></span>\n          <span class=\"m-l-8\">\n            {{ 'Limit device protocol to specific root nodes ID' | translate }}\n          </span>\n        </label>\n        <div\n          class=\"collapse\"\n          [isAnimated]=\"true\"\n          [collapse]=\"(!showRootNodes && constraints.matchesNodeIds !== null && constraints.matchesNodeIds.length < 1) || ( !showRootNodes && constraints.matchesNodeIds === null)\"\n        >\n            <ul c8yInputGroupListContainer class=\"list-unstyled p-t-16\">\n              <li\n                class=\"m-b-8\"\n                *ngFor=\"let item of constraints.matchesNodeIds; let i = index; trackBy: trackByFn\"\n              >\n                <c8y-input-group-list [index]=\"i\" (onAdd)=\"add()\" (onRemove)=\"remove($event)\">\n                  <c8y-form-group class=\"form-group--tooltip-validation\">\n                    <input\n                      type=\"text\"\n                      class=\"form-control\"\n                      placeholder=\"{{ 'e.g.' | translate }} nodeId\"\n                      [(ngModel)]=\"constraints.matchesNodeIds[i]\"\n                      [required]=\"true\"\n                    />\n                  </c8y-form-group>\n                </c8y-input-group-list>\n              </li>\n            </ul> \n        </div>\n      </li>\n    </ul>\n  </div>\n</div>\n"
        })
    ], OpcuaAutoApplySettingsComponent);
    return OpcuaAutoApplySettingsComponent;
}());
export { OpcuaAutoApplySettingsComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtYXV0by1hcHBseS1zZXR0aW5ncy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL3Byb3RvY29sLW9wY3VhLyIsInNvdXJjZXMiOlsib3BjdWEtYXV0by1hcHBseS1zZXR0aW5ncy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBRXpELE9BQU8sRUFBRSxjQUFjLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDL0QsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBTTlDO0lBZ0JFLHlDQUFvQixnQkFBa0M7UUFBbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQWZ0RCxpQkFBWSxHQUFxQixFQUFFLENBQUM7UUFDcEMsYUFBUSxHQUFxQixFQUFFLENBQUM7UUFDaEMsZ0JBQVcsR0FBeUI7WUFDbEMsc0JBQXNCLEVBQUUsRUFBRTtZQUMxQixjQUFjLEVBQUUsRUFBRTtZQUNsQix1QkFBdUIsRUFBRSxFQUFFO1lBQzNCLGdCQUFnQixFQUFFLEVBQUU7U0FDckIsQ0FBQztRQUNGLCtCQUEwQixHQUFXLE9BQU8sQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0lBT25CLENBQUM7SUFFcEQsa0RBQVEsR0FBZDs7Ozs7OzRCQUNtQixxQkFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDOzRCQUNoRCxRQUFRLEVBQUUsSUFBSTs0QkFDZCxjQUFjLEVBQUUsSUFBSTs0QkFDcEIsSUFBSSxFQUFFLGlCQUFpQjt5QkFDeEIsQ0FBQyxFQUFBOzt3QkFKTSxJQUFJLEdBQUssQ0FBQSxTQUlmLENBQUEsS0FKVTt3QkFNWixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQzt3QkFDekIsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7d0JBRVgsZ0JBQWdC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RCxnREFBTSxHQUFOLFVBQU8sS0FBSztRQUNWLElBQUksQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQUVELG1EQUFTLEdBQVQsVUFBVSxLQUFVLEVBQUUsSUFBUztRQUM3QixPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7O2dCQTNGcUMsZ0JBQWdCOztJQXlCN0M7UUFBUixLQUFLLEVBQUU7Z0VBS1A7SUE5Q1UsK0JBQStCO1FBSjNDLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxrQkFBa0I7WUFDNUIsbzlNQUF5RDtTQUMxRCxDQUFDO09BQ1csK0JBQStCLENBNEczQztJQUFELHNDQUFDO0NBQUEsQUE1R0QsSUE0R0M7U0E1R1ksK0JBQStCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBdXRvQXBwbHlDb25zdHJhaW50cyB9IGZyb20gJy4vb3BjdWEtcHJvdG9jb2wtZGV2aWNlLXR5cGUuaW50ZXJmYWNlJztcbmltcG9ydCB7IElNYW5hZ2VkT2JqZWN0LCBJbnZlbnRvcnlTZXJ2aWNlIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgc2V0IH0gZnJvbSAnbG9kYXNoLWVzJztcbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ29wY3VhLWF1dG8tYXBwbHknLFxuICB0ZW1wbGF0ZVVybDogJy4vb3BjdWEtYXV0by1hcHBseS1zZXR0aW5ncy5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgT3BjdWFBdXRvQXBwbHlTZXR0aW5nc0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIG9wY3VhU2VydmVyczogSU1hbmFnZWRPYmplY3RbXSA9IFtdO1xuICBzZWxlY3RlZDogSU1hbmFnZWRPYmplY3RbXSA9IFtdO1xuICBjb25zdHJhaW50czogQXV0b0FwcGx5Q29uc3RyYWludHMgPSB7XG4gICAgYnJvd3NlUGF0aE1hdGNoZXNSZWdleDogJycsXG4gICAgbWF0Y2hlc05vZGVJZHM6IFtdLFxuICAgIHNlcnZlck9iamVjdEhhc0ZyYWdtZW50OiAnJyxcbiAgICBtYXRjaGVzU2VydmVySWRzOiBbXVxuICB9O1xuICBwbGFjZWhvbGRlclNlbGVjdFNlcnZlcklkczogc3RyaW5nID0gZ2V0dGV4dCgnU2VsZWN0IHNlcnZlciBJRHMgZnJvbSBsaXN0Jyk7XG4gIHNob3dTZXJ2ZXJJZHM6IGJvb2xlYW47XG4gIHNob3dCcm93c2VQYXRoOiBib29sZWFuO1xuICBzaG93U2VydmVyRnJhZ21lbnQ6IGJvb2xlYW47XG4gIHNob3dSb290Tm9kZXM6IGJvb2xlYW47XG4gIHByaXZhdGUgX21vZGVsOiBJTWFuYWdlZE9iamVjdDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGludmVudG9yeVNlcnZpY2U6IEludmVudG9yeVNlcnZpY2UpIHt9XG5cbiAgYXN5bmMgbmdPbkluaXQoKSB7XG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLmludmVudG9yeVNlcnZpY2UubGlzdCh7XG4gICAgICBwYWdlU2l6ZTogMTAwMCxcbiAgICAgIHdpdGhUb3RhbFBhZ2VzOiB0cnVlLFxuICAgICAgdHlwZTogJ2M4eV9PcGN1YVNlcnZlcidcbiAgICB9KTtcblxuICAgIHRoaXMub3BjdWFTZXJ2ZXJzID0gZGF0YTtcbiAgICB0aGlzLnNlbGVjdGVkID0gW107XG5cbiAgICBjb25zdCB7IG1hdGNoZXNTZXJ2ZXJJZHMgfSA9IHRoaXMuY29uc3RyYWludHM7XG5cbiAgICBkYXRhLmZvckVhY2goc2VydmVyID0+IHtcbiAgICAgIGlmIChcbiAgICAgICAgbWF0Y2hlc1NlcnZlcklkcyAmJlxuICAgICAgICBtYXRjaGVzU2VydmVySWRzLmxlbmd0aCA+IDAgJiZcbiAgICAgICAgbWF0Y2hlc1NlcnZlcklkcy5maW5kKGl0ZW1JZCA9PiBpdGVtSWQgPT09IHNlcnZlci5pZClcbiAgICAgICkge1xuICAgICAgICB0aGlzLnNlbGVjdGVkLnB1c2goc2VydmVyKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIEBJbnB1dCgpIHNldCBtb2RlbChtb2RlbCkge1xuICAgIGlmIChtb2RlbCAmJiBtb2RlbC5hcHBseUNvbnN0cmFpbnRzKSB7XG4gICAgICB0aGlzLmNvbnN0cmFpbnRzID0gbW9kZWwuYXBwbHlDb25zdHJhaW50cyBhcyBBdXRvQXBwbHlDb25zdHJhaW50cztcbiAgICB9XG4gICAgdGhpcy5fbW9kZWwgPSBtb2RlbDtcbiAgfVxuXG4gIGdldCBtb2RlbCgpIHtcbiAgICByZXR1cm4gdGhpcy5fbW9kZWw7XG4gIH1cblxuICBzZXJ2ZXJJZHNTZWxlY3RlZChpdGVtczogSU1hbmFnZWRPYmplY3RbXSkge1xuICAgIGlmICh0aGlzLmNvbnN0cmFpbnRzKSB7XG4gICAgICB0aGlzLmNvbnN0cmFpbnRzLm1hdGNoZXNTZXJ2ZXJJZHMgPSBpdGVtcy5tYXAoKGl0ZW06IElNYW5hZ2VkT2JqZWN0KSA9PiBpdGVtLmlkKTtcbiAgICB9XG4gICAgdGhpcy5zZWxlY3RlZCA9IGl0ZW1zO1xuICB9XG5cbiAgb25DaGFuZ2VOb2RlSWQoZXZlbnQpIHtcbiAgICBpZiAoZXZlbnQudGFyZ2V0LmNoZWNrZWQpIHtcbiAgICAgIHRoaXMuc2hvd1Jvb3ROb2RlcyA9IHRydWU7XG4gICAgICB0aGlzLmFkZCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNob3dSb290Tm9kZXMgPSBmYWxzZTtcbiAgICAgIHRoaXMuY29uc3RyYWludHMubWF0Y2hlc05vZGVJZHMgPSBbXTtcbiAgICB9XG4gIH1cblxuICBvbkNoYW5nZVNob3dTZXJ2ZXJJZHMoZXZlbnQpIHtcbiAgICBpZiAoIWV2ZW50LnRhcmdldC5jaGVja2VkKSB7XG4gICAgICB0aGlzLmNvbnN0cmFpbnRzLm1hdGNoZXNTZXJ2ZXJJZHMgPSBbXTtcbiAgICAgIHRoaXMuc2hvd1NlcnZlcklkcyA9IGZhbHNlO1xuICAgICAgdGhpcy5zZWxlY3RlZCA9IFtdO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNob3dTZXJ2ZXJJZHMgPSB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIG9uQ2hhbmdlU2hvd0Jyb3dzZVBhdGgoZXZlbnQpIHtcbiAgICBpZiAoIWV2ZW50LnRhcmdldC5jaGVja2VkKSB7XG4gICAgICB0aGlzLmNvbnN0cmFpbnRzLmJyb3dzZVBhdGhNYXRjaGVzUmVnZXggPSAnJztcbiAgICAgIHRoaXMuc2hvd0Jyb3dzZVBhdGggPSBmYWxzZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zaG93QnJvd3NlUGF0aCA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgb25DaGFuZ2VTaG93U2VydmVyRnJhZ21lbnQoZXZlbnQpIHtcbiAgICBpZiAoIWV2ZW50LnRhcmdldC5jaGVja2VkKSB7XG4gICAgICB0aGlzLmNvbnN0cmFpbnRzLnNlcnZlck9iamVjdEhhc0ZyYWdtZW50ID0gJyc7XG4gICAgICB0aGlzLnNob3dTZXJ2ZXJGcmFnbWVudCA9IGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNob3dTZXJ2ZXJGcmFnbWVudCA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgYWRkKCkge1xuICAgIHRoaXMuY29uc3RyYWludHMubWF0Y2hlc05vZGVJZHMucHVzaCgnJyk7XG4gIH1cblxuICByZW1vdmUoaW5kZXgpIHtcbiAgICB0aGlzLmNvbnN0cmFpbnRzLm1hdGNoZXNOb2RlSWRzLnNwbGljZShpbmRleCwgMSk7XG4gIH1cblxuICB0cmFja0J5Rm4oaW5kZXg6IGFueSwgaXRlbTogYW55KSB7XG4gICAgcmV0dXJuIGluZGV4O1xuICB9XG59XG4iXX0=