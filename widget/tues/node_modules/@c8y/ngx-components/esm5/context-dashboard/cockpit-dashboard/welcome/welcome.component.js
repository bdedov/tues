import * as tslib_1 from "tslib";
import { Component, Input } from '@angular/core';
import { gettext, DocsService, DocLink, NavigatorService, NavigatorNode } from '@c8y/ngx-components';
import { Router } from '@angular/router';
import { TenantService, ApplicationService, IApplication } from '@c8y/client';
var WelcomeToCockpit = /** @class */ (function () {
    function WelcomeToCockpit(tenantService, docs, router, navigator, applicationService) {
        this.tenantService = tenantService;
        this.docs = docs;
        this.router = router;
        this.navigator = navigator;
        this.applicationService = applicationService;
        this.quickLinks = [];
        this.CONFIGURATION_NODE = 'Configuration';
        this.TRIAL = 'TRIAL';
    }
    WelcomeToCockpit.prototype.ngOnInit = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a;
            var _this = this;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        _a = this;
                        return [4 /*yield*/, this.tenantService.currentTenantType()];
                    case 1:
                        _a.tenantType = _b.sent();
                        this.setMessage();
                        this.navSubscription = this.navigator.items$.subscribe(function (nodes) {
                            _this.navNodes = nodes;
                            _this.configurationNode = nodes.find(function (node) { return node.label === _this.CONFIGURATION_NODE; });
                        });
                        this.docsSubscription = this.docs.items$.subscribe(function (links) {
                            _this.links = links;
                        });
                        // <---TRIAL & REGULAR TENANT --->
                        this.createConnectSmartphoneQuickLink();
                        return [4 /*yield*/, this.createQuicklinkRegisterDevice()];
                    case 2:
                        _b.sent();
                        // <--- TRIAL TENANT --->
                        if (this.tenantType === this.TRIAL) {
                            this.createQuicklinkUserGuide();
                            return [2 /*return*/];
                        }
                        // <--- REGULAR TENANT --->
                        this.createQuicklinkAddGroup();
                        this.createQuickLinkReports();
                        this.createQuickLinkExports();
                        this.createQuicklinkSmartRules();
                        return [2 /*return*/];
                }
            });
        });
    };
    WelcomeToCockpit.prototype.ngOnDestroy = function () {
        if (this.docsSubscription && !this.docsSubscription.closed) {
            this.docsSubscription.unsubscribe();
        }
        if (this.navSubscription && !this.navSubscription.closed) {
            this.navSubscription.unsubscribe();
        }
    };
    WelcomeToCockpit.prototype.setMessage = function () {
        if (this.tenantType === this.TRIAL) {
            this.welcomeMessage = gettext("\n        The Cockpit application allows you to build IoT applications in minutes.\n        To get started, connect any device to the platform.\n        If you do not have an IoT device to hand, you can start by connecting your smartphone.\n        Click below to be guided through the process.\n      ");
        }
        else {
            this.welcomeMessage = gettext("\n        The Cockpit application provides you with options to manage\n        and monitor Internet of Things assets and data from business perspective.\n      ");
        }
    };
    WelcomeToCockpit.prototype.createQuicklinkAddGroup = function () {
        // comes from angularJS factory c8yQuickLinks
        var addGroup = this.links.find(function (link) { return link.label === 'Add group'; });
        if (addGroup) {
            this.quickLinks.push(addGroup);
        }
    };
    WelcomeToCockpit.prototype.createConnectSmartphoneQuickLink = function () {
        // Provider in SensorPhoneModule defines the
        // 'Connect smartphone' quicklink.
        var connectSmartphone = this.links.find(function (link) { return link.label === 'Connect smartphone'; });
        if (connectSmartphone) {
            this.quickLinks.push(connectSmartphone);
        }
    };
    WelcomeToCockpit.prototype.createQuickLinkReports = function () {
        var _this = this;
        var label = gettext('Reports');
        var reports = {
            icon: 'th',
            label: label,
            url: '/reports'
        };
        var reportsNode = this.findNavigatorNode(label, this.navNodes);
        if (reportsNode) {
            reports.click = function () {
                reportsNode.open = true;
                _this.router.navigateByUrl(reports.url);
            };
            this.quickLinks.push(reports);
        }
    };
    WelcomeToCockpit.prototype.createQuickLinkExports = function () {
        var _this = this;
        var label = gettext('Exports');
        var exports = {
            icon: 'c8y-reports',
            label: label,
            url: '/export'
        };
        if (this.isConfigChildNodeShown(label)) {
            exports.click = function () {
                _this.configurationNode.open = true;
                _this.router.navigateByUrl(exports.url);
            };
            this.quickLinks.push(exports);
        }
    };
    WelcomeToCockpit.prototype.createQuicklinkSmartRules = function () {
        var _this = this;
        var label = gettext('Smart rules');
        var smartRules = {
            icon: 'c8y-smart-rules',
            label: label,
            url: '/rules'
        };
        if (this.isConfigChildNodeShown('Global smart rules')) {
            smartRules.click = function () {
                _this.configurationNode.open = true;
                _this.router.navigateByUrl(smartRules.url);
            };
            this.quickLinks.push(smartRules);
        }
    };
    WelcomeToCockpit.prototype.createQuicklinkRegisterDevice = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data, deviceManagement, deviceMgmtUrl_1, registerDevice;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.applicationService.listByUser()];
                    case 1:
                        data = (_a.sent()).data;
                        if (data) {
                            deviceManagement = data.find(function (app) { return app.contextPath === 'devicemanagement'; });
                            if (deviceManagement) {
                                deviceMgmtUrl_1 = this.applicationService.getHref(deviceManagement);
                                registerDevice = {
                                    icon: 'c8y-device-connect',
                                    label: gettext('Register device'),
                                    click: function () { return window.open(deviceMgmtUrl_1 + "/#/deviceregistration", '_self'); }
                                };
                                this.quickLinks.push(registerDevice);
                            }
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    WelcomeToCockpit.prototype.createQuicklinkUserGuide = function () {
        var _this = this;
        var userGuide = {
            icon: 'c8y-user',
            label: gettext('User guide'),
            url: '/users-guide/getting-started',
            click: function () {
                var userGuideURL = _this.docs.getUserGuideLink(userGuide.url);
                window.open(userGuideURL);
            }
        };
        this.quickLinks.push(userGuide);
    };
    WelcomeToCockpit.prototype.isConfigChildNodeShown = function (nodeName) {
        if (this.configurationNode && this.configurationNode.show) {
            var navNode = this.findNavigatorNode(nodeName, this.configurationNode.children);
            return !!navNode && navNode.show;
        }
        return false;
    };
    WelcomeToCockpit.prototype.findNavigatorNode = function (nodeName, navNodes) {
        if (navNodes && navNodes.length > 0) {
            return navNodes.find(function (node) { return node.label === nodeName; });
        }
        return undefined;
    };
    WelcomeToCockpit.ctorParameters = function () { return [
        { type: TenantService },
        { type: DocsService },
        { type: Router },
        { type: NavigatorService },
        { type: ApplicationService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], WelcomeToCockpit.prototype, "config", void 0);
    WelcomeToCockpit = tslib_1.__decorate([
        Component({
            selector: 'c8y-welcome-to-cockpit',
            template: "<div class=\"welcome-widget welcome-cockpit\">\n  <div class=\"flex-row\">\n    <div class=\"col-xs-12 col-md-5 flex-item-v-stretch p-24\">\n      <h2 class=\"text-light\">{{ 'Welcome to Cockpit' | translate }}</h2>\n      <p class=\"text-16 text-light p-t-16 p-b-24\">{{ welcomeMessage | translate }}</p>\n      <div class=\"card-group interact-grid tight-grid\">\n        <div *ngFor=\"let link of quickLinks\" class=\"col-sm-4 col-xs-6\">\n          <c8y-quick-link\n            (click)=\"link.click ? link.click() : false\"\n            [icon]=\"link.icon\"\n            [label]=\"link.label\"\n            class=\"card\"\n            c8yProductExperience\n            [actionName]=\"'welcomeWidgetClicked'\"\n            [actionData]=\"{ link: link.label }\"\n          >\n          </c8y-quick-link>\n        </div>\n      </div>\n    </div>\n    <!-- <div class=\"col-sm-6 welcome-illustration flex-item-v-stretch\"></div> -->\n  </div>\n</div>\n"
        })
    ], WelcomeToCockpit);
    return WelcomeToCockpit;
}());
export { WelcomeToCockpit };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2VsY29tZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL2NvbnRleHQtZGFzaGJvYXJkLyIsInNvdXJjZXMiOlsiY29ja3BpdC1kYXNoYm9hcmQvd2VsY29tZS93ZWxjb21lLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQXFCLE1BQU0sZUFBZSxDQUFDO0FBQ3BFLE9BQU8sRUFDTCxPQUFPLEVBQ1AsV0FBVyxFQUNYLE9BQU8sRUFDUCxnQkFBZ0IsRUFDaEIsYUFBYSxFQUNkLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRXpDLE9BQU8sRUFBRSxhQUFhLEVBQUUsa0JBQWtCLEVBQUUsWUFBWSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBTTlFO0lBY0UsMEJBQ1UsYUFBNEIsRUFDNUIsSUFBaUIsRUFDakIsTUFBYyxFQUNkLFNBQTJCLEVBQzNCLGtCQUFzQztRQUp0QyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixTQUFJLEdBQUosSUFBSSxDQUFhO1FBQ2pCLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCxjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUMzQix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBaEJoRCxlQUFVLEdBQUcsRUFBRSxDQUFDO1FBRUMsdUJBQWtCLEdBQVcsZUFBZSxDQUFDO1FBQzdDLFVBQUssR0FBVyxPQUFPLENBQUM7SUFjdEMsQ0FBQztJQUVFLG1DQUFRLEdBQWQ7Ozs7Ozs7d0JBQ0UsS0FBQSxJQUFJLENBQUE7d0JBQWMscUJBQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsRUFBRSxFQUFBOzt3QkFBOUQsR0FBSyxVQUFVLEdBQUcsU0FBNEMsQ0FBQzt3QkFDL0QsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO3dCQUNsQixJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxVQUFBLEtBQUs7NEJBQzFELEtBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDOzRCQUN0QixLQUFJLENBQUMsaUJBQWlCLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFDLElBQVMsSUFBSyxPQUFBLElBQUksQ0FBQyxLQUFLLEtBQUssS0FBSSxDQUFDLGtCQUFrQixFQUF0QyxDQUFzQyxDQUFDLENBQUM7d0JBQzdGLENBQUMsQ0FBQyxDQUFDO3dCQUNILElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsVUFBQSxLQUFLOzRCQUN0RCxLQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQzt3QkFDckIsQ0FBQyxDQUFDLENBQUM7d0JBRUgsa0NBQWtDO3dCQUNsQyxJQUFJLENBQUMsZ0NBQWdDLEVBQUUsQ0FBQzt3QkFDeEMscUJBQU0sSUFBSSxDQUFDLDZCQUE2QixFQUFFLEVBQUE7O3dCQUExQyxTQUEwQyxDQUFDO3dCQUUzQyx5QkFBeUI7d0JBQ3pCLElBQUksSUFBSSxDQUFDLFVBQVUsS0FBSyxJQUFJLENBQUMsS0FBSyxFQUFFOzRCQUNsQyxJQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQzs0QkFDaEMsc0JBQU87eUJBQ1I7d0JBRUQsMkJBQTJCO3dCQUMzQixJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQzt3QkFDL0IsSUFBSSxDQUFDLHNCQUFzQixFQUFFLENBQUM7d0JBQzlCLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO3dCQUM5QixJQUFJLENBQUMseUJBQXlCLEVBQUUsQ0FBQzs7Ozs7S0FDbEM7SUFFRCxzQ0FBVyxHQUFYO1FBQ0UsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFO1lBQzFELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUNyQztRQUVELElBQUksSUFBSSxDQUFDLGVBQWUsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFO1lBQ3hELElBQUksQ0FBQyxlQUFlLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDcEM7SUFDSCxDQUFDO0lBRU8scUNBQVUsR0FBbEI7UUFDRSxJQUFJLElBQUksQ0FBQyxVQUFVLEtBQUssSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNsQyxJQUFJLENBQUMsY0FBYyxHQUFHLE9BQU8sQ0FBQyxnVEFLN0IsQ0FBQyxDQUFDO1NBQ0o7YUFBTTtZQUNMLElBQUksQ0FBQyxjQUFjLEdBQUcsT0FBTyxDQUFDLGtLQUc3QixDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7SUFFTyxrREFBdUIsR0FBL0I7UUFDRSw2Q0FBNkM7UUFDN0MsSUFBTSxRQUFRLEdBQXFCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFVBQUEsSUFBSSxJQUFJLE9BQUEsSUFBSSxDQUFDLEtBQUssS0FBSyxXQUFXLEVBQTFCLENBQTBCLENBQUMsQ0FBQztRQUN2RixJQUFJLFFBQVEsRUFBRTtZQUNaLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ2hDO0lBQ0gsQ0FBQztJQUVPLDJEQUFnQyxHQUF4QztRQUNFLDRDQUE0QztRQUM1QyxrQ0FBa0M7UUFDbEMsSUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksQ0FBQyxLQUFLLEtBQUssb0JBQW9CLEVBQW5DLENBQW1DLENBQUMsQ0FBQztRQUN2RixJQUFJLGlCQUFpQixFQUFFO1lBQ3JCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7U0FDekM7SUFDSCxDQUFDO0lBRU8saURBQXNCLEdBQTlCO1FBQUEsaUJBZUM7UUFkQyxJQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDakMsSUFBTSxPQUFPLEdBQXFCO1lBQ2hDLElBQUksRUFBRSxJQUFJO1lBQ1YsS0FBSyxPQUFBO1lBQ0wsR0FBRyxFQUFFLFVBQVU7U0FDaEIsQ0FBQztRQUNGLElBQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2pFLElBQUksV0FBVyxFQUFFO1lBQ2YsT0FBTyxDQUFDLEtBQUssR0FBRztnQkFDZCxXQUFXLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztnQkFDeEIsS0FBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3pDLENBQUMsQ0FBQztZQUNGLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQy9CO0lBQ0gsQ0FBQztJQUVPLGlEQUFzQixHQUE5QjtRQUFBLGlCQWVDO1FBZEMsSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2pDLElBQU0sT0FBTyxHQUFxQjtZQUNoQyxJQUFJLEVBQUUsYUFBYTtZQUNuQixLQUFLLE9BQUE7WUFDTCxHQUFHLEVBQUUsU0FBUztTQUNmLENBQUM7UUFFRixJQUFJLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUN0QyxPQUFPLENBQUMsS0FBSyxHQUFHO2dCQUNkLEtBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO2dCQUNuQyxLQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDekMsQ0FBQyxDQUFDO1lBQ0YsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDL0I7SUFDSCxDQUFDO0lBRU8sb0RBQXlCLEdBQWpDO1FBQUEsaUJBY0M7UUFiQyxJQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDckMsSUFBTSxVQUFVLEdBQXFCO1lBQ25DLElBQUksRUFBRSxpQkFBaUI7WUFDdkIsS0FBSyxPQUFBO1lBQ0wsR0FBRyxFQUFFLFFBQVE7U0FDZCxDQUFDO1FBQ0YsSUFBSSxJQUFJLENBQUMsc0JBQXNCLENBQUMsb0JBQW9CLENBQUMsRUFBRTtZQUNyRCxVQUFVLENBQUMsS0FBSyxHQUFHO2dCQUNqQixLQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztnQkFDbkMsS0FBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzVDLENBQUMsQ0FBQztZQUNGLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQ2xDO0lBQ0gsQ0FBQztJQUVhLHdEQUE2QixHQUEzQzs7Ozs7NEJBQ21CLHFCQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLEVBQUUsRUFBQTs7d0JBQW5ELElBQUksR0FBSyxDQUFBLFNBQTBDLENBQUEsS0FBL0M7d0JBQ1osSUFBSSxJQUFJLEVBQUU7NEJBQ0YsZ0JBQWdCLEdBQWlCLElBQUksQ0FBQyxJQUFJLENBQzlDLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxDQUFDLFdBQVcsS0FBSyxrQkFBa0IsRUFBdEMsQ0FBc0MsQ0FDOUMsQ0FBQzs0QkFDRixJQUFJLGdCQUFnQixFQUFFO2dDQUNkLGtCQUFnQixJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7Z0NBQ2xFLGNBQWMsR0FBcUI7b0NBQ3ZDLElBQUksRUFBRSxvQkFBb0I7b0NBQzFCLEtBQUssRUFBRSxPQUFPLENBQUMsaUJBQWlCLENBQUM7b0NBQ2pDLEtBQUssRUFBRSxjQUFNLE9BQUEsTUFBTSxDQUFDLElBQUksQ0FBSSxlQUFhLDBCQUF1QixFQUFFLE9BQU8sQ0FBQyxFQUE3RCxDQUE2RDtpQ0FDM0UsQ0FBQztnQ0FDRixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQzs2QkFDdEM7eUJBQ0Y7Ozs7O0tBQ0Y7SUFFTyxtREFBd0IsR0FBaEM7UUFBQSxpQkFXQztRQVZDLElBQU0sU0FBUyxHQUFxQjtZQUNsQyxJQUFJLEVBQUUsVUFBVTtZQUNoQixLQUFLLEVBQUUsT0FBTyxDQUFDLFlBQVksQ0FBQztZQUM1QixHQUFHLEVBQUUsOEJBQThCO1lBQ25DLEtBQUssRUFBRTtnQkFDTCxJQUFNLFlBQVksR0FBRyxLQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQVcsQ0FBQztnQkFDekUsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUM1QixDQUFDO1NBQ0YsQ0FBQztRQUNGLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFTyxpREFBc0IsR0FBOUIsVUFBK0IsUUFBUTtRQUNyQyxJQUFJLElBQUksQ0FBQyxpQkFBaUIsSUFBSSxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFO1lBQ3pELElBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ2xGLE9BQU8sQ0FBQyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDO1NBQ2xDO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRU8sNENBQWlCLEdBQXpCLFVBQTBCLFFBQWdCLEVBQUUsUUFBeUI7UUFDbkUsSUFBSSxRQUFRLElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDbkMsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQUMsSUFBUyxJQUFLLE9BQUEsSUFBSSxDQUFDLEtBQUssS0FBSyxRQUFRLEVBQXZCLENBQXVCLENBQVEsQ0FBQztTQUNyRTtRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7O2dCQTVLd0IsYUFBYTtnQkFDdEIsV0FBVztnQkFDVCxNQUFNO2dCQUNILGdCQUFnQjtnQkFDUCxrQkFBa0I7O0lBbEJ2QztRQUFSLEtBQUssRUFBRTtvREFBUTtJQURMLGdCQUFnQjtRQUo1QixTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsd0JBQXdCO1lBQ2xDLHE4QkFBdUM7U0FDeEMsQ0FBQztPQUNXLGdCQUFnQixDQTRMNUI7SUFBRCx1QkFBQztDQUFBLEFBNUxELElBNExDO1NBNUxZLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE9uSW5pdCwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBnZXR0ZXh0LFxuICBEb2NzU2VydmljZSxcbiAgRG9jTGluayxcbiAgTmF2aWdhdG9yU2VydmljZSxcbiAgTmF2aWdhdG9yTm9kZVxufSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFRlbmFudFNlcnZpY2UsIEFwcGxpY2F0aW9uU2VydmljZSwgSUFwcGxpY2F0aW9uIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktd2VsY29tZS10by1jb2NrcGl0JyxcbiAgdGVtcGxhdGVVcmw6ICcuL3dlbGNvbWUuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFdlbGNvbWVUb0NvY2twaXQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gIEBJbnB1dCgpIGNvbmZpZztcbiAgd2VsY29tZU1lc3NhZ2U7XG4gIHF1aWNrTGlua3MgPSBbXTtcblxuICBwcml2YXRlIHJlYWRvbmx5IENPTkZJR1VSQVRJT05fTk9ERTogc3RyaW5nID0gJ0NvbmZpZ3VyYXRpb24nO1xuICBwcml2YXRlIHJlYWRvbmx5IFRSSUFMOiBzdHJpbmcgPSAnVFJJQUwnO1xuICBwcml2YXRlIHRlbmFudFR5cGU6IHN0cmluZztcbiAgcHJpdmF0ZSBuYXZOb2RlczogTmF2aWdhdG9yTm9kZVtdO1xuICBwcml2YXRlIGNvbmZpZ3VyYXRpb25Ob2RlOiBhbnk7XG4gIHByaXZhdGUgbGlua3M6IERvY0xpbmtbXTtcbiAgcHJpdmF0ZSBkb2NzU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgbmF2U3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB0ZW5hbnRTZXJ2aWNlOiBUZW5hbnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgZG9jczogRG9jc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICBwcml2YXRlIG5hdmlnYXRvcjogTmF2aWdhdG9yU2VydmljZSxcbiAgICBwcml2YXRlIGFwcGxpY2F0aW9uU2VydmljZTogQXBwbGljYXRpb25TZXJ2aWNlXG4gICkge31cblxuICBhc3luYyBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnRlbmFudFR5cGUgPSBhd2FpdCB0aGlzLnRlbmFudFNlcnZpY2UuY3VycmVudFRlbmFudFR5cGUoKTtcbiAgICB0aGlzLnNldE1lc3NhZ2UoKTtcbiAgICB0aGlzLm5hdlN1YnNjcmlwdGlvbiA9IHRoaXMubmF2aWdhdG9yLml0ZW1zJC5zdWJzY3JpYmUobm9kZXMgPT4ge1xuICAgICAgdGhpcy5uYXZOb2RlcyA9IG5vZGVzO1xuICAgICAgdGhpcy5jb25maWd1cmF0aW9uTm9kZSA9IG5vZGVzLmZpbmQoKG5vZGU6IGFueSkgPT4gbm9kZS5sYWJlbCA9PT0gdGhpcy5DT05GSUdVUkFUSU9OX05PREUpO1xuICAgIH0pO1xuICAgIHRoaXMuZG9jc1N1YnNjcmlwdGlvbiA9IHRoaXMuZG9jcy5pdGVtcyQuc3Vic2NyaWJlKGxpbmtzID0+IHtcbiAgICAgIHRoaXMubGlua3MgPSBsaW5rcztcbiAgICB9KTtcblxuICAgIC8vIDwtLS1UUklBTCAmIFJFR1VMQVIgVEVOQU5UIC0tLT5cbiAgICB0aGlzLmNyZWF0ZUNvbm5lY3RTbWFydHBob25lUXVpY2tMaW5rKCk7XG4gICAgYXdhaXQgdGhpcy5jcmVhdGVRdWlja2xpbmtSZWdpc3RlckRldmljZSgpO1xuXG4gICAgLy8gPC0tLSBUUklBTCBURU5BTlQgLS0tPlxuICAgIGlmICh0aGlzLnRlbmFudFR5cGUgPT09IHRoaXMuVFJJQUwpIHtcbiAgICAgIHRoaXMuY3JlYXRlUXVpY2tsaW5rVXNlckd1aWRlKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gPC0tLSBSRUdVTEFSIFRFTkFOVCAtLS0+XG4gICAgdGhpcy5jcmVhdGVRdWlja2xpbmtBZGRHcm91cCgpO1xuICAgIHRoaXMuY3JlYXRlUXVpY2tMaW5rUmVwb3J0cygpO1xuICAgIHRoaXMuY3JlYXRlUXVpY2tMaW5rRXhwb3J0cygpO1xuICAgIHRoaXMuY3JlYXRlUXVpY2tsaW5rU21hcnRSdWxlcygpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgaWYgKHRoaXMuZG9jc1N1YnNjcmlwdGlvbiAmJiAhdGhpcy5kb2NzU3Vic2NyaXB0aW9uLmNsb3NlZCkge1xuICAgICAgdGhpcy5kb2NzU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubmF2U3Vic2NyaXB0aW9uICYmICF0aGlzLm5hdlN1YnNjcmlwdGlvbi5jbG9zZWQpIHtcbiAgICAgIHRoaXMubmF2U3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRNZXNzYWdlKCkge1xuICAgIGlmICh0aGlzLnRlbmFudFR5cGUgPT09IHRoaXMuVFJJQUwpIHtcbiAgICAgIHRoaXMud2VsY29tZU1lc3NhZ2UgPSBnZXR0ZXh0KGBcbiAgICAgICAgVGhlIENvY2twaXQgYXBwbGljYXRpb24gYWxsb3dzIHlvdSB0byBidWlsZCBJb1QgYXBwbGljYXRpb25zIGluIG1pbnV0ZXMuXG4gICAgICAgIFRvIGdldCBzdGFydGVkLCBjb25uZWN0IGFueSBkZXZpY2UgdG8gdGhlIHBsYXRmb3JtLlxuICAgICAgICBJZiB5b3UgZG8gbm90IGhhdmUgYW4gSW9UIGRldmljZSB0byBoYW5kLCB5b3UgY2FuIHN0YXJ0IGJ5IGNvbm5lY3RpbmcgeW91ciBzbWFydHBob25lLlxuICAgICAgICBDbGljayBiZWxvdyB0byBiZSBndWlkZWQgdGhyb3VnaCB0aGUgcHJvY2Vzcy5cbiAgICAgIGApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLndlbGNvbWVNZXNzYWdlID0gZ2V0dGV4dChgXG4gICAgICAgIFRoZSBDb2NrcGl0IGFwcGxpY2F0aW9uIHByb3ZpZGVzIHlvdSB3aXRoIG9wdGlvbnMgdG8gbWFuYWdlXG4gICAgICAgIGFuZCBtb25pdG9yIEludGVybmV0IG9mIFRoaW5ncyBhc3NldHMgYW5kIGRhdGEgZnJvbSBidXNpbmVzcyBwZXJzcGVjdGl2ZS5cbiAgICAgIGApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUXVpY2tsaW5rQWRkR3JvdXAoKSB7XG4gICAgLy8gY29tZXMgZnJvbSBhbmd1bGFySlMgZmFjdG9yeSBjOHlRdWlja0xpbmtzXG4gICAgY29uc3QgYWRkR3JvdXA6IFBhcnRpYWw8RG9jTGluaz4gPSB0aGlzLmxpbmtzLmZpbmQobGluayA9PiBsaW5rLmxhYmVsID09PSAnQWRkIGdyb3VwJyk7XG4gICAgaWYgKGFkZEdyb3VwKSB7XG4gICAgICB0aGlzLnF1aWNrTGlua3MucHVzaChhZGRHcm91cCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDb25uZWN0U21hcnRwaG9uZVF1aWNrTGluaygpIHtcbiAgICAvLyBQcm92aWRlciBpbiBTZW5zb3JQaG9uZU1vZHVsZSBkZWZpbmVzIHRoZVxuICAgIC8vICdDb25uZWN0IHNtYXJ0cGhvbmUnIHF1aWNrbGluay5cbiAgICBjb25zdCBjb25uZWN0U21hcnRwaG9uZSA9IHRoaXMubGlua3MuZmluZChsaW5rID0+IGxpbmsubGFiZWwgPT09ICdDb25uZWN0IHNtYXJ0cGhvbmUnKTtcbiAgICBpZiAoY29ubmVjdFNtYXJ0cGhvbmUpIHtcbiAgICAgIHRoaXMucXVpY2tMaW5rcy5wdXNoKGNvbm5lY3RTbWFydHBob25lKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVF1aWNrTGlua1JlcG9ydHMoKSB7XG4gICAgY29uc3QgbGFiZWwgPSBnZXR0ZXh0KCdSZXBvcnRzJyk7XG4gICAgY29uc3QgcmVwb3J0czogUGFydGlhbDxEb2NMaW5rPiA9IHtcbiAgICAgIGljb246ICd0aCcsXG4gICAgICBsYWJlbCxcbiAgICAgIHVybDogJy9yZXBvcnRzJ1xuICAgIH07XG4gICAgY29uc3QgcmVwb3J0c05vZGUgPSB0aGlzLmZpbmROYXZpZ2F0b3JOb2RlKGxhYmVsLCB0aGlzLm5hdk5vZGVzKTtcbiAgICBpZiAocmVwb3J0c05vZGUpIHtcbiAgICAgIHJlcG9ydHMuY2xpY2sgPSAoKSA9PiB7XG4gICAgICAgIHJlcG9ydHNOb2RlLm9wZW4gPSB0cnVlO1xuICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKHJlcG9ydHMudXJsKTtcbiAgICAgIH07XG4gICAgICB0aGlzLnF1aWNrTGlua3MucHVzaChyZXBvcnRzKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVF1aWNrTGlua0V4cG9ydHMoKSB7XG4gICAgY29uc3QgbGFiZWwgPSBnZXR0ZXh0KCdFeHBvcnRzJyk7XG4gICAgY29uc3QgZXhwb3J0czogUGFydGlhbDxEb2NMaW5rPiA9IHtcbiAgICAgIGljb246ICdjOHktcmVwb3J0cycsXG4gICAgICBsYWJlbCxcbiAgICAgIHVybDogJy9leHBvcnQnXG4gICAgfTtcblxuICAgIGlmICh0aGlzLmlzQ29uZmlnQ2hpbGROb2RlU2hvd24obGFiZWwpKSB7XG4gICAgICBleHBvcnRzLmNsaWNrID0gKCkgPT4ge1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb25Ob2RlLm9wZW4gPSB0cnVlO1xuICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKGV4cG9ydHMudXJsKTtcbiAgICAgIH07XG4gICAgICB0aGlzLnF1aWNrTGlua3MucHVzaChleHBvcnRzKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVF1aWNrbGlua1NtYXJ0UnVsZXMoKSB7XG4gICAgY29uc3QgbGFiZWwgPSBnZXR0ZXh0KCdTbWFydCBydWxlcycpO1xuICAgIGNvbnN0IHNtYXJ0UnVsZXM6IFBhcnRpYWw8RG9jTGluaz4gPSB7XG4gICAgICBpY29uOiAnYzh5LXNtYXJ0LXJ1bGVzJyxcbiAgICAgIGxhYmVsLFxuICAgICAgdXJsOiAnL3J1bGVzJ1xuICAgIH07XG4gICAgaWYgKHRoaXMuaXNDb25maWdDaGlsZE5vZGVTaG93bignR2xvYmFsIHNtYXJ0IHJ1bGVzJykpIHtcbiAgICAgIHNtYXJ0UnVsZXMuY2xpY2sgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMuY29uZmlndXJhdGlvbk5vZGUub3BlbiA9IHRydWU7XG4gICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlQnlVcmwoc21hcnRSdWxlcy51cmwpO1xuICAgICAgfTtcbiAgICAgIHRoaXMucXVpY2tMaW5rcy5wdXNoKHNtYXJ0UnVsZXMpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY3JlYXRlUXVpY2tsaW5rUmVnaXN0ZXJEZXZpY2UoKSB7XG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLmFwcGxpY2F0aW9uU2VydmljZS5saXN0QnlVc2VyKCk7XG4gICAgaWYgKGRhdGEpIHtcbiAgICAgIGNvbnN0IGRldmljZU1hbmFnZW1lbnQ6IElBcHBsaWNhdGlvbiA9IGRhdGEuZmluZChcbiAgICAgICAgYXBwID0+IGFwcC5jb250ZXh0UGF0aCA9PT0gJ2RldmljZW1hbmFnZW1lbnQnXG4gICAgICApO1xuICAgICAgaWYgKGRldmljZU1hbmFnZW1lbnQpIHtcbiAgICAgICAgY29uc3QgZGV2aWNlTWdtdFVybCA9IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmdldEhyZWYoZGV2aWNlTWFuYWdlbWVudCk7XG4gICAgICAgIGNvbnN0IHJlZ2lzdGVyRGV2aWNlOiBQYXJ0aWFsPERvY0xpbms+ID0ge1xuICAgICAgICAgIGljb246ICdjOHktZGV2aWNlLWNvbm5lY3QnLFxuICAgICAgICAgIGxhYmVsOiBnZXR0ZXh0KCdSZWdpc3RlciBkZXZpY2UnKSxcbiAgICAgICAgICBjbGljazogKCkgPT4gd2luZG93Lm9wZW4oYCR7ZGV2aWNlTWdtdFVybH0vIy9kZXZpY2VyZWdpc3RyYXRpb25gLCAnX3NlbGYnKVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnF1aWNrTGlua3MucHVzaChyZWdpc3RlckRldmljZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVRdWlja2xpbmtVc2VyR3VpZGUoKSB7XG4gICAgY29uc3QgdXNlckd1aWRlOiBQYXJ0aWFsPERvY0xpbms+ID0ge1xuICAgICAgaWNvbjogJ2M4eS11c2VyJyxcbiAgICAgIGxhYmVsOiBnZXR0ZXh0KCdVc2VyIGd1aWRlJyksXG4gICAgICB1cmw6ICcvdXNlcnMtZ3VpZGUvZ2V0dGluZy1zdGFydGVkJyxcbiAgICAgIGNsaWNrOiAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHVzZXJHdWlkZVVSTCA9IHRoaXMuZG9jcy5nZXRVc2VyR3VpZGVMaW5rKHVzZXJHdWlkZS51cmwpIGFzIHN0cmluZztcbiAgICAgICAgd2luZG93Lm9wZW4odXNlckd1aWRlVVJMKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMucXVpY2tMaW5rcy5wdXNoKHVzZXJHdWlkZSk7XG4gIH1cblxuICBwcml2YXRlIGlzQ29uZmlnQ2hpbGROb2RlU2hvd24obm9kZU5hbWUpIHtcbiAgICBpZiAodGhpcy5jb25maWd1cmF0aW9uTm9kZSAmJiB0aGlzLmNvbmZpZ3VyYXRpb25Ob2RlLnNob3cpIHtcbiAgICAgIGNvbnN0IG5hdk5vZGUgPSB0aGlzLmZpbmROYXZpZ2F0b3JOb2RlKG5vZGVOYW1lLCB0aGlzLmNvbmZpZ3VyYXRpb25Ob2RlLmNoaWxkcmVuKTtcbiAgICAgIHJldHVybiAhIW5hdk5vZGUgJiYgbmF2Tm9kZS5zaG93O1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGZpbmROYXZpZ2F0b3JOb2RlKG5vZGVOYW1lOiBzdHJpbmcsIG5hdk5vZGVzOiBOYXZpZ2F0b3JOb2RlW10pIHtcbiAgICBpZiAobmF2Tm9kZXMgJiYgbmF2Tm9kZXMubGVuZ3RoID4gMCkge1xuICAgICAgcmV0dXJuIG5hdk5vZGVzLmZpbmQoKG5vZGU6IGFueSkgPT4gbm9kZS5sYWJlbCA9PT0gbm9kZU5hbWUpIGFzIGFueTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxufVxuIl19