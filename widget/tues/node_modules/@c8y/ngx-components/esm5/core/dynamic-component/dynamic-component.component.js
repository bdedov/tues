import * as tslib_1 from "tslib";
import { Component, Input, ViewChild, ComponentFactoryResolver, ViewContainerRef, ComponentRef } from '@angular/core';
import { DynamicComponentService } from './dynamic-component.service';
import { of, isObservable } from 'rxjs';
import { isUndefined } from 'lodash-es';
/**
 * C8y dynamic component.
 * ## Example:
 *
 * register component in HOOK in module:
 * ```typescript
 *  import { HOOK_COMPONENT } from '@c8y/ngx-components';
 *
 * @NgModule({
 *  ...,
 *  providers: [{
 *      provide: HOOK_COMPONENT,
 *      multi: true,
 *      useValue: [{
 *          id: 'test-component',
 *          label: 'My test component',
 *          description: 'this is test component',
 *          component: TestComponent
 *      }],
 *  ...
 *  }]
 *
 * ```
 * Showing dynamic component:
 * ```html
 * <c8y-dynamic-component [componentId]="'test-component'" [config]="config"></c8y-dynamic-component>
 * ```
 */
var DynamicComponentComponent = /** @class */ (function () {
    /**
     * @ignore only DI
     */
    function DynamicComponentComponent(componentFactoryResolver, dynamicComponentService) {
        this.componentFactoryResolver = componentFactoryResolver;
        this.dynamicComponentService = dynamicComponentService;
        /**
         * DynamicComponents can have two modes, an edit (config) and an view (component) mode.
         * By default it is shown in the component mode.
         */
        this.mode = 'component';
        /**
         * Disable this to hide the error that is shown if the component was not found.
         */
        this.notFoundError = true;
        /**
         * @ignore
         */
        this.expandErrorDetails = false;
    }
    /**
     * Calls the dynamic component life cycle hook. Currently only
     * supporting onBeforeSave, a hook which is called before a config component
     * is saved.
     */
    DynamicComponentComponent.prototype.callLifeCycleHooks = function () {
        return this.callOnBeforeSaveHook();
    };
    /**
     * @ignore
     */
    DynamicComponentComponent.prototype.ngOnChanges = function () {
        var _this = this;
        this.dynamicComponentService
            .getById$(this.componentId)
            .subscribe(function (cmp) { return _this.loadComponent(cmp); });
    };
    DynamicComponentComponent.prototype.loadComponent = function (dynamicComponent) {
        try {
            this.error = undefined;
            var componentFactory = this.componentFactoryResolver.resolveComponentFactory(this.mode === 'component' ? dynamicComponent.component : dynamicComponent.configComponent);
            this.host.clear();
            this.componentRef = this.host.createComponent(componentFactory);
            this.componentRef.instance.config = this.config;
        }
        catch (ex) {
            this.error = ex;
        }
    };
    DynamicComponentComponent.prototype.callOnBeforeSaveHook = function () {
        if (!this.componentRef) {
            return of(true);
        }
        var hook = this.componentRef.instance.onBeforeSave;
        if (hook) {
            var result = hook.call(this.componentRef.instance, this.config);
            if (isUndefined(result)) {
                return of(true);
            }
            return isObservable(result) ? result : of(result);
        }
        return of(true);
    };
    DynamicComponentComponent.ctorParameters = function () { return [
        { type: ComponentFactoryResolver },
        { type: DynamicComponentService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], DynamicComponentComponent.prototype, "componentId", void 0);
    tslib_1.__decorate([
        Input()
    ], DynamicComponentComponent.prototype, "config", void 0);
    tslib_1.__decorate([
        Input()
    ], DynamicComponentComponent.prototype, "mode", void 0);
    tslib_1.__decorate([
        Input()
    ], DynamicComponentComponent.prototype, "notFoundError", void 0);
    tslib_1.__decorate([
        ViewChild('host', { read: ViewContainerRef, static: true })
    ], DynamicComponentComponent.prototype, "host", void 0);
    DynamicComponentComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-dynamic-component',
            template: "<ng-template #host></ng-template>\n\n<div class=\"alert alert-warning m-8\" role=\"alert\" *ngIf=\"notFoundError && error\">\n  <strong class=\"message\">\n    {{\n      'This widget cannot be rendered because the current application does not support the following component:'\n        | translate\n    }}\n    {{ componentId }}.\n  </strong>\n  <p class=\"text-muted top-m-sm\">\n    <button class=\"btn btn-clean\" (click)=\"expandErrorDetails = !expandErrorDetails\">\n      <i class=\"fa fa-chevron-down\"></i>\n      <span *ngIf=\"!expandErrorDetails\" translate>Show details</span>\n      <span *ngIf=\"expandErrorDetails\" translate>Hide details</span>\n    </button>\n  </p>\n  <div [collapse]=\"!expandErrorDetails\" [isAnimated]=\"true\">\n    <pre>\n      {{ error }}\n    </pre>\n  </div>\n</div>\n"
        })
    ], DynamicComponentComponent);
    return DynamicComponentComponent;
}());
export { DynamicComponentComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1jb21wb25lbnQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImNvcmUvZHluYW1pYy1jb21wb25lbnQvZHluYW1pYy1jb21wb25lbnQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULEtBQUssRUFDTCxTQUFTLEVBQ1Qsd0JBQXdCLEVBQ3hCLGdCQUFnQixFQUNoQixZQUFZLEVBQ2IsTUFBTSxlQUFlLENBQUM7QUFNdkIsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDdEUsT0FBTyxFQUFFLEVBQUUsRUFBRSxZQUFZLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDcEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUV4Qzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBMkJHO0FBS0g7SUFpQ0U7O09BRUc7SUFDSCxtQ0FDVSx3QkFBa0QsRUFDbEQsdUJBQWdEO1FBRGhELDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQTVCMUQ7OztXQUdHO1FBQ00sU0FBSSxHQUEyQixXQUFXLENBQUM7UUFDcEQ7O1dBRUc7UUFDTSxrQkFBYSxHQUFHLElBQUksQ0FBQztRQVM5Qjs7V0FFRztRQUNILHVCQUFrQixHQUFHLEtBQUssQ0FBQztJQVN4QixDQUFDO0lBRUo7Ozs7T0FJRztJQUNILHNEQUFrQixHQUFsQjtRQUNFLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7SUFDckMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsK0NBQVcsR0FBWDtRQUFBLGlCQUlDO1FBSEMsSUFBSSxDQUFDLHVCQUF1QjthQUN6QixRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQzthQUMxQixTQUFTLENBQUMsVUFBQSxHQUFHLElBQUksT0FBQSxLQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxFQUF2QixDQUF1QixDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVPLGlEQUFhLEdBQXJCLFVBQXNCLGdCQUE0QztRQUNoRSxJQUFJO1lBQ0YsSUFBSSxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUM7WUFDdkIsSUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsd0JBQXdCLENBQUMsdUJBQXVCLENBQzVFLElBQUksQ0FBQyxJQUFJLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLGVBQWUsQ0FDMUYsQ0FBQztZQUNGLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDbEIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQy9ELElBQUksQ0FBQyxZQUFZLENBQUMsUUFBNkIsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztTQUN2RTtRQUFDLE9BQU8sRUFBRSxFQUFFO1lBQ1gsSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7U0FDakI7SUFDSCxDQUFDO0lBRU8sd0RBQW9CLEdBQTVCO1FBQ0UsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDdEIsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDakI7UUFDRCxJQUFNLElBQUksR0FBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQXlCLENBQUMsWUFBWSxDQUFDO1FBQ3ZFLElBQUksSUFBSSxFQUFFO1lBQ1IsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDbEUsSUFBSSxXQUFXLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQ3ZCLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ2pCO1lBQ0QsT0FBTyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBeUIsQ0FBQztTQUM1RTtRQUNELE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xCLENBQUM7O2dCQWpEbUMsd0JBQXdCO2dCQUN6Qix1QkFBdUI7O0lBakNqRDtRQUFSLEtBQUssRUFBRTtrRUFBcUI7SUFJcEI7UUFBUixLQUFLLEVBQUU7NkRBQWE7SUFLWjtRQUFSLEtBQUssRUFBRTsyREFBNEM7SUFJM0M7UUFBUixLQUFLLEVBQUU7b0VBQXNCO0lBSStCO1FBQTVELFNBQVMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDOzJEQUF3QjtJQXRCekUseUJBQXlCO1FBSnJDLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSx1QkFBdUI7WUFDakMsc3pCQUFpRDtTQUNsRCxDQUFDO09BQ1cseUJBQXlCLENBdUZyQztJQUFELGdDQUFDO0NBQUEsQUF2RkQsSUF1RkM7U0F2RlkseUJBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBJbnB1dCxcbiAgVmlld0NoaWxkLFxuICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gIFZpZXdDb250YWluZXJSZWYsXG4gIENvbXBvbmVudFJlZlxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIER5bmFtaWNDb21wb25lbnQsXG4gIER5bmFtaWNDb21wb25lbnREZWZpbml0aW9uLFxuICBPbkJlZm9yZVNhdmVcbn0gZnJvbSAnLi9keW5hbWljLWNvbXBvbmVudC5tb2RlbCc7XG5pbXBvcnQgeyBEeW5hbWljQ29tcG9uZW50U2VydmljZSB9IGZyb20gJy4vZHluYW1pYy1jb21wb25lbnQuc2VydmljZSc7XG5pbXBvcnQgeyBvZiwgaXNPYnNlcnZhYmxlLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBpc1VuZGVmaW5lZCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5cbi8qKlxuICogQzh5IGR5bmFtaWMgY29tcG9uZW50LlxuICogIyMgRXhhbXBsZTpcbiAqXG4gKiByZWdpc3RlciBjb21wb25lbnQgaW4gSE9PSyBpbiBtb2R1bGU6XG4gKiBgYGB0eXBlc2NyaXB0XG4gKiAgaW1wb3J0IHsgSE9PS19DT01QT05FTlQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbiAqXG4gKiBATmdNb2R1bGUoe1xuICogIC4uLixcbiAqICBwcm92aWRlcnM6IFt7XG4gKiAgICAgIHByb3ZpZGU6IEhPT0tfQ09NUE9ORU5ULFxuICogICAgICBtdWx0aTogdHJ1ZSxcbiAqICAgICAgdXNlVmFsdWU6IFt7XG4gKiAgICAgICAgICBpZDogJ3Rlc3QtY29tcG9uZW50JyxcbiAqICAgICAgICAgIGxhYmVsOiAnTXkgdGVzdCBjb21wb25lbnQnLFxuICogICAgICAgICAgZGVzY3JpcHRpb246ICd0aGlzIGlzIHRlc3QgY29tcG9uZW50JyxcbiAqICAgICAgICAgIGNvbXBvbmVudDogVGVzdENvbXBvbmVudFxuICogICAgICB9XSxcbiAqICAuLi5cbiAqICB9XVxuICpcbiAqIGBgYFxuICogU2hvd2luZyBkeW5hbWljIGNvbXBvbmVudDpcbiAqIGBgYGh0bWxcbiAqIDxjOHktZHluYW1pYy1jb21wb25lbnQgW2NvbXBvbmVudElkXT1cIid0ZXN0LWNvbXBvbmVudCdcIiBbY29uZmlnXT1cImNvbmZpZ1wiPjwvYzh5LWR5bmFtaWMtY29tcG9uZW50PlxuICogYGBgXG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1keW5hbWljLWNvbXBvbmVudCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9keW5hbWljLWNvbXBvbmVudC5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgRHluYW1pY0NvbXBvbmVudENvbXBvbmVudCB7XG4gIC8qKlxuICAgKiBUaGUgSUQgb2YgdGhlIHJlZ2lzdGVyZWQgY29tcG9uZW50LiBJdCBuZWVkcyB0byBiZSBhIGNvbXBvbmVudCB0aGF0IGlzIGhvb2tlZFxuICAgKiB3aXRoIHRoZSBIT09LX0NPTVBPTkVOVFMgZXh0ZW5zaW9uIGhvb2suXG4gICAqL1xuICBASW5wdXQoKSBjb21wb25lbnRJZDogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIGNvbmZpZ3VyYXRpb24gdG8gcGFzcy5cbiAgICovXG4gIEBJbnB1dCgpIGNvbmZpZzogYW55O1xuICAvKipcbiAgICogRHluYW1pY0NvbXBvbmVudHMgY2FuIGhhdmUgdHdvIG1vZGVzLCBhbiBlZGl0IChjb25maWcpIGFuZCBhbiB2aWV3IChjb21wb25lbnQpIG1vZGUuXG4gICAqIEJ5IGRlZmF1bHQgaXQgaXMgc2hvd24gaW4gdGhlIGNvbXBvbmVudCBtb2RlLlxuICAgKi9cbiAgQElucHV0KCkgbW9kZTogJ2NvbmZpZycgfCAnY29tcG9uZW50JyA9ICdjb21wb25lbnQnO1xuICAvKipcbiAgICogRGlzYWJsZSB0aGlzIHRvIGhpZGUgdGhlIGVycm9yIHRoYXQgaXMgc2hvd24gaWYgdGhlIGNvbXBvbmVudCB3YXMgbm90IGZvdW5kLlxuICAgKi9cbiAgQElucHV0KCkgbm90Rm91bmRFcnJvciA9IHRydWU7XG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBAVmlld0NoaWxkKCdob3N0JywgeyByZWFkOiBWaWV3Q29udGFpbmVyUmVmLCBzdGF0aWM6IHRydWUgfSkgaG9zdDogVmlld0NvbnRhaW5lclJlZjtcbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIGVycm9yOiBhbnk7XG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBleHBhbmRFcnJvckRldGFpbHMgPSBmYWxzZTtcbiAgcHJpdmF0ZSBjb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjxDb21wb25lbnQ+O1xuXG4gIC8qKlxuICAgKiBAaWdub3JlIG9ubHkgRElcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgcHJpdmF0ZSBkeW5hbWljQ29tcG9uZW50U2VydmljZTogRHluYW1pY0NvbXBvbmVudFNlcnZpY2VcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBDYWxscyB0aGUgZHluYW1pYyBjb21wb25lbnQgbGlmZSBjeWNsZSBob29rLiBDdXJyZW50bHkgb25seVxuICAgKiBzdXBwb3J0aW5nIG9uQmVmb3JlU2F2ZSwgYSBob29rIHdoaWNoIGlzIGNhbGxlZCBiZWZvcmUgYSBjb25maWcgY29tcG9uZW50XG4gICAqIGlzIHNhdmVkLlxuICAgKi9cbiAgY2FsbExpZmVDeWNsZUhvb2tzKCkge1xuICAgIHJldHVybiB0aGlzLmNhbGxPbkJlZm9yZVNhdmVIb29rKCk7XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgbmdPbkNoYW5nZXMoKTogdm9pZCB7XG4gICAgdGhpcy5keW5hbWljQ29tcG9uZW50U2VydmljZVxuICAgICAgLmdldEJ5SWQkKHRoaXMuY29tcG9uZW50SWQpXG4gICAgICAuc3Vic2NyaWJlKGNtcCA9PiB0aGlzLmxvYWRDb21wb25lbnQoY21wKSk7XG4gIH1cblxuICBwcml2YXRlIGxvYWRDb21wb25lbnQoZHluYW1pY0NvbXBvbmVudDogRHluYW1pY0NvbXBvbmVudERlZmluaXRpb24pIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5lcnJvciA9IHVuZGVmaW5lZDtcbiAgICAgIGNvbnN0IGNvbXBvbmVudEZhY3RvcnkgPSB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShcbiAgICAgICAgdGhpcy5tb2RlID09PSAnY29tcG9uZW50JyA/IGR5bmFtaWNDb21wb25lbnQuY29tcG9uZW50IDogZHluYW1pY0NvbXBvbmVudC5jb25maWdDb21wb25lbnRcbiAgICAgICk7XG4gICAgICB0aGlzLmhvc3QuY2xlYXIoKTtcbiAgICAgIHRoaXMuY29tcG9uZW50UmVmID0gdGhpcy5ob3N0LmNyZWF0ZUNvbXBvbmVudChjb21wb25lbnRGYWN0b3J5KTtcbiAgICAgICh0aGlzLmNvbXBvbmVudFJlZi5pbnN0YW5jZSBhcyBEeW5hbWljQ29tcG9uZW50KS5jb25maWcgPSB0aGlzLmNvbmZpZztcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5lcnJvciA9IGV4O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2FsbE9uQmVmb3JlU2F2ZUhvb2soKSB7XG4gICAgaWYgKCF0aGlzLmNvbXBvbmVudFJlZikge1xuICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgIH1cbiAgICBjb25zdCBob29rID0gKHRoaXMuY29tcG9uZW50UmVmLmluc3RhbmNlIGFzIE9uQmVmb3JlU2F2ZSkub25CZWZvcmVTYXZlO1xuICAgIGlmIChob29rKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBob29rLmNhbGwodGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UsIHRoaXMuY29uZmlnKTtcbiAgICAgIGlmIChpc1VuZGVmaW5lZChyZXN1bHQpKSB7XG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBpc09ic2VydmFibGUocmVzdWx0KSA/IHJlc3VsdCA6IChvZihyZXN1bHQpIGFzIE9ic2VydmFibGU8Ym9vbGVhbj4pO1xuICAgIH1cbiAgICByZXR1cm4gb2YodHJ1ZSk7XG4gIH1cbn1cbiJdfQ==