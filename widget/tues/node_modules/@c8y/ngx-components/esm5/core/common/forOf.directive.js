import * as tslib_1 from "tslib";
import { coerceNumberProperty } from '@angular/cdk/coercion';
import { ComponentFactory, ComponentFactoryResolver, Directive, EmbeddedViewRef, Input, SimpleChanges, TemplateRef, ViewContainerRef, ViewRef } from '@angular/core';
import { assign, get } from 'lodash-es';
import { isObservable, of, pipe, Subject } from 'rxjs';
import { map, takeUntil, tap } from 'rxjs/operators';
import { LoadMoreComponent } from './load-more.component';
/**
 * A directive to iterate over IResultList<T> data from @c8y/client.
 * Depending on the [c8yForLoadMore] a load more button is:
 *  - auto: Tries to automatically load more data (default maximum 10 iterations; can be
 *          change with maxIterations settings).
 *  - show: Shows a load more button for the user to decide
 *  - none: Doesn't perform any load more action.
 *  - hidden: Loads more data automatically but with no visible button for the user.
 *
 * Additional, any rxjs operator pipe can be applied to the [c8yForPipe] input, e.g. to
 * filter the data displayed currently as well as the data loaded by subsequent requests.
 *
 * Example:
 * ```html
 * <div *c8yFor="let device of devices; loadMore: 'auto'; let i = index; pipe: filterPipe;">
 *  {{ i + 1 }}. {{device.name}}
 * </div>
 * ```
 * The above example will list all entities that are applied to `devices`:
 * ```typescript
 * this.devices = this.inventoryService.list({ pageSize: 10, fragmentType: 'c8y_IsDevice' })
 * ```
 * It will display the first 10 items, if there is more space left on the screen, and there are more
 * than 10 devices, it will automatically load up to 10 pages more. If it still can't fit the screen
 * it will stop and switch to `show` mode.
 *
 * A pipe can be applied e.g. for filtering or grouping. This pipe is attached to every follow up
 * request done by the load more component:
 * ```typescript
 * this.filterPipe = pipe(
 *    map((data: []) => {
 *     return data.filter(
 *      (mo: any) => mo.name && mo.name.toLowerCase().indexOf(value.toLowerCase()) > -1
 *    );
 *  })
 * );
 * ```
 * The pipe must be an rxjs pipe and can take any operator.
 */
var ForOfDirective = /** @class */ (function () {
    function ForOfDirective(tpl, vcr, componentFactoryResolver) {
        this.tpl = tpl;
        this.vcr = vcr;
        this.componentFactoryResolver = componentFactoryResolver;
        this.cachedData = [];
        this.loadMoreMode = 'auto';
        this.dataPipe = pipe(tap());
        this.maxIterations = 10;
        this.unsubscribe$ = new Subject();
    }
    Object.defineProperty(ForOfDirective.prototype, "shouldUseLoadMoreButton", {
        get: function () {
            return (this.loadMoreMode === 'auto' || this.loadMoreMode === 'show' || this.loadMoreMode === 'hidden');
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "hasMoreData", {
        get: function () {
            return this.loadMore && this.loadMore.hasMore;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "length", {
        get: function () {
            return this.cachedData.length;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForOf", {
        /**
         * The data setter. Must be a response from @c8y/data or an observable.
         * You can pass an observable with null to explicitly clear the list.
         */
        set: function (fetchData) {
            var _this = this;
            if (fetchData) {
                this.obs$ = (isObservable(fetchData) ? fetchData : of(fetchData)).pipe(map(function (result) {
                    if (result === null) {
                        _this.paging = null;
                        return [];
                    }
                    var paging = result.paging, data = result.data;
                    _this.paging = paging;
                    return data;
                }));
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForLoadMore", {
        /**
         * The mode setter:
         *  - auto: Tries to automatically load more data (default maximum 10 iterations; can be
         *          change with maxIterations settings).
         *  - show: Shows a load more button for the user to decide
         *  - none: Doesn't perform any load more action.
         *  - hidden: Loads more data automatically but with no visible button for the user.
         */
        set: function (type) {
            this.loadMoreMode = type;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForPipe", {
        /**
         * The pipe setter to attach any rxjs pipe to the current and more loaded data.
         */
        set: function (dataPipe) {
            if (dataPipe) {
                this.dataPipe = dataPipe;
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForNotFound", {
        /**
         * A template to use if no data is found at all (e.g. if you apply a filter pipe).
         */
        set: function (notFoundTemplate) {
            this.notFoundTemplate = notFoundTemplate;
            if (this.loadMore) {
                this.loadMore.noMoreDataHint = notFoundTemplate;
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForMaxIterations", {
        /**
         * The maximum numbers of iterations to call data from the api.
         */
        set: function (maxIterations) {
            this.maxIterations = maxIterations;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForRealtime", {
        /**
         * A RealtimeService instance.
         */
        set: function (source) {
            this.realtime = source;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ForOfDirective.prototype, "c8yForComparator", {
        /**
         * A comparator function for comparing list items. Used to determine
         * the position at which a new element should be added to the list.
         */
        set: function (comparator) {
            this.comparator = comparator;
        },
        enumerable: true,
        configurable: true
    });
    ForOfDirective.prototype.ngOnInit = function () {
        this.handleRealtime();
    };
    ForOfDirective.prototype.ngOnChanges = function (changes) {
        var _this = this;
        if (this.obs$ && (changes.c8yForPipe || changes.c8yForOf)) {
            this.unsubscribePaging();
            // only re-rendering  on filtering if all data is already loaded
            // from the backend
            var reRender_1 = !this.hasMoreData && !!changes.c8yForPipe && !changes.c8yForOf;
            if (reRender_1) {
                this.obs$ = of(this.cachedData);
            }
            this.pagingSub = this.obs$
                .pipe(tap(function (data) {
                if (!reRender_1) {
                    _this.cachedData = data;
                }
            }))
                .pipe(function (src) { return _this.dataPipe(src); })
                .subscribe(function (data) {
                _this.render(data, reRender_1);
            });
        }
    };
    ForOfDirective.prototype.ngOnDestroy = function () {
        this.unsubscribePaging();
        this.unsubscribe$.next();
        this.unsubscribe$.complete();
    };
    ForOfDirective.prototype.handleRealtime = function () {
        var _this = this;
        if (this.realtime) {
            this.realtime
                .onCreate$()
                .pipe(takeUntil(this.unsubscribe$))
                .subscribe(function (item) { return _this.insert(item); });
            this.realtime
                .onUpdate$()
                .pipe(takeUntil(this.unsubscribe$))
                .subscribe(function (item) { return _this.update(item); });
            this.realtime
                .onDelete$()
                .pipe(takeUntil(this.unsubscribe$))
                .subscribe(function (id) { return _this.remove(coerceNumberProperty(id)); });
        }
    };
    ForOfDirective.prototype.render = function (data, reRender) {
        var _this = this;
        if (reRender === void 0) { reRender = false; }
        this.vcr.clear();
        data.forEach(function (item, index) {
            var context = {
                $implicit: item,
                index: index,
                length: _this.length,
                hasMore: _this.hasMoreData
            };
            _this.vcr.createEmbeddedView(_this.tpl, context);
        });
        if (this.shouldUseLoadMoreButton) {
            this.loadMore = this.createLoadMoreButtonComponent(reRender);
        }
    };
    ForOfDirective.prototype.append = function (data) {
        var _this = this;
        data.forEach(function (item) {
            var index = _this.shouldUseLoadMoreButton ? _this.vcr.length - 1 : _this.vcr.length;
            var context = {
                $implicit: item,
                index: index,
                length: _this.length,
                hasMore: _this.hasMoreData
            };
            _this.vcr.createEmbeddedView(_this.tpl, context, index);
        });
    };
    ForOfDirective.prototype.loadMoreData = function (data) {
        if (data.length > 0) {
            this.append(data);
        }
    };
    ForOfDirective.prototype.createLoadMoreButtonComponent = function (reRender) {
        var _this = this;
        var componentFactory = this.componentFactoryResolver.resolveComponentFactory(LoadMoreComponent);
        var componentRef = this.vcr.createComponent(componentFactory);
        var instance = componentRef.instance;
        instance.paging = this.paging;
        instance.useIntersection = this.loadMoreMode === 'auto' || this.loadMoreMode === 'hidden';
        instance.hidden = this.loadMoreMode === 'hidden';
        instance.maxIterations = this.maxIterations;
        instance.noMoreDataHint = this.notFoundTemplate;
        this.pagingSub = instance.onLoad
            .pipe(map(function (data) { return _this.checkForDuplicates(data); }), tap(function (data) {
            _this.cachedData = _this.cachedData.concat(data);
        }))
            .pipe(function (src) { return _this.dataPipe(src); })
            .subscribe(function (data) { return _this.loadMoreData(data); });
        if (reRender) {
            assign(instance, this.loadMore);
        }
        return instance;
    };
    ForOfDirective.prototype.insert = function (item) {
        var index = 0;
        if (this.comparator && this.cachedData.length) {
            var comparisionResult = void 0;
            do {
                var view = this.vcr.get(index);
                var itemB = get(view, 'context.$implicit');
                comparisionResult = item && itemB ? this.comparator(item, itemB) : 0;
                if (comparisionResult <= 0) {
                    index++;
                }
            } while (comparisionResult <= 0 && index < this.cachedData.length);
        }
        // Do not append elements after the last one currently loaded,
        // as it may belong further down there on the list and will
        // be eventually loaded with one of the next pages.
        if (index < this.cachedData.length || this.cachedData.length === 0) {
            var context = {
                $implicit: item,
                index: index,
                length: this.length,
                hasMore: this.hasMoreData
            };
            this.cachedData.splice(index, 0, item);
            var viewRef = this.tpl.createEmbeddedView(context);
            this.vcr.insert(viewRef, index);
        }
    };
    ForOfDirective.prototype.update = function (updatedItem) {
        this.forMatchingEmbeddedViewRef(function (item) { return item && updatedItem && item.id === updatedItem.id; }, function (view) {
            view.context.$implicit = updatedItem;
            view.markForCheck();
        });
    };
    ForOfDirective.prototype.remove = function (idToRemove) {
        this.forMatchingEmbeddedViewRef(function (item) { return item && coerceNumberProperty(item.id, NaN) === idToRemove; }, function (view) { return view.destroy(); });
    };
    ForOfDirective.prototype.forMatchingEmbeddedViewRef = function (filter, callback) {
        for (var i = 0; i < this.vcr.length; i++) {
            var view = this.vcr.get(i);
            var item = get(view, 'context.$implicit');
            if (filter(item)) {
                callback(view);
            }
        }
    };
    ForOfDirective.prototype.checkForDuplicates = function (data) {
        var _this = this;
        return this.realtime
            ? data.filter(function (item) { return !_this.cachedData.some(function (cached) { return cached.id === item.id; }); })
            : data;
    };
    ForOfDirective.prototype.unsubscribePaging = function () {
        if (this.pagingSub) {
            this.pagingSub.unsubscribe();
        }
    };
    ForOfDirective.ctorParameters = function () { return [
        { type: TemplateRef },
        { type: ViewContainerRef },
        { type: ComponentFactoryResolver }
    ]; };
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForOf", null);
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForLoadMore", null);
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForPipe", null);
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForNotFound", null);
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForMaxIterations", null);
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForRealtime", null);
    tslib_1.__decorate([
        Input()
    ], ForOfDirective.prototype, "c8yForComparator", null);
    ForOfDirective = tslib_1.__decorate([
        Directive({
            selector: '[c8yFor]'
        })
    ], ForOfDirective);
    return ForOfDirective;
}());
export { ForOfDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9yT2YuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImNvcmUvY29tbW9uL2Zvck9mLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDN0QsT0FBTyxFQUNMLGdCQUFnQixFQUNoQix3QkFBd0IsRUFDeEIsU0FBUyxFQUNULGVBQWUsRUFDZixLQUFLLEVBQ0wsYUFBYSxFQUNiLFdBQVcsRUFDWCxnQkFBZ0IsRUFDaEIsT0FBTyxFQUNSLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxZQUFZLEVBQWMsRUFBRSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBQ2pGLE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXJELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRzFEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXNDRztBQUlIO0lBNEdFLHdCQUNVLEdBQXFCLEVBQ3JCLEdBQXFCLEVBQ3JCLHdCQUFrRDtRQUZsRCxRQUFHLEdBQUgsR0FBRyxDQUFrQjtRQUNyQixRQUFHLEdBQUgsR0FBRyxDQUFrQjtRQUNyQiw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQTBCO1FBOUdwRCxlQUFVLEdBQWtCLEVBQUUsQ0FBQztRQUUvQixpQkFBWSxHQUFpQixNQUFNLENBQUM7UUFDcEMsYUFBUSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBSXZCLGtCQUFhLEdBQUcsRUFBRSxDQUFDO1FBSW5CLGlCQUFZLEdBQWtCLElBQUksT0FBTyxFQUFF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VUFBVSxDQUFDLElBQUksQ0FBQyxVQUFBLE1BQU0sSUFBSSxPQUFBLE1BQU0sQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLEVBQUUsRUFBckIsQ0FBcUIsQ0FBQyxFQUF0RCxDQUFzRCxDQUFDO1lBQzdFLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDWCxDQUFDO0lBRU8sMENBQWlCLEdBQXpCO1FBQ0UsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2xCLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDOUI7SUFDSCxDQUFDOztnQkFqTWMsV0FBVztnQkFDWCxnQkFBZ0I7Z0JBQ0ssd0JBQXdCOztJQTlFNUQ7UUFEQyxLQUFLLEVBQUU7a0RBZVA7SUFXRDtRQURDLEtBQUssRUFBRTt3REFHUDtJQU1EO1FBREMsS0FBSyxFQUFFO29EQUtQO0lBTUQ7UUFEQyxLQUFLLEVBQUU7d0RBTVA7SUFNRDtRQURDLEtBQUssRUFBRTs2REFHUDtJQU1EO1FBREMsS0FBSyxFQUFFO3dEQUdQO0lBT0Q7UUFEQyxLQUFLLEVBQUU7MERBR1A7SUExR1UsY0FBYztRQUgxQixTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsVUFBVTtTQUNyQixDQUFDO09BQ1csY0FBYyxDQStTMUI7SUFBRCxxQkFBQztDQUFBLEFBL1NELElBK1NDO1NBL1NZLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb2VyY2VOdW1iZXJQcm9wZXJ0eSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9jb2VyY2lvbic7XG5pbXBvcnQge1xuICBDb21wb25lbnRGYWN0b3J5LFxuICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gIERpcmVjdGl2ZSxcbiAgRW1iZWRkZWRWaWV3UmVmLFxuICBJbnB1dCxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgVGVtcGxhdGVSZWYsXG4gIFZpZXdDb250YWluZXJSZWYsXG4gIFZpZXdSZWZcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJSWRlbnRpZmllZCwgSVJlc3VsdExpc3QsIFBhZ2luZyB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IGFzc2lnbiwgZ2V0IH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IGlzT2JzZXJ2YWJsZSwgT2JzZXJ2YWJsZSwgb2YsIHBpcGUsIFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCB0YWtlVW50aWwsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFJlYWx0aW1lU2VydmljZSB9IGZyb20gJy4uL3JlYWx0aW1lL3JlYWx0aW1lLnNlcnZpY2UnO1xuaW1wb3J0IHsgTG9hZE1vcmVDb21wb25lbnQgfSBmcm9tICcuL2xvYWQtbW9yZS5jb21wb25lbnQnO1xuaW1wb3J0IHsgTG9hZE1vcmVNb2RlIH0gZnJvbSAnLi9sb2FkLW1vcmUubW9kZWwnO1xuXG4vKipcbiAqIEEgZGlyZWN0aXZlIHRvIGl0ZXJhdGUgb3ZlciBJUmVzdWx0TGlzdDxUPiBkYXRhIGZyb20gQGM4eS9jbGllbnQuXG4gKiBEZXBlbmRpbmcgb24gdGhlIFtjOHlGb3JMb2FkTW9yZV0gYSBsb2FkIG1vcmUgYnV0dG9uIGlzOlxuICogIC0gYXV0bzogVHJpZXMgdG8gYXV0b21hdGljYWxseSBsb2FkIG1vcmUgZGF0YSAoZGVmYXVsdCBtYXhpbXVtIDEwIGl0ZXJhdGlvbnM7IGNhbiBiZVxuICogICAgICAgICAgY2hhbmdlIHdpdGggbWF4SXRlcmF0aW9ucyBzZXR0aW5ncykuXG4gKiAgLSBzaG93OiBTaG93cyBhIGxvYWQgbW9yZSBidXR0b24gZm9yIHRoZSB1c2VyIHRvIGRlY2lkZVxuICogIC0gbm9uZTogRG9lc24ndCBwZXJmb3JtIGFueSBsb2FkIG1vcmUgYWN0aW9uLlxuICogIC0gaGlkZGVuOiBMb2FkcyBtb3JlIGRhdGEgYXV0b21hdGljYWxseSBidXQgd2l0aCBubyB2aXNpYmxlIGJ1dHRvbiBmb3IgdGhlIHVzZXIuXG4gKlxuICogQWRkaXRpb25hbCwgYW55IHJ4anMgb3BlcmF0b3IgcGlwZSBjYW4gYmUgYXBwbGllZCB0byB0aGUgW2M4eUZvclBpcGVdIGlucHV0LCBlLmcuIHRvXG4gKiBmaWx0ZXIgdGhlIGRhdGEgZGlzcGxheWVkIGN1cnJlbnRseSBhcyB3ZWxsIGFzIHRoZSBkYXRhIGxvYWRlZCBieSBzdWJzZXF1ZW50IHJlcXVlc3RzLlxuICpcbiAqIEV4YW1wbGU6XG4gKiBgYGBodG1sXG4gKiA8ZGl2ICpjOHlGb3I9XCJsZXQgZGV2aWNlIG9mIGRldmljZXM7IGxvYWRNb3JlOiAnYXV0byc7IGxldCBpID0gaW5kZXg7IHBpcGU6IGZpbHRlclBpcGU7XCI+XG4gKiAge3sgaSArIDEgfX0uIHt7ZGV2aWNlLm5hbWV9fVxuICogPC9kaXY+XG4gKiBgYGBcbiAqIFRoZSBhYm92ZSBleGFtcGxlIHdpbGwgbGlzdCBhbGwgZW50aXRpZXMgdGhhdCBhcmUgYXBwbGllZCB0byBgZGV2aWNlc2A6XG4gKiBgYGB0eXBlc2NyaXB0XG4gKiB0aGlzLmRldmljZXMgPSB0aGlzLmludmVudG9yeVNlcnZpY2UubGlzdCh7IHBhZ2VTaXplOiAxMCwgZnJhZ21lbnRUeXBlOiAnYzh5X0lzRGV2aWNlJyB9KVxuICogYGBgXG4gKiBJdCB3aWxsIGRpc3BsYXkgdGhlIGZpcnN0IDEwIGl0ZW1zLCBpZiB0aGVyZSBpcyBtb3JlIHNwYWNlIGxlZnQgb24gdGhlIHNjcmVlbiwgYW5kIHRoZXJlIGFyZSBtb3JlXG4gKiB0aGFuIDEwIGRldmljZXMsIGl0IHdpbGwgYXV0b21hdGljYWxseSBsb2FkIHVwIHRvIDEwIHBhZ2VzIG1vcmUuIElmIGl0IHN0aWxsIGNhbid0IGZpdCB0aGUgc2NyZWVuXG4gKiBpdCB3aWxsIHN0b3AgYW5kIHN3aXRjaCB0byBgc2hvd2AgbW9kZS5cbiAqXG4gKiBBIHBpcGUgY2FuIGJlIGFwcGxpZWQgZS5nLiBmb3IgZmlsdGVyaW5nIG9yIGdyb3VwaW5nLiBUaGlzIHBpcGUgaXMgYXR0YWNoZWQgdG8gZXZlcnkgZm9sbG93IHVwXG4gKiByZXF1ZXN0IGRvbmUgYnkgdGhlIGxvYWQgbW9yZSBjb21wb25lbnQ6XG4gKiBgYGB0eXBlc2NyaXB0XG4gKiB0aGlzLmZpbHRlclBpcGUgPSBwaXBlKFxuICogICAgbWFwKChkYXRhOiBbXSkgPT4ge1xuICogICAgIHJldHVybiBkYXRhLmZpbHRlcihcbiAqICAgICAgKG1vOiBhbnkpID0+IG1vLm5hbWUgJiYgbW8ubmFtZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YodmFsdWUudG9Mb3dlckNhc2UoKSkgPiAtMVxuICogICAgKTtcbiAqICB9KVxuICogKTtcbiAqIGBgYFxuICogVGhlIHBpcGUgbXVzdCBiZSBhbiByeGpzIHBpcGUgYW5kIGNhbiB0YWtlIGFueSBvcGVyYXRvci5cbiAqL1xuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnW2M4eUZvcl0nXG59KVxuZXhwb3J0IGNsYXNzIEZvck9mRGlyZWN0aXZlIHtcbiAgcHJpdmF0ZSBjYWNoZWREYXRhOiBJSWRlbnRpZmllZFtdID0gW107XG4gIHByaXZhdGUgcGFnaW5nOiBQYWdpbmc8SUlkZW50aWZpZWQ+O1xuICBwcml2YXRlIGxvYWRNb3JlTW9kZTogTG9hZE1vcmVNb2RlID0gJ2F1dG8nO1xuICBwcml2YXRlIGRhdGFQaXBlID0gcGlwZSh0YXAoKSk7XG4gIHByaXZhdGUgcGFnaW5nU3ViOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgb2JzJDogT2JzZXJ2YWJsZTxJSWRlbnRpZmllZFtdPjtcbiAgcHJpdmF0ZSBsb2FkTW9yZTogTG9hZE1vcmVDb21wb25lbnQ7XG4gIHByaXZhdGUgbWF4SXRlcmF0aW9ucyA9IDEwO1xuICBwcml2YXRlIG5vdEZvdW5kVGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT47XG4gIHByaXZhdGUgcmVhbHRpbWU6IFJlYWx0aW1lU2VydmljZTxhbnk+O1xuICBwcml2YXRlIGNvbXBhcmF0b3I6IChpdGVtQTogb2JqZWN0LCBpdGVtQjogb2JqZWN0KSA9PiBudW1iZXI7XG4gIHByaXZhdGUgdW5zdWJzY3JpYmUkOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3QoKTtcblxuICBwcml2YXRlIGdldCBzaG91bGRVc2VMb2FkTW9yZUJ1dHRvbigpIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5sb2FkTW9yZU1vZGUgPT09ICdhdXRvJyB8fCB0aGlzLmxvYWRNb3JlTW9kZSA9PT0gJ3Nob3cnIHx8IHRoaXMubG9hZE1vcmVNb2RlID09PSAnaGlkZGVuJ1xuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldCBoYXNNb3JlRGF0YSgpIHtcbiAgICByZXR1cm4gdGhpcy5sb2FkTW9yZSAmJiB0aGlzLmxvYWRNb3JlLmhhc01vcmU7XG4gIH1cblxuICBwcml2YXRlIGdldCBsZW5ndGgoKSB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGVkRGF0YS5sZW5ndGg7XG4gIH1cblxuICAvKipcbiAgICogVGhlIGRhdGEgc2V0dGVyLiBNdXN0IGJlIGEgcmVzcG9uc2UgZnJvbSBAYzh5L2RhdGEgb3IgYW4gb2JzZXJ2YWJsZS5cbiAgICogWW91IGNhbiBwYXNzIGFuIG9ic2VydmFibGUgd2l0aCBudWxsIHRvIGV4cGxpY2l0bHkgY2xlYXIgdGhlIGxpc3QuXG4gICAqL1xuICBASW5wdXQoKVxuICBzZXQgYzh5Rm9yT2YoZmV0Y2hEYXRhOiBJUmVzdWx0TGlzdDxJSWRlbnRpZmllZD4gfCBPYnNlcnZhYmxlPElSZXN1bHRMaXN0PElJZGVudGlmaWVkPj4pIHtcbiAgICBpZiAoZmV0Y2hEYXRhKSB7XG4gICAgICB0aGlzLm9icyQgPSAoaXNPYnNlcnZhYmxlKGZldGNoRGF0YSkgPyBmZXRjaERhdGEgOiBvZihmZXRjaERhdGEpKS5waXBlKFxuICAgICAgICBtYXAocmVzdWx0ID0+IHtcbiAgICAgICAgICBpZiAocmVzdWx0ID09PSBudWxsKSB7XG4gICAgICAgICAgICB0aGlzLnBhZ2luZyA9IG51bGw7XG4gICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IHsgcGFnaW5nLCBkYXRhIH0gPSByZXN1bHQ7XG4gICAgICAgICAgdGhpcy5wYWdpbmcgPSBwYWdpbmc7XG4gICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgbW9kZSBzZXR0ZXI6XG4gICAqICAtIGF1dG86IFRyaWVzIHRvIGF1dG9tYXRpY2FsbHkgbG9hZCBtb3JlIGRhdGEgKGRlZmF1bHQgbWF4aW11bSAxMCBpdGVyYXRpb25zOyBjYW4gYmVcbiAgICogICAgICAgICAgY2hhbmdlIHdpdGggbWF4SXRlcmF0aW9ucyBzZXR0aW5ncykuXG4gICAqICAtIHNob3c6IFNob3dzIGEgbG9hZCBtb3JlIGJ1dHRvbiBmb3IgdGhlIHVzZXIgdG8gZGVjaWRlXG4gICAqICAtIG5vbmU6IERvZXNuJ3QgcGVyZm9ybSBhbnkgbG9hZCBtb3JlIGFjdGlvbi5cbiAgICogIC0gaGlkZGVuOiBMb2FkcyBtb3JlIGRhdGEgYXV0b21hdGljYWxseSBidXQgd2l0aCBubyB2aXNpYmxlIGJ1dHRvbiBmb3IgdGhlIHVzZXIuXG4gICAqL1xuICBASW5wdXQoKVxuICBzZXQgYzh5Rm9yTG9hZE1vcmUodHlwZTogTG9hZE1vcmVNb2RlKSB7XG4gICAgdGhpcy5sb2FkTW9yZU1vZGUgPSB0eXBlO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBwaXBlIHNldHRlciB0byBhdHRhY2ggYW55IHJ4anMgcGlwZSB0byB0aGUgY3VycmVudCBhbmQgbW9yZSBsb2FkZWQgZGF0YS5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHNldCBjOHlGb3JQaXBlKGRhdGFQaXBlKSB7XG4gICAgaWYgKGRhdGFQaXBlKSB7XG4gICAgICB0aGlzLmRhdGFQaXBlID0gZGF0YVBpcGU7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEEgdGVtcGxhdGUgdG8gdXNlIGlmIG5vIGRhdGEgaXMgZm91bmQgYXQgYWxsIChlLmcuIGlmIHlvdSBhcHBseSBhIGZpbHRlciBwaXBlKS5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHNldCBjOHlGb3JOb3RGb3VuZChub3RGb3VuZFRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+KSB7XG4gICAgdGhpcy5ub3RGb3VuZFRlbXBsYXRlID0gbm90Rm91bmRUZW1wbGF0ZTtcbiAgICBpZiAodGhpcy5sb2FkTW9yZSkge1xuICAgICAgdGhpcy5sb2FkTW9yZS5ub01vcmVEYXRhSGludCA9IG5vdEZvdW5kVGVtcGxhdGU7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBtYXhpbXVtIG51bWJlcnMgb2YgaXRlcmF0aW9ucyB0byBjYWxsIGRhdGEgZnJvbSB0aGUgYXBpLlxuICAgKi9cbiAgQElucHV0KClcbiAgc2V0IGM4eUZvck1heEl0ZXJhdGlvbnMobWF4SXRlcmF0aW9uczogbnVtYmVyKSB7XG4gICAgdGhpcy5tYXhJdGVyYXRpb25zID0gbWF4SXRlcmF0aW9ucztcbiAgfVxuXG4gIC8qKlxuICAgKiBBIFJlYWx0aW1lU2VydmljZSBpbnN0YW5jZS5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHNldCBjOHlGb3JSZWFsdGltZShzb3VyY2U6IFJlYWx0aW1lU2VydmljZTxhbnk+KSB7XG4gICAgdGhpcy5yZWFsdGltZSA9IHNvdXJjZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBIGNvbXBhcmF0b3IgZnVuY3Rpb24gZm9yIGNvbXBhcmluZyBsaXN0IGl0ZW1zLiBVc2VkIHRvIGRldGVybWluZVxuICAgKiB0aGUgcG9zaXRpb24gYXQgd2hpY2ggYSBuZXcgZWxlbWVudCBzaG91bGQgYmUgYWRkZWQgdG8gdGhlIGxpc3QuXG4gICAqL1xuICBASW5wdXQoKVxuICBzZXQgYzh5Rm9yQ29tcGFyYXRvcihjb21wYXJhdG9yOiAoaXRlbUE6IG9iamVjdCwgaXRlbUI6IG9iamVjdCkgPT4gbnVtYmVyKSB7XG4gICAgdGhpcy5jb21wYXJhdG9yID0gY29tcGFyYXRvcjtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdHBsOiBUZW1wbGF0ZVJlZjxhbnk+LFxuICAgIHByaXZhdGUgdmNyOiBWaWV3Q29udGFpbmVyUmVmLFxuICAgIHByaXZhdGUgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXJcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMuaGFuZGxlUmVhbHRpbWUoKTtcbiAgfVxuXG4gIHByaXZhdGUgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xuICAgIGlmICh0aGlzLm9icyQgJiYgKGNoYW5nZXMuYzh5Rm9yUGlwZSB8fCBjaGFuZ2VzLmM4eUZvck9mKSkge1xuICAgICAgdGhpcy51bnN1YnNjcmliZVBhZ2luZygpO1xuXG4gICAgICAvLyBvbmx5IHJlLXJlbmRlcmluZyAgb24gZmlsdGVyaW5nIGlmIGFsbCBkYXRhIGlzIGFscmVhZHkgbG9hZGVkXG4gICAgICAvLyBmcm9tIHRoZSBiYWNrZW5kXG4gICAgICBjb25zdCByZVJlbmRlciA9ICF0aGlzLmhhc01vcmVEYXRhICYmICEhY2hhbmdlcy5jOHlGb3JQaXBlICYmICFjaGFuZ2VzLmM4eUZvck9mO1xuXG4gICAgICBpZiAocmVSZW5kZXIpIHtcbiAgICAgICAgdGhpcy5vYnMkID0gb2YodGhpcy5jYWNoZWREYXRhKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucGFnaW5nU3ViID0gdGhpcy5vYnMkXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIHRhcChkYXRhID0+IHtcbiAgICAgICAgICAgIGlmICghcmVSZW5kZXIpIHtcbiAgICAgICAgICAgICAgdGhpcy5jYWNoZWREYXRhID0gZGF0YTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICApXG4gICAgICAgIC5waXBlKHNyYyA9PiB0aGlzLmRhdGFQaXBlKHNyYykpXG4gICAgICAgIC5zdWJzY3JpYmUoKGRhdGE6IFtdKSA9PiB7XG4gICAgICAgICAgdGhpcy5yZW5kZXIoZGF0YSwgcmVSZW5kZXIpO1xuICAgICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMudW5zdWJzY3JpYmVQYWdpbmcoKTtcbiAgICB0aGlzLnVuc3Vic2NyaWJlJC5uZXh0KCk7XG4gICAgdGhpcy51bnN1YnNjcmliZSQuY29tcGxldGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlUmVhbHRpbWUoKSB7XG4gICAgaWYgKHRoaXMucmVhbHRpbWUpIHtcbiAgICAgIHRoaXMucmVhbHRpbWVcbiAgICAgICAgLm9uQ3JlYXRlJCgpXG4gICAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLnVuc3Vic2NyaWJlJCkpXG4gICAgICAgIC5zdWJzY3JpYmUoaXRlbSA9PiB0aGlzLmluc2VydChpdGVtKSk7XG4gICAgICB0aGlzLnJlYWx0aW1lXG4gICAgICAgIC5vblVwZGF0ZSQoKVxuICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy51bnN1YnNjcmliZSQpKVxuICAgICAgICAuc3Vic2NyaWJlKGl0ZW0gPT4gdGhpcy51cGRhdGUoaXRlbSkpO1xuICAgICAgdGhpcy5yZWFsdGltZVxuICAgICAgICAub25EZWxldGUkKClcbiAgICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMudW5zdWJzY3JpYmUkKSlcbiAgICAgICAgLnN1YnNjcmliZShpZCA9PiB0aGlzLnJlbW92ZShjb2VyY2VOdW1iZXJQcm9wZXJ0eShpZCkpKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbmRlcihkYXRhLCByZVJlbmRlciA9IGZhbHNlKTogdm9pZCB7XG4gICAgdGhpcy52Y3IuY2xlYXIoKTtcblxuICAgIGRhdGEuZm9yRWFjaCgoaXRlbSwgaW5kZXgpID0+IHtcbiAgICAgIGNvbnN0IGNvbnRleHQgPSB7XG4gICAgICAgICRpbXBsaWNpdDogaXRlbSxcbiAgICAgICAgaW5kZXgsXG4gICAgICAgIGxlbmd0aDogdGhpcy5sZW5ndGgsXG4gICAgICAgIGhhc01vcmU6IHRoaXMuaGFzTW9yZURhdGFcbiAgICAgIH07XG4gICAgICB0aGlzLnZjci5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy50cGwsIGNvbnRleHQpO1xuICAgIH0pO1xuXG4gICAgaWYgKHRoaXMuc2hvdWxkVXNlTG9hZE1vcmVCdXR0b24pIHtcbiAgICAgIHRoaXMubG9hZE1vcmUgPSB0aGlzLmNyZWF0ZUxvYWRNb3JlQnV0dG9uQ29tcG9uZW50KHJlUmVuZGVyKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFwcGVuZChkYXRhKSB7XG4gICAgZGF0YS5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgY29uc3QgaW5kZXggPSB0aGlzLnNob3VsZFVzZUxvYWRNb3JlQnV0dG9uID8gdGhpcy52Y3IubGVuZ3RoIC0gMSA6IHRoaXMudmNyLmxlbmd0aDtcbiAgICAgIGNvbnN0IGNvbnRleHQgPSB7XG4gICAgICAgICRpbXBsaWNpdDogaXRlbSxcbiAgICAgICAgaW5kZXgsXG4gICAgICAgIGxlbmd0aDogdGhpcy5sZW5ndGgsXG4gICAgICAgIGhhc01vcmU6IHRoaXMuaGFzTW9yZURhdGFcbiAgICAgIH07XG4gICAgICB0aGlzLnZjci5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy50cGwsIGNvbnRleHQsIGluZGV4KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZE1vcmVEYXRhKGRhdGEpIHtcbiAgICBpZiAoZGF0YS5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLmFwcGVuZChkYXRhKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUxvYWRNb3JlQnV0dG9uQ29tcG9uZW50KHJlUmVuZGVyKSB7XG4gICAgY29uc3QgY29tcG9uZW50RmFjdG9yeTogQ29tcG9uZW50RmFjdG9yeTxcbiAgICAgIGFueVxuICAgID4gPSB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShMb2FkTW9yZUNvbXBvbmVudCk7XG4gICAgY29uc3QgY29tcG9uZW50UmVmID0gdGhpcy52Y3IuY3JlYXRlQ29tcG9uZW50KGNvbXBvbmVudEZhY3RvcnkpO1xuICAgIGNvbnN0IGluc3RhbmNlID0gY29tcG9uZW50UmVmLmluc3RhbmNlIGFzIExvYWRNb3JlQ29tcG9uZW50O1xuICAgIGluc3RhbmNlLnBhZ2luZyA9IHRoaXMucGFnaW5nO1xuICAgIGluc3RhbmNlLnVzZUludGVyc2VjdGlvbiA9IHRoaXMubG9hZE1vcmVNb2RlID09PSAnYXV0bycgfHwgdGhpcy5sb2FkTW9yZU1vZGUgPT09ICdoaWRkZW4nO1xuICAgIGluc3RhbmNlLmhpZGRlbiA9IHRoaXMubG9hZE1vcmVNb2RlID09PSAnaGlkZGVuJztcbiAgICBpbnN0YW5jZS5tYXhJdGVyYXRpb25zID0gdGhpcy5tYXhJdGVyYXRpb25zO1xuICAgIGluc3RhbmNlLm5vTW9yZURhdGFIaW50ID0gdGhpcy5ub3RGb3VuZFRlbXBsYXRlO1xuICAgIHRoaXMucGFnaW5nU3ViID0gaW5zdGFuY2Uub25Mb2FkXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKChkYXRhOiBbXSkgPT4gdGhpcy5jaGVja0ZvckR1cGxpY2F0ZXMoZGF0YSkpLFxuICAgICAgICB0YXAoKGRhdGE6IFtdKSA9PiB7XG4gICAgICAgICAgdGhpcy5jYWNoZWREYXRhID0gdGhpcy5jYWNoZWREYXRhLmNvbmNhdChkYXRhKTtcbiAgICAgICAgfSlcbiAgICAgIClcbiAgICAgIC5waXBlKHNyYyA9PiB0aGlzLmRhdGFQaXBlKHNyYykpXG4gICAgICAuc3Vic2NyaWJlKGRhdGEgPT4gdGhpcy5sb2FkTW9yZURhdGEoZGF0YSkpO1xuICAgIGlmIChyZVJlbmRlcikge1xuICAgICAgYXNzaWduKGluc3RhbmNlLCB0aGlzLmxvYWRNb3JlKTtcbiAgICB9XG4gICAgcmV0dXJuIGluc3RhbmNlO1xuICB9XG5cbiAgcHJpdmF0ZSBpbnNlcnQoaXRlbSkge1xuICAgIGxldCBpbmRleDogbnVtYmVyID0gMDtcblxuICAgIGlmICh0aGlzLmNvbXBhcmF0b3IgJiYgdGhpcy5jYWNoZWREYXRhLmxlbmd0aCkge1xuICAgICAgbGV0IGNvbXBhcmlzaW9uUmVzdWx0OiBudW1iZXI7XG4gICAgICBkbyB7XG4gICAgICAgIGNvbnN0IHZpZXc6IEVtYmVkZGVkVmlld1JlZjxhbnk+ID0gdGhpcy52Y3IuZ2V0KGluZGV4KSBhcyBFbWJlZGRlZFZpZXdSZWY8YW55PjtcbiAgICAgICAgY29uc3QgaXRlbUIgPSBnZXQodmlldywgJ2NvbnRleHQuJGltcGxpY2l0Jyk7XG4gICAgICAgIGNvbXBhcmlzaW9uUmVzdWx0ID0gaXRlbSAmJiBpdGVtQiA/IHRoaXMuY29tcGFyYXRvcihpdGVtLCBpdGVtQikgOiAwO1xuICAgICAgICBpZiAoY29tcGFyaXNpb25SZXN1bHQgPD0gMCkge1xuICAgICAgICAgIGluZGV4Kys7XG4gICAgICAgIH1cbiAgICAgIH0gd2hpbGUgKGNvbXBhcmlzaW9uUmVzdWx0IDw9IDAgJiYgaW5kZXggPCB0aGlzLmNhY2hlZERhdGEubGVuZ3RoKTtcbiAgICB9XG5cbiAgICAvLyBEbyBub3QgYXBwZW5kIGVsZW1lbnRzIGFmdGVyIHRoZSBsYXN0IG9uZSBjdXJyZW50bHkgbG9hZGVkLFxuICAgIC8vIGFzIGl0IG1heSBiZWxvbmcgZnVydGhlciBkb3duIHRoZXJlIG9uIHRoZSBsaXN0IGFuZCB3aWxsXG4gICAgLy8gYmUgZXZlbnR1YWxseSBsb2FkZWQgd2l0aCBvbmUgb2YgdGhlIG5leHQgcGFnZXMuXG4gICAgaWYgKGluZGV4IDwgdGhpcy5jYWNoZWREYXRhLmxlbmd0aCB8fCB0aGlzLmNhY2hlZERhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICBjb25zdCBjb250ZXh0ID0ge1xuICAgICAgICAkaW1wbGljaXQ6IGl0ZW0sXG4gICAgICAgIGluZGV4LFxuICAgICAgICBsZW5ndGg6IHRoaXMubGVuZ3RoLFxuICAgICAgICBoYXNNb3JlOiB0aGlzLmhhc01vcmVEYXRhXG4gICAgICB9O1xuXG4gICAgICB0aGlzLmNhY2hlZERhdGEuc3BsaWNlKGluZGV4LCAwLCBpdGVtKTtcbiAgICAgIGNvbnN0IHZpZXdSZWY6IFZpZXdSZWYgPSB0aGlzLnRwbC5jcmVhdGVFbWJlZGRlZFZpZXcoY29udGV4dCk7XG4gICAgICB0aGlzLnZjci5pbnNlcnQodmlld1JlZiwgaW5kZXgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlKHVwZGF0ZWRJdGVtKSB7XG4gICAgdGhpcy5mb3JNYXRjaGluZ0VtYmVkZGVkVmlld1JlZihcbiAgICAgIChpdGVtOiBJSWRlbnRpZmllZCkgPT4gaXRlbSAmJiB1cGRhdGVkSXRlbSAmJiBpdGVtLmlkID09PSB1cGRhdGVkSXRlbS5pZCxcbiAgICAgICh2aWV3OiBFbWJlZGRlZFZpZXdSZWY8YW55PikgPT4ge1xuICAgICAgICB2aWV3LmNvbnRleHQuJGltcGxpY2l0ID0gdXBkYXRlZEl0ZW07XG4gICAgICAgIHZpZXcubWFya0ZvckNoZWNrKCk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlKGlkVG9SZW1vdmUpIHtcbiAgICB0aGlzLmZvck1hdGNoaW5nRW1iZWRkZWRWaWV3UmVmKFxuICAgICAgKGl0ZW06IElJZGVudGlmaWVkKSA9PiBpdGVtICYmIGNvZXJjZU51bWJlclByb3BlcnR5KGl0ZW0uaWQsIE5hTikgPT09IGlkVG9SZW1vdmUsXG4gICAgICAodmlldzogRW1iZWRkZWRWaWV3UmVmPGFueT4pID0+IHZpZXcuZGVzdHJveSgpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZm9yTWF0Y2hpbmdFbWJlZGRlZFZpZXdSZWYoXG4gICAgZmlsdGVyOiAoaXRlbTogSUlkZW50aWZpZWQpID0+IGJvb2xlYW4sXG4gICAgY2FsbGJhY2s6ICh2aWV3OiBFbWJlZGRlZFZpZXdSZWY8YW55PikgPT4gdm9pZFxuICApIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMudmNyLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCB2aWV3OiBFbWJlZGRlZFZpZXdSZWY8YW55PiA9IHRoaXMudmNyLmdldChpKSBhcyBFbWJlZGRlZFZpZXdSZWY8YW55PjtcbiAgICAgIGNvbnN0IGl0ZW06IElJZGVudGlmaWVkID0gZ2V0KHZpZXcsICdjb250ZXh0LiRpbXBsaWNpdCcpO1xuICAgICAgaWYgKGZpbHRlcihpdGVtKSkge1xuICAgICAgICBjYWxsYmFjayh2aWV3KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNoZWNrRm9yRHVwbGljYXRlcyhkYXRhOiBJSWRlbnRpZmllZFtdKTogSUlkZW50aWZpZWRbXSB7XG4gICAgcmV0dXJuIHRoaXMucmVhbHRpbWVcbiAgICAgID8gZGF0YS5maWx0ZXIoaXRlbSA9PiAhdGhpcy5jYWNoZWREYXRhLnNvbWUoY2FjaGVkID0+IGNhY2hlZC5pZCA9PT0gaXRlbS5pZCkpXG4gICAgICA6IGRhdGE7XG4gIH1cblxuICBwcml2YXRlIHVuc3Vic2NyaWJlUGFnaW5nKCkge1xuICAgIGlmICh0aGlzLnBhZ2luZ1N1Yikge1xuICAgICAgdGhpcy5wYWdpbmdTdWIudW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==