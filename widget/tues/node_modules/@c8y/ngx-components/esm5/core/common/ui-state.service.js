import * as tslib_1 from "tslib";
import { Injectable, isDevMode } from '@angular/core';
import { keys } from 'lodash-es';
import { BehaviorSubject } from 'rxjs';
import { scan, distinctUntilChanged, map, filter } from 'rxjs/operators';
import { StateService } from './state-service.abstract';
import { OptionsService } from './options.service';
import { FetchClient, TenantLoginOptionsService } from '@c8y/client';
import { ApplicationService, IUser, ICurrentTenant } from '@c8y/client';
import { ApiService } from '@c8y/ngx-components/api';
import { throttle } from './throttle.decorator';
var AppStateService = /** @class */ (function (_super) {
    tslib_1.__extends(AppStateService, _super);
    function AppStateService(applicationService, apiService, options, fetchClient, tenantLoginOptionsService) {
        var _this = _super.call(this) || this;
        _this.applicationService = applicationService;
        _this.apiService = apiService;
        _this.options = options;
        _this.fetchClient = fetchClient;
        _this.tenantLoginOptionsService = tenantLoginOptionsService;
        _this.state$ = new BehaviorSubject({
            app: {
                name: _this.options.name,
                contextPath: _this.getCurrentContextPath() || _this.options.contextPath
            },
            supportUrl: _this.options.supportUrl,
            lang: _this.options.get('defaultLanguage', 'en'),
            langs: _this.getLangs(),
            langsDetail: _this.options.languages,
            loginOptions: _this.options.loginOptions,
            activateSupportUserAvailable: undefined,
            versions: {
                backend: undefined,
                ui: _this.options.versions || { ngx: undefined }
            },
            hidePowered: _this.options.hidePowered,
            isLoading: false,
            showRightDrawer: _this.options.rightDrawer,
            loginExtraLink: _this.options.get('login_extra_link'),
            newsletter: _this.options.newsletter
        });
        _this.currentSupportUserName = new BehaviorSubject(null);
        _this.currentUser = new BehaviorSubject(null);
        _this.currentTenant = new BehaviorSubject(null);
        _this.apiService.calls
            .pipe(filter(function (_a) {
            var url = _a.url;
            return !/notification\/realtime/.test(url);
        }), map(function (_a) {
            var phase = _a.phase;
            return (phase === 'start' ? 1 : -1);
        }), scan(function (count, item) { return count + item; }, 0), map(function (count) { return count > 0; }), distinctUntilChanged())
            .subscribe(function (isLoading) { return (_this.state.isLoading = isLoading); });
        _this.assignApplicationKeyToDefaultHeaders();
        return _this;
    }
    AppStateService.prototype.assignApplicationKeyToDefaultHeaders = function () {
        if (!isDevMode()) {
            this.fetchClient.defaultHeaders = tslib_1.__assign({}, (this.fetchClient.defaultHeaders || {}), { 'X-Cumulocity-Application-Key': this.options.key });
        }
    };
    Object.defineProperty(AppStateService.prototype, "state", {
        /**
         * Returns the current state.
         */
        get: function () {
            return this.state$.value;
        },
        enumerable: true,
        configurable: true
    });
    AppStateService.prototype.getLangs = function () {
        var languages = this.options.languages;
        return languages ? keys(languages).filter(function (k) { return languages[k]; }) : [];
    };
    Object.defineProperty(AppStateService.prototype, "uiVersion", {
        /**
         * Returns the correct UI version. In hybrid mode for angular and ngx.
         */
        get: function () {
            var version = this.state.versions.ui;
            return version.ngx || version.ng1;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Loads the app manifest. If no access -> throw an error to verify app access.
     */
    AppStateService.prototype.loadManifest = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var application, ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, this.applicationService.detail(this.state.app.contextPath + "/manifest")];
                    case 1:
                        application = (_a.sent()).data.application;
                        this.state.app.manifest = application;
                        this.loadDefaultOptions();
                        return [3 /*break*/, 3];
                    case 2:
                        ex_1 = _a.sent();
                        throw ex_1;
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    /**
     * When this function called, it refreshes the values of loginOptions stored within ui state object.
     * Function is throttled to execute the refresh once in a time specified by params of @throttled decorator,
     * it should be called on leading edge of the timeout.
     */
    AppStateService.prototype.refreshLoginOptions = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var loginOptions;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.tenantLoginOptionsService.detail()];
                    case 1:
                        loginOptions = (_a.sent()).data.loginOptions;
                        this.state$.next(tslib_1.__assign({}, this.state, { loginOptions: loginOptions }));
                        return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Checks current users application list and matches it against given application name.
     * Returns true if application is in the list.
     * @param name application name
     */
    AppStateService.prototype.isApplicationAvailable = function (name) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var data;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.applicationService.listByUser(undefined, { pageSize: 100 })];
                    case 1:
                        data = (_a.sent()).data;
                        return [2 /*return*/, data.some(function (app) { return app.name === name; })];
                }
            });
        });
    };
    /**
     * Sets current user (including support user).
     * @param userInfo Info about current user and support user to be set.
     */
    AppStateService.prototype.setUser = function (userInfo) {
        this.currentSupportUserName.next(userInfo.supportUserName || null);
        this.currentUser.next(userInfo.user);
    };
    AppStateService.prototype.getCurrentContextPath = function () {
        var match = window.location.pathname.match(/\/apps\/(public\/){0,1}(.+?)(\/|\?|#|$)/);
        return match && match[2];
    };
    AppStateService.prototype.loadDefaultOptions = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a, _b, _c;
            return tslib_1.__generator(this, function (_d) {
                switch (_d.label) {
                    case 0:
                        _a = this.state;
                        return [4 /*yield*/, this.options.getSupportUrl()];
                    case 1:
                        _a.supportUrl = _d.sent();
                        _b = this.state;
                        return [4 /*yield*/, this.options.getActivateSupportUser()];
                    case 2:
                        _b.activateSupportUserAvailable = _d.sent();
                        _c = this.state.versions;
                        return [4 /*yield*/, this.options.getSystemOption('system', 'version')];
                    case 3:
                        _c.backend = _d.sent();
                        try {
                            this.showIncompatibleVersionsError();
                        }
                        catch (ex) {
                            // ignore this
                        }
                        this.emitNewState();
                        return [2 /*return*/];
                }
            });
        });
    };
    AppStateService.prototype.showIncompatibleVersionsError = function () {
        var uiVersion = this.state.versions.ui.ngx;
        var backendVersion = this.state.versions.backend;
        var uiVersionArray = uiVersion
            .replace(/[^\d.]/g, '')
            .split('.')
            .map(Number);
        var beVersionArray = backendVersion
            .replace(/[^\d.]/g, '')
            .split('.')
            .map(Number);
        var multiplier = Math.pow(10, Math.ceil(Math.log10(Math.max.apply(Math, tslib_1.__spread(uiVersionArray, beVersionArray)) + 1)));
        var sumReducer = function (acc, cur) { return acc + cur; };
        var calculateVersionMapper = function (curr, idx) { return curr * (multiplier / Math.pow(10, idx)); };
        var uiVersionNumber = uiVersionArray.map(calculateVersionMapper).reduce(sumReducer);
        var beVersionNumber = beVersionArray.map(calculateVersionMapper).reduce(sumReducer);
        var showError = uiVersionNumber > beVersionNumber;
        if (showError) {
            var errorContent = "You are running version " + uiVersion + " of the UI and version " + backendVersion + " of backend!";
            console.log('%c ' + errorContent, 'font-weight: bold; font-size: 30px; color: red;');
        }
    };
    AppStateService.ctorParameters = function () { return [
        { type: ApplicationService },
        { type: ApiService },
        { type: OptionsService },
        { type: FetchClient },
        { type: TenantLoginOptionsService }
    ]; };
    tslib_1.__decorate([
        throttle(600, { trailing: false })
    ], AppStateService.prototype, "refreshLoginOptions", null);
    AppStateService = tslib_1.__decorate([
        Injectable()
    ], AppStateService);
    return AppStateService;
}(StateService));
export { AppStateService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWktc3RhdGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2NvbW1vbi91aS1zdGF0ZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN0RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFFLElBQUksRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsV0FBVyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRXJFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxLQUFLLEVBQUUsY0FBYyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFHaEQ7SUFBcUMsMkNBQVk7SUEwQi9DLHlCQUNVLGtCQUFzQyxFQUN2QyxVQUFzQixFQUNyQixPQUF1QixFQUN2QixXQUF3QixFQUN4Qix5QkFBb0Q7UUFMOUQsWUFPRSxpQkFBTyxTQVlSO1FBbEJTLHdCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdkMsZ0JBQVUsR0FBVixVQUFVLENBQVk7UUFDckIsYUFBTyxHQUFQLE9BQU8sQ0FBZ0I7UUFDdkIsaUJBQVcsR0FBWCxXQUFXLENBQWE7UUFDeEIsK0JBQXlCLEdBQXpCLHlCQUF5QixDQUEy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LENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEVBQXZDLENBQXVDLENBQUM7UUFDdEYsSUFBTSxlQUFlLEdBQUcsY0FBYyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN0RixJQUFNLGVBQWUsR0FBRyxjQUFjLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3RGLElBQU0sU0FBUyxHQUFHLGVBQWUsR0FBRyxlQUFlLENBQUM7UUFDcEQsSUFBSSxTQUFTLEVBQUU7WUFDYixJQUFNLFlBQVksR0FBRyw2QkFBMkIsU0FBUywrQkFBMEIsY0FBYyxpQkFBYyxDQUFDO1lBQ2hILE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxHQUFHLFlBQVksRUFBRSxpREFBaUQsQ0FBQyxDQUFDO1NBQ3RGO0lBQ0gsQ0FBQzs7Z0JBdkk2QixrQkFBa0I7Z0JBQzNCLFVBQVU7Z0JBQ1osY0FBYztnQkFDVixXQUFXO2dCQUNHLHlCQUF5Qjs7SUFrRTlEO1FBREMsUUFBUSxDQUFDLEdBQUcsRUFBRSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsQ0FBQzs4REFJbEM7SUFwR1UsZUFBZTtRQUQzQixVQUFVLEVBQUU7T0FDQSxlQUFlLENBbUszQjtJQUFELHNCQUFDO0NBQUEsQUFuS0QsQ0FBcUMsWUFBWSxHQW1LaEQ7U0FuS1ksZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIGlzRGV2TW9kZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsga2V5cyB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHNjYW4sIGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAsIGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFN0YXRlU2VydmljZSB9IGZyb20gJy4vc3RhdGUtc2VydmljZS5hYnN0cmFjdCc7XG5pbXBvcnQgeyBPcHRpb25zU2VydmljZSB9IGZyb20gJy4vb3B0aW9ucy5zZXJ2aWNlJztcbmltcG9ydCB7IEZldGNoQ2xpZW50LCBUZW5hbnRMb2dpbk9wdGlvbnNTZXJ2aWNlIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuXG5pbXBvcnQgeyBBcHBsaWNhdGlvblNlcnZpY2UsIElVc2VyLCBJQ3VycmVudFRlbmFudCB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEFwaVNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL2FwaSc7XG5pbXBvcnQgeyB0aHJvdHRsZSB9IGZyb20gJy4vdGhyb3R0bGUuZGVjb3JhdG9yJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEFwcFN0YXRlU2VydmljZSBleHRlbmRzIFN0YXRlU2VydmljZSB7XG4gIHN0YXRlJDogQmVoYXZpb3JTdWJqZWN0PGFueT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGFueT4oe1xuICAgIGFwcDoge1xuICAgICAgbmFtZTogdGhpcy5vcHRpb25zLm5hbWUsXG4gICAgICBjb250ZXh0UGF0aDogdGhpcy5nZXRDdXJyZW50Q29udGV4dFBhdGgoKSB8fCB0aGlzLm9wdGlvbnMuY29udGV4dFBhdGhcbiAgICB9LFxuICAgIHN1cHBvcnRVcmw6IHRoaXMub3B0aW9ucy5zdXBwb3J0VXJsLFxuICAgIGxhbmc6IHRoaXMub3B0aW9ucy5nZXQoJ2RlZmF1bHRMYW5ndWFnZScsICdlbicpLFxuICAgIGxhbmdzOiB0aGlzLmdldExhbmdzKCksXG4gICAgbGFuZ3NEZXRhaWw6IHRoaXMub3B0aW9ucy5sYW5ndWFnZXMsXG4gICAgbG9naW5PcHRpb25zOiB0aGlzLm9wdGlvbnMubG9naW5PcHRpb25zLFxuICAgIGFjdGl2YXRlU3VwcG9ydFVzZXJBdmFpbGFibGU6IHVuZGVmaW5lZCxcbiAgICB2ZXJzaW9uczoge1xuICAgICAgYmFja2VuZDogdW5kZWZpbmVkLFxuICAgICAgdWk6IHRoaXMub3B0aW9ucy52ZXJzaW9ucyB8fCB7IG5neDogdW5kZWZpbmVkIH1cbiAgICB9LFxuICAgIGhpZGVQb3dlcmVkOiB0aGlzLm9wdGlvbnMuaGlkZVBvd2VyZWQsXG4gICAgaXNMb2FkaW5nOiBmYWxzZSxcbiAgICBzaG93UmlnaHREcmF3ZXI6IHRoaXMub3B0aW9ucy5yaWdodERyYXdlcixcbiAgICBsb2dpbkV4dHJhTGluazogdGhpcy5vcHRpb25zLmdldCgnbG9naW5fZXh0cmFfbGluaycpLFxuICAgIG5ld3NsZXR0ZXI6IHRoaXMub3B0aW9ucy5uZXdzbGV0dGVyXG4gIH0pO1xuICBjdXJyZW50U3VwcG9ydFVzZXJOYW1lOiBCZWhhdmlvclN1YmplY3Q8c3RyaW5nIHwgbnVsbD4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KG51bGwpO1xuICBjdXJyZW50VXNlcjogQmVoYXZpb3JTdWJqZWN0PElVc2VyIHwgbnVsbD4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KG51bGwpO1xuICBjdXJyZW50VGVuYW50OiBCZWhhdmlvclN1YmplY3Q8SUN1cnJlbnRUZW5hbnQgfCBudWxsPiA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhcHBsaWNhdGlvblNlcnZpY2U6IEFwcGxpY2F0aW9uU2VydmljZSxcbiAgICBwdWJsaWMgYXBpU2VydmljZTogQXBpU2VydmljZSxcbiAgICBwcml2YXRlIG9wdGlvbnM6IE9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgZmV0Y2hDbGllbnQ6IEZldGNoQ2xpZW50LFxuICAgIHByaXZhdGUgdGVuYW50TG9naW5PcHRpb25zU2VydmljZTogVGVuYW50TG9naW5PcHRpb25zU2VydmljZVxuICApIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuYXBpU2VydmljZS5jYWxsc1xuICAgICAgLnBpcGUoXG4gICAgICAgIGZpbHRlcigoeyB1cmwgfSkgPT4gIS9ub3RpZmljYXRpb25cXC9yZWFsdGltZS8udGVzdCh1cmwpKSxcbiAgICAgICAgbWFwKCh7IHBoYXNlIH0pID0+IChwaGFzZSA9PT0gJ3N0YXJ0JyA/IDEgOiAtMSkpLFxuICAgICAgICBzY2FuKChjb3VudCwgaXRlbSkgPT4gY291bnQgKyBpdGVtLCAwKSxcbiAgICAgICAgbWFwKGNvdW50ID0+IGNvdW50ID4gMCksXG4gICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKClcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoaXNMb2FkaW5nID0+ICh0aGlzLnN0YXRlLmlzTG9hZGluZyA9IGlzTG9hZGluZykpO1xuXG4gICAgdGhpcy5hc3NpZ25BcHBsaWNhdGlvbktleVRvRGVmYXVsdEhlYWRlcnMoKTtcbiAgfVxuXG4gIGFzc2lnbkFwcGxpY2F0aW9uS2V5VG9EZWZhdWx0SGVhZGVycygpIHtcbiAgICBpZiAoIWlzRGV2TW9kZSgpKSB7XG4gICAgICB0aGlzLmZldGNoQ2xpZW50LmRlZmF1bHRIZWFkZXJzID0ge1xuICAgICAgICAuLi4odGhpcy5mZXRjaENsaWVudC5kZWZhdWx0SGVhZGVycyB8fCB7fSksXG4gICAgICAgICdYLUN1bXVsb2NpdHktQXBwbGljYXRpb24tS2V5JzogdGhpcy5vcHRpb25zLmtleVxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgY3VycmVudCBzdGF0ZS5cbiAgICovXG4gIGdldCBzdGF0ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZSQudmFsdWU7XG4gIH1cblxuICBnZXRMYW5ncygpIHtcbiAgICBjb25zdCB7IGxhbmd1YWdlcyB9ID0gdGhpcy5vcHRpb25zO1xuICAgIHJldHVybiBsYW5ndWFnZXMgPyBrZXlzKGxhbmd1YWdlcykuZmlsdGVyKGsgPT4gbGFuZ3VhZ2VzW2tdKSA6IFtdO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGNvcnJlY3QgVUkgdmVyc2lvbi4gSW4gaHlicmlkIG1vZGUgZm9yIGFuZ3VsYXIgYW5kIG5neC5cbiAgICovXG4gIGdldCB1aVZlcnNpb24oKSB7XG4gICAgY29uc3QgdmVyc2lvbiA9IHRoaXMuc3RhdGUudmVyc2lvbnMudWk7XG4gICAgcmV0dXJuIHZlcnNpb24ubmd4IHx8IHZlcnNpb24ubmcxO1xuICB9XG5cbiAgLyoqXG4gICAqIExvYWRzIHRoZSBhcHAgbWFuaWZlc3QuIElmIG5vIGFjY2VzcyAtPiB0aHJvdyBhbiBlcnJvciB0byB2ZXJpZnkgYXBwIGFjY2Vzcy5cbiAgICovXG4gIGFzeW5jIGxvYWRNYW5pZmVzdCgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBhcHBsaWNhdGlvbiB9ID0gKGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmRldGFpbChcbiAgICAgICAgYCR7dGhpcy5zdGF0ZS5hcHAuY29udGV4dFBhdGh9L21hbmlmZXN0YFxuICAgICAgKSkuZGF0YSBhcyBhbnk7XG4gICAgICB0aGlzLnN0YXRlLmFwcC5tYW5pZmVzdCA9IGFwcGxpY2F0aW9uO1xuICAgICAgdGhpcy5sb2FkRGVmYXVsdE9wdGlvbnMoKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhyb3cgZXg7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFdoZW4gdGhpcyBmdW5jdGlvbiBjYWxsZWQsIGl0IHJlZnJlc2hlcyB0aGUgdmFsdWVzIG9mIGxvZ2luT3B0aW9ucyBzdG9yZWQgd2l0aGluIHVpIHN0YXRlIG9iamVjdC5cbiAgICogRnVuY3Rpb24gaXMgdGhyb3R0bGVkIHRvIGV4ZWN1dGUgdGhlIHJlZnJlc2ggb25jZSBpbiBhIHRpbWUgc3BlY2lmaWVkIGJ5IHBhcmFtcyBvZiBAdGhyb3R0bGVkIGRlY29yYXRvcixcbiAgICogaXQgc2hvdWxkIGJlIGNhbGxlZCBvbiBsZWFkaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQuXG4gICAqL1xuICBAdGhyb3R0bGUoNjAwLCB7IHRyYWlsaW5nOiBmYWxzZSB9KVxuICBhc3luYyByZWZyZXNoTG9naW5PcHRpb25zKCkge1xuICAgIGNvbnN0IHsgZGF0YTogeyBsb2dpbk9wdGlvbnMgfSB9ID0gYXdhaXQgdGhpcy50ZW5hbnRMb2dpbk9wdGlvbnNTZXJ2aWNlLmRldGFpbCgpO1xuICAgIHRoaXMuc3RhdGUkLm5leHQoeyAuLi50aGlzLnN0YXRlLCBsb2dpbk9wdGlvbnMgfSk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIGN1cnJlbnQgdXNlcnMgYXBwbGljYXRpb24gbGlzdCBhbmQgbWF0Y2hlcyBpdCBhZ2FpbnN0IGdpdmVuIGFwcGxpY2F0aW9uIG5hbWUuXG4gICAqIFJldHVybnMgdHJ1ZSBpZiBhcHBsaWNhdGlvbiBpcyBpbiB0aGUgbGlzdC5cbiAgICogQHBhcmFtIG5hbWUgYXBwbGljYXRpb24gbmFtZVxuICAgKi9cbiAgYXN5bmMgaXNBcHBsaWNhdGlvbkF2YWlsYWJsZShuYW1lOiBzdHJpbmcpIHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmxpc3RCeVVzZXIodW5kZWZpbmVkLCB7IHBhZ2VTaXplOiAxMDAgfSk7XG4gICAgcmV0dXJuIGRhdGEuc29tZShhcHAgPT4gYXBwLm5hbWUgPT09IG5hbWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgY3VycmVudCB1c2VyIChpbmNsdWRpbmcgc3VwcG9ydCB1c2VyKS5cbiAgICogQHBhcmFtIHVzZXJJbmZvIEluZm8gYWJvdXQgY3VycmVudCB1c2VyIGFuZCBzdXBwb3J0IHVzZXIgdG8gYmUgc2V0LlxuICAgKi9cbiAgc2V0VXNlcih1c2VySW5mbzogeyB1c2VyOiBJVXNlcjsgc3VwcG9ydFVzZXJOYW1lOiBzdHJpbmcgfSkge1xuICAgIHRoaXMuY3VycmVudFN1cHBvcnRVc2VyTmFtZS5uZXh0KHVzZXJJbmZvLnN1cHBvcnRVc2VyTmFtZSB8fCBudWxsKTtcbiAgICB0aGlzLmN1cnJlbnRVc2VyLm5leHQodXNlckluZm8udXNlcik7XG4gIH1cblxuICBwcml2YXRlIGdldEN1cnJlbnRDb250ZXh0UGF0aCgpIHtcbiAgICBjb25zdCBtYXRjaCA9IHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZS5tYXRjaCgvXFwvYXBwc1xcLyhwdWJsaWNcXC8pezAsMX0oLis/KShcXC98XFw/fCN8JCkvKTtcbiAgICByZXR1cm4gbWF0Y2ggJiYgbWF0Y2hbMl07XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGxvYWREZWZhdWx0T3B0aW9ucygpIHtcbiAgICB0aGlzLnN0YXRlLnN1cHBvcnRVcmwgPSBhd2FpdCB0aGlzLm9wdGlvbnMuZ2V0U3VwcG9ydFVybCgpO1xuICAgIHRoaXMuc3RhdGUuYWN0aXZhdGVTdXBwb3J0VXNlckF2YWlsYWJsZSA9IGF3YWl0IHRoaXMub3B0aW9ucy5nZXRBY3RpdmF0ZVN1cHBvcnRVc2VyKCk7XG4gICAgdGhpcy5zdGF0ZS52ZXJzaW9ucy5iYWNrZW5kID0gYXdhaXQgdGhpcy5vcHRpb25zLmdldFN5c3RlbU9wdGlvbignc3lzdGVtJywgJ3ZlcnNpb24nKTtcbiAgICB0cnkge1xuICAgICAgdGhpcy5zaG93SW5jb21wYXRpYmxlVmVyc2lvbnNFcnJvcigpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAvLyBpZ25vcmUgdGhpc1xuICAgIH1cbiAgICB0aGlzLmVtaXROZXdTdGF0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBzaG93SW5jb21wYXRpYmxlVmVyc2lvbnNFcnJvcigpIHtcbiAgICBjb25zdCB1aVZlcnNpb24gPSB0aGlzLnN0YXRlLnZlcnNpb25zLnVpLm5neDtcbiAgICBjb25zdCBiYWNrZW5kVmVyc2lvbiA9IHRoaXMuc3RhdGUudmVyc2lvbnMuYmFja2VuZDtcbiAgICBjb25zdCB1aVZlcnNpb25BcnJheSA9IHVpVmVyc2lvblxuICAgICAgLnJlcGxhY2UoL1teXFxkLl0vZywgJycpXG4gICAgICAuc3BsaXQoJy4nKVxuICAgICAgLm1hcChOdW1iZXIpO1xuICAgIGNvbnN0IGJlVmVyc2lvbkFycmF5ID0gYmFja2VuZFZlcnNpb25cbiAgICAgIC5yZXBsYWNlKC9bXlxcZC5dL2csICcnKVxuICAgICAgLnNwbGl0KCcuJylcbiAgICAgIC5tYXAoTnVtYmVyKTtcbiAgICBjb25zdCBtdWx0aXBsaWVyID0gTWF0aC5wb3coXG4gICAgICAxMCxcbiAgICAgIE1hdGguY2VpbChNYXRoLmxvZzEwKE1hdGgubWF4KC4uLnVpVmVyc2lvbkFycmF5LCAuLi5iZVZlcnNpb25BcnJheSkgKyAxKSlcbiAgICApO1xuICAgIGNvbnN0IHN1bVJlZHVjZXIgPSAoYWNjLCBjdXIpID0+IGFjYyArIGN1cjtcbiAgICBjb25zdCBjYWxjdWxhdGVWZXJzaW9uTWFwcGVyID0gKGN1cnIsIGlkeCkgPT4gY3VyciAqIChtdWx0aXBsaWVyIC8gTWF0aC5wb3coMTAsIGlkeCkpO1xuICAgIGNvbnN0IHVpVmVyc2lvbk51bWJlciA9IHVpVmVyc2lvbkFycmF5Lm1hcChjYWxjdWxhdGVWZXJzaW9uTWFwcGVyKS5yZWR1Y2Uoc3VtUmVkdWNlcik7XG4gICAgY29uc3QgYmVWZXJzaW9uTnVtYmVyID0gYmVWZXJzaW9uQXJyYXkubWFwKGNhbGN1bGF0ZVZlcnNpb25NYXBwZXIpLnJlZHVjZShzdW1SZWR1Y2VyKTtcbiAgICBjb25zdCBzaG93RXJyb3IgPSB1aVZlcnNpb25OdW1iZXIgPiBiZVZlcnNpb25OdW1iZXI7XG4gICAgaWYgKHNob3dFcnJvcikge1xuICAgICAgY29uc3QgZXJyb3JDb250ZW50ID0gYFlvdSBhcmUgcnVubmluZyB2ZXJzaW9uICR7dWlWZXJzaW9ufSBvZiB0aGUgVUkgYW5kIHZlcnNpb24gJHtiYWNrZW5kVmVyc2lvbn0gb2YgYmFja2VuZCFgO1xuICAgICAgY29uc29sZS5sb2coJyVjICcgKyBlcnJvckNvbnRlbnQsICdmb250LXdlaWdodDogYm9sZDsgZm9udC1zaXplOiAzMHB4OyBjb2xvcjogcmVkOycpO1xuICAgIH1cbiAgfVxufVxuIl19