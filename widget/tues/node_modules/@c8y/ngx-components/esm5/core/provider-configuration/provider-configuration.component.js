import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { FormGroup } from '@angular/forms';
import { ActivatedRoute } from '@angular/router';
import { ɵdefineHiddenProp } from '@ngx-formly/core';
import { find, get, mapValues, pick } from 'lodash-es';
import { BehaviorSubject, combineLatest, from, merge, of, Subject } from 'rxjs';
import { catchError, map, shareReplay, switchMap, tap } from 'rxjs/operators';
import { AlertService } from '../alert/alert.service';
import { Permissions, Status } from '../common/index';
import { C8yJSONSchema } from '../dynamic-forms/json-schema/c8y-json-schema.service';
import { ModalService } from '../modal/modal.service';
import { ProviderConfigurationService } from './service/provider-configuration.service';
import { ProviderDefinitionsService } from './service/provider-definitions.service';
var ProviderConfigurationComponent = /** @class */ (function () {
    function ProviderConfigurationComponent(permissions, activatedRoute, modalService, alertService, providerDefinitionsService, providerConfigurationService, jsonschema) {
        var _this = this;
        this.permissions = permissions;
        this.activatedRoute = activatedRoute;
        this.modalService = modalService;
        this.alertService = alertService;
        this.providerDefinitionsService = providerDefinitionsService;
        this.providerConfigurationService = providerConfigurationService;
        this.jsonschema = jsonschema;
        this.layout$ = this.activatedRoute.data.pipe(map(function (config) { return config.layout; }), tap(function (layout) { return (_this.layout = layout); }), tap(function (layout) {
            return (_this.options.formState.disabled = !_this.permissions.hasAllRoles(layout.saveRoles));
        }));
        this.changeProvider$ = new BehaviorSubject(null);
        this.providerInput$ = new BehaviorSubject('');
        this.form = new FormGroup({});
        this.fields = [];
        this.options = {
            formState: {
                disabled: false
            }
        };
        this.reload$ = new BehaviorSubject(null);
        this.updatedConfiguration$ = new Subject();
    }
    ProviderConfigurationComponent.prototype.ngOnInit = function () {
        var _this = this;
        var allProviders$ = from(this.providerDefinitionsService.list()).pipe(map(function (result) { return result.data; }), shareReplay(1));
        this.providers$ = combineLatest(allProviders$, this.providerInput$).pipe(map(function (_a) {
            var _b = tslib_1.__read(_a, 2), providers = _b[0], input = _b[1];
            return input
                ? providers.filter(function (el) { return el.displayName.toLowerCase().indexOf(input.toLowerCase()) >= 0; })
                : providers;
        }), shareReplay(1));
        this.configuration$ = merge(this.updatedConfiguration$, this.reload$.pipe(switchMap(function () {
            return from(_this.providerConfigurationService.detail()).pipe(catchError(function () { return of({}); }));
        }), map(function (result) { return result.data; }))).pipe(map(this.removeEncryptedValues), shareReplay(1));
        this.selectedProvider$ = combineLatest(allProviders$, this.configuration$, this.changeProvider$).pipe(tap(function (_a) {
            var _b = tslib_1.__read(_a, 3), _ = _b[0], configuration = _b[1], newProvider = _b[2];
            return (_this.model = newProvider
                ? pick(_this.model, 'sms.senderName', 'sms.senderAddress')
                : configuration);
        }), map(function (_a) {
            var _b = tslib_1.__read(_a, 3), providers = _b[0], configuration = _b[1], newProvider = _b[2];
            return newProvider ||
                find(providers, function (provider) { return get(configuration, 'provider') === provider.id; });
        }), tap(function (provider) {
            if (provider) {
                var config = _this.jsonschema.toFieldConfig(get(provider, 'schema'));
                if (config.fieldGroup) {
                    config.fieldGroup.forEach(function (fieldConfig) {
                        ɵdefineHiddenProp(fieldConfig, '_keyPath', {
                            key: fieldConfig.key,
                            path: [fieldConfig.key]
                        });
                        fieldConfig.expressionProperties = {
                            'templateOptions.disabled': 'formState.disabled'
                        };
                    });
                }
                _this.fields = [config];
                _this.form = new FormGroup({});
            }
        }), shareReplay(1));
    };
    ProviderConfigurationComponent.prototype.saveProviderConfiguration = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var res, err_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, this.providerConfigurationService.update(this.model)];
                    case 1:
                        res = _a.sent();
                        this.changeProvider$.next(null);
                        this.updatedConfiguration$.next(res.data);
                        this.alertService.success(this.layout.configurationUpdatedSuccessMsg);
                        this.form.markAsPristine();
                        return [3 /*break*/, 3];
                    case 2:
                        err_1 = _a.sent();
                        this.alertService.addServerFailure(err_1);
                        return [3 /*break*/, 3];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    ProviderConfigurationComponent.prototype.deleteProviderConfiguration = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var err_2;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 3, , 4]);
                        return [4 /*yield*/, this.modalService.confirm(this.layout.deleteConfigurationModalTitle, this.layout.deleteConfigurationModalBody, Status.DANGER, {
                                ok: this.layout.deleteConfigurationModalOkBtnLabel,
                                cancel: this.layout.deleteConfigurationModalCancelBtnLabel
                            })];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.providerConfigurationService.delete()];
                    case 2:
                        _a.sent();
                        this.reload$.next();
                        this.alertService.success(this.layout.configurationDeletedSuccessMsg);
                        return [3 /*break*/, 4];
                    case 3:
                        err_2 = _a.sent();
                        if (err_2) {
                            this.alertService.addServerFailure(err_2);
                        }
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    ProviderConfigurationComponent.prototype.removeEncryptedValues = function (configuration) {
        return mapValues(configuration, function (value) { return (value === '<<Encrypted>>' ? undefined : value); });
    };
    ProviderConfigurationComponent.ctorParameters = function () { return [
        { type: Permissions },
        { type: ActivatedRoute },
        { type: ModalService },
        { type: AlertService },
        { type: ProviderDefinitionsService },
        { type: ProviderConfigurationService },
        { type: C8yJSONSchema }
    ]; };
    ProviderConfigurationComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-sms-gateway',
            template: "<c8y-title>\n  {{ (layout$ | async).pageTitle | translate }}\n</c8y-title>\n\n<div class=\"row\">\n  <div class=\"col-md-8 col-xs-12\">\n    <form class=\"card card--fullpage\" (ngSubmit)=\"saveProviderConfiguration()\">\n      <div class=\"card-header separator\">\n        <h4 class=\"card-title\">\n          {{ (layout$ | async).cardTitle | translate }}\n        </h4>\n      </div>\n      <div class=\"inner-scroll\">\n        <div class=\"card-block\">\n          <p *ngIf=\"!!(layout$ | async).description\" class=\"bottom-m\">\n            {{ (layout$ | async).description | translate }}\n          </p>\n          <c8y-form-group>\n            <label for=\"providerName\">{{ (layout$ | async).providerName | translate }}</label>\n            <c8y-typeahead\n              [disabled]=\"!permissions.hasAllRoles((layout$ | async).saveRoles)\"\n              [ngModel]=\"selectedProvider$ | async\"\n              [displayProperty]=\"'displayName'\"\n              name=\"providerName\"\n              placeholder=\"{{ (layout$ | async).providerNamePlaceholder | translate }}\"\n              (onSearch)=\"providerInput$.next($event)\"\n              [allowFreeEntries]=\"false\"\n              [required]=\"true\"\n              [container]=\"'body'\"\n            >\n              <c8y-li\n                *ngFor=\"let provider of providers$ | async\"\n                class=\"p-l-8 p-r-8 c8y-list__item--link\"\n                (click)=\"changeProvider$.next(provider); providerInput$.next('')\"\n                [active]=\"(selectedProvider$ | async) === provider\"\n              >\n                <c8y-highlight\n                  [text]=\"provider.displayName || '--'\"\n                  [pattern]=\"providerInput$ | async\"\n                ></c8y-highlight>\n              </c8y-li>\n            </c8y-typeahead>\n            <c8y-messages\n              ><c8y-message\n                name=\"notExisting\"\n                [text]=\"(layout$ | async).providerNameNoMatchesHint | translate\"\n              ></c8y-message>\n            </c8y-messages>\n          </c8y-form-group>\n          <formly-form\n            *ngIf=\"selectedProvider$ | async\"\n            [form]=\"form\"\n            [fields]=\"fields\"\n            [model]=\"model\"\n            [options]=\"options\"\n          ></formly-form>\n        </div>\n      </div>\n      <div class=\"card-footer separator\">\n        <button\n          *c8yIfAllowed=\"(layout$ | async).deleteRoles\"\n          class=\"btn btn-default\"\n          type=\"button\"\n          (click)=\"deleteProviderConfiguration()\"\n          [disabled]=\"!(configuration$ | async)?.provider\"\n          title=\"{{ (layout$ | async).deleteBtnLabel | translate }}\"\n        >\n          {{ (layout$ | async).deleteBtnLabel | translate }}\n        </button>\n        <button\n          *c8yIfAllowed=\"(layout$ | async).saveRoles\"\n          class=\"btn btn-primary\"\n          type=\"submit\"\n          [disabled]=\"form.invalid || form.pristine\"\n          title=\"{{ (layout$ | async).saveBtnLabel | translate }}\"\n        >\n          {{ (layout$ | async).saveBtnLabel | translate }}\n        </button>\n      </div>\n    </form>\n  </div>\n</div>\n",
            providers: [ProviderConfigurationService, ProviderDefinitionsService]
        })
    ], ProviderConfigurationComponent);
    return ProviderConfigurationComponent;
}());
export { ProviderConfigurationComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmlkZXItY29uZmlndXJhdGlvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiY29yZS9wcm92aWRlci1jb25maWd1cmF0aW9uL3Byb3ZpZGVyLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFakQsT0FBTyxFQUF3QyxpQkFBaUIsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzNGLE9BQU8sRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdkQsT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBYyxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVGLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3RELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDdEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHNEQUFzRCxDQUFDO0FBQ3JGLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQU90RCxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUN4RixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQU9wRjtJQTZC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QTBCLENBQUM7U0FDdEUsQ0FBQztPQUNXLDhCQUE4QixDQTZKMUM7SUFBRCxxQ0FBQztDQUFBLEFBN0pELElBNkpDO1NBN0pZLDhCQUE4QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm9ybUdyb3VwIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgSVJlc3VsdCB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEZvcm1seUZpZWxkQ29uZmlnLCBGb3JtbHlGb3JtT3B0aW9ucywgybVkZWZpbmVIaWRkZW5Qcm9wIH0gZnJvbSAnQG5neC1mb3JtbHkvY29yZSc7XG5pbXBvcnQgeyBmaW5kLCBnZXQsIG1hcFZhbHVlcywgcGljayB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGNvbWJpbmVMYXRlc3QsIGZyb20sIG1lcmdlLCBPYnNlcnZhYmxlLCBvZiwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBzaGFyZVJlcGxheSwgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UgfSBmcm9tICcuLi9hbGVydC9hbGVydC5zZXJ2aWNlJztcbmltcG9ydCB7IFBlcm1pc3Npb25zLCBTdGF0dXMgfSBmcm9tICcuLi9jb21tb24vaW5kZXgnO1xuaW1wb3J0IHsgQzh5SlNPTlNjaGVtYSB9IGZyb20gJy4uL2R5bmFtaWMtZm9ybXMvanNvbi1zY2hlbWEvYzh5LWpzb24tc2NoZW1hLnNlcnZpY2UnO1xuaW1wb3J0IHsgTW9kYWxTZXJ2aWNlIH0gZnJvbSAnLi4vbW9kYWwvbW9kYWwuc2VydmljZSc7XG5pbXBvcnQge1xuICBEeW5hbWljUHJvdmlkZXJDb25maWcsXG4gIER5bmFtaWNQcm92aWRlckxheW91dENvbmZpZ1xufSBmcm9tICcuL21vZGVsL2R5bmFtaWMtcHJvdmlkZXItY29uZmlnLm1vZGVsJztcbmltcG9ydCB7IFByb3ZpZGVyRGVmaW5pdGlvbiB9IGZyb20gJy4vbW9kZWwvcHJvdmlkZXItZGVmaW5pdGlvbi5tb2RlbCc7XG5pbXBvcnQgeyBQcm92aWRlclByb3BlcnRpZXMgfSBmcm9tICcuL21vZGVsL3Byb3ZpZGVyLXByb3BlcnRpZXMubW9kZWwnO1xuaW1wb3J0IHsgUHJvdmlkZXJDb25maWd1cmF0aW9uU2VydmljZSB9IGZyb20gJy4vc2VydmljZS9wcm92aWRlci1jb25maWd1cmF0aW9uLnNlcnZpY2UnO1xuaW1wb3J0IHsgUHJvdmlkZXJEZWZpbml0aW9uc1NlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2UvcHJvdmlkZXItZGVmaW5pdGlvbnMuc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1zbXMtZ2F0ZXdheScsXG4gIHRlbXBsYXRlVXJsOiAnLi9wcm92aWRlci1jb25maWd1cmF0aW9uLmNvbXBvbmVudC5odG1sJyxcbiAgcHJvdmlkZXJzOiBbUHJvdmlkZXJDb25maWd1cmF0aW9uU2VydmljZSwgUHJvdmlkZXJEZWZpbml0aW9uc1NlcnZpY2VdXG59KVxuZXhwb3J0IGNsYXNzIFByb3ZpZGVyQ29uZmlndXJhdGlvbkNvbXBvbmVudCB7XG4gIGxheW91dCQ6IE9ic2VydmFibGU8RHluYW1pY1Byb3ZpZGVyTGF5b3V0Q29uZmlnPiA9IHRoaXMuYWN0aXZhdGVkUm91dGUuZGF0YS5waXBlKFxuICAgIG1hcCgoY29uZmlnOiBEeW5hbWljUHJvdmlkZXJDb25maWcpID0+IGNvbmZpZy5sYXlvdXQpLFxuICAgIHRhcCgobGF5b3V0OiBEeW5hbWljUHJvdmlkZXJMYXlvdXRDb25maWcpID0+ICh0aGlzLmxheW91dCA9IGxheW91dCkpLFxuICAgIHRhcChcbiAgICAgIChsYXlvdXQ6IER5bmFtaWNQcm92aWRlckxheW91dENvbmZpZykgPT5cbiAgICAgICAgKHRoaXMub3B0aW9ucy5mb3JtU3RhdGUuZGlzYWJsZWQgPSAhdGhpcy5wZXJtaXNzaW9ucy5oYXNBbGxSb2xlcyhsYXlvdXQuc2F2ZVJvbGVzKSlcbiAgICApXG4gICk7XG5cbiAgcHJvdmlkZXJzJDogT2JzZXJ2YWJsZTxQcm92aWRlckRlZmluaXRpb25bXT47XG4gIHNlbGVjdGVkUHJvdmlkZXIkOiBPYnNlcnZhYmxlPFByb3ZpZGVyRGVmaW5pdGlvbj47XG4gIGNoYW5nZVByb3ZpZGVyJDogU3ViamVjdDxQcm92aWRlckRlZmluaXRpb24+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChudWxsKTtcbiAgY29uZmlndXJhdGlvbiQ6IE9ic2VydmFibGU8UHJvdmlkZXJQcm9wZXJ0aWVzPjtcbiAgcHJvdmlkZXJJbnB1dCQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PHN0cmluZz4oJycpO1xuXG4gIGZvcm0gPSBuZXcgRm9ybUdyb3VwKHt9KTtcbiAgbW9kZWw6IFByb3ZpZGVyUHJvcGVydGllcztcbiAgZmllbGRzOiBGb3JtbHlGaWVsZENvbmZpZ1tdID0gW107XG4gIG9wdGlvbnM6IEZvcm1seUZvcm1PcHRpb25zID0ge1xuICAgIGZvcm1TdGF0ZToge1xuICAgICAgZGlzYWJsZWQ6IGZhbHNlXG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgcmVsb2FkJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8dm9pZD4obnVsbCk7XG4gIHByaXZhdGUgdXBkYXRlZENvbmZpZ3VyYXRpb24kID0gbmV3IFN1YmplY3Q8UHJvdmlkZXJQcm9wZXJ0aWVzPigpO1xuICBwcml2YXRlIGxheW91dDogRHluYW1pY1Byb3ZpZGVyTGF5b3V0Q29uZmlnO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBwZXJtaXNzaW9uczogUGVybWlzc2lvbnMsXG4gICAgcHJpdmF0ZSBhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsXG4gICAgcHJpdmF0ZSBtb2RhbFNlcnZpY2U6IE1vZGFsU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgcHJvdmlkZXJEZWZpbml0aW9uc1NlcnZpY2U6IFByb3ZpZGVyRGVmaW5pdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgcHJvdmlkZXJDb25maWd1cmF0aW9uU2VydmljZTogUHJvdmlkZXJDb25maWd1cmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGpzb25zY2hlbWE6IEM4eUpTT05TY2hlbWFcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGNvbnN0IGFsbFByb3ZpZGVycyQ6IE9ic2VydmFibGU8UHJvdmlkZXJEZWZpbml0aW9uW10+ID0gZnJvbShcbiAgICAgIHRoaXMucHJvdmlkZXJEZWZpbml0aW9uc1NlcnZpY2UubGlzdCgpXG4gICAgKS5waXBlKFxuICAgICAgbWFwKHJlc3VsdCA9PiByZXN1bHQuZGF0YSksXG4gICAgICBzaGFyZVJlcGxheSgxKVxuICAgICk7XG5cbiAgICB0aGlzLnByb3ZpZGVycyQgPSBjb21iaW5lTGF0ZXN0KGFsbFByb3ZpZGVycyQsIHRoaXMucHJvdmlkZXJJbnB1dCQpLnBpcGUoXG4gICAgICBtYXAoKFtwcm92aWRlcnMsIGlucHV0XTogW1Byb3ZpZGVyRGVmaW5pdGlvbltdLCBzdHJpbmddKSA9PlxuICAgICAgICBpbnB1dFxuICAgICAgICAgID8gcHJvdmlkZXJzLmZpbHRlcihlbCA9PiBlbC5kaXNwbGF5TmFtZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoaW5wdXQudG9Mb3dlckNhc2UoKSkgPj0gMClcbiAgICAgICAgICA6IHByb3ZpZGVyc1xuICAgICAgKSxcbiAgICAgIHNoYXJlUmVwbGF5KDEpXG4gICAgKTtcblxuICAgIHRoaXMuY29uZmlndXJhdGlvbiQgPSBtZXJnZShcbiAgICAgIHRoaXMudXBkYXRlZENvbmZpZ3VyYXRpb24kLFxuICAgICAgdGhpcy5yZWxvYWQkLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgoKSA9PlxuICAgICAgICAgIGZyb20odGhpcy5wcm92aWRlckNvbmZpZ3VyYXRpb25TZXJ2aWNlLmRldGFpbCgpKS5waXBlKGNhdGNoRXJyb3IoKCkgPT4gb2Yoe30gYXMgYW55KSkpXG4gICAgICAgICksXG4gICAgICAgIG1hcChyZXN1bHQgPT4gcmVzdWx0LmRhdGEpXG4gICAgICApXG4gICAgKS5waXBlKFxuICAgICAgbWFwKHRoaXMucmVtb3ZlRW5jcnlwdGVkVmFsdWVzKSxcbiAgICAgIHNoYXJlUmVwbGF5KDEpXG4gICAgKTtcblxuICAgIHRoaXMuc2VsZWN0ZWRQcm92aWRlciQgPSBjb21iaW5lTGF0ZXN0KFxuICAgICAgYWxsUHJvdmlkZXJzJCxcbiAgICAgIHRoaXMuY29uZmlndXJhdGlvbiQsXG4gICAgICB0aGlzLmNoYW5nZVByb3ZpZGVyJFxuICAgICkucGlwZShcbiAgICAgIHRhcChcbiAgICAgICAgKFtfLCBjb25maWd1cmF0aW9uLCBuZXdQcm92aWRlcl06IFtcbiAgICAgICAgICBQcm92aWRlckRlZmluaXRpb25bXSxcbiAgICAgICAgICBQcm92aWRlclByb3BlcnRpZXMsXG4gICAgICAgICAgUHJvdmlkZXJEZWZpbml0aW9uXG4gICAgICAgIF0pID0+XG4gICAgICAgICAgKHRoaXMubW9kZWwgPSBuZXdQcm92aWRlclxuICAgICAgICAgICAgPyBwaWNrKHRoaXMubW9kZWwsICdzbXMuc2VuZGVyTmFtZScsICdzbXMuc2VuZGVyQWRkcmVzcycpXG4gICAgICAgICAgICA6IGNvbmZpZ3VyYXRpb24pXG4gICAgICApLFxuICAgICAgbWFwKFxuICAgICAgICAoW3Byb3ZpZGVycywgY29uZmlndXJhdGlvbiwgbmV3UHJvdmlkZXJdOiBbXG4gICAgICAgICAgUHJvdmlkZXJEZWZpbml0aW9uW10sXG4gICAgICAgICAgUHJvdmlkZXJQcm9wZXJ0aWVzLFxuICAgICAgICAgIFByb3ZpZGVyRGVmaW5pdGlvblxuICAgICAgICBdKSA9PlxuICAgICAgICAgIG5ld1Byb3ZpZGVyIHx8XG4gICAgICAgICAgZmluZChcbiAgICAgICAgICAgIHByb3ZpZGVycyxcbiAgICAgICAgICAgIChwcm92aWRlcjogUHJvdmlkZXJEZWZpbml0aW9uKSA9PiBnZXQoY29uZmlndXJhdGlvbiwgJ3Byb3ZpZGVyJykgPT09IHByb3ZpZGVyLmlkXG4gICAgICAgICAgKVxuICAgICAgKSxcbiAgICAgIHRhcCgocHJvdmlkZXI6IFByb3ZpZGVyRGVmaW5pdGlvbikgPT4ge1xuICAgICAgICBpZiAocHJvdmlkZXIpIHtcbiAgICAgICAgICBjb25zdCBjb25maWc6IEZvcm1seUZpZWxkQ29uZmlnID0gdGhpcy5qc29uc2NoZW1hLnRvRmllbGRDb25maWcoZ2V0KHByb3ZpZGVyLCAnc2NoZW1hJykpO1xuICAgICAgICAgIGlmIChjb25maWcuZmllbGRHcm91cCkge1xuICAgICAgICAgICAgY29uZmlnLmZpZWxkR3JvdXAuZm9yRWFjaCgoZmllbGRDb25maWc6IEZvcm1seUZpZWxkQ29uZmlnKSA9PiB7XG4gICAgICAgICAgICAgIMm1ZGVmaW5lSGlkZGVuUHJvcChmaWVsZENvbmZpZywgJ19rZXlQYXRoJywge1xuICAgICAgICAgICAgICAgIGtleTogZmllbGRDb25maWcua2V5LFxuICAgICAgICAgICAgICAgIHBhdGg6IFtmaWVsZENvbmZpZy5rZXldXG4gICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgIGZpZWxkQ29uZmlnLmV4cHJlc3Npb25Qcm9wZXJ0aWVzID0ge1xuICAgICAgICAgICAgICAgICd0ZW1wbGF0ZU9wdGlvbnMuZGlzYWJsZWQnOiAnZm9ybVN0YXRlLmRpc2FibGVkJ1xuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMuZmllbGRzID0gW2NvbmZpZ107XG4gICAgICAgICAgdGhpcy5mb3JtID0gbmV3IEZvcm1Hcm91cCh7fSk7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgc2hhcmVSZXBsYXkoMSlcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgc2F2ZVByb3ZpZGVyQ29uZmlndXJhdGlvbigpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzOiBJUmVzdWx0PFByb3ZpZGVyUHJvcGVydGllcz4gPSBhd2FpdCB0aGlzLnByb3ZpZGVyQ29uZmlndXJhdGlvblNlcnZpY2UudXBkYXRlKFxuICAgICAgICB0aGlzLm1vZGVsXG4gICAgICApO1xuICAgICAgdGhpcy5jaGFuZ2VQcm92aWRlciQubmV4dChudWxsKTtcbiAgICAgIHRoaXMudXBkYXRlZENvbmZpZ3VyYXRpb24kLm5leHQocmVzLmRhdGEpO1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2Uuc3VjY2Vzcyh0aGlzLmxheW91dC5jb25maWd1cmF0aW9uVXBkYXRlZFN1Y2Nlc3NNc2cpO1xuICAgICAgdGhpcy5mb3JtLm1hcmtBc1ByaXN0aW5lKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGVycik7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGVsZXRlUHJvdmlkZXJDb25maWd1cmF0aW9uKCkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLm1vZGFsU2VydmljZS5jb25maXJtKFxuICAgICAgICB0aGlzLmxheW91dC5kZWxldGVDb25maWd1cmF0aW9uTW9kYWxUaXRsZSxcbiAgICAgICAgdGhpcy5sYXlvdXQuZGVsZXRlQ29uZmlndXJhdGlvbk1vZGFsQm9keSxcbiAgICAgICAgU3RhdHVzLkRBTkdFUixcbiAgICAgICAge1xuICAgICAgICAgIG9rOiB0aGlzLmxheW91dC5kZWxldGVDb25maWd1cmF0aW9uTW9kYWxPa0J0bkxhYmVsLFxuICAgICAgICAgIGNhbmNlbDogdGhpcy5sYXlvdXQuZGVsZXRlQ29uZmlndXJhdGlvbk1vZGFsQ2FuY2VsQnRuTGFiZWxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIGF3YWl0IHRoaXMucHJvdmlkZXJDb25maWd1cmF0aW9uU2VydmljZS5kZWxldGUoKTtcbiAgICAgIHRoaXMucmVsb2FkJC5uZXh0KCk7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5zdWNjZXNzKHRoaXMubGF5b3V0LmNvbmZpZ3VyYXRpb25EZWxldGVkU3VjY2Vzc01zZyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoZXJyKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUVuY3J5cHRlZFZhbHVlcyhjb25maWd1cmF0aW9uOiBQcm92aWRlclByb3BlcnRpZXMpOiBQcm92aWRlclByb3BlcnRpZXMge1xuICAgIHJldHVybiBtYXBWYWx1ZXMoY29uZmlndXJhdGlvbiwgdmFsdWUgPT4gKHZhbHVlID09PSAnPDxFbmNyeXB0ZWQ+PicgPyB1bmRlZmluZWQgOiB2YWx1ZSkpO1xuICB9XG59XG4iXX0=