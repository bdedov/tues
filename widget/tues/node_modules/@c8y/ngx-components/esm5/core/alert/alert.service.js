import * as tslib_1 from "tslib";
import { BehaviorSubject } from 'rxjs';
import { Injectable } from '@angular/core';
import { StateService } from '../common/state-service.abstract';
import { gettext } from '../i18n/gettext';
import * as i0 from "@angular/core";
/**
 * A service which allows to display alerts.
 */
var AlertService = /** @class */ (function (_super) {
    tslib_1.__extends(AlertService, _super);
    function AlertService() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        /**
         * @ignore
         */
        _this.state$ = new BehaviorSubject([]);
        _this.MAX_ALERTS = 3;
        _this.ALERT_TIMEOUT = 3000;
        return _this;
    }
    Object.defineProperty(AlertService.prototype, "state", {
        /**
         * Returns all alerts.
         * @readonly
         */
        get: function () {
            return this.state$.value;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Adds a new alert to the current state.
     */
    AlertService.prototype.add = function (alert) {
        this.addAlert(alert);
    };
    /**
     * Adds a alert by text.
     */
    AlertService.prototype.addByText = function (type, txt, detailedData) {
        this.addAlert({ text: txt, type: type, detailedData: detailedData });
    };
    /**
     * Returns all alerts.
     * @deprecated Use alertService.alerts instead.
     */
    AlertService.prototype.list = function () {
        return this.state;
    };
    /**
     * Remove an alert from the current state.
     */
    AlertService.prototype.remove = function (alert) {
        var _this = this;
        this.changeAlerts(this.state.filter(function (item) { return !_this.areSame(alert, item); }));
    };
    /**
     * Updates matching alert with provided values.
     */
    AlertService.prototype.update = function (alert, fieldsToUpdate) {
        var _this = this;
        this.changeAlerts(this.state.map(function (item) {
            if (_this.areSame(alert, item)) {
                Object.assign(item, fieldsToUpdate);
            }
            return item;
        }));
    };
    /**
     * Removes last danger alert.
     * It can be used e.g. in the case of a failed request which triggered an alert, to hide it from user.
     *
     * ```js
     *  try {
     *    // something that might throw a danger server msg
     *  } catch (ex) {
     *   this.alertService.removeLastDanger();
     *  }
     * ```
     */
    AlertService.prototype.removeLastDanger = function () {
        var firstDangerAlert = this.state.reverse().find(function (_a) {
            var type = _a.type;
            return type === 'danger';
        });
        this.changeAlerts(this.state.filter(function (alert) { return alert !== firstDangerAlert; }));
    };
    /**
     * Shorthand for a save successful alert.
     * @param savedObject The object which was saved.
     * @return A function that can be executed to show the msg.
     */
    AlertService.prototype.saveSuccess = function (savedObject) {
        var _this = this;
        return function () {
            var text = savedObject + " saved successfully";
            _this.addByText('success', text);
        };
    };
    /**
     * Shorthand for a create successful alert.
     * @param createdObject The object which was created.
     * @return A function that can be executed to show the msg.
     */
    AlertService.prototype.createSuccess = function (createdObject) {
        var _this = this;
        return function () {
            var text = createdObject + " created successfully";
            _this.addByText('success', text);
        };
    };
    /**
     * Clears all alerts.
     */
    AlertService.prototype.clearAll = function () {
        this.changeAlerts([]);
    };
    /**
     * A shorthand to display a simple success message.
     * @param text The success text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.success = function (text, detailedData) {
        this.addByText('success', text, detailedData);
    };
    /**
     * A shorthand to display a simple danger message.
     * @param text The danger text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.danger = function (text, detailedData) {
        this.addByText('danger', text, detailedData);
    };
    /**
     * A shorthand to display a simple info message.
     * @param text The info text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.info = function (text, detailedData) {
        this.addByText('info', text, detailedData);
    };
    /**
     * A shorthand to display a simple warning message.
     * @param text The warning text.
     * @param detailedData The text with additional information.
     */
    AlertService.prototype.warning = function (text, detailedData) {
        this.addByText('warning', text, detailedData);
    };
    /**
     * Creates alert from standard api errors.
     * Should be used for errors generated by @c8y/client services.
     * @param {IResult}  error The error from server.
     * @param {alertType} type The type of alert.
     */
    AlertService.prototype.addServerFailure = function (error, type) {
        if (type === void 0) { type = 'danger'; }
        var data = error.data, res = error.res;
        var text = data && data.message ? data.message : null;
        var detailedData;
        if (data) {
            if (typeof data === 'object') {
                detailedData = data.exceptionMessage;
            }
            else if (typeof data === 'string') {
                detailedData = data;
            }
        }
        var hasRelevantMessage = !!(text || detailedData);
        if (!text) {
            text = gettext('A server error occurred.');
        }
        if (!hasRelevantMessage) {
            detailedData = {
                status: res.status,
                statusText: res.statusText,
                url: res.url
            };
        }
        this.addAlert({
            type: type,
            text: text,
            detailedData: detailedData
        });
    };
    /**
     * Compares two alert objects. Alerts are same if text, type, detailed data and callbacks are same.
     * Callbacks are same if they refer to the same function.
     */
    AlertService.prototype.areSame = function (alert1, alert2) {
        return (alert1.text === alert2.text &&
            alert1.type === alert2.type &&
            alert1.detailedData === alert2.detailedData &&
            alert1.onClose === alert2.onClose &&
            alert1.onDetail === alert2.onDetail);
    };
    AlertService.prototype.changeAlerts = function (newAlerts) {
        this.state$.next(newAlerts);
    };
    AlertService.prototype.addAlert = function (alert) {
        var _this = this;
        if (!alert.text && !alert.type) {
            throw new Error('Cannot add empty alert');
        }
        var alertAlreadyAdded = this.state.find(function (item) { return _this.areSame(alert, item); });
        if (alertAlreadyAdded) {
            return;
        }
        this.changeAlerts(tslib_1.__spread(this.state, [alert]));
        this.hideAutomaticallyIfNeeded(alert);
        this.removeOldestIfMax();
    };
    AlertService.prototype.hideAutomaticallyIfNeeded = function (alert) {
        var _this = this;
        var isSuccess = alert.type === 'success';
        var noDetails = !alert.detailedData;
        var alertTimeout = isSuccess && noDetails ? this.ALERT_TIMEOUT : 0;
        if (typeof alert.timeout !== 'undefined') {
            alertTimeout = alert.timeout;
        }
        if (alertTimeout) {
            setTimeout(function () { return _this.remove(alert); }, alertTimeout);
        }
    };
    AlertService.prototype.removeOldestIfMax = function () {
        if (this.state.length > this.MAX_ALERTS) {
            var _a = tslib_1.__read(this.state), firstRemoved = _a.slice(1);
            this.changeAlerts(firstRemoved);
        }
    };
    AlertService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function AlertService_Factory() { return new AlertService(); }, token: AlertService, providedIn: "root" });
    AlertService = tslib_1.__decorate([
        Injectable({
            providedIn: 'root'
        })
    ], AlertService);
    return AlertService;
}(StateService));
export { AlertService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxlcnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2FsZXJ0L2FsZXJ0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDaEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDOztBQUkxQzs7R0FFRztBQUlIO0lBQWtDLHdDQUFZO0lBSDlDO1FBQUEscUVBeU9DO1FBOU5DOztXQUVHO1FBQ0gsWUFBTSxHQUFHLElBQUksZUFBZSxDQUFVLEVBQUUsQ0FBQyxDQUFDO1FBRWxDLGdCQUFVLEdBQUcsQ0FBQyxDQUFDO1FBQ2YsbUJBQWEsR0FBRyxJQUFJLENBQUM7O0tBd045QjtJQWpPQyxzQkFBSSwrQkFBSztRQUpUOzs7V0FHRzthQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztRQUMzQixDQUFDOzs7T0FBQTtJQVNEOztPQUVHO0lBQ0gsMEJBQUcsR0FBSCxVQUFJLEtBQVk7UUFDZCxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7SUFFRDs7T0FFRztJQUNILGdDQUFTLEdBQVQsVUFBVSxJQUFlLEVBQUUsR0FBVyxFQUFFLFlBQXFCO1FBQzNELElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLElBQUksTUFBQSxFQUFFLFlBQVksY0FBQSxFQUFFLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsMkJBQUksR0FBSjtRQUNFLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBRUQ7O09BRUc7SUFDSCw2QkFBTSxHQUFOLFVBQU8sS0FBWTtRQUFuQixpQkFFQztRQURDLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxDQUFDLEtBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUExQixDQUEwQixDQUFDLENBQUMsQ0FBQztJQUMzRSxDQUFDO0lBRUQ7O09BRUc7SUFDSCw2QkFBTSxHQUFOLFVBQU8sS0FBWSxFQUFFLGNBQThCO1FBQW5ELGlCQVNDO1FBUkMsSUFBSSxDQUFDLFlBQVksQ0FDZixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxVQUFBLElBQUk7WUFDakIsSUFBSSxLQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRTtnQkFDN0IsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsY0FBYyxDQUFDLENBQUM7YUFDckM7WUFDRCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7Ozs7Ozs7O09BV0c7SUFDSCx1Q0FBZ0IsR0FBaEI7UUFDRSxJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQUMsRUFBUTtnQkFBTixjQUFJO1lBQU8sT0FBQSxJQUFJLEtBQUssUUFBUTtRQUFqQixDQUFpQixDQUFDLENBQUM7UUFDcEYsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFBLEtBQUssSUFBSSxPQUFBLEtBQUssS0FBSyxnQkFBZ0IsRUFBMUIsQ0FBMEIsQ0FBQyxDQUFDLENBQUM7SUFDNUUsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxrQ0FBVyxHQUFYLFVBQVksV0FBbUI7UUFBL0IsaUJBS0M7UUFKQyxPQUFPO1lBQ0wsSUFBTSxJQUFJLEdBQU0sV0FBVyx3QkFBcUIsQ0FBQztZQUNqRCxLQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNsQyxDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILG9DQUFhLEdBQWIsVUFBYyxhQUFhO1FBQTNCLGlCQUtDO1FBSkMsT0FBTztZQUNMLElBQU0sSUFBSSxHQUFNLGFBQWEsMEJBQXVCLENBQUM7WUFDckQsS0FBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbEMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0gsK0JBQVEsR0FBUjtRQUNFLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCw4QkFBTyxHQUFQLFVBQVEsSUFBWSxFQUFFLFlBQXFCO1FBQ3pDLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILDZCQUFNLEdBQU4sVUFBTyxJQUFZLEVBQUUsWUFBcUI7UUFDeEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsMkJBQUksR0FBSixVQUFLLElBQVksRUFBRSxZQUFxQjtRQUN0QyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCw4QkFBTyxHQUFQLFVBQVEsSUFBWSxFQUFFLFlBQXFCO1FBQ3pDLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCx1Q0FBZ0IsR0FBaEIsVUFBaUIsS0FBVSxFQUFFLElBQTBCO1FBQTFCLHFCQUFBLEVBQUEsZUFBMEI7UUFDN0MsSUFBQSxpQkFBSSxFQUFFLGVBQUcsQ0FBVztRQUM1QixJQUFJLElBQUksR0FBRyxJQUFJLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ3RELElBQUksWUFBWSxDQUFDO1FBQ2pCLElBQUksSUFBSSxFQUFFO1lBQ1IsSUFBSSxPQUFPLElBQUksS0FBSyxRQUFRLEVBQUU7Z0JBQzVCLFlBQVksR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7YUFDdEM7aUJBQU0sSUFBSSxPQUFPLElBQUksS0FBSyxRQUFRLEVBQUU7Z0JBQ25DLFlBQVksR0FBRyxJQUFJLENBQUM7YUFDckI7U0FDRjtRQUNELElBQU0sa0JBQWtCLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLFlBQVksQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDVCxJQUFJLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUM7U0FDNUM7UUFDRCxJQUFJLENBQUMsa0JBQWtCLEVBQUU7WUFDdkIsWUFBWSxHQUFHO2dCQUNiLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTTtnQkFDbEIsVUFBVSxFQUFFLEdBQUcsQ0FBQyxVQUFVO2dCQUMxQixHQUFHLEVBQUUsR0FBRyxDQUFDLEdBQUc7YUFDYixDQUFDO1NBQ0g7UUFFRCxJQUFJLENBQUMsUUFBUSxDQUFDO1lBQ1osSUFBSSxNQUFBO1lBQ0osSUFBSSxNQUFBO1lBQ0osWUFBWSxjQUFBO1NBQ2IsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7T0FHRztJQUNILDhCQUFPLEdBQVAsVUFBUSxNQUFhLEVBQUUsTUFBYTtRQUNsQyxPQUFPLENBQ0wsTUFBTSxDQUFDLElBQUksS0FBSyxNQUFNLENBQUMsSUFBSTtZQUMzQixNQUFNLENBQUMsSUFBSSxLQUFLLE1BQU0sQ0FBQyxJQUFJO1lBQzNCLE1BQU0sQ0FBQyxZQUFZLEtBQUssTUFBTSxDQUFDLFlBQVk7WUFDM0MsTUFBTSxDQUFDLE9BQU8sS0FBSyxNQUFNLENBQUMsT0FBTztZQUNqQyxNQUFNLENBQUMsUUFBUSxLQUFLLE1BQU0sQ0FBQyxRQUFRLENBQ3BDLENBQUM7SUFDSixDQUFDO0lBRU8sbUNBQVksR0FBcEIsVUFBcUIsU0FBa0I7UUFDckMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUVPLCtCQUFRLEdBQWhCLFVBQWlCLEtBQVk7UUFBN0IsaUJBYUM7UUFaQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUU7WUFDOUIsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1NBQzNDO1FBRUQsSUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLEtBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUF6QixDQUF5QixDQUFDLENBQUM7UUFDN0UsSUFBSSxpQkFBaUIsRUFBRTtZQUNyQixPQUFPO1NBQ1I7UUFFRCxJQUFJLENBQUMsWUFBWSxrQkFBSyxJQUFJLENBQUMsS0FBSyxHQUFFLEtBQUssR0FBRSxDQUFDO1FBQzFDLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN0QyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRU8sZ0RBQXlCLEdBQWpDLFVBQWtDLEtBQVk7UUFBOUMsaUJBVUM7UUFUQyxJQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQztRQUMzQyxJQUFNLFNBQVMsR0FBRyxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUM7UUFDdEMsSUFBSSxZQUFZLEdBQUcsU0FBUyxJQUFJLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25FLElBQUksT0FBTyxLQUFLLENBQUMsT0FBTyxLQUFLLFdBQVcsRUFBRTtZQUN4QyxZQUFZLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztTQUM5QjtRQUNELElBQUksWUFBWSxFQUFFO1lBQ2hCLFVBQVUsQ0FBQyxjQUFNLE9BQUEsS0FBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBbEIsQ0FBa0IsRUFBRSxZQUFZLENBQUMsQ0FBQztTQUNwRDtJQUNILENBQUM7SUFFTyx3Q0FBaUIsR0FBekI7UUFDRSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDakMsSUFBQSwrQkFBZ0MsRUFBN0IsMEJBQTZCLENBQUM7WUFDdkMsSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQztTQUNqQztJQUNILENBQUM7O0lBck9VLFlBQVk7UUFIeEIsVUFBVSxDQUFDO1lBQ1YsVUFBVSxFQUFFLE1BQU07U0FDbkIsQ0FBQztPQUNXLFlBQVksQ0FzT3hCO3VCQXBQRDtDQW9QQyxBQXRPRCxDQUFrQyxZQUFZLEdBc083QztTQXRPWSxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWxlcnQgfSBmcm9tICcuL2FsZXJ0Lm1vZGVsJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL3N0YXRlLXNlcnZpY2UuYWJzdHJhY3QnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJy4uL2kxOG4vZ2V0dGV4dCc7XG5pbXBvcnQge0lSZXN1bHR9IGZyb20gJ0BjOHkvY2xpZW50JztcblxudHlwZSBhbGVydFR5cGUgPSAnc3VjY2VzcycgfCAnd2FybmluZycgfCAnZGFuZ2VyJyB8ICdpbmZvJyB8ICdzeXN0ZW0nO1xuLyoqXG4gKiBBIHNlcnZpY2Ugd2hpY2ggYWxsb3dzIHRvIGRpc3BsYXkgYWxlcnRzLlxuICovXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBBbGVydFNlcnZpY2UgZXh0ZW5kcyBTdGF0ZVNlcnZpY2Uge1xuICAvKipcbiAgICogUmV0dXJucyBhbGwgYWxlcnRzLlxuICAgKiBAcmVhZG9ubHlcbiAgICovXG4gIGdldCBzdGF0ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZSQudmFsdWU7XG4gIH1cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIHN0YXRlJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8QWxlcnRbXT4oW10pO1xuXG4gIHByaXZhdGUgTUFYX0FMRVJUUyA9IDM7XG4gIHByaXZhdGUgQUxFUlRfVElNRU9VVCA9IDMwMDA7XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBuZXcgYWxlcnQgdG8gdGhlIGN1cnJlbnQgc3RhdGUuXG4gICAqL1xuICBhZGQoYWxlcnQ6IEFsZXJ0KSB7XG4gICAgdGhpcy5hZGRBbGVydChhbGVydCk7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhIGFsZXJ0IGJ5IHRleHQuXG4gICAqL1xuICBhZGRCeVRleHQodHlwZTogYWxlcnRUeXBlLCB0eHQ6IHN0cmluZywgZGV0YWlsZWREYXRhPzogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5hZGRBbGVydCh7IHRleHQ6IHR4dCwgdHlwZSwgZGV0YWlsZWREYXRhIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYWxsIGFsZXJ0cy5cbiAgICogQGRlcHJlY2F0ZWQgVXNlIGFsZXJ0U2VydmljZS5hbGVydHMgaW5zdGVhZC5cbiAgICovXG4gIGxpc3QoKTogQWxlcnRbXSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGU7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGFuIGFsZXJ0IGZyb20gdGhlIGN1cnJlbnQgc3RhdGUuXG4gICAqL1xuICByZW1vdmUoYWxlcnQ6IEFsZXJ0KSB7XG4gICAgdGhpcy5jaGFuZ2VBbGVydHModGhpcy5zdGF0ZS5maWx0ZXIoaXRlbSA9PiAhdGhpcy5hcmVTYW1lKGFsZXJ0LCBpdGVtKSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgbWF0Y2hpbmcgYWxlcnQgd2l0aCBwcm92aWRlZCB2YWx1ZXMuXG4gICAqL1xuICB1cGRhdGUoYWxlcnQ6IEFsZXJ0LCBmaWVsZHNUb1VwZGF0ZTogUGFydGlhbDxBbGVydD4pIHtcbiAgICB0aGlzLmNoYW5nZUFsZXJ0cyhcbiAgICAgIHRoaXMuc3RhdGUubWFwKGl0ZW0gPT4ge1xuICAgICAgICBpZiAodGhpcy5hcmVTYW1lKGFsZXJ0LCBpdGVtKSkge1xuICAgICAgICAgIE9iamVjdC5hc3NpZ24oaXRlbSwgZmllbGRzVG9VcGRhdGUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpdGVtO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgbGFzdCBkYW5nZXIgYWxlcnQuXG4gICAqIEl0IGNhbiBiZSB1c2VkIGUuZy4gaW4gdGhlIGNhc2Ugb2YgYSBmYWlsZWQgcmVxdWVzdCB3aGljaCB0cmlnZ2VyZWQgYW4gYWxlcnQsIHRvIGhpZGUgaXQgZnJvbSB1c2VyLlxuICAgKlxuICAgKiBgYGBqc1xuICAgKiAgdHJ5IHtcbiAgICogICAgLy8gc29tZXRoaW5nIHRoYXQgbWlnaHQgdGhyb3cgYSBkYW5nZXIgc2VydmVyIG1zZ1xuICAgKiAgfSBjYXRjaCAoZXgpIHtcbiAgICogICB0aGlzLmFsZXJ0U2VydmljZS5yZW1vdmVMYXN0RGFuZ2VyKCk7XG4gICAqICB9XG4gICAqIGBgYFxuICAgKi9cbiAgcmVtb3ZlTGFzdERhbmdlcigpIHtcbiAgICBjb25zdCBmaXJzdERhbmdlckFsZXJ0ID0gdGhpcy5zdGF0ZS5yZXZlcnNlKCkuZmluZCgoeyB0eXBlIH0pID0+IHR5cGUgPT09ICdkYW5nZXInKTtcbiAgICB0aGlzLmNoYW5nZUFsZXJ0cyh0aGlzLnN0YXRlLmZpbHRlcihhbGVydCA9PiBhbGVydCAhPT0gZmlyc3REYW5nZXJBbGVydCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNob3J0aGFuZCBmb3IgYSBzYXZlIHN1Y2Nlc3NmdWwgYWxlcnQuXG4gICAqIEBwYXJhbSBzYXZlZE9iamVjdCBUaGUgb2JqZWN0IHdoaWNoIHdhcyBzYXZlZC5cbiAgICogQHJldHVybiBBIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIGV4ZWN1dGVkIHRvIHNob3cgdGhlIG1zZy5cbiAgICovXG4gIHNhdmVTdWNjZXNzKHNhdmVkT2JqZWN0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY29uc3QgdGV4dCA9IGAke3NhdmVkT2JqZWN0fSBzYXZlZCBzdWNjZXNzZnVsbHlgO1xuICAgICAgdGhpcy5hZGRCeVRleHQoJ3N1Y2Nlc3MnLCB0ZXh0KTtcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFNob3J0aGFuZCBmb3IgYSBjcmVhdGUgc3VjY2Vzc2Z1bCBhbGVydC5cbiAgICogQHBhcmFtIGNyZWF0ZWRPYmplY3QgVGhlIG9iamVjdCB3aGljaCB3YXMgY3JlYXRlZC5cbiAgICogQHJldHVybiBBIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIGV4ZWN1dGVkIHRvIHNob3cgdGhlIG1zZy5cbiAgICovXG4gIGNyZWF0ZVN1Y2Nlc3MoY3JlYXRlZE9iamVjdCkge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjb25zdCB0ZXh0ID0gYCR7Y3JlYXRlZE9iamVjdH0gY3JlYXRlZCBzdWNjZXNzZnVsbHlgO1xuICAgICAgdGhpcy5hZGRCeVRleHQoJ3N1Y2Nlc3MnLCB0ZXh0KTtcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFycyBhbGwgYWxlcnRzLlxuICAgKi9cbiAgY2xlYXJBbGwoKSB7XG4gICAgdGhpcy5jaGFuZ2VBbGVydHMoW10pO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgc2hvcnRoYW5kIHRvIGRpc3BsYXkgYSBzaW1wbGUgc3VjY2VzcyBtZXNzYWdlLlxuICAgKiBAcGFyYW0gdGV4dCBUaGUgc3VjY2VzcyB0ZXh0LlxuICAgKiBAcGFyYW0gZGV0YWlsZWREYXRhIFRoZSB0ZXh0IHdpdGggYWRkaXRpb25hbCBpbmZvcm1hdGlvbi5cbiAgICovXG4gIHN1Y2Nlc3ModGV4dDogc3RyaW5nLCBkZXRhaWxlZERhdGE/OiBzdHJpbmcpIHtcbiAgICB0aGlzLmFkZEJ5VGV4dCgnc3VjY2VzcycsIHRleHQsIGRldGFpbGVkRGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQSBzaG9ydGhhbmQgdG8gZGlzcGxheSBhIHNpbXBsZSBkYW5nZXIgbWVzc2FnZS5cbiAgICogQHBhcmFtIHRleHQgVGhlIGRhbmdlciB0ZXh0LlxuICAgKiBAcGFyYW0gZGV0YWlsZWREYXRhIFRoZSB0ZXh0IHdpdGggYWRkaXRpb25hbCBpbmZvcm1hdGlvbi5cbiAgICovXG4gIGRhbmdlcih0ZXh0OiBzdHJpbmcsIGRldGFpbGVkRGF0YT86IHN0cmluZykge1xuICAgIHRoaXMuYWRkQnlUZXh0KCdkYW5nZXInLCB0ZXh0LCBkZXRhaWxlZERhdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgc2hvcnRoYW5kIHRvIGRpc3BsYXkgYSBzaW1wbGUgaW5mbyBtZXNzYWdlLlxuICAgKiBAcGFyYW0gdGV4dCBUaGUgaW5mbyB0ZXh0LlxuICAgKiBAcGFyYW0gZGV0YWlsZWREYXRhIFRoZSB0ZXh0IHdpdGggYWRkaXRpb25hbCBpbmZvcm1hdGlvbi5cbiAgICovXG4gIGluZm8odGV4dDogc3RyaW5nLCBkZXRhaWxlZERhdGE/OiBzdHJpbmcpIHtcbiAgICB0aGlzLmFkZEJ5VGV4dCgnaW5mbycsIHRleHQsIGRldGFpbGVkRGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQSBzaG9ydGhhbmQgdG8gZGlzcGxheSBhIHNpbXBsZSB3YXJuaW5nIG1lc3NhZ2UuXG4gICAqIEBwYXJhbSB0ZXh0IFRoZSB3YXJuaW5nIHRleHQuXG4gICAqIEBwYXJhbSBkZXRhaWxlZERhdGEgVGhlIHRleHQgd2l0aCBhZGRpdGlvbmFsIGluZm9ybWF0aW9uLlxuICAgKi9cbiAgd2FybmluZyh0ZXh0OiBzdHJpbmcsIGRldGFpbGVkRGF0YT86IHN0cmluZykge1xuICAgIHRoaXMuYWRkQnlUZXh0KCd3YXJuaW5nJywgdGV4dCwgZGV0YWlsZWREYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGFsZXJ0IGZyb20gc3RhbmRhcmQgYXBpIGVycm9ycy5cbiAgICogU2hvdWxkIGJlIHVzZWQgZm9yIGVycm9ycyBnZW5lcmF0ZWQgYnkgQGM4eS9jbGllbnQgc2VydmljZXMuXG4gICAqIEBwYXJhbSB7SVJlc3VsdH0gIGVycm9yIFRoZSBlcnJvciBmcm9tIHNlcnZlci5cbiAgICogQHBhcmFtIHthbGVydFR5cGV9IHR5cGUgVGhlIHR5cGUgb2YgYWxlcnQuXG4gICAqL1xuICBhZGRTZXJ2ZXJGYWlsdXJlKGVycm9yOiBhbnksIHR5cGU6IGFsZXJ0VHlwZSA9ICdkYW5nZXInKSB7XG4gICAgY29uc3QgeyBkYXRhLCByZXMgfSA9IGVycm9yO1xuICAgIGxldCB0ZXh0ID0gZGF0YSAmJiBkYXRhLm1lc3NhZ2UgPyBkYXRhLm1lc3NhZ2UgOiBudWxsO1xuICAgIGxldCBkZXRhaWxlZERhdGE7XG4gICAgaWYgKGRhdGEpIHtcbiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgZGV0YWlsZWREYXRhID0gZGF0YS5leGNlcHRpb25NZXNzYWdlO1xuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgZGV0YWlsZWREYXRhID0gZGF0YTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgaGFzUmVsZXZhbnRNZXNzYWdlID0gISEodGV4dCB8fCBkZXRhaWxlZERhdGEpO1xuICAgIGlmICghdGV4dCkge1xuICAgICAgdGV4dCA9IGdldHRleHQoJ0Egc2VydmVyIGVycm9yIG9jY3VycmVkLicpO1xuICAgIH1cbiAgICBpZiAoIWhhc1JlbGV2YW50TWVzc2FnZSkge1xuICAgICAgZGV0YWlsZWREYXRhID0ge1xuICAgICAgICBzdGF0dXM6IHJlcy5zdGF0dXMsXG4gICAgICAgIHN0YXR1c1RleHQ6IHJlcy5zdGF0dXNUZXh0LFxuICAgICAgICB1cmw6IHJlcy51cmxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgdGhpcy5hZGRBbGVydCh7XG4gICAgICB0eXBlLFxuICAgICAgdGV4dCxcbiAgICAgIGRldGFpbGVkRGF0YVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbXBhcmVzIHR3byBhbGVydCBvYmplY3RzLiBBbGVydHMgYXJlIHNhbWUgaWYgdGV4dCwgdHlwZSwgZGV0YWlsZWQgZGF0YSBhbmQgY2FsbGJhY2tzIGFyZSBzYW1lLlxuICAgKiBDYWxsYmFja3MgYXJlIHNhbWUgaWYgdGhleSByZWZlciB0byB0aGUgc2FtZSBmdW5jdGlvbi5cbiAgICovXG4gIGFyZVNhbWUoYWxlcnQxOiBBbGVydCwgYWxlcnQyOiBBbGVydCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAoXG4gICAgICBhbGVydDEudGV4dCA9PT0gYWxlcnQyLnRleHQgJiZcbiAgICAgIGFsZXJ0MS50eXBlID09PSBhbGVydDIudHlwZSAmJlxuICAgICAgYWxlcnQxLmRldGFpbGVkRGF0YSA9PT0gYWxlcnQyLmRldGFpbGVkRGF0YSAmJlxuICAgICAgYWxlcnQxLm9uQ2xvc2UgPT09IGFsZXJ0Mi5vbkNsb3NlICYmXG4gICAgICBhbGVydDEub25EZXRhaWwgPT09IGFsZXJ0Mi5vbkRldGFpbFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNoYW5nZUFsZXJ0cyhuZXdBbGVydHM6IEFsZXJ0W10pIHtcbiAgICB0aGlzLnN0YXRlJC5uZXh0KG5ld0FsZXJ0cyk7XG4gIH1cblxuICBwcml2YXRlIGFkZEFsZXJ0KGFsZXJ0OiBBbGVydCk6IHZvaWQge1xuICAgIGlmICghYWxlcnQudGV4dCAmJiAhYWxlcnQudHlwZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgYWRkIGVtcHR5IGFsZXJ0Jyk7XG4gICAgfVxuXG4gICAgY29uc3QgYWxlcnRBbHJlYWR5QWRkZWQgPSB0aGlzLnN0YXRlLmZpbmQoaXRlbSA9PiB0aGlzLmFyZVNhbWUoYWxlcnQsIGl0ZW0pKTtcbiAgICBpZiAoYWxlcnRBbHJlYWR5QWRkZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmNoYW5nZUFsZXJ0cyhbLi4udGhpcy5zdGF0ZSwgYWxlcnRdKTtcbiAgICB0aGlzLmhpZGVBdXRvbWF0aWNhbGx5SWZOZWVkZWQoYWxlcnQpO1xuICAgIHRoaXMucmVtb3ZlT2xkZXN0SWZNYXgoKTtcbiAgfVxuXG4gIHByaXZhdGUgaGlkZUF1dG9tYXRpY2FsbHlJZk5lZWRlZChhbGVydDogQWxlcnQpIHtcbiAgICBjb25zdCBpc1N1Y2Nlc3MgPSBhbGVydC50eXBlID09PSAnc3VjY2Vzcyc7XG4gICAgY29uc3Qgbm9EZXRhaWxzID0gIWFsZXJ0LmRldGFpbGVkRGF0YTtcbiAgICBsZXQgYWxlcnRUaW1lb3V0ID0gaXNTdWNjZXNzICYmIG5vRGV0YWlscyA/IHRoaXMuQUxFUlRfVElNRU9VVCA6IDA7XG4gICAgaWYgKHR5cGVvZiBhbGVydC50aW1lb3V0ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgYWxlcnRUaW1lb3V0ID0gYWxlcnQudGltZW91dDtcbiAgICB9XG4gICAgaWYgKGFsZXJ0VGltZW91dCkge1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnJlbW92ZShhbGVydCksIGFsZXJ0VGltZW91dCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVPbGRlc3RJZk1heCgpIHtcbiAgICBpZiAodGhpcy5zdGF0ZS5sZW5ndGggPiB0aGlzLk1BWF9BTEVSVFMpIHtcbiAgICAgIGNvbnN0IFssIC4uLmZpcnN0UmVtb3ZlZF0gPSB0aGlzLnN0YXRlO1xuICAgICAgdGhpcy5jaGFuZ2VBbGVydHMoZmlyc3RSZW1vdmVkKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==