import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { InventoryService, IManagedObject, OperationStatus, IOperation } from '@c8y/client';
import { gettext } from '@c8y/ngx-components';
import { RepositoryService } from '../repository.service';
import { AlertService } from '@c8y/ngx-components';
import { DeviceConfigurationOperation } from '../repository.model';
import { DeviceConfigurationService } from './device-configuration.service';
var TextBasedConfigurationComponent = /** @class */ (function () {
    function TextBasedConfigurationComponent(route, alertService, repositoryService, deviceConfigurationService, inventoryService) {
        this.route = route;
        this.alertService = alertService;
        this.repositoryService = repositoryService;
        this.deviceConfigurationService = deviceConfigurationService;
        this.inventoryService = inventoryService;
        this.reloadingConfig = false;
        this.savingConfig = false;
    }
    TextBasedConfigurationComponent.prototype.ngOnInit = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.device = this.route.snapshot.parent.data.contextData;
                        return [4 /*yield*/, this.loadOperation()];
                    case 1:
                        _a.sent();
                        this.showTextBasedConfigReload = this.deviceConfigurationService.hasAnySupportedOperation(this.device, [DeviceConfigurationOperation.SEND_CONFIG]);
                        this.showTextBasedConfigSave = this.deviceConfigurationService.hasAnySupportedOperation(this.device, [DeviceConfigurationOperation.CONFIG]);
                        if (this.device.c8y_Configuration && this.device.c8y_Configuration.config) {
                            this.config = this.device.c8y_Configuration.config;
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    TextBasedConfigurationComponent.prototype.loadOperation = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var operation;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.repositoryService.getLastConfigUpdateOperation(this.device.id)];
                    case 1:
                        operation = _a.sent();
                        if (operation !== null) {
                            this.repositoryService.observeOperation(operation).subscribe(function (operationUpdate) {
                                _this.latestOperation = operationUpdate;
                            });
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    TextBasedConfigurationComponent.prototype.reloadConfiguration = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var operationCfg;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.reloadingConfig = true;
                        return [4 /*yield*/, this.repositoryService.createTextBasedConfigurationReloadOperation(this.device)];
                    case 1:
                        operationCfg = _a.sent();
                        try {
                            this.repositoryService
                                .createObservedOperation(operationCfg)
                                .subscribe(function (operationUpdate) { return _this.onOperationReloadSuccess(operationUpdate); }, function (operationUpdate) { return _this.onOperationReloadError(operationUpdate); }, function () { return _this.onOperationReloadComplete(); });
                        }
                        catch (ex) {
                            this.alertService.addServerFailure(ex);
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    TextBasedConfigurationComponent.prototype.updateConfiguration = function (config) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var operationCfg;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.savingConfig = true;
                        return [4 /*yield*/, this.repositoryService.createTextBasedConfigurationUpdateOperation(this.device, config)];
                    case 1:
                        operationCfg = _a.sent();
                        try {
                            this.repositoryService
                                .createObservedOperation(operationCfg)
                                .subscribe(function (operationUpdate) { return _this.onOperationUpdateSuccess(operationUpdate); }, function (operationUpdate) { return _this.onOperationUpdateError(operationUpdate); }, function () { return _this.onOperationUpdateComplete(); });
                        }
                        catch (ex) {
                            this.alertService.addServerFailure(ex);
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    TextBasedConfigurationComponent.prototype.onOperationReloadSuccess = function (operationUpdate) {
        this.latestOperation = operationUpdate;
        if (operationUpdate.status === OperationStatus.PENDING) {
            this.alertService.success(gettext('Configuration will be reloaded.'));
        }
    };
    TextBasedConfigurationComponent.prototype.onOperationReloadError = function (operationUpdate) {
        this.latestOperation = operationUpdate;
        this.reloadingConfig = false;
    };
    TextBasedConfigurationComponent.prototype.onOperationReloadComplete = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.loadDevice()];
                    case 1:
                        _a.sent();
                        this.config = this.device.c8y_Configuration.config;
                        this.reloadingConfig = false;
                        return [2 /*return*/];
                }
            });
        });
    };
    TextBasedConfigurationComponent.prototype.onOperationUpdateSuccess = function (operationUpdate) {
        this.latestOperation = operationUpdate;
        if (operationUpdate.status === OperationStatus.PENDING) {
            this.alertService.success(gettext('Configuration will be updated.'));
        }
    };
    TextBasedConfigurationComponent.prototype.onOperationUpdateError = function (operationUpdate) {
        this.latestOperation = operationUpdate;
        this.savingConfig = false;
    };
    TextBasedConfigurationComponent.prototype.onOperationUpdateComplete = function () {
        this.device.c8y_Configuration.config = this.config;
        this.savingConfig = false;
    };
    TextBasedConfigurationComponent.prototype.loadDevice = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        _a = this;
                        return [4 /*yield*/, this.inventoryService.detail(this.device.id, { withChildren: false })];
                    case 1:
                        _a.device = (_b.sent()).data;
                        return [2 /*return*/];
                }
            });
        });
    };
    TextBasedConfigurationComponent.ctorParameters = function () { return [
        { type: ActivatedRoute },
        { type: AlertService },
        { type: RepositoryService },
        { type: DeviceConfigurationService },
        { type: InventoryService }
    ]; };
    TextBasedConfigurationComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-text-based-configuration',
            template: "<div class=\"d-flex d-col fit-v\">\n  <fieldset *ngIf=\"latestOperation !== undefined\" class=\"card-block bg-gray-white fit-h\">\n    <div class=\"content-flex-50\">\n      <c8y-single-operation [operation]=\"latestOperation\" class=\"flex-grow\"></c8y-single-operation>\n      <div class=\"flex-item-right d-flex\">\n        <button\n          title=\"{{ 'Get snapshot from device' | translate }}\"\n          type=\"button\"\n          class=\"btn btn-default btn-sm flex-item-v-center m-t-8 m-b-8\"\n          *ngIf=\"showTextBasedConfigReload\"\n          (click)=\"reloadConfiguration()\"\n          [disabled]=\"reloadingConfig || savingConfig\"\n        >\n          <i\n            c8yIcon=\"refresh\"\n            *ngIf=\"reloadingConfig\"\n            class=\"m-r-4\"\n            [ngClass]=\"{ 'fa-spin': reloadingConfig }\"\n          ></i>\n          <i c8yIcon=\"download\" *ngIf=\"!reloadingConfig\" class=\"m-r-4\"></i>\n\n          {{ 'Get snapshot from device' | translate }}\n        </button>\n      </div>\n    </div>\n  </fieldset>\n  <div class=\"card-block flex-grow\">\n    <textarea\n      [(ngModel)]=\"config\"\n      style=\"height: 100%;\"\n      class=\"form-control\"\n      [disabled]=\"reloadingConfig || savingConfig\"\n      c8y-spellcheck=\"false\"\n    ></textarea>\n  </div>\n  <div class=\"card-footer fit-h separator\" *ngIf=\"showTextBasedConfigSave\">\n    <button\n      type=\"button\"\n      (click)=\"updateConfiguration(config)\"\n      [disabled]=\"reloadingConfig || savingConfig\"\n      class=\"btn btn-primary\"\n      [ngClass]=\"{ 'btn-pending': savingConfig }\"\n    >\n      <span title=\"{{ 'Send' | translate }}\" *ngIf=\"!savingConfig\">\n        {{ 'Send configuration to device' | translate }}\n      </span>\n      <span title=\"{{ 'Sending' | translate }}\u2026\" *ngIf=\"savingConfig\">\n        {{ 'Sending' | translate }}\u2026</span\n      >\n    </button>\n  </div>\n</div>\n"
        })
    ], TextBasedConfigurationComponent);
    return TextBasedConfigurationComponent;
}());
export { TextBasedConfigurationComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dC1iYXNlZC1jb25maWd1cmF0aW9uLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvcmVwb3NpdG9yeS8iLCJzb3VyY2VzIjpbImNvbmZpZ3VyYXRpb24tZGV2aWNlLXRhYi90ZXh0LWJhc2VkLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBQ2xELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsY0FBYyxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDNUYsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzFELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQU01RTtJQVNFLHlDQUNVLEtBQXFCLEVBQ3JCLFlBQTBCLEVBQzFCLGlCQUFvQyxFQUNwQywwQkFBc0QsRUFDdEQsZ0JBQWtDO1FBSmxDLFVBQUssR0FBTCxLQUFLLENBQWdCO1FBQ3JCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMsK0JBQTBCLEdBQTFCLDBCQUEwQixDQUE0QjtRQUN0RCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBVDVDLG9CQUFlLEdBQUcsS0FBSyxDQUFDO1FBQ3hCLGlCQUFZLEdBQUcsS0FBSyxDQUFDO0lBU2xCLENBQUM7SUFFRSxrREFBUSxHQUFkOzs7Ozt3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QUFlLENBQUM7UUFDdkMsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7SUFDNUIsQ0FBQztJQUVPLG1FQUF5QixHQUFqQztRQUNFLElBQUksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDbkQsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7SUFDNUIsQ0FBQztJQUVhLG9EQUFVLEdBQXhCOzs7Ozs7d0JBQ0UsS0FBQSxJQUFJLENBQUE7d0JBQVcscUJBQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFBOzt3QkFBMUYsR0FBSyxNQUFNLEdBQUcsQ0FBQyxTQUEyRSxDQUFDLENBQUMsSUFBSSxDQUFDOzs7OztLQUNsRzs7Z0JBMUdnQixjQUFjO2dCQUNQLFlBQVk7Z0JBQ1AsaUJBQWlCO2dCQUNSLDBCQUEwQjtnQkFDcEMsZ0JBQWdCOztJQWRqQywrQkFBK0I7UUFKM0MsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLDhCQUE4QjtZQUN4QyxxNkRBQXdEO1NBQ3pELENBQUM7T0FDVywrQkFBK0IsQ0FxSDNDO0lBQUQsc0NBQUM7Q0FBQSxBQXJIRCxJQXFIQztTQXJIWSwrQkFBK0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgSW52ZW50b3J5U2VydmljZSwgSU1hbmFnZWRPYmplY3QsIE9wZXJhdGlvblN0YXR1cywgSU9wZXJhdGlvbiB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IGdldHRleHQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IFJlcG9zaXRvcnlTZXJ2aWNlIH0gZnJvbSAnLi4vcmVwb3NpdG9yeS5zZXJ2aWNlJztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgRGV2aWNlQ29uZmlndXJhdGlvbk9wZXJhdGlvbiB9IGZyb20gJy4uL3JlcG9zaXRvcnkubW9kZWwnO1xuaW1wb3J0IHsgRGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2UgfSBmcm9tICcuL2RldmljZS1jb25maWd1cmF0aW9uLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktdGV4dC1iYXNlZC1jb25maWd1cmF0aW9uJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3RleHQtYmFzZWQtY29uZmlndXJhdGlvbi5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgVGV4dEJhc2VkQ29uZmlndXJhdGlvbkNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIGRldmljZTogSU1hbmFnZWRPYmplY3Q7XG4gIGxhdGVzdE9wZXJhdGlvbjogSU9wZXJhdGlvbjtcbiAgc2hvd1RleHRCYXNlZENvbmZpZ1JlbG9hZDogYm9vbGVhbjtcbiAgc2hvd1RleHRCYXNlZENvbmZpZ1NhdmU6IGJvb2xlYW47XG4gIHJlbG9hZGluZ0NvbmZpZyA9IGZhbHNlO1xuICBzYXZpbmdDb25maWcgPSBmYWxzZTtcbiAgY29uZmlnOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByb3V0ZTogQWN0aXZhdGVkUm91dGUsXG4gICAgcHJpdmF0ZSBhbGVydFNlcnZpY2U6IEFsZXJ0U2VydmljZSxcbiAgICBwcml2YXRlIHJlcG9zaXRvcnlTZXJ2aWNlOiBSZXBvc2l0b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGRldmljZUNvbmZpZ3VyYXRpb25TZXJ2aWNlOiBEZXZpY2VDb25maWd1cmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeVNlcnZpY2U6IEludmVudG9yeVNlcnZpY2VcbiAgKSB7fVxuXG4gIGFzeW5jIG5nT25Jbml0KCkge1xuICAgIHRoaXMuZGV2aWNlID0gdGhpcy5yb3V0ZS5zbmFwc2hvdC5wYXJlbnQuZGF0YS5jb250ZXh0RGF0YTtcbiAgICBhd2FpdCB0aGlzLmxvYWRPcGVyYXRpb24oKTtcbiAgICB0aGlzLnNob3dUZXh0QmFzZWRDb25maWdSZWxvYWQgPSB0aGlzLmRldmljZUNvbmZpZ3VyYXRpb25TZXJ2aWNlLmhhc0FueVN1cHBvcnRlZE9wZXJhdGlvbihcbiAgICAgIHRoaXMuZGV2aWNlLFxuICAgICAgW0RldmljZUNvbmZpZ3VyYXRpb25PcGVyYXRpb24uU0VORF9DT05GSUddXG4gICAgKTtcbiAgICB0aGlzLnNob3dUZXh0QmFzZWRDb25maWdTYXZlID0gdGhpcy5kZXZpY2VDb25maWd1cmF0aW9uU2VydmljZS5oYXNBbnlTdXBwb3J0ZWRPcGVyYXRpb24oXG4gICAgICB0aGlzLmRldmljZSxcbiAgICAgIFtEZXZpY2VDb25maWd1cmF0aW9uT3BlcmF0aW9uLkNPTkZJR11cbiAgICApO1xuICAgIGlmICh0aGlzLmRldmljZS5jOHlfQ29uZmlndXJhdGlvbiAmJiB0aGlzLmRldmljZS5jOHlfQ29uZmlndXJhdGlvbi5jb25maWcpIHtcbiAgICAgIHRoaXMuY29uZmlnID0gdGhpcy5kZXZpY2UuYzh5X0NvbmZpZ3VyYXRpb24uY29uZmlnO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGxvYWRPcGVyYXRpb24oKSB7XG4gICAgY29uc3Qgb3BlcmF0aW9uID0gYXdhaXQgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5nZXRMYXN0Q29uZmlnVXBkYXRlT3BlcmF0aW9uKHRoaXMuZGV2aWNlLmlkKTtcbiAgICBpZiAob3BlcmF0aW9uICE9PSBudWxsKSB7XG4gICAgICB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLm9ic2VydmVPcGVyYXRpb24ob3BlcmF0aW9uKS5zdWJzY3JpYmUob3BlcmF0aW9uVXBkYXRlID0+IHtcbiAgICAgICAgdGhpcy5sYXRlc3RPcGVyYXRpb24gPSBvcGVyYXRpb25VcGRhdGU7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyByZWxvYWRDb25maWd1cmF0aW9uKCkge1xuICAgIHRoaXMucmVsb2FkaW5nQ29uZmlnID0gdHJ1ZTtcbiAgICBjb25zdCBvcGVyYXRpb25DZmcgPSBhd2FpdCB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmNyZWF0ZVRleHRCYXNlZENvbmZpZ3VyYXRpb25SZWxvYWRPcGVyYXRpb24oXG4gICAgICB0aGlzLmRldmljZVxuICAgICk7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMucmVwb3NpdG9yeVNlcnZpY2VcbiAgICAgICAgLmNyZWF0ZU9ic2VydmVkT3BlcmF0aW9uKG9wZXJhdGlvbkNmZylcbiAgICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgICBvcGVyYXRpb25VcGRhdGUgPT4gdGhpcy5vbk9wZXJhdGlvblJlbG9hZFN1Y2Nlc3Mob3BlcmF0aW9uVXBkYXRlKSxcbiAgICAgICAgICBvcGVyYXRpb25VcGRhdGUgPT4gdGhpcy5vbk9wZXJhdGlvblJlbG9hZEVycm9yKG9wZXJhdGlvblVwZGF0ZSksXG4gICAgICAgICAgKCkgPT4gdGhpcy5vbk9wZXJhdGlvblJlbG9hZENvbXBsZXRlKClcbiAgICAgICAgKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgdXBkYXRlQ29uZmlndXJhdGlvbihjb25maWcpIHtcbiAgICB0aGlzLnNhdmluZ0NvbmZpZyA9IHRydWU7XG4gICAgY29uc3Qgb3BlcmF0aW9uQ2ZnID0gYXdhaXQgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5jcmVhdGVUZXh0QmFzZWRDb25maWd1cmF0aW9uVXBkYXRlT3BlcmF0aW9uKFxuICAgICAgdGhpcy5kZXZpY2UsXG4gICAgICBjb25maWdcbiAgICApO1xuICAgIHRyeSB7XG4gICAgICB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlXG4gICAgICAgIC5jcmVhdGVPYnNlcnZlZE9wZXJhdGlvbihvcGVyYXRpb25DZmcpXG4gICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgb3BlcmF0aW9uVXBkYXRlID0+IHRoaXMub25PcGVyYXRpb25VcGRhdGVTdWNjZXNzKG9wZXJhdGlvblVwZGF0ZSksXG4gICAgICAgICAgb3BlcmF0aW9uVXBkYXRlID0+IHRoaXMub25PcGVyYXRpb25VcGRhdGVFcnJvcihvcGVyYXRpb25VcGRhdGUpLFxuICAgICAgICAgICgpID0+IHRoaXMub25PcGVyYXRpb25VcGRhdGVDb21wbGV0ZSgpXG4gICAgICAgICk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoZXgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25PcGVyYXRpb25SZWxvYWRTdWNjZXNzKG9wZXJhdGlvblVwZGF0ZSkge1xuICAgIHRoaXMubGF0ZXN0T3BlcmF0aW9uID0gb3BlcmF0aW9uVXBkYXRlO1xuICAgIGlmIChvcGVyYXRpb25VcGRhdGUuc3RhdHVzID09PSBPcGVyYXRpb25TdGF0dXMuUEVORElORykge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2Uuc3VjY2VzcyhnZXR0ZXh0KCdDb25maWd1cmF0aW9uIHdpbGwgYmUgcmVsb2FkZWQuJykpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25PcGVyYXRpb25SZWxvYWRFcnJvcihvcGVyYXRpb25VcGRhdGUpIHtcbiAgICB0aGlzLmxhdGVzdE9wZXJhdGlvbiA9IG9wZXJhdGlvblVwZGF0ZTtcbiAgICB0aGlzLnJlbG9hZGluZ0NvbmZpZyA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBvbk9wZXJhdGlvblJlbG9hZENvbXBsZXRlKCkge1xuICAgIGF3YWl0IHRoaXMubG9hZERldmljZSgpO1xuICAgIHRoaXMuY29uZmlnID0gdGhpcy5kZXZpY2UuYzh5X0NvbmZpZ3VyYXRpb24uY29uZmlnO1xuICAgIHRoaXMucmVsb2FkaW5nQ29uZmlnID0gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIG9uT3BlcmF0aW9uVXBkYXRlU3VjY2VzcyhvcGVyYXRpb25VcGRhdGUpIHtcbiAgICB0aGlzLmxhdGVzdE9wZXJhdGlvbiA9IG9wZXJhdGlvblVwZGF0ZTtcbiAgICBpZiAob3BlcmF0aW9uVXBkYXRlLnN0YXR1cyA9PT0gT3BlcmF0aW9uU3RhdHVzLlBFTkRJTkcpIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnN1Y2Nlc3MoZ2V0dGV4dCgnQ29uZmlndXJhdGlvbiB3aWxsIGJlIHVwZGF0ZWQuJykpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25PcGVyYXRpb25VcGRhdGVFcnJvcihvcGVyYXRpb25VcGRhdGUpIHtcbiAgICB0aGlzLmxhdGVzdE9wZXJhdGlvbiA9IG9wZXJhdGlvblVwZGF0ZTtcbiAgICB0aGlzLnNhdmluZ0NvbmZpZyA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBvbk9wZXJhdGlvblVwZGF0ZUNvbXBsZXRlKCkge1xuICAgIHRoaXMuZGV2aWNlLmM4eV9Db25maWd1cmF0aW9uLmNvbmZpZyA9IHRoaXMuY29uZmlnO1xuICAgIHRoaXMuc2F2aW5nQ29uZmlnID0gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGxvYWREZXZpY2UoKSB7XG4gICAgdGhpcy5kZXZpY2UgPSAoYXdhaXQgdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmRldGFpbCh0aGlzLmRldmljZS5pZCwgeyB3aXRoQ2hpbGRyZW46IGZhbHNlIH0pKS5kYXRhO1xuICB9XG59XG4iXX0=