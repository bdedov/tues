import * as tslib_1 from "tslib";
import { Component, Input } from '@angular/core';
import { RepositoryService } from './../repository.service';
import { memoize } from '@c8y/ngx-components';
import { saveAs } from 'file-saver';
import { InventoryBinaryService } from '@c8y/client';
import { LinkRenderType } from './link-render-type.enum';
var FileDownloadComponent = /** @class */ (function () {
    function FileDownloadComponent(repositoryService, inventoryBinaryService) {
        this.repositoryService = repositoryService;
        this.inventoryBinaryService = inventoryBinaryService;
        this.linkRenderType = LinkRenderType;
    }
    FileDownloadComponent.prototype.getBinaryName$ = function (binaryUrl) {
        return this.repositoryService.getBinaryName$(binaryUrl);
    };
    FileDownloadComponent.prototype.determineBehavior = function () {
        var result;
        if (this.inventoryBinaryService.getIdFromUrl(this.url)) {
            result = LinkRenderType.DOWNLOAD;
        }
        else if (this.url.match(/\/\//g)) {
            result = LinkRenderType.LINK;
        }
        else {
            result = LinkRenderType.TEXTONLY;
        }
        return result;
    };
    FileDownloadComponent.prototype.downloadFile = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var binary;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.repositoryService.getBinaryFile(this.url, {
                            allowExternal: false
                        })];
                    case 1:
                        binary = _a.sent();
                        saveAs(binary);
                        return [2 /*return*/];
                }
            });
        });
    };
    FileDownloadComponent.ctorParameters = function () { return [
        { type: RepositoryService },
        { type: InventoryBinaryService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], FileDownloadComponent.prototype, "url", void 0);
    tslib_1.__decorate([
        memoize()
    ], FileDownloadComponent.prototype, "getBinaryName$", null);
    tslib_1.__decorate([
        memoize()
    ], FileDownloadComponent.prototype, "determineBehavior", null);
    FileDownloadComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-file-download',
            template: "<a\n  *ngIf=\"determineBehavior() === linkRenderType.LINK\"\n  href=\"{{ url }}\"\n  class=\"pointer\"\n  target=\"_blank\"\n  rel=\"noopener noreferrer\"\n>\n  {{ getBinaryName$(url) | async }}\n</a>\n\n<span *ngIf=\"determineBehavior() === linkRenderType.TEXTONLY\">{{ getBinaryName$(url) | async }}</span>\n\n<a *ngIf=\"determineBehavior() === linkRenderType.DOWNLOAD\" class=\"pointer\" (click)=\"downloadFile()\">\n    {{getBinaryName$(url) | async}}\n</a>\n"
        })
    ], FileDownloadComponent);
    return FileDownloadComponent;
}());
export { FileDownloadComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS1kb3dubG9hZC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL3JlcG9zaXRvcnkvIiwic291cmNlcyI6WyJmaWxlLWRvd25sb2FkL2ZpbGUtZG93bmxvYWQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNqRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM1RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDOUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFlBQVksQ0FBQztBQUNwQyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDckQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBTXpEO0lBR0UsK0JBQ1UsaUJBQW9DLEVBQ3BDLHNCQUE4QztRQUQ5QyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUFIeEQsbUJBQWMsR0FBRyxjQUFjLENBQUM7SUFJN0IsQ0FBQztJQUdKLDhDQUFjLEdBQWQsVUFBZSxTQUFTO1FBQ3RCLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUMxRCxDQUFDO0lBR0QsaURBQWlCLEdBQWpCO1FBQ0UsSUFBSSxNQUFzQixDQUFDO1FBQzNCLElBQUksSUFBSSxDQUFDLHNCQUFzQixDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDdEQsTUFBTSxHQUFHLGNBQWMsQ0FBQyxRQUFRLENBQUM7U0FDbEM7YUFBTSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ2xDLE1BQU0sR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDO1NBQzlCO2FBQU07WUFDTCxNQUFNLEdBQUcsY0FBYyxDQUFDLFFBQVEsQ0FBQztTQUNsQztRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFSyw0Q0FBWSxHQUFsQjs7Ozs7NEJBQ3VCLHFCQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTs0QkFDeEUsYUFBYSxFQUFFLEtBQUs7eUJBQ3JCLENBQUMsRUFBQTs7d0JBRkksTUFBTSxHQUFTLFNBRW5CO3dCQUNGLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQzs7Ozs7S0FDaEI7O2dCQTNCNEIsaUJBQWlCO2dCQUNaLHNCQUFzQjs7SUFKL0M7UUFBUixLQUFLLEVBQUU7c0RBQWE7SUFRckI7UUFEQyxPQUFPLEVBQUU7K0RBR1Q7SUFHRDtRQURDLE9BQU8sRUFBRTtrRUFXVDtJQXhCVSxxQkFBcUI7UUFKakMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLG1CQUFtQjtZQUM3QiwyZEFBNkM7U0FDOUMsQ0FBQztPQUNXLHFCQUFxQixDQWdDakM7SUFBRCw0QkFBQztDQUFBLEFBaENELElBZ0NDO1NBaENZLHFCQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJlcG9zaXRvcnlTZXJ2aWNlIH0gZnJvbSAnLi8uLi9yZXBvc2l0b3J5LnNlcnZpY2UnO1xuaW1wb3J0IHsgbWVtb2l6ZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgc2F2ZUFzIH0gZnJvbSAnZmlsZS1zYXZlcic7XG5pbXBvcnQgeyBJbnZlbnRvcnlCaW5hcnlTZXJ2aWNlIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgTGlua1JlbmRlclR5cGUgfSBmcm9tICcuL2xpbmstcmVuZGVyLXR5cGUuZW51bSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1maWxlLWRvd25sb2FkJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2ZpbGUtZG93bmxvYWQuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIEZpbGVEb3dubG9hZENvbXBvbmVudCB7XG4gIEBJbnB1dCgpIHVybDogc3RyaW5nO1xuICBsaW5rUmVuZGVyVHlwZSA9IExpbmtSZW5kZXJUeXBlO1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlcG9zaXRvcnlTZXJ2aWNlOiBSZXBvc2l0b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeUJpbmFyeVNlcnZpY2U6IEludmVudG9yeUJpbmFyeVNlcnZpY2VcbiAgKSB7fVxuXG4gIEBtZW1vaXplKClcbiAgZ2V0QmluYXJ5TmFtZSQoYmluYXJ5VXJsKSB7XG4gICAgcmV0dXJuIHRoaXMucmVwb3NpdG9yeVNlcnZpY2UuZ2V0QmluYXJ5TmFtZSQoYmluYXJ5VXJsKTtcbiAgfVxuXG4gIEBtZW1vaXplKClcbiAgZGV0ZXJtaW5lQmVoYXZpb3IoKTogTGlua1JlbmRlclR5cGUge1xuICAgIGxldCByZXN1bHQ6IExpbmtSZW5kZXJUeXBlO1xuICAgIGlmICh0aGlzLmludmVudG9yeUJpbmFyeVNlcnZpY2UuZ2V0SWRGcm9tVXJsKHRoaXMudXJsKSkge1xuICAgICAgcmVzdWx0ID0gTGlua1JlbmRlclR5cGUuRE9XTkxPQUQ7XG4gICAgfSBlbHNlIGlmICh0aGlzLnVybC5tYXRjaCgvXFwvXFwvL2cpKSB7XG4gICAgICByZXN1bHQgPSBMaW5rUmVuZGVyVHlwZS5MSU5LO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQgPSBMaW5rUmVuZGVyVHlwZS5URVhUT05MWTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGFzeW5jIGRvd25sb2FkRmlsZSgpIHtcbiAgICBjb25zdCBiaW5hcnk6IEZpbGUgPSBhd2FpdCB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmdldEJpbmFyeUZpbGUodGhpcy51cmwsIHtcbiAgICAgIGFsbG93RXh0ZXJuYWw6IGZhbHNlXG4gICAgfSk7XG4gICAgc2F2ZUFzKGJpbmFyeSk7XG4gIH1cbn1cbiJdfQ==