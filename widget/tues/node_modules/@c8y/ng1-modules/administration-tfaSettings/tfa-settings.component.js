"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(){function e(r,e,a,o,t,i,u,l,s,c){var y=this,n="two-factor-authentication",f=c("TOTP requires OAuth Internal login mode."),d=c("Messaging application is not subscribed."),p=c("The setting is enforced on the platform level."),g=[{systemOption:!0,key:"tenant-scope-settings.enabled",default:!1,readOnly:!0},{key:"enabled",default:!1,loader:T},{key:"token.validity",default:43200,readOnlyIfTenantScopeSettingsDisabled:!0},{key:"pin.validity",default:30,readOnlyIfTenantScopeSettingsDisabled:!0},{key:"enforced",default:!1,loader:T}],b=[{key:"enforcedOnSystemLevel",default:!1,readOnly:!0},{key:"totpEnforcedOnTenantLevel",default:!1,readOnly:!0},{key:"enforcedUsersGroup",default:!1,readOnly:!0},{key:"strategy",default:"SMS"}];function m(t){var e=v(t),n=t.default;return(t.systemOption?o.getSystemOptionValue(e,n):"function"==typeof t.loader?t.loader():o.detailValue(e,n)).then(function(e){return S(t,e)}).catch(function(){return S(t,t.default)})}function v(e){return{category:n,key:e.key}}function S(e,t){y[h(e.key)]=t,y.previousSettings[h(e.key)]=_.cloneDeep(t)}function h(e){return _.camelCase(e)}function A(e){var t={category:n,key:e.key,value:O(e)};return function(e){var t="enabled"===e.key||k(),n=y.previousSettings[h(e.key)]!==O(e),r=e.readOnly,a=e.readOnlyIfTenantScopeSettingsDisabled&&!y.tenantScopeSettingsEnabled;return n&&t&&!e.systemOption&&!(r||a)}(e)?o.updateOption(t).then(function(){return S(e,t.value)}):r.when()}function O(e){return function(e){return _.isNumber(e)||!_.isNaN(_.toNumber(e))&&_.isString(e)?_.toNumber(e):e}(y[h(e.key)])}function T(){var t=this,n=v(this);return o.getSystemOptionValue(n,this.default).then(function(e){return!0===e?t.readOnly=!0:o.detailValue(n,t.default)})}function k(){return y.enabled||y.enforcedOnSystemLevel||y.enforcedUsersGroup}_.assign(y,{$onInit:function(){b.forEach(function(e){_.assign(y,_defineProperty({},e.key,e.default))}),r.all([r.all([].concat(_toConsumableArray(_.map(g,m)),[void e.isAvailable({contextPath:"messaging"}).then(function(e){y.smsAppAvailable=e})])),i.current().then(function(e){return u.getTfaSettings(e)}).then(function(t){return b.forEach(function(e){t[e.key]&&S(e,t[e.key])})})]).finally(function(){y.initialized=!0})},saveSettings:function(t){y.enabled&&"TOTP"===y.strategy||(y.enforced=!1);var n=y.previousSettings.strategy!==y.strategy&&k(),e=function(){var e=[].concat(_toConsumableArray(_.map(g,A)),[n?i.current().then(function(e){return u.updateTfaSettings(e,y.strategy)}):r.resolve()]);return r.all(e).then(function(){l.success(c("TFA settings saved.")),t&&t.$setPristine()})};return(n?s.requireLogout(e):e()).catch(function(e){"canceled"!==e&&l.danger(a.getResErrorMessage(e))})},limitValidityRegex:/^[0-9]\d*$/,initialized:!1,totpPopover:f,smsWarningPopover:d,enforcedOnSystemLevelPopover:p,oAuthLoginMode:function(){return y.loginMode===t.loginOptions.OAUTH2_INTERNAL.value.toUpperCase()},isReadOnly:function(r){return g.some(function(e){var t=e.key,n=e.readOnly;return t===r&&n})},isTFAEnabled:k,previousSettings:{}})}e.$inject=["$q","c8yApplication","c8yBase","c8ySettings","c8yLoginOptions","c8yTenant","c8yTfaSettings","c8yAlert","c8yUserUtil","gettext"],angular.module("c8y.parts.tfaSettings").component("c8yTfaSettings",{controller:e,controllerAs:"vm",templateUrl:":::PLUGIN_PATH:::/tfa-settings.html",bindings:{loginMode:"<"}})}();