"use strict";!function(){function e(s,e,r,t,u,i,o,n,c,a,f){var l,d,h=e.userId,p=["business"];function A(){h?u.detail(h).then(function(e){return e.data}).then(N):(N({enabled:s.isNew=!0}),M(f("New user")))}function N(e){l=e.email,e.devicePermissions=e.devicePermissions||{},s.user=e,s._groups={},s.password.showPassword=s.isNew,(e.groups&&e.groups.references||[]).forEach(function(e){var n=e.group.id;s._groups[n]=!0}),s.isNew&&_.forEach(s.groups,function(e){_.includes(p,e.name)&&(s._groups[e.id]=!0)}),u.checkIfCurrent(s.user).then(function(e){e&&c.listByUser(s.user).then(function(e){s.user.applications=e}),s.showUserApps=!(u.hasRole(s.user,"ROLE_APPLICATION_MANAGEMENT_READ")||u.hasRole(s.user,"ROLE_APPLICATION_MANAGEMENT_ADMIN"))})}function E(e){s.groups=e}function g(e){s.currentUser=e}function w(e){e?R(s.user):A()}function R(e){s.saving=!0;var n=!e.id||e.groups?_.keys(s._groups).filter(function(e){return s._groups[e]}).map(function(e){return parseInt(e,10)}):null;try{u.save(e).then(t.getResData).then(function(e){return e.id=e.userName,h=e.id,e}).then(function(e){return n?i.updateGroups(e,n):e}).then(angular.bind({},A)).then(_.partial(o.success,f("User saved."))).then(function(){r.history.back()}).finally(function(){s.saving=!1})}catch(e){o.danger(e.message),s.saving=!1}}function M(e){e&&n.changeTitle({title:e})}s.checkPassword=function(e){s.isNew||!s.password.showPassword&&!function(e){return e.email!==l}(e)?R(s.user):a.askForPassword().then(w)},s.$watch("user.userName",M),s.canEditUser=function(e,n){return!(!e||!n)&&(!n.id||(e.id===n.id?u.hasRole(e,"ROLE_USER_MANAGEMENT_OWN_ADMIN"):u.hasRole(e,"ROLE_USER_MANAGEMENT_ADMIN")))},s.canEditUserGroups=function(e){return u.hasRole(e,"ROLE_USER_MANAGEMENT_ADMIN")},s.canActivateUser=function(e,n){return!(!e||!n)&&e.id!==n.id},s.forms={},s.password={},s.saving=!1,s.showAcl=function(){return!0},i.list(d).then(E).then(A),u.current().then(g)}e.$inject=["$scope","$routeParams","$window","c8yBase","c8yUser","c8yUserGroup","c8yAlert","c8yTitle","c8yApplication","c8yUserUtil","gettext"],angular.module("c8y.parts.users").controller("userDetailCtrl",e)}();