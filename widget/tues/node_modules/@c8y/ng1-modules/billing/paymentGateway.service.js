"use strict";!function(){function e(i,t,n,e,r,a,c){var o,u=e.createEnum([{name:"CREDIT_CARD",label:a("Credit card"),icon:"credit-card",paymentBearerSent:"CreditCard:",paymentBearerReceived:"CreditCard"},{name:"INVOICE",label:a("Invoice"),icon:"money",paymentBearerSent:"InvoicePayment",paymentBearerReceived:"InvoicePayment"},{name:"DIRECT_DEBIT",label:a("Direct debit"),icon:"keyboard-o",paymentBearerSent:"Debit:",paymentBearerReceived:"BankAccount"}]);return t.getEnvironmentUrl().then(function(e){o=e}),{PAYMENT_METHODS:u,changePaymentMethod:function(r){return i.all({customerPortal:l(),paymentService:d({providerReturnUrl:"".concat(m(),"?billing-finalize-payment-method-change=true")})}).then(function(t){return i(function(e,n){try{t.customerPortal.paymentChange(t.paymentService,r,e,n)}catch(e){n(e.message)}}).then(function(e){var n=i.resolve(e);return _.get(e,"Url")&&(window.location.href=e.Url,n=i.reject()),n}).catch(y)})},createNewPlanOrder:function(r,a,c){return i(function(n,t){try{var e=new BillwerkJS.Signup;e.createOrder(r,a,function(e){f(c,e).then(function(){n()})},function(e){t(e)})}catch(e){t(e.message)}})},upgradeToStandardPlan:function(e,n){return s(e).then(t.getProductsInfo).then(function(e){var n=_.find(e.PlanVariants,{ExternalId:"standard-tenant"});return{Cart:{PlanVariantId:n.Id}}}).then(t.placeOrder).then(function(e){return _.set(e,"OrderId",e.Id),f(n,e)}).then(function(e){var n=i.resolve(e);return _.get(e,"Url")&&(window.location.href=e.Url,n=i.reject()),n}).catch(function(e){y(e)})},finalizeInteractivePayment:function(){return i(function(e,n){try{BillwerkJS.finalize(e,n)}catch(e){y(e)}})},updateCustomerData:s,generateInvoiceDownloadLink:function(t){return l().then(function(e){var n="";try{n=e.invoicePdfDownloadUrl(t)}catch(e){y(e)}return n})},constructEnvironmentPaymentBearer:function(e){return"InvoicePayment"===e?e:e+n[o].paymentProvider},isInTrial:function(e){var n=e.CurrentPhase,t=_.last(e.Phases);return"Trial"===n.Type&&"Normal"!==t.Type}};function l(){return l.promise||(l.promise=t.getUserToken().then(function(e){var n;try{n=new BillwerkJS.Portal(e)}catch(e){y(e)}return n})),i.when(l.promise)}function m(){return"".concat(window.location.protocol,"//").concat(window.location.host).concat(window.location.pathname)}function d(e){var r=_.assign(e,_.pick(n[o],"publicApiKey"));return i(function(e,n){var t;try{t=new BillwerkJS.Payment(r,function(){e(t)},n)}catch(e){y(e)}})}function s(r){return l().then(function(t){return i(function(e,n){try{t.customerChange(r,e,n)}catch(e){n(e.message)}})})}function f(r,a){return i.all({customerPortal:l(),paymentService:d({providerReturnUrl:"".concat(m(),"?billing-finalize-upgrade=true")})}).then(function(t){return i(function(e,n){try{t.customerPortal.upgradePayInteractive(t.paymentService,r,a,e,n)}catch(e){n(e.message)}})})}function y(e){var n=e.message||e.errorMessage;r.danger(c.getString("Error occurred: {{message}}",{message:n}))}}e.$inject=["$q","customerBillingSvc","billingConstants","c8yBase","c8yAlert","gettext","gettextCatalog"],angular.module("c8y.customerBilling").factory("paymentGatewaySvc",e)}();