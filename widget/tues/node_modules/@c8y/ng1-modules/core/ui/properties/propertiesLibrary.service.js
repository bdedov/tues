"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(){function e(e,o,p,s,c,u,l,f,m){return new function r(e){var i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},t=i.tenantId,h=this,a="x-show-if-any-available";function n(e){var t=_.cloneDeep(e),r=s.when(t),i=_.find(h.ENTITIES.values(),{staticSchemaPath:h.propertiesCfg.static.path});return i&&(r=l.list().then(function(e){var t={appliesTo:{}};return t.appliesTo[i.value]=!0,_.filter(e,t)}).then(function(e){return _.map(e,function(e){return _.get(e,"c8y_JsonSchema")})}).then(function(e){return _.forEach(e,function(e){i===h.ENTITIES.TENANTS?_.merge(t.properties.customProperties.properties,e.properties):_.merge(t.properties,e.properties)}),t})),r}this.ENTITIES=c.createEnum([{name:"MANAGED_OBJECTS",value:"MANAGED_OBJECTS",staticSchemaPath:c.dataFilePath("properties/managed-objects.json")},{name:"MEASUREMENTS",value:"MEASUREMENTS",staticSchemaPath:c.dataFilePath("properties/measurements.json")},{name:"ALARMS",value:"ALARMS",staticSchemaPath:c.dataFilePath("properties/alarms.json")},{name:"EVENTS",value:"EVENTS",staticSchemaPath:c.dataFilePath("properties/events.json")},{name:"TENANTS",value:"TENANTS",staticSchemaPath:c.dataFilePath("properties/tenants.json")}]),this.properties={},this.propertiesCfg={static:{path:e}},this.list=function(){return h.loadProperties().then(_.bind(h.getSimplifiedProperties,h))},this.getProperties=function(){return h.loadProperties().then(_.bind(h.getFullProperties,h))},this.getTenantDetails=function(){return t?m.detail(t).then(c.getResData):m.current()},this.removeKeysDependingOnAppsAvailability=function(r){return function e(t){for(var r=Object.keys(t),i=!1,n=0;n<r.length;n++){var o=r[n];_typeof(t[o])===_typeof({})&&null!==t[o]&&(i=o===a||i||e(t[o]))}return i}(r)?h.getTenantDetails().then(function(e){var t=_.flatMap(e.applications.references,"application");return function t(r,i){var e=Object.keys(r);return _.forEach(e,function(e){void 0===r[e][a]||_.some(r[e][a],function(e){return u.isAppOnTheList(i,e)})?_typeof(r[e])===_typeof({})&&null!==r[e]&&e!==a&&t(r[e],i):delete r[e]}),r}(r,t)}):r},this.loadProperties=_.throttle(function(){return h.loadStaticPropertiesSchema().then(n).then(h.removeKeysDependingOnAppsAvailability).then(_.bind(h.getPropertiesFromSchema,h)).then(_.bind(h.addProperties,h))},1e3),this.loadStaticPropertiesSchema=function(){var e=h.propertiesCfg.static.path;return h.loadStaticPropertiesSchemaFromMemory()||o.get(e).then(c.getResData)},this.pathToKey=function(){var e=h.propertiesCfg.static.path;return _.last(e.split("/")).replace(/\.json$/,"")},this.loadStaticPropertiesSchemaFromMemory=function(){var e=h.pathToKey(),t=(window.c8y&&window.c8y.collections&&window.c8y.collections.properties||{})[e];return t&&s.when(t)},this.getPropertiesFromSchema=function(e,t,r){var a=3<arguments.length&&void 0!==arguments[3]?arguments[3]:["properties"],p=4<arguments.length&&void 0!==arguments[4]?arguments[4]:[],s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:[],c=t||e.id||"c8yDefaultSchema",i=_.cloneDeep(r||{type:"object",properties:{}}),u=h.setObjValue(i,a,{});return _.has(e,"properties")&&_.forEach(e.properties,function(e,t){var r=_.cloneDeep(u),i=_.flattenDeep([a,t,"properties"]),n=_.flattenDeep([p,t]);r=h.setObjValue(r,a,_.cloneDeep(e),t);var o=h.getNewPropertyObj(c,n,r,e);s.push(o),h.getPropertiesFromSchema(e,c,r,i,n,s)}),s},this.getNewPropertyObj=function(e,t,r,i){var n=t.join("."),o={id:"".concat(e,"!!").concat(n),keyPath:t,type:i.type,printFormat:i.printFormat,label:h.getDefaultPropertyLabel(t,i),schema:r};return i.config&&(o.configSchema=i.config),i.computed&&(o.computed=i.computed),o},this.getFragmentName=function(e){var t=e[e.length-1],r=/_\d{9,}$/;return r.test(t)&&(t=t.replace(r,"")),t},this.getDefaultPropertyLabel=function(e,t){var r=f.getString(t.title);return r||(r=(r=(r=h.getFragmentName(e)).replace(/^c8y_/i,"").replace(/([A-Z][a-z])/g," $1").replace(/([^0-9])([0-9])/g,"$1 $2").replace("_"," ").replace(/^\s*/,"").replace(/\s*$/,"")).charAt(0).toUpperCase()+r.slice(1)),r},this.setObjValue=function(e,t,r,i){var n,o=e,a=o;for(n=0;n<t.length-1;n++)a[t[n]]||(a[t[n]]={}),a=a[t[n]];return i?a[t[n]][i]=r:a[t[n]]=r,o},this.addProperties=function(e){_.forEach(e,function(e){h.properties[e.id]=e})},this.getSimplifiedProperties=function(){return _.map(h.properties,_.bind(h.simplifyProperty,h))},this.simplifyProperty=function(e){return _.pick(e,["id","keyPath","type","label","configSchema","computed","printFormat"])},this.getFullProperties=function(){return _.cloneDeep(h.properties)},this.getSchema=function(e){return h.loadProperties().then(_.bind(h.getSchemaForProperties,h,e)).catch(p.error)},this.getSchemaForProperties=function(n){var o={type:"object",properties:{}};return _.forEach(n,function(e){h.properties[e.id]||h.addCustomProperty(e),_.merge(o.properties,h.properties[e.id].schema.properties);var t=h.findInSchemaByFragment(o,h.getFragmentName(e.keyPath)).shift();t&&h.isComplexProperty(e)&&0<h.getChildren(e,n).length&&(t.properties={}),_.forEach(_.get(t,"properties"),function(e){_.set(e,"title",f.getString(e.title))}),t.title=e.label||h.properties[e.id].label,t.id=e.id;var r=_.last(e.id.split("!!")),i=_.last(e.keyPath);e.computed&&e.configSchema&&r!==i&&(o.properties[i]=o.properties[r],delete o.properties[r])}),o},this.findInSchemaByFragment=function(e,r){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];return _.isObjectLike(e)&&_.forOwn(e,function(e,t){_.isObjectLike(e)&&t===r?i.push(e):h.findInSchemaByFragment(e,r,i)}),i},this.findInSchemaById=function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];return _.isObjectLike(e)&&_.forOwn(e,function(e){_.isObjectLike(e)&&e.id===t?r.push(e):h.findInSchemaById(e,t,r)}),r},this.findInSchemaByKeyPath=function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],i=_.first(t);return _.isObjectLike(e)&&_.forOwn(e,function(e){_.isObject(e)&&_.has(e,i)?r.push(e[i]):h.findInSchemaByKeyPath(e,t,r)}),r},this.getForm=function(e,t){return h.loadProperties().then(_.bind(h.getFormForProperties,h,e,t))},this.getFormForProperties=function(e,t){var r=[],i=h.getSchemaForProperties(e);return _.forEach(h.removeDuplication(e),function(e){r.push(function(e,t,r){var i=e.computed?h.findInSchemaByKeyPath(r,e.keyPath).shift():h.findInSchemaById(r,e.id).shift(),n={key:ObjectPath.stringify(h.properties[e.id].keyPath),title:i.title||e.label||h.properties[e.id].label};return n=function(e,t,r){var i=e;return _.find(_.values(r.properties),{format:"datetime"})&&(i=_(r.properties).mapValues(function(e,t){return e._key=t,e}).sortBy("title").map(function(e){return{key:_.concat(t.keyPath,e._key)}}).value()),i}(n=function(e,t){return t.computed&&t.configSchema&&(e.key=_.last(t.keyPath)),e}(n,e),e,i),_.assign(n,t),n}(e,t,i))}),_.flatten(r)},this.isComplexProperty=function(e){return"object"===e.type},this.isCustomProperty=function(e){return"c8yCustom"===e.id.split("!!")[0]},this.getChildren=function(t,e){return _.filter(e||h.properties,function(e){return t.id!==e.id&&_.isEqual(_.take(e.keyPath,t.keyPath.length),t.keyPath)})},this.changeActiveProperty=function(e,t){return _.map(e,function(e){return _.assign(e,{__active:t})})},this.removeDuplication=function(e){var t,r=e;return _.map(e,function(e){h.isComplexProperty(e)&&(t=_.map(h.getChildren(e),"id"),r=_.reject(r,function(e){return _.includes(t,e.id)}))}),r},this.getParent=function(t){return _.filter(h.properties,function(e){return t.keyPath.length>e.keyPath.length&&_.isEqual(_.take(t.keyPath,e.keyPath.length),e.keyPath)})},this.addCustomProperty=function(e){h.properties[e.id]||(h.properties[e.id]={},_.merge(h.properties[e.id],e))},this.another=function(e,t){return new r(e,void 0===t?i:t)},this.paths=_.reduce(this.ENTITIES.values(),function(e,t){return e[_.startCase(_.camelCase(t.value)).replace(" ","")]=t.staticSchemaPath,e},{})}(c.dataFilePath("properties/managed-objects.json"))}e.$inject=["$filter","$http","$log","$q","c8yBase","c8yApplication","c8yJsonSchemas","gettextCatalog","c8yTenant"],angular.module("c8y.ui").provider("c8yPropertiesLibrary",function(){return{$get:e}})}();