import { Subject, defer, of } from 'rxjs';
import { merge } from 'rxjs/operators';
import { pick, map, property, some, every } from 'lodash-es';
import { NavigatorNodeRootLegacy } from './navigator-node-root-legacy';
// Just to hook into the bridge service
export function c8yNavigatorProvider() {
    const root = new NavigatorNodeRootLegacy();
    const rootNodesSubject = new Subject();
    const conditionalNodes = [];
    const rootNodes$ = rootNodesSubject.pipe(merge(defer(() => of(root.children))));
    function addNavigation(nodes) {
        const nodeList = (Array.isArray(nodes) ? nodes : [nodes]);
        nodeList.forEach((node) => {
            if (isConditional(node)) {
                node.hidden = undefined;
                conditionalNodes.push(node);
            }
            node.navNode = root.addRoot(node);
        });
        rootNodesSubject.next(root.children);
    }
    function removeNavigation(node) {
        const found = root.find((n) => n === node);
        if (found) {
            found.parents.forEach((p) => p.remove(found));
            rootNodesSubject.next(root.children);
        }
    }
    function findNode(node) {
        return root.find(node);
    }
    function isConditional(node) {
        return node.showIf || node.showIfPermissions || node.showIfContainsVisibleViews;
    }
    function $get($q, $injector) {
        'ngInject';
        // This avoids the circular dependency
        setTimeout(() => conditionalNodes.forEach(processShowIf));
        function processShowIf(node) {
            const c8yUiUtil = $injector.get('c8yUiUtil');
            const visibilityPromises = [];
            const { showIf, showIfPermissions, showIfContainsVisibleViews } = node;
            if (showIf) {
                visibilityPromises.push($injector.invoke(showIf));
            }
            if (showIfContainsVisibleViews) {
                visibilityPromises.push(viewsConditionalVisibility(node));
            }
            c8yUiUtil.configureVisibility({
                showIf: () => $q.all(visibilityPromises).then(every),
                showIfPermissions
            }, 'visible')
                .then(({ visible }) => {
                if (visible) {
                    node.navNode.update({
                        hidden: false,
                        showIf: null,
                        showIfPermission: null,
                        showIfContainsVisibleViews: null
                    });
                }
                else {
                    node.navNode.update({
                        hidden: true
                    });
                }
            });
        }
        function viewsConditionalVisibility(node) {
            const c8yUiUtil = $injector.get('c8yUiUtil');
            const c8yViews = $injector.get('c8yViews');
            const views = c8yViews.getByPath(node.path);
            return $q.all(map(views, (view) => c8yUiUtil
                .configureVisibility(pick(view, ['showIf', 'showIfPermissions']), 'show', false)
                .then(property('show'))))
                .then(some);
        }
        return {
            rootNodes() {
                return root.children;
            },
            findNode,
            addNavigation,
            removeNavigation,
            rootNodes$
        };
    }
    return {
        $get,
        addNavigation,
        removeNavigation
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdG9yLnByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy91cGdyYWRlLyIsInNvdXJjZXMiOlsibmcxL25hdmlnYXRvci5wcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQWMsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxJQUFJLEVBQUcsR0FBRyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzlELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRXZFLHVDQUF1QztBQUN2QyxNQUFNLFVBQVUsb0JBQW9CO0lBQ2xDLE1BQU0sSUFBSSxHQUFHLElBQUksdUJBQXVCLEVBQUUsQ0FBQztJQUMzQyxNQUFNLGdCQUFnQixHQUE2QixJQUFJLE9BQU8sRUFBRSxDQUFDO0lBQ2pFLE1BQU0sZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO0lBQzVCLE1BQU0sVUFBVSxHQUFnQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQ25FLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQ3RDLENBQUM7SUFFRixTQUFTLGFBQWEsQ0FBQyxLQUFLO1FBQzFCLE1BQU0sUUFBUSxHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDMUQsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ3hCLElBQUksYUFBYSxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUN2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LE1BQU0sUUFBUSxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDM0MsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDNUMsT0FBTyxFQUFFLENBQUMsR0FBRyxDQUNYLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLFNBQVM7aUJBQzNCLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUUsbUJBQW1CLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxLQUFLLENBQUM7aUJBQy9FLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FDeEIsQ0FDRjtpQkFDQSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDZCxDQUFDO1FBRUQsT0FBTztZQUNMLFNBQVM7Z0JBQ1AsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO1lBQ3ZCLENBQUM7WUFDRCxRQUFRO1lBQ1IsYUFBYTtZQUNiLGdCQUFnQjtZQUNoQixVQUFVO1NBQ1gsQ0FBQztJQUNKLENBQUM7SUFFRCxPQUFPO1FBQ0wsSUFBSTtRQUNKLGFBQWE7UUFDYixnQkFBZ0I7S0FDakIsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOYXZpZ2F0b3JOb2RlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCBkZWZlciwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1lcmdlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgcGljaywgIG1hcCwgcHJvcGVydHksIHNvbWUsIGV2ZXJ5IH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IE5hdmlnYXRvck5vZGVSb290TGVnYWN5IH0gZnJvbSAnLi9uYXZpZ2F0b3Itbm9kZS1yb290LWxlZ2FjeSc7XG5cbi8vIEp1c3QgdG8gaG9vayBpbnRvIHRoZSBicmlkZ2Ugc2VydmljZVxuZXhwb3J0IGZ1bmN0aW9uIGM4eU5hdmlnYXRvclByb3ZpZGVyKCkge1xuICBjb25zdCByb290ID0gbmV3IE5hdmlnYXRvck5vZGVSb290TGVnYWN5KCk7XG4gIGNvbnN0IHJvb3ROb2Rlc1N1YmplY3Q6IFN1YmplY3Q8TmF2aWdhdG9yTm9kZVtdPiA9IG5ldyBTdWJqZWN0KCk7XG4gIGNvbnN0IGNvbmRpdGlvbmFsTm9kZXMgPSBbXTtcbiAgY29uc3Qgcm9vdE5vZGVzJDogT2JzZXJ2YWJsZTxOYXZpZ2F0b3JOb2RlW10+ID0gcm9vdE5vZGVzU3ViamVjdC5waXBlKFxuICAgIG1lcmdlKGRlZmVyKCgpID0+IG9mKHJvb3QuY2hpbGRyZW4pKSksXG4gICk7XG5cbiAgZnVuY3Rpb24gYWRkTmF2aWdhdGlvbihub2Rlcykge1xuICAgIGNvbnN0IG5vZGVMaXN0ID0gKEFycmF5LmlzQXJyYXkobm9kZXMpID8gbm9kZXMgOiBbbm9kZXNdKTtcbiAgICBub2RlTGlzdC5mb3JFYWNoKChub2RlKSA9PiB7XG4gICAgICBpZiAoaXNDb25kaXRpb25hbChub2RlKSkge1xuICAgICAgICBub2RlLmhpZGRlbiA9IHVuZGVmaW5lZDtcbiAgICAgICAgY29uZGl0aW9uYWxOb2Rlcy5wdXNoKG5vZGUpO1xuICAgICAgfVxuICAgICAgbm9kZS5uYXZOb2RlID0gcm9vdC5hZGRSb290KG5vZGUpO1xuICAgIH0pO1xuICAgIHJvb3ROb2Rlc1N1YmplY3QubmV4dChyb290LmNoaWxkcmVuKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHJlbW92ZU5hdmlnYXRpb24obm9kZSkge1xuICAgIGNvbnN0IGZvdW5kID0gcm9vdC5maW5kKChuKSA9PiBuID09PSBub2RlKTtcbiAgICBpZiAoZm91bmQpIHtcbiAgICAgIGZvdW5kLnBhcmVudHMuZm9yRWFjaCgocCkgPT4gcC5yZW1vdmUoZm91bmQpKTtcbiAgICAgIHJvb3ROb2Rlc1N1YmplY3QubmV4dChyb290LmNoaWxkcmVuKTtcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBmaW5kTm9kZShub2RlKSB7XG4gICAgcmV0dXJuIHJvb3QuZmluZChub2RlKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGlzQ29uZGl0aW9uYWwobm9kZSkge1xuICAgIHJldHVybiBub2RlLnNob3dJZiB8fCBub2RlLnNob3dJZlBlcm1pc3Npb25zIHx8IG5vZGUuc2hvd0lmQ29udGFpbnNWaXNpYmxlVmlld3M7XG4gIH1cblxuICBmdW5jdGlvbiAkZ2V0KCRxLCAkaW5qZWN0b3IpIHtcbiAgICAnbmdJbmplY3QnO1xuXG4gICAgLy8gVGhpcyBhdm9pZHMgdGhlIGNpcmN1bGFyIGRlcGVuZGVuY3lcbiAgICBzZXRUaW1lb3V0KCgpID0+IGNvbmRpdGlvbmFsTm9kZXMuZm9yRWFjaChwcm9jZXNzU2hvd0lmKSk7XG5cbiAgICBmdW5jdGlvbiBwcm9jZXNzU2hvd0lmKG5vZGUpIHtcbiAgICAgIGNvbnN0IGM4eVVpVXRpbCA9ICRpbmplY3Rvci5nZXQoJ2M4eVVpVXRpbCcpO1xuICAgICAgY29uc3QgdmlzaWJpbGl0eVByb21pc2VzID0gW107XG4gICAgICBjb25zdCB7XG4gICAgICAgIHNob3dJZixcbiAgICAgICAgc2hvd0lmUGVybWlzc2lvbnMsXG4gICAgICAgIHNob3dJZkNvbnRhaW5zVmlzaWJsZVZpZXdzXG4gICAgICB9ID0gbm9kZTtcblxuICAgICAgaWYgKHNob3dJZikge1xuICAgICAgICB2aXNpYmlsaXR5UHJvbWlzZXMucHVzaCgkaW5qZWN0b3IuaW52b2tlKHNob3dJZikpO1xuICAgICAgfVxuICAgICAgaWYgKHNob3dJZkNvbnRhaW5zVmlzaWJsZVZpZXdzKSB7XG4gICAgICAgIHZpc2liaWxpdHlQcm9taXNlcy5wdXNoKHZpZXdzQ29uZGl0aW9uYWxWaXNpYmlsaXR5KG5vZGUpKTtcbiAgICAgIH1cblxuICAgICAgYzh5VWlVdGlsLmNvbmZpZ3VyZVZpc2liaWxpdHkoe1xuICAgICAgICBzaG93SWY6ICgpID0+ICRxLmFsbCh2aXNpYmlsaXR5UHJvbWlzZXMpLnRoZW4oZXZlcnkpLFxuICAgICAgICBzaG93SWZQZXJtaXNzaW9uc1xuICAgICAgfSwgJ3Zpc2libGUnKVxuICAgICAgICAudGhlbigoeyB2aXNpYmxlIH0pID0+IHtcbiAgICAgICAgICBpZiAodmlzaWJsZSkge1xuICAgICAgICAgICAgbm9kZS5uYXZOb2RlLnVwZGF0ZSh7XG4gICAgICAgICAgICAgIGhpZGRlbjogZmFsc2UsXG4gICAgICAgICAgICAgIHNob3dJZjogbnVsbCxcbiAgICAgICAgICAgICAgc2hvd0lmUGVybWlzc2lvbjogbnVsbCxcbiAgICAgICAgICAgICAgc2hvd0lmQ29udGFpbnNWaXNpYmxlVmlld3M6IG51bGxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBub2RlLm5hdk5vZGUudXBkYXRlKHtcbiAgICAgICAgICAgICAgaGlkZGVuOiB0cnVlXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHZpZXdzQ29uZGl0aW9uYWxWaXNpYmlsaXR5KG5vZGUpIHtcbiAgICAgIGNvbnN0IGM4eVVpVXRpbCA9ICRpbmplY3Rvci5nZXQoJ2M4eVVpVXRpbCcpO1xuICAgICAgY29uc3QgYzh5Vmlld3MgPSAkaW5qZWN0b3IuZ2V0KCdjOHlWaWV3cycpO1xuICAgICAgY29uc3Qgdmlld3MgPSBjOHlWaWV3cy5nZXRCeVBhdGgobm9kZS5wYXRoKTtcbiAgICAgIHJldHVybiAkcS5hbGwoXG4gICAgICAgIG1hcCh2aWV3cywgKHZpZXcpID0+IGM4eVVpVXRpbFxuICAgICAgICAgIC5jb25maWd1cmVWaXNpYmlsaXR5KHBpY2sodmlldywgWydzaG93SWYnLCAnc2hvd0lmUGVybWlzc2lvbnMnXSksICdzaG93JywgZmFsc2UpXG4gICAgICAgICAgLnRoZW4ocHJvcGVydHkoJ3Nob3cnKSlcbiAgICAgICAgKVxuICAgICAgKVxuICAgICAgLnRoZW4oc29tZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHJvb3ROb2RlcygpIHtcbiAgICAgICAgcmV0dXJuIHJvb3QuY2hpbGRyZW47XG4gICAgICB9LFxuICAgICAgZmluZE5vZGUsXG4gICAgICBhZGROYXZpZ2F0aW9uLFxuICAgICAgcmVtb3ZlTmF2aWdhdGlvbixcbiAgICAgIHJvb3ROb2RlcyRcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICAkZ2V0LFxuICAgIGFkZE5hdmlnYXRpb24sXG4gICAgcmVtb3ZlTmF2aWdhdGlvblxuICB9O1xufVxuIl19