import { startsWith, unary, map, find, forEach } from 'lodash-es';
import { ViewContext } from '@c8y/ngx-components';
import { ReplaySubject } from 'rxjs';
export var ViewContextLegacyParameter;
(function (ViewContextLegacyParameter) {
    ViewContextLegacyParameter["Device"] = "deviceId";
    ViewContextLegacyParameter["Group"] = "groupId";
    ViewContextLegacyParameter["User"] = "userId";
    ViewContextLegacyParameter["Application"] = "applicationId";
    ViewContextLegacyParameter["SubscribedApplications"] = "applicationId";
    ViewContextLegacyParameter["Tenant"] = "tenantId";
})(ViewContextLegacyParameter || (ViewContextLegacyParameter = {}));
function c8yViewsProvider($routeProvider, c8yTabsProvider, c8yPathUtils) {
    'ngInject';
    const viewMap = {};
    const contextViews = new ReplaySubject();
    return {
        when,
        $get() {
            return {
                contextViews,
                when(path, cfg) {
                    return when(path, cfg, true);
                },
                getByPath,
                prefixWithSlash
            };
        }
    };
    /**
     * @ngdoc function
     * @name when
     * @methodOf c8y.ui.provider:c8yViewsProvider
     *
     * @description
     * Defines a view for given route.
     * If multiple views are defined for a single route then there will be a separate tab for each view available when user visits that route.
     *
     * @param path Target route.
     * @param cfg View configuration object with the following properties:
     *
     * - **name** - `string` - View's name (in case of multiple views at single route this will be displayed as tab's title).
     * - **priority** - `integer` - View's priority (in case of multiple views at single route this will determine the position of view's tab in the tabs stack).
     * - **icon** - `string` - Font Awesome icon name for the view (displayed on the tab's header).
     * - **showIf** - `function` - Function returning boolean value indicating whether to show a tab for the view or not.
     * - **templateUrl** - `string` - Path to the template to use for displaying the view.
     *
     * You can also provide other view options - the same as available for standard {@link https://docs.angularjs.org/api/ngRoute/provider/$routeProvider $routeProvider} in AngularJS.
     *
     * @example
     * The following example demonstrates how to add a new view to device details route
     * (which will be displayed as a tab if other views are assigned to the same route):
     * <pre>
     *   c8yViewsProvider.when('/device/:deviceId', {
     *     name: 'Tracking',
     *     templateUrl: ':::PLUGIN_PATH:::/views/index.html',
     *     icon: 'crosshairs',
     *     showIf: ['$routeParams', 'c8yDevices', function ($routeParams, c8yDevices) {
     *       var deviceId = $routeParams.deviceId;
     *       return c8yDevices.detailCached(deviceId).then(function (res) {
     *         var device = res.data;
     *         return device && (device.c8y_MotionTracking || device.c8y_Geofence);
     *       });
     *     }]
     *   });
     * </pre>
     */
    function when(path, cfg, runPhase) {
        const newPath = prefixWithSlash(path);
        cfg.resolve = cfg.resolve || {};
        // eslint-disable-next-line no-underscore-dangle
        cfg.resolve.__c8y_locales = [
            'c8yLocales',
            c8yLocales => {
                return c8yLocales.initDone;
            }
        ];
        let currentCfg = viewMap[newPath];
        const originalPath = newPath;
        if (!cfg.name) {
            // console.warn('View name not defined');
        }
        if (!currentCfg) {
            viewMap[newPath] = [];
            currentCfg = viewMap[newPath];
        }
        const upgradedContext = Object.keys(ViewContext)
            .map(key => ({
            key,
            isUpgrade: prefixWithSlash(ViewContext[key].replace('id', ViewContextLegacyParameter[key])) === path
        }))
            .find(({ isUpgrade }) => isUpgrade);
        if (upgradedContext) {
            currentCfg.push(cfg);
            cfg.path = newPath;
            const p = c8yPathUtils.appendSegment(originalPath.replace(path, ''), cfg.name);
            contextViews.next(Object.assign({}, cfg, { path: cfg.name ? p.substring(1) : '', contextKey: upgradedContext.key, runPhase }));
            cfg.showIf = undefined;
            if (cfg.name) {
                cfg.path = c8yPathUtils.appendSegment(originalPath, cfg.name);
            }
        }
        else {
            if (currentCfg.length === 1) {
                const [existingConfig] = currentCfg;
                existingConfig.path = c8yPathUtils.appendSegment(originalPath, existingConfig.name);
                existingConfig.tab = createTab(originalPath, existingConfig);
                $routeProvider.when(existingConfig.path, existingConfig);
            }
            currentCfg.push(cfg);
            cfg.path = newPath;
            if (currentCfg.length > 1) {
                cfg.path = c8yPathUtils.appendSegment(originalPath, cfg.name);
                createTab(originalPath, cfg);
                $routeProvider.when(prefixWithSlash(originalPath), {
                    resolveRedirectTo($route, $q, c8yUiUtil, c8yTabs, gettextCatalog) {
                        'ngInject';
                        const sortedCurrentCfg = c8yTabsProvider.sortTabsViews(currentCfg, gettextCatalog);
                        const params = $route.current.pathParams;
                        return $q
                            .all(map(sortedCurrentCfg, unary(c8yUiUtil.configureVisibility)))
                            .then(views => {
                            const first = find(views, 'show');
                            let url = first.path;
                            forEach(params, (val, key) => {
                                url = url.replace(`:${key}`, val);
                            });
                            c8yTabs.redirectedViewPath = url;
                            return url;
                        });
                    }
                });
            }
        }
        return $routeProvider.when(prefixWithSlash(cfg.path), cfg);
    }
    function getByPath(path) {
        return viewMap[prefixWithSlash(path)];
    }
    function createTab(path, cfg) {
        c8yTabsProvider.addTab(path, cfg);
    }
    function prefixWithSlash(path) {
        const prefix = startsWith(path, '/') ? '' : '/';
        return prefix + path;
    }
}
export { c8yViewsProvider };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld3MucHJvdmlkZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL3VwZ3JhZGUvIiwic291cmNlcyI6WyJuZzEvdmlld3MucHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbEUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFckMsTUFBTSxDQUFOLElBQVksMEJBT1g7QUFQRCxXQUFZLDBCQUEwQjtJQUNwQyxpREFBbUIsQ0FBQTtJQUNuQiwrQ0FBaUIsQ0FBQTtJQUNqQiw2Q0FBZSxDQUFBO0lBQ2YsMkRBQTZCLENBQUE7SUFDN0Isc0VBQXdDLENBQUE7SUFDeEMsaURBQW1CLENBQUE7QUFDckIsQ0FBQyxFQVBXLDBCQUEwQixLQUExQiwwQkFBMEIsUUFPckM7QUFFRCxTQUFTLGdCQUFnQixDQUFDLGNBQWMsRUFBRSxlQUFlLEVBQUUsWUFBWTtJQUNyRSxVQUFVLENBQUM7SUFFWCxNQUFNLE9BQU8sR0FBRyxFQUFFLENBQUM7SUFDbkIsTUFBTSxZQUFZLEdBQUcsSUFBSSxhQUFhLEVBQUUsQ0FBQztJQUV6QyxPQUFPO1FBQ0wsSUFBSTtRQUNKLElBQUk7WUFDRixPQUFPO2dCQUNMLFlBQVk7Z0JBQ1osSUFBSSxDQUFDLElBQUksRUFBRSxHQUFHO29CQUNaLE9BQU8sSUFBSSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBQy9CLENBQUM7Z0JBQ0QsU0FBUztnQkFDVCxlQUFlO2FBQ2hCLENBQUM7UUFDSixDQUFDO0tBQ0YsQ0FBQztJQUVGOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O09BcUNHO0lBQ0gsU0FBUyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxRQUFRO1FBQy9CLE1BQU0sT0FBTyxHQUFHLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN0QyxHQUFHLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDO1FBQ2hDLGdEQUFnRDtRQUNoRCxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsR0FBRztZQUMxQixZQUFZO1lBQ1osVUFBVSxDQUFDLEVBQUU7Z0JBQ1gsT0FBTyxVQUFVLENBQUMsUUFBUSxDQUFDO1lBQzdCLENBQUM7U0FDRixDQUFDO1FBRUYsSUFBSSxVQUFVLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2xDLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQztRQUU3QixJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRTtZQUNiLHlDQUF5QztTQUMxQztRQUVELElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDZixPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ3RCLFVBQVUsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDL0I7UUFFRCxNQUFNLGVBQWUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQzthQUM3QyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ1gsR0FBRztZQUNILFNBQVMsRUFDUCxlQUFlLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsMEJBQTBCLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUk7U0FDNUYsQ0FBQyxDQUFDO2FBQ0YsSUFBSSxDQUFDLENBQUMsRUFBRSxTQUFTLEVBQUUsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFdEMsSUFBSSxlQUFlLEVBQUU7WUFDbkIsVUFBVSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNyQixHQUFHLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQztZQUVuQixNQUFNLENBQUMsR0FBRyxZQUFZLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMvRSxZQUFZLENBQUMsSUFBSSxtQkFDWixHQUFHLElBQ04sSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFDcEMsVUFBVSxFQUFFLGVBQWUsQ0FBQyxHQUFHLEVBQy9CLFFBQVEsSUFDUixDQUFDO1lBQ0gsR0FBRyxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUM7WUFDdkIsSUFBSSxHQUFHLENBQUMsSUFBSSxFQUFFO2dCQUNaLEdBQUcsQ0FBQyxJQUFJLEdBQUcsWUFBWSxDQUFDLGFBQWEsQ0FBQyxZQUFZLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQy9EO1NBQ0Y7YUFBTTtZQUNMLElBQUksVUFBVSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBQzNCLE1BQU0sQ0FBQyxjQUFjLENBQUMsR0FBRyxVQUFVLENBQUM7Z0JBQ3BDLGNBQWMsQ0FBQyxJQUFJLEdBQUcsWUFBWSxDQUFDLGFBQWEsQ0FBQyxZQUFZLEVBQUUsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNwRixjQUFjLENBQUMsR0FBRyxHQUFHLFNBQVMsQ0FBQyxZQUFZLEVBQUUsY0FBYyxDQUFDLENBQUM7Z0JBQzdELGNBQWMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxjQUFjLENBQUMsQ0FBQzthQUMxRDtZQUVELFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDckIsR0FBRyxDQUFDLElBQUksR0FBRyxPQUFPLENBQUM7WUFFbkIsSUFBSSxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDekIsR0FBRyxDQUFDLElBQUksR0FBRyxZQUFZLENBQUMsYUFBYSxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzlELFNBQVMsQ0FBQyxZQUFZLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBRTdCLGNBQWMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLFlBQVksQ0FBQyxFQUFFO29CQUNqRCxpQkFBaUIsQ0FBQyxNQUFNLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsY0FBYzt3QkFDOUQsVUFBVSxDQUFDO3dCQUVYLE1BQU0sZ0JBQWdCLEdBQUcsZUFBZSxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUUsY0FBYyxDQUFDLENBQUM7d0JBQ25GLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDO3dCQUV6QyxPQUFPLEVBQUU7NkJBQ04sR0FBRyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxLQUFLLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQzs2QkFDaEUsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFOzRCQUNaLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7NEJBQ2xDLElBQUksR0FBRyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUM7NEJBQ3JCLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUU7Z0NBQzNCLEdBQUcsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksR0FBRyxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7NEJBQ3BDLENBQUMsQ0FBQyxDQUFDOzRCQUNILE9BQU8sQ0FBQyxrQkFBa0IsR0FBRyxHQUFHLENBQUM7NEJBQ2pDLE9BQU8sR0FBRyxDQUFDO3dCQUNiLENBQUMsQ0FBQyxDQUFDO29CQUNQLENBQUM7aUJBQ0YsQ0FBQyxDQUFDO2FBQ0o7U0FDRjtRQUNELE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFRCxTQUFTLFNBQVMsQ0FBQyxJQUFJO1FBQ3JCLE9BQU8sT0FBTyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFRCxTQUFTLFNBQVMsQ0FBQyxJQUFJLEVBQUUsR0FBRztRQUMxQixlQUFlLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQsU0FBUyxlQUFlLENBQUMsSUFBSTtRQUMzQixNQUFNLE1BQU0sR0FBRyxVQUFVLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztRQUNoRCxPQUFPLE1BQU0sR0FBRyxJQUFJLENBQUM7SUFDdkIsQ0FBQztBQUNILENBQUM7QUFFRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHN0YXJ0c1dpdGgsIHVuYXJ5LCBtYXAsIGZpbmQsIGZvckVhY2ggfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgVmlld0NvbnRleHQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IFJlcGxheVN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuZXhwb3J0IGVudW0gVmlld0NvbnRleHRMZWdhY3lQYXJhbWV0ZXIge1xuICBEZXZpY2UgPSAnZGV2aWNlSWQnLFxuICBHcm91cCA9ICdncm91cElkJyxcbiAgVXNlciA9ICd1c2VySWQnLFxuICBBcHBsaWNhdGlvbiA9ICdhcHBsaWNhdGlvbklkJyxcbiAgU3Vic2NyaWJlZEFwcGxpY2F0aW9ucyA9ICdhcHBsaWNhdGlvbklkJyxcbiAgVGVuYW50ID0gJ3RlbmFudElkJ1xufVxuXG5mdW5jdGlvbiBjOHlWaWV3c1Byb3ZpZGVyKCRyb3V0ZVByb3ZpZGVyLCBjOHlUYWJzUHJvdmlkZXIsIGM4eVBhdGhVdGlscykge1xuICAnbmdJbmplY3QnO1xuXG4gIGNvbnN0IHZpZXdNYXAgPSB7fTtcbiAgY29uc3QgY29udGV4dFZpZXdzID0gbmV3IFJlcGxheVN1YmplY3QoKTtcblxuICByZXR1cm4ge1xuICAgIHdoZW4sXG4gICAgJGdldCgpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGNvbnRleHRWaWV3cyxcbiAgICAgICAgd2hlbihwYXRoLCBjZmcpIHtcbiAgICAgICAgICByZXR1cm4gd2hlbihwYXRoLCBjZmcsIHRydWUpO1xuICAgICAgICB9LFxuICAgICAgICBnZXRCeVBhdGgsXG4gICAgICAgIHByZWZpeFdpdGhTbGFzaFxuICAgICAgfTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIEBuZ2RvYyBmdW5jdGlvblxuICAgKiBAbmFtZSB3aGVuXG4gICAqIEBtZXRob2RPZiBjOHkudWkucHJvdmlkZXI6Yzh5Vmlld3NQcm92aWRlclxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICogRGVmaW5lcyBhIHZpZXcgZm9yIGdpdmVuIHJvdXRlLlxuICAgKiBJZiBtdWx0aXBsZSB2aWV3cyBhcmUgZGVmaW5lZCBmb3IgYSBzaW5nbGUgcm91dGUgdGhlbiB0aGVyZSB3aWxsIGJlIGEgc2VwYXJhdGUgdGFiIGZvciBlYWNoIHZpZXcgYXZhaWxhYmxlIHdoZW4gdXNlciB2aXNpdHMgdGhhdCByb3V0ZS5cbiAgICpcbiAgICogQHBhcmFtIHBhdGggVGFyZ2V0IHJvdXRlLlxuICAgKiBAcGFyYW0gY2ZnIFZpZXcgY29uZmlndXJhdGlvbiBvYmplY3Qgd2l0aCB0aGUgZm9sbG93aW5nIHByb3BlcnRpZXM6XG4gICAqXG4gICAqIC0gKipuYW1lKiogLSBgc3RyaW5nYCAtIFZpZXcncyBuYW1lIChpbiBjYXNlIG9mIG11bHRpcGxlIHZpZXdzIGF0IHNpbmdsZSByb3V0ZSB0aGlzIHdpbGwgYmUgZGlzcGxheWVkIGFzIHRhYidzIHRpdGxlKS5cbiAgICogLSAqKnByaW9yaXR5KiogLSBgaW50ZWdlcmAgLSBWaWV3J3MgcHJpb3JpdHkgKGluIGNhc2Ugb2YgbXVsdGlwbGUgdmlld3MgYXQgc2luZ2xlIHJvdXRlIHRoaXMgd2lsbCBkZXRlcm1pbmUgdGhlIHBvc2l0aW9uIG9mIHZpZXcncyB0YWIgaW4gdGhlIHRhYnMgc3RhY2spLlxuICAgKiAtICoqaWNvbioqIC0gYHN0cmluZ2AgLSBGb250IEF3ZXNvbWUgaWNvbiBuYW1lIGZvciB0aGUgdmlldyAoZGlzcGxheWVkIG9uIHRoZSB0YWIncyBoZWFkZXIpLlxuICAgKiAtICoqc2hvd0lmKiogLSBgZnVuY3Rpb25gIC0gRnVuY3Rpb24gcmV0dXJuaW5nIGJvb2xlYW4gdmFsdWUgaW5kaWNhdGluZyB3aGV0aGVyIHRvIHNob3cgYSB0YWIgZm9yIHRoZSB2aWV3IG9yIG5vdC5cbiAgICogLSAqKnRlbXBsYXRlVXJsKiogLSBgc3RyaW5nYCAtIFBhdGggdG8gdGhlIHRlbXBsYXRlIHRvIHVzZSBmb3IgZGlzcGxheWluZyB0aGUgdmlldy5cbiAgICpcbiAgICogWW91IGNhbiBhbHNvIHByb3ZpZGUgb3RoZXIgdmlldyBvcHRpb25zIC0gdGhlIHNhbWUgYXMgYXZhaWxhYmxlIGZvciBzdGFuZGFyZCB7QGxpbmsgaHR0cHM6Ly9kb2NzLmFuZ3VsYXJqcy5vcmcvYXBpL25nUm91dGUvcHJvdmlkZXIvJHJvdXRlUHJvdmlkZXIgJHJvdXRlUHJvdmlkZXJ9IGluIEFuZ3VsYXJKUy5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogVGhlIGZvbGxvd2luZyBleGFtcGxlIGRlbW9uc3RyYXRlcyBob3cgdG8gYWRkIGEgbmV3IHZpZXcgdG8gZGV2aWNlIGRldGFpbHMgcm91dGVcbiAgICogKHdoaWNoIHdpbGwgYmUgZGlzcGxheWVkIGFzIGEgdGFiIGlmIG90aGVyIHZpZXdzIGFyZSBhc3NpZ25lZCB0byB0aGUgc2FtZSByb3V0ZSk6XG4gICAqIDxwcmU+XG4gICAqICAgYzh5Vmlld3NQcm92aWRlci53aGVuKCcvZGV2aWNlLzpkZXZpY2VJZCcsIHtcbiAgICogICAgIG5hbWU6ICdUcmFja2luZycsXG4gICAqICAgICB0ZW1wbGF0ZVVybDogJzo6OlBMVUdJTl9QQVRIOjo6L3ZpZXdzL2luZGV4Lmh0bWwnLFxuICAgKiAgICAgaWNvbjogJ2Nyb3NzaGFpcnMnLFxuICAgKiAgICAgc2hvd0lmOiBbJyRyb3V0ZVBhcmFtcycsICdjOHlEZXZpY2VzJywgZnVuY3Rpb24gKCRyb3V0ZVBhcmFtcywgYzh5RGV2aWNlcykge1xuICAgKiAgICAgICB2YXIgZGV2aWNlSWQgPSAkcm91dGVQYXJhbXMuZGV2aWNlSWQ7XG4gICAqICAgICAgIHJldHVybiBjOHlEZXZpY2VzLmRldGFpbENhY2hlZChkZXZpY2VJZCkudGhlbihmdW5jdGlvbiAocmVzKSB7XG4gICAqICAgICAgICAgdmFyIGRldmljZSA9IHJlcy5kYXRhO1xuICAgKiAgICAgICAgIHJldHVybiBkZXZpY2UgJiYgKGRldmljZS5jOHlfTW90aW9uVHJhY2tpbmcgfHwgZGV2aWNlLmM4eV9HZW9mZW5jZSk7XG4gICAqICAgICAgIH0pO1xuICAgKiAgICAgfV1cbiAgICogICB9KTtcbiAgICogPC9wcmU+XG4gICAqL1xuICBmdW5jdGlvbiB3aGVuKHBhdGgsIGNmZywgcnVuUGhhc2UpIHtcbiAgICBjb25zdCBuZXdQYXRoID0gcHJlZml4V2l0aFNsYXNoKHBhdGgpO1xuICAgIGNmZy5yZXNvbHZlID0gY2ZnLnJlc29sdmUgfHwge307XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVyc2NvcmUtZGFuZ2xlXG4gICAgY2ZnLnJlc29sdmUuX19jOHlfbG9jYWxlcyA9IFtcbiAgICAgICdjOHlMb2NhbGVzJyxcbiAgICAgIGM4eUxvY2FsZXMgPT4ge1xuICAgICAgICByZXR1cm4gYzh5TG9jYWxlcy5pbml0RG9uZTtcbiAgICAgIH1cbiAgICBdO1xuXG4gICAgbGV0IGN1cnJlbnRDZmcgPSB2aWV3TWFwW25ld1BhdGhdO1xuICAgIGNvbnN0IG9yaWdpbmFsUGF0aCA9IG5ld1BhdGg7XG5cbiAgICBpZiAoIWNmZy5uYW1lKSB7XG4gICAgICAvLyBjb25zb2xlLndhcm4oJ1ZpZXcgbmFtZSBub3QgZGVmaW5lZCcpO1xuICAgIH1cblxuICAgIGlmICghY3VycmVudENmZykge1xuICAgICAgdmlld01hcFtuZXdQYXRoXSA9IFtdO1xuICAgICAgY3VycmVudENmZyA9IHZpZXdNYXBbbmV3UGF0aF07XG4gICAgfVxuXG4gICAgY29uc3QgdXBncmFkZWRDb250ZXh0ID0gT2JqZWN0LmtleXMoVmlld0NvbnRleHQpXG4gICAgICAubWFwKGtleSA9PiAoe1xuICAgICAgICBrZXksXG4gICAgICAgIGlzVXBncmFkZTpcbiAgICAgICAgICBwcmVmaXhXaXRoU2xhc2goVmlld0NvbnRleHRba2V5XS5yZXBsYWNlKCdpZCcsIFZpZXdDb250ZXh0TGVnYWN5UGFyYW1ldGVyW2tleV0pKSA9PT0gcGF0aFxuICAgICAgfSkpXG4gICAgICAuZmluZCgoeyBpc1VwZ3JhZGUgfSkgPT4gaXNVcGdyYWRlKTtcblxuICAgIGlmICh1cGdyYWRlZENvbnRleHQpIHtcbiAgICAgIGN1cnJlbnRDZmcucHVzaChjZmcpO1xuICAgICAgY2ZnLnBhdGggPSBuZXdQYXRoO1xuXG4gICAgICBjb25zdCBwID0gYzh5UGF0aFV0aWxzLmFwcGVuZFNlZ21lbnQob3JpZ2luYWxQYXRoLnJlcGxhY2UocGF0aCwgJycpLCBjZmcubmFtZSk7XG4gICAgICBjb250ZXh0Vmlld3MubmV4dCh7XG4gICAgICAgIC4uLmNmZyxcbiAgICAgICAgcGF0aDogY2ZnLm5hbWUgPyBwLnN1YnN0cmluZygxKSA6ICcnLFxuICAgICAgICBjb250ZXh0S2V5OiB1cGdyYWRlZENvbnRleHQua2V5LFxuICAgICAgICBydW5QaGFzZVxuICAgICAgfSk7XG4gICAgICBjZmcuc2hvd0lmID0gdW5kZWZpbmVkO1xuICAgICAgaWYgKGNmZy5uYW1lKSB7XG4gICAgICAgIGNmZy5wYXRoID0gYzh5UGF0aFV0aWxzLmFwcGVuZFNlZ21lbnQob3JpZ2luYWxQYXRoLCBjZmcubmFtZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChjdXJyZW50Q2ZnLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICBjb25zdCBbZXhpc3RpbmdDb25maWddID0gY3VycmVudENmZztcbiAgICAgICAgZXhpc3RpbmdDb25maWcucGF0aCA9IGM4eVBhdGhVdGlscy5hcHBlbmRTZWdtZW50KG9yaWdpbmFsUGF0aCwgZXhpc3RpbmdDb25maWcubmFtZSk7XG4gICAgICAgIGV4aXN0aW5nQ29uZmlnLnRhYiA9IGNyZWF0ZVRhYihvcmlnaW5hbFBhdGgsIGV4aXN0aW5nQ29uZmlnKTtcbiAgICAgICAgJHJvdXRlUHJvdmlkZXIud2hlbihleGlzdGluZ0NvbmZpZy5wYXRoLCBleGlzdGluZ0NvbmZpZyk7XG4gICAgICB9XG5cbiAgICAgIGN1cnJlbnRDZmcucHVzaChjZmcpO1xuICAgICAgY2ZnLnBhdGggPSBuZXdQYXRoO1xuXG4gICAgICBpZiAoY3VycmVudENmZy5sZW5ndGggPiAxKSB7XG4gICAgICAgIGNmZy5wYXRoID0gYzh5UGF0aFV0aWxzLmFwcGVuZFNlZ21lbnQob3JpZ2luYWxQYXRoLCBjZmcubmFtZSk7XG4gICAgICAgIGNyZWF0ZVRhYihvcmlnaW5hbFBhdGgsIGNmZyk7XG5cbiAgICAgICAgJHJvdXRlUHJvdmlkZXIud2hlbihwcmVmaXhXaXRoU2xhc2gob3JpZ2luYWxQYXRoKSwge1xuICAgICAgICAgIHJlc29sdmVSZWRpcmVjdFRvKCRyb3V0ZSwgJHEsIGM4eVVpVXRpbCwgYzh5VGFicywgZ2V0dGV4dENhdGFsb2cpIHtcbiAgICAgICAgICAgICduZ0luamVjdCc7XG5cbiAgICAgICAgICAgIGNvbnN0IHNvcnRlZEN1cnJlbnRDZmcgPSBjOHlUYWJzUHJvdmlkZXIuc29ydFRhYnNWaWV3cyhjdXJyZW50Q2ZnLCBnZXR0ZXh0Q2F0YWxvZyk7XG4gICAgICAgICAgICBjb25zdCBwYXJhbXMgPSAkcm91dGUuY3VycmVudC5wYXRoUGFyYW1zO1xuXG4gICAgICAgICAgICByZXR1cm4gJHFcbiAgICAgICAgICAgICAgLmFsbChtYXAoc29ydGVkQ3VycmVudENmZywgdW5hcnkoYzh5VWlVdGlsLmNvbmZpZ3VyZVZpc2liaWxpdHkpKSlcbiAgICAgICAgICAgICAgLnRoZW4odmlld3MgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGZpcnN0ID0gZmluZCh2aWV3cywgJ3Nob3cnKTtcbiAgICAgICAgICAgICAgICBsZXQgdXJsID0gZmlyc3QucGF0aDtcbiAgICAgICAgICAgICAgICBmb3JFYWNoKHBhcmFtcywgKHZhbCwga2V5KSA9PiB7XG4gICAgICAgICAgICAgICAgICB1cmwgPSB1cmwucmVwbGFjZShgOiR7a2V5fWAsIHZhbCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgYzh5VGFicy5yZWRpcmVjdGVkVmlld1BhdGggPSB1cmw7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVybDtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuICRyb3V0ZVByb3ZpZGVyLndoZW4ocHJlZml4V2l0aFNsYXNoKGNmZy5wYXRoKSwgY2ZnKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEJ5UGF0aChwYXRoKSB7XG4gICAgcmV0dXJuIHZpZXdNYXBbcHJlZml4V2l0aFNsYXNoKHBhdGgpXTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGNyZWF0ZVRhYihwYXRoLCBjZmcpIHtcbiAgICBjOHlUYWJzUHJvdmlkZXIuYWRkVGFiKHBhdGgsIGNmZyk7XG4gIH1cblxuICBmdW5jdGlvbiBwcmVmaXhXaXRoU2xhc2gocGF0aCkge1xuICAgIGNvbnN0IHByZWZpeCA9IHN0YXJ0c1dpdGgocGF0aCwgJy8nKSA/ICcnIDogJy8nO1xuICAgIHJldHVybiBwcmVmaXggKyBwYXRoO1xuICB9XG59XG5cbmV4cG9ydCB7IGM4eVZpZXdzUHJvdmlkZXIgfTtcbiJdfQ==