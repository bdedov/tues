import * as tslib_1 from "tslib";
import { Injectable, NgZone } from '@angular/core';
import { Router } from '@angular/router';
import { ActionBarService, getActivatedRoute } from '@c8y/ngx-components';
import { ContextDashboardService, ContextDashboardManagedObject, ContextWidgetConfig } from '@c8y/ngx-components/context-dashboard';
import { gettext } from '@c8y/ngx-components';
import { get } from 'lodash-es';
let DashboardBridgeService = class DashboardBridgeService {
    constructor(ng1Injector, zone, router, contextDashboardService, actionBarService) {
        this.ng1Injector = ng1Injector;
        this.zone = zone;
        this.router = router;
        this.contextDashboardService = contextDashboardService;
        this.actionBarService = actionBarService;
        this.dashboardSvc = ng1Injector.get('dashboardSvc');
        this.compile = ng1Injector.get('$compile');
    }
    get ng1Components() {
        return this.ng1Injector.get('c8yComponents');
    }
    instantiateComponent(widget, element) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const { dashboard, context, child } = widget;
            if (dashboard) {
                const transformedChild = yield this.dashboardSvc.transformChildWithContext(this.dashboardSvc.forcedContext || context, dashboard, child);
                if (this.dashboardSvc.forcedContext || dashboard.deviceType) {
                    yield this.dashboardSvc.updateConfigTargetsWithContext(this.dashboardSvc.forcedContext || context, transformedChild.config);
                }
                return this.zone.runOutsideAngular(() => this.loadTemplate(transformedChild, child, element, context));
            }
            else {
                return this.loadConfigTemplate(element, widget);
            }
        });
    }
    editDashboard(dashboard) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return this.dashboardSvc.editCurrentDashboard({ dashboardId: dashboard.id });
        });
    }
    copyDashboard() {
        const dashboard = this.getDashboard();
        const couldCopy = this.dashboardSvc.copyDashboard(dashboard.c8y_Dashboard);
        if (couldCopy) {
            this.dashboardClipboard = dashboard;
            this.actionBarService.refresh();
            return dashboard;
        }
    }
    pasteDashboard() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const newDashboard = yield this.dashboardSvc.pasteDashboard();
                this.navigateToDashboard(newDashboard);
                this.dashboardClipboard = undefined;
            }
            catch (ex) {
                // intended empty
            }
            this.actionBarService.refresh();
        });
    }
    instantiateDeviceSelector(element, widgetConfig) {
        return this.loadConfigTemplate(element, widgetConfig, true);
    }
    loadTemplate(transformedChild, child, element, context) {
        const scope = this.ng1Injector.get('$rootScope').$new(true);
        scope.child = transformedChild;
        scope.dashboardContext = context;
        if (child.widgetComponent) {
            element.innerHTML = `<c8y-ui-component component-name="'${child.widgetComponent}'" config="child.config" context="dashboardContext"></c8y-ui-component>`;
        }
        else if (child.templateUrl) {
            element.innerHTML = `<ng-include src="'${child.templateUrl}'"></ng-include>`;
        }
        this.compile(element)(scope);
        return scope;
    }
    navigateToDashboard(dashboard) {
        if (/dashboard/.test(this.router.url)) {
            this.router.navigate(['..', dashboard.id], {
                relativeTo: getActivatedRoute(this.router)
            });
        }
        else {
            this.router.navigate(['..', 'dashboard', dashboard.id], {
                relativeTo: getActivatedRoute(this.router)
            });
        }
    }
    getDashboard() {
        return getActivatedRoute(this.router).snapshot.data.dashboard;
    }
    loadConfigTemplate(element, widgetConfig, onlyDeviceSelector = false) {
        const { settings } = widgetConfig;
        const scope = this.ng1Injector.get('$rootScope').$new(true);
        scope.settings = Object.assign({}, settings, settings.ng1);
        scope.options = widgetConfig.options;
        scope.config = widgetConfig;
        scope.forms = {};
        scope.rootId = settings.context.id;
        scope.dashboard = get(widgetConfig, 'settings.dashboardMo');
        let configCmp = '';
        if (!onlyDeviceSelector) {
            if (widgetConfig.settings.configComponent) {
                configCmp = `<c8y-ui-component component-name="'${widgetConfig.settings.configComponent}'" config="config"></c8y-ui-component>`;
            }
            else if (widgetConfig.settings.configTemplateUrl) {
                configCmp = `<ng-include src="'${widgetConfig.settings.configTemplateUrl}'"></ng-include>`;
            }
        }
        element.innerHTML = `
    <ng-form name="forms.componentForm">
      <div class="form-group"
        ng-if="!settings.noDeviceTarget"
        ng-style="{height: settings.hideTarget && '0', overflow: 'hidden'}"
      >
        <label translate>${gettext('Target assets or devices')}</label>
        <c8y-device-selector-combo parent="rootId"
          selected-child-device="config.device"
          groups-selectable="settings.groupsSelectable"
          select-required="!settings.deviceTargetNotRequired"
        ></c8y-device-selector-combo>
      </div>
      ${configCmp}
    </ng-form>`;
        scope.$watch('forms.componentForm.$invalid', formStatus => {
            this.contextDashboardService.formDisabled = formStatus;
        });
        this.compile(element)(scope);
        this.contextDashboardService.formDisabled = scope.forms.componentForm.$invalid;
        return scope;
    }
};
DashboardBridgeService.ctorParameters = () => [
    { type: undefined },
    { type: NgZone },
    { type: Router },
    { type: ContextDashboardService },
    { type: ActionBarService }
];
DashboardBridgeService = tslib_1.__decorate([
    Injectable()
], DashboardBridgeService);
export { DashboardBridgeService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzaGJvYXJkLWJyaWRnZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy91cGdyYWRlLyIsInNvdXJjZXMiOlsiZGFzaGJvYXJkL2Rhc2hib2FyZC1icmlkZ2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzFFLE9BQU8sRUFDTCx1QkFBdUIsRUFDdkIsNkJBQTZCLEVBQzdCLG1CQUFtQixFQUNwQixNQUFNLHVDQUF1QyxDQUFDO0FBQy9DLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBR2hDLElBQWEsc0JBQXNCLEdBQW5DLE1BQWEsc0JBQXNCO0lBS2pDLFlBQ1UsV0FBZ0IsRUFDaEIsSUFBWSxFQUNaLE1BQWMsRUFDZCx1QkFBZ0QsRUFDaEQsZ0JBQWtDO1FBSmxDLGdCQUFXLEdBQVgsV0FBVyxDQUFLO1FBQ2hCLFNBQUksR0FBSixJQUFJLENBQVE7UUFDWixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQUNoRCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBRTFDLElBQUksQ0FBQyxZQUFZLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsT0FBTyxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVELElBQUksYUFBYTtRQUNmLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxH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QUNGLENBQUE7OztZQWpKaUIsTUFBTTtZQUNKLE1BQU07WUFDVyx1QkFBdUI7WUFDOUIsZ0JBQWdCOztBQVZqQyxzQkFBc0I7SUFEbEMsVUFBVSxFQUFFO0dBQ0Esc0JBQXNCLENBd0psQztTQXhKWSxzQkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBBY3Rpb25CYXJTZXJ2aWNlLCBnZXRBY3RpdmF0ZWRSb3V0ZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHtcbiAgQ29udGV4dERhc2hib2FyZFNlcnZpY2UsXG4gIENvbnRleHREYXNoYm9hcmRNYW5hZ2VkT2JqZWN0LFxuICBDb250ZXh0V2lkZ2V0Q29uZmlnXG59IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMvY29udGV4dC1kYXNoYm9hcmQnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgZ2V0IH0gZnJvbSAnbG9kYXNoLWVzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIERhc2hib2FyZEJyaWRnZVNlcnZpY2Uge1xuICBkYXNoYm9hcmRTdmM7XG4gIGNvbXBpbGU7XG4gIGRhc2hib2FyZENsaXBib2FyZDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG5nMUluamVjdG9yOiBhbnksXG4gICAgcHJpdmF0ZSB6b25lOiBOZ1pvbmUsXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICBwcml2YXRlIGNvbnRleHREYXNoYm9hcmRTZXJ2aWNlOiBDb250ZXh0RGFzaGJvYXJkU2VydmljZSxcbiAgICBwcml2YXRlIGFjdGlvbkJhclNlcnZpY2U6IEFjdGlvbkJhclNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5kYXNoYm9hcmRTdmMgPSBuZzFJbmplY3Rvci5nZXQoJ2Rhc2hib2FyZFN2YycpO1xuICAgIHRoaXMuY29tcGlsZSA9IG5nMUluamVjdG9yLmdldCgnJGNvbXBpbGUnKTtcbiAgfVxuXG4gIGdldCBuZzFDb21wb25lbnRzKCkge1xuICAgIHJldHVybiB0aGlzLm5nMUluamVjdG9yLmdldCgnYzh5Q29tcG9uZW50cycpO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFudGlhdGVDb21wb25lbnQod2lkZ2V0LCBlbGVtZW50KSB7XG4gICAgY29uc3QgeyBkYXNoYm9hcmQsIGNvbnRleHQsIGNoaWxkIH0gPSB3aWRnZXQ7XG4gICAgaWYgKGRhc2hib2FyZCkge1xuICAgICAgY29uc3QgdHJhbnNmb3JtZWRDaGlsZCA9IGF3YWl0IHRoaXMuZGFzaGJvYXJkU3ZjLnRyYW5zZm9ybUNoaWxkV2l0aENvbnRleHQoXG4gICAgICAgIHRoaXMuZGFzaGJvYXJkU3ZjLmZvcmNlZENvbnRleHQgfHwgY29udGV4dCxcbiAgICAgICAgZGFzaGJvYXJkLFxuICAgICAgICBjaGlsZFxuICAgICAgKTtcbiAgICAgIGlmICh0aGlzLmRhc2hib2FyZFN2Yy5mb3JjZWRDb250ZXh0IHx8IGRhc2hib2FyZC5kZXZpY2VUeXBlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZGFzaGJvYXJkU3ZjLnVwZGF0ZUNvbmZpZ1RhcmdldHNXaXRoQ29udGV4dChcbiAgICAgICAgICB0aGlzLmRhc2hib2FyZFN2Yy5mb3JjZWRDb250ZXh0IHx8IGNvbnRleHQsXG4gICAgICAgICAgdHJhbnNmb3JtZWRDaGlsZC5jb25maWdcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT5cbiAgICAgICAgdGhpcy5sb2FkVGVtcGxhdGUodHJhbnNmb3JtZWRDaGlsZCwgY2hpbGQsIGVsZW1lbnQsIGNvbnRleHQpXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5sb2FkQ29uZmlnVGVtcGxhdGUoZWxlbWVudCwgd2lkZ2V0KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBlZGl0RGFzaGJvYXJkKGRhc2hib2FyZCkge1xuICAgIHJldHVybiB0aGlzLmRhc2hib2FyZFN2Yy5lZGl0Q3VycmVudERhc2hib2FyZCh7IGRhc2hib2FyZElkOiBkYXNoYm9hcmQuaWQgfSk7XG4gIH1cblxuICBjb3B5RGFzaGJvYXJkKCkge1xuICAgIGNvbnN0IGRhc2hib2FyZCA9IHRoaXMuZ2V0RGFzaGJvYXJkKCk7XG4gICAgY29uc3QgY291bGRDb3B5ID0gdGhpcy5kYXNoYm9hcmRTdmMuY29weURhc2hib2FyZChkYXNoYm9hcmQuYzh5X0Rhc2hib2FyZCk7XG4gICAgaWYgKGNvdWxkQ29weSkge1xuICAgICAgdGhpcy5kYXNoYm9hcmRDbGlwYm9hcmQgPSBkYXNoYm9hcmQ7XG4gICAgICB0aGlzLmFjdGlvbkJhclNlcnZpY2UucmVmcmVzaCgpO1xuICAgICAgcmV0dXJuIGRhc2hib2FyZDtcbiAgICB9XG4gIH1cblxuICBhc3luYyBwYXN0ZURhc2hib2FyZCgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgbmV3RGFzaGJvYXJkID0gYXdhaXQgdGhpcy5kYXNoYm9hcmRTdmMucGFzdGVEYXNoYm9hcmQoKTtcbiAgICAgIHRoaXMubmF2aWdhdGVUb0Rhc2hib2FyZChuZXdEYXNoYm9hcmQpO1xuICAgICAgdGhpcy5kYXNoYm9hcmRDbGlwYm9hcmQgPSB1bmRlZmluZWQ7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIC8vIGludGVuZGVkIGVtcHR5XG4gICAgfVxuICAgIHRoaXMuYWN0aW9uQmFyU2VydmljZS5yZWZyZXNoKCk7XG4gIH1cblxuICBpbnN0YW50aWF0ZURldmljZVNlbGVjdG9yKGVsZW1lbnQsIHdpZGdldENvbmZpZzogQ29udGV4dFdpZGdldENvbmZpZykge1xuICAgIHJldHVybiB0aGlzLmxvYWRDb25maWdUZW1wbGF0ZShlbGVtZW50LCB3aWRnZXRDb25maWcsIHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2FkVGVtcGxhdGUodHJhbnNmb3JtZWRDaGlsZCwgY2hpbGQsIGVsZW1lbnQsIGNvbnRleHQpIHtcbiAgICBjb25zdCBzY29wZSA9IHRoaXMubmcxSW5qZWN0b3IuZ2V0KCckcm9vdFNjb3BlJykuJG5ldyh0cnVlKTtcbiAgICBzY29wZS5jaGlsZCA9IHRyYW5zZm9ybWVkQ2hpbGQ7XG4gICAgc2NvcGUuZGFzaGJvYXJkQ29udGV4dCA9IGNvbnRleHQ7XG4gICAgaWYgKGNoaWxkLndpZGdldENvbXBvbmVudCkge1xuICAgICAgZWxlbWVudC5pbm5lckhUTUwgPSBgPGM4eS11aS1jb21wb25lbnQgY29tcG9uZW50LW5hbWU9XCInJHtcbiAgICAgICAgY2hpbGQud2lkZ2V0Q29tcG9uZW50XG4gICAgICB9J1wiIGNvbmZpZz1cImNoaWxkLmNvbmZpZ1wiIGNvbnRleHQ9XCJkYXNoYm9hcmRDb250ZXh0XCI+PC9jOHktdWktY29tcG9uZW50PmA7XG4gICAgfSBlbHNlIGlmIChjaGlsZC50ZW1wbGF0ZVVybCkge1xuICAgICAgZWxlbWVudC5pbm5lckhUTUwgPSBgPG5nLWluY2x1ZGUgc3JjPVwiJyR7Y2hpbGQudGVtcGxhdGVVcmx9J1wiPjwvbmctaW5jbHVkZT5gO1xuICAgIH1cbiAgICB0aGlzLmNvbXBpbGUoZWxlbWVudCkoc2NvcGUpO1xuICAgIHJldHVybiBzY29wZTtcbiAgfVxuXG4gIHByaXZhdGUgbmF2aWdhdGVUb0Rhc2hib2FyZChkYXNoYm9hcmQ6IENvbnRleHREYXNoYm9hcmRNYW5hZ2VkT2JqZWN0KSB7XG4gICAgaWYgKC9kYXNoYm9hcmQvLnRlc3QodGhpcy5yb3V0ZXIudXJsKSkge1xuICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWycuLicsIGRhc2hib2FyZC5pZF0sIHtcbiAgICAgICAgcmVsYXRpdmVUbzogZ2V0QWN0aXZhdGVkUm91dGUodGhpcy5yb3V0ZXIpXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWycuLicsICdkYXNoYm9hcmQnLCBkYXNoYm9hcmQuaWRdLCB7XG4gICAgICAgIHJlbGF0aXZlVG86IGdldEFjdGl2YXRlZFJvdXRlKHRoaXMucm91dGVyKVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXREYXNoYm9hcmQoKSB7XG4gICAgcmV0dXJuIGdldEFjdGl2YXRlZFJvdXRlKHRoaXMucm91dGVyKS5zbmFwc2hvdC5kYXRhLmRhc2hib2FyZDtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZENvbmZpZ1RlbXBsYXRlKFxuICAgIGVsZW1lbnQsXG4gICAgd2lkZ2V0Q29uZmlnOiBDb250ZXh0V2lkZ2V0Q29uZmlnLFxuICAgIG9ubHlEZXZpY2VTZWxlY3RvciA9IGZhbHNlXG4gICkge1xuICAgIGNvbnN0IHsgc2V0dGluZ3MgfSA9IHdpZGdldENvbmZpZztcbiAgICBjb25zdCBzY29wZSA9IHRoaXMubmcxSW5qZWN0b3IuZ2V0KCckcm9vdFNjb3BlJykuJG5ldyh0cnVlKTtcblxuICAgIHNjb3BlLnNldHRpbmdzID0geyAuLi5zZXR0aW5ncywgLi4uc2V0dGluZ3MubmcxIH07XG4gICAgc2NvcGUub3B0aW9ucyA9IHdpZGdldENvbmZpZy5vcHRpb25zO1xuICAgIHNjb3BlLmNvbmZpZyA9IHdpZGdldENvbmZpZztcbiAgICBzY29wZS5mb3JtcyA9IHt9O1xuICAgIHNjb3BlLnJvb3RJZCA9IHNldHRpbmdzLmNvbnRleHQuaWQ7XG4gICAgc2NvcGUuZGFzaGJvYXJkID0gZ2V0KHdpZGdldENvbmZpZywgJ3NldHRpbmdzLmRhc2hib2FyZE1vJyk7XG5cbiAgICBsZXQgY29uZmlnQ21wID0gJyc7XG4gICAgaWYgKCFvbmx5RGV2aWNlU2VsZWN0b3IpIHtcbiAgICAgIGlmICh3aWRnZXRDb25maWcuc2V0dGluZ3MuY29uZmlnQ29tcG9uZW50KSB7XG4gICAgICAgIGNvbmZpZ0NtcCA9IGA8Yzh5LXVpLWNvbXBvbmVudCBjb21wb25lbnQtbmFtZT1cIicke1xuICAgICAgICAgIHdpZGdldENvbmZpZy5zZXR0aW5ncy5jb25maWdDb21wb25lbnRcbiAgICAgICAgfSdcIiBjb25maWc9XCJjb25maWdcIj48L2M4eS11aS1jb21wb25lbnQ+YDtcbiAgICAgIH0gZWxzZSBpZiAod2lkZ2V0Q29uZmlnLnNldHRpbmdzLmNvbmZpZ1RlbXBsYXRlVXJsKSB7XG4gICAgICAgIGNvbmZpZ0NtcCA9IGA8bmctaW5jbHVkZSBzcmM9XCInJHt3aWRnZXRDb25maWcuc2V0dGluZ3MuY29uZmlnVGVtcGxhdGVVcmx9J1wiPjwvbmctaW5jbHVkZT5gO1xuICAgICAgfVxuICAgIH1cblxuICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gYFxuICAgIDxuZy1mb3JtIG5hbWU9XCJmb3Jtcy5jb21wb25lbnRGb3JtXCI+XG4gICAgICA8ZGl2IGNsYXNzPVwiZm9ybS1ncm91cFwiXG4gICAgICAgIG5nLWlmPVwiIXNldHRpbmdzLm5vRGV2aWNlVGFyZ2V0XCJcbiAgICAgICAgbmctc3R5bGU9XCJ7aGVpZ2h0OiBzZXR0aW5ncy5oaWRlVGFyZ2V0ICYmICcwJywgb3ZlcmZsb3c6ICdoaWRkZW4nfVwiXG4gICAgICA+XG4gICAgICAgIDxsYWJlbCB0cmFuc2xhdGU+JHtnZXR0ZXh0KCdUYXJnZXQgYXNzZXRzIG9yIGRldmljZXMnKX08L2xhYmVsPlxuICAgICAgICA8Yzh5LWRldmljZS1zZWxlY3Rvci1jb21ibyBwYXJlbnQ9XCJyb290SWRcIlxuICAgICAgICAgIHNlbGVjdGVkLWNoaWxkLWRldmljZT1cImNvbmZpZy5kZXZpY2VcIlxuICAgICAgICAgIGdyb3Vwcy1zZWxlY3RhYmxlPVwic2V0dGluZ3MuZ3JvdXBzU2VsZWN0YWJsZVwiXG4gICAgICAgICAgc2VsZWN0LXJlcXVpcmVkPVwiIXNldHRpbmdzLmRldmljZVRhcmdldE5vdFJlcXVpcmVkXCJcbiAgICAgICAgPjwvYzh5LWRldmljZS1zZWxlY3Rvci1jb21ibz5cbiAgICAgIDwvZGl2PlxuICAgICAgJHtjb25maWdDbXB9XG4gICAgPC9uZy1mb3JtPmA7XG5cbiAgICBzY29wZS4kd2F0Y2goJ2Zvcm1zLmNvbXBvbmVudEZvcm0uJGludmFsaWQnLCBmb3JtU3RhdHVzID0+IHtcbiAgICAgIHRoaXMuY29udGV4dERhc2hib2FyZFNlcnZpY2UuZm9ybURpc2FibGVkID0gZm9ybVN0YXR1cztcbiAgICB9KTtcbiAgICB0aGlzLmNvbXBpbGUoZWxlbWVudCkoc2NvcGUpO1xuICAgIHRoaXMuY29udGV4dERhc2hib2FyZFNlcnZpY2UuZm9ybURpc2FibGVkID0gc2NvcGUuZm9ybXMuY29tcG9uZW50Rm9ybS4kaW52YWxpZDtcblxuICAgIHJldHVybiBzY29wZTtcbiAgfVxufVxuIl19