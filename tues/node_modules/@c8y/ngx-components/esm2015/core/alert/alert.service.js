import * as tslib_1 from "tslib";
import { BehaviorSubject } from 'rxjs';
import { Injectable } from '@angular/core';
import { StateService } from '../common/state-service.abstract';
import { gettext } from '../i18n/gettext';
import * as i0 from "@angular/core";
/**
 * A service which allows to display alerts.
 */
let AlertService = class AlertService extends StateService {
    /**
     * A service which allows to display alerts.
     */
    constructor() {
        super(...arguments);
        /**
         * @ignore
         */
        this.state$ = new BehaviorSubject([]);
        this.MAX_ALERTS = 3;
        this.ALERT_TIMEOUT = 3000;
    }
    /**
     * Returns all alerts.
     * @readonly
     */
    get state() {
        return this.state$.value;
    }
    /**
     * Adds a new alert to the current state.
     */
    add(alert) {
        this.addAlert(alert);
    }
    /**
     * Adds a alert by text.
     */
    addByText(type, txt, detailedData) {
        this.addAlert({ text: txt, type, detailedData });
    }
    /**
     * Returns all alerts.
     * @deprecated Use alertService.alerts instead.
     */
    list() {
        return this.state;
    }
    /**
     * Remove an alert from the current state.
     */
    remove(alert) {
        this.changeAlerts(this.state.filter(item => !this.areSame(alert, item)));
    }
    /**
     * Updates matching alert with provided values.
     */
    update(alert, fieldsToUpdate) {
        this.changeAlerts(this.state.map(item => {
            if (this.areSame(alert, item)) {
                Object.assign(item, fieldsToUpdate);
            }
            return item;
        }));
    }
    /**
     * Removes last danger alert.
     * It can be used e.g. in the case of a failed request which triggered an alert, to hide it from user.
     *
     * ```js
     *  try {
     *    // something that might throw a danger server msg
     *  } catch (ex) {
     *   this.alertService.removeLastDanger();
     *  }
     * ```
     */
    removeLastDanger() {
        const firstDangerAlert = this.state.reverse().find(({ type }) => type === 'danger');
        this.changeAlerts(this.state.filter(alert => alert !== firstDangerAlert));
    }
    /**
     * Shorthand for a save successful alert.
     * @param savedObject The object which was saved.
     * @return A function that can be executed to show the msg.
     */
    saveSuccess(savedObject) {
        return () => {
            const text = `${savedObject} saved successfully`;
            this.addByText('success', text);
        };
    }
    /**
     * Shorthand for a create successful alert.
     * @param createdObject The object which was created.
     * @return A function that can be executed to show the msg.
     */
    createSuccess(createdObject) {
        return () => {
            const text = `${createdObject} created successfully`;
            this.addByText('success', text);
        };
    }
    /**
     * Clears all alerts.
     */
    clearAll() {
        this.changeAlerts([]);
    }
    /**
     * A shorthand to display a simple success message.
     * @param text The success text.
     * @param detailedData The text with additional information.
     */
    success(text, detailedData) {
        this.addByText('success', text, detailedData);
    }
    /**
     * A shorthand to display a simple danger message.
     * @param text The danger text.
     * @param detailedData The text with additional information.
     */
    danger(text, detailedData) {
        this.addByText('danger', text, detailedData);
    }
    /**
     * A shorthand to display a simple info message.
     * @param text The info text.
     * @param detailedData The text with additional information.
     */
    info(text, detailedData) {
        this.addByText('info', text, detailedData);
    }
    /**
     * A shorthand to display a simple warning message.
     * @param text The warning text.
     * @param detailedData The text with additional information.
     */
    warning(text, detailedData) {
        this.addByText('warning', text, detailedData);
    }
    /**
     * Creates alert from standard api errors.
     * Should be used for errors generated by @c8y/client services.
     * @param {IResult}  error The error from server.
     * @param {alertType} type The type of alert.
     */
    addServerFailure(error, type = 'danger') {
        const { data, res } = error;
        let text = data && data.message ? data.message : null;
        let detailedData;
        if (data) {
            if (typeof data === 'object') {
                detailedData = data.exceptionMessage;
            }
            else if (typeof data === 'string') {
                detailedData = data;
            }
        }
        const hasRelevantMessage = !!(text || detailedData);
        if (!text) {
            text = gettext('A server error occurred.');
        }
        if (!hasRelevantMessage) {
            detailedData = {
                status: res.status,
                statusText: res.statusText,
                url: res.url
            };
        }
        this.addAlert({
            type,
            text,
            detailedData
        });
    }
    /**
     * Compares two alert objects. Alerts are same if text, type, detailed data and callbacks are same.
     * Callbacks are same if they refer to the same function.
     */
    areSame(alert1, alert2) {
        return (alert1.text === alert2.text &&
            alert1.type === alert2.type &&
            alert1.detailedData === alert2.detailedData &&
            alert1.onClose === alert2.onClose &&
            alert1.onDetail === alert2.onDetail);
    }
    changeAlerts(newAlerts) {
        this.state$.next(newAlerts);
    }
    addAlert(alert) {
        if (!alert.text && !alert.type) {
            throw new Error('Cannot add empty alert');
        }
        const alertAlreadyAdded = this.state.find(item => this.areSame(alert, item));
        if (alertAlreadyAdded) {
            return;
        }
        this.changeAlerts([...this.state, alert]);
        this.hideAutomaticallyIfNeeded(alert);
        this.removeOldestIfMax();
    }
    hideAutomaticallyIfNeeded(alert) {
        const isSuccess = alert.type === 'success';
        const noDetails = !alert.detailedData;
        let alertTimeout = isSuccess && noDetails ? this.ALERT_TIMEOUT : 0;
        if (typeof alert.timeout !== 'undefined') {
            alertTimeout = alert.timeout;
        }
        if (alertTimeout) {
            setTimeout(() => this.remove(alert), alertTimeout);
        }
    }
    removeOldestIfMax() {
        if (this.state.length > this.MAX_ALERTS) {
            const [, ...firstRemoved] = this.state;
            this.changeAlerts(firstRemoved);
        }
    }
};
AlertService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function AlertService_Factory() { return new AlertService(); }, token: AlertService, providedIn: "root" });
AlertService = tslib_1.__decorate([
    Injectable({
        providedIn: 'root'
    })
], AlertService);
export { AlertService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxlcnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2FsZXJ0L2FsZXJ0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDaEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDOztBQUkxQzs7R0FFRztBQUlILElBQWEsWUFBWSxHQUF6QixNQUFhLFlBQWEsU0FBUSxZQUFZO0lBTjlDOztPQUVHO0lBQ0g7O1FBV0U7O1dBRUc7UUFDSCxXQUFNLEdBQUcsSUFBSSxlQUFlLENBQVUsRUFBRSxDQUFDLENBQUM7UUFFbEMsZUFBVSxHQUFHLENBQUMsQ0FBQztRQUNmLGtCQUFhLEdBQUcsSUFBSSxDQUFDO0tBd045QjtJQXJPQzs7O09BR0c7SUFDSCxJQUFJLEtBQUs7UUFDUCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO0lBQzNCLENBQUM7SUFTRDs7T0FFRztJQUNILEdBQUcsQ0FBQyxLQUFZO1FBQ2QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN2QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxTQUFTLENBQUMsSUFBZSxFQUFFLEdBQVcsRUFBRSxZQUFxQjtRQUMzRCxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsSUFBSTtRQUNGLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsS0FBWTtR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QUN2QixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDdkMsTUFBTSxDQUFDLEVBQUUsR0FBRyxZQUFZLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1lBQ3ZDLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLENBQUM7U0FDakM7SUFDSCxDQUFDO0NBQ0YsQ0FBQTs7QUF0T1ksWUFBWTtJQUh4QixVQUFVLENBQUM7UUFDVixVQUFVLEVBQUUsTUFBTTtLQUNuQixDQUFDO0dBQ1csWUFBWSxDQXNPeEI7U0F0T1ksWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFsZXJ0IH0gZnJvbSAnLi9hbGVydC5tb2RlbCc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN0YXRlU2VydmljZSB9IGZyb20gJy4uL2NvbW1vbi9zdGF0ZS1zZXJ2aWNlLmFic3RyYWN0JztcbmltcG9ydCB7IGdldHRleHQgfSBmcm9tICcuLi9pMThuL2dldHRleHQnO1xuaW1wb3J0IHtJUmVzdWx0fSBmcm9tICdAYzh5L2NsaWVudCc7XG5cbnR5cGUgYWxlcnRUeXBlID0gJ3N1Y2Nlc3MnIHwgJ3dhcm5pbmcnIHwgJ2RhbmdlcicgfCAnaW5mbycgfCAnc3lzdGVtJztcbi8qKlxuICogQSBzZXJ2aWNlIHdoaWNoIGFsbG93cyB0byBkaXNwbGF5IGFsZXJ0cy5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQWxlcnRTZXJ2aWNlIGV4dGVuZHMgU3RhdGVTZXJ2aWNlIHtcbiAgLyoqXG4gICAqIFJldHVybnMgYWxsIGFsZXJ0cy5cbiAgICogQHJlYWRvbmx5XG4gICAqL1xuICBnZXQgc3RhdGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGUkLnZhbHVlO1xuICB9XG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBzdGF0ZSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEFsZXJ0W10+KFtdKTtcblxuICBwcml2YXRlIE1BWF9BTEVSVFMgPSAzO1xuICBwcml2YXRlIEFMRVJUX1RJTUVPVVQgPSAzMDAwO1xuXG4gIC8qKlxuICAgKiBBZGRzIGEgbmV3IGFsZXJ0IHRvIHRoZSBjdXJyZW50IHN0YXRlLlxuICAgKi9cbiAgYWRkKGFsZXJ0OiBBbGVydCkge1xuICAgIHRoaXMuYWRkQWxlcnQoYWxlcnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBhbGVydCBieSB0ZXh0LlxuICAgKi9cbiAgYWRkQnlUZXh0KHR5cGU6IGFsZXJ0VHlwZSwgdHh0OiBzdHJpbmcsIGRldGFpbGVkRGF0YT86IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuYWRkQWxlcnQoeyB0ZXh0OiB0eHQsIHR5cGUsIGRldGFpbGVkRGF0YSB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFsbCBhbGVydHMuXG4gICAqIEBkZXByZWNhdGVkIFVzZSBhbGVydFNlcnZpY2UuYWxlcnRzIGluc3RlYWQuXG4gICAqL1xuICBsaXN0KCk6IEFsZXJ0W10ge1xuICAgIHJldHVybiB0aGlzLnN0YXRlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSBhbiBhbGVydCBmcm9tIHRoZSBjdXJyZW50IHN0YXRlLlxuICAgKi9cbiAgcmVtb3ZlKGFsZXJ0OiBBbGVydCkge1xuICAgIHRoaXMuY2hhbmdlQWxlcnRzKHRoaXMuc3RhdGUuZmlsdGVyKGl0ZW0gPT4gIXRoaXMuYXJlU2FtZShhbGVydCwgaXRlbSkpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGVzIG1hdGNoaW5nIGFsZXJ0IHdpdGggcHJvdmlkZWQgdmFsdWVzLlxuICAgKi9cbiAgdXBkYXRlKGFsZXJ0OiBBbGVydCwgZmllbGRzVG9VcGRhdGU6IFBhcnRpYWw8QWxlcnQ+KSB7XG4gICAgdGhpcy5jaGFuZ2VBbGVydHMoXG4gICAgICB0aGlzLnN0YXRlLm1hcChpdGVtID0+IHtcbiAgICAgICAgaWYgKHRoaXMuYXJlU2FtZShhbGVydCwgaXRlbSkpIHtcbiAgICAgICAgICBPYmplY3QuYXNzaWduKGl0ZW0sIGZpZWxkc1RvVXBkYXRlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIGxhc3QgZGFuZ2VyIGFsZXJ0LlxuICAgKiBJdCBjYW4gYmUgdXNlZCBlLmcuIGluIHRoZSBjYXNlIG9mIGEgZmFpbGVkIHJlcXVlc3Qgd2hpY2ggdHJpZ2dlcmVkIGFuIGFsZXJ0LCB0byBoaWRlIGl0IGZyb20gdXNlci5cbiAgICpcbiAgICogYGBganNcbiAgICogIHRyeSB7XG4gICAqICAgIC8vIHNvbWV0aGluZyB0aGF0IG1pZ2h0IHRocm93IGEgZGFuZ2VyIHNlcnZlciBtc2dcbiAgICogIH0gY2F0Y2ggKGV4KSB7XG4gICAqICAgdGhpcy5hbGVydFNlcnZpY2UucmVtb3ZlTGFzdERhbmdlcigpO1xuICAgKiAgfVxuICAgKiBgYGBcbiAgICovXG4gIHJlbW92ZUxhc3REYW5nZXIoKSB7XG4gICAgY29uc3QgZmlyc3REYW5nZXJBbGVydCA9IHRoaXMuc3RhdGUucmV2ZXJzZSgpLmZpbmQoKHsgdHlwZSB9KSA9PiB0eXBlID09PSAnZGFuZ2VyJyk7XG4gICAgdGhpcy5jaGFuZ2VBbGVydHModGhpcy5zdGF0ZS5maWx0ZXIoYWxlcnQgPT4gYWxlcnQgIT09IGZpcnN0RGFuZ2VyQWxlcnQpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTaG9ydGhhbmQgZm9yIGEgc2F2ZSBzdWNjZXNzZnVsIGFsZXJ0LlxuICAgKiBAcGFyYW0gc2F2ZWRPYmplY3QgVGhlIG9iamVjdCB3aGljaCB3YXMgc2F2ZWQuXG4gICAqIEByZXR1cm4gQSBmdW5jdGlvbiB0aGF0IGNhbiBiZSBleGVjdXRlZCB0byBzaG93IHRoZSBtc2cuXG4gICAqL1xuICBzYXZlU3VjY2VzcyhzYXZlZE9iamVjdDogc3RyaW5nKSB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNvbnN0IHRleHQgPSBgJHtzYXZlZE9iamVjdH0gc2F2ZWQgc3VjY2Vzc2Z1bGx5YDtcbiAgICAgIHRoaXMuYWRkQnlUZXh0KCdzdWNjZXNzJywgdGV4dCk7XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTaG9ydGhhbmQgZm9yIGEgY3JlYXRlIHN1Y2Nlc3NmdWwgYWxlcnQuXG4gICAqIEBwYXJhbSBjcmVhdGVkT2JqZWN0IFRoZSBvYmplY3Qgd2hpY2ggd2FzIGNyZWF0ZWQuXG4gICAqIEByZXR1cm4gQSBmdW5jdGlvbiB0aGF0IGNhbiBiZSBleGVjdXRlZCB0byBzaG93IHRoZSBtc2cuXG4gICAqL1xuICBjcmVhdGVTdWNjZXNzKGNyZWF0ZWRPYmplY3QpIHtcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY29uc3QgdGV4dCA9IGAke2NyZWF0ZWRPYmplY3R9IGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5YDtcbiAgICAgIHRoaXMuYWRkQnlUZXh0KCdzdWNjZXNzJywgdGV4dCk7XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhcnMgYWxsIGFsZXJ0cy5cbiAgICovXG4gIGNsZWFyQWxsKCkge1xuICAgIHRoaXMuY2hhbmdlQWxlcnRzKFtdKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBIHNob3J0aGFuZCB0byBkaXNwbGF5IGEgc2ltcGxlIHN1Y2Nlc3MgbWVzc2FnZS5cbiAgICogQHBhcmFtIHRleHQgVGhlIHN1Y2Nlc3MgdGV4dC5cbiAgICogQHBhcmFtIGRldGFpbGVkRGF0YSBUaGUgdGV4dCB3aXRoIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24uXG4gICAqL1xuICBzdWNjZXNzKHRleHQ6IHN0cmluZywgZGV0YWlsZWREYXRhPzogc3RyaW5nKSB7XG4gICAgdGhpcy5hZGRCeVRleHQoJ3N1Y2Nlc3MnLCB0ZXh0LCBkZXRhaWxlZERhdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgc2hvcnRoYW5kIHRvIGRpc3BsYXkgYSBzaW1wbGUgZGFuZ2VyIG1lc3NhZ2UuXG4gICAqIEBwYXJhbSB0ZXh0IFRoZSBkYW5nZXIgdGV4dC5cbiAgICogQHBhcmFtIGRldGFpbGVkRGF0YSBUaGUgdGV4dCB3aXRoIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24uXG4gICAqL1xuICBkYW5nZXIodGV4dDogc3RyaW5nLCBkZXRhaWxlZERhdGE/OiBzdHJpbmcpIHtcbiAgICB0aGlzLmFkZEJ5VGV4dCgnZGFuZ2VyJywgdGV4dCwgZGV0YWlsZWREYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBIHNob3J0aGFuZCB0byBkaXNwbGF5IGEgc2ltcGxlIGluZm8gbWVzc2FnZS5cbiAgICogQHBhcmFtIHRleHQgVGhlIGluZm8gdGV4dC5cbiAgICogQHBhcmFtIGRldGFpbGVkRGF0YSBUaGUgdGV4dCB3aXRoIGFkZGl0aW9uYWwgaW5mb3JtYXRpb24uXG4gICAqL1xuICBpbmZvKHRleHQ6IHN0cmluZywgZGV0YWlsZWREYXRhPzogc3RyaW5nKSB7XG4gICAgdGhpcy5hZGRCeVRleHQoJ2luZm8nLCB0ZXh0LCBkZXRhaWxlZERhdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgc2hvcnRoYW5kIHRvIGRpc3BsYXkgYSBzaW1wbGUgd2FybmluZyBtZXNzYWdlLlxuICAgKiBAcGFyYW0gdGV4dCBUaGUgd2FybmluZyB0ZXh0LlxuICAgKiBAcGFyYW0gZGV0YWlsZWREYXRhIFRoZSB0ZXh0IHdpdGggYWRkaXRpb25hbCBpbmZvcm1hdGlvbi5cbiAgICovXG4gIHdhcm5pbmcodGV4dDogc3RyaW5nLCBkZXRhaWxlZERhdGE/OiBzdHJpbmcpIHtcbiAgICB0aGlzLmFkZEJ5VGV4dCgnd2FybmluZycsIHRleHQsIGRldGFpbGVkRGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBhbGVydCBmcm9tIHN0YW5kYXJkIGFwaSBlcnJvcnMuXG4gICAqIFNob3VsZCBiZSB1c2VkIGZvciBlcnJvcnMgZ2VuZXJhdGVkIGJ5IEBjOHkvY2xpZW50IHNlcnZpY2VzLlxuICAgKiBAcGFyYW0ge0lSZXN1bHR9ICBlcnJvciBUaGUgZXJyb3IgZnJvbSBzZXJ2ZXIuXG4gICAqIEBwYXJhbSB7YWxlcnRUeXBlfSB0eXBlIFRoZSB0eXBlIG9mIGFsZXJ0LlxuICAgKi9cbiAgYWRkU2VydmVyRmFpbHVyZShlcnJvcjogYW55LCB0eXBlOiBhbGVydFR5cGUgPSAnZGFuZ2VyJykge1xuICAgIGNvbnN0IHsgZGF0YSwgcmVzIH0gPSBlcnJvcjtcbiAgICBsZXQgdGV4dCA9IGRhdGEgJiYgZGF0YS5tZXNzYWdlID8gZGF0YS5tZXNzYWdlIDogbnVsbDtcbiAgICBsZXQgZGV0YWlsZWREYXRhO1xuICAgIGlmIChkYXRhKSB7XG4gICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIGRldGFpbGVkRGF0YSA9IGRhdGEuZXhjZXB0aW9uTWVzc2FnZTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGRhdGEgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIGRldGFpbGVkRGF0YSA9IGRhdGE7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGhhc1JlbGV2YW50TWVzc2FnZSA9ICEhKHRleHQgfHwgZGV0YWlsZWREYXRhKTtcbiAgICBpZiAoIXRleHQpIHtcbiAgICAgIHRleHQgPSBnZXR0ZXh0KCdBIHNlcnZlciBlcnJvciBvY2N1cnJlZC4nKTtcbiAgICB9XG4gICAgaWYgKCFoYXNSZWxldmFudE1lc3NhZ2UpIHtcbiAgICAgIGRldGFpbGVkRGF0YSA9IHtcbiAgICAgICAgc3RhdHVzOiByZXMuc3RhdHVzLFxuICAgICAgICBzdGF0dXNUZXh0OiByZXMuc3RhdHVzVGV4dCxcbiAgICAgICAgdXJsOiByZXMudXJsXG4gICAgICB9O1xuICAgIH1cblxuICAgIHRoaXMuYWRkQWxlcnQoe1xuICAgICAgdHlwZSxcbiAgICAgIHRleHQsXG4gICAgICBkZXRhaWxlZERhdGFcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb21wYXJlcyB0d28gYWxlcnQgb2JqZWN0cy4gQWxlcnRzIGFyZSBzYW1lIGlmIHRleHQsIHR5cGUsIGRldGFpbGVkIGRhdGEgYW5kIGNhbGxiYWNrcyBhcmUgc2FtZS5cbiAgICogQ2FsbGJhY2tzIGFyZSBzYW1lIGlmIHRoZXkgcmVmZXIgdG8gdGhlIHNhbWUgZnVuY3Rpb24uXG4gICAqL1xuICBhcmVTYW1lKGFsZXJ0MTogQWxlcnQsIGFsZXJ0MjogQWxlcnQpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKFxuICAgICAgYWxlcnQxLnRleHQgPT09IGFsZXJ0Mi50ZXh0ICYmXG4gICAgICBhbGVydDEudHlwZSA9PT0gYWxlcnQyLnR5cGUgJiZcbiAgICAgIGFsZXJ0MS5kZXRhaWxlZERhdGEgPT09IGFsZXJ0Mi5kZXRhaWxlZERhdGEgJiZcbiAgICAgIGFsZXJ0MS5vbkNsb3NlID09PSBhbGVydDIub25DbG9zZSAmJlxuICAgICAgYWxlcnQxLm9uRGV0YWlsID09PSBhbGVydDIub25EZXRhaWxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGFuZ2VBbGVydHMobmV3QWxlcnRzOiBBbGVydFtdKSB7XG4gICAgdGhpcy5zdGF0ZSQubmV4dChuZXdBbGVydHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRBbGVydChhbGVydDogQWxlcnQpOiB2b2lkIHtcbiAgICBpZiAoIWFsZXJ0LnRleHQgJiYgIWFsZXJ0LnR5cGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGFkZCBlbXB0eSBhbGVydCcpO1xuICAgIH1cblxuICAgIGNvbnN0IGFsZXJ0QWxyZWFkeUFkZGVkID0gdGhpcy5zdGF0ZS5maW5kKGl0ZW0gPT4gdGhpcy5hcmVTYW1lKGFsZXJ0LCBpdGVtKSk7XG4gICAgaWYgKGFsZXJ0QWxyZWFkeUFkZGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5jaGFuZ2VBbGVydHMoWy4uLnRoaXMuc3RhdGUsIGFsZXJ0XSk7XG4gICAgdGhpcy5oaWRlQXV0b21hdGljYWxseUlmTmVlZGVkKGFsZXJ0KTtcbiAgICB0aGlzLnJlbW92ZU9sZGVzdElmTWF4KCk7XG4gIH1cblxuICBwcml2YXRlIGhpZGVBdXRvbWF0aWNhbGx5SWZOZWVkZWQoYWxlcnQ6IEFsZXJ0KSB7XG4gICAgY29uc3QgaXNTdWNjZXNzID0gYWxlcnQudHlwZSA9PT0gJ3N1Y2Nlc3MnO1xuICAgIGNvbnN0IG5vRGV0YWlscyA9ICFhbGVydC5kZXRhaWxlZERhdGE7XG4gICAgbGV0IGFsZXJ0VGltZW91dCA9IGlzU3VjY2VzcyAmJiBub0RldGFpbHMgPyB0aGlzLkFMRVJUX1RJTUVPVVQgOiAwO1xuICAgIGlmICh0eXBlb2YgYWxlcnQudGltZW91dCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGFsZXJ0VGltZW91dCA9IGFsZXJ0LnRpbWVvdXQ7XG4gICAgfVxuICAgIGlmIChhbGVydFRpbWVvdXQpIHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5yZW1vdmUoYWxlcnQpLCBhbGVydFRpbWVvdXQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlT2xkZXN0SWZNYXgoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUubGVuZ3RoID4gdGhpcy5NQVhfQUxFUlRTKSB7XG4gICAgICBjb25zdCBbLCAuLi5maXJzdFJlbW92ZWRdID0gdGhpcy5zdGF0ZTtcbiAgICAgIHRoaXMuY2hhbmdlQWxlcnRzKGZpcnN0UmVtb3ZlZCk7XG4gICAgfVxuICB9XG59XG4iXX0=