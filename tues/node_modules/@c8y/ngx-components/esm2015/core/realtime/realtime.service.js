import { coerceNumberProperty } from '@angular/cdk/coercion';
import { Subject } from 'rxjs';
import { filter, finalize, map } from 'rxjs/operators';
/**
 * A wrapper class for handling realtime notifications in RxJS fashion.
 */
export class RealtimeService {
    constructor(realtime) {
        this.realtime = realtime;
        this.subjects$ = new Map();
        this.isActive = true;
    }
    /**
     * A flag displaying if realtime notifications are currently active.
     */
    get active() {
        return this.isActive;
    }
    /**
     * Get an Observable of all realtime notifications.
     *
     * @param {string | number | IIdentified} entityOrId Entity object or id
     *
     * @returns An [[Observable]] of notifications wrapped as [[RealtimeMessage]]
     */
    onAll$(entityOrId) {
        const subject$ = this.getSubjectForChannel(entityOrId);
        return subject$.pipe(finalize(() => {
            if (subject$.observers.length === 1 && subject$.observers[0].closed) {
                subject$.stop();
                this.subjects$.delete(subject$.channel);
            }
        }));
    }
    /**
     * Subscribes again all realtime channels with active observers.
     */
    start() {
        if (!this.isActive) {
            this.subjects$.forEach(subject$ => {
                subject$.start();
            });
            this.isActive = true;
        }
    }
    /**
     * Stops realtime notifications and unsubscribes all realtime channels.
     */
    stop() {
        if (this.isActive) {
            this.subjects$.forEach(subject$ => {
                subject$.stop();
            });
            this.isActive = false;
        }
    }
    /**
     * Get an Observable of all CREATE realtime notifications.
     *
     * @returns An [[Observable]] of newly created entity objects.
     */
    onCreate$() {
        return this.onAll$().pipe(filter(msg => msg.realtimeAction === 'CREATE'), map(msg => msg.data));
    }
    /**
     * Get an Observable of all UPDATE realtime notifications.
     *
     * @param {string | number | IIdentified} entityOrId Entity object or id
     *
     * @returns An [[Observable]] of updated entity objects.
     */
    onUpdate$(entityOrId) {
        return this.onAll$(entityOrId).pipe(filter(msg => msg.realtimeAction === 'UPDATE'), map(msg => msg.data));
    }
    /**
     * Get an Observable of all DELETE realtime notifications.
     *
     * @param {string | number | IIdentified} entityOrId Entity object or id
     *
     * @returns An [[Observable]] of deleted entity objects.
     */
    onDelete$(entityOrId) {
        return this.onAll$(entityOrId).pipe(filter(msg => msg.realtimeAction === 'DELETE'), map(msg => coerceNumberProperty(msg.data)));
    }
    getIdString(reference) {
        let id;
        if (typeof reference === 'object') {
            id = reference.id;
        }
        else {
            id = reference;
        }
        return String(id);
    }
    getChannel(entityOrId) {
        return entityOrId ? this.channel().replace('*', this.getIdString(entityOrId)) : this.channel();
    }
    getSubjectForChannel(entityOrId) {
        const channel = this.getChannel(entityOrId);
        let subject$;
        if (this.subjects$.has(channel)) {
            subject$ = this.subjects$.get(channel);
        }
        else {
            subject$ = new RealtimeSubject(channel, this.realtime);
            this.subjects$.set(channel, subject$);
        }
        return subject$;
    }
}
// tslint:disable-next-line: max-classes-per-file
class RealtimeSubject extends Subject {
    constructor(realtimeChannel, realtime) {
        super();
        this.realtimeChannel = realtimeChannel;
        this.realtime = realtime;
        this.start();
    }
    get channel() {
        return this.realtimeChannel;
    }
    start() {
        if (!this.realtimeSubscription) {
            this.realtimeSubscription = this.realtime.subscribe(this.realtimeChannel, msg => {
                const data = {
                    channel: msg.channel,
                    data: msg.data.data,
                    id: msg.id,
                    realtimeAction: msg.data.realtimeAction
                };
                this.next(data);
            });
        }
    }
    stop() {
        if (this.realtimeSubscription) {
            this.realtime.unsubscribe(this.realtimeSubscription);
            this.realtimeSubscription = null;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhbHRpbWUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL3JlYWx0aW1lL3JlYWx0aW1lLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFN0QsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUd2RDs7R0FFRztBQUNILE1BQU0sT0FBZ0IsZUFBZTtJQVduQyxZQUFzQixRQUFrQjtRQUFsQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBSGhDLGNBQVMsR0FBb0MsSUFBSSxHQUFHLEVBQThCLENBQUM7UUFDbkYsYUFBUSxHQUFZLElBQUksQ0FBQztJQUVVLENBQUM7SUFWNUM7O09BRUc7SUFDSCxJQUFJLE1BQU07UUFDUixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdkIsQ0FBQztJQU9EOzs7Ozs7T0FNRztJQUNILE1BQU0sQ0FBQyxVQUEwQztRQUMvQyxNQUFNLFFBQVEsR0FBdUIsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRTNFLE9BQU8sUUFBUSxDQUFDLElBQUksQ0FDbEIsUUFBUSxDQUFDLEdBQUcsRUFBRTtZQUNaLElBQUksUUFBUSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFO2dCQUNuRSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2hCLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUN6QztRQUNILENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lB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WyJpbXBvcnQgeyBjb2VyY2VOdW1iZXJQcm9wZXJ0eSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9jb2VyY2lvbic7XG5pbXBvcnQgeyBJSWRlbnRpZmllZCwgUmVhbHRpbWUgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIGZpbmFsaXplLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBSZWFsdGltZU1lc3NhZ2UgfSBmcm9tICcuL3JlYWx0aW1lLm1vZGVsJztcblxuLyoqXG4gKiBBIHdyYXBwZXIgY2xhc3MgZm9yIGhhbmRsaW5nIHJlYWx0aW1lIG5vdGlmaWNhdGlvbnMgaW4gUnhKUyBmYXNoaW9uLlxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUmVhbHRpbWVTZXJ2aWNlPFQ+IHtcbiAgLyoqXG4gICAqIEEgZmxhZyBkaXNwbGF5aW5nIGlmIHJlYWx0aW1lIG5vdGlmaWNhdGlvbnMgYXJlIGN1cnJlbnRseSBhY3RpdmUuXG4gICAqL1xuICBnZXQgYWN0aXZlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmlzQWN0aXZlO1xuICB9XG5cbiAgcHJpdmF0ZSBzdWJqZWN0cyQ6IE1hcDxzdHJpbmcsIFJlYWx0aW1lU3ViamVjdDxUPj4gPSBuZXcgTWFwPHN0cmluZywgUmVhbHRpbWVTdWJqZWN0PFQ+PigpO1xuICBwcml2YXRlIGlzQWN0aXZlOiBib29sZWFuID0gdHJ1ZTtcblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgcmVhbHRpbWU6IFJlYWx0aW1lKSB7fVxuXG4gIC8qKlxuICAgKiBHZXQgYW4gT2JzZXJ2YWJsZSBvZiBhbGwgcmVhbHRpbWUgbm90aWZpY2F0aW9ucy5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmcgfCBudW1iZXIgfCBJSWRlbnRpZmllZH0gZW50aXR5T3JJZCBFbnRpdHkgb2JqZWN0IG9yIGlkXG4gICAqXG4gICAqIEByZXR1cm5zIEFuIFtbT2JzZXJ2YWJsZV1dIG9mIG5vdGlmaWNhdGlvbnMgd3JhcHBlZCBhcyBbW1JlYWx0aW1lTWVzc2FnZV1dXG4gICAqL1xuICBvbkFsbCQoZW50aXR5T3JJZD86IHN0cmluZyB8IG51bWJlciB8IElJZGVudGlmaWVkKTogT2JzZXJ2YWJsZTxSZWFsdGltZU1lc3NhZ2U8VD4+IHtcbiAgICBjb25zdCBzdWJqZWN0JDogUmVhbHRpbWVTdWJqZWN0PFQ+ID0gdGhpcy5nZXRTdWJqZWN0Rm9yQ2hhbm5lbChlbnRpdHlPcklkKTtcblxuICAgIHJldHVybiBzdWJqZWN0JC5waXBlKFxuICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICBpZiAoc3ViamVjdCQub2JzZXJ2ZXJzLmxlbmd0aCA9PT0gMSAmJiBzdWJqZWN0JC5vYnNlcnZlcnNbMF0uY2xvc2VkKSB7XG4gICAgICAgICAgc3ViamVjdCQuc3RvcCgpO1xuICAgICAgICAgIHRoaXMuc3ViamVjdHMkLmRlbGV0ZShzdWJqZWN0JC5jaGFubmVsKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFN1YnNjcmliZXMgYWdhaW4gYWxsIHJlYWx0aW1lIGNoYW5uZWxzIHdpdGggYWN0aXZlIG9ic2VydmVycy5cbiAgICovXG4gIHN0YXJ0KCkge1xuICAgIGlmICghdGhpcy5pc0FjdGl2ZSkge1xuICAgICAgdGhpcy5zdWJqZWN0cyQuZm9yRWFjaChzdWJqZWN0JCA9PiB7XG4gICAgICAgIHN1YmplY3QkLnN0YXJ0KCk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuaXNBY3RpdmUgPSB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9wcyByZWFsdGltZSBub3RpZmljYXRpb25zIGFuZCB1bnN1YnNjcmliZXMgYWxsIHJlYWx0aW1lIGNoYW5uZWxzLlxuICAgKi9cbiAgc3RvcCgpIHtcbiAgICBpZiAodGhpcy5pc0FjdGl2ZSkge1xuICAgICAgdGhpcy5zdWJqZWN0cyQuZm9yRWFjaChzdWJqZWN0JCA9PiB7XG4gICAgICAgIHN1YmplY3QkLnN0b3AoKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmlzQWN0aXZlID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhbiBPYnNlcnZhYmxlIG9mIGFsbCBDUkVBVEUgcmVhbHRpbWUgbm90aWZpY2F0aW9ucy5cbiAgICpcbiAgICogQHJldHVybnMgQW4gW1tPYnNlcnZhYmxlXV0gb2YgbmV3bHkgY3JlYXRlZCBlbnRpdHkgb2JqZWN0cy5cbiAgICovXG4gIG9uQ3JlYXRlJCgpOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICByZXR1cm4gdGhpcy5vbkFsbCQoKS5waXBlKFxuICAgICAgZmlsdGVyKG1zZyA9PiBtc2cucmVhbHRpbWVBY3Rpb24gPT09ICdDUkVBVEUnKSxcbiAgICAgIG1hcChtc2cgPT4gbXNnLmRhdGEgYXMgVClcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhbiBPYnNlcnZhYmxlIG9mIGFsbCBVUERBVEUgcmVhbHRpbWUgbm90aWZpY2F0aW9ucy5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmcgfCBudW1iZXIgfCBJSWRlbnRpZmllZH0gZW50aXR5T3JJZCBFbnRpdHkgb2JqZWN0IG9yIGlkXG4gICAqXG4gICAqIEByZXR1cm5zIEFuIFtbT2JzZXJ2YWJsZV1dIG9mIHVwZGF0ZWQgZW50aXR5IG9iamVjdHMuXG4gICAqL1xuICBvblVwZGF0ZSQoZW50aXR5T3JJZD86IHN0cmluZyB8IG51bWJlciB8IElJZGVudGlmaWVkKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgcmV0dXJuIHRoaXMub25BbGwkKGVudGl0eU9ySWQpLnBpcGUoXG4gICAgICBmaWx0ZXIobXNnID0+IG1zZy5yZWFsdGltZUFjdGlvbiA9PT0gJ1VQREFURScpLFxuICAgICAgbWFwKG1zZyA9PiBtc2cuZGF0YSBhcyBUKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFuIE9ic2VydmFibGUgb2YgYWxsIERFTEVURSByZWFsdGltZSBub3RpZmljYXRpb25zLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZyB8IG51bWJlciB8IElJZGVudGlmaWVkfSBlbnRpdHlPcklkIEVudGl0eSBvYmplY3Qgb3IgaWRcbiAgICpcbiAgICogQHJldHVybnMgQW4gW1tPYnNlcnZhYmxlXV0gb2YgZGVsZXRlZCBlbnRpdHkgb2JqZWN0cy5cbiAgICovXG4gIG9uRGVsZXRlJChlbnRpdHlPcklkPzogc3RyaW5nIHwgbnVtYmVyIHwgSUlkZW50aWZpZWQpOiBPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgIHJldHVybiB0aGlzLm9uQWxsJChlbnRpdHlPcklkKS5waXBlKFxuICAgICAgZmlsdGVyKG1zZyA9PiBtc2cucmVhbHRpbWVBY3Rpb24gPT09ICdERUxFVEUnKSxcbiAgICAgIG1hcChtc2cgPT4gY29lcmNlTnVtYmVyUHJvcGVydHkobXNnLmRhdGEpKVxuICAgICk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0SWRTdHJpbmcocmVmZXJlbmNlOiBudW1iZXIgfCBzdHJpbmcgfCBJSWRlbnRpZmllZCk6IHN0cmluZyB7XG4gICAgbGV0IGlkOiBzdHJpbmcgfCBudW1iZXI7XG4gICAgaWYgKHR5cGVvZiByZWZlcmVuY2UgPT09ICdvYmplY3QnKSB7XG4gICAgICBpZCA9IHJlZmVyZW5jZS5pZDtcbiAgICB9IGVsc2Uge1xuICAgICAgaWQgPSByZWZlcmVuY2U7XG4gICAgfVxuICAgIHJldHVybiBTdHJpbmcoaWQpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldENoYW5uZWwoZW50aXR5T3JJZD86IHN0cmluZyB8IG51bWJlciB8IElJZGVudGlmaWVkKSB7XG4gICAgcmV0dXJuIGVudGl0eU9ySWQgPyB0aGlzLmNoYW5uZWwoKS5yZXBsYWNlKCcqJywgdGhpcy5nZXRJZFN0cmluZyhlbnRpdHlPcklkKSkgOiB0aGlzLmNoYW5uZWwoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBjaGFubmVsKCk6IHN0cmluZztcblxuICBwcml2YXRlIGdldFN1YmplY3RGb3JDaGFubmVsKGVudGl0eU9ySWQ/OiBzdHJpbmcgfCBudW1iZXIgfCBJSWRlbnRpZmllZCk6IFJlYWx0aW1lU3ViamVjdDxUPiB7XG4gICAgY29uc3QgY2hhbm5lbDogc3RyaW5nID0gdGhpcy5nZXRDaGFubmVsKGVudGl0eU9ySWQpO1xuICAgIGxldCBzdWJqZWN0JDogUmVhbHRpbWVTdWJqZWN0PFQ+O1xuICAgIGlmICh0aGlzLnN1YmplY3RzJC5oYXMoY2hhbm5lbCkpIHtcbiAgICAgIHN1YmplY3QkID0gdGhpcy5zdWJqZWN0cyQuZ2V0KGNoYW5uZWwpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdWJqZWN0JCA9IG5ldyBSZWFsdGltZVN1YmplY3QoY2hhbm5lbCwgdGhpcy5yZWFsdGltZSk7XG4gICAgICB0aGlzLnN1YmplY3RzJC5zZXQoY2hhbm5lbCwgc3ViamVjdCQpO1xuICAgIH1cblxuICAgIHJldHVybiBzdWJqZWN0JDtcbiAgfVxufVxuXG4vLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1jbGFzc2VzLXBlci1maWxlXG5jbGFzcyBSZWFsdGltZVN1YmplY3Q8VD4gZXh0ZW5kcyBTdWJqZWN0PFJlYWx0aW1lTWVzc2FnZTxUPj4ge1xuICByZWFsdGltZVN1YnNjcmlwdGlvbjogb2JqZWN0O1xuICBnZXQgY2hhbm5lbCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnJlYWx0aW1lQ2hhbm5lbDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhbHRpbWVDaGFubmVsOiBzdHJpbmcsIHByaXZhdGUgcmVhbHRpbWU6IFJlYWx0aW1lKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnN0YXJ0KCk7XG4gIH1cblxuICBzdGFydCgpIHtcbiAgICBpZiAoIXRoaXMucmVhbHRpbWVTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMucmVhbHRpbWVTdWJzY3JpcHRpb24gPSB0aGlzLnJlYWx0aW1lLnN1YnNjcmliZSh0aGlzLnJlYWx0aW1lQ2hhbm5lbCwgbXNnID0+IHtcbiAgICAgICAgY29uc3QgZGF0YTogUmVhbHRpbWVNZXNzYWdlPFQ+ID0ge1xuICAgICAgICAgIGNoYW5uZWw6IG1zZy5jaGFubmVsLFxuICAgICAgICAgIGRhdGE6IG1zZy5kYXRhLmRhdGEsXG4gICAgICAgICAgaWQ6IG1zZy5pZCxcbiAgICAgICAgICByZWFsdGltZUFjdGlvbjogbXNnLmRhdGEucmVhbHRpbWVBY3Rpb25cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5uZXh0KGRhdGEpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgc3RvcCgpIHtcbiAgICBpZiAodGhpcy5yZWFsdGltZVN1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5yZWFsdGltZS51bnN1YnNjcmliZSh0aGlzLnJlYWx0aW1lU3Vic2NyaXB0aW9uKTtcbiAgICAgIHRoaXMucmVhbHRpbWVTdWJzY3JpcHRpb24gPSBudWxsO1xuICAgIH1cbiAgfVxufVxuIl19