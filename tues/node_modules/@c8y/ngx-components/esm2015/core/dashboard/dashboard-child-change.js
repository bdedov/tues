import { sortBy } from 'lodash-es';
import { pipe } from 'rxjs';
import { distinctUntilChanged, expand, filter, map, tap } from 'rxjs/operators';
export class DashboardChildChange {
    constructor(childToChange) {
        this.MIN_WIDTH = 2;
        this.MIN_HEIGHT = 1;
        this.PIXEL_SIZE_THRESHOLD = 10;
        this.diffX = 0;
        this.diffY = 0;
        this.dashboard = childToChange.dashboard;
        this.children = childToChange.dashboard.children
            ? childToChange.dashboard.children.filter(child => childToChange !== child)
            : [];
        this.child = childToChange;
    }
    get resize$() {
        return this.child.dragSource.moved.pipe(map(move => this.getPixelSize(move)), tap(resizeDimension => this.setPixelSize(resizeDimension)), map(resizeDimension => this.getDimensionSize(resizeDimension)), distinctUntilChanged((prev, next) => prev.width === next.width && prev.height === next.height), map(dimension => this.setDimension(dimension)), this.arrangePipe());
    }
    get drag$() {
        return this.child.dragSource.moved.pipe(map(move => this.getDimensionPosition(move)), filter(dimension => dimension.x >= 0 &&
            dimension.x <= this.dashboard.columns - this.child.width &&
            dimension.y >= 0), distinctUntilChanged((prev, next) => prev.x === next.x && prev.y === next.y), this.arrangePipe());
    }
    findFreeDimension() {
        let y = -1;
        let x = 0;
        let found = false;
        const { width, height } = this.child;
        if (width > this.dashboard.columns) {
            throw new Error('The child does not fit on the current dashboard.');
        }
        do {
            x = 0;
            y++;
            while (x + width <= this.dashboard.columns) {
                if (this.getCollided({ x, y, width, height }).length === 0) {
                    found = true;
                    break;
                }
                x++;
            }
        } while (!found);
        return { x, y, width, height };
    }
    collapseUpAll() {
        return sortBy([this.child, ...this.children], ['y']).forEach(w => {
            const ds = new DashboardChildChange(w);
            const newPosition = ds.collapseUp(w);
            ds.setDimension(newPosition);
        });
    }
    arrangeAll(arrange) {
        const { current, scan, spacing, origin } = arrange;
        const collided = this.getCollided(current, sortBy(scan, ['y']));
        return collided.map(child => {
            const ds = new DashboardChildChange(child);
            ds.setDimension(Object.assign({}, child, { y: spacing }));
            return {
                current: child,
                scan: scan.filter(w => w !== child),
                spacing: child.y + child.height,
                origin
            };
        });
    }
    arrangePipe() {
        return pipe(map((dimension) => ({
            current: dimension,
            scan: this.children,
            spacing: dimension.y + dimension.height,
            origin: Object.assign({}, dimension)
        })), expand((dimensions) => this.arrangeAll(dimensions)), map(({ origin }) => origin), map(dimension => this.setDimension(dimension, true)), tap(() => this.collapseUpAll()), tap(() => this.dashboard.getLastRow()));
    }
    collapseUp(dimension) {
        let { y } = dimension;
        while (y > 0) {
            if (this.getCollided(Object.assign({}, dimension, { y: y - 1 })).length !== 0) {
                break;
            }
            y--;
        }
        return Object.assign({}, dimension, { y });
    }
    setDimension(dimension, notIfColliding = false) {
        if (notIfColliding && this.getCollided(dimension).length > 0) {
            return;
        }
        this.child.x = dimension.x;
        this.child.y = dimension.y;
        if (dimension.width >= this.MIN_WIDTH &&
            dimension.x + dimension.width <= this.dashboard.columns) {
            this.child.width = dimension.width;
        }
        else if (dimension.width < this.MIN_WIDTH) {
            dimension.width = this.MIN_WIDTH;
        }
        else {
            dimension.width = this.dashboard.columns - dimension.x;
        }
        if (dimension.height >= this.MIN_HEIGHT) {
            this.child.height = dimension.height;
        }
        else {
            dimension.height = this.MIN_WIDTH;
        }
        return dimension;
    }
    setPixelSize({ width, height }) {
        if (width >= this.dashboard.columnSize * this.MIN_WIDTH - this.dashboard.gap) {
            this.child.pxWidth = width + this.PIXEL_SIZE_THRESHOLD;
        }
        if (height >= this.dashboard.rowSize * this.MIN_HEIGHT - this.dashboard.gap) {
            this.child.pxHeight = height + this.PIXEL_SIZE_THRESHOLD;
        }
    }
    getPixelSize(moveEvent) {
        const draggedElement = moveEvent.source.element.nativeElement.parentNode;
        if (!this.diffX) {
            const rect = draggedElement.getBoundingClientRect();
            this.diffX = rect.left;
            this.diffY = rect.top;
        }
        const { x, y } = moveEvent.pointerPosition;
        const width = Math.round(x - this.diffX);
        const height = Math.round(y - this.diffY);
        return { width, height, pointer: { x, y } };
    }
    getDimensionSize(resizePosition) {
        const { x, y } = this.child;
        const ds = this.dashboard.dashboardRect;
        const column = this.dashboard.columnSize;
        const row = this.dashboard.rowSize + this.dashboard.gap;
        const width = Math.round((resizePosition.pointer.x - ds.left + this.dashboard.gap) / column) - x;
        const height = Math.round((resizePosition.pointer.y - ds.top + this.dashboard.gap) / row) - y;
        return { x, y, width, height };
    }
    getDimensionPosition(moveEvent) {
        const draggedElement = moveEvent.source.element.nativeElement.nextElementSibling;
        if (!this.diffX) {
            const rect = draggedElement.getBoundingClientRect();
            this.diffX = moveEvent.pointerPosition.x - rect.left;
            this.diffY = moveEvent.pointerPosition.y - rect.top;
        }
        const left = moveEvent.pointerPosition.x - this.diffX;
        const top = moveEvent.pointerPosition.y - this.diffY;
        const { width, height } = this.child;
        const ds = this.dashboard.dashboardRect;
        const column = this.dashboard.columnSize;
        const row = this.dashboard.rowSize + this.dashboard.gap / 2;
        const x = Math.round((left - ds.left) / column);
        const y = Math.round((top - ds.top) / row);
        return { x, y, width, height };
    }
    doesCollide(a, b) {
        if (b.x === undefined) {
            return false;
        }
        return !(a.y + a.height - 1 < b.y ||
            a.y > b.y + b.height - 1 ||
            a.x + a.width - 1 < b.x ||
            a.x > b.x + b.width - 1);
    }
    getCollided(currentDimension, dimensions = this.children) {
        const collided = dimensions.filter(dimension => this.doesCollide(currentDimension, dimension));
        return collided;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzaGJvYXJkLWNoaWxkLWNoYW5nZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2Rhc2hib2FyZC9kYXNoYm9hcmQtY2hpbGQtY2hhbmdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbkMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1QixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFTaEYsTUFBTSxPQUFPLG9CQUFvQjtJQVkvQixZQUFZLGFBQXNDO1FBUGpDLGNBQVMsR0FBRyxDQUFDLENBQUM7UUFDdkIsZUFBVSxHQUFHLENBQUMsQ0FBQztRQUNOLHlCQUFvQixHQUFHLEVBQUUsQ0FBQztRQUVuQyxVQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQ1YsVUFBSyxHQUFHLENBQUMsQ0FBQztRQUdoQixJQUFJLENBQUMsU0FBUyxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUM7UUFDekMsSUFBSSxDQUFDLFFBQVEsR0FBRyxhQUFhLENBQUMsU0FBUyxDQUFDLFFBQVE7WUFDOUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLGFBQWEsS0FBSyxLQUFLLENBQUM7WUFDM0UsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUNQLElBQUksQ0FBQyxLQUFLLEdBQUcsYUFBYSxDQUFDO0lBQzdCLENBQUM7SUFFRCxJQUFJLE9BQU87UUFDVCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQ3JDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxD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Q0FBQyxRQUFRO1FBQ3ZGLE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDL0YsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2RrRHJhZ01vdmUgfSBmcm9tICdAYW5ndWxhci9jZGsvZHJhZy1kcm9wJztcbmltcG9ydCB7IHNvcnRCeSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBwaXBlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgZXhwYW5kLCBmaWx0ZXIsIG1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRGFzaGJvYXJkQ29tcG9uZW50IH0gZnJvbSAnLi9kYXNoYm9hcmQuY29tcG9uZW50JztcbmltcG9ydCB7XG4gIERhc2hib2FyZENoaWxkRGltZW5zaW9uLFxuICBEYXNoYm9hcmRDaGlsZFJlc2l6ZURpbWVuc2lvbixcbiAgRGFzaGJvYXJkQ2hpbGRBcnJhbmdlbWVudFxufSBmcm9tICcuL2Rhc2hib2FyZC5tb2RlbCc7XG5pbXBvcnQgeyBEYXNoYm9hcmRDaGlsZENvbXBvbmVudCB9IGZyb20gJy4vZGFzaGJvYXJkLWNoaWxkLmNvbXBvbmVudCc7XG5cbmV4cG9ydCBjbGFzcyBEYXNoYm9hcmRDaGlsZENoYW5nZSB7XG4gIGNoaWxkOiBEYXNoYm9hcmRDaGlsZENvbXBvbmVudDtcbiAgY2hpbGRyZW46IERhc2hib2FyZENoaWxkQ29tcG9uZW50W107XG4gIHByaXZhdGUgZGFzaGJvYXJkOiBEYXNoYm9hcmRDb21wb25lbnQ7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBNSU5fV0lEVEggPSAyO1xuICBwcml2YXRlIE1JTl9IRUlHSFQgPSAxO1xuICBwcml2YXRlIHJlYWRvbmx5IFBJWEVMX1NJWkVfVEhSRVNIT0xEID0gMTA7XG5cbiAgcHJpdmF0ZSBkaWZmWCA9IDA7XG4gIHByaXZhdGUgZGlmZlkgPSAwO1xuXG4gIGNvbnN0cnVjdG9yKGNoaWxkVG9DaGFuZ2U6IERhc2hib2FyZENoaWxkQ29tcG9uZW50KSB7XG4gICAgdGhpcy5kYXNoYm9hcmQgPSBjaGlsZFRvQ2hhbmdlLmRhc2hib2FyZDtcbiAgICB0aGlzLmNoaWxkcmVuID0gY2hpbGRUb0NoYW5nZS5kYXNoYm9hcmQuY2hpbGRyZW5cbiAgICAgID8gY2hpbGRUb0NoYW5nZS5kYXNoYm9hcmQuY2hpbGRyZW4uZmlsdGVyKGNoaWxkID0+IGNoaWxkVG9DaGFuZ2UgIT09IGNoaWxkKVxuICAgICAgOiBbXTtcbiAgICB0aGlzLmNoaWxkID0gY2hpbGRUb0NoYW5nZTtcbiAgfVxuXG4gIGdldCByZXNpemUkKCkge1xuICAgIHJldHVybiB0aGlzLmNoaWxkLmRyYWdTb3VyY2UubW92ZWQucGlwZShcbiAgICAgIG1hcChtb3ZlID0+IHRoaXMuZ2V0UGl4ZWxTaXplKG1vdmUpKSxcbiAgICAgIHRhcChyZXNpemVEaW1lbnNpb24gPT4gdGhpcy5zZXRQaXhlbFNpemUocmVzaXplRGltZW5zaW9uKSksXG4gICAgICBtYXAocmVzaXplRGltZW5zaW9uID0+IHRoaXMuZ2V0RGltZW5zaW9uU2l6ZShyZXNpemVEaW1lbnNpb24pKSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKFxuICAgICAgICAocHJldiwgbmV4dCkgPT4gcHJldi53aWR0aCA9PT0gbmV4dC53aWR0aCAmJiBwcmV2LmhlaWdodCA9PT0gbmV4dC5oZWlnaHRcbiAgICAgICksXG4gICAgICBtYXAoZGltZW5zaW9uID0+IHRoaXMuc2V0RGltZW5zaW9uKGRpbWVuc2lvbikpLFxuICAgICAgdGhpcy5hcnJhbmdlUGlwZSgpXG4gICAgKTtcbiAgfVxuXG4gIGdldCBkcmFnJCgpIHtcbiAgICByZXR1cm4gdGhpcy5jaGlsZC5kcmFnU291cmNlLm1vdmVkLnBpcGUoXG4gICAgICBtYXAobW92ZSA9PiB0aGlzLmdldERpbWVuc2lvblBvc2l0aW9uKG1vdmUpKSxcbiAgICAgIGZpbHRlcihcbiAgICAgICAgZGltZW5zaW9uID0+XG4gICAgICAgICAgZGltZW5zaW9uLnggPj0gMCAmJlxuICAgICAgICAgIGRpbWVuc2lvbi54IDw9IHRoaXMuZGFzaGJvYXJkLmNvbHVtbnMgLSB0aGlzLmNoaWxkLndpZHRoICYmXG4gICAgICAgICAgZGltZW5zaW9uLnkgPj0gMFxuICAgICAgKSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKChwcmV2LCBuZXh0KSA9PiBwcmV2LnggPT09IG5leHQueCAmJiBwcmV2LnkgPT09IG5leHQueSksXG4gICAgICB0aGlzLmFycmFuZ2VQaXBlKClcbiAgICApO1xuICB9XG5cbiAgZmluZEZyZWVEaW1lbnNpb24oKSB7XG4gICAgbGV0IHkgPSAtMTtcbiAgICBsZXQgeCA9IDA7XG4gICAgbGV0IGZvdW5kID0gZmFsc2U7XG4gICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSB0aGlzLmNoaWxkO1xuICAgIGlmICh3aWR0aCA+IHRoaXMuZGFzaGJvYXJkLmNvbHVtbnMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIGNoaWxkIGRvZXMgbm90IGZpdCBvbiB0aGUgY3VycmVudCBkYXNoYm9hcmQuJyk7XG4gICAgfVxuICAgIGRvIHtcbiAgICAgIHggPSAwO1xuICAgICAgeSsrO1xuICAgICAgd2hpbGUgKHggKyB3aWR0aCA8PSB0aGlzLmRhc2hib2FyZC5jb2x1bW5zKSB7XG4gICAgICAgIGlmICh0aGlzLmdldENvbGxpZGVkKHsgeCwgeSwgd2lkdGgsIGhlaWdodCB9KS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgeCsrO1xuICAgICAgfVxuICAgIH0gd2hpbGUgKCFmb3VuZCk7XG4gICAgcmV0dXJuIHsgeCwgeSwgd2lkdGgsIGhlaWdodCB9IGFzIERhc2hib2FyZENoaWxkRGltZW5zaW9uO1xuICB9XG5cbiAgY29sbGFwc2VVcEFsbCgpOiB2b2lkIHtcbiAgICByZXR1cm4gc29ydEJ5KFt0aGlzLmNoaWxkLCAuLi50aGlzLmNoaWxkcmVuXSwgWyd5J10pLmZvckVhY2godyA9PiB7XG4gICAgICBjb25zdCBkcyA9IG5ldyBEYXNoYm9hcmRDaGlsZENoYW5nZSh3KTtcbiAgICAgIGNvbnN0IG5ld1Bvc2l0aW9uID0gZHMuY29sbGFwc2VVcCh3KTtcbiAgICAgIGRzLnNldERpbWVuc2lvbihuZXdQb3NpdGlvbik7XG4gICAgfSk7XG4gIH1cblxuICBhcnJhbmdlQWxsKGFycmFuZ2U6IERhc2hib2FyZENoaWxkQXJyYW5nZW1lbnQpIHtcbiAgICBjb25zdCB7IGN1cnJlbnQsIHNjYW4sIHNwYWNpbmcsIG9yaWdpbiB9ID0gYXJyYW5nZTtcbiAgICBjb25zdCBjb2xsaWRlZCA9IHRoaXMuZ2V0Q29sbGlkZWQoY3VycmVudCwgc29ydEJ5KHNjYW4sIFsneSddKSk7XG4gICAgcmV0dXJuIGNvbGxpZGVkLm1hcChjaGlsZCA9PiB7XG4gICAgICBjb25zdCBkcyA9IG5ldyBEYXNoYm9hcmRDaGlsZENoYW5nZShjaGlsZCk7XG4gICAgICBkcy5zZXREaW1lbnNpb24oeyAuLi5jaGlsZCwgeTogc3BhY2luZyB9KTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGN1cnJlbnQ6IGNoaWxkLFxuICAgICAgICBzY2FuOiBzY2FuLmZpbHRlcih3ID0+IHcgIT09IGNoaWxkKSxcbiAgICAgICAgc3BhY2luZzogY2hpbGQueSArIGNoaWxkLmhlaWdodCxcbiAgICAgICAgb3JpZ2luXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhcnJhbmdlUGlwZSgpIHtcbiAgICByZXR1cm4gcGlwZShcbiAgICAgIG1hcChcbiAgICAgICAgKGRpbWVuc2lvbjogRGFzaGJvYXJkQ2hpbGREaW1lbnNpb24pID0+XG4gICAgICAgICAgKHtcbiAgICAgICAgICAgIGN1cnJlbnQ6IGRpbWVuc2lvbixcbiAgICAgICAgICAgIHNjYW46IHRoaXMuY2hpbGRyZW4sXG4gICAgICAgICAgICBzcGFjaW5nOiBkaW1lbnNpb24ueSArIGRpbWVuc2lvbi5oZWlnaHQsXG4gICAgICAgICAgICBvcmlnaW46IHsgLi4uZGltZW5zaW9uIH1cbiAgICAgICAgICB9IGFzIERhc2hib2FyZENoaWxkQXJyYW5nZW1lbnQpXG4gICAgICApLFxuICAgICAgZXhwYW5kKChkaW1lbnNpb25zOiBEYXNoYm9hcmRDaGlsZEFycmFuZ2VtZW50KSA9PiB0aGlzLmFycmFuZ2VBbGwoZGltZW5zaW9ucykpLFxuICAgICAgbWFwKCh7IG9yaWdpbiB9KSA9PiBvcmlnaW4pLFxuICAgICAgbWFwKGRpbWVuc2lvbiA9PiB0aGlzLnNldERpbWVuc2lvbihkaW1lbnNpb24sIHRydWUpKSxcbiAgICAgIHRhcCgoKSA9PiB0aGlzLmNvbGxhcHNlVXBBbGwoKSksXG4gICAgICB0YXAoKCkgPT4gdGhpcy5kYXNoYm9hcmQuZ2V0TGFzdFJvdygpKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNvbGxhcHNlVXAoZGltZW5zaW9uOiBEYXNoYm9hcmRDaGlsZERpbWVuc2lvbikge1xuICAgIGxldCB7IHkgfSA9IGRpbWVuc2lvbjtcbiAgICB3aGlsZSAoeSA+IDApIHtcbiAgICAgIGlmICh0aGlzLmdldENvbGxpZGVkKHsgLi4uZGltZW5zaW9uLCB5OiB5IC0gMSB9KS5sZW5ndGggIT09IDApIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICB5LS07XG4gICAgfVxuICAgIHJldHVybiB7IC4uLmRpbWVuc2lvbiwgeSB9O1xuICB9XG5cbiAgcHJpdmF0ZSBzZXREaW1lbnNpb24oZGltZW5zaW9uOiBEYXNoYm9hcmRDaGlsZERpbWVuc2lvbiwgbm90SWZDb2xsaWRpbmcgPSBmYWxzZSkge1xuICAgIGlmIChub3RJZkNvbGxpZGluZyAmJiB0aGlzLmdldENvbGxpZGVkKGRpbWVuc2lvbikubGVuZ3RoID4gMCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuY2hpbGQueCA9IGRpbWVuc2lvbi54O1xuICAgIHRoaXMuY2hpbGQueSA9IGRpbWVuc2lvbi55O1xuICAgIGlmIChcbiAgICAgIGRpbWVuc2lvbi53aWR0aCA+PSB0aGlzLk1JTl9XSURUSCAmJlxuICAgICAgZGltZW5zaW9uLnggKyBkaW1lbnNpb24ud2lkdGggPD0gdGhpcy5kYXNoYm9hcmQuY29sdW1uc1xuICAgICkge1xuICAgICAgdGhpcy5jaGlsZC53aWR0aCA9IGRpbWVuc2lvbi53aWR0aDtcbiAgICB9IGVsc2UgaWYgKGRpbWVuc2lvbi53aWR0aCA8IHRoaXMuTUlOX1dJRFRIKSB7XG4gICAgICBkaW1lbnNpb24ud2lkdGggPSB0aGlzLk1JTl9XSURUSDtcbiAgICB9IGVsc2Uge1xuICAgICAgZGltZW5zaW9uLndpZHRoID0gdGhpcy5kYXNoYm9hcmQuY29sdW1ucyAtIGRpbWVuc2lvbi54O1xuICAgIH1cbiAgICBpZiAoZGltZW5zaW9uLmhlaWdodCA+PSB0aGlzLk1JTl9IRUlHSFQpIHtcbiAgICAgIHRoaXMuY2hpbGQuaGVpZ2h0ID0gZGltZW5zaW9uLmhlaWdodDtcbiAgICB9IGVsc2Uge1xuICAgICAgZGltZW5zaW9uLmhlaWdodCA9IHRoaXMuTUlOX1dJRFRIO1xuICAgIH1cbiAgICByZXR1cm4gZGltZW5zaW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRQaXhlbFNpemUoeyB3aWR0aCwgaGVpZ2h0IH0pIHtcbiAgICBpZiAod2lkdGggPj0gdGhpcy5kYXNoYm9hcmQuY29sdW1uU2l6ZSAqIHRoaXMuTUlOX1dJRFRIIC0gdGhpcy5kYXNoYm9hcmQuZ2FwKSB7XG4gICAgICB0aGlzLmNoaWxkLnB4V2lkdGggPSB3aWR0aCArIHRoaXMuUElYRUxfU0laRV9USFJFU0hPTEQ7XG4gICAgfVxuICAgIGlmIChoZWlnaHQgPj0gdGhpcy5kYXNoYm9hcmQucm93U2l6ZSAqIHRoaXMuTUlOX0hFSUdIVCAtIHRoaXMuZGFzaGJvYXJkLmdhcCkge1xuICAgICAgdGhpcy5jaGlsZC5weEhlaWdodCA9IGhlaWdodCArIHRoaXMuUElYRUxfU0laRV9USFJFU0hPTEQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRQaXhlbFNpemUobW92ZUV2ZW50OiBDZGtEcmFnTW92ZSkge1xuICAgIGNvbnN0IGRyYWdnZWRFbGVtZW50ID0gbW92ZUV2ZW50LnNvdXJjZS5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQucGFyZW50Tm9kZSBhcyBIVE1MRWxlbWVudDtcbiAgICBpZiAoIXRoaXMuZGlmZlgpIHtcbiAgICAgIGNvbnN0IHJlY3QgPSBkcmFnZ2VkRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgIHRoaXMuZGlmZlggPSAgcmVjdC5sZWZ0O1xuICAgICAgdGhpcy5kaWZmWSA9ICByZWN0LnRvcDtcbiAgICB9XG4gICAgY29uc3QgeyB4LCB5IH0gPSBtb3ZlRXZlbnQucG9pbnRlclBvc2l0aW9uO1xuICAgIGNvbnN0IHdpZHRoID0gTWF0aC5yb3VuZCh4IC0gdGhpcy5kaWZmWCk7XG4gICAgY29uc3QgaGVpZ2h0ID0gTWF0aC5yb3VuZCh5IC0gdGhpcy5kaWZmWSk7XG4gICAgcmV0dXJuIHsgd2lkdGgsIGhlaWdodCwgcG9pbnRlcjogeyB4LCB5IH0gfSBhcyBEYXNoYm9hcmRDaGlsZFJlc2l6ZURpbWVuc2lvbjtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGltZW5zaW9uU2l6ZShyZXNpemVQb3NpdGlvbjogRGFzaGJvYXJkQ2hpbGRSZXNpemVEaW1lbnNpb24pIHtcbiAgICBjb25zdCB7IHgsIHkgfSA9IHRoaXMuY2hpbGQ7XG4gICAgY29uc3QgZHMgPSB0aGlzLmRhc2hib2FyZC5kYXNoYm9hcmRSZWN0O1xuICAgIGNvbnN0IGNvbHVtbiA9IHRoaXMuZGFzaGJvYXJkLmNvbHVtblNpemU7XG4gICAgY29uc3Qgcm93ID0gdGhpcy5kYXNoYm9hcmQucm93U2l6ZSArIHRoaXMuZGFzaGJvYXJkLmdhcDtcbiAgICBjb25zdCB3aWR0aCA9XG4gICAgICBNYXRoLnJvdW5kKChyZXNpemVQb3NpdGlvbi5wb2ludGVyLnggLSBkcy5sZWZ0ICsgdGhpcy5kYXNoYm9hcmQuZ2FwKSAvIGNvbHVtbikgLSB4O1xuICAgIGNvbnN0IGhlaWdodCA9IE1hdGgucm91bmQoKHJlc2l6ZVBvc2l0aW9uLnBvaW50ZXIueSAtIGRzLnRvcCArIHRoaXMuZGFzaGJvYXJkLmdhcCkgLyByb3cpIC0geTtcbiAgICByZXR1cm4geyB4LCB5LCB3aWR0aCwgaGVpZ2h0IH0gYXMgRGFzaGJvYXJkQ2hpbGREaW1lbnNpb247XG4gIH1cblxuICBwcml2YXRlIGdldERpbWVuc2lvblBvc2l0aW9uKG1vdmVFdmVudDogQ2RrRHJhZ01vdmUpIHtcbiAgICBjb25zdCBkcmFnZ2VkRWxlbWVudCA9IG1vdmVFdmVudC5zb3VyY2UuZWxlbWVudC5uYXRpdmVFbGVtZW50Lm5leHRFbGVtZW50U2libGluZztcbiAgICBpZiAoIXRoaXMuZGlmZlgpIHtcbiAgICAgIGNvbnN0IHJlY3QgPSBkcmFnZ2VkRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgIHRoaXMuZGlmZlggPSAgbW92ZUV2ZW50LnBvaW50ZXJQb3NpdGlvbi54IC0gcmVjdC5sZWZ0O1xuICAgICAgdGhpcy5kaWZmWSA9ICBtb3ZlRXZlbnQucG9pbnRlclBvc2l0aW9uLnkgLSByZWN0LnRvcDtcbiAgICB9XG5cbiAgICBjb25zdCBsZWZ0ID0gbW92ZUV2ZW50LnBvaW50ZXJQb3NpdGlvbi54IC0gdGhpcy5kaWZmWDtcbiAgICBjb25zdCB0b3AgPSBtb3ZlRXZlbnQucG9pbnRlclBvc2l0aW9uLnkgLSB0aGlzLmRpZmZZO1xuICAgIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gdGhpcy5jaGlsZDtcbiAgICBjb25zdCBkcyA9IHRoaXMuZGFzaGJvYXJkLmRhc2hib2FyZFJlY3Q7XG4gICAgY29uc3QgY29sdW1uID0gdGhpcy5kYXNoYm9hcmQuY29sdW1uU2l6ZTtcbiAgICBjb25zdCByb3cgPSB0aGlzLmRhc2hib2FyZC5yb3dTaXplICsgdGhpcy5kYXNoYm9hcmQuZ2FwIC8gMjtcbiAgICBjb25zdCB4ID0gTWF0aC5yb3VuZCgobGVmdCAtIGRzLmxlZnQpIC8gY29sdW1uKTtcbiAgICBjb25zdCB5ID0gTWF0aC5yb3VuZCgodG9wIC0gZHMudG9wKSAvIHJvdyk7XG4gICAgcmV0dXJuIHsgeCwgeSwgd2lkdGgsIGhlaWdodCB9IGFzIERhc2hib2FyZENoaWxkRGltZW5zaW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBkb2VzQ29sbGlkZShhOiBEYXNoYm9hcmRDaGlsZERpbWVuc2lvbiwgYjogRGFzaGJvYXJkQ2hpbGREaW1lbnNpb24pIHtcbiAgICBpZiAoYi54ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuICEoXG4gICAgICBhLnkgKyBhLmhlaWdodCAtIDEgPCBiLnkgfHxcbiAgICAgIGEueSA+IGIueSArIGIuaGVpZ2h0IC0gMSB8fFxuICAgICAgYS54ICsgYS53aWR0aCAtIDEgPCBiLnggfHxcbiAgICAgIGEueCA+IGIueCArIGIud2lkdGggLSAxXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q29sbGlkZWQoY3VycmVudERpbWVuc2lvbjogRGFzaGJvYXJkQ2hpbGREaW1lbnNpb24sIGRpbWVuc2lvbnMgPSB0aGlzLmNoaWxkcmVuKSB7XG4gICAgY29uc3QgY29sbGlkZWQgPSBkaW1lbnNpb25zLmZpbHRlcihkaW1lbnNpb24gPT4gdGhpcy5kb2VzQ29sbGlkZShjdXJyZW50RGltZW5zaW9uLCBkaW1lbnNpb24pKTtcbiAgICByZXR1cm4gY29sbGlkZWQ7XG4gIH1cbn1cbiJdfQ==