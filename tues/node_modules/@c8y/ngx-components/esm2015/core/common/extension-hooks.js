import { NavigationEnd } from '@angular/router';
import { flatten, isFunction, sortBy } from 'lodash-es';
import { combineLatest, defer, from, isObservable, of, race } from 'rxjs';
import { filter, map, merge, startWith, switchMap } from 'rxjs/operators';
export function fromTrigger(router, refresh, factories) {
    return router.events.pipe(filter(evt => evt instanceof NavigationEnd), merge(refresh), startWith(1), switchMap(() => fromFactories(factories, router)));
}
export function fromFactories(factories, router, withFirstEmpty = true) {
    return !Array.isArray(factories) || factories.length < 1
        ? of([])
        : defer(() => {
            const factoryObservables = resolveInjectedFactories(factories).map(f => {
                return toObservable(Array.isArray(f) ? f : f && isFunction(f.get) ? f.get(getActivatedRoute(router)) : [f], withFirstEmpty);
            });
            return combineLatest(...factoryObservables);
        }).pipe(map(results => sortByPriority([].concat(...results))));
}
export function resolveInjectedFactories(factories) {
    return flatten(factories.map(f => (isFunction(f) ? f() : [f])));
}
export function stateToFactory(componentsState) {
    const components$ = componentsState.pipe(map((componentSet) => Array.from(componentSet)));
    return { get: () => components$ };
}
export function sortByPriority(items) {
    return sortBy(items, 'priority');
}
function toObservable(factoryResult, withFirstEmpty) {
    let observable;
    if (!factoryResult) {
        return of([]);
    }
    else if (typeof factoryResult.then === 'function' || isObservable(factoryResult)) {
        if (withFirstEmpty) {
            const forceObservable = from(factoryResult);
            const withEmptyFirst = forceObservable.pipe(startWith([]));
            observable = race(forceObservable, withEmptyFirst);
        }
        else {
            observable = from(factoryResult);
        }
    }
    else {
        observable = of(factoryResult);
    }
    return observable.pipe(map(result => (Array.isArray(result) ? result : [result]).filter(item => !!item)));
}
/**
 * Helper function to get the activated route in
 * a service (as ActivatedRoute injection only
 * works in components). Works as long as we only use
 * a tree and no child is active at the same time.
 *
 * @param router The current router
 */
export function getActivatedRoute(router) {
    if (router && router.routerState && router.routerState.root) {
        let route = router.routerState.root;
        while (route.firstChild) {
            route = route.firstChild;
        }
        return route;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5zaW9uLWhvb2tzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImNvcmUvY29tbW9uL2V4dGVuc2lvbi1ob29rcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWtCLGFBQWEsRUFBVSxNQUFNLGlCQUFpQixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN4RCxPQUFPLEVBQUUsYUFBYSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFjLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEYsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUUxRSxNQUFNLFVBQVUsV0FBVyxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsU0FBUztJQUNwRCxPQUFPLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUN2QixNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFlBQVksYUFBYSxDQUFDLEVBQzNDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFDZCxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQ1osU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLGFBQWEsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FDbEQsQ0FBQztBQUNKLENBQUM7QUFDRCxNQUFNLFVBQVUsYUFBYSxDQUMzQixTQUFVLEVBQ1YsTUFBZSxFQUNmLGNBQWMsR0FBRyxJQUFJO0lBRXJCLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQztRQUN0RCxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUNSLENBQUMsQ0FBQyxLQUFL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QUFpQixDQUFDLE1BQWM7SUFDOUMsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLFdBQVcsSUFBSSxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRTtRQUMzRCxJQUFJLEtBQUssR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQztRQUNwQyxPQUFPLEtBQUssQ0FBQyxVQUFVLEVBQUU7WUFDdkIsS0FBSyxHQUFHLEtBQUssQ0FBQyxVQUFVLENBQUM7U0FDMUI7UUFDRCxPQUFPLEtBQUssQ0FBQztLQUNkO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFjdGl2YXRlZFJvdXRlLCBOYXZpZ2F0aW9uRW5kLCBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgZmxhdHRlbiwgaXNGdW5jdGlvbiwgc29ydEJ5IH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IGNvbWJpbmVMYXRlc3QsIGRlZmVyLCBmcm9tLCBpc09ic2VydmFibGUsIE9ic2VydmFibGUsIG9mLCByYWNlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCwgbWVyZ2UsIHN0YXJ0V2l0aCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5leHBvcnQgZnVuY3Rpb24gZnJvbVRyaWdnZXIocm91dGVyLCByZWZyZXNoLCBmYWN0b3JpZXMpIHtcbiAgcmV0dXJuIHJvdXRlci5ldmVudHMucGlwZShcbiAgICBmaWx0ZXIoZXZ0ID0+IGV2dCBpbnN0YW5jZW9mIE5hdmlnYXRpb25FbmQpLFxuICAgIG1lcmdlKHJlZnJlc2gpLFxuICAgIHN0YXJ0V2l0aCgxKSxcbiAgICBzd2l0Y2hNYXAoKCkgPT4gZnJvbUZhY3RvcmllcyhmYWN0b3JpZXMsIHJvdXRlcikpXG4gICk7XG59XG5leHBvcnQgZnVuY3Rpb24gZnJvbUZhY3RvcmllczxUPihcbiAgZmFjdG9yaWVzPyxcbiAgcm91dGVyPzogUm91dGVyLFxuICB3aXRoRmlyc3RFbXB0eSA9IHRydWVcbik6IE9ic2VydmFibGU8VFtdPiB7XG4gIHJldHVybiAhQXJyYXkuaXNBcnJheShmYWN0b3JpZXMpIHx8IGZhY3Rvcmllcy5sZW5ndGggPCAxXG4gICAgPyBvZihbXSlcbiAgICA6IGRlZmVyKCgpID0+IHtcbiAgICAgICAgY29uc3QgZmFjdG9yeU9ic2VydmFibGVzID0gcmVzb2x2ZUluamVjdGVkRmFjdG9yaWVzKGZhY3RvcmllcykubWFwKGYgPT4ge1xuICAgICAgICAgIHJldHVybiB0b09ic2VydmFibGUoXG4gICAgICAgICAgICBBcnJheS5pc0FycmF5KGYpID8gZiA6IGYgJiYgaXNGdW5jdGlvbihmLmdldCkgPyBmLmdldChnZXRBY3RpdmF0ZWRSb3V0ZShyb3V0ZXIpKSA6IFtmXSxcbiAgICAgICAgICAgIHdpdGhGaXJzdEVtcHR5XG4gICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KC4uLmZhY3RvcnlPYnNlcnZhYmxlcyk7XG4gICAgICB9KS5waXBlKG1hcChyZXN1bHRzID0+IHNvcnRCeVByaW9yaXR5KFtdLmNvbmNhdCguLi5yZXN1bHRzKSkpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlc29sdmVJbmplY3RlZEZhY3RvcmllcyhmYWN0b3JpZXMpIHtcbiAgcmV0dXJuIGZsYXR0ZW4oZmFjdG9yaWVzLm1hcChmID0+IChpc0Z1bmN0aW9uKGYpID8gZigpIDogW2ZdKSkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3RhdGVUb0ZhY3Rvcnk8VD4oY29tcG9uZW50c1N0YXRlKTogRXh0ZW5zaW9uRmFjdG9yeTxUPiB7XG4gIGNvbnN0IGNvbXBvbmVudHMkID0gY29tcG9uZW50c1N0YXRlLnBpcGUobWFwKChjb21wb25lbnRTZXQ6IFNldDxUPikgPT4gQXJyYXkuZnJvbShjb21wb25lbnRTZXQpKSk7XG4gIHJldHVybiB7IGdldDogKCkgPT4gY29tcG9uZW50cyQgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNvcnRCeVByaW9yaXR5KGl0ZW1zKSB7XG4gIHJldHVybiBzb3J0QnkoaXRlbXMsICdwcmlvcml0eScpO1xufVxuXG5mdW5jdGlvbiB0b09ic2VydmFibGUoZmFjdG9yeVJlc3VsdCwgd2l0aEZpcnN0RW1wdHkpIHtcbiAgbGV0IG9ic2VydmFibGU7XG4gIGlmICghZmFjdG9yeVJlc3VsdCkge1xuICAgIHJldHVybiBvZihbXSk7XG4gIH0gZWxzZSBpZiAodHlwZW9mIGZhY3RvcnlSZXN1bHQudGhlbiA9PT0gJ2Z1bmN0aW9uJyB8fCBpc09ic2VydmFibGUoZmFjdG9yeVJlc3VsdCkpIHtcbiAgICBpZiAod2l0aEZpcnN0RW1wdHkpIHtcbiAgICAgIGNvbnN0IGZvcmNlT2JzZXJ2YWJsZSA9IGZyb20oZmFjdG9yeVJlc3VsdCk7XG4gICAgICBjb25zdCB3aXRoRW1wdHlGaXJzdCA9IGZvcmNlT2JzZXJ2YWJsZS5waXBlKHN0YXJ0V2l0aChbXSkpO1xuICAgICAgb2JzZXJ2YWJsZSA9IHJhY2UoZm9yY2VPYnNlcnZhYmxlLCB3aXRoRW1wdHlGaXJzdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIG9ic2VydmFibGUgPSBmcm9tKGZhY3RvcnlSZXN1bHQpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBvYnNlcnZhYmxlID0gb2YoZmFjdG9yeVJlc3VsdCk7XG4gIH1cbiAgcmV0dXJuIG9ic2VydmFibGUucGlwZShcbiAgICBtYXAocmVzdWx0ID0+IChBcnJheS5pc0FycmF5KHJlc3VsdCkgPyByZXN1bHQgOiBbcmVzdWx0XSkuZmlsdGVyKGl0ZW0gPT4gISFpdGVtKSlcbiAgKTtcbn1cblxuLyoqXG4gKiBBbGxvd3MgdG8gZXh0ZW5kIHRoZSBleGlzdGluZyBhcHBsaWNhdGlvbnMgZnJvbSBhIG1vZHVsZS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFeHRlbnNpb25GYWN0b3J5PFQ+IHtcbiAgLyoqXG4gICAqIEFsbG93cyB0byByZXNvbHZlIHRoZSBkYXRhIG9mIGFuIGV4dGVuc2lvbiBwb2ludC5cbiAgICogVGhlIHJldHVybiB2YWx1ZSBjYW4gYmUgYSBQcm9taXNlIG9yIE9ic2VydmFibGVcbiAgICogKGFsbG93aW5nIGZvciBhc3luY2hyb25vdXMgZGF0YSByZXNvbHV0aW9uKS5cbiAgICpcbiAgICogQHBhcmFtIGFjdGl2YXRlZFJvdXRlIFRoZSBjdXJyZW50IGFjdGl2YXRlZCByb3V0ZSAoaWYgcG9zc2libGUgdG8gcmVzb2x2ZSkuXG4gICAqL1xuICBnZXQoYWN0aXZhdGVkUm91dGU/OiBBY3RpdmF0ZWRSb3V0ZSk6IE9ic2VydmFibGU8VFtdIHwgVD4gfCBQcm9taXNlPFRbXSB8IFQ+IHwgVFtdIHwgVDtcbn1cblxuLyoqXG4gKiBFeHRlbnNpb24gcG9pbnRzIGFsbG93IHRvIGV4dGVuZCB0aGUgYXBwbGljYXRpb24gZnJvbVxuICogYW55IG1vZHVsZVxuICovXG5leHBvcnQgaW50ZXJmYWNlIEV4dGVuc2lvblBvaW50PFQ+IHtcbiAgLyoqXG4gICAqIE9ic2VydmFibGUgdGhhdCBlbWl0cyBvZiBhcnJheSBvZiBleHRlbnNpb25zIGFjdGl2ZSBhdCBhbnkgZ2l2ZSB0aW1lXG4gICAqL1xuICByZWFkb25seSBpdGVtcyQ6IE9ic2VydmFibGU8VFtdPjtcbiAgLyoqXG4gICAqIENhbGwgdGhlIGV4dGVuc2lvbiBmYWN0b3JpZXMgdG8gcmVmcmVzaCB0aGVtLlxuICAgKi9cbiAgcmVmcmVzaCgpO1xufVxuXG4vKipcbiAqIEhlbHBlciBmdW5jdGlvbiB0byBnZXQgdGhlIGFjdGl2YXRlZCByb3V0ZSBpblxuICogYSBzZXJ2aWNlIChhcyBBY3RpdmF0ZWRSb3V0ZSBpbmplY3Rpb24gb25seVxuICogd29ya3MgaW4gY29tcG9uZW50cykuIFdvcmtzIGFzIGxvbmcgYXMgd2Ugb25seSB1c2VcbiAqIGEgdHJlZSBhbmQgbm8gY2hpbGQgaXMgYWN0aXZlIGF0IHRoZSBzYW1lIHRpbWUuXG4gKlxuICogQHBhcmFtIHJvdXRlciBUaGUgY3VycmVudCByb3V0ZXJcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldEFjdGl2YXRlZFJvdXRlKHJvdXRlcjogUm91dGVyKSB7XG4gIGlmIChyb3V0ZXIgJiYgcm91dGVyLnJvdXRlclN0YXRlICYmIHJvdXRlci5yb3V0ZXJTdGF0ZS5yb290KSB7XG4gICAgbGV0IHJvdXRlID0gcm91dGVyLnJvdXRlclN0YXRlLnJvb3Q7XG4gICAgd2hpbGUgKHJvdXRlLmZpcnN0Q2hpbGQpIHtcbiAgICAgIHJvdXRlID0gcm91dGUuZmlyc3RDaGlsZDtcbiAgICB9XG4gICAgcmV0dXJuIHJvdXRlO1xuICB9XG59XG4iXX0=