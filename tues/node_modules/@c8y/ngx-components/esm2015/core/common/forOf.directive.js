import * as tslib_1 from "tslib";
import { coerceNumberProperty } from '@angular/cdk/coercion';
import { ComponentFactory, ComponentFactoryResolver, Directive, EmbeddedViewRef, Input, SimpleChanges, TemplateRef, ViewContainerRef, ViewRef } from '@angular/core';
import { assign, get } from 'lodash-es';
import { isObservable, of, pipe, Subject } from 'rxjs';
import { map, takeUntil, tap } from 'rxjs/operators';
import { LoadMoreComponent } from './load-more.component';
/**
 * A directive to iterate over IResultList<T> data from @c8y/client.
 * Depending on the [c8yForLoadMore] a load more button is:
 *  - auto: Tries to automatically load more data (default maximum 10 iterations; can be
 *          change with maxIterations settings).
 *  - show: Shows a load more button for the user to decide
 *  - none: Doesn't perform any load more action.
 *  - hidden: Loads more data automatically but with no visible button for the user.
 *
 * Additional, any rxjs operator pipe can be applied to the [c8yForPipe] input, e.g. to
 * filter the data displayed currently as well as the data loaded by subsequent requests.
 *
 * Example:
 * ```html
 * <div *c8yFor="let device of devices; loadMore: 'auto'; let i = index; pipe: filterPipe;">
 *  {{ i + 1 }}. {{device.name}}
 * </div>
 * ```
 * The above example will list all entities that are applied to `devices`:
 * ```typescript
 * this.devices = this.inventoryService.list({ pageSize: 10, fragmentType: 'c8y_IsDevice' })
 * ```
 * It will display the first 10 items, if there is more space left on the screen, and there are more
 * than 10 devices, it will automatically load up to 10 pages more. If it still can't fit the screen
 * it will stop and switch to `show` mode.
 *
 * A pipe can be applied e.g. for filtering or grouping. This pipe is attached to every follow up
 * request done by the load more component:
 * ```typescript
 * this.filterPipe = pipe(
 *    map((data: []) => {
 *     return data.filter(
 *      (mo: any) => mo.name && mo.name.toLowerCase().indexOf(value.toLowerCase()) > -1
 *    );
 *  })
 * );
 * ```
 * The pipe must be an rxjs pipe and can take any operator.
 */
let ForOfDirective = class ForOfDirective {
    constructor(tpl, vcr, componentFactoryResolver) {
        this.tpl = tpl;
        this.vcr = vcr;
        this.componentFactoryResolver = componentFactoryResolver;
        this.cachedData = [];
        this.loadMoreMode = 'auto';
        this.dataPipe = pipe(tap());
        this.maxIterations = 10;
        this.unsubscribe$ = new Subject();
    }
    get shouldUseLoadMoreButton() {
        return (this.loadMoreMode === 'auto' || this.loadMoreMode === 'show' || this.loadMoreMode === 'hidden');
    }
    get hasMoreData() {
        return this.loadMore && this.loadMore.hasMore;
    }
    get length() {
        return this.cachedData.length;
    }
    /**
     * The data setter. Must be a response from @c8y/data or an observable.
     * You can pass an observable with null to explicitly clear the list.
     */
    set c8yForOf(fetchData) {
        if (fetchData) {
            this.obs$ = (isObservable(fetchData) ? fetchData : of(fetchData)).pipe(map(result => {
                if (result === null) {
                    this.paging = null;
                    return [];
                }
                const { paging, data } = result;
                this.paging = paging;
                return data;
            }));
        }
    }
    /**
     * The mode setter:
     *  - auto: Tries to automatically load more data (default maximum 10 iterations; can be
     *          change with maxIterations settings).
     *  - show: Shows a load more button for the user to decide
     *  - none: Doesn't perform any load more action.
     *  - hidden: Loads more data automatically but with no visible button for the user.
     */
    set c8yForLoadMore(type) {
        this.loadMoreMode = type;
    }
    /**
     * The pipe setter to attach any rxjs pipe to the current and more loaded data.
     */
    set c8yForPipe(dataPipe) {
        if (dataPipe) {
            this.dataPipe = dataPipe;
        }
    }
    /**
     * A template to use if no data is found at all (e.g. if you apply a filter pipe).
     */
    set c8yForNotFound(notFoundTemplate) {
        this.notFoundTemplate = notFoundTemplate;
        if (this.loadMore) {
            this.loadMore.noMoreDataHint = notFoundTemplate;
        }
    }
    /**
     * The maximum numbers of iterations to call data from the api.
     */
    set c8yForMaxIterations(maxIterations) {
        this.maxIterations = maxIterations;
    }
    /**
     * A RealtimeService instance.
     */
    set c8yForRealtime(source) {
        this.realtime = source;
    }
    /**
     * A comparator function for comparing list items. Used to determine
     * the position at which a new element should be added to the list.
     */
    set c8yForComparator(comparator) {
        this.comparator = comparator;
    }
    ngOnInit() {
        this.handleRealtime();
    }
    ngOnChanges(changes) {
        if (this.obs$ && (changes.c8yForPipe || changes.c8yForOf)) {
            this.unsubscribePaging();
            // only re-rendering  on filtering if all data is already loaded
            // from the backend
            const reRender = !this.hasMoreData && !!changes.c8yForPipe && !changes.c8yForOf;
            if (reRender) {
                this.obs$ = of(this.cachedData);
            }
            this.pagingSub = this.obs$
                .pipe(tap(data => {
                if (!reRender) {
                    this.cachedData = data;
                }
            }))
                .pipe(src => this.dataPipe(src))
                .subscribe((data) => {
                this.render(data, reRender);
            });
        }
    }
    ngOnDestroy() {
        this.unsubscribePaging();
        this.unsubscribe$.next();
        this.unsubscribe$.complete();
    }
    handleRealtime() {
        if (this.realtime) {
            this.realtime
                .onCreate$()
                .pipe(takeUntil(this.unsubscribe$))
                .subscribe(item => this.insert(item));
            this.realtime
                .onUpdate$()
                .pipe(takeUntil(this.unsubscribe$))
                .subscribe(item => this.update(item));
            this.realtime
                .onDelete$()
                .pipe(takeUntil(this.unsubscribe$))
                .subscribe(id => this.remove(coerceNumberProperty(id)));
        }
    }
    render(data, reRender = false) {
        this.vcr.clear();
        data.forEach((item, index) => {
            const context = {
                $implicit: item,
                index,
                length: this.length,
                hasMore: this.hasMoreData
            };
            this.vcr.createEmbeddedView(this.tpl, context);
        });
        if (this.shouldUseLoadMoreButton) {
            this.loadMore = this.createLoadMoreButtonComponent(reRender);
        }
    }
    append(data) {
        data.forEach(item => {
            const index = this.shouldUseLoadMoreButton ? this.vcr.length - 1 : this.vcr.length;
            const context = {
                $implicit: item,
                index,
                length: this.length,
                hasMore: this.hasMoreData
            };
            this.vcr.createEmbeddedView(this.tpl, context, index);
        });
    }
    loadMoreData(data) {
        if (data.length > 0) {
            this.append(data);
        }
    }
    createLoadMoreButtonComponent(reRender) {
        const componentFactory = this.componentFactoryResolver.resolveComponentFactory(LoadMoreComponent);
        const componentRef = this.vcr.createComponent(componentFactory);
        const instance = componentRef.instance;
        instance.paging = this.paging;
        instance.useIntersection = this.loadMoreMode === 'auto' || this.loadMoreMode === 'hidden';
        instance.hidden = this.loadMoreMode === 'hidden';
        instance.maxIterations = this.maxIterations;
        instance.noMoreDataHint = this.notFoundTemplate;
        this.pagingSub = instance.onLoad
            .pipe(map((data) => this.checkForDuplicates(data)), tap((data) => {
            this.cachedData = this.cachedData.concat(data);
        }))
            .pipe(src => this.dataPipe(src))
            .subscribe(data => this.loadMoreData(data));
        if (reRender) {
            assign(instance, this.loadMore);
        }
        return instance;
    }
    insert(item) {
        let index = 0;
        if (this.comparator && this.cachedData.length) {
            let comparisionResult;
            do {
                const view = this.vcr.get(index);
                const itemB = get(view, 'context.$implicit');
                comparisionResult = item && itemB ? this.comparator(item, itemB) : 0;
                if (comparisionResult <= 0) {
                    index++;
                }
            } while (comparisionResult <= 0 && index < this.cachedData.length);
        }
        // Do not append elements after the last one currently loaded,
        // as it may belong further down there on the list and will
        // be eventually loaded with one of the next pages.
        if (index < this.cachedData.length || this.cachedData.length === 0) {
            const context = {
                $implicit: item,
                index,
                length: this.length,
                hasMore: this.hasMoreData
            };
            this.cachedData.splice(index, 0, item);
            const viewRef = this.tpl.createEmbeddedView(context);
            this.vcr.insert(viewRef, index);
        }
    }
    update(updatedItem) {
        this.forMatchingEmbeddedViewRef((item) => item && updatedItem && item.id === updatedItem.id, (view) => {
            view.context.$implicit = updatedItem;
            view.markForCheck();
        });
    }
    remove(idToRemove) {
        this.forMatchingEmbeddedViewRef((item) => item && coerceNumberProperty(item.id, NaN) === idToRemove, (view) => view.destroy());
    }
    forMatchingEmbeddedViewRef(filter, callback) {
        for (let i = 0; i < this.vcr.length; i++) {
            const view = this.vcr.get(i);
            const item = get(view, 'context.$implicit');
            if (filter(item)) {
                callback(view);
            }
        }
    }
    checkForDuplicates(data) {
        return this.realtime
            ? data.filter(item => !this.cachedData.some(cached => cached.id === item.id))
            : data;
    }
    unsubscribePaging() {
        if (this.pagingSub) {
            this.pagingSub.unsubscribe();
        }
    }
};
ForOfDirective.ctorParameters = () => [
    { type: TemplateRef },
    { type: ViewContainerRef },
    { type: ComponentFactoryResolver }
];
tslib_1.__decorate([
    Input()
], ForOfDirective.prototype, "c8yForOf", null);
tslib_1.__decorate([
    Input()
], ForOfDirective.prototype, "c8yForLoadMore", null);
tslib_1.__decorate([
    Input()
], ForOfDirective.prototype, "c8yForPipe", null);
tslib_1.__decorate([
    Input()
], ForOfDirective.prototype, "c8yForNotFound", null);
tslib_1.__decorate([
    Input()
], ForOfDirective.prototype, "c8yForMaxIterations", null);
tslib_1.__decorate([
    Input()
], ForOfDirective.prototype, "c8yForRealtime", null);
tslib_1.__decorate([
    Input()
], ForOfDirective.prototype, "c8yForComparator", null);
ForOfDirective = tslib_1.__decorate([
    Directive({
        selector: '[c8yFor]'
    })
], ForOfDirective);
export { ForOfDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9yT2YuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImNvcmUvY29tbW9uL2Zvck9mLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDN0QsT0FBTyxFQUNMLGdCQUFnQixFQUNoQix3QkFBd0IsRUFDeEIsU0FBUyxFQUNULGVBQWUsRUFDZixLQUFLLEVBQ0wsYUFBYSxFQUNiLFdBQVcsRUFDWCxnQkFBZ0IsRUFDaEIsT0FBTyxFQUNSLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxZQUFZLEVBQWMsRUFBRSxFQUFFLElBQUksRUFBRSxPQUFPLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBQ2pGLE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXJELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRzFEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXNDRztBQUlILElBQWEsY0FBYyxHQUEzQixNQUFhLGNBQWM7SUE0R3pCLFlBQ1UsR0FBcUIsRUFDckIsR0FBcUIsRUFDckIsd0JBQWtEO1FBRmxELFFBQUcsR0FBSCxHQUFHLENBQWtCO1FBQ3JCLFFBQUcsR0FBSCxHQUFHLENBQWtCO1FBQ3JCLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUE5R3BELGVBQVUsR0FBa0IsRUFBRSxDQUFDO1FBRS9CLGlCQUFZLEdBQWlCLE1BQU0sQ0FBQztRQUNwQyxhQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFJdkIsa0JBQWEsR0FBRyxFQUFFLENBQUM7UUFJbkIs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TUQ7SUFEQyxLQUFLLEVBQUU7b0RBTVA7QUFNRDtJQURDLEtBQUssRUFBRTt5REFHUDtBQU1EO0lBREMsS0FBSyxFQUFFO29EQUdQO0FBT0Q7SUFEQyxLQUFLLEVBQUU7c0RBR1A7QUExR1UsY0FBYztJQUgxQixTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsVUFBVTtLQUNyQixDQUFDO0dBQ1csY0FBYyxDQStTMUI7U0EvU1ksY0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvZXJjZU51bWJlclByb3BlcnR5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2NvZXJjaW9uJztcbmltcG9ydCB7XG4gIENvbXBvbmVudEZhY3RvcnksXG4gIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgRGlyZWN0aXZlLFxuICBFbWJlZGRlZFZpZXdSZWYsXG4gIElucHV0LFxuICBTaW1wbGVDaGFuZ2VzLFxuICBUZW1wbGF0ZVJlZixcbiAgVmlld0NvbnRhaW5lclJlZixcbiAgVmlld1JlZlxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IElJZGVudGlmaWVkLCBJUmVzdWx0TGlzdCwgUGFnaW5nIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgYXNzaWduLCBnZXQgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgaXNPYnNlcnZhYmxlLCBPYnNlcnZhYmxlLCBvZiwgcGlwZSwgU3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHRha2VVbnRpbCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUmVhbHRpbWVTZXJ2aWNlIH0gZnJvbSAnLi4vcmVhbHRpbWUvcmVhbHRpbWUuc2VydmljZSc7XG5pbXBvcnQgeyBMb2FkTW9yZUNvbXBvbmVudCB9IGZyb20gJy4vbG9hZC1tb3JlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBMb2FkTW9yZU1vZGUgfSBmcm9tICcuL2xvYWQtbW9yZS5tb2RlbCc7XG5cbi8qKlxuICogQSBkaXJlY3RpdmUgdG8gaXRlcmF0ZSBvdmVyIElSZXN1bHRMaXN0PFQ+IGRhdGEgZnJvbSBAYzh5L2NsaWVudC5cbiAqIERlcGVuZGluZyBvbiB0aGUgW2M4eUZvckxvYWRNb3JlXSBhIGxvYWQgbW9yZSBidXR0b24gaXM6XG4gKiAgLSBhdXRvOiBUcmllcyB0byBhdXRvbWF0aWNhbGx5IGxvYWQgbW9yZSBkYXRhIChkZWZhdWx0IG1heGltdW0gMTAgaXRlcmF0aW9uczsgY2FuIGJlXG4gKiAgICAgICAgICBjaGFuZ2Ugd2l0aCBtYXhJdGVyYXRpb25zIHNldHRpbmdzKS5cbiAqICAtIHNob3c6IFNob3dzIGEgbG9hZCBtb3JlIGJ1dHRvbiBmb3IgdGhlIHVzZXIgdG8gZGVjaWRlXG4gKiAgLSBub25lOiBEb2Vzbid0IHBlcmZvcm0gYW55IGxvYWQgbW9yZSBhY3Rpb24uXG4gKiAgLSBoaWRkZW46IExvYWRzIG1vcmUgZGF0YSBhdXRvbWF0aWNhbGx5IGJ1dCB3aXRoIG5vIHZpc2libGUgYnV0dG9uIGZvciB0aGUgdXNlci5cbiAqXG4gKiBBZGRpdGlvbmFsLCBhbnkgcnhqcyBvcGVyYXRvciBwaXBlIGNhbiBiZSBhcHBsaWVkIHRvIHRoZSBbYzh5Rm9yUGlwZV0gaW5wdXQsIGUuZy4gdG9cbiAqIGZpbHRlciB0aGUgZGF0YSBkaXNwbGF5ZWQgY3VycmVudGx5IGFzIHdlbGwgYXMgdGhlIGRhdGEgbG9hZGVkIGJ5IHN1YnNlcXVlbnQgcmVxdWVzdHMuXG4gKlxuICogRXhhbXBsZTpcbiAqIGBgYGh0bWxcbiAqIDxkaXYgKmM4eUZvcj1cImxldCBkZXZpY2Ugb2YgZGV2aWNlczsgbG9hZE1vcmU6ICdhdXRvJzsgbGV0IGkgPSBpbmRleDsgcGlwZTogZmlsdGVyUGlwZTtcIj5cbiAqICB7eyBpICsgMSB9fS4ge3tkZXZpY2UubmFtZX19XG4gKiA8L2Rpdj5cbiAqIGBgYFxuICogVGhlIGFib3ZlIGV4YW1wbGUgd2lsbCBsaXN0IGFsbCBlbnRpdGllcyB0aGF0IGFyZSBhcHBsaWVkIHRvIGBkZXZpY2VzYDpcbiAqIGBgYHR5cGVzY3JpcHRcbiAqIHRoaXMuZGV2aWNlcyA9IHRoaXMuaW52ZW50b3J5U2VydmljZS5saXN0KHsgcGFnZVNpemU6IDEwLCBmcmFnbWVudFR5cGU6ICdjOHlfSXNEZXZpY2UnIH0pXG4gKiBgYGBcbiAqIEl0IHdpbGwgZGlzcGxheSB0aGUgZmlyc3QgMTAgaXRlbXMsIGlmIHRoZXJlIGlzIG1vcmUgc3BhY2UgbGVmdCBvbiB0aGUgc2NyZWVuLCBhbmQgdGhlcmUgYXJlIG1vcmVcbiAqIHRoYW4gMTAgZGV2aWNlcywgaXQgd2lsbCBhdXRvbWF0aWNhbGx5IGxvYWQgdXAgdG8gMTAgcGFnZXMgbW9yZS4gSWYgaXQgc3RpbGwgY2FuJ3QgZml0IHRoZSBzY3JlZW5cbiAqIGl0IHdpbGwgc3RvcCBhbmQgc3dpdGNoIHRvIGBzaG93YCBtb2RlLlxuICpcbiAqIEEgcGlwZSBjYW4gYmUgYXBwbGllZCBlLmcuIGZvciBmaWx0ZXJpbmcgb3IgZ3JvdXBpbmcuIFRoaXMgcGlwZSBpcyBhdHRhY2hlZCB0byBldmVyeSBmb2xsb3cgdXBcbiAqIHJlcXVlc3QgZG9uZSBieSB0aGUgbG9hZCBtb3JlIGNvbXBvbmVudDpcbiAqIGBgYHR5cGVzY3JpcHRcbiAqIHRoaXMuZmlsdGVyUGlwZSA9IHBpcGUoXG4gKiAgICBtYXAoKGRhdGE6IFtdKSA9PiB7XG4gKiAgICAgcmV0dXJuIGRhdGEuZmlsdGVyKFxuICogICAgICAobW86IGFueSkgPT4gbW8ubmFtZSAmJiBtby5uYW1lLnRvTG93ZXJDYXNlKCkuaW5kZXhPZih2YWx1ZS50b0xvd2VyQ2FzZSgpKSA+IC0xXG4gKiAgICApO1xuICogIH0pXG4gKiApO1xuICogYGBgXG4gKiBUaGUgcGlwZSBtdXN0IGJlIGFuIHJ4anMgcGlwZSBhbmQgY2FuIHRha2UgYW55IG9wZXJhdG9yLlxuICovXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbYzh5Rm9yXSdcbn0pXG5leHBvcnQgY2xhc3MgRm9yT2ZEaXJlY3RpdmUge1xuICBwcml2YXRlIGNhY2hlZERhdGE6IElJZGVudGlmaWVkW10gPSBbXTtcbiAgcHJpdmF0ZSBwYWdpbmc6IFBhZ2luZzxJSWRlbnRpZmllZD47XG4gIHByaXZhdGUgbG9hZE1vcmVNb2RlOiBMb2FkTW9yZU1vZGUgPSAnYXV0byc7XG4gIHByaXZhdGUgZGF0YVBpcGUgPSBwaXBlKHRhcCgpKTtcbiAgcHJpdmF0ZSBwYWdpbmdTdWI6IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBvYnMkOiBPYnNlcnZhYmxlPElJZGVudGlmaWVkW10+O1xuICBwcml2YXRlIGxvYWRNb3JlOiBMb2FkTW9yZUNvbXBvbmVudDtcbiAgcHJpdmF0ZSBtYXhJdGVyYXRpb25zID0gMTA7XG4gIHByaXZhdGUgbm90Rm91bmRUZW1wbGF0ZTogVGVtcGxhdGVSZWY8YW55PjtcbiAgcHJpdmF0ZSByZWFsdGltZTogUmVhbHRpbWVTZXJ2aWNlPGFueT47XG4gIHByaXZhdGUgY29tcGFyYXRvcjogKGl0ZW1BOiBvYmplY3QsIGl0ZW1COiBvYmplY3QpID0+IG51bWJlcjtcbiAgcHJpdmF0ZSB1bnN1YnNjcmliZSQ6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdCgpO1xuXG4gIHByaXZhdGUgZ2V0IHNob3VsZFVzZUxvYWRNb3JlQnV0dG9uKCkge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLmxvYWRNb3JlTW9kZSA9PT0gJ2F1dG8nIHx8IHRoaXMubG9hZE1vcmVNb2RlID09PSAnc2hvdycgfHwgdGhpcy5sb2FkTW9yZU1vZGUgPT09ICdoaWRkZW4nXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGhhc01vcmVEYXRhKCkge1xuICAgIHJldHVybiB0aGlzLmxvYWRNb3JlICYmIHRoaXMubG9hZE1vcmUuaGFzTW9yZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGxlbmd0aCgpIHtcbiAgICByZXR1cm4gdGhpcy5jYWNoZWREYXRhLmxlbmd0aDtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGUgZGF0YSBzZXR0ZXIuIE11c3QgYmUgYSByZXNwb25zZSBmcm9tIEBjOHkvZGF0YSBvciBhbiBvYnNlcnZhYmxlLlxuICAgKiBZb3UgY2FuIHBhc3MgYW4gb2JzZXJ2YWJsZSB3aXRoIG51bGwgdG8gZXhwbGljaXRseSBjbGVhciB0aGUgbGlzdC5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHNldCBjOHlGb3JPZihmZXRjaERhdGE6IElSZXN1bHRMaXN0PElJZGVudGlmaWVkPiB8IE9ic2VydmFibGU8SVJlc3VsdExpc3Q8SUlkZW50aWZpZWQ+Pikge1xuICAgIGlmIChmZXRjaERhdGEpIHtcbiAgICAgIHRoaXMub2JzJCA9IChpc09ic2VydmFibGUoZmV0Y2hEYXRhKSA/IGZldGNoRGF0YSA6IG9mKGZldGNoRGF0YSkpLnBpcGUoXG4gICAgICAgIG1hcChyZXN1bHQgPT4ge1xuICAgICAgICAgIGlmIChyZXN1bHQgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHRoaXMucGFnaW5nID0gbnVsbDtcbiAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgeyBwYWdpbmcsIGRhdGEgfSA9IHJlc3VsdDtcbiAgICAgICAgICB0aGlzLnBhZ2luZyA9IHBhZ2luZztcbiAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBtb2RlIHNldHRlcjpcbiAgICogIC0gYXV0bzogVHJpZXMgdG8gYXV0b21hdGljYWxseSBsb2FkIG1vcmUgZGF0YSAoZGVmYXVsdCBtYXhpbXVtIDEwIGl0ZXJhdGlvbnM7IGNhbiBiZVxuICAgKiAgICAgICAgICBjaGFuZ2Ugd2l0aCBtYXhJdGVyYXRpb25zIHNldHRpbmdzKS5cbiAgICogIC0gc2hvdzogU2hvd3MgYSBsb2FkIG1vcmUgYnV0dG9uIGZvciB0aGUgdXNlciB0byBkZWNpZGVcbiAgICogIC0gbm9uZTogRG9lc24ndCBwZXJmb3JtIGFueSBsb2FkIG1vcmUgYWN0aW9uLlxuICAgKiAgLSBoaWRkZW46IExvYWRzIG1vcmUgZGF0YSBhdXRvbWF0aWNhbGx5IGJ1dCB3aXRoIG5vIHZpc2libGUgYnV0dG9uIGZvciB0aGUgdXNlci5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHNldCBjOHlGb3JMb2FkTW9yZSh0eXBlOiBMb2FkTW9yZU1vZGUpIHtcbiAgICB0aGlzLmxvYWRNb3JlTW9kZSA9IHR5cGU7XG4gIH1cblxuICAvKipcbiAgICogVGhlIHBpcGUgc2V0dGVyIHRvIGF0dGFjaCBhbnkgcnhqcyBwaXBlIHRvIHRoZSBjdXJyZW50IGFuZCBtb3JlIGxvYWRlZCBkYXRhLlxuICAgKi9cbiAgQElucHV0KClcbiAgc2V0IGM4eUZvclBpcGUoZGF0YVBpcGUpIHtcbiAgICBpZiAoZGF0YVBpcGUpIHtcbiAgICAgIHRoaXMuZGF0YVBpcGUgPSBkYXRhUGlwZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQSB0ZW1wbGF0ZSB0byB1c2UgaWYgbm8gZGF0YSBpcyBmb3VuZCBhdCBhbGwgKGUuZy4gaWYgeW91IGFwcGx5IGEgZmlsdGVyIHBpcGUpLlxuICAgKi9cbiAgQElucHV0KClcbiAgc2V0IGM4eUZvck5vdEZvdW5kKG5vdEZvdW5kVGVtcGxhdGU6IFRlbXBsYXRlUmVmPGFueT4pIHtcbiAgICB0aGlzLm5vdEZvdW5kVGVtcGxhdGUgPSBub3RGb3VuZFRlbXBsYXRlO1xuICAgIGlmICh0aGlzLmxvYWRNb3JlKSB7XG4gICAgICB0aGlzLmxvYWRNb3JlLm5vTW9yZURhdGFIaW50ID0gbm90Rm91bmRUZW1wbGF0ZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVGhlIG1heGltdW0gbnVtYmVycyBvZiBpdGVyYXRpb25zIHRvIGNhbGwgZGF0YSBmcm9tIHRoZSBhcGkuXG4gICAqL1xuICBASW5wdXQoKVxuICBzZXQgYzh5Rm9yTWF4SXRlcmF0aW9ucyhtYXhJdGVyYXRpb25zOiBudW1iZXIpIHtcbiAgICB0aGlzLm1heEl0ZXJhdGlvbnMgPSBtYXhJdGVyYXRpb25zO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgUmVhbHRpbWVTZXJ2aWNlIGluc3RhbmNlLlxuICAgKi9cbiAgQElucHV0KClcbiAgc2V0IGM4eUZvclJlYWx0aW1lKHNvdXJjZTogUmVhbHRpbWVTZXJ2aWNlPGFueT4pIHtcbiAgICB0aGlzLnJlYWx0aW1lID0gc291cmNlO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgY29tcGFyYXRvciBmdW5jdGlvbiBmb3IgY29tcGFyaW5nIGxpc3QgaXRlbXMuIFVzZWQgdG8gZGV0ZXJtaW5lXG4gICAqIHRoZSBwb3NpdGlvbiBhdCB3aGljaCBhIG5ldyBlbGVtZW50IHNob3VsZCBiZSBhZGRlZCB0byB0aGUgbGlzdC5cbiAgICovXG4gIEBJbnB1dCgpXG4gIHNldCBjOHlGb3JDb21wYXJhdG9yKGNvbXBhcmF0b3I6IChpdGVtQTogb2JqZWN0LCBpdGVtQjogb2JqZWN0KSA9PiBudW1iZXIpIHtcbiAgICB0aGlzLmNvbXBhcmF0b3IgPSBjb21wYXJhdG9yO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSB0cGw6IFRlbXBsYXRlUmVmPGFueT4sXG4gICAgcHJpdmF0ZSB2Y3I6IFZpZXdDb250YWluZXJSZWYsXG4gICAgcHJpdmF0ZSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlclxuICApIHt9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5oYW5kbGVSZWFsdGltZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKHRoaXMub2JzJCAmJiAoY2hhbmdlcy5jOHlGb3JQaXBlIHx8IGNoYW5nZXMuYzh5Rm9yT2YpKSB7XG4gICAgICB0aGlzLnVuc3Vic2NyaWJlUGFnaW5nKCk7XG5cbiAgICAgIC8vIG9ubHkgcmUtcmVuZGVyaW5nICBvbiBmaWx0ZXJpbmcgaWYgYWxsIGRhdGEgaXMgYWxyZWFkeSBsb2FkZWRcbiAgICAgIC8vIGZyb20gdGhlIGJhY2tlbmRcbiAgICAgIGNvbnN0IHJlUmVuZGVyID0gIXRoaXMuaGFzTW9yZURhdGEgJiYgISFjaGFuZ2VzLmM4eUZvclBpcGUgJiYgIWNoYW5nZXMuYzh5Rm9yT2Y7XG5cbiAgICAgIGlmIChyZVJlbmRlcikge1xuICAgICAgICB0aGlzLm9icyQgPSBvZih0aGlzLmNhY2hlZERhdGEpO1xuICAgICAgfVxuICAgICAgdGhpcy5wYWdpbmdTdWIgPSB0aGlzLm9icyRcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgdGFwKGRhdGEgPT4ge1xuICAgICAgICAgICAgaWYgKCFyZVJlbmRlcikge1xuICAgICAgICAgICAgICB0aGlzLmNhY2hlZERhdGEgPSBkYXRhO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIClcbiAgICAgICAgLnBpcGUoc3JjID0+IHRoaXMuZGF0YVBpcGUoc3JjKSlcbiAgICAgICAgLnN1YnNjcmliZSgoZGF0YTogW10pID0+IHtcbiAgICAgICAgICB0aGlzLnJlbmRlcihkYXRhLCByZVJlbmRlcik7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy51bnN1YnNjcmliZVBhZ2luZygpO1xuICAgIHRoaXMudW5zdWJzY3JpYmUkLm5leHQoKTtcbiAgICB0aGlzLnVuc3Vic2NyaWJlJC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVSZWFsdGltZSgpIHtcbiAgICBpZiAodGhpcy5yZWFsdGltZSkge1xuICAgICAgdGhpcy5yZWFsdGltZVxuICAgICAgICAub25DcmVhdGUkKClcbiAgICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMudW5zdWJzY3JpYmUkKSlcbiAgICAgICAgLnN1YnNjcmliZShpdGVtID0+IHRoaXMuaW5zZXJ0KGl0ZW0pKTtcbiAgICAgIHRoaXMucmVhbHRpbWVcbiAgICAgICAgLm9uVXBkYXRlJCgpXG4gICAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLnVuc3Vic2NyaWJlJCkpXG4gICAgICAgIC5zdWJzY3JpYmUoaXRlbSA9PiB0aGlzLnVwZGF0ZShpdGVtKSk7XG4gICAgICB0aGlzLnJlYWx0aW1lXG4gICAgICAgIC5vbkRlbGV0ZSQoKVxuICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy51bnN1YnNjcmliZSQpKVxuICAgICAgICAuc3Vic2NyaWJlKGlkID0+IHRoaXMucmVtb3ZlKGNvZXJjZU51bWJlclByb3BlcnR5KGlkKSkpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVuZGVyKGRhdGEsIHJlUmVuZGVyID0gZmFsc2UpOiB2b2lkIHtcbiAgICB0aGlzLnZjci5jbGVhcigpO1xuXG4gICAgZGF0YS5mb3JFYWNoKChpdGVtLCBpbmRleCkgPT4ge1xuICAgICAgY29uc3QgY29udGV4dCA9IHtcbiAgICAgICAgJGltcGxpY2l0OiBpdGVtLFxuICAgICAgICBpbmRleCxcbiAgICAgICAgbGVuZ3RoOiB0aGlzLmxlbmd0aCxcbiAgICAgICAgaGFzTW9yZTogdGhpcy5oYXNNb3JlRGF0YVxuICAgICAgfTtcbiAgICAgIHRoaXMudmNyLmNyZWF0ZUVtYmVkZGVkVmlldyh0aGlzLnRwbCwgY29udGV4dCk7XG4gICAgfSk7XG5cbiAgICBpZiAodGhpcy5zaG91bGRVc2VMb2FkTW9yZUJ1dHRvbikge1xuICAgICAgdGhpcy5sb2FkTW9yZSA9IHRoaXMuY3JlYXRlTG9hZE1vcmVCdXR0b25Db21wb25lbnQocmVSZW5kZXIpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXBwZW5kKGRhdGEpIHtcbiAgICBkYXRhLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuc2hvdWxkVXNlTG9hZE1vcmVCdXR0b24gPyB0aGlzLnZjci5sZW5ndGggLSAxIDogdGhpcy52Y3IubGVuZ3RoO1xuICAgICAgY29uc3QgY29udGV4dCA9IHtcbiAgICAgICAgJGltcGxpY2l0OiBpdGVtLFxuICAgICAgICBpbmRleCxcbiAgICAgICAgbGVuZ3RoOiB0aGlzLmxlbmd0aCxcbiAgICAgICAgaGFzTW9yZTogdGhpcy5oYXNNb3JlRGF0YVxuICAgICAgfTtcbiAgICAgIHRoaXMudmNyLmNyZWF0ZUVtYmVkZGVkVmlldyh0aGlzLnRwbCwgY29udGV4dCwgaW5kZXgpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2FkTW9yZURhdGEoZGF0YSkge1xuICAgIGlmIChkYXRhLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuYXBwZW5kKGRhdGEpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTG9hZE1vcmVCdXR0b25Db21wb25lbnQocmVSZW5kZXIpIHtcbiAgICBjb25zdCBjb21wb25lbnRGYWN0b3J5OiBDb21wb25lbnRGYWN0b3J5PFxuICAgICAgYW55XG4gICAgPiA9IHRoaXMuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KExvYWRNb3JlQ29tcG9uZW50KTtcbiAgICBjb25zdCBjb21wb25lbnRSZWYgPSB0aGlzLnZjci5jcmVhdGVDb21wb25lbnQoY29tcG9uZW50RmFjdG9yeSk7XG4gICAgY29uc3QgaW5zdGFuY2UgPSBjb21wb25lbnRSZWYuaW5zdGFuY2UgYXMgTG9hZE1vcmVDb21wb25lbnQ7XG4gICAgaW5zdGFuY2UucGFnaW5nID0gdGhpcy5wYWdpbmc7XG4gICAgaW5zdGFuY2UudXNlSW50ZXJzZWN0aW9uID0gdGhpcy5sb2FkTW9yZU1vZGUgPT09ICdhdXRvJyB8fCB0aGlzLmxvYWRNb3JlTW9kZSA9PT0gJ2hpZGRlbic7XG4gICAgaW5zdGFuY2UuaGlkZGVuID0gdGhpcy5sb2FkTW9yZU1vZGUgPT09ICdoaWRkZW4nO1xuICAgIGluc3RhbmNlLm1heEl0ZXJhdGlvbnMgPSB0aGlzLm1heEl0ZXJhdGlvbnM7XG4gICAgaW5zdGFuY2Uubm9Nb3JlRGF0YUhpbnQgPSB0aGlzLm5vdEZvdW5kVGVtcGxhdGU7XG4gICAgdGhpcy5wYWdpbmdTdWIgPSBpbnN0YW5jZS5vbkxvYWRcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoKGRhdGE6IFtdKSA9PiB0aGlzLmNoZWNrRm9yRHVwbGljYXRlcyhkYXRhKSksXG4gICAgICAgIHRhcCgoZGF0YTogW10pID0+IHtcbiAgICAgICAgICB0aGlzLmNhY2hlZERhdGEgPSB0aGlzLmNhY2hlZERhdGEuY29uY2F0KGRhdGEpO1xuICAgICAgICB9KVxuICAgICAgKVxuICAgICAgLnBpcGUoc3JjID0+IHRoaXMuZGF0YVBpcGUoc3JjKSlcbiAgICAgIC5zdWJzY3JpYmUoZGF0YSA9PiB0aGlzLmxvYWRNb3JlRGF0YShkYXRhKSk7XG4gICAgaWYgKHJlUmVuZGVyKSB7XG4gICAgICBhc3NpZ24oaW5zdGFuY2UsIHRoaXMubG9hZE1vcmUpO1xuICAgIH1cbiAgICByZXR1cm4gaW5zdGFuY2U7XG4gIH1cblxuICBwcml2YXRlIGluc2VydChpdGVtKSB7XG4gICAgbGV0IGluZGV4OiBudW1iZXIgPSAwO1xuXG4gICAgaWYgKHRoaXMuY29tcGFyYXRvciAmJiB0aGlzLmNhY2hlZERhdGEubGVuZ3RoKSB7XG4gICAgICBsZXQgY29tcGFyaXNpb25SZXN1bHQ6IG51bWJlcjtcbiAgICAgIGRvIHtcbiAgICAgICAgY29uc3QgdmlldzogRW1iZWRkZWRWaWV3UmVmPGFueT4gPSB0aGlzLnZjci5nZXQoaW5kZXgpIGFzIEVtYmVkZGVkVmlld1JlZjxhbnk+O1xuICAgICAgICBjb25zdCBpdGVtQiA9IGdldCh2aWV3LCAnY29udGV4dC4kaW1wbGljaXQnKTtcbiAgICAgICAgY29tcGFyaXNpb25SZXN1bHQgPSBpdGVtICYmIGl0ZW1CID8gdGhpcy5jb21wYXJhdG9yKGl0ZW0sIGl0ZW1CKSA6IDA7XG4gICAgICAgIGlmIChjb21wYXJpc2lvblJlc3VsdCA8PSAwKSB7XG4gICAgICAgICAgaW5kZXgrKztcbiAgICAgICAgfVxuICAgICAgfSB3aGlsZSAoY29tcGFyaXNpb25SZXN1bHQgPD0gMCAmJiBpbmRleCA8IHRoaXMuY2FjaGVkRGF0YS5sZW5ndGgpO1xuICAgIH1cblxuICAgIC8vIERvIG5vdCBhcHBlbmQgZWxlbWVudHMgYWZ0ZXIgdGhlIGxhc3Qgb25lIGN1cnJlbnRseSBsb2FkZWQsXG4gICAgLy8gYXMgaXQgbWF5IGJlbG9uZyBmdXJ0aGVyIGRvd24gdGhlcmUgb24gdGhlIGxpc3QgYW5kIHdpbGxcbiAgICAvLyBiZSBldmVudHVhbGx5IGxvYWRlZCB3aXRoIG9uZSBvZiB0aGUgbmV4dCBwYWdlcy5cbiAgICBpZiAoaW5kZXggPCB0aGlzLmNhY2hlZERhdGEubGVuZ3RoIHx8IHRoaXMuY2FjaGVkRGF0YS5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvbnN0IGNvbnRleHQgPSB7XG4gICAgICAgICRpbXBsaWNpdDogaXRlbSxcbiAgICAgICAgaW5kZXgsXG4gICAgICAgIGxlbmd0aDogdGhpcy5sZW5ndGgsXG4gICAgICAgIGhhc01vcmU6IHRoaXMuaGFzTW9yZURhdGFcbiAgICAgIH07XG5cbiAgICAgIHRoaXMuY2FjaGVkRGF0YS5zcGxpY2UoaW5kZXgsIDAsIGl0ZW0pO1xuICAgICAgY29uc3Qgdmlld1JlZjogVmlld1JlZiA9IHRoaXMudHBsLmNyZWF0ZUVtYmVkZGVkVmlldyhjb250ZXh0KTtcbiAgICAgIHRoaXMudmNyLmluc2VydCh2aWV3UmVmLCBpbmRleCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGUodXBkYXRlZEl0ZW0pIHtcbiAgICB0aGlzLmZvck1hdGNoaW5nRW1iZWRkZWRWaWV3UmVmKFxuICAgICAgKGl0ZW06IElJZGVudGlmaWVkKSA9PiBpdGVtICYmIHVwZGF0ZWRJdGVtICYmIGl0ZW0uaWQgPT09IHVwZGF0ZWRJdGVtLmlkLFxuICAgICAgKHZpZXc6IEVtYmVkZGVkVmlld1JlZjxhbnk+KSA9PiB7XG4gICAgICAgIHZpZXcuY29udGV4dC4kaW1wbGljaXQgPSB1cGRhdGVkSXRlbTtcbiAgICAgICAgdmlldy5tYXJrRm9yQ2hlY2soKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmUoaWRUb1JlbW92ZSkge1xuICAgIHRoaXMuZm9yTWF0Y2hpbmdFbWJlZGRlZFZpZXdSZWYoXG4gICAgICAoaXRlbTogSUlkZW50aWZpZWQpID0+IGl0ZW0gJiYgY29lcmNlTnVtYmVyUHJvcGVydHkoaXRlbS5pZCwgTmFOKSA9PT0gaWRUb1JlbW92ZSxcbiAgICAgICh2aWV3OiBFbWJlZGRlZFZpZXdSZWY8YW55PikgPT4gdmlldy5kZXN0cm95KClcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBmb3JNYXRjaGluZ0VtYmVkZGVkVmlld1JlZihcbiAgICBmaWx0ZXI6IChpdGVtOiBJSWRlbnRpZmllZCkgPT4gYm9vbGVhbixcbiAgICBjYWxsYmFjazogKHZpZXc6IEVtYmVkZGVkVmlld1JlZjxhbnk+KSA9PiB2b2lkXG4gICkge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy52Y3IubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHZpZXc6IEVtYmVkZGVkVmlld1JlZjxhbnk+ID0gdGhpcy52Y3IuZ2V0KGkpIGFzIEVtYmVkZGVkVmlld1JlZjxhbnk+O1xuICAgICAgY29uc3QgaXRlbTogSUlkZW50aWZpZWQgPSBnZXQodmlldywgJ2NvbnRleHQuJGltcGxpY2l0Jyk7XG4gICAgICBpZiAoZmlsdGVyKGl0ZW0pKSB7XG4gICAgICAgIGNhbGxiYWNrKHZpZXcpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tGb3JEdXBsaWNhdGVzKGRhdGE6IElJZGVudGlmaWVkW10pOiBJSWRlbnRpZmllZFtdIHtcbiAgICByZXR1cm4gdGhpcy5yZWFsdGltZVxuICAgICAgPyBkYXRhLmZpbHRlcihpdGVtID0+ICF0aGlzLmNhY2hlZERhdGEuc29tZShjYWNoZWQgPT4gY2FjaGVkLmlkID09PSBpdGVtLmlkKSlcbiAgICAgIDogZGF0YTtcbiAgfVxuXG4gIHByaXZhdGUgdW5zdWJzY3JpYmVQYWdpbmcoKSB7XG4gICAgaWYgKHRoaXMucGFnaW5nU3ViKSB7XG4gICAgICB0aGlzLnBhZ2luZ1N1Yi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxufVxuIl19