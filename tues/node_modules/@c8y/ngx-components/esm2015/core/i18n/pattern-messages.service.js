import * as tslib_1 from "tslib";
import { Injectable, Inject } from '@angular/core';
import { mapValues, each } from 'lodash-es';
import { HOOK_PATTERN_MESSAGES } from './patterns-message.hook';
import { formatDate } from '@angular/common';
import * as i0 from "@angular/core";
import * as i1 from "./patterns-message.hook";
/**
 * A service to translate messages by using regexp patterns.
 */
let PatternMessagesService = class PatternMessagesService {
    constructor(patterns) {
        this.patterns = {};
        this.pipes = {
            absoluteDate: (date) => formatDate(date, 'medium', this.translateService.currentLang),
            translate: (key) => this.translateService.instant(key)
        };
        each(patterns, (pattern) => {
            Object.assign(this.patterns, pattern);
        });
    }
    translate(message) {
        const translation = this.translateWithPatterns(message);
        return (translation !== message) ? translation : '';
    }
    translateWithPatterns(message, patterns = this.patterns) {
        let translatedMessage = message;
        each(patterns, (patternCfg, pattern) => {
            const globalRegExp = new RegExp(pattern, 'g');
            let globalMatch;
            if (!globalRegExp.test(translatedMessage)) {
                return;
            }
            globalRegExp.test(''); // reset the regexp
            globalMatch = globalRegExp.exec(translatedMessage);
            while (globalMatch !== null) {
                const [localMatch] = globalMatch;
                const placeholderValues = mapValues(patternCfg.placeholders, (placeholder) => {
                    const expr = placeholder.capture || placeholder;
                    let replacement = localMatch.replace(new RegExp(pattern, 'g'), expr);
                    if (placeholder.translate) {
                        replacement = this.translateWithPatterns(replacement, placeholder.translate);
                    }
                    return replacement;
                });
                translatedMessage = translatedMessage.replace(localMatch, this.translateWithParams(patternCfg, placeholderValues));
                globalMatch = globalRegExp.exec(translatedMessage);
            }
        });
        return translatedMessage;
    }
    translateWithParams(patternCfg, params = {}) {
        const { defaultLang, currentLang, compiler } = this.translateService;
        const translations = this.translateService.store.translations[currentLang];
        const defaultTranslations = this.translateService.store.translations[defaultLang];
        const originalKey = patternCfg.gettext;
        let originalValue = originalKey;
        if (translations) {
            if (translations[originalKey]) {
                originalValue = translations[originalKey];
            }
            else if (defaultTranslations) {
                if (defaultTranslations[originalKey]) {
                    originalValue = defaultTranslations[originalKey];
                }
            }
        }
        let key = originalKey;
        let value = originalValue;
        const interpolateParams = Object.assign({}, params, { noPatternMessages: true });
        let match;
        const pipeRegex = RegExp('{{\\s*([^\\s]+)\\s*\\|\\s*([^\\s]+)\\s*}}', 'g');
        // tslint:disable-next-line:no-conditional-assignment
        while ((match = pipeRegex.exec(originalKey)) !== null) {
            const [placeholder, paramName, pipeName] = match;
            if (this.pipes[pipeName]) {
                key = key.replace(placeholder, `{{${paramName}}}`);
                value = value.replace(placeholder, `{{${paramName}}}`);
                interpolateParams[paramName] = this.pipes[pipeName](params[paramName]);
            }
        }
        if (translations) {
            translations[key] = compiler.compile(value, currentLang);
        }
        return this.translateService.instant(key, interpolateParams);
    }
};
PatternMessagesService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [HOOK_PATTERN_MESSAGES,] }] }
];
PatternMessagesService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function PatternMessagesService_Factory() { return new PatternMessagesService(i0.ɵɵinject(i1.HOOK_PATTERN_MESSAGES)); }, token: PatternMessagesService, providedIn: "root" });
PatternMessagesService = tslib_1.__decorate([
    Injectable({
        providedIn: 'root'
    }),
    tslib_1.__param(0, Inject(HOOK_PATTERN_MESSAGES))
], PatternMessagesService);
export { PatternMessagesService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGF0dGVybi1tZXNzYWdlcy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImNvcmUvaTE4bi9wYXR0ZXJuLW1lc3NhZ2VzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRW5ELE9BQU8sRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzVDLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ2hFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQzs7O0FBRTdDOztHQUVHO0FBSUgsSUFBYSxzQkFBc0IsR0FBbkMsTUFBYSxzQkFBc0I7SUFVakMsWUFDaUMsUUFBUTtRQVR6QyxhQUFRLEdBQVEsRUFBRSxDQUFDO1FBQ25CLFVBQUssR0FBRztZQUNOLFlBQVksRUFBRSxDQUFDLElBQXdCLEVBQUUsRUFBRSxDQUN6QyxVQUFVLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDO1lBQy9ELFNBQVMsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQ2pCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDO1NBQ3JDLENBQUM7UUFLQSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDekIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELFNBQVMsQ0FBQyxPQUFlO1FBQ3ZCLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN4RCxPQUFPLENBQUMsV0FBVyxL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c0JBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQgeyBtYXBWYWx1ZXMsIGVhY2ggfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgSE9PS19QQVRURVJOX01FU1NBR0VTIH0gZnJvbSAnLi9wYXR0ZXJucy1tZXNzYWdlLmhvb2snO1xuaW1wb3J0IHsgZm9ybWF0RGF0ZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5cbi8qKlxuICogQSBzZXJ2aWNlIHRvIHRyYW5zbGF0ZSBtZXNzYWdlcyBieSB1c2luZyByZWdleHAgcGF0dGVybnMuXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFBhdHRlcm5NZXNzYWdlc1NlcnZpY2Uge1xuICB0cmFuc2xhdGVTZXJ2aWNlOiBUcmFuc2xhdGVTZXJ2aWNlO1xuICBwYXR0ZXJuczogYW55ID0ge307XG4gIHBpcGVzID0ge1xuICAgIGFic29sdXRlRGF0ZTogKGRhdGU6IHN0cmluZ3xudW1iZXJ8RGF0ZSkgPT5cbiAgICAgIGZvcm1hdERhdGUoZGF0ZSwgJ21lZGl1bScsIHRoaXMudHJhbnNsYXRlU2VydmljZS5jdXJyZW50TGFuZyksXG4gICAgdHJhbnNsYXRlOiAoa2V5KSA9PlxuICAgICAgdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoa2V5KVxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoSE9PS19QQVRURVJOX01FU1NBR0VTKSBwYXR0ZXJuc1xuICApIHtcbiAgICBlYWNoKHBhdHRlcm5zLCAocGF0dGVybikgPT4ge1xuICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLnBhdHRlcm5zLCBwYXR0ZXJuKTtcbiAgICB9KTtcbiAgfVxuXG4gIHRyYW5zbGF0ZShtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICBjb25zdCB0cmFuc2xhdGlvbiA9IHRoaXMudHJhbnNsYXRlV2l0aFBhdHRlcm5zKG1lc3NhZ2UpO1xuICAgIHJldHVybiAodHJhbnNsYXRpb24gIT09IG1lc3NhZ2UpID8gdHJhbnNsYXRpb24gOiAnJztcbiAgfVxuXG4gIHByaXZhdGUgdHJhbnNsYXRlV2l0aFBhdHRlcm5zKG1lc3NhZ2UsIHBhdHRlcm5zID0gdGhpcy5wYXR0ZXJucykge1xuICAgIGxldCB0cmFuc2xhdGVkTWVzc2FnZSA9IG1lc3NhZ2U7XG5cbiAgICBlYWNoKHBhdHRlcm5zLCAocGF0dGVybkNmZywgcGF0dGVybikgPT4ge1xuICAgICAgY29uc3QgZ2xvYmFsUmVnRXhwID0gbmV3IFJlZ0V4cChwYXR0ZXJuLCAnZycpO1xuICAgICAgbGV0IGdsb2JhbE1hdGNoO1xuXG4gICAgICBpZiAoIWdsb2JhbFJlZ0V4cC50ZXN0KHRyYW5zbGF0ZWRNZXNzYWdlKSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBnbG9iYWxSZWdFeHAudGVzdCgnJyk7IC8vIHJlc2V0IHRoZSByZWdleHBcbiAgICAgIGdsb2JhbE1hdGNoID0gZ2xvYmFsUmVnRXhwLmV4ZWModHJhbnNsYXRlZE1lc3NhZ2UpO1xuICAgICAgd2hpbGUgKGdsb2JhbE1hdGNoICE9PSBudWxsKSB7XG4gICAgICAgIGNvbnN0IFsgbG9jYWxNYXRjaCBdID0gZ2xvYmFsTWF0Y2g7XG5cbiAgICAgICAgY29uc3QgcGxhY2Vob2xkZXJWYWx1ZXMgPSBtYXBWYWx1ZXMocGF0dGVybkNmZy5wbGFjZWhvbGRlcnMsIChwbGFjZWhvbGRlcikgPT4ge1xuICAgICAgICAgIGNvbnN0IGV4cHIgPSBwbGFjZWhvbGRlci5jYXB0dXJlIHx8IHBsYWNlaG9sZGVyO1xuICAgICAgICAgIGxldCByZXBsYWNlbWVudCA9IGxvY2FsTWF0Y2gucmVwbGFjZShuZXcgUmVnRXhwKHBhdHRlcm4sICdnJyksIGV4cHIpO1xuXG4gICAgICAgICAgaWYgKHBsYWNlaG9sZGVyLnRyYW5zbGF0ZSkge1xuICAgICAgICAgICAgcmVwbGFjZW1lbnQgPSB0aGlzLnRyYW5zbGF0ZVdpdGhQYXR0ZXJucyhyZXBsYWNlbWVudCwgcGxhY2Vob2xkZXIudHJhbnNsYXRlKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gcmVwbGFjZW1lbnQ7XG4gICAgICAgIH0pO1xuICAgICAgICB0cmFuc2xhdGVkTWVzc2FnZSA9IHRyYW5zbGF0ZWRNZXNzYWdlLnJlcGxhY2UoXG4gICAgICAgICAgbG9jYWxNYXRjaCxcbiAgICAgICAgICB0aGlzLnRyYW5zbGF0ZVdpdGhQYXJhbXMocGF0dGVybkNmZywgcGxhY2Vob2xkZXJWYWx1ZXMpXG4gICAgICAgICk7XG5cbiAgICAgICAgZ2xvYmFsTWF0Y2ggPSBnbG9iYWxSZWdFeHAuZXhlYyh0cmFuc2xhdGVkTWVzc2FnZSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHRyYW5zbGF0ZWRNZXNzYWdlO1xuICB9XG5cbiAgcHJpdmF0ZSB0cmFuc2xhdGVXaXRoUGFyYW1zKHBhdHRlcm5DZmc6IGFueSwgcGFyYW1zOiBhbnkgPSB7fSkge1xuICAgIGNvbnN0IHsgZGVmYXVsdExhbmcsIGN1cnJlbnRMYW5nLCBjb21waWxlciB9ID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlO1xuICAgIGNvbnN0IHRyYW5zbGF0aW9ucyA9IHRoaXMudHJhbnNsYXRlU2VydmljZS5zdG9yZS50cmFuc2xhdGlvbnNbY3VycmVudExhbmddO1xuICAgIGNvbnN0IGRlZmF1bHRUcmFuc2xhdGlvbnMgPSB0aGlzLnRyYW5zbGF0ZVNlcnZpY2Uuc3RvcmUudHJhbnNsYXRpb25zW2RlZmF1bHRMYW5nXTtcbiAgICBjb25zdCBvcmlnaW5hbEtleSA9IHBhdHRlcm5DZmcuZ2V0dGV4dDtcblxuICAgIGxldCBvcmlnaW5hbFZhbHVlID0gb3JpZ2luYWxLZXk7XG4gICAgaWYgKHRyYW5zbGF0aW9ucykge1xuICAgICAgaWYgKHRyYW5zbGF0aW9uc1tvcmlnaW5hbEtleV0pIHtcbiAgICAgICAgb3JpZ2luYWxWYWx1ZSA9IHRyYW5zbGF0aW9uc1tvcmlnaW5hbEtleV07XG4gICAgICB9IGVsc2UgaWYgKGRlZmF1bHRUcmFuc2xhdGlvbnMpIHtcbiAgICAgICAgaWYgKGRlZmF1bHRUcmFuc2xhdGlvbnNbb3JpZ2luYWxLZXldKSB7XG4gICAgICAgICAgb3JpZ2luYWxWYWx1ZSA9IGRlZmF1bHRUcmFuc2xhdGlvbnNbb3JpZ2luYWxLZXldO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGtleSA9IG9yaWdpbmFsS2V5O1xuICAgIGxldCB2YWx1ZSA9IG9yaWdpbmFsVmFsdWU7XG4gICAgY29uc3QgaW50ZXJwb2xhdGVQYXJhbXMgPSB7XG4gICAgICAuLi5wYXJhbXMsXG4gICAgICBub1BhdHRlcm5NZXNzYWdlczogdHJ1ZVxuICAgIH07XG5cbiAgICBsZXQgbWF0Y2g7XG4gICAgY29uc3QgcGlwZVJlZ2V4ID0gUmVnRXhwKCd7e1xcXFxzKihbXlxcXFxzXSspXFxcXHMqXFxcXHxcXFxccyooW15cXFxcc10rKVxcXFxzKn19JywgJ2cnKTtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uZGl0aW9uYWwtYXNzaWdubWVudFxuICAgIHdoaWxlICgobWF0Y2ggPSBwaXBlUmVnZXguZXhlYyhvcmlnaW5hbEtleSkpICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBbcGxhY2Vob2xkZXIsIHBhcmFtTmFtZSwgcGlwZU5hbWVdID0gbWF0Y2g7XG4gICAgICBpZiAodGhpcy5waXBlc1twaXBlTmFtZV0pIHtcbiAgICAgICAga2V5ID0ga2V5LnJlcGxhY2UocGxhY2Vob2xkZXIsIGB7eyR7cGFyYW1OYW1lfX19YCk7XG4gICAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZShwbGFjZWhvbGRlciwgYHt7JHtwYXJhbU5hbWV9fX1gKTtcbiAgICAgICAgaW50ZXJwb2xhdGVQYXJhbXNbcGFyYW1OYW1lXSA9IHRoaXMucGlwZXNbcGlwZU5hbWVdKHBhcmFtc1twYXJhbU5hbWVdKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodHJhbnNsYXRpb25zKSB7XG4gICAgICB0cmFuc2xhdGlvbnNba2V5XSA9IGNvbXBpbGVyLmNvbXBpbGUodmFsdWUsIGN1cnJlbnRMYW5nKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KGtleSwgaW50ZXJwb2xhdGVQYXJhbXMpO1xuICB9XG59XG4iXX0=