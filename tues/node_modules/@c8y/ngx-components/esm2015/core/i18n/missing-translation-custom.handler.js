import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { PatternMessagesService } from './pattern-messages.service';
import { MissingTranslationHandler, MissingTranslationHandlerParams, TranslateParser, TranslateService } from '@ngx-translate/core';
let MissingTranslationCustomHandler = class MissingTranslationCustomHandler {
    constructor(parser, patternMessagesService) {
        this.parser = parser;
        this.patternMessagesService = patternMessagesService;
        this.cache = {};
    }
    handle(params) {
        const { key: messageKey, interpolateParams, translateService } = params;
        this.translateService = translateService;
        let translation = this.getFromCache(messageKey, interpolateParams);
        if (!translation) {
            const patternMessageTranslation = this.getPatternMessageTranslation(messageKey, interpolateParams);
            if (patternMessageTranslation) {
                translation = patternMessageTranslation;
            }
            else {
                translation = this.parser.interpolate(messageKey, interpolateParams);
            }
            this.addToCache(messageKey, interpolateParams, translation);
        }
        return translation;
    }
    getFromCache(messageKey, interpolateParams) {
        const { currentLang } = this.translateService;
        const currentCache = this.cache[currentLang] || {};
        const cacheKey = this.getCacheKey(messageKey, interpolateParams);
        return currentCache[cacheKey];
    }
    addToCache(messageKey, interpolateParams, translation) {
        const { currentLang } = this.translateService;
        const currentCache = this.cache[currentLang] = this.cache[currentLang] || {};
        const cacheKey = this.getCacheKey(messageKey, interpolateParams);
        currentCache[cacheKey] = translation;
    }
    getCacheKey(messageKey, interpolateParams) {
        return interpolateParams ? `${messageKey} ${JSON.stringify(interpolateParams)}` : messageKey;
    }
    getPatternMessageTranslation(messageKey, interpolateParams) {
        const shouldTryPatternMessages = !interpolateParams || !(interpolateParams.noPatternMessages);
        if (shouldTryPatternMessages) {
            if (!this.patternMessagesService.translateService) {
                this.patternMessagesService.translateService = this.translateService;
            }
            return this.patternMessagesService.translate(messageKey);
        }
        return undefined;
    }
};
MissingTranslationCustomHandler.ctorParameters = () => [
    { type: TranslateParser },
    { type: PatternMessagesService }
];
MissingTranslationCustomHandler = tslib_1.__decorate([
    Injectable()
], MissingTranslationCustomHandler);
export { MissingTranslationCustomHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWlzc2luZy10cmFuc2xhdGlvbi1jdXN0b20uaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2kxOG4vbWlzc2luZy10cmFuc2xhdGlvbi1jdXN0b20uaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRSxPQUFPLEVBQ0wseUJBQXlCLEVBQ3pCLCtCQUErQixFQUMvQixlQUFlLEVBQ2YsZ0JBQWdCLEVBQ2pCLE1BQU0scUJBQXFCLENBQUM7QUFHN0IsSUFBYSwrQkFBK0IsR0FBNUMsTUFBYSwrQkFBK0I7SUFJMUMsWUFDVSxNQUF1QixFQUN2QixzQkFBOEM7UUFEOUMsV0FBTSxHQUFOLE1BQU0sQ0FBaUI7UUFDdkIsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUF3QjtRQUp4RCxVQUFLLEdBQVEsRUFBRSxDQUFDO0lBS2IsQ0FBQztJQUVKLE1BQU0sQ0FBQyxNQUF1QztRQUM1QyxNQUFNLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxpQkFBaUIsRUFBRSxnQkFBZ0IsRUFBRSxHQUFHLE1BQU0sQ0FBQztRQUN4RSxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUM7UUFFekMsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztRQUVuRSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ2hCLE1BQU0seUJBQXlCLEdBQUcsSUFBSSxDQUFDLDRCQUE0QixDQUFDLFVBQVUsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1lBQ25HLElBQUkseUJBQXlCLEVBQUU7Z0JBQzdCLFdBQVcsR0FBRyx5QkFBeUIsQ0FBQzthQUN6QztpQkFBTTtnQkFDTCxXQUFXLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLGlCQUFpQixDQUFDLENBQUM7YUFDdEU7WUFFRCxJQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsRUFBRSxpQkFBaUIsRUFBRSxXQUFXLENBQUMsQ0FBQztTQUM3RDtRQUVELE9BQU8sV0FBVyxDQUFDO0lBQ3JCLENBQUM7SUFFTyxZQUFZLENBQUMsVUFBa0IsRUFBRSxpQkFBeUI7UUFDaEUsTUFBTSxFQUFFLFdBQVcsRUFBRSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztRQUM5QyxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNuRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1FBQ2pFLE9BQU8sWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFTyxVQUFVLENBQUMsVUFBa0IsRUFBRSxpQkFBeUIsRUFBRSxXQUFtQjtRQUNuRixNQUFNLEVBQUUsV0FBVyxFQUFFLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDO1FBQzlDLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDN0UsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztRQUNqRSxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsV0FBVyxDQUFDO0lBQ3ZDLENBQUM7SUFFTyxXQUFXLENBQUMsVUFBa0IsRUFBRSxpQkFBeUI7UUFDL0QsT0FBTyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsR0FBRyxVQUFVLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQztJQUMvRixDQUFDO0lBRU8sNEJBQTRCLENBQUMsVUFBa0IsRUFBRSxpQkFBeUI7UUFDaEYsTUFBTSx3QkFBd0IsR0FBRyxDQUFDLGlCQUFpQixJQUFJLENBQUMsQ0FBRSxpQkFBeUIsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBRXZHLElBQUksd0JBQXdCLEVBQUU7WUFDNUIsSUFBSSxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDakQsSUFBSSxDQUFDLHNCQUFzQixDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQzthQUN0RTtZQUNELE9BQU8sSUFBSSxDQUFDLHNCQUFzQixDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUMxRDtRQUVELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7Q0FDRixDQUFBOztZQXREbUIsZUFBZTtZQUNDLHNCQUFzQjs7QUFON0MsK0JBQStCO0lBRDNDLFVBQVUsRUFBRTtHQUNBLCtCQUErQixDQTJEM0M7U0EzRFksK0JBQStCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUGF0dGVybk1lc3NhZ2VzU2VydmljZSB9IGZyb20gJy4vcGF0dGVybi1tZXNzYWdlcy5zZXJ2aWNlJztcbmltcG9ydCB7XG4gIE1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXIsXG4gIE1pc3NpbmdUcmFuc2xhdGlvbkhhbmRsZXJQYXJhbXMsXG4gIFRyYW5zbGF0ZVBhcnNlcixcbiAgVHJhbnNsYXRlU2VydmljZVxufSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE1pc3NpbmdUcmFuc2xhdGlvbkN1c3RvbUhhbmRsZXIgaW1wbGVtZW50cyBNaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyIHtcbiAgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRlU2VydmljZTtcbiAgY2FjaGU6IGFueSA9IHt9O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcGFyc2VyOiBUcmFuc2xhdGVQYXJzZXIsXG4gICAgcHJpdmF0ZSBwYXR0ZXJuTWVzc2FnZXNTZXJ2aWNlOiBQYXR0ZXJuTWVzc2FnZXNTZXJ2aWNlXG4gICkge31cblxuICBoYW5kbGUocGFyYW1zOiBNaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyUGFyYW1zKSB7XG4gICAgY29uc3QgeyBrZXk6IG1lc3NhZ2VLZXksIGludGVycG9sYXRlUGFyYW1zLCB0cmFuc2xhdGVTZXJ2aWNlIH0gPSBwYXJhbXM7XG4gICAgdGhpcy50cmFuc2xhdGVTZXJ2aWNlID0gdHJhbnNsYXRlU2VydmljZTtcblxuICAgIGxldCB0cmFuc2xhdGlvbiA9IHRoaXMuZ2V0RnJvbUNhY2hlKG1lc3NhZ2VLZXksIGludGVycG9sYXRlUGFyYW1zKTtcblxuICAgIGlmICghdHJhbnNsYXRpb24pIHtcbiAgICAgIGNvbnN0IHBhdHRlcm5NZXNzYWdlVHJhbnNsYXRpb24gPSB0aGlzLmdldFBhdHRlcm5NZXNzYWdlVHJhbnNsYXRpb24obWVzc2FnZUtleSwgaW50ZXJwb2xhdGVQYXJhbXMpO1xuICAgICAgaWYgKHBhdHRlcm5NZXNzYWdlVHJhbnNsYXRpb24pIHtcbiAgICAgICAgdHJhbnNsYXRpb24gPSBwYXR0ZXJuTWVzc2FnZVRyYW5zbGF0aW9uO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdHJhbnNsYXRpb24gPSB0aGlzLnBhcnNlci5pbnRlcnBvbGF0ZShtZXNzYWdlS2V5LCBpbnRlcnBvbGF0ZVBhcmFtcyk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuYWRkVG9DYWNoZShtZXNzYWdlS2V5LCBpbnRlcnBvbGF0ZVBhcmFtcywgdHJhbnNsYXRpb24pO1xuICAgIH1cblxuICAgIHJldHVybiB0cmFuc2xhdGlvbjtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RnJvbUNhY2hlKG1lc3NhZ2VLZXk6IHN0cmluZywgaW50ZXJwb2xhdGVQYXJhbXM6IG9iamVjdCk6IHN0cmluZyB7XG4gICAgY29uc3QgeyBjdXJyZW50TGFuZyB9ID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlO1xuICAgIGNvbnN0IGN1cnJlbnRDYWNoZSA9IHRoaXMuY2FjaGVbY3VycmVudExhbmddIHx8IHt9O1xuICAgIGNvbnN0IGNhY2hlS2V5ID0gdGhpcy5nZXRDYWNoZUtleShtZXNzYWdlS2V5LCBpbnRlcnBvbGF0ZVBhcmFtcyk7XG4gICAgcmV0dXJuIGN1cnJlbnRDYWNoZVtjYWNoZUtleV07XG4gIH1cblxuICBwcml2YXRlIGFkZFRvQ2FjaGUobWVzc2FnZUtleTogc3RyaW5nLCBpbnRlcnBvbGF0ZVBhcmFtczogb2JqZWN0LCB0cmFuc2xhdGlvbjogc3RyaW5nKSB7XG4gICAgY29uc3QgeyBjdXJyZW50TGFuZyB9ID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlO1xuICAgIGNvbnN0IGN1cnJlbnRDYWNoZSA9IHRoaXMuY2FjaGVbY3VycmVudExhbmddID0gdGhpcy5jYWNoZVtjdXJyZW50TGFuZ10gfHwge307XG4gICAgY29uc3QgY2FjaGVLZXkgPSB0aGlzLmdldENhY2hlS2V5KG1lc3NhZ2VLZXksIGludGVycG9sYXRlUGFyYW1zKTtcbiAgICBjdXJyZW50Q2FjaGVbY2FjaGVLZXldID0gdHJhbnNsYXRpb247XG4gIH1cblxuICBwcml2YXRlIGdldENhY2hlS2V5KG1lc3NhZ2VLZXk6IHN0cmluZywgaW50ZXJwb2xhdGVQYXJhbXM6IG9iamVjdCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGludGVycG9sYXRlUGFyYW1zID8gYCR7bWVzc2FnZUtleX0gJHtKU09OLnN0cmluZ2lmeShpbnRlcnBvbGF0ZVBhcmFtcyl9YCA6IG1lc3NhZ2VLZXk7XG4gIH1cblxuICBwcml2YXRlIGdldFBhdHRlcm5NZXNzYWdlVHJhbnNsYXRpb24obWVzc2FnZUtleTogc3RyaW5nLCBpbnRlcnBvbGF0ZVBhcmFtczogb2JqZWN0KTogc3RyaW5nIHtcbiAgICBjb25zdCBzaG91bGRUcnlQYXR0ZXJuTWVzc2FnZXMgPSAhaW50ZXJwb2xhdGVQYXJhbXMgfHwgISgoaW50ZXJwb2xhdGVQYXJhbXMgYXMgYW55KS5ub1BhdHRlcm5NZXNzYWdlcyk7XG5cbiAgICBpZiAoc2hvdWxkVHJ5UGF0dGVybk1lc3NhZ2VzKSB7XG4gICAgICBpZiAoIXRoaXMucGF0dGVybk1lc3NhZ2VzU2VydmljZS50cmFuc2xhdGVTZXJ2aWNlKSB7XG4gICAgICAgIHRoaXMucGF0dGVybk1lc3NhZ2VzU2VydmljZS50cmFuc2xhdGVTZXJ2aWNlID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXMucGF0dGVybk1lc3NhZ2VzU2VydmljZS50cmFuc2xhdGUobWVzc2FnZUtleSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxufVxuIl19