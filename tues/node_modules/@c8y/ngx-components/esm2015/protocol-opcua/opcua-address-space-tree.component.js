import * as tslib_1 from "tslib";
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { AddressSpaceNode, AddressSpaceService, NodeNavigationData } from './address-space.service';
import { OpcuaService } from './opcuaService';
import { AlertService } from '@c8y/ngx-components';
import { DynamicDataSource } from './dynamic-data-source';
import { NestedTreeControl } from '@angular/cdk/tree';
import { clone } from 'lodash';
let OpcuaAddressSpaceTreeComponent = class OpcuaAddressSpaceTreeComponent {
    constructor(addressSpaceService, opcuaService, alertService) {
        this.addressSpaceService = addressSpaceService;
        this.opcuaService = opcuaService;
        this.alertService = alertService;
        this.focusEmitter = new EventEmitter();
        this.selectedNode = new EventEmitter();
        this.dataSource = null;
        this.loading = false;
        this.getChildren = (node) => (node.expanded ? node.children : []);
        this.hasChild = (_, _nodeData) => this.addressSpaceService.childrenAvailable(_nodeData.references);
    }
    set moId(id) {
        this._moId = id || undefined;
    }
    ngOnInit() {
        this.initializeDataSet();
    }
    ngOnChanges(changes) {
        if (changes.moId && (changes.moId.currentValue !== changes.moId.previousValue)) {
            this.initializeDataSet();
        }
    }
    initializeDataSet() {
        this.nodeNavDataSubscription = this.addressSpaceService
            .getNodeNavData$()
            .subscribe(nodeNavData => this.openNode(nodeNavData));
        this.subscriptionRef = this.focusEmitter.subscribe(node => {
            this.focused = this.isFocusedNode(node) ? undefined : node;
        });
    }
    ngOnDestroy() {
        // clean up the address-space-tree
        this.addressSpaceService.resetTreeToRootNode();
        if (this.nodeNavDataSubscription && !this.nodeNavDataSubscription.closed) {
            this.nodeNavDataSubscription.unsubscribe();
        }
        if (this.subscriptionRef && !this.subscriptionRef.closed) {
            this.subscriptionRef.unsubscribe();
        }
    }
    openNode(nodeNavData) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const { node, selectedAncestorIds } = nodeNavData;
            let nodeId;
            // We just set the nodeId when the selectedAncestorIds variable an empty array.
            // If selectedAncestorIds contain any id we assume that the tree should be travsersed beginning
            // from the root node.
            if (node && node.nodeId && selectedAncestorIds && selectedAncestorIds.length === 0) {
                nodeId = node.nodeId;
            }
            // Always recreate the tree when routing to a specific nested node,
            // because previous modifications to the tree-structure could cause errors
            // while traversing with 'old' tree-data
            // -----------------
            // setupTree is able to handle nodeId = undefined
            yield this.setupTree(nodeId);
            if (!selectedAncestorIds || selectedAncestorIds.length === 0) {
                return;
            }
            if (nodeNavData && this.dataSource) {
                const clonedAncestors = clone(selectedAncestorIds);
                clonedAncestors.shift();
                const n = yield this.dataSource.toggleNode(this.dataSource.data[0], true);
                this.setChildNodes(n.children, clonedAncestors);
                this.toggleFocusedNode(node);
            }
        });
    }
    setChildNodes(nodes, ids) {
        if (nodes) {
            ids.forEach((id) => tslib_1.__awaiter(this, void 0, void 0, function* () {
                const match = nodes.find(n => n.nodeId === id);
                if (match && ids.length > 0) {
                    const idx = ids.findIndex(value => value === id);
                    if (idx >= 0) {
                        ids.splice(idx, 1);
                    }
                    const toggledNode = yield this.dataSource.toggleNode(match, true);
                    this.setChildNodes(toggledNode.children, ids);
                }
            }));
        }
    }
    setupTree(nodeId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.loading = true;
            if (!this._moId || this._moId.length === 0) {
                this._moId = this.opcuaService.getMoId();
            }
            // addressSpaceService.getNode returns either the root node of the server (moId)
            // or if nodeId !== undefined the node with given nodeId
            const res = yield this.addressSpaceService.getNode(this._moId, nodeId);
            if (res) {
                if (res.status !== 200) {
                    const data = res.json ? yield res.json() : undefined;
                    this.alertService.addServerFailure({ data, res });
                    this.dataSource = undefined;
                }
                else {
                    const rootNode = (yield res.json());
                    this.nestedTreeControl = new NestedTreeControl(this.getChildren);
                    this.dataSource = new DynamicDataSource(this.nestedTreeControl, this.addressSpaceService, this._moId);
                    this.dataSource.data = [rootNode];
                }
                this.loading = false;
            }
            else {
                this.loading = false;
            }
        });
    }
    getMoId() {
        if (!this._moId || this._moId.length === 0) {
            return this.opcuaService.getMoId();
        }
        return this._moId;
    }
    getIcon(nodeClassName) {
        return this.addressSpaceService.getIcon(nodeClassName);
    }
    toggleFocusedNode(node) {
        const relativePath = [];
        this.getRelativePath(node, relativePath);
        node.relativePath = relativePath;
        this.selectedNode.emit(node);
        this.focused = this.isFocusedNode(node) ? undefined : node;
    }
    isFocusedNode(node) {
        if (this.focused) {
            return node.nodeId === this.focused.nodeId;
        }
        return false;
    }
    getRelativePath(node, relativePath) {
        if (node.parentNode) {
            relativePath.unshift(node.browseName);
            this.getRelativePath(node.parentNode, relativePath);
        }
    }
};
OpcuaAddressSpaceTreeComponent.ctorParameters = () => [
    { type: AddressSpaceService },
    { type: OpcuaService },
    { type: AlertService }
];
tslib_1.__decorate([
    Input()
], OpcuaAddressSpaceTreeComponent.prototype, "moId", null);
tslib_1.__decorate([
    Input()
], OpcuaAddressSpaceTreeComponent.prototype, "node", void 0);
tslib_1.__decorate([
    Input()
], OpcuaAddressSpaceTreeComponent.prototype, "focusEmitter", void 0);
tslib_1.__decorate([
    Output()
], OpcuaAddressSpaceTreeComponent.prototype, "selectedNode", void 0);
OpcuaAddressSpaceTreeComponent = tslib_1.__decorate([
    Component({
        selector: 'opcua-address-space-tree',
        template: "<div class=\"card-block\" *ngIf=\"dataSource && !loading\">\n  <cdk-tree [dataSource]=\"dataSource\" [treeControl]=\"nestedTreeControl\">\n    <!-- This is the tree node template for leaf nodes -->\n    <cdk-nested-tree-node *cdkTreeNodeDef=\"let node\" (click)=\"toggleFocusedNode(node)\"\n    [ngClass]=\"{'strong':isFocusedNode(node)}\" style=\"cursor: pointer\">\n      <span>\n        <i class=\"right-m-xs\" \n        [c8yIcon]=\"getIcon(node.nodeClassName)\" \n        [ngClass]=\"{'strong':isFocusedNode(node)}\" \n        style=\"cursor: pointer\"></i>\n        {{node.displayName}}\n      </span>\n    </cdk-nested-tree-node>\n    <!-- This is the tree node template for expandable nodes -->\n    <cdk-nested-tree-node *cdkTreeNodeDef=\"let node; when: hasChild\">\n      <div class=\"flex-row\">\n        <button cdkTreeNodeToggle class=\"btn-clean text-primary right-m-xs\" [disabled]=\"node.currentlyLoadingChildren\">\n          <i class=\"fa\" [ngClass]=\"{'fa-plus-square': !node.expanded, 'fa-minus-square': node.expanded}\"></i>\n        </button>\n        <i class=\"right-m-xs\" [c8yIcon]=\"getIcon(node.nodeClassName)\" [ngClass]=\"{'strong':isFocusedNode(node)}\" style=\"cursor: pointer\"></i>\n        <span (click)=\"toggleFocusedNode(node)\" [ngClass]=\"{'strong':isFocusedNode(node)}\" style=\"cursor: pointer\"> {{node.displayName}} </span>\n        <span class=\"left-m-xs\" [style.visibility]=\"node.currentlyLoadingChildren ? 'visible': 'hidden'\">\n          <i class=\"fa fa-circle-o-notch fa-spin\"></i>\n        </span>\n      </div>\n      <ng-container cdkTreeNodeOutlet></ng-container>\n    </cdk-nested-tree-node>\n  </cdk-tree>\n</div>\n<div style=\"padding: 8px;\" *ngIf=\"loading\">\n  <div class=\"spinner\" style=\"position: relative\">\n    <div class=\"rect1\"></div>\n    <div class=\"rect2\"></div>\n    <div class=\"rect3\"></div>\n    <div class=\"rect4\"></div>\n    <div class=\"rect5\"></div>\n  </div>\n</div>\n<div class=\"alert alert-info m-t-16\" *ngIf=\"!dataSource && !loading\" translate>\n  No source data available to fetch address space.\n</div>"
    })
], OpcuaAddressSpaceTreeComponent);
export { OpcuaAddressSpaceTreeComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtYWRkcmVzcy1zcGFjZS10cmVlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvcHJvdG9jb2wtb3BjdWEvIiwic291cmNlcyI6WyJvcGN1YS1hZGRyZXNzLXNwYWNlLXRyZWUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULEtBQUssRUFDTCxNQUFNLEVBRU4sWUFBWSxFQUliLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxtQkFBbUIsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3BHLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDdEQsT0FBTyxFQUFFLEtBQUssRUFBYSxNQUFNLFFBQVEsQ0FBQztBQVExQyxJQUFhLDhCQUE4QixHQUEzQyxNQUFhLDhCQUE4QjtJQWdCekMsWUFDVSxtQkFBd0MsRUFDeEMsWUFBMEIsRUFDMUIsWUFBMEI7UUFGMUIsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUN4QyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQVozQixpQkFBWSxHQUFtQyxJQUFJLFlBQVksRUFBb0IsQ0FBQztRQUNuRixpQkFBWSxHQUFtQyxJQUFJLFlBQVksRUFBb0IsQ0FBQztRQUU5RixlQUFVLEdBQXNCLElBQUksQ0FBQztRQUVyQyxZQUFPLEdBQVksS0FBSyxDQUFDO1FBVXpCLGdCQUFXLEdBQUcsQ0FBQyxJQUFzQixFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FB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QUM7U0FDckQ7SUFDSCxDQUFDO0NBQ0YsQ0FBQTs7WUF6SmdDLG1CQUFtQjtZQUMxQixZQUFZO1lBQ1osWUFBWTs7QUFqQnBDO0lBREMsS0FBSyxFQUFFOzBEQUdQO0FBRVE7SUFBUixLQUFLLEVBQUU7NERBQU07QUFDTDtJQUFSLEtBQUssRUFBRTtvRUFBcUY7QUFDbkY7SUFBVCxNQUFNLEVBQUU7b0VBQXFGO0FBUm5GLDhCQUE4QjtJQUoxQyxTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsMEJBQTBCO1FBQ3BDLHdrRUFBd0Q7S0FDekQsQ0FBQztHQUNXLDhCQUE4QixDQTBLMUM7U0ExS1ksOEJBQThCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBPbkluaXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgT25EZXN0cm95LFxuICBPbkNoYW5nZXMsXG4gIFNpbXBsZUNoYW5nZXNcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBZGRyZXNzU3BhY2VOb2RlLCBBZGRyZXNzU3BhY2VTZXJ2aWNlLCBOb2RlTmF2aWdhdGlvbkRhdGEgfSBmcm9tICcuL2FkZHJlc3Mtc3BhY2Uuc2VydmljZSc7XG5pbXBvcnQgeyBPcGN1YVNlcnZpY2UgfSBmcm9tICcuL29wY3VhU2VydmljZSc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IER5bmFtaWNEYXRhU291cmNlIH0gZnJvbSAnLi9keW5hbWljLWRhdGEtc291cmNlJztcbmltcG9ydCB7IE5lc3RlZFRyZWVDb250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3RyZWUnO1xuaW1wb3J0IHsgY2xvbmUsIGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHJlbGF0aXZlIH0gZnJvbSAncGF0aCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ29wY3VhLWFkZHJlc3Mtc3BhY2UtdHJlZScsXG4gIHRlbXBsYXRlVXJsOiAnLi9vcGN1YS1hZGRyZXNzLXNwYWNlLXRyZWUuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIE9wY3VhQWRkcmVzc1NwYWNlVHJlZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBPbkNoYW5nZXMge1xuICBASW5wdXQoKVxuICBzZXQgbW9JZChpZDogc3RyaW5nKSB7XG4gICAgdGhpcy5fbW9JZCA9IGlkIHx8IHVuZGVmaW5lZDtcbiAgfVxuXG4gIEBJbnB1dCgpIG5vZGU7XG4gIEBJbnB1dCgpIGZvY3VzRW1pdHRlcjogRXZlbnRFbWl0dGVyPEFkZHJlc3NTcGFjZU5vZGU+ID0gbmV3IEV2ZW50RW1pdHRlcjxBZGRyZXNzU3BhY2VOb2RlPigpO1xuICBAT3V0cHV0KCkgc2VsZWN0ZWROb2RlOiBFdmVudEVtaXR0ZXI8QWRkcmVzc1NwYWNlTm9kZT4gPSBuZXcgRXZlbnRFbWl0dGVyPEFkZHJlc3NTcGFjZU5vZGU+KCk7XG4gIG5lc3RlZFRyZWVDb250cm9sOiBOZXN0ZWRUcmVlQ29udHJvbDxBZGRyZXNzU3BhY2VOb2RlPjtcbiAgZGF0YVNvdXJjZTogRHluYW1pY0RhdGFTb3VyY2UgPSBudWxsO1xuICBmb2N1c2VkOiBBZGRyZXNzU3BhY2VOb2RlO1xuICBsb2FkaW5nOiBib29sZWFuID0gZmFsc2U7XG4gIHN1YnNjcmlwdGlvblJlZjogU3Vic2NyaXB0aW9uO1xuICBub2RlTmF2RGF0YVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICBwcml2YXRlIF9tb0lkOiBzdHJpbmc7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYWRkcmVzc1NwYWNlU2VydmljZTogQWRkcmVzc1NwYWNlU2VydmljZSxcbiAgICBwcml2YXRlIG9wY3VhU2VydmljZTogT3BjdWFTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2VcbiAgKSB7fVxuXG4gIGdldENoaWxkcmVuID0gKG5vZGU6IEFkZHJlc3NTcGFjZU5vZGUpID0+IChub2RlLmV4cGFuZGVkID8gbm9kZS5jaGlsZHJlbiA6IFtdKTtcbiAgaGFzQ2hpbGQgPSAoXzogbnVtYmVyLCBfbm9kZURhdGE6IEFkZHJlc3NTcGFjZU5vZGUpID0+XG4gICAgdGhpcy5hZGRyZXNzU3BhY2VTZXJ2aWNlLmNoaWxkcmVuQXZhaWxhYmxlKF9ub2RlRGF0YS5yZWZlcmVuY2VzKVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuaW5pdGlhbGl6ZURhdGFTZXQoKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBpZiAoY2hhbmdlcy5tb0lkICYmIChjaGFuZ2VzLm1vSWQuY3VycmVudFZhbHVlICE9PSBjaGFuZ2VzLm1vSWQucHJldmlvdXNWYWx1ZSkpIHtcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZURhdGFTZXQoKTtcbiAgICB9XG4gIH1cblxuICBpbml0aWFsaXplRGF0YVNldCgpIHtcbiAgICB0aGlzLm5vZGVOYXZEYXRhU3Vic2NyaXB0aW9uID0gdGhpcy5hZGRyZXNzU3BhY2VTZXJ2aWNlXG4gICAgICAuZ2V0Tm9kZU5hdkRhdGEkKClcbiAgICAgIC5zdWJzY3JpYmUobm9kZU5hdkRhdGEgPT4gdGhpcy5vcGVuTm9kZShub2RlTmF2RGF0YSkpO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uUmVmID0gdGhpcy5mb2N1c0VtaXR0ZXIuc3Vic2NyaWJlKG5vZGUgPT4ge1xuICAgICAgdGhpcy5mb2N1c2VkID0gdGhpcy5pc0ZvY3VzZWROb2RlKG5vZGUpID8gdW5kZWZpbmVkIDogbm9kZTtcbiAgICB9KTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIC8vIGNsZWFuIHVwIHRoZSBhZGRyZXNzLXNwYWNlLXRyZWVcbiAgICB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2UucmVzZXRUcmVlVG9Sb290Tm9kZSgpO1xuXG4gICAgaWYgKHRoaXMubm9kZU5hdkRhdGFTdWJzY3JpcHRpb24gJiYgIXRoaXMubm9kZU5hdkRhdGFTdWJzY3JpcHRpb24uY2xvc2VkKSB7XG4gICAgICB0aGlzLm5vZGVOYXZEYXRhU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc3Vic2NyaXB0aW9uUmVmICYmICF0aGlzLnN1YnNjcmlwdGlvblJlZi5jbG9zZWQpIHtcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9uUmVmLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgb3Blbk5vZGUobm9kZU5hdkRhdGE6IE5vZGVOYXZpZ2F0aW9uRGF0YSkge1xuICAgIGNvbnN0IHsgbm9kZSwgc2VsZWN0ZWRBbmNlc3RvcklkcyB9ID0gbm9kZU5hdkRhdGE7XG4gICAgbGV0IG5vZGVJZDtcblxuICAgIC8vIFdlIGp1c3Qgc2V0IHRoZSBub2RlSWQgd2hlbiB0aGUgc2VsZWN0ZWRBbmNlc3RvcklkcyB2YXJpYWJsZSBhbiBlbXB0eSBhcnJheS5cbiAgICAvLyBJZiBzZWxlY3RlZEFuY2VzdG9ySWRzIGNvbnRhaW4gYW55IGlkIHdlIGFzc3VtZSB0aGF0IHRoZSB0cmVlIHNob3VsZCBiZSB0cmF2c2Vyc2VkIGJlZ2lubmluZ1xuICAgIC8vIGZyb20gdGhlIHJvb3Qgbm9kZS5cbiAgICBpZiAobm9kZSAmJiBub2RlLm5vZGVJZCAmJiBzZWxlY3RlZEFuY2VzdG9ySWRzICYmIHNlbGVjdGVkQW5jZXN0b3JJZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICBub2RlSWQgPSBub2RlLm5vZGVJZDtcbiAgICB9XG4gICAgLy8gQWx3YXlzIHJlY3JlYXRlIHRoZSB0cmVlIHdoZW4gcm91dGluZyB0byBhIHNwZWNpZmljIG5lc3RlZCBub2RlLFxuICAgIC8vIGJlY2F1c2UgcHJldmlvdXMgbW9kaWZpY2F0aW9ucyB0byB0aGUgdHJlZS1zdHJ1Y3R1cmUgY291bGQgY2F1c2UgZXJyb3JzXG4gICAgLy8gd2hpbGUgdHJhdmVyc2luZyB3aXRoICdvbGQnIHRyZWUtZGF0YVxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gc2V0dXBUcmVlIGlzIGFibGUgdG8gaGFuZGxlIG5vZGVJZCA9IHVuZGVmaW5lZFxuICAgIGF3YWl0IHRoaXMuc2V0dXBUcmVlKG5vZGVJZCk7XG5cbiAgICBpZiAoIXNlbGVjdGVkQW5jZXN0b3JJZHMgfHwgc2VsZWN0ZWRBbmNlc3Rvcklkcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAobm9kZU5hdkRhdGEgJiYgdGhpcy5kYXRhU291cmNlKSB7XG4gICAgICBjb25zdCBjbG9uZWRBbmNlc3RvcnMgPSBjbG9uZShzZWxlY3RlZEFuY2VzdG9ySWRzKTtcbiAgICAgIGNsb25lZEFuY2VzdG9ycy5zaGlmdCgpO1xuXG4gICAgICBjb25zdCBuID0gYXdhaXQgdGhpcy5kYXRhU291cmNlLnRvZ2dsZU5vZGUodGhpcy5kYXRhU291cmNlLmRhdGFbMF0sIHRydWUpO1xuICAgICAgdGhpcy5zZXRDaGlsZE5vZGVzKG4uY2hpbGRyZW4sIGNsb25lZEFuY2VzdG9ycyk7XG5cbiAgICAgIHRoaXMudG9nZ2xlRm9jdXNlZE5vZGUobm9kZSk7XG4gICAgfVxuICB9XG5cbiAgc2V0Q2hpbGROb2Rlcyhub2RlczogQWRkcmVzc1NwYWNlTm9kZVtdLCBpZHM6IHN0cmluZ1tdKSB7XG4gICAgaWYgKG5vZGVzKSB7XG4gICAgICBpZHMuZm9yRWFjaChhc3luYyBpZCA9PiB7XG4gICAgICAgIGNvbnN0IG1hdGNoID0gbm9kZXMuZmluZChuID0+IG4ubm9kZUlkID09PSBpZCk7XG4gICAgICAgIGlmIChtYXRjaCAmJiBpZHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGNvbnN0IGlkeCA9IGlkcy5maW5kSW5kZXgodmFsdWUgPT4gdmFsdWUgPT09IGlkKTtcbiAgICAgICAgICBpZiAoaWR4ID49IDApIHtcbiAgICAgICAgICAgIGlkcy5zcGxpY2UoaWR4LCAxKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgdG9nZ2xlZE5vZGUgPSBhd2FpdCB0aGlzLmRhdGFTb3VyY2UudG9nZ2xlTm9kZShtYXRjaCwgdHJ1ZSk7XG4gICAgICAgICAgdGhpcy5zZXRDaGlsZE5vZGVzKHRvZ2dsZWROb2RlLmNoaWxkcmVuLCBpZHMpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzZXR1cFRyZWUobm9kZUlkPzogc3RyaW5nKSB7XG4gICAgdGhpcy5sb2FkaW5nID0gdHJ1ZTtcblxuICAgIGlmICghdGhpcy5fbW9JZCB8fCB0aGlzLl9tb0lkLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhpcy5fbW9JZCA9IHRoaXMub3BjdWFTZXJ2aWNlLmdldE1vSWQoKTtcbiAgICB9XG5cbiAgICAvLyBhZGRyZXNzU3BhY2VTZXJ2aWNlLmdldE5vZGUgcmV0dXJucyBlaXRoZXIgdGhlIHJvb3Qgbm9kZSBvZiB0aGUgc2VydmVyIChtb0lkKVxuICAgIC8vIG9yIGlmIG5vZGVJZCAhPT0gdW5kZWZpbmVkIHRoZSBub2RlIHdpdGggZ2l2ZW4gbm9kZUlkXG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5hZGRyZXNzU3BhY2VTZXJ2aWNlLmdldE5vZGUodGhpcy5fbW9JZCwgbm9kZUlkKTtcbiAgICBpZiAocmVzKSB7XG4gICAgICBpZiAocmVzLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSByZXMuanNvbiA/IGF3YWl0IHJlcy5qc29uKCkgOiB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoeyBkYXRhLCByZXMgfSk7XG4gICAgICAgIHRoaXMuZGF0YVNvdXJjZSA9IHVuZGVmaW5lZDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJvb3ROb2RlID0gKGF3YWl0IHJlcy5qc29uKCkpIGFzIEFkZHJlc3NTcGFjZU5vZGU7XG4gICAgICAgIHRoaXMubmVzdGVkVHJlZUNvbnRyb2wgPSBuZXcgTmVzdGVkVHJlZUNvbnRyb2w8QWRkcmVzc1NwYWNlTm9kZT4odGhpcy5nZXRDaGlsZHJlbik7XG4gICAgICAgIHRoaXMuZGF0YVNvdXJjZSA9IG5ldyBEeW5hbWljRGF0YVNvdXJjZShcbiAgICAgICAgICB0aGlzLm5lc3RlZFRyZWVDb250cm9sLFxuICAgICAgICAgIHRoaXMuYWRkcmVzc1NwYWNlU2VydmljZSxcbiAgICAgICAgICB0aGlzLl9tb0lkXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuZGF0YVNvdXJjZS5kYXRhID0gW3Jvb3ROb2RlXTtcbiAgICAgIH1cbiAgICAgIHRoaXMubG9hZGluZyA9IGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBnZXRNb0lkKCkge1xuICAgIGlmICghdGhpcy5fbW9JZCB8fCB0aGlzLl9tb0lkLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHRoaXMub3BjdWFTZXJ2aWNlLmdldE1vSWQoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX21vSWQ7XG4gIH1cblxuICBnZXRJY29uKG5vZGVDbGFzc05hbWUpIHtcbiAgICByZXR1cm4gdGhpcy5hZGRyZXNzU3BhY2VTZXJ2aWNlLmdldEljb24obm9kZUNsYXNzTmFtZSk7XG4gIH1cblxuICB0b2dnbGVGb2N1c2VkTm9kZShub2RlKSB7XG4gICAgY29uc3QgcmVsYXRpdmVQYXRoID0gW107XG4gICAgdGhpcy5nZXRSZWxhdGl2ZVBhdGgobm9kZSwgcmVsYXRpdmVQYXRoKTtcbiAgICBub2RlLnJlbGF0aXZlUGF0aCA9IHJlbGF0aXZlUGF0aDtcblxuICAgIHRoaXMuc2VsZWN0ZWROb2RlLmVtaXQobm9kZSk7XG4gICAgdGhpcy5mb2N1c2VkID0gdGhpcy5pc0ZvY3VzZWROb2RlKG5vZGUpID8gdW5kZWZpbmVkIDogbm9kZTtcbiAgfVxuXG4gIGlzRm9jdXNlZE5vZGUobm9kZTogQWRkcmVzc1NwYWNlTm9kZSkge1xuICAgIGlmICh0aGlzLmZvY3VzZWQpIHtcbiAgICAgIHJldHVybiBub2RlLm5vZGVJZCA9PT0gdGhpcy5mb2N1c2VkLm5vZGVJZDtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRSZWxhdGl2ZVBhdGgobm9kZTogQWRkcmVzc1NwYWNlTm9kZSwgcmVsYXRpdmVQYXRoOiBzdHJpbmdbXSkge1xuICAgIGlmIChub2RlLnBhcmVudE5vZGUpIHtcbiAgICAgIHJlbGF0aXZlUGF0aC51bnNoaWZ0KG5vZGUuYnJvd3NlTmFtZSk7XG4gICAgICB0aGlzLmdldFJlbGF0aXZlUGF0aChub2RlLnBhcmVudE5vZGUsIHJlbGF0aXZlUGF0aCk7XG4gICAgfVxuICB9XG59XG4iXX0=