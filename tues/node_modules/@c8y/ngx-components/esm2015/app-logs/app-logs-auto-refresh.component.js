import * as tslib_1 from "tslib";
import { Component, Input, Output, ViewChild, EventEmitter } from '@angular/core';
import { AppLogsService } from './app-logs.service';
import { fromEvent, Subject, of, interval, NEVER } from 'rxjs';
import { filter, catchError, tap, debounce, switchMap, takeUntil, finalize, delay, repeat, merge, scan } from 'rxjs/operators';
let AppLogsAutoRefreshComponent = class AppLogsAutoRefreshComponent {
    constructor(appLogsService) {
        this.appLogsService = appLogsService;
        this.cancel$ = new Subject();
        this.isAutoRefreshDisabled = false;
        this.logsToOutput = this.getEmptyLogsJson();
        this.isAutoRefreshOn = true;
        this.onNewLogs = new EventEmitter();
        this.toggleState = currentState => !currentState;
    }
    set buttonsDisabled(areDisabled) {
        this.isAutoRefreshDisabled = areDisabled;
        if (areDisabled && this.isAutoRefreshOn) {
            this.isAutoRefreshOn = false;
            this.cancel$.next(false);
        }
    }
    ngAfterViewInit() {
        const clicks$ = fromEvent(this.button.nativeElement, 'click').pipe(merge(this.cancel$), debounce(() => interval(300)), scan(this.toggleState, false), tap(isAutoRefreshOn => this.setButtonState(isAutoRefreshOn)), switchMap(isOn => (isOn ? this.watchForNewLogs() : NEVER)));
        this.subscription = clicks$.subscribe();
    }
    ngOnDestroy() {
        if (this.subscription) {
            this.subscription.unsubscribe();
        }
    }
    setButtonState(isAutoRefreshOn) {
        this.isAutoRefreshOn = isAutoRefreshOn;
    }
    watchForNewLogs() {
        return this.startPolling().pipe(takeUntil(this.cancel$.pipe(filter(isAutoRefreshOn => isAutoRefreshOn === false))), finalize(() => {
            this.isAutoRefreshOn = false;
        }));
    }
    startPolling() {
        return of(1).pipe(switchMap(() => this.getNewLogs().pipe(catchError(er => of(this.getEmptyLogsJson())))), tap(logs => this.updateLogsToOutput(logs)), delay(10000), repeat());
    }
    getNewLogs() {
        return this.appLogsService.getLogs$(this.getAppId(), this.getInstanceName());
    }
    getAppId() {
        return this.mo.applicationId;
    }
    getInstanceName() {
        return this.selectedInstance.name;
    }
    updateLogsToOutput(newLogs) {
        const { dateFrom, dateTo } = newLogs;
        if (dateFrom && dateTo) {
            this.logsToOutput = Object.assign({}, newLogs);
            this.onNewLogs.emit(this.logsToOutput);
        }
    }
    getEmptyLogsJson() {
        return {
            dateFrom: null,
            dateTo: null,
            logs: '',
            truncated: false
        };
    }
};
AppLogsAutoRefreshComponent.ctorParameters = () => [
    { type: AppLogsService }
];
tslib_1.__decorate([
    Input()
], AppLogsAutoRefreshComponent.prototype, "selectedInstance", void 0);
tslib_1.__decorate([
    Input()
], AppLogsAutoRefreshComponent.prototype, "mo", void 0);
tslib_1.__decorate([
    Input()
], AppLogsAutoRefreshComponent.prototype, "buttonsDisabled", null);
tslib_1.__decorate([
    Output()
], AppLogsAutoRefreshComponent.prototype, "onNewLogs", void 0);
tslib_1.__decorate([
    ViewChild('autoRefresh', { static: true })
], AppLogsAutoRefreshComponent.prototype, "button", void 0);
AppLogsAutoRefreshComponent = tslib_1.__decorate([
    Component({
        selector: 'c8y-app-logs-auto-refresh',
        template: "<button #autoRefresh\n  type=\"button\"\n  class=\"btn btn-link c8y-realtime\"\n  [ngStyle]=\"{'width': 'auto'}\"\n  title=\"{{'Toggle auto refresh' | translate}}\"\n  [disabled]=\"isAutoRefreshDisabled\"\n>\n  <span class=\"c8y-pulse\" [ngClass]=\"isAutoRefreshOn ? 'active' : 'inactive'\"></span>\n  {{'Auto refresh' | translate}}\n</button>"
    })
], AppLogsAutoRefreshComponent);
export { AppLogsAutoRefreshComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLWxvZ3MtYXV0by1yZWZyZXNoLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvYXBwLWxvZ3MvIiwic291cmNlcyI6WyJhcHAtbG9ncy1hdXRvLXJlZnJlc2guY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBYyxNQUFNLGVBQWUsQ0FBQztBQUU5RixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFjLFNBQVMsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBQ3pGLE9BQU8sRUFDTCxNQUFNLEVBQ04sVUFBVSxFQUNWLEdBQUcsRUFDSCxRQUFRLEVBQ1IsU0FBUyxFQUNULFNBQVMsRUFDVCxRQUFRLEVBQ1IsS0FBSyxFQUNMLE1BQU0sRUFDTixLQUFLLEVBQ0wsSUFBSSxFQUNMLE1BQU0sZ0JBQWdCLENBQUM7QUFNeEIsSUFBYSwyQkFBMkIsR0FBeEMsTUFBYSwyQkFBMkI7SUFvQnRDLFlBQW9CLGNBQThCO1FBQTlCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQW5CbEQsWUFBTyxHQUFxQixJQUFJLE9BQU8sRUFBVyxDQUFDO1FBQ25ELDBCQUFxQixHQUFZLEtBQUssQ0FBQztRQUN2QyxpQkFBWSxHQUFhLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ2pELG9CQUFlLEdBQVksSUFBSSxDQUFDO1FBV3RCLGNBQVMsR0FBRyxJQUFJLFlBQVksRUFBWSxDQUFDO1FBdUIzQyxnQkFBVyxHQUFHLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUM7SUFsQkMsQ0FBQztJQVo3QyxJQUFJLGVBQWUsQ0FBQyxXQUFvQjtRQUMvQyxJQUFJLENBQUMscUJBQXFCLEdB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QUFDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7U0FDeEM7SUFDSCxDQUFDO0lBRU8sZ0JBQWdCO1FBQ3RCLE9BQU87WUFDTCxRQUFRLEVBQUUsSUFBSTtZQUNkLE1BQU0sRUFBRSxJQUFJO1lBQ1osSUFBSSxFQUFFLEVBQUU7WUFDUixTQUFTLEVBQUUsS0FBSztTQUNqQixDQUFDO0lBQ0osQ0FBQztDQUNGLENBQUE7O1lBckVxQyxjQUFjOztBQWR6QztJQUFSLEtBQUssRUFBRTtxRUFBdUI7QUFDdEI7SUFBUixLQUFLLEVBQUU7dURBQVM7QUFDUjtJQUFSLEtBQUssRUFBRTtrRUFNUDtBQUNTO0lBQVQsTUFBTSxFQUFFOzhEQUEwQztBQUNQO0lBQTNDLFNBQVMsQ0FBQyxhQUFhLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUM7MkRBQW9CO0FBaEJwRCwyQkFBMkI7SUFKdkMsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLDJCQUEyQjtRQUNyQyxtV0FBcUQ7S0FDdEQsQ0FBQztHQUNXLDJCQUEyQixDQXlGdkM7U0F6RlksMkJBQTJCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT3V0cHV0LCBWaWV3Q2hpbGQsIEV2ZW50RW1pdHRlciwgRWxlbWVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTG9nc0pTT04gfSBmcm9tICcuL2xvZ3MubW9kZWwnO1xuaW1wb3J0IHsgQXBwTG9nc1NlcnZpY2UgfSBmcm9tICcuL2FwcC1sb2dzLnNlcnZpY2UnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbUV2ZW50LCBTdWJqZWN0LCBvZiwgaW50ZXJ2YWwsIE5FVkVSLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGZpbHRlcixcbiAgY2F0Y2hFcnJvcixcbiAgdGFwLFxuICBkZWJvdW5jZSxcbiAgc3dpdGNoTWFwLFxuICB0YWtlVW50aWwsXG4gIGZpbmFsaXplLFxuICBkZWxheSxcbiAgcmVwZWF0LFxuICBtZXJnZSxcbiAgc2NhblxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1hcHAtbG9ncy1hdXRvLXJlZnJlc2gnLFxuICB0ZW1wbGF0ZVVybDogJy4vYXBwLWxvZ3MtYXV0by1yZWZyZXNoLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBBcHBMb2dzQXV0b1JlZnJlc2hDb21wb25lbnQge1xuICBjYW5jZWwkOiBTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcbiAgaXNBdXRvUmVmcmVzaERpc2FibGVkOiBib29sZWFuID0gZmFsc2U7XG4gIGxvZ3NUb091dHB1dDogTG9nc0pTT04gPSB0aGlzLmdldEVtcHR5TG9nc0pzb24oKTtcbiAgaXNBdXRvUmVmcmVzaE9uOiBib29sZWFuID0gdHJ1ZTtcblxuICBASW5wdXQoKSBzZWxlY3RlZEluc3RhbmNlOiBhbnk7XG4gIEBJbnB1dCgpIG1vOiBhbnk7XG4gIEBJbnB1dCgpIHNldCBidXR0b25zRGlzYWJsZWQoYXJlRGlzYWJsZWQ6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmlzQXV0b1JlZnJlc2hEaXNhYmxlZCA9IGFyZURpc2FibGVkO1xuICAgIGlmIChhcmVEaXNhYmxlZCAmJiB0aGlzLmlzQXV0b1JlZnJlc2hPbikge1xuICAgICAgdGhpcy5pc0F1dG9SZWZyZXNoT24gPSBmYWxzZTtcbiAgICAgIHRoaXMuY2FuY2VsJC5uZXh0KGZhbHNlKTtcbiAgICB9XG4gIH1cbiAgQE91dHB1dCgpIG9uTmV3TG9ncyA9IG5ldyBFdmVudEVtaXR0ZXI8TG9nc0pTT04+KCk7XG4gIEBWaWV3Q2hpbGQoJ2F1dG9SZWZyZXNoJywgeyBzdGF0aWM6IHRydWUgfSkgYnV0dG9uOiBFbGVtZW50UmVmO1xuXG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBhcHBMb2dzU2VydmljZTogQXBwTG9nc1NlcnZpY2UpIHt9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIGNvbnN0IGNsaWNrcyQgPSBmcm9tRXZlbnQodGhpcy5idXR0b24ubmF0aXZlRWxlbWVudCwgJ2NsaWNrJykucGlwZShcbiAgICAgIG1lcmdlKHRoaXMuY2FuY2VsJCksXG4gICAgICBkZWJvdW5jZSgoKSA9PiBpbnRlcnZhbCgzMDApKSxcbiAgICAgIHNjYW4odGhpcy50b2dnbGVTdGF0ZSwgZmFsc2UpLFxuICAgICAgdGFwKGlzQXV0b1JlZnJlc2hPbiA9PiB0aGlzLnNldEJ1dHRvblN0YXRlKGlzQXV0b1JlZnJlc2hPbikpLFxuICAgICAgc3dpdGNoTWFwKGlzT24gPT4gKGlzT24gPyB0aGlzLndhdGNoRm9yTmV3TG9ncygpIDogTkVWRVIpKVxuICAgICk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24gPSBjbGlja3MkLnN1YnNjcmliZSgpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgaWYgKHRoaXMuc3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIHRvZ2dsZVN0YXRlID0gY3VycmVudFN0YXRlID0+ICFjdXJyZW50U3RhdGU7XG5cbiAgcHJpdmF0ZSBzZXRCdXR0b25TdGF0ZShpc0F1dG9SZWZyZXNoT246IGJvb2xlYW4pIHtcbiAgICB0aGlzLmlzQXV0b1JlZnJlc2hPbiA9IGlzQXV0b1JlZnJlc2hPbjtcbiAgfVxuXG4gIHByaXZhdGUgd2F0Y2hGb3JOZXdMb2dzKCkge1xuICAgIHJldHVybiB0aGlzLnN0YXJ0UG9sbGluZygpLnBpcGUoXG4gICAgICB0YWtlVW50aWwodGhpcy5jYW5jZWwkLnBpcGUoZmlsdGVyKGlzQXV0b1JlZnJlc2hPbiA9PiBpc0F1dG9SZWZyZXNoT24gPT09IGZhbHNlKSkpLFxuICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICB0aGlzLmlzQXV0b1JlZnJlc2hPbiA9IGZhbHNlO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGFydFBvbGxpbmcoKSB7XG4gICAgcmV0dXJuIG9mKDEpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5nZXROZXdMb2dzKCkucGlwZShjYXRjaEVycm9yKGVyID0+IG9mKHRoaXMuZ2V0RW1wdHlMb2dzSnNvbigpKSkpKSxcbiAgICAgIHRhcChsb2dzID0+IHRoaXMudXBkYXRlTG9nc1RvT3V0cHV0KGxvZ3MpKSxcbiAgICAgIGRlbGF5KDEwMDAwKSxcbiAgICAgIHJlcGVhdCgpXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0TmV3TG9ncygpOiBPYnNlcnZhYmxlPExvZ3NKU09OPiB7XG4gICAgcmV0dXJuIHRoaXMuYXBwTG9nc1NlcnZpY2UuZ2V0TG9ncyQodGhpcy5nZXRBcHBJZCgpLCB0aGlzLmdldEluc3RhbmNlTmFtZSgpKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0QXBwSWQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5tby5hcHBsaWNhdGlvbklkO1xuICB9XG4gIHByaXZhdGUgZ2V0SW5zdGFuY2VOYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuc2VsZWN0ZWRJbnN0YW5jZS5uYW1lO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVMb2dzVG9PdXRwdXQobmV3TG9ncykge1xuICAgIGNvbnN0IHsgZGF0ZUZyb20sIGRhdGVUbyB9ID0gbmV3TG9ncztcbiAgICBpZiAoZGF0ZUZyb20gJiYgZGF0ZVRvKSB7XG4gICAgICB0aGlzLmxvZ3NUb091dHB1dCA9IHsgLi4ubmV3TG9ncyB9O1xuICAgICAgdGhpcy5vbk5ld0xvZ3MuZW1pdCh0aGlzLmxvZ3NUb091dHB1dCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRFbXB0eUxvZ3NKc29uKCk6IExvZ3NKU09OIHtcbiAgICByZXR1cm4ge1xuICAgICAgZGF0ZUZyb206IG51bGwsXG4gICAgICBkYXRlVG86IG51bGwsXG4gICAgICBsb2dzOiAnJyxcbiAgICAgIHRydW5jYXRlZDogZmFsc2VcbiAgICB9O1xuICB9XG59XG4iXX0=