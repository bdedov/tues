import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { isUndefined, sortBy } from 'lodash-es';
import { debounceTime, take } from 'rxjs/operators';
import { IApplication, ApplicationType, ApplicationService, ISystemOption, TenantService, TenantOptionsService } from '@c8y/client';
import { HumanizeAppNamePipe } from '@c8y/ngx-components';
import { DefaultSubscriptionsContext as DefaultSubscriptionsContextTenant } from './default-subscriptions.model';
let DefaultSubscriptionsService = class DefaultSubscriptionsService {
    constructor(applicationService, tenantService, tenantOptionsService, humanizeAppNamePipe) {
        this.applicationService = applicationService;
        this.tenantService = tenantService;
        this.tenantOptionsService = tenantOptionsService;
        this.humanizeAppNamePipe = humanizeAppNamePipe;
    }
    /**
     * Gets the list of applications which can be used in default subscriptions, i.e.:
     * - current tenant's all own applications,
     * - inherited applications, which do not have the same names as current tenant's own apps.
     * The list is sorted alphabetically by humanized app name and contains up to 2000 items.
     * @returns The list of applications, which can be used in default subscriptions.
     */
    getSubscribableTenantApps() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const currentTenant = (yield this.tenantService.current()).data;
            const allApps = (yield this.applicationService.listByTenant(null, { pageSize: 2000 })).data;
            const ownApps = allApps.filter(app => app.owner.tenant.id === currentTenant.name);
            const inheritedApps = allApps.filter(app => app.owner.tenant.id !== currentTenant.name);
            const filteredApps = [...ownApps];
            inheritedApps.forEach(inheritedApp => {
                if (!filteredApps.some(filteredApp => filteredApp.name === inheritedApp.name)) {
                    filteredApps.push(inheritedApp);
                }
            });
            const filteredAppsWithHumanizedNames = yield Promise.all(filteredApps.map((app) => tslib_1.__awaiter(this, void 0, void 0, function* () {
                const humanizedName = yield this.humanizeAppNamePipe
                    .transform(app.name)
                    .pipe(debounceTime(250), take(1))
                    .toPromise();
                return { app, humanizedName };
            })));
            const sortedAppsWithHumanizedNames = sortBy(filteredAppsWithHumanizedNames, ['humanizedName']);
            const sortedApps = sortedAppsWithHumanizedNames.map(({ app }) => app);
            return sortedApps;
        });
    }
    /**
     * Gets the default subscriptions configuration inherited from parent tenant.
     * @returns The default subscriptions object with settings from parent tenant.
     */
    getDefaultSubscriptionsEvaluatedFromParentTenant() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return this.getDefaultSubscriptions(DefaultSubscriptionsContextTenant.PARENT_TENANT);
        });
    }
    /**
     * Gets the default subscriptions configuration from the current tenant.
     * @returns The default subscriptions object with settings from the current tenant.
     */
    getDefaultSubscriptionsFromCurrentTenant() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return this.getDefaultSubscriptions(DefaultSubscriptionsContextTenant.CURRENT_TENANT);
        });
    }
    /**
     * Saves given default subscriptions configuration to the current tenant
     * (either sets, updates, or deletes corresponding tenant options).
     * @param defaultSubscriptions The default subscriptions configuration to be saved.
     */
    saveDefaultSubscriptionsToCurrentTenant(defaultSubscriptions) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            yield this.saveOnCreationSubscriptions(defaultSubscriptions);
            yield this.saveOnUpgradeSubscriptions(defaultSubscriptions);
        });
    }
    /**
     * Gets default subscriptions in the context of current or parent tenant.
     * @param contextTenant Tells whether to use current or parent tenant as context.
     */
    getDefaultSubscriptions(contextTenant) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let tenantOptionsParams;
            let overridable;
            switch (contextTenant) {
                case DefaultSubscriptionsContextTenant.CURRENT_TENANT:
                    tenantOptionsParams = { evaluate: 'current' };
                    overridable = true;
                    break;
                case DefaultSubscriptionsContextTenant.PARENT_TENANT:
                    tenantOptionsParams = { evaluate: 'inherited' };
                    overridable = false;
                    break;
            }
            const { onCreationApps, onCreationMicroservices, onUpgradeAppsEnabled, onUpgradeApps, onUpgradeMicroservicesEnabled, onUpgradeMicroservices } = yield this.getTenantOptions(tenantOptionsParams);
            const onCreationSubscriptions = this.namesToPartialApps({
                appsNamesStr: onCreationApps,
                microservicesNamesStr: onCreationMicroservices
            });
            const onUpgradeAppsDefault = overridable ? null : onCreationApps;
            const onUpgradeMicroservicesDefault = overridable ? null : onCreationMicroservices;
            const onUpgradeSubscriptions = this.namesToPartialApps({
                appsNamesStr: onUpgradeAppsEnabled ? onUpgradeApps : onUpgradeAppsDefault,
                microservicesNamesStr: onUpgradeMicroservicesEnabled
                    ? onUpgradeMicroservices
                    : onUpgradeMicroservicesDefault
            });
            const defaultSubscriptions = {
                onCreationSubscriptions,
                onUpgradeSubscriptions
            };
            if (overridable) {
                defaultSubscriptions.overrideOnCreationSubscriptions =
                    onCreationApps !== null || onCreationMicroservices !== null;
                defaultSubscriptions.overrideOnUpgradeSubscriptions =
                    onUpgradeAppsEnabled || onUpgradeMicroservicesEnabled;
            }
            return defaultSubscriptions;
        });
    }
    getTenantOptions(params = {}) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return {
                onCreationApps: yield this.getTenantOption({
                    category: 'configuration',
                    key: 'default.tenant.applications'
                }, null, params),
                onCreationMicroservices: yield this.getTenantOption({
                    category: 'configuration',
                    key: 'default.tenant.microservices'
                }, null, params),
                onUpgradeAppsEnabled: yield this.getTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.applications.enabled'
                }, false, params),
                onUpgradeApps: yield this.getTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.applications'
                }, null, params),
                onUpgradeMicroservicesEnabled: yield this.getTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.microservices.enabled'
                }, false, params),
                onUpgradeMicroservices: yield this.getTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.microservices'
                }, null, params)
            };
        });
    }
    saveOnCreationSubscriptions(defaultSubscriptions) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (defaultSubscriptions.overrideOnCreationSubscriptions) {
                yield this.setTenantOption({
                    category: 'configuration',
                    key: 'default.tenant.applications',
                    value: this.partialAppsListToAppsNames(defaultSubscriptions.onCreationSubscriptions)
                });
                yield this.setTenantOption({
                    category: 'configuration',
                    key: 'default.tenant.microservices',
                    value: this.partialAppsToMicroservicesNames(defaultSubscriptions.onCreationSubscriptions)
                });
            }
            else {
                yield this.unsetTenantOption({
                    category: 'configuration',
                    key: 'default.tenant.applications'
                });
                yield this.unsetTenantOption({
                    category: 'configuration',
                    key: 'default.tenant.microservices'
                });
            }
        });
    }
    saveOnUpgradeSubscriptions(defaultSubscriptions) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (defaultSubscriptions.overrideOnUpgradeSubscriptions) {
                yield this.setTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.applications.enabled',
                    value: 'true'
                });
                yield this.setTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.microservices.enabled',
                    value: 'true'
                });
                yield this.setTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.applications',
                    value: this.partialAppsListToAppsNames(defaultSubscriptions.onUpgradeSubscriptions)
                });
                yield this.setTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.microservices',
                    value: this.partialAppsToMicroservicesNames(defaultSubscriptions.onUpgradeSubscriptions)
                });
            }
            else {
                yield this.unsetTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.applications.enabled'
                });
                yield this.unsetTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.microservices.enabled'
                });
                yield this.unsetTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.applications'
                });
                yield this.unsetTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.microservices'
                });
            }
        });
    }
    getTenantOption(option, defaultValue = null, params = {}) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let value;
            try {
                value = (yield this.tenantOptionsService.detail(option, params)).data.value;
                value = JSON.parse(value);
            }
            catch (ex) {
                value = !isUndefined(value) ? value : defaultValue;
            }
            return value;
        });
    }
    setTenantOption(option) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return this.tenantOptionsService.update(option);
        });
    }
    unsetTenantOption(option) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                yield this.tenantOptionsService.delete(option);
            }
            catch (ex) {
                if (!ex || !ex.res || ex.res.status !== 404) {
                    throw ex;
                }
            }
        });
    }
    namesToPartialApps({ appsNamesStr, microservicesNamesStr }) {
        if (appsNamesStr === null && microservicesNamesStr === null) {
            return null;
        }
        return [
            ...(appsNamesStr || '')
                .split(',')
                .filter(name => name.length)
                .map(name => ({ name: name.trim() })),
            ...(microservicesNamesStr || '')
                .split(',')
                .filter(name => name.length)
                .map(name => ({
                name: name.trim(),
                type: ApplicationType.MICROSERVICE
            }))
        ];
    }
    partialAppsListToAppsNames(apps) {
        return apps
            .filter(app => app.type !== ApplicationType.MICROSERVICE)
            .map(app => app.name)
            .join(',');
    }
    partialAppsToMicroservicesNames(apps) {
        return apps
            .filter(app => app.type === ApplicationType.MICROSERVICE)
            .map(app => app.name)
            .join(',');
    }
};
DefaultSubscriptionsService.ctorParameters = () => [
    { type: ApplicationService },
    { type: TenantService },
    { type: TenantOptionsService },
    { type: HumanizeAppNamePipe }
];
DefaultSubscriptionsService = tslib_1.__decorate([
    Injectable()
], DefaultSubscriptionsService);
export { DefaultSubscriptionsService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1zdWJzY3JpcHRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL2RlZmF1bHQtc3Vic2NyaXB0aW9ucy8iLCJzb3VyY2VzIjpbImRlZmF1bHQtc3Vic2NyaXB0aW9ucy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2hELE9BQU8sRUFBRSxZQUFZLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFcEQsT0FBTyxFQUNMLFlBQVksRUFDWixlQUFlLEVBQ2Ysa0JBQWtCLEVBQ2xCLGFBQWEsRUFDYixhQUFhLEVBQ2Isb0JBQW9CLEVBQ3JCLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRTFELE9BQU8sRUFHTCwyQkFBMkIsSUFBSSxpQ0FBaUMsRUFDakUsTUFBTSwrQkFBK0IsQ0FBQztBQUd2QyxJQUFhLDJCQUEyQixHQUF4QyxNQUFhLDJCQUEyQjtJQUN0QyxZQUNVLGtCQUFzQyxFQUN0QyxhQUE0QixFQUM1QixvQkFBMEMsRUFDMUMsbUJBQXdDO1FBSHhDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQUMxQyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO0lBQy9DLENBQUM7SUFFSjs7Ozs7O09BTUc7SUFDRyx5QkFBeUI7O1lBQzdCLE1BQU0sYUFBYSxHQUFHLENBQUMsTUFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDO1lBRWhFLE1BQU0sT0FBTyxHQUFHLENBQUMsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQzVGLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEtBQUssYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2xGLE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEtBQUssYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRXhGLE1BQU0sWUFBWSxHQUFtQixDQUFDLEdBQUcsT0FBTyxDQUFDLENBQUM7WUFDbEQsYUFBYSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsRUFBRTtnQkFDbkMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsSUFBSSxLQUFLLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFBRTtvQkFDN0UsWUFBWSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztpQkFDakM7WUFDSCxDQUFDLENBQUMsQ0FBQztZQUVILE1BQU0sOEJBQThCLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUN0RCxZQUFZLENBQUMsR0FBRyxDQUFDLENBQU0sR0FBRyxFQUFDLEVBQUU7Z0JBQzNCLE1BQU0sYUFBYSxHQUFHLE1BQU0sSUFBSSxDQUFDLG1CQUFtQjtxQkFDakQsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7cUJBQ25CLElBQUksQ0FDSCxZQUFZLENBQUMsR0FBRyxDQUFDLEVBQ2pCLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FDUjtxQkFDQSxTQUFTLEVBQUUsQ0FBQztnQkFDZixPQUFPLEVBQUUsR0FBRyxFQUFFLGFBQWEsRUFBRSxDQUFDO1lBQ2hDLENBQUMsQ0FBQSxDQUFDLENBQ0gsQ0FBQztZQUNGLE1BQU0sNEJBQTRCLEdBQUcsTUFBTSxDQUFDLDhCQUE4QixFQUFFLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztZQUMvRixNQUFNLFVBQVUsR0FBRyw0QkFBNEIsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUV0RSxPQUFPLFVBQVUsQ0FBQztRQUNwQixDQUFDO0tBQUE7SUFFRDs7O09BR0c7SUFDRyxnREFBZ0Q7O1lBQ3BELE9BQU8sSUFBSSxDQUFDLHVCQUF1QixDQUFDLGlDQUFpQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3ZGLENBQUM7S0FBQTtJQUVEOzs7T0FHRztJQUNHLHdDQUF3Qzs7WUFDNUMsT0FBTyxJQUFJLENBQUMsdUJBQXVCLENBQUMsaUNBQWlDLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDeEYsQ0FBQztLQUFBO0lBRUQ7Ozs7T0FJRztJQUNHLHVDQUF1QyxDQUFDLG9CQUEwQzs7WUFDdEYsTUFBTSxJQUFJLENBQUMsMkJBQTJCLENBQUMsb0JBQW9CLENBQUMsQ0FBQztZQUM3RCxNQUFNLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBQzlELENBQUM7S0FBQTtJQUVEOzs7T0FHRztJQUNXLHVCQUF1QixDQUNuQyxhQUFnRDs7WUFFaEQsSUFBSSxtQkFBMkIsQ0FBQztZQUNoQyxJQUFJLFdBQW9CLENBQUM7WUFFekIsUUFBUSxhQUFhLEVBQUU7Z0JBQ3JCLEtBQUssaUNBQWlDLENBQUMsY0FBYztvQkFDbkQsbUJBQW1CLEdBQUcsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLENBQUM7b0JBQzlDLFdBQVcsR0FBRyxJQUFJLENBQUM7b0JBQ25CLE1BQU07Z0JBRVIsS0FBSyxpQ0FBaUMsQ0FBQyxhQUFhO29CQUNsRCxtQkFBbUIsR0FBRyxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsQ0FBQztvQkFDaEQsV0FBVyxHQUFHLEtBQUssQ0FBQztvQkFDcEIsTUFBTTthQUNUO1lBRUQsTUFBTSxFQUNKLGNBQWMsRUFDZCx1QkFBdUIsRUFDdkIsb0JBQW9CLEVBQ3BCLGFBQWEsRUFDYiw2QkFBNkIsRUFDN0Isc0JBQXNCLEVBQ3ZCLEdBQUcsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUVyRCxNQUFNLHVCQUF1QixHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQztnQkFDdEQsWUFBWSxFQUFFLGNBQWM7Z0JBQzVCLHFCQUFxQixFQUFFLHVCQUF1QjthQUMvQyxDQUFDLENBQUM7WUFFSCxNQUFNLG9CQUFvQixHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUM7WUFDakUsTUFBTSw2QkFBNkIsR0FBRyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsdUJBQXVCLENBQUM7WUFDbkYsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUM7Z0JBQ3JELFlBQVksRUFBRSxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxvQkFBb0I7Z0JBQ3pFLHFCQUFxQixFQUFFLDZCQUE2QjtvQkFDbEQsQ0FBQyxDQUFDLHNCQUFzQjtvQkFDeEIsQ0FBQyxDQUFDLDZCQUE2QjthQUNsQyxDQUFDLENBQUM7WUFFSCxNQUFNLG9CQUFvQixHQUF5QjtnQkFDakQsdUJBQXVCO2dCQUN2QixzQkFBc0I7YUFDdkIsQ0FBQztZQUVGLElBQUksV0FBVyxFQUFFO2dCQUNmLG9CQUFvQixDQUFDLCtCQUErQjtvQkFDbEQsY0FBYyxLQUFLLElBQUksSUFBSSx1QkFBdUIsS0FBSyxJQUFJLENBQUM7Z0JBQzlELG9CQUFvQixDQUFDLDhCQUE4QjtvQkFDakQsb0JBQW9CLElBQUksNkJBQTZCLENBQUM7YUFDekQ7WUFFRCxPQUFPLG9CQUFvQixDQUFDO1FBQzlCLENBQUM7S0FBQTtJQUVhLGdCQUFnQixDQUFDLE1BQU0sR0FBRyxFQUFFOztZQUN4QyxPQUFPO2dCQUNMLGNBQWMsRUFBRSxNQUFNLElBQUksQ0FBQyxlQUFlLENBQ3hDO29CQUNFLFFBQVEsRUFBRSxlQUFlO29CQUN6QixHQUFHLEVBQUUsNkJBQTZCO2lCQUNuQyxFQUNELElBQUksRUFDSixNQUFNLENBQ1A7Z0JBQ0QsdUJBQXVCLEVBQUUsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUNqRDtvQkFDRSxRQUFRLEVBQUUsZUFBZTtvQkFDekIsR0FBRyxFQUFFLDhCQUE4QjtpQkFDcEMsRUFDRCxJQUFJLEVBQ0osTUFBTSxDQUNQO2dCQUNELG9CQUFvQixFQUFFLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FDOUM7b0JBQ0UsUUFBUSxFQUFFLGVBQWU7b0JBQ3pCLEdBQUcsRUFBRSx1Q0FBdUM7aUJBQzdDLEVBQ0QsS0FBSyxFQUNMLE1BQU0sQ0FDUDtnQkFDRCxhQUFhLEVBQUUsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUN2QztvQkFDRSxRQUFRLEVBQUUsZUFBZTtvQkFDekIsR0FBRyxFQUFFLCtCQUErQjtpQkFDckMsRUFDRCxJQUFJLEVBQ0osTUFBTSxDQUNQO2dCQUNELDZCQUE2QixFQUFFLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FDdkQ7b0JBQ0UsUUFBUSxFQUFFLGVBQWU7b0JBQ3pCLEdBQUcsRUFBRSx3Q0FBd0M7aUJBQzlDLEVBQ0QsS0FBSyxFQUNMLE1BQU0sQ0FDUDtnQkFDRCxzQkFBc0IsRUFBRSxNQUFNLElBQUksQ0FBQyxlQUFlLENBQ2hEO29CQUNFLFFBQVEsRUFBRSxlQUFlO29CQUN6QixHQUFHLEVBQUUsZ0NBQWdDO2lCQUN0QyxFQUNELElBQUksRUFDSixNQUFNLENBQ1A7YUFDRixDQUFDO1FBQ0osQ0FBQztLQUFBO0lBRWEsMkJBQTJCLENBQUMsb0JBQTBDOztZQUNsRixJQUFJLG9CQUFvQixDQUFDLCtCQUErQixFQUFFO2dCQUN4RCxNQUFNLElBQUksQ0FBQyxlQUFlLENBQUM7b0JBQ3pCLFFBQVEsRUFBRSxlQUFlO29CQUN6QixHQUFHLEVBQUUsNkJBQTZCO29CQUNsQyxLQUFLLEVBQUUsSUFBSSxDQUFDLDBCQUEwQixDQUFDLG9CQUFvQixDQUFDLHVCQUF1QixDQUFDO2lCQUNyRixDQUFDLENBQUM7Z0JBQ0gsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDO29CQUN6QixRQUFRLEVBQUUsZUFBZTtvQkFDekIsR0FBRyxFQUFFLDhCQUE4QjtvQkFDbkMsS0FBSyxFQUFFLElBQUksQ0FBQywrQkFBK0IsQ0FBQyxvQkFBb0IsQ0FBQyx1QkFBdUIsQ0FBQztpQkFDMUYsQ0FBQyxDQUFDO2FBQ0o7aUJBQU07Z0JBQ0wsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUM7b0JBQzNCLFFBQVEsRUFBRSxlQUFlO29CQUN6QixHQUFHLEVBQUUsNkJBQTZCO2lCQUNuQyxDQUFDLENBQUM7Z0JBQ0gsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUM7b0JBQzNCLFFBQVEsRUFBRSxlQUFlO29CQUN6QixHQUFHLEVBQUUsOEJBQThCO2lCQUNwQyxDQUFDLENBQUM7YUFDSjtRQUNILENBQUM7S0FBQTtJQUVhLDBCQUEwQixDQUFDLG9CQUEwQzs7WUFDakYsSUFBSSxvQkFBb0IsQ0FBQyw4QkFBOEIsRUFBRTtnQkFDdkQsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDO29CQUN6QixRQUFRLEVBQUUsZUFBZTtvQkFDekIsR0FBRyxFQUFFLHVDQUF1QztvQkFDNUMsS0FBSyxFQUFFLE1BQU07aUJBQ2QsQ0FBQyxDQUFDO2dCQUNILE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQztvQkFDekIsUUFBUSxFQUFFLGVBQWU7b0JBQ3pCLEdBQUcsRUFBRSx3Q0FBd0M7b0JBQzdDLEtBQUssRUFBRSxNQUFNO2lCQUNkLENBQUMsQ0FBQztnQkFDSCxNQUFNLElBQUksQ0FBQyxlQUFlLENBQUM7b0JBQ3pCLFFBQVEsRUFBRSxlQUFlO29CQUN6QixHQUFHLEVBQUUsK0JBQStCO29CQUNwQyxLQUFLLEVBQUUsSUFBSSxDQUFDLDBCQUEwQixDQUFDLG9CQUFvQixDQUFDLHNCQUFzQixDQUFDO2lCQUNwRixDQUFDLENBQUM7Z0JBQ0gsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDO29CQUN6QixRQUFRLEVBQUUsZUFBZTtvQkFDekIsR0FBRyxFQUFFLGdDQUFnQztvQkFDckMsS0FBSyxFQUFFLElBQUksQ0FBQywrQkFBK0IsQ0FBQyxvQkFBb0IsQ0FBQyxzQkFBc0IsQ0FBQztpQkFDekYsQ0FBQyxDQUFDO2FBQ0o7aUJBQU07Z0JBQ0wsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUM7b0JBQzNCLFFBQVEsRUFBRSxlQUFlO29CQUN6QixHQUFHLEVBQUUsdUNBQXVDO2lCQUM3QyxDQUFDLENBQUM7Z0JBQ0gsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUM7b0JBQzNCLFFBQVEsRUFBRSxlQUFlO29CQUN6QixHQUFHLEVBQUUsd0NBQXdDO2lCQUM5QyxDQUFDLENBQUM7Z0JBQ0gsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUM7b0JBQzNCLFFBQVEsRUFBRSxlQUFlO29CQUN6QixHQUFHLEVBQUUsK0JBQStCO2lCQUNyQyxDQUFDLENBQUM7Z0JBQ0gsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUM7b0JBQzNCLFFBQVEsRUFBRSxlQUFlO29CQUN6QixHQUFHLEVBQUUsZ0NBQWdDO2lCQUN0QyxDQUFDLENBQUM7YUFDSjtRQUNILENBQUM7S0FBQTtJQUVhLGVBQWUsQ0FBQyxNQUFxQixFQUFFLFlBQVksR0FBRyxJQUFJLEVBQUUsTUFBTSxHQUFHLEVBQUU7O1lBQ25GLElBQUksS0FBSyxDQUFDO1lBQ1YsSUFBSTtnQkFDRixLQUFLLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztnQkFDNUUsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDM0I7WUFBQyxPQUFPLEVBQUUsRUFBRTtnQkFDWCxLQUFLLEdBQUcsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDO2FBQ3BEO1lBQ0QsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO0tBQUE7SUFFYSxlQUFlLENBQUMsTUFBcUI7O1lBQ2pELE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNsRCxDQUFDO0tBQUE7SUFFYSxpQkFBaUIsQ0FBQyxNQUFxQjs7WUFDbkQsSUFBSTtnQkFDRixNQUFNLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDaEQ7WUFBQyxPQUFPLEVBQUUsRUFBRTtnQkFDWCxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7b0JBQzNDLE1BQU0sRUFBRSxDQUFDO2lCQUNWO2FBQ0Y7UUFDSCxDQUFDO0tBQUE7SUFFTyxrQkFBa0IsQ0FBQyxFQUN6QixZQUFZLEVBQ1oscUJBQXFCLEVBSXRCO1FBQ0MsSUFBSSxZQUFZLEtBQUssSUFBSSxJQUFJLHFCQUFxQixLQUFLLElBQUksRUFBRTtZQUMzRCxPQUFPLElBQUksQ0FBQztTQUNiO1FBRUQsT0FBTztZQUNMLEdBQUcsQ0FBQyxZQUFZLElBQUksRUFBRSxDQUFDO2lCQUNwQixLQUFLLENBQUMsR0FBRyxDQUFDO2lCQUNWLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7aUJBQzNCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztZQUN2QyxHQUFHLENBQUMscUJBQXFCLElBQUksRUFBRSxDQUFDO2lCQUM3QixLQUFLLENBQUMsR0FBRyxDQUFDO2lCQUNWLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7aUJBQzNCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ1osSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUU7Z0JBQ2pCLElBQUksRUFBRSxlQUFlLENBQUMsWUFBWTthQUNuQyxDQUFDLENBQUM7U0FDTixDQUFDO0lBQ0osQ0FBQztJQUVPLDBCQUEwQixDQUFDLElBQXFCO1FBQ3RELE9BQU8sSUFBSTthQUNSLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEtBQUssZUFBZSxDQUFDLFlBQVksQ0FBQzthQUN4RCxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO2FBQ3BCLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNmLENBQUM7SUFFTywrQkFBK0IsQ0FBQyxJQUFxQjtRQUMzRCxPQUFPLElBQUk7YUFDUixNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLGVBQWUsQ0FBQyxZQUFZLENBQUM7YUFDeEQsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQzthQUNwQixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDZixDQUFDO0NBQ0YsQ0FBQTs7WUExVCtCLGtCQUFrQjtZQUN2QixhQUFhO1lBQ04sb0JBQW9CO1lBQ3JCLG1CQUFtQjs7QUFMdkMsMkJBQTJCO0lBRHZDLFVBQVUsRUFBRTtHQUNBLDJCQUEyQixDQTRUdkM7U0E1VFksMkJBQTJCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgaXNVbmRlZmluZWQsIHNvcnRCeSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7XG4gIElBcHBsaWNhdGlvbixcbiAgQXBwbGljYXRpb25UeXBlLFxuICBBcHBsaWNhdGlvblNlcnZpY2UsXG4gIElTeXN0ZW1PcHRpb24sXG4gIFRlbmFudFNlcnZpY2UsXG4gIFRlbmFudE9wdGlvbnNTZXJ2aWNlXG59IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEh1bWFuaXplQXBwTmFtZVBpcGUgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcblxuaW1wb3J0IHtcbiAgUGFydGlhbEFwcHNMaXN0LFxuICBEZWZhdWx0U3Vic2NyaXB0aW9ucyxcbiAgRGVmYXVsdFN1YnNjcmlwdGlvbnNDb250ZXh0IGFzIERlZmF1bHRTdWJzY3JpcHRpb25zQ29udGV4dFRlbmFudFxufSBmcm9tICcuL2RlZmF1bHQtc3Vic2NyaXB0aW9ucy5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBEZWZhdWx0U3Vic2NyaXB0aW9uc1NlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFwcGxpY2F0aW9uU2VydmljZTogQXBwbGljYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgdGVuYW50U2VydmljZTogVGVuYW50U2VydmljZSxcbiAgICBwcml2YXRlIHRlbmFudE9wdGlvbnNTZXJ2aWNlOiBUZW5hbnRPcHRpb25zU2VydmljZSxcbiAgICBwcml2YXRlIGh1bWFuaXplQXBwTmFtZVBpcGU6IEh1bWFuaXplQXBwTmFtZVBpcGVcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBsaXN0IG9mIGFwcGxpY2F0aW9ucyB3aGljaCBjYW4gYmUgdXNlZCBpbiBkZWZhdWx0IHN1YnNjcmlwdGlvbnMsIGkuZS46XG4gICAqIC0gY3VycmVudCB0ZW5hbnQncyBhbGwgb3duIGFwcGxpY2F0aW9ucyxcbiAgICogLSBpbmhlcml0ZWQgYXBwbGljYXRpb25zLCB3aGljaCBkbyBub3QgaGF2ZSB0aGUgc2FtZSBuYW1lcyBhcyBjdXJyZW50IHRlbmFudCdzIG93biBhcHBzLlxuICAgKiBUaGUgbGlzdCBpcyBzb3J0ZWQgYWxwaGFiZXRpY2FsbHkgYnkgaHVtYW5pemVkIGFwcCBuYW1lIGFuZCBjb250YWlucyB1cCB0byAyMDAwIGl0ZW1zLlxuICAgKiBAcmV0dXJucyBUaGUgbGlzdCBvZiBhcHBsaWNhdGlvbnMsIHdoaWNoIGNhbiBiZSB1c2VkIGluIGRlZmF1bHQgc3Vic2NyaXB0aW9ucy5cbiAgICovXG4gIGFzeW5jIGdldFN1YnNjcmliYWJsZVRlbmFudEFwcHMoKTogUHJvbWlzZTxJQXBwbGljYXRpb25bXT4ge1xuICAgIGNvbnN0IGN1cnJlbnRUZW5hbnQgPSAoYXdhaXQgdGhpcy50ZW5hbnRTZXJ2aWNlLmN1cnJlbnQoKSkuZGF0YTtcblxuICAgIGNvbnN0IGFsbEFwcHMgPSAoYXdhaXQgdGhpcy5hcHBsaWNhdGlvblNlcnZpY2UubGlzdEJ5VGVuYW50KG51bGwsIHsgcGFnZVNpemU6IDIwMDAgfSkpLmRhdGE7XG4gICAgY29uc3Qgb3duQXBwcyA9IGFsbEFwcHMuZmlsdGVyKGFwcCA9PiBhcHAub3duZXIudGVuYW50LmlkID09PSBjdXJyZW50VGVuYW50Lm5hbWUpO1xuICAgIGNvbnN0IGluaGVyaXRlZEFwcHMgPSBhbGxBcHBzLmZpbHRlcihhcHAgPT4gYXBwLm93bmVyLnRlbmFudC5pZCAhPT0gY3VycmVudFRlbmFudC5uYW1lKTtcblxuICAgIGNvbnN0IGZpbHRlcmVkQXBwczogSUFwcGxpY2F0aW9uW10gPSBbLi4ub3duQXBwc107XG4gICAgaW5oZXJpdGVkQXBwcy5mb3JFYWNoKGluaGVyaXRlZEFwcCA9PiB7XG4gICAgICBpZiAoIWZpbHRlcmVkQXBwcy5zb21lKGZpbHRlcmVkQXBwID0+IGZpbHRlcmVkQXBwLm5hbWUgPT09IGluaGVyaXRlZEFwcC5uYW1lKSkge1xuICAgICAgICBmaWx0ZXJlZEFwcHMucHVzaChpbmhlcml0ZWRBcHApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3QgZmlsdGVyZWRBcHBzV2l0aEh1bWFuaXplZE5hbWVzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICBmaWx0ZXJlZEFwcHMubWFwKGFzeW5jIGFwcCA9PiB7XG4gICAgICAgIGNvbnN0IGh1bWFuaXplZE5hbWUgPSBhd2FpdCB0aGlzLmh1bWFuaXplQXBwTmFtZVBpcGVcbiAgICAgICAgICAudHJhbnNmb3JtKGFwcC5uYW1lKVxuICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgZGVib3VuY2VUaW1lKDI1MCksXG4gICAgICAgICAgICB0YWtlKDEpXG4gICAgICAgICAgKVxuICAgICAgICAgIC50b1Byb21pc2UoKTtcbiAgICAgICAgcmV0dXJuIHsgYXBwLCBodW1hbml6ZWROYW1lIH07XG4gICAgICB9KVxuICAgICk7XG4gICAgY29uc3Qgc29ydGVkQXBwc1dpdGhIdW1hbml6ZWROYW1lcyA9IHNvcnRCeShmaWx0ZXJlZEFwcHNXaXRoSHVtYW5pemVkTmFtZXMsIFsnaHVtYW5pemVkTmFtZSddKTtcbiAgICBjb25zdCBzb3J0ZWRBcHBzID0gc29ydGVkQXBwc1dpdGhIdW1hbml6ZWROYW1lcy5tYXAoKHsgYXBwIH0pID0+IGFwcCk7XG5cbiAgICByZXR1cm4gc29ydGVkQXBwcztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBkZWZhdWx0IHN1YnNjcmlwdGlvbnMgY29uZmlndXJhdGlvbiBpbmhlcml0ZWQgZnJvbSBwYXJlbnQgdGVuYW50LlxuICAgKiBAcmV0dXJucyBUaGUgZGVmYXVsdCBzdWJzY3JpcHRpb25zIG9iamVjdCB3aXRoIHNldHRpbmdzIGZyb20gcGFyZW50IHRlbmFudC5cbiAgICovXG4gIGFzeW5jIGdldERlZmF1bHRTdWJzY3JpcHRpb25zRXZhbHVhdGVkRnJvbVBhcmVudFRlbmFudCgpOiBQcm9taXNlPERlZmF1bHRTdWJzY3JpcHRpb25zPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbnMoRGVmYXVsdFN1YnNjcmlwdGlvbnNDb250ZXh0VGVuYW50LlBBUkVOVF9URU5BTlQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIGRlZmF1bHQgc3Vic2NyaXB0aW9ucyBjb25maWd1cmF0aW9uIGZyb20gdGhlIGN1cnJlbnQgdGVuYW50LlxuICAgKiBAcmV0dXJucyBUaGUgZGVmYXVsdCBzdWJzY3JpcHRpb25zIG9iamVjdCB3aXRoIHNldHRpbmdzIGZyb20gdGhlIGN1cnJlbnQgdGVuYW50LlxuICAgKi9cbiAgYXN5bmMgZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbnNGcm9tQ3VycmVudFRlbmFudCgpOiBQcm9taXNlPERlZmF1bHRTdWJzY3JpcHRpb25zPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbnMoRGVmYXVsdFN1YnNjcmlwdGlvbnNDb250ZXh0VGVuYW50LkNVUlJFTlRfVEVOQU5UKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTYXZlcyBnaXZlbiBkZWZhdWx0IHN1YnNjcmlwdGlvbnMgY29uZmlndXJhdGlvbiB0byB0aGUgY3VycmVudCB0ZW5hbnRcbiAgICogKGVpdGhlciBzZXRzLCB1cGRhdGVzLCBvciBkZWxldGVzIGNvcnJlc3BvbmRpbmcgdGVuYW50IG9wdGlvbnMpLlxuICAgKiBAcGFyYW0gZGVmYXVsdFN1YnNjcmlwdGlvbnMgVGhlIGRlZmF1bHQgc3Vic2NyaXB0aW9ucyBjb25maWd1cmF0aW9uIHRvIGJlIHNhdmVkLlxuICAgKi9cbiAgYXN5bmMgc2F2ZURlZmF1bHRTdWJzY3JpcHRpb25zVG9DdXJyZW50VGVuYW50KGRlZmF1bHRTdWJzY3JpcHRpb25zOiBEZWZhdWx0U3Vic2NyaXB0aW9ucykge1xuICAgIGF3YWl0IHRoaXMuc2F2ZU9uQ3JlYXRpb25TdWJzY3JpcHRpb25zKGRlZmF1bHRTdWJzY3JpcHRpb25zKTtcbiAgICBhd2FpdCB0aGlzLnNhdmVPblVwZ3JhZGVTdWJzY3JpcHRpb25zKGRlZmF1bHRTdWJzY3JpcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIGRlZmF1bHQgc3Vic2NyaXB0aW9ucyBpbiB0aGUgY29udGV4dCBvZiBjdXJyZW50IG9yIHBhcmVudCB0ZW5hbnQuXG4gICAqIEBwYXJhbSBjb250ZXh0VGVuYW50IFRlbGxzIHdoZXRoZXIgdG8gdXNlIGN1cnJlbnQgb3IgcGFyZW50IHRlbmFudCBhcyBjb250ZXh0LlxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBnZXREZWZhdWx0U3Vic2NyaXB0aW9ucyhcbiAgICBjb250ZXh0VGVuYW50OiBEZWZhdWx0U3Vic2NyaXB0aW9uc0NvbnRleHRUZW5hbnRcbiAgKTogUHJvbWlzZTxEZWZhdWx0U3Vic2NyaXB0aW9ucz4ge1xuICAgIGxldCB0ZW5hbnRPcHRpb25zUGFyYW1zOiBvYmplY3Q7XG4gICAgbGV0IG92ZXJyaWRhYmxlOiBib29sZWFuO1xuXG4gICAgc3dpdGNoIChjb250ZXh0VGVuYW50KSB7XG4gICAgICBjYXNlIERlZmF1bHRTdWJzY3JpcHRpb25zQ29udGV4dFRlbmFudC5DVVJSRU5UX1RFTkFOVDpcbiAgICAgICAgdGVuYW50T3B0aW9uc1BhcmFtcyA9IHsgZXZhbHVhdGU6ICdjdXJyZW50JyB9O1xuICAgICAgICBvdmVycmlkYWJsZSA9IHRydWU7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIERlZmF1bHRTdWJzY3JpcHRpb25zQ29udGV4dFRlbmFudC5QQVJFTlRfVEVOQU5UOlxuICAgICAgICB0ZW5hbnRPcHRpb25zUGFyYW1zID0geyBldmFsdWF0ZTogJ2luaGVyaXRlZCcgfTtcbiAgICAgICAgb3ZlcnJpZGFibGUgPSBmYWxzZTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgY29uc3Qge1xuICAgICAgb25DcmVhdGlvbkFwcHMsXG4gICAgICBvbkNyZWF0aW9uTWljcm9zZXJ2aWNlcyxcbiAgICAgIG9uVXBncmFkZUFwcHNFbmFibGVkLFxuICAgICAgb25VcGdyYWRlQXBwcyxcbiAgICAgIG9uVXBncmFkZU1pY3Jvc2VydmljZXNFbmFibGVkLFxuICAgICAgb25VcGdyYWRlTWljcm9zZXJ2aWNlc1xuICAgIH0gPSBhd2FpdCB0aGlzLmdldFRlbmFudE9wdGlvbnModGVuYW50T3B0aW9uc1BhcmFtcyk7XG5cbiAgICBjb25zdCBvbkNyZWF0aW9uU3Vic2NyaXB0aW9ucyA9IHRoaXMubmFtZXNUb1BhcnRpYWxBcHBzKHtcbiAgICAgIGFwcHNOYW1lc1N0cjogb25DcmVhdGlvbkFwcHMsXG4gICAgICBtaWNyb3NlcnZpY2VzTmFtZXNTdHI6IG9uQ3JlYXRpb25NaWNyb3NlcnZpY2VzXG4gICAgfSk7XG5cbiAgICBjb25zdCBvblVwZ3JhZGVBcHBzRGVmYXVsdCA9IG92ZXJyaWRhYmxlID8gbnVsbCA6IG9uQ3JlYXRpb25BcHBzO1xuICAgIGNvbnN0IG9uVXBncmFkZU1pY3Jvc2VydmljZXNEZWZhdWx0ID0gb3ZlcnJpZGFibGUgPyBudWxsIDogb25DcmVhdGlvbk1pY3Jvc2VydmljZXM7XG4gICAgY29uc3Qgb25VcGdyYWRlU3Vic2NyaXB0aW9ucyA9IHRoaXMubmFtZXNUb1BhcnRpYWxBcHBzKHtcbiAgICAgIGFwcHNOYW1lc1N0cjogb25VcGdyYWRlQXBwc0VuYWJsZWQgPyBvblVwZ3JhZGVBcHBzIDogb25VcGdyYWRlQXBwc0RlZmF1bHQsXG4gICAgICBtaWNyb3NlcnZpY2VzTmFtZXNTdHI6IG9uVXBncmFkZU1pY3Jvc2VydmljZXNFbmFibGVkXG4gICAgICAgID8gb25VcGdyYWRlTWljcm9zZXJ2aWNlc1xuICAgICAgICA6IG9uVXBncmFkZU1pY3Jvc2VydmljZXNEZWZhdWx0XG4gICAgfSk7XG5cbiAgICBjb25zdCBkZWZhdWx0U3Vic2NyaXB0aW9uczogRGVmYXVsdFN1YnNjcmlwdGlvbnMgPSB7XG4gICAgICBvbkNyZWF0aW9uU3Vic2NyaXB0aW9ucyxcbiAgICAgIG9uVXBncmFkZVN1YnNjcmlwdGlvbnNcbiAgICB9O1xuXG4gICAgaWYgKG92ZXJyaWRhYmxlKSB7XG4gICAgICBkZWZhdWx0U3Vic2NyaXB0aW9ucy5vdmVycmlkZU9uQ3JlYXRpb25TdWJzY3JpcHRpb25zID1cbiAgICAgICAgb25DcmVhdGlvbkFwcHMgIT09IG51bGwgfHwgb25DcmVhdGlvbk1pY3Jvc2VydmljZXMgIT09IG51bGw7XG4gICAgICBkZWZhdWx0U3Vic2NyaXB0aW9ucy5vdmVycmlkZU9uVXBncmFkZVN1YnNjcmlwdGlvbnMgPVxuICAgICAgICBvblVwZ3JhZGVBcHBzRW5hYmxlZCB8fCBvblVwZ3JhZGVNaWNyb3NlcnZpY2VzRW5hYmxlZDtcbiAgICB9XG5cbiAgICByZXR1cm4gZGVmYXVsdFN1YnNjcmlwdGlvbnM7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldFRlbmFudE9wdGlvbnMocGFyYW1zID0ge30pIHtcbiAgICByZXR1cm4ge1xuICAgICAgb25DcmVhdGlvbkFwcHM6IGF3YWl0IHRoaXMuZ2V0VGVuYW50T3B0aW9uKFxuICAgICAgICB7XG4gICAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAgICBrZXk6ICdkZWZhdWx0LnRlbmFudC5hcHBsaWNhdGlvbnMnXG4gICAgICAgIH0sXG4gICAgICAgIG51bGwsXG4gICAgICAgIHBhcmFtc1xuICAgICAgKSxcbiAgICAgIG9uQ3JlYXRpb25NaWNyb3NlcnZpY2VzOiBhd2FpdCB0aGlzLmdldFRlbmFudE9wdGlvbihcbiAgICAgICAge1xuICAgICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgICAga2V5OiAnZGVmYXVsdC50ZW5hbnQubWljcm9zZXJ2aWNlcydcbiAgICAgICAgfSxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgcGFyYW1zXG4gICAgICApLFxuICAgICAgb25VcGdyYWRlQXBwc0VuYWJsZWQ6IGF3YWl0IHRoaXMuZ2V0VGVuYW50T3B0aW9uKFxuICAgICAgICB7XG4gICAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAgICBrZXk6ICdvbi11cGRhdGUudGVuYW50LmFwcGxpY2F0aW9ucy5lbmFibGVkJ1xuICAgICAgICB9LFxuICAgICAgICBmYWxzZSxcbiAgICAgICAgcGFyYW1zXG4gICAgICApLFxuICAgICAgb25VcGdyYWRlQXBwczogYXdhaXQgdGhpcy5nZXRUZW5hbnRPcHRpb24oXG4gICAgICAgIHtcbiAgICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQuYXBwbGljYXRpb25zJ1xuICAgICAgICB9LFxuICAgICAgICBudWxsLFxuICAgICAgICBwYXJhbXNcbiAgICAgICksXG4gICAgICBvblVwZ3JhZGVNaWNyb3NlcnZpY2VzRW5hYmxlZDogYXdhaXQgdGhpcy5nZXRUZW5hbnRPcHRpb24oXG4gICAgICAgIHtcbiAgICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQubWljcm9zZXJ2aWNlcy5lbmFibGVkJ1xuICAgICAgICB9LFxuICAgICAgICBmYWxzZSxcbiAgICAgICAgcGFyYW1zXG4gICAgICApLFxuICAgICAgb25VcGdyYWRlTWljcm9zZXJ2aWNlczogYXdhaXQgdGhpcy5nZXRUZW5hbnRPcHRpb24oXG4gICAgICAgIHtcbiAgICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQubWljcm9zZXJ2aWNlcydcbiAgICAgICAgfSxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgcGFyYW1zXG4gICAgICApXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2F2ZU9uQ3JlYXRpb25TdWJzY3JpcHRpb25zKGRlZmF1bHRTdWJzY3JpcHRpb25zOiBEZWZhdWx0U3Vic2NyaXB0aW9ucykge1xuICAgIGlmIChkZWZhdWx0U3Vic2NyaXB0aW9ucy5vdmVycmlkZU9uQ3JlYXRpb25TdWJzY3JpcHRpb25zKSB7XG4gICAgICBhd2FpdCB0aGlzLnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ2RlZmF1bHQudGVuYW50LmFwcGxpY2F0aW9ucycsXG4gICAgICAgIHZhbHVlOiB0aGlzLnBhcnRpYWxBcHBzTGlzdFRvQXBwc05hbWVzKGRlZmF1bHRTdWJzY3JpcHRpb25zLm9uQ3JlYXRpb25TdWJzY3JpcHRpb25zKVxuICAgICAgfSk7XG4gICAgICBhd2FpdCB0aGlzLnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ2RlZmF1bHQudGVuYW50Lm1pY3Jvc2VydmljZXMnLFxuICAgICAgICB2YWx1ZTogdGhpcy5wYXJ0aWFsQXBwc1RvTWljcm9zZXJ2aWNlc05hbWVzKGRlZmF1bHRTdWJzY3JpcHRpb25zLm9uQ3JlYXRpb25TdWJzY3JpcHRpb25zKVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMudW5zZXRUZW5hbnRPcHRpb24oe1xuICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICBrZXk6ICdkZWZhdWx0LnRlbmFudC5hcHBsaWNhdGlvbnMnXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHRoaXMudW5zZXRUZW5hbnRPcHRpb24oe1xuICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICBrZXk6ICdkZWZhdWx0LnRlbmFudC5taWNyb3NlcnZpY2VzJ1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzYXZlT25VcGdyYWRlU3Vic2NyaXB0aW9ucyhkZWZhdWx0U3Vic2NyaXB0aW9uczogRGVmYXVsdFN1YnNjcmlwdGlvbnMpIHtcbiAgICBpZiAoZGVmYXVsdFN1YnNjcmlwdGlvbnMub3ZlcnJpZGVPblVwZ3JhZGVTdWJzY3JpcHRpb25zKSB7XG4gICAgICBhd2FpdCB0aGlzLnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQuYXBwbGljYXRpb25zLmVuYWJsZWQnLFxuICAgICAgICB2YWx1ZTogJ3RydWUnXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHRoaXMuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5taWNyb3NlcnZpY2VzLmVuYWJsZWQnLFxuICAgICAgICB2YWx1ZTogJ3RydWUnXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHRoaXMuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5hcHBsaWNhdGlvbnMnLFxuICAgICAgICB2YWx1ZTogdGhpcy5wYXJ0aWFsQXBwc0xpc3RUb0FwcHNOYW1lcyhkZWZhdWx0U3Vic2NyaXB0aW9ucy5vblVwZ3JhZGVTdWJzY3JpcHRpb25zKVxuICAgICAgfSk7XG4gICAgICBhd2FpdCB0aGlzLnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQubWljcm9zZXJ2aWNlcycsXG4gICAgICAgIHZhbHVlOiB0aGlzLnBhcnRpYWxBcHBzVG9NaWNyb3NlcnZpY2VzTmFtZXMoZGVmYXVsdFN1YnNjcmlwdGlvbnMub25VcGdyYWRlU3Vic2NyaXB0aW9ucylcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCB0aGlzLnVuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5hcHBsaWNhdGlvbnMuZW5hYmxlZCdcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgdGhpcy51bnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQubWljcm9zZXJ2aWNlcy5lbmFibGVkJ1xuICAgICAgfSk7XG4gICAgICBhd2FpdCB0aGlzLnVuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5hcHBsaWNhdGlvbnMnXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHRoaXMudW5zZXRUZW5hbnRPcHRpb24oe1xuICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICBrZXk6ICdvbi11cGRhdGUudGVuYW50Lm1pY3Jvc2VydmljZXMnXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldFRlbmFudE9wdGlvbihvcHRpb246IElTeXN0ZW1PcHRpb24sIGRlZmF1bHRWYWx1ZSA9IG51bGwsIHBhcmFtcyA9IHt9KSB7XG4gICAgbGV0IHZhbHVlO1xuICAgIHRyeSB7XG4gICAgICB2YWx1ZSA9IChhd2FpdCB0aGlzLnRlbmFudE9wdGlvbnNTZXJ2aWNlLmRldGFpbChvcHRpb24sIHBhcmFtcykpLmRhdGEudmFsdWU7XG4gICAgICB2YWx1ZSA9IEpTT04ucGFyc2UodmFsdWUpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICB2YWx1ZSA9ICFpc1VuZGVmaW5lZCh2YWx1ZSkgPyB2YWx1ZSA6IGRlZmF1bHRWYWx1ZTtcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZXRUZW5hbnRPcHRpb24ob3B0aW9uOiBJU3lzdGVtT3B0aW9uKSB7XG4gICAgcmV0dXJuIHRoaXMudGVuYW50T3B0aW9uc1NlcnZpY2UudXBkYXRlKG9wdGlvbik7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHVuc2V0VGVuYW50T3B0aW9uKG9wdGlvbjogSVN5c3RlbU9wdGlvbikge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnRlbmFudE9wdGlvbnNTZXJ2aWNlLmRlbGV0ZShvcHRpb24pO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICBpZiAoIWV4IHx8ICFleC5yZXMgfHwgZXgucmVzLnN0YXR1cyAhPT0gNDA0KSB7XG4gICAgICAgIHRocm93IGV4O1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbmFtZXNUb1BhcnRpYWxBcHBzKHtcbiAgICBhcHBzTmFtZXNTdHIsXG4gICAgbWljcm9zZXJ2aWNlc05hbWVzU3RyXG4gIH06IHtcbiAgICBhcHBzTmFtZXNTdHI/OiBzdHJpbmc7XG4gICAgbWljcm9zZXJ2aWNlc05hbWVzU3RyPzogc3RyaW5nO1xuICB9KTogUGFydGlhbEFwcHNMaXN0IHtcbiAgICBpZiAoYXBwc05hbWVzU3RyID09PSBudWxsICYmIG1pY3Jvc2VydmljZXNOYW1lc1N0ciA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIFtcbiAgICAgIC4uLihhcHBzTmFtZXNTdHIgfHwgJycpXG4gICAgICAgIC5zcGxpdCgnLCcpXG4gICAgICAgIC5maWx0ZXIobmFtZSA9PiBuYW1lLmxlbmd0aClcbiAgICAgICAgLm1hcChuYW1lID0+ICh7IG5hbWU6IG5hbWUudHJpbSgpIH0pKSxcbiAgICAgIC4uLihtaWNyb3NlcnZpY2VzTmFtZXNTdHIgfHwgJycpXG4gICAgICAgIC5zcGxpdCgnLCcpXG4gICAgICAgIC5maWx0ZXIobmFtZSA9PiBuYW1lLmxlbmd0aClcbiAgICAgICAgLm1hcChuYW1lID0+ICh7XG4gICAgICAgICAgbmFtZTogbmFtZS50cmltKCksXG4gICAgICAgICAgdHlwZTogQXBwbGljYXRpb25UeXBlLk1JQ1JPU0VSVklDRVxuICAgICAgICB9KSlcbiAgICBdO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJ0aWFsQXBwc0xpc3RUb0FwcHNOYW1lcyhhcHBzOiBQYXJ0aWFsQXBwc0xpc3QpOiBzdHJpbmcge1xuICAgIHJldHVybiBhcHBzXG4gICAgICAuZmlsdGVyKGFwcCA9PiBhcHAudHlwZSAhPT0gQXBwbGljYXRpb25UeXBlLk1JQ1JPU0VSVklDRSlcbiAgICAgIC5tYXAoYXBwID0+IGFwcC5uYW1lKVxuICAgICAgLmpvaW4oJywnKTtcbiAgfVxuXG4gIHByaXZhdGUgcGFydGlhbEFwcHNUb01pY3Jvc2VydmljZXNOYW1lcyhhcHBzOiBQYXJ0aWFsQXBwc0xpc3QpOiBzdHJpbmcge1xuICAgIHJldHVybiBhcHBzXG4gICAgICAuZmlsdGVyKGFwcCA9PiBhcHAudHlwZSA9PT0gQXBwbGljYXRpb25UeXBlLk1JQ1JPU0VSVklDRSlcbiAgICAgIC5tYXAoYXBwID0+IGFwcC5uYW1lKVxuICAgICAgLmpvaW4oJywnKTtcbiAgfVxufVxuIl19