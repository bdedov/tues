import * as tslib_1 from "tslib";
import { Component, EventEmitter } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { gettext, ModalSelectionMode } from '@c8y/ngx-components';
import { get } from 'lodash-es';
import { QueriesUtil } from '@c8y/client';
import { Subject, from, BehaviorSubject } from 'rxjs';
import { switchMap, map, mergeMap, shareReplay, tap } from 'rxjs/operators';
import { RepositoryService } from '../repository.service';
// MODAL STRUCTURE
// - selectModalObject (repository entry (repositoryCategory) -> type c8y_Firmware/c8y_Software)
//   -- ISelectModalOption (repository binary entry (repositoryBinary) => type c8y_FirmwareBinary/c8y_SoftwareBinary)
//   -- ISelectModalOption...
// - selectModalObject...
/**
 * RepositorySelectModalComponent displays repository entries options and allows to select them.
 *
 * @example
 * ```
 * import { take } from 'rxjs/operators';
 * import { RepositorySelectModalComponent, ModalSelectionMode, RepositoryType } from '@c8y/ngx-components/repository';
 *
 * const initialState = {
 *   repositoryType: RepositoryType.FIRMWARE,
 *   title: gettext('Install firmware'),
 *   subTitle: gettext('Available firmwares matching the device type'),
 *   icon: 'c8y-firmware',
 *   mode: ModalSelectionMode.SINGLE,
 *   labels: { ok: gettext('Install') },
 *   disableSelected: false
 * };
 *
 * const modal = this.bsModal.show(RepositorySelectModalComponent, {
 *   ignoreBackdropClick: true,
 *   initialState
 * });
 *
 * modal.content.load.next();
 * modal.content.resultEmitter.pipe(take(1)).subscribe((firmware) => {
 *   ...
 * })
 * ```
 */
let RepositorySelectModalComponent = class RepositorySelectModalComponent {
    constructor(repositoryService, translateService) {
        this.repositoryService = repositoryService;
        this.translateService = translateService;
        /**
         * Optional
         * Allows to provide custom data.
         * @example
         * ```
         * import { from } from 'rxjs';
         *
         * const repositoryEntry = { name: 'ExampleEntry', type: 'c8y_Firmware' };
         * const versions = [{ c8y_Firmware: { version: '1.0.0', url: 'http://example.com' } }];
         *
         * const initialState = {repositoryEntriesWithVersions$: from({ ...repositoryEntry, versions })};
         * ```
         */
        this.repositoryEntriesWithVersions$ = undefined;
        /**
         * Optional
         * Allows to use custom badges templates.
         * @example
         * ```
         * import { gettext } from '@c8y/ngx-components';
         *
         * const badgeTemplates = { '=1': gettext('{{count}} version'), other: gettext('{{count}} versions') };
         * const initialState = { badgeTemplates };
         * ```
         */
        this.badgeTemplates = { '=1': gettext('{{count}} version'), other: gettext('{{count}} versions') };
        /**
         * Optional
         * Allows to provide custom modal title.
         */
        this.title = gettext('Select repository entry');
        /**
         * Loads the content of the modal.
         * Must be invoked by the modal's caller.
         */
        this.load = new Subject();
        /**
         * Optional
         * Emits a search string currently entered in the filter input.
         * Use it to filter the items if you use custom repositoryEntriesWithVersions$.
         */
        this.searchTerm = new BehaviorSubject('');
        /**
         * Optional
         * Allows to provide device type query to restrict search criteria.
         * Only takes effect when repositoryEntriesWithVersions$ is not provided,
         * otherwise modal's caller have to provide already filtered data in the repositoryEntriesWithVersions$.
         */
        this.deviceTypeQuery = {};
        /**
         * Optional
         * Allows to provide query to restrict search criteria.
         * Only takes effect when repositoryEntriesWithVersions$ is not provided,
         * otherwise modal's caller have to provide already filtered data in the repositoryEntriesWithVersions$.
         */
        this.searchQuery = {};
        /**
         * Optional
         * Allows to provide custom labels for the buttons responsible for confirm/dismiss modal actions.
         */
        this.labels = { ok: gettext('Save') };
        /**
         * Optional
         * Allows to hide the filter input field.
         * By default, the filter input field is displayed.
         */
        this.showFilter = true;
        /**
         * Optional
         * Allows to show a warning that the search criteria should be narrowed down.
         * By default, this warning is hidden.
         */
        this.areMoreEntries = false;
        /**
         * Emits the list of selected options.
         */
        this.resultEmitter = new EventEmitter();
        /**
         * Optional
         * Allows to change selection mode.
         * Supported options:
         *   * single: only single option can be selected.
         *   * multiple: multiple options can be selected.
         */
        this.mode = ModalSelectionMode.SINGLE;
        /**
         * Allows to block selection of the other versions from the same repository entry.
         */
        this.disableSelected = true;
        this.modalEntries = this.load.pipe(switchMap(() => this.repositoryEntriesWithVersions$), mergeMap(mos => this.aggregate(mos)), tap(items => {
            this.areMoreEntries = items.length >= this.PAGE_SIZE ? true : false;
        }));
        this.PAGE_SIZE = 100;
        this.queriesUtil = new QueriesUtil();
    }
    ngOnInit() {
        if (!this.repositoryType) {
            throw new Error('Repository type must be defined');
        }
        if (!this.repositoryEntriesWithVersions$) {
            this.repositoryEntriesWithVersions$ = from(this.repositoryService.listRepositoryEntries(this.repositoryType, {
                query: this.queriesUtil.addOrFilter(this.deviceTypeQuery, this.searchQuery),
                params: { pageSize: this.PAGE_SIZE }
            })).pipe(map(({ data }) => data), map(mos => this.getAndAssignRepositoryBinaries(mos)), shareReplay(1));
        }
    }
    getAndAssignRepositoryBinaries(mos) {
        mos.forEach(mo => {
            mo.versions = this.repositoryService.listAllVersions(mo);
        });
        return mos;
    }
    search(searchTerm) {
        this.searchTerm.next(searchTerm);
        if (!searchTerm) {
            this.searchQuery = {};
        }
        else {
            this.searchQuery = { name: `*${searchTerm}*` };
        }
        this.load.next();
    }
    result(selectedItems) {
        this.resultEmitter.emit(selectedItems);
    }
    aggregate(mos) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const repositoryType = this.repositoryType;
            const selectedItems = this.selected;
            return Promise.all(mos.map((repositoryEntry) => tslib_1.__awaiter(this, void 0, void 0, function* () {
                const options = this.getSelectModalOptions(yield this.repositoryService.fetchAllItemsFromList(repositoryEntry.versions), selectedItems, repositoryEntry, repositoryType);
                const selectModalObject = this.getSelectModalObject(repositoryEntry, options);
                return selectModalObject;
            })));
        });
    }
    getSelectModalOptions(versions, selectedItems, repositoryEntry, repositoryType) {
        const selectModalOptions = [];
        versions.forEach(repositoryBinary => {
            const isSelected = this.isBinaryRepositorySelected(selectedItems, repositoryEntry, repositoryBinary, repositoryType);
            const { version } = repositoryBinary[`${repositoryType}`];
            const bodyValue = version || `(${this.translateService.instant(gettext('not specified`version`'))})`;
            const bodyClass = version ? '' : 'text-muted';
            selectModalOptions.push({
                body: [
                    {
                        value: bodyValue,
                        class: bodyClass
                    }
                ],
                obj: Object.assign({ id: repositoryBinary.id, name: repositoryEntry.name, version }, (get(repositoryBinary, 'c8y_Patch.dependency') && {
                    dependency: get(repositoryBinary, 'c8y_Patch.dependency')
                }), (get(repositoryBinary, 'c8y_Patch') && { c8y_Patch: true }), { url: repositoryBinary[`${repositoryType}`].url }),
                selected: isSelected
            });
        });
        return selectModalOptions;
    }
    isBinaryRepositorySelected(selectedItems, repositoryEntry, repositoryBinary, repositoryType) {
        const isSelected = selectedItems
            ? selectedItems.filter(repositoryFragment => repositoryFragment.name === repositoryEntry.name &&
                repositoryFragment.version === repositoryBinary[`${repositoryType}`].version).length > 0
            : false;
        return isSelected;
    }
    getSelectModalObject(repositoryEntry, options) {
        const label = options.length === 1
            ? this.translateService.instant(this.badgeTemplates['=1'], { count: options.length })
            : this.translateService.instant(this.badgeTemplates.other, { count: options.length });
        const selectModalObject = {
            groupId: repositoryEntry.id,
            body: [
                { value: repositoryEntry.name, class: 'text-truncate' },
                { value: repositoryEntry.description, class: 'text-truncate text-muted' }
            ],
            additionalInformation: { value: label, class: 'label label-info' },
            options
        };
        return selectModalObject;
    }
};
RepositorySelectModalComponent.ctorParameters = () => [
    { type: RepositoryService },
    { type: TranslateService }
];
RepositorySelectModalComponent = tslib_1.__decorate([
    Component({
        selector: 'c8y-repository-select-modal',
        template: "<c8y-select-modal\n  [icon]=\"icon\"\n  [title]=\"title\"\n  [subTitle]=\"subTitle\"\n  [items]=\"modalEntries | async\"\n  [mode]=\"mode\"\n  [disableSelected]=\"disableSelected\"\n  [labels]=\"labels\"\n  [showFilter]=\"showFilter\"\n  [areMoreEntries]=\"areMoreEntries\"\n  (search)=\"search($event)\"\n  (result)=\"result($event)\"\n>\n</c8y-select-modal>\n"
    })
], RepositorySelectModalComponent);
export { RepositorySelectModalComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3NpdG9yeS1zZWxlY3QtbW9kYWwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9yZXBvc2l0b3J5LyIsInNvdXJjZXMiOlsic2VsZWN0LW1vZGFsL3JlcG9zaXRvcnktc2VsZWN0LW1vZGFsLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDeEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUNMLE9BQU8sRUFJUCxrQkFBa0IsRUFDbkIsTUFBTSxxQkFBcUIsQ0FBQztBQUM3QixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2hDLE9BQU8sRUFBa0IsV0FBVyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzFELE9BQU8sRUFBRSxPQUFPLEVBQWMsSUFBSSxFQUFFLGVBQWUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNsRSxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBUTFELGtCQUFrQjtBQUNsQixnR0FBZ0c7QUFDaEcscUhBQXFIO0FBQ3JILDZCQUE2QjtBQUM3Qix5QkFBeUI7QUFFekI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0E0Qkc7QUFNSCxJQUFhLDhCQUE4QixHQUEzQyxNQUFhLDhCQUE4QjtJQXlIekMsWUFDVSxpQkFBb0MsRUFDcEMsZ0JBQWtDO1FBRGxDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQTFINUM7Ozs7Ozs7Ozs7OztXQVlHO1FBQ0gsbUNBQThCLEdBQWlDLFNB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RSxLQUFLLEVBQUUsMEJBQTBCLEVBQUU7YUFDMUU7WUFDRCxxQkFBcUIsRUFBRSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLGtCQUFrQixFQUFFO1lBQ2xFLE9BQU87U0FDUixDQUFDO1FBRUYsT0FBTyxpQkFBaUIsQ0FBQztJQUMzQixDQUFDO0NBRUYsQ0FBQTs7WUFySjhCLGlCQUFpQjtZQUNsQixnQkFBZ0I7O0FBM0hqQyw4QkFBOEI7SUFKMUMsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLDZCQUE2QjtRQUN2QyxxWEFBdUQ7S0FDeEQsQ0FBQztHQUNXLDhCQUE4QixDQStRMUM7U0EvUVksOEJBQThCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7XG4gIGdldHRleHQsXG4gIElTZWxlY3RNb2RhbE9iamVjdCxcbiAgSVNlbGVjdE1vZGFsT3B0aW9uLFxuICBNb2RhbExhYmVscyxcbiAgTW9kYWxTZWxlY3Rpb25Nb2RlXG59IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgZ2V0IH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IElNYW5hZ2VkT2JqZWN0LCBRdWVyaWVzVXRpbCB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUsIGZyb20sIEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgc3dpdGNoTWFwLCBtYXAsIG1lcmdlTWFwLCBzaGFyZVJlcGxheSwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUmVwb3NpdG9yeVNlcnZpY2UgfSBmcm9tICcuLi9yZXBvc2l0b3J5LnNlcnZpY2UnO1xuaW1wb3J0IHtcbiAgUmVwb3NpdG9yeVR5cGUsXG4gIFJlcG9zaXRvcnlDYXRlZ29yeSxcbiAgUmVwb3NpdG9yeUJpbmFyeSxcbiAgU2VsZWN0ZWRSZXBvc2l0b3J5QmluYXJ5XG59IGZyb20gJy4uL3JlcG9zaXRvcnkubW9kZWwnO1xuXG4vLyBNT0RBTCBTVFJVQ1RVUkVcbi8vIC0gc2VsZWN0TW9kYWxPYmplY3QgKHJlcG9zaXRvcnkgZW50cnkgKHJlcG9zaXRvcnlDYXRlZ29yeSkgLT4gdHlwZSBjOHlfRmlybXdhcmUvYzh5X1NvZnR3YXJlKVxuLy8gICAtLSBJU2VsZWN0TW9kYWxPcHRpb24gKHJlcG9zaXRvcnkgYmluYXJ5IGVudHJ5IChyZXBvc2l0b3J5QmluYXJ5KSA9PiB0eXBlIGM4eV9GaXJtd2FyZUJpbmFyeS9jOHlfU29mdHdhcmVCaW5hcnkpXG4vLyAgIC0tIElTZWxlY3RNb2RhbE9wdGlvbi4uLlxuLy8gLSBzZWxlY3RNb2RhbE9iamVjdC4uLlxuXG4vKipcbiAqIFJlcG9zaXRvcnlTZWxlY3RNb2RhbENvbXBvbmVudCBkaXNwbGF5cyByZXBvc2l0b3J5IGVudHJpZXMgb3B0aW9ucyBhbmQgYWxsb3dzIHRvIHNlbGVjdCB0aGVtLlxuICpcbiAqIEBleGFtcGxlXG4gKiBgYGBcbiAqIGltcG9ydCB7IHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG4gKiBpbXBvcnQgeyBSZXBvc2l0b3J5U2VsZWN0TW9kYWxDb21wb25lbnQsIE1vZGFsU2VsZWN0aW9uTW9kZSwgUmVwb3NpdG9yeVR5cGUgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL3JlcG9zaXRvcnknO1xuICpcbiAqIGNvbnN0IGluaXRpYWxTdGF0ZSA9IHtcbiAqICAgcmVwb3NpdG9yeVR5cGU6IFJlcG9zaXRvcnlUeXBlLkZJUk1XQVJFLFxuICogICB0aXRsZTogZ2V0dGV4dCgnSW5zdGFsbCBmaXJtd2FyZScpLFxuICogICBzdWJUaXRsZTogZ2V0dGV4dCgnQXZhaWxhYmxlIGZpcm13YXJlcyBtYXRjaGluZyB0aGUgZGV2aWNlIHR5cGUnKSxcbiAqICAgaWNvbjogJ2M4eS1maXJtd2FyZScsXG4gKiAgIG1vZGU6IE1vZGFsU2VsZWN0aW9uTW9kZS5TSU5HTEUsXG4gKiAgIGxhYmVsczogeyBvazogZ2V0dGV4dCgnSW5zdGFsbCcpIH0sXG4gKiAgIGRpc2FibGVTZWxlY3RlZDogZmFsc2VcbiAqIH07XG4gKlxuICogY29uc3QgbW9kYWwgPSB0aGlzLmJzTW9kYWwuc2hvdyhSZXBvc2l0b3J5U2VsZWN0TW9kYWxDb21wb25lbnQsIHtcbiAqICAgaWdub3JlQmFja2Ryb3BDbGljazogdHJ1ZSxcbiAqICAgaW5pdGlhbFN0YXRlXG4gKiB9KTtcbiAqXG4gKiBtb2RhbC5jb250ZW50LmxvYWQubmV4dCgpO1xuICogbW9kYWwuY29udGVudC5yZXN1bHRFbWl0dGVyLnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKChmaXJtd2FyZSkgPT4ge1xuICogICAuLi5cbiAqIH0pXG4gKiBgYGBcbiAqL1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktcmVwb3NpdG9yeS1zZWxlY3QtbW9kYWwnLFxuICB0ZW1wbGF0ZVVybDogJy4vcmVwb3NpdG9yeS1zZWxlY3QtbW9kYWwuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFJlcG9zaXRvcnlTZWxlY3RNb2RhbENvbXBvbmVudCB7XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gcHJvdmlkZSBjdXN0b20gZGF0YS5cbiAgICogQGV4YW1wbGVcbiAgICogYGBgXG4gICAqIGltcG9ydCB7IGZyb20gfSBmcm9tICdyeGpzJztcbiAgICpcbiAgICogY29uc3QgcmVwb3NpdG9yeUVudHJ5ID0geyBuYW1lOiAnRXhhbXBsZUVudHJ5JywgdHlwZTogJ2M4eV9GaXJtd2FyZScgfTtcbiAgICogY29uc3QgdmVyc2lvbnMgPSBbeyBjOHlfRmlybXdhcmU6IHsgdmVyc2lvbjogJzEuMC4wJywgdXJsOiAnaHR0cDovL2V4YW1wbGUuY29tJyB9IH1dO1xuICAgKlxuICAgKiBjb25zdCBpbml0aWFsU3RhdGUgPSB7cmVwb3NpdG9yeUVudHJpZXNXaXRoVmVyc2lvbnMkOiBmcm9tKHsgLi4ucmVwb3NpdG9yeUVudHJ5LCB2ZXJzaW9ucyB9KX07XG4gICAqIGBgYFxuICAgKi9cbiAgcmVwb3NpdG9yeUVudHJpZXNXaXRoVmVyc2lvbnMkOiBPYnNlcnZhYmxlPElNYW5hZ2VkT2JqZWN0W10+ID0gdW5kZWZpbmVkO1xuICAvKipcbiAgICogUmVwb3NpdG9yeSBlbnRyeSB0eXBlLlxuICAgKi9cbiAgcmVwb3NpdG9yeVR5cGU6IFJlcG9zaXRvcnlUeXBlLkZJUk1XQVJFIHwgUmVwb3NpdG9yeVR5cGUuU09GVFdBUkU7XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gdXNlIGN1c3RvbSBiYWRnZXMgdGVtcGxhdGVzLlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGBcbiAgICogaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuICAgKlxuICAgKiBjb25zdCBiYWRnZVRlbXBsYXRlcyA9IHsgJz0xJzogZ2V0dGV4dCgne3tjb3VudH19IHZlcnNpb24nKSwgb3RoZXI6IGdldHRleHQoJ3t7Y291bnR9fSB2ZXJzaW9ucycpIH07XG4gICAqIGNvbnN0IGluaXRpYWxTdGF0ZSA9IHsgYmFkZ2VUZW1wbGF0ZXMgfTtcbiAgICogYGBgXG4gICAqL1xuICBiYWRnZVRlbXBsYXRlcyA9IHsgJz0xJzogZ2V0dGV4dCgne3tjb3VudH19IHZlcnNpb24nKSwgb3RoZXI6IGdldHRleHQoJ3t7Y291bnR9fSB2ZXJzaW9ucycpIH07XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gcHJvdmlkZSBjdXN0b20gbW9kYWwgdGl0bGUuXG4gICAqL1xuICB0aXRsZTogc3RyaW5nID0gZ2V0dGV4dCgnU2VsZWN0IHJlcG9zaXRvcnkgZW50cnknKTtcbiAgLyoqXG4gICAqIE9wdGlvbmFsXG4gICAqIEFsbG93cyB0byBwcm92aWRlIGN1c3RvbSBtb2RhbCBzdWJ0aXRsZS5cbiAgICovXG4gIHN1YlRpdGxlOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBMb2FkcyB0aGUgY29udGVudCBvZiB0aGUgbW9kYWwuXG4gICAqIE11c3QgYmUgaW52b2tlZCBieSB0aGUgbW9kYWwncyBjYWxsZXIuXG4gICAqL1xuICBsb2FkOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3QoKTtcbiAgLyoqXG4gICAqIE9wdGlvbmFsXG4gICAqIEVtaXRzIGEgc2VhcmNoIHN0cmluZyBjdXJyZW50bHkgZW50ZXJlZCBpbiB0aGUgZmlsdGVyIGlucHV0LlxuICAgKiBVc2UgaXQgdG8gZmlsdGVyIHRoZSBpdGVtcyBpZiB5b3UgdXNlIGN1c3RvbSByZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQuXG4gICAqL1xuICBzZWFyY2hUZXJtOiBCZWhhdmlvclN1YmplY3Q8c3RyaW5nPiA9IG5ldyBCZWhhdmlvclN1YmplY3QoJycpO1xuICAvKipcbiAgICogT3B0aW9uYWxcbiAgICogQWxsb3dzIHRvIHByb3ZpZGUgZGV2aWNlIHR5cGUgcXVlcnkgdG8gcmVzdHJpY3Qgc2VhcmNoIGNyaXRlcmlhLlxuICAgKiBPbmx5IHRha2VzIGVmZmVjdCB3aGVuIHJlcG9zaXRvcnlFbnRyaWVzV2l0aFZlcnNpb25zJCBpcyBub3QgcHJvdmlkZWQsXG4gICAqIG90aGVyd2lzZSBtb2RhbCdzIGNhbGxlciBoYXZlIHRvIHByb3ZpZGUgYWxyZWFkeSBmaWx0ZXJlZCBkYXRhIGluIHRoZSByZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQuXG4gICAqL1xuICBkZXZpY2VUeXBlUXVlcnk6IGFueSA9IHt9O1xuICAvKipcbiAgICogT3B0aW9uYWxcbiAgICogQWxsb3dzIHRvIHByb3ZpZGUgcXVlcnkgdG8gcmVzdHJpY3Qgc2VhcmNoIGNyaXRlcmlhLlxuICAgKiBPbmx5IHRha2VzIGVmZmVjdCB3aGVuIHJlcG9zaXRvcnlFbnRyaWVzV2l0aFZlcnNpb25zJCBpcyBub3QgcHJvdmlkZWQsXG4gICAqIG90aGVyd2lzZSBtb2RhbCdzIGNhbGxlciBoYXZlIHRvIHByb3ZpZGUgYWxyZWFkeSBmaWx0ZXJlZCBkYXRhIGluIHRoZSByZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQuXG4gICAqL1xuICBzZWFyY2hRdWVyeTogYW55ID0ge307XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gcHJvdmlkZSBjdXN0b20gbGFiZWxzIGZvciB0aGUgYnV0dG9ucyByZXNwb25zaWJsZSBmb3IgY29uZmlybS9kaXNtaXNzIG1vZGFsIGFjdGlvbnMuXG4gICAqL1xuICBsYWJlbHM6IE1vZGFsTGFiZWxzID0geyBvazogZ2V0dGV4dCgnU2F2ZScpIH07XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gaGlkZSB0aGUgZmlsdGVyIGlucHV0IGZpZWxkLlxuICAgKiBCeSBkZWZhdWx0LCB0aGUgZmlsdGVyIGlucHV0IGZpZWxkIGlzIGRpc3BsYXllZC5cbiAgICovXG4gIHNob3dGaWx0ZXI6IGJvb2xlYW4gPSB0cnVlO1xuICAvKipcbiAgICogT3B0aW9uYWxcbiAgICogQWxsb3dzIHRvIHNob3cgYSB3YXJuaW5nIHRoYXQgdGhlIHNlYXJjaCBjcml0ZXJpYSBzaG91bGQgYmUgbmFycm93ZWQgZG93bi5cbiAgICogQnkgZGVmYXVsdCwgdGhpcyB3YXJuaW5nIGlzIGhpZGRlbi5cbiAgICovXG4gIGFyZU1vcmVFbnRyaWVzOiBib29sZWFuID0gZmFsc2U7XG4gIC8qKlxuICAgKiBPcHRpb25hbFxuICAgKiBBbGxvd3MgdG8gcGFzcyB0aGUgYXJyYXkgb2YgaXRlbXMuIEVhY2ggaXRlbSBmcm9tIHRoaXMgYXJyYXkgd2lsbCBiZSBtYXJrZWQgYXMgc2VsZWN0ZWQgaW4gdGhlIG1vZGFsLlxuICAgKi9cbiAgc2VsZWN0ZWQ6IFNlbGVjdGVkUmVwb3NpdG9yeUJpbmFyeVtdO1xuICAvKipcbiAgICogRW1pdHMgdGhlIGxpc3Qgb2Ygc2VsZWN0ZWQgb3B0aW9ucy5cbiAgICovXG4gIHJlc3VsdEVtaXR0ZXI6IEV2ZW50RW1pdHRlcjxTZWxlY3RlZFJlcG9zaXRvcnlCaW5hcnlbXT4gPSBuZXcgRXZlbnRFbWl0dGVyPFxuICAgIFNlbGVjdGVkUmVwb3NpdG9yeUJpbmFyeVtdXG4gID4oKTtcbiAgLyoqXG4gICAqIE9wdGlvbmFsXG4gICAqIEFsbG93cyB0byBjaGFuZ2Ugc2VsZWN0aW9uIG1vZGUuXG4gICAqIFN1cHBvcnRlZCBvcHRpb25zOlxuICAgKiAgICogc2luZ2xlOiBvbmx5IHNpbmdsZSBvcHRpb24gY2FuIGJlIHNlbGVjdGVkLlxuICAgKiAgICogbXVsdGlwbGU6IG11bHRpcGxlIG9wdGlvbnMgY2FuIGJlIHNlbGVjdGVkLlxuICAgKi9cbiAgbW9kZTogTW9kYWxTZWxlY3Rpb25Nb2RlID0gTW9kYWxTZWxlY3Rpb25Nb2RlLlNJTkdMRTtcbiAgLyoqXG4gICAqIE9wdGlvbmFsXG4gICAqIEFsbG93cyB0byB1c2UgY3VzdG9tIGljb24gaW4gdGhlIG1vZGFsIGhlYWRlci5cbiAgICovXG4gIGljb246IHN0cmluZztcbiAgLyoqXG4gICAqIEFsbG93cyB0byBibG9jayBzZWxlY3Rpb24gb2YgdGhlIG90aGVyIHZlcnNpb25zIGZyb20gdGhlIHNhbWUgcmVwb3NpdG9yeSBlbnRyeS5cbiAgICovXG4gIGRpc2FibGVTZWxlY3RlZDogYm9vbGVhbiA9IHRydWU7XG4gIG1vZGFsRW50cmllczogT2JzZXJ2YWJsZTxJU2VsZWN0TW9kYWxPYmplY3RbXT4gPSB0aGlzLmxvYWQucGlwZShcbiAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5yZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQpLFxuICAgIG1lcmdlTWFwKG1vcyA9PiB0aGlzLmFnZ3JlZ2F0ZShtb3MpKSxcbiAgICB0YXAoaXRlbXMgPT4ge1xuICAgICAgdGhpcy5hcmVNb3JlRW50cmllcyA9IGl0ZW1zLmxlbmd0aCA+PSB0aGlzLlBBR0VfU0laRSA/IHRydWUgOiBmYWxzZTtcbiAgICB9KVxuICApO1xuICBwcml2YXRlIFBBR0VfU0laRSA9IDEwMDtcbiAgcHJpdmF0ZSBxdWVyaWVzVXRpbDogUXVlcmllc1V0aWw7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5U2VydmljZTogUmVwb3NpdG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSB0cmFuc2xhdGVTZXJ2aWNlOiBUcmFuc2xhdGVTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMucXVlcmllc1V0aWwgPSBuZXcgUXVlcmllc1V0aWwoKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICghdGhpcy5yZXBvc2l0b3J5VHlwZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZXBvc2l0b3J5IHR5cGUgbXVzdCBiZSBkZWZpbmVkJyk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnJlcG9zaXRvcnlFbnRyaWVzV2l0aFZlcnNpb25zJCkge1xuICAgICAgdGhpcy5yZXBvc2l0b3J5RW50cmllc1dpdGhWZXJzaW9ucyQgPSBmcm9tKFxuICAgICAgICB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmxpc3RSZXBvc2l0b3J5RW50cmllcyh0aGlzLnJlcG9zaXRvcnlUeXBlLCB7XG4gICAgICAgICAgcXVlcnk6IHRoaXMucXVlcmllc1V0aWwuYWRkT3JGaWx0ZXIodGhpcy5kZXZpY2VUeXBlUXVlcnksIHRoaXMuc2VhcmNoUXVlcnkpLFxuICAgICAgICAgIHBhcmFtczogeyBwYWdlU2l6ZTogdGhpcy5QQUdFX1NJWkUgfVxuICAgICAgICB9KVxuICAgICAgKS5waXBlKFxuICAgICAgICBtYXAoKHsgZGF0YSB9KSA9PiBkYXRhKSxcbiAgICAgICAgbWFwKG1vcyA9PiB0aGlzLmdldEFuZEFzc2lnblJlcG9zaXRvcnlCaW5hcmllcyhtb3MpKSxcbiAgICAgICAgc2hhcmVSZXBsYXkoMSlcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgZ2V0QW5kQXNzaWduUmVwb3NpdG9yeUJpbmFyaWVzKG1vczogSU1hbmFnZWRPYmplY3RbXSkge1xuICAgIG1vcy5mb3JFYWNoKG1vID0+IHtcbiAgICAgIG1vLnZlcnNpb25zID0gdGhpcy5yZXBvc2l0b3J5U2VydmljZS5saXN0QWxsVmVyc2lvbnMobW8pO1xuICAgIH0pO1xuICAgIHJldHVybiBtb3M7XG4gIH1cblxuICBzZWFyY2goc2VhcmNoVGVybTogc3RyaW5nKSB7XG4gICAgdGhpcy5zZWFyY2hUZXJtLm5leHQoc2VhcmNoVGVybSk7XG4gICAgaWYgKCFzZWFyY2hUZXJtKSB7XG4gICAgICB0aGlzLnNlYXJjaFF1ZXJ5ID0ge307XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2VhcmNoUXVlcnkgPSB7IG5hbWU6IGAqJHtzZWFyY2hUZXJtfSpgIH07XG4gICAgfVxuICAgIHRoaXMubG9hZC5uZXh0KCk7XG4gIH1cblxuICByZXN1bHQoc2VsZWN0ZWRJdGVtczogU2VsZWN0ZWRSZXBvc2l0b3J5QmluYXJ5W10pIHtcbiAgICB0aGlzLnJlc3VsdEVtaXR0ZXIuZW1pdChzZWxlY3RlZEl0ZW1zKTtcbiAgfVxuXG4gIGFzeW5jIGFnZ3JlZ2F0ZShtb3M6IElNYW5hZ2VkT2JqZWN0W10pOiBQcm9taXNlPElTZWxlY3RNb2RhbE9iamVjdFtdPiB7XG4gICAgY29uc3QgcmVwb3NpdG9yeVR5cGUgPSB0aGlzLnJlcG9zaXRvcnlUeXBlO1xuICAgIGNvbnN0IHNlbGVjdGVkSXRlbXM6IFNlbGVjdGVkUmVwb3NpdG9yeUJpbmFyeVtdID0gdGhpcy5zZWxlY3RlZDtcblxuICAgIHJldHVybiBQcm9taXNlLmFsbChcbiAgICAgIG1vcy5tYXAoYXN5bmMgcmVwb3NpdG9yeUVudHJ5ID0+IHtcbiAgICAgICAgY29uc3Qgb3B0aW9uczogSVNlbGVjdE1vZGFsT3B0aW9uW10gPSB0aGlzLmdldFNlbGVjdE1vZGFsT3B0aW9ucyhcbiAgICAgICAgICBhd2FpdCB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmZldGNoQWxsSXRlbXNGcm9tTGlzdChyZXBvc2l0b3J5RW50cnkudmVyc2lvbnMpLFxuICAgICAgICAgIHNlbGVjdGVkSXRlbXMsXG4gICAgICAgICAgcmVwb3NpdG9yeUVudHJ5IGFzIFJlcG9zaXRvcnlDYXRlZ29yeSxcbiAgICAgICAgICByZXBvc2l0b3J5VHlwZVxuICAgICAgICApO1xuICAgICAgICBjb25zdCBzZWxlY3RNb2RhbE9iamVjdCA9IHRoaXMuZ2V0U2VsZWN0TW9kYWxPYmplY3QoXG4gICAgICAgICAgcmVwb3NpdG9yeUVudHJ5IGFzIFJlcG9zaXRvcnlDYXRlZ29yeSxcbiAgICAgICAgICBvcHRpb25zXG4gICAgICAgICk7XG5cbiAgICAgICAgcmV0dXJuIHNlbGVjdE1vZGFsT2JqZWN0O1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgZ2V0U2VsZWN0TW9kYWxPcHRpb25zKFxuICAgIHZlcnNpb25zOiBSZXBvc2l0b3J5QmluYXJ5W10sXG4gICAgc2VsZWN0ZWRJdGVtczogU2VsZWN0ZWRSZXBvc2l0b3J5QmluYXJ5W10sXG4gICAgcmVwb3NpdG9yeUVudHJ5OiBSZXBvc2l0b3J5Q2F0ZWdvcnksXG4gICAgcmVwb3NpdG9yeVR5cGU6IFJlcG9zaXRvcnlUeXBlXG4gICk6IElTZWxlY3RNb2RhbE9wdGlvbltdIHtcbiAgICBjb25zdCBzZWxlY3RNb2RhbE9wdGlvbnM6IElTZWxlY3RNb2RhbE9wdGlvbltdID0gW107XG4gICAgdmVyc2lvbnMuZm9yRWFjaChyZXBvc2l0b3J5QmluYXJ5ID0+IHtcbiAgICAgIGNvbnN0IGlzU2VsZWN0ZWQ6IGJvb2xlYW4gPSB0aGlzLmlzQmluYXJ5UmVwb3NpdG9yeVNlbGVjdGVkKFxuICAgICAgICBzZWxlY3RlZEl0ZW1zLFxuICAgICAgICByZXBvc2l0b3J5RW50cnksXG4gICAgICAgIHJlcG9zaXRvcnlCaW5hcnksXG4gICAgICAgIHJlcG9zaXRvcnlUeXBlXG4gICAgICApO1xuXG4gICAgICBjb25zdCB7IHZlcnNpb24gfSA9IHJlcG9zaXRvcnlCaW5hcnlbYCR7cmVwb3NpdG9yeVR5cGV9YF07XG4gICAgICBjb25zdCBib2R5VmFsdWUgPVxuICAgICAgICB2ZXJzaW9uIHx8IGAoJHt0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuaW5zdGFudChnZXR0ZXh0KCdub3Qgc3BlY2lmaWVkYHZlcnNpb25gJykpfSlgO1xuICAgICAgY29uc3QgYm9keUNsYXNzID0gdmVyc2lvbiA/ICcnIDogJ3RleHQtbXV0ZWQnO1xuICAgICAgc2VsZWN0TW9kYWxPcHRpb25zLnB1c2goe1xuICAgICAgICBib2R5OiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgdmFsdWU6IGJvZHlWYWx1ZSxcbiAgICAgICAgICAgIGNsYXNzOiBib2R5Q2xhc3NcbiAgICAgICAgICB9XG4gICAgICAgIF0sXG4gICAgICAgIG9iajoge1xuICAgICAgICAgIGlkOiByZXBvc2l0b3J5QmluYXJ5LmlkLFxuICAgICAgICAgIG5hbWU6IHJlcG9zaXRvcnlFbnRyeS5uYW1lLFxuICAgICAgICAgIHZlcnNpb24sXG4gICAgICAgICAgLi4uKGdldChyZXBvc2l0b3J5QmluYXJ5LCAnYzh5X1BhdGNoLmRlcGVuZGVuY3knKSAmJiB7XG4gICAgICAgICAgICBkZXBlbmRlbmN5OiBnZXQocmVwb3NpdG9yeUJpbmFyeSwgJ2M4eV9QYXRjaC5kZXBlbmRlbmN5JylcbiAgICAgICAgICB9KSxcbiAgICAgICAgICAuLi4oZ2V0KHJlcG9zaXRvcnlCaW5hcnksICdjOHlfUGF0Y2gnKSAmJiB7IGM4eV9QYXRjaDogdHJ1ZSB9KSxcbiAgICAgICAgICB1cmw6IHJlcG9zaXRvcnlCaW5hcnlbYCR7cmVwb3NpdG9yeVR5cGV9YF0udXJsXG4gICAgICAgIH0sXG4gICAgICAgIHNlbGVjdGVkOiBpc1NlbGVjdGVkXG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gc2VsZWN0TW9kYWxPcHRpb25zO1xuICB9XG5cbiAgaXNCaW5hcnlSZXBvc2l0b3J5U2VsZWN0ZWQoXG4gICAgc2VsZWN0ZWRJdGVtczogU2VsZWN0ZWRSZXBvc2l0b3J5QmluYXJ5W10sXG4gICAgcmVwb3NpdG9yeUVudHJ5OiBSZXBvc2l0b3J5Q2F0ZWdvcnksXG4gICAgcmVwb3NpdG9yeUJpbmFyeTogUmVwb3NpdG9yeUJpbmFyeSxcbiAgICByZXBvc2l0b3J5VHlwZTogUmVwb3NpdG9yeVR5cGVcbiAgKTogYm9vbGVhbiB7XG4gICAgY29uc3QgaXNTZWxlY3RlZCA9IHNlbGVjdGVkSXRlbXNcbiAgICAgID8gc2VsZWN0ZWRJdGVtcy5maWx0ZXIoXG4gICAgICAgICAgcmVwb3NpdG9yeUZyYWdtZW50ID0+XG4gICAgICAgICAgICByZXBvc2l0b3J5RnJhZ21lbnQubmFtZSA9PT0gcmVwb3NpdG9yeUVudHJ5Lm5hbWUgJiZcbiAgICAgICAgICAgIHJlcG9zaXRvcnlGcmFnbWVudC52ZXJzaW9uID09PSByZXBvc2l0b3J5QmluYXJ5W2Ake3JlcG9zaXRvcnlUeXBlfWBdLnZlcnNpb25cbiAgICAgICAgKS5sZW5ndGggPiAwXG4gICAgICA6IGZhbHNlO1xuXG4gICAgcmV0dXJuIGlzU2VsZWN0ZWQ7XG4gIH1cblxuICBnZXRTZWxlY3RNb2RhbE9iamVjdChcbiAgICByZXBvc2l0b3J5RW50cnk6IFJlcG9zaXRvcnlDYXRlZ29yeSxcbiAgICBvcHRpb25zOiBJU2VsZWN0TW9kYWxPcHRpb25bXVxuICApOiBJU2VsZWN0TW9kYWxPYmplY3Qge1xuICAgIGNvbnN0IGxhYmVsID1cbiAgICAgIG9wdGlvbnMubGVuZ3RoID09PSAxXG4gICAgICAgID8gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQodGhpcy5iYWRnZVRlbXBsYXRlc1snPTEnXSwgeyBjb3VudDogb3B0aW9ucy5sZW5ndGggfSlcbiAgICAgICAgOiB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuaW5zdGFudCh0aGlzLmJhZGdlVGVtcGxhdGVzLm90aGVyLCB7IGNvdW50OiBvcHRpb25zLmxlbmd0aCB9KTtcblxuICAgIGNvbnN0IHNlbGVjdE1vZGFsT2JqZWN0OiBJU2VsZWN0TW9kYWxPYmplY3QgPSB7XG4gICAgICBncm91cElkOiByZXBvc2l0b3J5RW50cnkuaWQsXG4gICAgICBib2R5OiBbXG4gICAgICAgIHsgdmFsdWU6IHJlcG9zaXRvcnlFbnRyeS5uYW1lLCBjbGFzczogJ3RleHQtdHJ1bmNhdGUnIH0sXG4gICAgICAgIHsgdmFsdWU6IHJlcG9zaXRvcnlFbnRyeS5kZXNjcmlwdGlvbiwgY2xhc3M6ICd0ZXh0LXRydW5jYXRlIHRleHQtbXV0ZWQnIH1cbiAgICAgIF0sXG4gICAgICBhZGRpdGlvbmFsSW5mb3JtYXRpb246IHsgdmFsdWU6IGxhYmVsLCBjbGFzczogJ2xhYmVsIGxhYmVsLWluZm8nIH0sXG4gICAgICBvcHRpb25zXG4gICAgfTtcblxuICAgIHJldHVybiBzZWxlY3RNb2RhbE9iamVjdDtcbiAgfVxuXG59XG4iXX0=