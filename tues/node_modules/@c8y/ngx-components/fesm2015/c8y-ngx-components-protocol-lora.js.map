{"version":3,"file":"c8y-ngx-components-protocol-lora.js","sources":["ng://@c8y/ngx-components/protocol-lora/lora-set-device-protocol.service.ts","ng://@c8y/ngx-components/protocol-lora/lora-set-device-protocol.component.ts","ng://@c8y/ngx-components/protocol-lora/lora-agent.guard.ts","ng://@c8y/ngx-components/protocol-lora/lora-protocol.module.ts","ng://@c8y/ngx-components/protocol-lora/c8y-ngx-components-protocol-lora.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { IManagedObject, InventoryService, IResultList } from '@c8y/client';\n\n@Injectable()\nexport class LoraSetDeviceProtocolService {\n  constructor(\n    private inventoryService: InventoryService) { }\n\n  async getCurrentProtocol(device: IManagedObject) {\n    const protocolId = device.c8y_LpwanDevice.type\n      ? device.c8y_LpwanDevice.type.split('/')[2]\n      : null;\n    if (!protocolId) {\n      return null;\n    }\n    const { data } = await this.inventoryService.detail(protocolId);\n    return data;\n  }\n\n  async applyProtocol(device: IManagedObject, selectedProtocol: IManagedObject) {\n    device.c8y_LpwanDevice.type = 'inventory/managedObjects/' + selectedProtocol.id;\n    device.type = selectedProtocol.name;\n    return this.inventoryService.update(device);\n  }\n\n  async getAvailableProtocols(): Promise<IResultList<IManagedObject>> {\n    const query = {\n      type: {\n        __in: ['c8y_ActilityDeviceType', 'c8y_LoraDeviceType']\n      }\n    };\n    return this.inventoryService.listQuery(query);\n  }\n}\n","import { Component, OnInit, ViewChild } from '@angular/core';\nimport { LoraSetDeviceProtocolService } from './lora-set-device-protocol.service';\nimport { AlertService, gettext } from '@c8y/ngx-components';\nimport { IManagedObject, InventoryService, IResultList } from '@c8y/client';\nimport { Router } from '@angular/router';\nimport { pipe } from 'rxjs';\nimport { map } from 'rxjs/operators';\n\n@Component({\n  selector: 'set-device-protocol',\n  templateUrl: './lora-set-device-protocol.component.html'\n})\n\nexport class LoraAssignDeviceProtocolComponent implements OnInit {\n  loading: boolean;\n  device: IManagedObject;\n  currentProtocol: IManagedObject;\n  availableProtocols: IResultList<IManagedObject>;\n  newProtocol: IManagedObject;\n\n  filterCurrentProtocol = pipe(\n    map((protocols: IManagedObject[]) =>\n      protocols.filter(protocol => !this.currentProtocol || this.currentProtocol.id !== protocol.id)\n    )\n  );\n  @ViewChild('loraSetDeviceProtocolForm', { static: false }) loraSetDeviceProtocolForm: any;\n\n  constructor(\n    private loraService: LoraSetDeviceProtocolService,\n    private alertService: AlertService,\n    private router: Router,\n    private inventoryService: InventoryService\n  ) { }\n  async ngOnInit() {\n    await this.reload();\n  }\n\n  async reload() {\n    this.loading = true;\n    this.newProtocol = null;\n    try {\n      await this.loadDevice();\n      this.availableProtocols = await this.loraService.getAvailableProtocols();\n      this.currentProtocol = await this.loraService.getCurrentProtocol(this.device);\n    } catch (ex) {\n      this.alertService.addServerFailure(ex);\n    } finally {\n      this.loading = false;\n    }\n  }\n\n  async loadDevice() {\n    const deviceId = this.router.routerState.snapshot.url.match(/\\d+/)[0];\n    const { data } = await this.inventoryService.detail(deviceId);\n    this.device = data;\n  }\n\n  async apply(selectedProtocol) {\n    try {\n      await this.loraService.applyProtocol(this.device, selectedProtocol);\n      await this.reload();\n      this.alertService.success(gettext('Device protocol set.'));\n      this.loraSetDeviceProtocolForm.reset('dirty');\n    } catch (ex) {\n      this.alertService.danger(gettext('Could not set device protocol.'));\n    }\n  }\n}\n","import { Injectable } from '@angular/core';\nimport { ActivatedRouteSnapshot, CanActivate } from '@angular/router';\nimport {\n  isUndefined\n} from 'lodash-es';\nimport { Observable } from 'rxjs';\n\n@Injectable()\nexport class LoraAgentGuard implements CanActivate {\n  canActivate(route: ActivatedRouteSnapshot): boolean {\n    const contextData = route.data.contextData || route.parent.data.contextData;\n    return contextData && !isUndefined(contextData.c8y_LpwanDevice) && (contextData.c8y_LpwanDevice.lpwanDeviceType === 'Lora');\n  }\n}\n","import { NgModule } from '@angular/core';\nimport {\n  CoreModule,\n  FormsModule,\n  gettext,\n  HOOK_ONCE_ROUTE,\n  Route,\n  ViewContext\n} from '@c8y/ngx-components';\nimport { LoraAssignDeviceProtocolComponent } from './lora-set-device-protocol.component';\nimport { LoraAgentGuard } from './lora-agent.guard';\nimport { LoraSetDeviceProtocolService } from './lora-set-device-protocol.service';\n\nconst routes: Route[] = [\n  {\n    context: ViewContext.Device,\n    path: 'assign-protocol',\n    component: LoraAssignDeviceProtocolComponent,\n    label: gettext('LPWAN'),\n    icon: 'c8y-device-protocols',\n    canActivate: [LoraAgentGuard]\n  }\n];\n\n@NgModule({\n  declarations: [\n    LoraAssignDeviceProtocolComponent\n  ],\n  imports: [\n    CoreModule,\n    FormsModule\n  ],\n  entryComponents: [LoraAssignDeviceProtocolComponent],\n  providers: [\n    LoraAgentGuard,\n    LoraSetDeviceProtocolService,\n    {\n      provide: HOOK_ONCE_ROUTE,\n      useValue: routes,\n      multi: true\n    }\n  ]\n})\nexport class LoraProtocolModule { }\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n\nexport {LoraAgentGuard as ɵb} from './lora-agent.guard';\nexport {LoraSetDeviceProtocolService as ɵa} from './lora-set-device-protocol.service';"],"names":["tslib_1.__decorate"],"mappings":"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"}