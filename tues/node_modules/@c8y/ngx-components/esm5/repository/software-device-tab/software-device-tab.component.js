import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { BehaviorSubject } from 'rxjs';
import { map } from 'rxjs/operators';
import { IManagedObject, InventoryService, OperationStatus, IOperation } from '@c8y/client';
import { RepositoryType } from '../repository.model';
import { RepositoryService } from '../repository.service';
var SoftwareDeviceTabComponent = /** @class */ (function () {
    function SoftwareDeviceTabComponent(route, repository, inventory) {
        var _this = this;
        this.route = route;
        this.repository = repository;
        this.inventory = inventory;
        this.deviceId = this.route.snapshot.parent.data.contextData.id;
        this.device$ = new BehaviorSubject(this.route.snapshot.parent.data.contextData);
        this.deviceTypeQuery$ = this.device$.pipe(map(function (device) { return _this.repository.getDeviceTypeQuery(RepositoryType.SOFTWARE, device); }));
        this.list$ = this.device$.pipe(map(function (device) { return _this.repository.getDeviceSoftwareList(device); }));
        this.changes$ = new BehaviorSubject([]);
        this.changesOperation$ = new BehaviorSubject(null);
        this.changesInProgress$ = this.changesOperation$.pipe(map(function (operation) { return _this.isInProgress(operation); }));
        this.reloading = false;
    }
    SoftwareDeviceTabComponent.prototype.ngOnInit = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.loadDevice()];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.loadOperation()];
                    case 2:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    SoftwareDeviceTabComponent.prototype.addChanges = function (requestedChanges) {
        var _this = this;
        var stagedChanges = tslib_1.__spread(this.changes$.value);
        requestedChanges.forEach(function (requestedChange) {
            var alreadyStaged = stagedChanges.some(function (stagedChange) {
                return _this.areSameChanges(stagedChange, requestedChange);
            });
            if (!alreadyStaged) {
                stagedChanges = tslib_1.__spread(stagedChanges, [requestedChange]);
            }
        });
        this.changes$.next(stagedChanges);
    };
    SoftwareDeviceTabComponent.prototype.dropChange = function (changeToBeDropped) {
        var _this = this;
        var stagedChanges = tslib_1.__spread(this.changes$.value);
        stagedChanges = stagedChanges.filter(function (stagedChange) { return !_this.areSameChanges(stagedChange, changeToBeDropped); });
        this.changes$.next(stagedChanges);
    };
    SoftwareDeviceTabComponent.prototype.areSameChanges = function (change1, change2) {
        return change1.name === change2.name &&
            change1.version === change2.version &&
            change1.action === change2.action;
    };
    SoftwareDeviceTabComponent.prototype.clearChanges = function () {
        this.changes$.next([]);
    };
    SoftwareDeviceTabComponent.prototype.loadDevice = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var device;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.reloading = true;
                        return [4 /*yield*/, this.inventory.detail(this.deviceId, { withChildren: false })];
                    case 1:
                        device = (_a.sent()).data;
                        this.device$.next(device);
                        this.reloading = false;
                        return [2 /*return*/];
                }
            });
        });
    };
    SoftwareDeviceTabComponent.prototype.applyChanges = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var operation;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.repository.createSoftwareUpdateOperation(this.device$.value, this.changes$.value)];
                    case 1:
                        operation = _a.sent();
                        this.trackOperation(operation);
                        return [2 /*return*/];
                }
            });
        });
    };
    SoftwareDeviceTabComponent.prototype.loadOperation = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var operation;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.repository.getLastSoftwareUpdateOperation(this.deviceId)];
                    case 1:
                        operation = _a.sent();
                        this.trackOperation(operation);
                        return [2 /*return*/];
                }
            });
        });
    };
    SoftwareDeviceTabComponent.prototype.trackOperation = function (operation) {
        var _this = this;
        this.changesOperation$.next(operation);
        if (this.isInProgress(operation)) {
            this.displayChangesFromOperation(operation);
            this.repository.observeOperation(operation).subscribe(function (operationUpdate) {
                _this.changesOperation$.next(operationUpdate);
                if (operationUpdate.status === OperationStatus.SUCCESSFUL) {
                    _this.clearChanges();
                    _this.loadDevice();
                }
            }, function (operationUpdate) {
                _this.changesOperation$.next(operationUpdate);
            });
        }
    };
    SoftwareDeviceTabComponent.prototype.displayChangesFromOperation = function (operation) {
        var changes = this.repository.getDeviceSoftwareChangesFromOperation(operation, this.device$.value);
        this.changes$.next(changes);
    };
    SoftwareDeviceTabComponent.prototype.isInProgress = function (operation) {
        return (operation && [OperationStatus.PENDING, OperationStatus.EXECUTING].includes(operation.status));
    };
    SoftwareDeviceTabComponent.ctorParameters = function () { return [
        { type: ActivatedRoute },
        { type: RepositoryService },
        { type: InventoryService }
    ]; };
    SoftwareDeviceTabComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-software-device-tab',
            template: "<c8y-action-bar-item [placement]=\"'right'\">\n  <button class=\"btn btn-link\" title=\"{{ 'Reload' | translate }}\" (click)=\"loadDevice()\">\n    <i c8yIcon=\"refresh\" [ngClass]=\"{ 'fa-spin': reloading }\"></i>\n    {{ 'Reload' | translate }}\n  </button>\n</c8y-action-bar-item>\n\n<div class=\"card d-grid grid__col--8-4--md m-b-0\">\n  <c8y-installed-software\n    class=\"card--fullpage bg-white\"\n    [deviceTypeQuery]=\"deviceTypeQuery$ | async\"\n    [softwareList]=\"list$ | async\"\n    [deviceSoftwareChanges]=\"changes$ | async\"\n    [deviceSoftwareChangesOperation]=\"changesOperation$ | async\"\n    [deviceSoftwareChangesInProgress]=\"changesInProgress$ | async\"\n    (changes)=\"addChanges($event)\"\n  ></c8y-installed-software>\n  <c8y-device-software-changes\n    class=\"card--fullpage bg-gray-white\"\n    [changes]=\"changes$ | async\"\n    [changesInProgress]=\"changesInProgress$ | async\"\n    (clear)=\"clearChanges()\"\n    (drop)=\"dropChange($event)\"\n    (apply)=\"applyChanges()\"\n  ></c8y-device-software-changes>\n</div>\n"
        })
    ], SoftwareDeviceTabComponent);
    return SoftwareDeviceTabComponent;
}());
export { SoftwareDeviceTabComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29mdHdhcmUtZGV2aWNlLXRhYi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL3JlcG9zaXRvcnkvIiwic291cmNlcyI6WyJzb2Z0d2FyZS1kZXZpY2UtdGFiL3NvZnR3YXJlLWRldmljZS10YWIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLE1BQU0sZUFBZSxDQUFDO0FBQ2xELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNqRCxPQUFPLEVBQWMsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyQyxPQUFPLEVBQUUsY0FBYyxFQUFFLGdCQUFnQixFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDNUYsT0FBTyxFQUF3QyxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMzRixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQU0xRDtJQWdCRSxvQ0FDVSxLQUFxQixFQUNyQixVQUE2QixFQUM3QixTQUEyQjtRQUhyQyxpQkFJSTtRQUhNLFVBQUssR0FBTCxLQUFLLENBQWdCO1FBQ3JCLGVBQVUsR0FBVixVQUFVLENBQW1CO1FBQzdCLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBbEJyQyxhQUFRLEdBQW9CLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQztRQUMzRSxZQUFPLEdBQUcsSUFBSSxlQUFlLENBQWlCLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDM0YscUJBQWdCLEdBQXVCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUN0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LENBQUM7b0JBQ3BCLEtBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztpQkFDbkI7WUFDSCxDQUFDLEVBQ0QsVUFBQSxlQUFlO2dCQUNiLEtBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDL0MsQ0FBQyxDQUNGLENBQUM7U0FDSDtJQUNILENBQUM7SUFFTyxnRUFBMkIsR0FBbkMsVUFBb0MsU0FBcUI7UUFDdkQsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxxQ0FBcUMsQ0FDbkUsU0FBUyxFQUNULElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUNuQixDQUFDO1FBQ0YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDOUIsQ0FBQztJQUVPLGlEQUFZLEdBQXBCLFVBQXFCLFNBQXFCO1FBQ3hDLE9BQU8sQ0FDTCxTQUFTLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUM3RixDQUFDO0lBQ0osQ0FBQzs7Z0JBMUZnQixjQUFjO2dCQUNULGlCQUFpQjtnQkFDbEIsZ0JBQWdCOztJQW5CMUIsMEJBQTBCO1FBSnRDLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSx5QkFBeUI7WUFDbkMsbWpDQUFpRDtTQUNsRCxDQUFDO09BQ1csMEJBQTBCLENBNEd0QztJQUFELGlDQUFDO0NBQUEsQUE1R0QsSUE0R0M7U0E1R1ksMEJBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IE9ic2VydmFibGUsIEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSU1hbmFnZWRPYmplY3QsIEludmVudG9yeVNlcnZpY2UsIE9wZXJhdGlvblN0YXR1cywgSU9wZXJhdGlvbiB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IERldmljZVNvZnR3YXJlLCBEZXZpY2VTb2Z0d2FyZUNoYW5nZSwgUmVwb3NpdG9yeVR5cGUgfSBmcm9tICcuLi9yZXBvc2l0b3J5Lm1vZGVsJztcbmltcG9ydCB7IFJlcG9zaXRvcnlTZXJ2aWNlIH0gZnJvbSAnLi4vcmVwb3NpdG9yeS5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXNvZnR3YXJlLWRldmljZS10YWInLFxuICB0ZW1wbGF0ZVVybDogJ3NvZnR3YXJlLWRldmljZS10YWIuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFNvZnR3YXJlRGV2aWNlVGFiQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgZGV2aWNlSWQ6IHN0cmluZyB8IG51bWJlciA9IHRoaXMucm91dGUuc25hcHNob3QucGFyZW50LmRhdGEuY29udGV4dERhdGEuaWQ7XG4gIGRldmljZSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PElNYW5hZ2VkT2JqZWN0Pih0aGlzLnJvdXRlLnNuYXBzaG90LnBhcmVudC5kYXRhLmNvbnRleHREYXRhKTtcbiAgZGV2aWNlVHlwZVF1ZXJ5JDogT2JzZXJ2YWJsZTxvYmplY3Q+ID0gdGhpcy5kZXZpY2UkLnBpcGUoXG4gICAgbWFwKGRldmljZSA9PiB0aGlzLnJlcG9zaXRvcnkuZ2V0RGV2aWNlVHlwZVF1ZXJ5KFJlcG9zaXRvcnlUeXBlLlNPRlRXQVJFLCBkZXZpY2UpKVxuICApO1xuICBsaXN0JDogT2JzZXJ2YWJsZTxEZXZpY2VTb2Z0d2FyZVtdPiA9IHRoaXMuZGV2aWNlJC5waXBlKFxuICAgIG1hcChkZXZpY2UgPT4gdGhpcy5yZXBvc2l0b3J5LmdldERldmljZVNvZnR3YXJlTGlzdChkZXZpY2UpKVxuICApO1xuICBjaGFuZ2VzJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8RGV2aWNlU29mdHdhcmVDaGFuZ2VbXT4oW10pO1xuICBjaGFuZ2VzT3BlcmF0aW9uJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8SU9wZXJhdGlvbj4obnVsbCk7XG4gIGNoYW5nZXNJblByb2dyZXNzJDogT2JzZXJ2YWJsZTxib29sZWFuPiA9IHRoaXMuY2hhbmdlc09wZXJhdGlvbiQucGlwZShcbiAgICBtYXAob3BlcmF0aW9uID0+IHRoaXMuaXNJblByb2dyZXNzKG9wZXJhdGlvbikpXG4gICk7XG4gIHJlbG9hZGluZzogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcm91dGU6IEFjdGl2YXRlZFJvdXRlLFxuICAgIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnk6IEludmVudG9yeVNlcnZpY2VcbiAgKSB7fVxuXG4gIGFzeW5jIG5nT25Jbml0KCkge1xuICAgIGF3YWl0IHRoaXMubG9hZERldmljZSgpO1xuICAgIGF3YWl0IHRoaXMubG9hZE9wZXJhdGlvbigpO1xuICB9XG5cbiAgYWRkQ2hhbmdlcyhyZXF1ZXN0ZWRDaGFuZ2VzOiBEZXZpY2VTb2Z0d2FyZUNoYW5nZVtdKSB7XG4gICAgbGV0IHN0YWdlZENoYW5nZXMgPSBbLi4udGhpcy5jaGFuZ2VzJC52YWx1ZV07XG4gICAgcmVxdWVzdGVkQ2hhbmdlcy5mb3JFYWNoKHJlcXVlc3RlZENoYW5nZSA9PiB7XG4gICAgICBjb25zdCBhbHJlYWR5U3RhZ2VkID0gc3RhZ2VkQ2hhbmdlcy5zb21lKHN0YWdlZENoYW5nZSA9PlxuICAgICAgICB0aGlzLmFyZVNhbWVDaGFuZ2VzKHN0YWdlZENoYW5nZSwgcmVxdWVzdGVkQ2hhbmdlKSk7XG4gICAgICBpZiAoIWFscmVhZHlTdGFnZWQpIHtcbiAgICAgICAgc3RhZ2VkQ2hhbmdlcyA9IFsuLi5zdGFnZWRDaGFuZ2VzLCByZXF1ZXN0ZWRDaGFuZ2VdO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMuY2hhbmdlcyQubmV4dChzdGFnZWRDaGFuZ2VzKTtcbiAgfVxuXG4gIGRyb3BDaGFuZ2UoY2hhbmdlVG9CZURyb3BwZWQ6IERldmljZVNvZnR3YXJlQ2hhbmdlKSB7XG4gICAgbGV0IHN0YWdlZENoYW5nZXMgPSBbLi4udGhpcy5jaGFuZ2VzJC52YWx1ZV07XG4gICAgc3RhZ2VkQ2hhbmdlcyA9IHN0YWdlZENoYW5nZXMuZmlsdGVyKHN0YWdlZENoYW5nZSA9PiAhdGhpcy5hcmVTYW1lQ2hhbmdlcyhzdGFnZWRDaGFuZ2UsIGNoYW5nZVRvQmVEcm9wcGVkKSk7XG4gICAgdGhpcy5jaGFuZ2VzJC5uZXh0KHN0YWdlZENoYW5nZXMpO1xuICB9XG5cbiAgYXJlU2FtZUNoYW5nZXMoY2hhbmdlMTogRGV2aWNlU29mdHdhcmVDaGFuZ2UsIGNoYW5nZTI6IERldmljZVNvZnR3YXJlQ2hhbmdlKSB7XG4gICAgcmV0dXJuIGNoYW5nZTEubmFtZSA9PT0gY2hhbmdlMi5uYW1lICYmXG4gICAgICBjaGFuZ2UxLnZlcnNpb24gPT09IGNoYW5nZTIudmVyc2lvbiAmJlxuICAgICAgY2hhbmdlMS5hY3Rpb24gPT09IGNoYW5nZTIuYWN0aW9uO1xuICB9XG5cbiAgY2xlYXJDaGFuZ2VzKCkge1xuICAgIHRoaXMuY2hhbmdlcyQubmV4dChbXSk7XG4gIH1cblxuICBhc3luYyBsb2FkRGV2aWNlKCkge1xuICAgIHRoaXMucmVsb2FkaW5nID0gdHJ1ZTtcbiAgICBjb25zdCBkZXZpY2UgPSAoYXdhaXQgdGhpcy5pbnZlbnRvcnkuZGV0YWlsKHRoaXMuZGV2aWNlSWQsIHsgd2l0aENoaWxkcmVuOiBmYWxzZSB9KSkuZGF0YTtcbiAgICB0aGlzLmRldmljZSQubmV4dChkZXZpY2UpO1xuICAgIHRoaXMucmVsb2FkaW5nID0gZmFsc2U7XG4gIH1cblxuICBhc3luYyBhcHBseUNoYW5nZXMoKSB7XG4gICAgY29uc3Qgb3BlcmF0aW9uID0gYXdhaXQgdGhpcy5yZXBvc2l0b3J5LmNyZWF0ZVNvZnR3YXJlVXBkYXRlT3BlcmF0aW9uKFxuICAgICAgdGhpcy5kZXZpY2UkLnZhbHVlLFxuICAgICAgdGhpcy5jaGFuZ2VzJC52YWx1ZVxuICAgICk7XG4gICAgdGhpcy50cmFja09wZXJhdGlvbihvcGVyYXRpb24pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkT3BlcmF0aW9uKCkge1xuICAgIGNvbnN0IG9wZXJhdGlvbiA9IGF3YWl0IHRoaXMucmVwb3NpdG9yeS5nZXRMYXN0U29mdHdhcmVVcGRhdGVPcGVyYXRpb24odGhpcy5kZXZpY2VJZCk7XG4gICAgdGhpcy50cmFja09wZXJhdGlvbihvcGVyYXRpb24pO1xuICB9XG5cbiAgcHJpdmF0ZSB0cmFja09wZXJhdGlvbihvcGVyYXRpb246IElPcGVyYXRpb24pIHtcbiAgICB0aGlzLmNoYW5nZXNPcGVyYXRpb24kLm5leHQob3BlcmF0aW9uKTtcblxuICAgIGlmICh0aGlzLmlzSW5Qcm9ncmVzcyhvcGVyYXRpb24pKSB7XG4gICAgICB0aGlzLmRpc3BsYXlDaGFuZ2VzRnJvbU9wZXJhdGlvbihvcGVyYXRpb24pO1xuICAgICAgdGhpcy5yZXBvc2l0b3J5Lm9ic2VydmVPcGVyYXRpb24ob3BlcmF0aW9uKS5zdWJzY3JpYmUoXG4gICAgICAgIG9wZXJhdGlvblVwZGF0ZSA9PiB7XG4gICAgICAgICAgdGhpcy5jaGFuZ2VzT3BlcmF0aW9uJC5uZXh0KG9wZXJhdGlvblVwZGF0ZSk7XG4gICAgICAgICAgaWYgKG9wZXJhdGlvblVwZGF0ZS5zdGF0dXMgPT09IE9wZXJhdGlvblN0YXR1cy5TVUNDRVNTRlVMKSB7XG4gICAgICAgICAgICB0aGlzLmNsZWFyQ2hhbmdlcygpO1xuICAgICAgICAgICAgdGhpcy5sb2FkRGV2aWNlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBvcGVyYXRpb25VcGRhdGUgPT4ge1xuICAgICAgICAgIHRoaXMuY2hhbmdlc09wZXJhdGlvbiQubmV4dChvcGVyYXRpb25VcGRhdGUpO1xuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZGlzcGxheUNoYW5nZXNGcm9tT3BlcmF0aW9uKG9wZXJhdGlvbjogSU9wZXJhdGlvbikge1xuICAgIGNvbnN0IGNoYW5nZXMgPSB0aGlzLnJlcG9zaXRvcnkuZ2V0RGV2aWNlU29mdHdhcmVDaGFuZ2VzRnJvbU9wZXJhdGlvbihcbiAgICAgIG9wZXJhdGlvbixcbiAgICAgIHRoaXMuZGV2aWNlJC52YWx1ZVxuICAgICk7XG4gICAgdGhpcy5jaGFuZ2VzJC5uZXh0KGNoYW5nZXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0luUHJvZ3Jlc3Mob3BlcmF0aW9uOiBJT3BlcmF0aW9uKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIG9wZXJhdGlvbiAmJiBbT3BlcmF0aW9uU3RhdHVzLlBFTkRJTkcsIE9wZXJhdGlvblN0YXR1cy5FWEVDVVRJTkddLmluY2x1ZGVzKG9wZXJhdGlvbi5zdGF0dXMpXG4gICAgKTtcbiAgfVxufVxuIl19