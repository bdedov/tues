import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { AlertService } from '@c8y/ngx-components';
import { orderBy, isEqual, remove, some } from 'lodash-es';
import { InventoryService, IdReference } from '@c8y/client';
import { FetchClient, IFetchOptions } from '@c8y/client';
import { gettext } from '@c8y/ngx-components';
var ReportsService = /** @class */ (function () {
    function ReportsService(alertService, inventoryService, client) {
        this.alertService = alertService;
        this.inventoryService = inventoryService;
        this.client = client;
        this.ERROR_MESSAGES = {
            pattern_multiEmail: gettext('Invalid email addresses.'),
            pattern_singleEmail: gettext('Invalid email address.')
        };
        this.microserviceUrl = '/service/reporting/schedule';
        this.headers = { 'Content-Type': 'application/json' };
    }
    ReportsService.prototype.getExport = function (exportId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var exp, exportDetail, data, res;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.inventoryService.detail(exportId)];
                    case 1:
                        exportDetail = _a.sent();
                        data = exportDetail.data, res = exportDetail.res;
                        if (res.status !== 200) {
                            this.alertService.addServerFailure({ data: data, res: res });
                        }
                        else {
                            exp = data ? data : {};
                        }
                        return [2 /*return*/, exp];
                }
            });
        });
    };
    ReportsService.prototype.getScheduleList = function (exportId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var exp;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.getExport(exportId)];
                    case 1:
                        exp = _a.sent();
                        return [2 /*return*/, this.extractScheduleListFromExport(exp)];
                }
            });
        });
    };
    ReportsService.prototype.extractScheduleListFromExport = function (exp) {
        var scheduleList;
        if (exp) {
            scheduleList = exp.c8y_ScheduleConfiguration ? exp.c8y_ScheduleConfiguration : [];
        }
        return orderBy(scheduleList, ['timestamp'], ['desc']);
    };
    ReportsService.prototype.addSchedule = function (schedule, exportId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.updateSchedules(exportId, [], [schedule])];
                    case 1: return [2 /*return*/, _a.sent()];
                }
            });
        });
    };
    ReportsService.prototype.updateSchedule = function (oldSchedule, schedule, exportId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.updateSchedules(exportId, [oldSchedule], [schedule])];
                    case 1: return [2 /*return*/, _a.sent()];
                }
            });
        });
    };
    ReportsService.prototype.updateSchedules = function (exportId, schedulesToRemove, schedulesToAdd) {
        if (schedulesToRemove === void 0) { schedulesToRemove = []; }
        if (schedulesToAdd === void 0) { schedulesToAdd = []; }
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var success, exp, schedules, _a, data, res;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        success = false;
                        return [4 /*yield*/, this.getExport(exportId)];
                    case 1:
                        exp = _b.sent();
                        schedules = this.extractScheduleListFromExport(exp);
                        remove(schedules, function (schedule) {
                            return some(schedulesToRemove, function (scheduleToRemove) { return isEqual(schedule, scheduleToRemove); });
                        });
                        schedules.push.apply(schedules, schedulesToAdd);
                        exp.c8y_ScheduleConfiguration = schedules;
                        return [4 /*yield*/, this.inventoryService.update(exp)];
                    case 2:
                        _a = _b.sent(), data = _a.data, res = _a.res;
                        if (!(res.status === 200)) return [3 /*break*/, 4];
                        return [4 /*yield*/, this.reschedule(exportId)];
                    case 3:
                        success = _b.sent();
                        return [3 /*break*/, 5];
                    case 4:
                        this.alertService.addServerFailure({ data: data, res: res });
                        _b.label = 5;
                    case 5: return [2 /*return*/, success];
                }
            });
        });
    };
    ReportsService.prototype.reschedule = function (exportId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var options, rescheduling;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        options = {
                            method: 'PUT',
                            headers: this.headers
                        };
                        return [4 /*yield*/, this.client.fetch(this.microserviceUrl + "/" + exportId, options)];
                    case 1:
                        rescheduling = _a.sent();
                        return [2 /*return*/, rescheduling.status === 200];
                }
            });
        });
    };
    ReportsService.prototype.deleteSchedule = function (schedule, exportId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.updateSchedules(exportId, [schedule], [])];
                    case 1: return [2 /*return*/, _a.sent()];
                }
            });
        });
    };
    ReportsService.ctorParameters = function () { return [
        { type: AlertService },
        { type: InventoryService },
        { type: FetchClient }
    ]; };
    ReportsService = tslib_1.__decorate([
        Injectable()
    ], ReportsService);
    return ReportsService;
}());
export { ReportsService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3J0cy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9yZXBvcnRzLyIsInNvdXJjZXMiOlsicmVwb3J0cy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzNELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDNUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxhQUFhLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDekQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRzlDO0lBUUUsd0JBQ1UsWUFBMEIsRUFDMUIsZ0JBQWtDLEVBQ2xDLE1BQW1CO1FBRm5CLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsV0FBTSxHQUFOLE1BQU0sQ0FBYTtRQVY3QixtQkFBYyxHQUFHO1lBQ2Ysa0JBQWtCLEVBQUUsT0FBTyxDQUFDLDBCQUEwQixDQUFDO1lBQ3ZELG1CQUFtQixFQUFFLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQztTQUN2RCxDQUFDO1FBU0EsSUFBSSxDQUFDLGVBQWUsR0FBRyw2QkFBNkIsQ0FBQztRQUNyRCxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLENBQUM7SUFDeEQsQ0FBQztJQUVLLGtDQUFTLEdBQWYsVUFBZ0IsUUFBcUI7Ozs7OzRCQUVkLHFCQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQUE7O3dCQUEzRCxZQUFZLEdB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QXpDLE9BQU8sR0FBRyxTQUErQixDQUFDOzs7d0JBRTFDLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxJQUFJLE1BQUEsRUFBRSxHQUFHLEtBQUEsRUFBRSxDQUFDLENBQUM7OzRCQUdwRCxzQkFBTyxPQUFPLEVBQUM7Ozs7S0FDaEI7SUFFSyxtQ0FBVSxHQUFoQixVQUFpQixRQUFxQjs7Ozs7O3dCQUM5QixPQUFPLEdBQWtCOzRCQUM3QixNQUFNLEVBQUUsS0FBSzs0QkFDYixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87eUJBQ3RCLENBQUM7d0JBQ21CLHFCQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFJLElBQUksQ0FBQyxlQUFlLFNBQUksUUFBVSxFQUFFLE9BQU8sQ0FBQyxFQUFBOzt3QkFBdEYsWUFBWSxHQUFHLFNBQXVFO3dCQUM1RixzQkFBTyxZQUFZLENBQUMsTUFBTSxLQUFLLEdBQUcsRUFBQzs7OztLQUNwQztJQUVLLHVDQUFjLEdBQXBCLFVBQXFCLFFBQWtCLEVBQUUsUUFBcUI7Ozs7NEJBQ3JELHFCQUFNLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUE7NEJBQTNELHNCQUFPLFNBQW9ELEVBQUM7Ozs7S0FDN0Q7O2dCQTlFdUIsWUFBWTtnQkFDUixnQkFBZ0I7Z0JBQzFCLFdBQVc7O0lBWGxCLGNBQWM7UUFEMUIsVUFBVSxFQUFFO09BQ0EsY0FBYyxDQXdGMUI7SUFBRCxxQkFBQztDQUFBLEFBeEZELElBd0ZDO1NBeEZZLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBFeHBvcnQsIFNjaGVkdWxlIH0gZnJvbSAnLi9leHBvcnQtc2NoZWR1bGVzLmludGVyZmFjZSc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IG9yZGVyQnksIGlzRXF1YWwsIHJlbW92ZSwgc29tZSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBJbnZlbnRvcnlTZXJ2aWNlLCBJZFJlZmVyZW5jZSB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEZldGNoQ2xpZW50LCBJRmV0Y2hPcHRpb25zIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUmVwb3J0c1NlcnZpY2Uge1xuICBFUlJPUl9NRVNTQUdFUyA9IHtcbiAgICBwYXR0ZXJuX211bHRpRW1haWw6IGdldHRleHQoJ0ludmFsaWQgZW1haWwgYWRkcmVzc2VzLicpLFxuICAgIHBhdHRlcm5fc2luZ2xlRW1haWw6IGdldHRleHQoJ0ludmFsaWQgZW1haWwgYWRkcmVzcy4nKVxuICB9O1xuICBtaWNyb3NlcnZpY2VVcmw6IHN0cmluZztcbiAgaGVhZGVyczogYW55O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgY2xpZW50OiBGZXRjaENsaWVudFxuICApIHtcbiAgICB0aGlzLm1pY3Jvc2VydmljZVVybCA9ICcvc2VydmljZS9yZXBvcnRpbmcvc2NoZWR1bGUnO1xuICAgIHRoaXMuaGVhZGVycyA9IHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9O1xuICB9XG5cbiAgYXN5bmMgZ2V0RXhwb3J0KGV4cG9ydElkOiBJZFJlZmVyZW5jZSkge1xuICAgIGxldCBleHA6IEV4cG9ydDtcbiAgICBjb25zdCBleHBvcnREZXRhaWwgPSBhd2FpdCB0aGlzLmludmVudG9yeVNlcnZpY2UuZGV0YWlsKGV4cG9ydElkKTtcbiAgICBjb25zdCB7IGRhdGEsIHJlcyB9ID0gZXhwb3J0RGV0YWlsO1xuICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoeyBkYXRhLCByZXMgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGV4cCA9IGRhdGEgPyAoKGRhdGEgYXMgdW5rbm93bikgYXMgRXhwb3J0KSA6ICh7fSBhcyBFeHBvcnQpO1xuICAgIH1cblxuICAgIHJldHVybiBleHA7XG4gIH1cblxuICBhc3luYyBnZXRTY2hlZHVsZUxpc3QoZXhwb3J0SWQ6IElkUmVmZXJlbmNlKSB7XG4gICAgY29uc3QgZXhwID0gYXdhaXQgdGhpcy5nZXRFeHBvcnQoZXhwb3J0SWQpO1xuXG4gICAgcmV0dXJuIHRoaXMuZXh0cmFjdFNjaGVkdWxlTGlzdEZyb21FeHBvcnQoZXhwKTtcbiAgfVxuXG4gIGV4dHJhY3RTY2hlZHVsZUxpc3RGcm9tRXhwb3J0KGV4cDogRXhwb3J0KSB7XG4gICAgbGV0IHNjaGVkdWxlTGlzdDogU2NoZWR1bGVbXTtcbiAgICBpZiAoZXhwKSB7XG4gICAgICBzY2hlZHVsZUxpc3QgPSBleHAuYzh5X1NjaGVkdWxlQ29uZmlndXJhdGlvbiA/IGV4cC5jOHlfU2NoZWR1bGVDb25maWd1cmF0aW9uIDogW107XG4gICAgfVxuICAgIHJldHVybiBvcmRlckJ5KHNjaGVkdWxlTGlzdCwgWyd0aW1lc3RhbXAnXSwgWydkZXNjJ10pO1xuICB9XG5cbiAgYXN5bmMgYWRkU2NoZWR1bGUoc2NoZWR1bGU6IFNjaGVkdWxlLCBleHBvcnRJZDogSWRSZWZlcmVuY2UpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51cGRhdGVTY2hlZHVsZXMoZXhwb3J0SWQsIFtdLCBbc2NoZWR1bGVdKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVNjaGVkdWxlKG9sZFNjaGVkdWxlOiBTY2hlZHVsZSwgc2NoZWR1bGU6IFNjaGVkdWxlLCBleHBvcnRJZDogSWRSZWZlcmVuY2UpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51cGRhdGVTY2hlZHVsZXMoZXhwb3J0SWQsIFtvbGRTY2hlZHVsZV0sIFtzY2hlZHVsZV0pO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlU2NoZWR1bGVzKFxuICAgIGV4cG9ydElkOiBJZFJlZmVyZW5jZSxcbiAgICBzY2hlZHVsZXNUb1JlbW92ZTogU2NoZWR1bGVbXSA9IFtdLFxuICAgIHNjaGVkdWxlc1RvQWRkOiBTY2hlZHVsZVtdID0gW11cbiAgKSB7XG4gICAgbGV0IHN1Y2Nlc3M6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBjb25zdCBleHAgPSBhd2FpdCB0aGlzLmdldEV4cG9ydChleHBvcnRJZCk7XG4gICAgY29uc3Qgc2NoZWR1bGVzID0gdGhpcy5leHRyYWN0U2NoZWR1bGVMaXN0RnJvbUV4cG9ydChleHApO1xuXG4gICAgcmVtb3ZlKHNjaGVkdWxlcywgKHNjaGVkdWxlOiBTY2hlZHVsZSkgPT5cbiAgICAgIHNvbWUoc2NoZWR1bGVzVG9SZW1vdmUsIChzY2hlZHVsZVRvUmVtb3ZlOiBTY2hlZHVsZSkgPT4gaXNFcXVhbChzY2hlZHVsZSwgc2NoZWR1bGVUb1JlbW92ZSkpXG4gICAgKTtcbiAgICBzY2hlZHVsZXMucHVzaC5hcHBseShzY2hlZHVsZXMsIHNjaGVkdWxlc1RvQWRkKTtcbiAgICBleHAuYzh5X1NjaGVkdWxlQ29uZmlndXJhdGlvbiA9IHNjaGVkdWxlcztcbiAgICBjb25zdCB7IGRhdGEsIHJlcyB9ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLnVwZGF0ZShleHApO1xuICAgIGlmIChyZXMuc3RhdHVzID09PSAyMDApIHtcbiAgICAgIHN1Y2Nlc3MgPSBhd2FpdCB0aGlzLnJlc2NoZWR1bGUoZXhwb3J0SWQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKHsgZGF0YSwgcmVzIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBzdWNjZXNzO1xuICB9XG5cbiAgYXN5bmMgcmVzY2hlZHVsZShleHBvcnRJZDogSWRSZWZlcmVuY2UpIHtcbiAgICBjb25zdCBvcHRpb25zOiBJRmV0Y2hPcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnUFVUJyxcbiAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVyc1xuICAgIH07XG4gICAgY29uc3QgcmVzY2hlZHVsaW5nID0gYXdhaXQgdGhpcy5jbGllbnQuZmV0Y2goYCR7dGhpcy5taWNyb3NlcnZpY2VVcmx9LyR7ZXhwb3J0SWR9YCwgb3B0aW9ucyk7XG4gICAgcmV0dXJuIHJlc2NoZWR1bGluZy5zdGF0dXMgPT09IDIwMDtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNjaGVkdWxlKHNjaGVkdWxlOiBTY2hlZHVsZSwgZXhwb3J0SWQ6IElkUmVmZXJlbmNlKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudXBkYXRlU2NoZWR1bGVzKGV4cG9ydElkLCBbc2NoZWR1bGVdLCBbXSk7XG4gIH1cbn1cbiJdfQ==