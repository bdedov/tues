import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { IManagedObject, IOperation, IResultList, Realtime } from '@c8y/client';
import { ActivatedRoute } from '@angular/router';
import { pipe } from 'rxjs';
import { filter, map } from 'rxjs/operators';
import { DeviceProfileService } from '../device-profile.service';
import { AlertService, gettext, ManagedObjectRealtimeService } from '@c8y/ngx-components';
var DeviceTabProfileComponent = /** @class */ (function () {
    function DeviceTabProfileComponent(deviceRealtime, deviceProfileService, route, realtime, alertService) {
        this.deviceRealtime = deviceRealtime;
        this.deviceProfileService = deviceProfileService;
        this.route = route;
        this.realtime = realtime;
        this.alertService = alertService;
        this.firmwareItems = [];
        this.softwareItems = [];
        this.configurationItems = [];
        this.pattern = '';
        this.reloading = false;
    }
    DeviceTabProfileComponent.prototype.ngOnInit = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                this.device = this.route.snapshot.parent.data.contextData;
                this.getDeviceProfilesAndUpdateProfileItems();
                this.subscribeToManagedObjects();
                return [2 /*return*/];
            });
        });
    };
    DeviceTabProfileComponent.prototype.getDeviceProfilesAndUpdateProfileItems = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a, profileId_1, _b;
            return tslib_1.__generator(this, function (_c) {
                switch (_c.label) {
                    case 0:
                        this.reloading = true;
                        _a = this;
                        return [4 /*yield*/, this.deviceProfileService.getDeviceProfilesByDeviceType(this.device.type)];
                    case 1:
                        _a.deviceProfiles = _c.sent();
                        if (this.device.c8y_Profile) {
                            profileId_1 = this.device.c8y_Profile.profileId;
                            this.selectedProfile = this.deviceProfiles.data.find(function (mo) { return mo.id === profileId_1; });
                        }
                        this.updateProfileItems(this.device, this.selectedProfile);
                        _b = this;
                        return [4 /*yield*/, this.deviceProfileService.getProfileOperation(this.device.id)];
                    case 2:
                        _b.operation = _c.sent();
                        this.subscribeToOperations();
                        this.reloading = false;
                        return [2 /*return*/];
                }
            });
        });
    };
    DeviceTabProfileComponent.prototype.selectProfile = function (mo) {
        this.selectedProfile = mo;
        this.updateProfileItems(this.device, this.selectedProfile);
    };
    DeviceTabProfileComponent.prototype.createOperation = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        _a = this;
                        return [4 /*yield*/, this.deviceProfileService.createProfileOperation(this.device, this.selectedProfile)];
                    case 1:
                        _a.operation = _b.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    DeviceTabProfileComponent.prototype.setPipe = function (filterStr) {
        this.pattern = filterStr;
        this.filterPipe = pipe(map(function (data) {
            return data.filter(function (mo) { return mo.name && mo.name.toLowerCase().indexOf(filterStr.toLowerCase()) > -1; });
        }));
    };
    DeviceTabProfileComponent.prototype.ngOnDestroy = function () {
        this.operationsSubscription.unsubscribe();
        this.moOnUpdateSubscription.unsubscribe();
        this.moOnDeleteSubscription.unsubscribe();
    };
    DeviceTabProfileComponent.prototype.updateProfileItems = function (device, profile) {
        this.firmwareItems = this.deviceProfileService.getFirmwareItems(device, profile);
        this.softwareItems = this.deviceProfileService.getSoftwareItems(device, profile);
        this.configurationItems = this.deviceProfileService.getConfigurationItems(device, profile);
    };
    DeviceTabProfileComponent.prototype.subscribeToManagedObjects = function () {
        var _this = this;
        this.moOnUpdateSubscription = this.deviceRealtime
            .onUpdate$(this.device.id)
            .subscribe(function (managedObject) {
            _this.updateProfileItems(managedObject, _this.selectedProfile);
        });
        this.moOnDeleteSubscription = this.deviceRealtime.onDelete$(this.device.id).subscribe(function () {
            _this.alertService.danger(gettext('This device has just been deleted. You will be redirected to "All devices" page now.'));
            window.location.href = '#/device';
        });
    };
    DeviceTabProfileComponent.prototype.subscribeToOperations = function () {
        var _this = this;
        var operationsChannel = "/operations/" + this.device.id;
        this.operationsSubscription = this.realtime
            .observable(operationsChannel)
            .pipe(filter(function (_a) {
            var data = _a.data;
            return data.c8y_DeviceProfile;
        }))
            .subscribe(function (_a) {
            var data = _a.data;
            _this.operation = data;
        });
    };
    DeviceTabProfileComponent.ctorParameters = function () { return [
        { type: ManagedObjectRealtimeService },
        { type: DeviceProfileService },
        { type: ActivatedRoute },
        { type: Realtime },
        { type: AlertService }
    ]; };
    DeviceTabProfileComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-device-tab-profile',
            template: "<c8y-action-bar-item [placement]=\"'right'\">\n  <button class=\"btn btn-link\" title=\"{{ 'Reload' | translate }}\" (click)=\"getDeviceProfilesAndUpdateProfileItems()\">\n    <i c8yIcon=\"refresh\" [ngClass]=\"{ 'fa-spin': reloading }\"></i>\n    {{ 'Reload' | translate }}\n  </button>\n</c8y-action-bar-item>\n<c8y-action-bar-item [placement]=\"'right'\">\n  <c8y-realtime-btn [service]=\"deviceRealtime\"></c8y-realtime-btn>\n</c8y-action-bar-item>\n\n<div class=\"card card--grid--fullpage card--grid--fullpage card--grid grid__row--2-10--md\">\n  <div class=\"card--grid grid__col--6-6--md\">\n    <!-- AVAILABLE PROFILES -->\n    <div class=\"bg-white\">\n      <div class=\"card-header separator\">\n        <h4 class=\"card-title\" translate>Device profile</h4>\n      </div>\n      <div class=\"p-16\">\n        <form #deviceProfileForm=\"ngForm\">\n          <div class=\"input-group\">\n            <c8y-typeahead\n              class=\"flex-grow\"\n              name=\"selectProfile\"\n              [(ngModel)]=\"selectedProfile\"\n              placeholder=\"{{ 'Select device profile' | translate }}\"\n              (onSearch)=\"setPipe($event)\"\n              [allowFreeEntries]=\"false\"\n            >\n              <c8y-li\n                *c8yFor=\"let profile of deviceProfiles; pipe: filterPipe\"\n                class=\"p-l-8 p-r-8 c8y-list__item--link\"\n                (click)=\"selectProfile(profile); setPipe('')\"\n              >\n                <c8y-highlight\n                  [text]=\"profile.name || '&#45;&#45;'\"\n                  [pattern]=\"pattern\"\n                ></c8y-highlight>\n              </c8y-li>\n            </c8y-typeahead>\n            <div class=\"input-group-btn\">\n              <button\n                class=\"btn btn-primary\"\n                (click)=\"createOperation()\"\n                title=\"{{ 'Assign device profile' | translate }}\"\n                [disabled]=\"!selectedProfile?.id\"\n                translate\n              >\n                Assign device profile\n              </button>\n            </div>\n          </div>\n        </form>\n      </div>\n    </div>\n\n    <!-- INSTALL PROFILE OPERATION -->\n    <div class=\"bg-gray-white\">\n      <div class=\"card-header separator\">\n        <h4 class=\"card-title\" translate>Currently installed</h4>\n      </div>\n      <div class=\"card-block\">\n        <c8y-single-operation [operation]=\"operation\"></c8y-single-operation>\n      </div>\n    </div>\n  </div>\n  <div class=\"card--grid__inner-scroll flex-col no-align-items\">\n    <div class=\"d-contents\">\n      <!-- FIRMWARE -->\n      <c8y-device-tab-profile-detail\n        [sectionTitle]=\"'Firmware' | translate\"\n        [sectionIcon]=\"'c8y-firmware'\"\n        [emptyStateText]=\"'No firmware to display.' | translate\"\n        [emptyStateDetails]=\"'No firmware assigned.' | translate\"\n        [isProfileSelected]=\"!!selectedProfile\"\n        [items]=\"firmwareItems\"\n        [isEmpty]=\"!selectedProfile?.c8y_DeviceProfile?.firmware?.name\"\n        class=\"d-contents\"\n      ></c8y-device-tab-profile-detail>\n    </div>\n    <div class=\"d-contents\">\n      <!-- SOFTWARE -->\n      <c8y-device-tab-profile-detail\n        [sectionTitle]=\"'Software' | translate\"\n        [sectionIcon]=\"'c8y-tools'\"\n        [emptyStateText]=\"'No software to display.' | translate\"\n        [emptyStateDetails]=\"'No software assigned.' | translate\"\n        [isProfileSelected]=\"!!selectedProfile\"\n        [items]=\"softwareItems\"\n        [isEmpty]=\"\n          !selectedProfile?.c8y_DeviceProfile?.software ||\n          selectedProfile?.c8y_DeviceProfile?.software?.length === 0\n        \"\n        class=\"d-contents\"\n      ></c8y-device-tab-profile-detail>\n    </div>\n    <div class=\"d-contents\">\n      <!-- CONFIGURATION -->\n      <c8y-device-tab-profile-detail\n        [sectionTitle]=\"'Configuration' | translate\"\n        [sectionIcon]=\"'gears'\"\n        [emptyStateText]=\"'No configuration to display' | translate\"\n        [emptyStateDetails]=\"'No configuration assigned' | translate\"\n        [isProfileSelected]=\"!!selectedProfile\"\n        [items]=\"configurationItems\"\n        [isEmpty]=\"\n          !selectedProfile?.c8y_DeviceProfile?.configuration ||\n          selectedProfile?.c8y_DeviceProfile?.configuration?.length === 0\n        \"\n        [showTextLabel]=\"false\"\n        class=\"d-contents\"\n      ></c8y-device-tab-profile-detail>\n    </div>\n    <!-- fill in the remanining vertical space when empty -->\n    <div class=\"card--grid grid__col--6-6--md flex-grow\">\n      <div class=\"bg-white\"></div>\n      <div class=\"bg-gray-white\"></div>\n    </div>\n  </div>\n</div>\n",
            providers: [ManagedObjectRealtimeService]
        })
    ], DeviceTabProfileComponent);
    return DeviceTabProfileComponent;
}());
export { DeviceTabProfileComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLXRhYi1wcm9maWxlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvZGV2aWNlLXByb2ZpbGUvIiwic291cmNlcyI6WyJkZXZpY2UtdGFiLXByb2ZpbGUvZGV2aWNlLXRhYi1wcm9maWxlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBMkIsTUFBTSxlQUFlLENBQUM7QUFDbkUsT0FBTyxFQUFFLGNBQWMsRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNoRixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDakQsT0FBTyxFQUFFLElBQUksRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDMUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUVqRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBTzFGO0lBZ0JFLG1DQUNTLGNBQTRDLEVBQzNDLG9CQUEwQyxFQUMxQyxLQUFxQixFQUNyQixRQUFrQixFQUNsQixZQUEwQjtRQUozQixtQkFBYyxHQUFkLGNBQWMsQ0FBOEI7UUFDM0MseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQUMxQyxVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUNyQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBaEJwQyxrQkFBYSxHQUF1QixFQUFFLENBQUM7UUFDdkMsa0JBQWEsR0FBdUIsRUFBRSxDQUFDO1FBQ3ZDLHVCQUFrQixHQUF1QixFQUFFLENBQUM7UUFHNUMsWUFBTyxHQUFXLEVBQUUsQ0FBQztRQUNyQixjQUFTLEdBQVks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Q0FBQyxVQUFDLEVBQVE7Z0JBQU4sY0FBSTtZQUFPLE9BQUEsSUFBSSxDQUFDLGlCQUFpQjtRQUF0QixDQUFzQixDQUFDLENBQUM7YUFDbEQsU0FBUyxDQUFDLFVBQUMsRUFBUTtnQkFBTixjQUFJO1lBQ2hCLEtBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ3hCLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQzs7Z0JBbkZ3Qiw0QkFBNEI7Z0JBQ3JCLG9CQUFvQjtnQkFDbkMsY0FBYztnQkFDWCxRQUFRO2dCQUNKLFlBQVk7O0lBckJ6Qix5QkFBeUI7UUFMckMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLHdCQUF3QjtZQUNsQyxvcUpBQWtEO1lBQ2xELFNBQVMsRUFBRSxDQUFDLDRCQUE0QixDQUFDO1NBQzFDLENBQUM7T0FDVyx5QkFBeUIsQ0FxR3JDO0lBQUQsZ0NBQUM7Q0FBQSxBQXJHRCxJQXFHQztTQXJHWSx5QkFBeUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uRGVzdHJveSwgT25Jbml0LCBQaXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJTWFuYWdlZE9iamVjdCwgSU9wZXJhdGlvbiwgSVJlc3VsdExpc3QsIFJlYWx0aW1lIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgcGlwZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IERldmljZVByb2ZpbGVTZXJ2aWNlIH0gZnJvbSAnLi4vZGV2aWNlLXByb2ZpbGUuc2VydmljZSc7XG5pbXBvcnQgeyBEZXZpY2VQcm9maWxlLCBDb21wYXJpc29uUmVzdWx0IH0gZnJvbSAnLi4vZGV2aWNlLXByb2ZpbGUubW9kZWwnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlLCBnZXR0ZXh0LCBNYW5hZ2VkT2JqZWN0UmVhbHRpbWVTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1kZXZpY2UtdGFiLXByb2ZpbGUnLFxuICB0ZW1wbGF0ZVVybDogJy4vZGV2aWNlLXRhYi1wcm9maWxlLmNvbXBvbmVudC5odG1sJyxcbiAgcHJvdmlkZXJzOiBbTWFuYWdlZE9iamVjdFJlYWx0aW1lU2VydmljZV1cbn0pXG5leHBvcnQgY2xhc3MgRGV2aWNlVGFiUHJvZmlsZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgZGV2aWNlOiBJTWFuYWdlZE9iamVjdDtcbiAgZGV2aWNlUHJvZmlsZXM6IElSZXN1bHRMaXN0PElNYW5hZ2VkT2JqZWN0PjtcbiAgc2VsZWN0ZWRQcm9maWxlOiBQYXJ0aWFsPERldmljZVByb2ZpbGU+O1xuICBvcGVyYXRpb246IElPcGVyYXRpb247XG4gIGZpcm13YXJlSXRlbXM6IENvbXBhcmlzb25SZXN1bHRbXSA9IFtdO1xuICBzb2Z0d2FyZUl0ZW1zOiBDb21wYXJpc29uUmVzdWx0W10gPSBbXTtcbiAgY29uZmlndXJhdGlvbkl0ZW1zOiBDb21wYXJpc29uUmVzdWx0W10gPSBbXTtcblxuICBmaWx0ZXJQaXBlOiBQaXBlO1xuICBwYXR0ZXJuOiBzdHJpbmcgPSAnJztcbiAgcmVsb2FkaW5nOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgb3BlcmF0aW9uc1N1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICBwcml2YXRlIG1vT25EZWxldGVTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBtb09uVXBkYXRlU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGRldmljZVJlYWx0aW1lOiBNYW5hZ2VkT2JqZWN0UmVhbHRpbWVTZXJ2aWNlLFxuICAgIHByaXZhdGUgZGV2aWNlUHJvZmlsZVNlcnZpY2U6IERldmljZVByb2ZpbGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgcm91dGU6IEFjdGl2YXRlZFJvdXRlLFxuICAgIHByaXZhdGUgcmVhbHRpbWU6IFJlYWx0aW1lLFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2VcbiAgKSB7fVxuXG4gIGFzeW5jIG5nT25Jbml0KCkge1xuICAgIHRoaXMuZGV2aWNlID0gdGhpcy5yb3V0ZS5zbmFwc2hvdC5wYXJlbnQuZGF0YS5jb250ZXh0RGF0YTtcbiAgICB0aGlzLmdldERldmljZVByb2ZpbGVzQW5kVXBkYXRlUHJvZmlsZUl0ZW1zKCk7XG4gICAgdGhpcy5zdWJzY3JpYmVUb01hbmFnZWRPYmplY3RzKCk7XG4gIH1cblxuICBhc3luYyBnZXREZXZpY2VQcm9maWxlc0FuZFVwZGF0ZVByb2ZpbGVJdGVtcygpIHtcbiAgICB0aGlzLnJlbG9hZGluZyA9IHRydWU7XG4gICAgdGhpcy5kZXZpY2VQcm9maWxlcyA9IGF3YWl0IHRoaXMuZGV2aWNlUHJvZmlsZVNlcnZpY2UuZ2V0RGV2aWNlUHJvZmlsZXNCeURldmljZVR5cGUoXG4gICAgICB0aGlzLmRldmljZS50eXBlXG4gICAgKTtcbiAgICBpZiAodGhpcy5kZXZpY2UuYzh5X1Byb2ZpbGUpIHtcbiAgICAgIGNvbnN0IHByb2ZpbGVJZCA9IHRoaXMuZGV2aWNlLmM4eV9Qcm9maWxlLnByb2ZpbGVJZDtcbiAgICAgIHRoaXMuc2VsZWN0ZWRQcm9maWxlID0gdGhpcy5kZXZpY2VQcm9maWxlcy5kYXRhLmZpbmQobW8gPT4gbW8uaWQgPT09IHByb2ZpbGVJZCk7XG4gICAgfVxuICAgIHRoaXMudXBkYXRlUHJvZmlsZUl0ZW1zKHRoaXMuZGV2aWNlLCB0aGlzLnNlbGVjdGVkUHJvZmlsZSk7XG4gICAgdGhpcy5vcGVyYXRpb24gPSBhd2FpdCB0aGlzLmRldmljZVByb2ZpbGVTZXJ2aWNlLmdldFByb2ZpbGVPcGVyYXRpb24odGhpcy5kZXZpY2UuaWQpO1xuICAgIHRoaXMuc3Vic2NyaWJlVG9PcGVyYXRpb25zKCk7XG4gICAgdGhpcy5yZWxvYWRpbmcgPSBmYWxzZTtcbiAgfVxuXG4gIHNlbGVjdFByb2ZpbGUobW86IERldmljZVByb2ZpbGUpIHtcbiAgICB0aGlzLnNlbGVjdGVkUHJvZmlsZSA9IG1vO1xuICAgIHRoaXMudXBkYXRlUHJvZmlsZUl0ZW1zKHRoaXMuZGV2aWNlLCB0aGlzLnNlbGVjdGVkUHJvZmlsZSk7XG4gIH1cblxuICBhc3luYyBjcmVhdGVPcGVyYXRpb24oKSB7XG4gICAgdGhpcy5vcGVyYXRpb24gPSBhd2FpdCB0aGlzLmRldmljZVByb2ZpbGVTZXJ2aWNlLmNyZWF0ZVByb2ZpbGVPcGVyYXRpb24oXG4gICAgICB0aGlzLmRldmljZSxcbiAgICAgIHRoaXMuc2VsZWN0ZWRQcm9maWxlXG4gICAgKTtcbiAgfVxuXG4gIHNldFBpcGUoZmlsdGVyU3RyOiBzdHJpbmcpIHtcbiAgICB0aGlzLnBhdHRlcm4gPSBmaWx0ZXJTdHI7XG4gICAgdGhpcy5maWx0ZXJQaXBlID0gcGlwZShcbiAgICAgIG1hcCgoZGF0YTogYW55W10pID0+IHtcbiAgICAgICAgcmV0dXJuIGRhdGEuZmlsdGVyKFxuICAgICAgICAgIChtbzogYW55KSA9PiBtby5uYW1lICYmIG1vLm5hbWUudG9Mb3dlckNhc2UoKS5pbmRleE9mKGZpbHRlclN0ci50b0xvd2VyQ2FzZSgpKSA+IC0xXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLm9wZXJhdGlvbnNTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB0aGlzLm1vT25VcGRhdGVTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB0aGlzLm1vT25EZWxldGVTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIHVwZGF0ZVByb2ZpbGVJdGVtcyhkZXZpY2UsIHByb2ZpbGUpIHtcbiAgICB0aGlzLmZpcm13YXJlSXRlbXMgPSB0aGlzLmRldmljZVByb2ZpbGVTZXJ2aWNlLmdldEZpcm13YXJlSXRlbXMoZGV2aWNlLCBwcm9maWxlKTtcbiAgICB0aGlzLnNvZnR3YXJlSXRlbXMgPSB0aGlzLmRldmljZVByb2ZpbGVTZXJ2aWNlLmdldFNvZnR3YXJlSXRlbXMoZGV2aWNlLCBwcm9maWxlKTtcbiAgICB0aGlzLmNvbmZpZ3VyYXRpb25JdGVtcyA9IHRoaXMuZGV2aWNlUHJvZmlsZVNlcnZpY2UuZ2V0Q29uZmlndXJhdGlvbkl0ZW1zKGRldmljZSwgcHJvZmlsZSk7XG4gIH1cblxuICBwcml2YXRlIHN1YnNjcmliZVRvTWFuYWdlZE9iamVjdHMoKSB7XG4gICAgdGhpcy5tb09uVXBkYXRlU3Vic2NyaXB0aW9uID0gdGhpcy5kZXZpY2VSZWFsdGltZVxuICAgICAgLm9uVXBkYXRlJCh0aGlzLmRldmljZS5pZClcbiAgICAgIC5zdWJzY3JpYmUoKG1hbmFnZWRPYmplY3Q6IElNYW5hZ2VkT2JqZWN0KSA9PiB7XG4gICAgICAgIHRoaXMudXBkYXRlUHJvZmlsZUl0ZW1zKG1hbmFnZWRPYmplY3QsIHRoaXMuc2VsZWN0ZWRQcm9maWxlKTtcbiAgICAgIH0pO1xuICAgIHRoaXMubW9PbkRlbGV0ZVN1YnNjcmlwdGlvbiA9IHRoaXMuZGV2aWNlUmVhbHRpbWUub25EZWxldGUkKHRoaXMuZGV2aWNlLmlkKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuZGFuZ2VyKGdldHRleHQoJ1RoaXMgZGV2aWNlIGhhcyBqdXN0IGJlZW4gZGVsZXRlZC4gWW91IHdpbGwgYmUgcmVkaXJlY3RlZCB0byBcIkFsbCBkZXZpY2VzXCIgcGFnZSBub3cuJykpO1xuICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSAnIy9kZXZpY2UnO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzdWJzY3JpYmVUb09wZXJhdGlvbnMoKSB7XG4gICAgY29uc3Qgb3BlcmF0aW9uc0NoYW5uZWwgPSBgL29wZXJhdGlvbnMvJHt0aGlzLmRldmljZS5pZH1gO1xuICAgIHRoaXMub3BlcmF0aW9uc1N1YnNjcmlwdGlvbiA9IHRoaXMucmVhbHRpbWVcbiAgICAgIC5vYnNlcnZhYmxlKG9wZXJhdGlvbnNDaGFubmVsKVxuICAgICAgLnBpcGUoZmlsdGVyKCh7IGRhdGEgfSkgPT4gZGF0YS5jOHlfRGV2aWNlUHJvZmlsZSkpXG4gICAgICAuc3Vic2NyaWJlKCh7IGRhdGEgfSkgPT4ge1xuICAgICAgICB0aGlzLm9wZXJhdGlvbiA9IGRhdGE7XG4gICAgICB9KTtcbiAgfVxufVxuIl19