import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { IManagedObject, InventoryService, IOperation, IResultList, OperationService, OperationStatus, QueriesUtil } from '@c8y/client';
import { AlertService } from '@c8y/ngx-components';
import { sortBy, toArray, get } from 'lodash-es';
import { gettext } from '@c8y/ngx-components';
var DeviceProfileService = /** @class */ (function () {
    function DeviceProfileService(inventoryService, operationService, alertService) {
        this.inventoryService = inventoryService;
        this.operationService = operationService;
        this.alertService = alertService;
        this.dateFrom = new Date(0);
        this.dateTo = new Date(Date.now() + 86400000); // 1 day in the future
        this.NOT_INSTALLED_WARNING = gettext('Not installed on the device');
        this.VERSION_MISSMATCH_WARNING = gettext('Version mismatch');
        this.SAME_URL_WARNING = gettext('Url is the same');
        this.queriesUtil = new QueriesUtil();
    }
    DeviceProfileService.prototype.createDeviceProfile = function (deviceProfile) {
        return this.inventoryService.create(deviceProfile);
    };
    DeviceProfileService.prototype.getDeviceProfilesByDeviceType = function (deviceType) {
        var deviceTypeFilter = {
            __or: [{ 'c8y_Filter.type': deviceType }, { __not: { __has: 'c8y_Filter.type' } }]
        };
        return this.getDeviceProfiles(deviceTypeFilter);
    };
    DeviceProfileService.prototype.getDeviceProfiles = function (andQuery) {
        var query = {
            type: 'c8y_Profile'
        };
        var filter = {
            pageSize: 100,
            withTotalPages: true
        };
        query = this.queriesUtil.addAndFilter(query, andQuery || {});
        return this.inventoryService.listQuery(query, filter);
    };
    DeviceProfileService.prototype.getProfileOperation = function (deviceId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var filter, operation;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        filter = {
                            deviceId: deviceId,
                            fragmentType: 'c8y_DeviceProfile',
                            dateFrom: this.dateFrom.toISOString(),
                            dateTo: this.dateTo.toISOString(),
                            revert: true,
                            pageSize: 1
                        };
                        return [4 /*yield*/, this.operationService.list(filter)];
                    case 1:
                        operation = (_a.sent()).data[0];
                        return [2 /*return*/, operation && operation.status !== OperationStatus.SUCCESSFUL ? operation : undefined];
                }
            });
        });
    };
    DeviceProfileService.prototype.createProfileOperation = function (device, deviceProfile) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var operation, operationCfg, data, ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        operationCfg = {
                            deviceId: device.id,
                            profileId: deviceProfile.id,
                            profileName: deviceProfile.name,
                            c8y_DeviceProfile: deviceProfile.c8y_DeviceProfile,
                            description: "Assign device profile " + deviceProfile.name + " to device " + device.name
                        };
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 3, , 4]);
                        return [4 /*yield*/, this.operationService.create(operationCfg)];
                    case 2:
                        data = (_a.sent()).data;
                        operation = data;
                        return [3 /*break*/, 4];
                    case 3:
                        ex_1 = _a.sent();
                        this.alertService.addServerFailure(ex_1);
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/, operation];
                }
            });
        });
    };
    DeviceProfileService.prototype.getFirmwareItems = function (device, selectedProfile) {
        var deviceFirmware = device.c8y_Firmware;
        var profileFirmware = get(selectedProfile, 'c8y_DeviceProfile.firmware');
        var deviceItems = [];
        var profileItems = [];
        if (deviceFirmware) {
            deviceItems.push(deviceFirmware);
        }
        if (profileFirmware) {
            profileItems.push(profileFirmware);
        }
        return this.createProfileComparison(deviceItems, profileItems, 'name', 'version', this.getAlert('firmware'));
    };
    DeviceProfileService.prototype.getSoftwareItems = function (device, selectedProfile) {
        var deviceSoftware = device.c8y_SoftwareList;
        var profileSoftware = get(selectedProfile, 'c8y_DeviceProfile.software');
        return this.createProfileComparison(deviceSoftware, profileSoftware, 'name', 'version', this.getAlert('software'));
    };
    DeviceProfileService.prototype.getConfigurationItems = function (device, selectedProfile) {
        var deviceConfiguration = [];
        Object.keys(device).forEach(function (key) {
            if (key.slice(0, 18) === 'c8y_Configuration_') {
                deviceConfiguration.push(device[key]);
            }
        });
        var profileConfiguration = get(selectedProfile, 'c8y_DeviceProfile.configuration');
        return this.createProfileComparison(deviceConfiguration, profileConfiguration, 'url', 'type', this.getAlert('configuration'));
    };
    DeviceProfileService.prototype.getAlert = function (itemType) {
        var _this = this;
        var notInstalled = function (comparisionResult) {
            return !comparisionResult.device ? _this.NOT_INSTALLED_WARNING : '';
        };
        switch (itemType) {
            case 'firmware':
            case 'software':
                return function (comparisionResult) {
                    return comparisionResult.device && comparisionResult.profile && comparisionResult.device.itemDetails !== comparisionResult.profile.itemDetails ?
                        _this.VERSION_MISSMATCH_WARNING : notInstalled(comparisionResult);
                };
            case 'configuration':
                return function (comparisionResult) {
                    return comparisionResult.device && comparisionResult.profile &&
                        ((comparisionResult.device.itemName !== comparisionResult.profile.itemName) ||
                            (comparisionResult.device.itemDetails !== comparisionResult.profile.itemDetails)) ?
                        _this.SAME_URL_WARNING : notInstalled(comparisionResult);
                };
            default:
                return notInstalled;
        }
    };
    DeviceProfileService.prototype.createProfileComparison = function (deviceItems, profileItems, mergeByProperty, propertyNameWithDetails, getAlert) {
        if (deviceItems === void 0) { deviceItems = []; }
        if (profileItems === void 0) { profileItems = []; }
        var comparisonObj = this.createProfileComparisonFromDeviceItems(deviceItems, mergeByProperty, propertyNameWithDetails);
        var extendedComparisonObj = this.extendProfileComparisonWithProfileItems(comparisonObj, profileItems, mergeByProperty, propertyNameWithDetails, getAlert);
        return sortBy(toArray(extendedComparisonObj), 'name');
    };
    DeviceProfileService.prototype.createProfileComparisonFromDeviceItems = function (deviceItems, mergeByProperty, propertyNameWithDetails) {
        return deviceItems.reduce(function (comapritionItem, deviceItem) {
            var _a;
            return Object.assign(comapritionItem, (_a = {},
                _a[deviceItem[mergeByProperty]] = {
                    device: {
                        itemName: deviceItem.name,
                        itemDetails: deviceItem[propertyNameWithDetails],
                        itemUrl: deviceItem.url
                    },
                    profile: undefined,
                },
                _a));
        }, {});
    };
    DeviceProfileService.prototype.extendProfileComparisonWithProfileItems = function (comparisonObj, profileItems, mergeByProperty, propertyNameWithDetails, getAlert) {
        profileItems.forEach(function (profileItem) {
            var comparisionResult = {
                profile: {
                    itemName: profileItem.name,
                    itemDetails: profileItem[propertyNameWithDetails],
                    itemUrl: profileItem.url
                },
                device: comparisonObj[profileItem[mergeByProperty]] ? comparisonObj[profileItem[mergeByProperty]].device : undefined,
            };
            comparisionResult.comparisonAlert = getAlert(comparisionResult);
            comparisonObj[profileItem[mergeByProperty]] = comparisionResult;
        });
        return comparisonObj;
    };
    DeviceProfileService.ctorParameters = function () { return [
        { type: InventoryService },
        { type: OperationService },
        { type: AlertService }
    ]; };
    DeviceProfileService = tslib_1.__decorate([
        Injectable()
    ], DeviceProfileService);
    return DeviceProfileService;
}());
export { DeviceProfileService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLXByb2ZpbGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvZGV2aWNlLXByb2ZpbGUvIiwic291cmNlcyI6WyJkZXZpY2UtcHJvZmlsZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFDTCxjQUFjLEVBQ2QsZ0JBQWdCLEVBQ2hCLFVBQVUsRUFDVixXQUFXLEVBQ1gsZ0JBQWdCLEVBQ2hCLGVBQWUsRUFDZixXQUFXLEVBQ1osTUFBTSxhQUFhLENBQUM7QUFPckIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNqRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFHOUM7SUFTRSw4QkFDVSxnQkFBa0MsRUFDbEMsZ0JBQWtDLEVBQ2xDLFlBQTBCO1FBRjFCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQVgzQixhQUFRLEdBQUcsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkIsV0FBTSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLHNCQUFzQjtRQUdqRSwwQkFBcUIsR0FBRyxPQUFPLENBQUMsNkJBQTZCLENBQUMsQ0FBQztRQUMvRCw4QkFBeUIsR0FBRyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUN4RCxxQkFBZ0IsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQU9wRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksV0FB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LHVCQUErQixFQUMvQixRQUEyRDtRQUUzRCxZQUFZLENBQUMsT0FBTyxDQUFDLFVBQUEsV0FBVztZQUM5QixJQUFNLGlCQUFpQixHQUFxQjtnQkFDMUMsT0FBTyxFQUFFO29CQUNQLFFBQVEsRUFBRSxXQUFXLENBQUMsSUFBSTtvQkFDMUIsV0FBVyxFQUFFLFdBQVcsQ0FBQyx1QkFBdUIsQ0FBQztvQkFDakQsT0FBTyxFQUFFLFdBQVcsQ0FBQyxHQUFHO2lCQUN6QjtnQkFDRCxNQUFNLEVBQUUsYUFBYSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxTQUFTO2FBQ3JILENBQUM7WUFDRixpQkFBaUIsQ0FBQyxlQUFlLEdBQUcsUUFBUSxDQUFDLGlCQUFpQixDQUFDLENBQUM7WUFDaEUsYUFBYSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxHQUFHLGlCQUFpQixDQUFDO1FBQ2xFLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxhQUFhLENBQUM7SUFDdkIsQ0FBQzs7Z0JBMUwyQixnQkFBZ0I7Z0JBQ2hCLGdCQUFnQjtnQkFDcEIsWUFBWTs7SUFaekIsb0JBQW9CO1FBRGhDLFVBQVUsRUFBRTtPQUNBLG9CQUFvQixDQXFNaEM7SUFBRCwyQkFBQztDQUFBLEFBck1ELElBcU1DO1NBck1ZLG9CQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIElNYW5hZ2VkT2JqZWN0LFxuICBJbnZlbnRvcnlTZXJ2aWNlLFxuICBJT3BlcmF0aW9uLFxuICBJUmVzdWx0TGlzdCxcbiAgT3BlcmF0aW9uU2VydmljZSxcbiAgT3BlcmF0aW9uU3RhdHVzLFxuICBRdWVyaWVzVXRpbFxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQge1xuICBEZXZpY2VQcm9maWxlLFxuICBEZXZpY2VQcm9maWxlRmlybXdhcmUsXG4gIERldmljZVByb2ZpbGVTb2Z0d2FyZSxcbiAgQ29tcGFyaXNvblJlc3VsdFxufSBmcm9tICcuL2RldmljZS1wcm9maWxlLm1vZGVsJztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgc29ydEJ5LCB0b0FycmF5LCBnZXQgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRGV2aWNlUHJvZmlsZVNlcnZpY2Uge1xuICByZWFkb25seSBkYXRlRnJvbSA9IG5ldyBEYXRlKDApO1xuICByZWFkb25seSBkYXRlVG8gPSBuZXcgRGF0ZShEYXRlLm5vdygpICsgODY0MDAwMDApOyAvLyAxIGRheSBpbiB0aGUgZnV0dXJlXG4gIHByaXZhdGUgcXVlcmllc1V0aWw6IFF1ZXJpZXNVdGlsO1xuXG4gIHByaXZhdGUgTk9UX0lOU1RBTExFRF9XQVJOSU5HID0gZ2V0dGV4dCgnTm90IGluc3RhbGxlZCBvbiB0aGUgZGV2aWNlJyk7XG4gIHByaXZhdGUgVkVSU0lPTl9NSVNTTUFUQ0hfV0FSTklORyA9IGdldHRleHQoJ1ZlcnNpb24gbWlzbWF0Y2gnKTtcbiAgcHJpdmF0ZSBTQU1FX1VSTF9XQVJOSU5HID0gZ2V0dGV4dCgnVXJsIGlzIHRoZSBzYW1lJyk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgb3BlcmF0aW9uU2VydmljZTogT3BlcmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMucXVlcmllc1V0aWwgPSBuZXcgUXVlcmllc1V0aWwoKTtcbiAgfVxuXG4gIGNyZWF0ZURldmljZVByb2ZpbGUoZGV2aWNlUHJvZmlsZTogUGFydGlhbDxEZXZpY2VQcm9maWxlPikge1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeVNlcnZpY2UuY3JlYXRlKGRldmljZVByb2ZpbGUgYXMgSU1hbmFnZWRPYmplY3QpO1xuICB9XG5cbiAgZ2V0RGV2aWNlUHJvZmlsZXNCeURldmljZVR5cGUoZGV2aWNlVHlwZTogc3RyaW5nKTogUHJvbWlzZTxJUmVzdWx0TGlzdDxJTWFuYWdlZE9iamVjdD4+IHtcbiAgICBjb25zdCBkZXZpY2VUeXBlRmlsdGVyID0ge1xuICAgICAgX19vcjogW3sgJ2M4eV9GaWx0ZXIudHlwZSc6IGRldmljZVR5cGUgfSwgeyBfX25vdDogeyBfX2hhczogJ2M4eV9GaWx0ZXIudHlwZScgfSB9XVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuZ2V0RGV2aWNlUHJvZmlsZXMoZGV2aWNlVHlwZUZpbHRlcik7XG4gIH1cblxuICBnZXREZXZpY2VQcm9maWxlcyhhbmRRdWVyeT86IGFueSk6IFByb21pc2U8SVJlc3VsdExpc3Q8SU1hbmFnZWRPYmplY3Q+PiB7XG4gICAgbGV0IHF1ZXJ5OiBvYmplY3QgPSB7XG4gICAgICB0eXBlOiAnYzh5X1Byb2ZpbGUnXG4gICAgfTtcbiAgICBjb25zdCBmaWx0ZXI6IG9iamVjdCA9IHtcbiAgICAgIHBhZ2VTaXplOiAxMDAsXG4gICAgICB3aXRoVG90YWxQYWdlczogdHJ1ZVxuICAgIH07XG4gICAgcXVlcnkgPSB0aGlzLnF1ZXJpZXNVdGlsLmFkZEFuZEZpbHRlcihxdWVyeSwgYW5kUXVlcnkgfHwge30pO1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeVNlcnZpY2UubGlzdFF1ZXJ5KHF1ZXJ5LCBmaWx0ZXIpO1xuICB9XG5cbiAgYXN5bmMgZ2V0UHJvZmlsZU9wZXJhdGlvbihkZXZpY2VJZDogc3RyaW5nIHwgbnVtYmVyKSB7XG4gICAgY29uc3QgZmlsdGVyOiBvYmplY3QgPSB7XG4gICAgICBkZXZpY2VJZCxcbiAgICAgIGZyYWdtZW50VHlwZTogJ2M4eV9EZXZpY2VQcm9maWxlJyxcbiAgICAgIGRhdGVGcm9tOiB0aGlzLmRhdGVGcm9tLnRvSVNPU3RyaW5nKCksXG4gICAgICBkYXRlVG86IHRoaXMuZGF0ZVRvLnRvSVNPU3RyaW5nKCksXG4gICAgICByZXZlcnQ6IHRydWUsXG4gICAgICBwYWdlU2l6ZTogMVxuICAgIH07XG5cbiAgICBjb25zdCBvcGVyYXRpb24gPSAoYXdhaXQgdGhpcy5vcGVyYXRpb25TZXJ2aWNlLmxpc3QoZmlsdGVyKSkuZGF0YVswXTtcbiAgICByZXR1cm4gb3BlcmF0aW9uICYmIG9wZXJhdGlvbi5zdGF0dXMgIT09IE9wZXJhdGlvblN0YXR1cy5TVUNDRVNTRlVMID8gb3BlcmF0aW9uIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlUHJvZmlsZU9wZXJhdGlvbihkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LCBkZXZpY2VQcm9maWxlOiBQYXJ0aWFsPERldmljZVByb2ZpbGU+KSB7XG4gICAgbGV0IG9wZXJhdGlvbjtcbiAgICBjb25zdCBvcGVyYXRpb25DZmc6IElPcGVyYXRpb24gPSB7XG4gICAgICBkZXZpY2VJZDogZGV2aWNlLmlkLFxuICAgICAgcHJvZmlsZUlkOiBkZXZpY2VQcm9maWxlLmlkLFxuICAgICAgcHJvZmlsZU5hbWU6IGRldmljZVByb2ZpbGUubmFtZSxcbiAgICAgIGM4eV9EZXZpY2VQcm9maWxlOiBkZXZpY2VQcm9maWxlLmM4eV9EZXZpY2VQcm9maWxlLFxuICAgICAgZGVzY3JpcHRpb246IGBBc3NpZ24gZGV2aWNlIHByb2ZpbGUgJHtkZXZpY2VQcm9maWxlLm5hbWV9IHRvIGRldmljZSAke2RldmljZS5uYW1lfWBcbiAgICB9O1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMub3BlcmF0aW9uU2VydmljZS5jcmVhdGUob3BlcmF0aW9uQ2ZnKTtcbiAgICAgIG9wZXJhdGlvbiA9IGRhdGE7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoZXgpO1xuICAgIH1cbiAgICByZXR1cm4gb3BlcmF0aW9uO1xuICB9XG5cbiAgZ2V0RmlybXdhcmVJdGVtcyhcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LFxuICAgIHNlbGVjdGVkUHJvZmlsZTogUGFydGlhbDxEZXZpY2VQcm9maWxlPlxuICApOiBDb21wYXJpc29uUmVzdWx0W10ge1xuICAgIGNvbnN0IGRldmljZUZpcm13YXJlID0gZGV2aWNlLmM4eV9GaXJtd2FyZTtcbiAgICBjb25zdCBwcm9maWxlRmlybXdhcmUgPSBnZXQoc2VsZWN0ZWRQcm9maWxlLCAnYzh5X0RldmljZVByb2ZpbGUuZmlybXdhcmUnKTtcbiAgICBjb25zdCBkZXZpY2VJdGVtcyA9IFtdO1xuICAgIGNvbnN0IHByb2ZpbGVJdGVtcyA9IFtdO1xuXG4gICAgaWYgKGRldmljZUZpcm13YXJlKSB7XG4gICAgICBkZXZpY2VJdGVtcy5wdXNoKGRldmljZUZpcm13YXJlKTtcbiAgICB9XG4gICAgaWYgKHByb2ZpbGVGaXJtd2FyZSkge1xuICAgICAgcHJvZmlsZUl0ZW1zLnB1c2gocHJvZmlsZUZpcm13YXJlKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlUHJvZmlsZUNvbXBhcmlzb24oZGV2aWNlSXRlbXMsIHByb2ZpbGVJdGVtcywgJ25hbWUnLCAndmVyc2lvbicsIHRoaXMuZ2V0QWxlcnQoJ2Zpcm13YXJlJykpO1xuICB9XG5cbiAgZ2V0U29mdHdhcmVJdGVtcyhcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LFxuICAgIHNlbGVjdGVkUHJvZmlsZTogUGFydGlhbDxEZXZpY2VQcm9maWxlPlxuICApOiBDb21wYXJpc29uUmVzdWx0W10ge1xuICAgIGNvbnN0IGRldmljZVNvZnR3YXJlID0gZGV2aWNlLmM4eV9Tb2Z0d2FyZUxpc3Q7XG4gICAgY29uc3QgcHJvZmlsZVNvZnR3YXJlID0gZ2V0KHNlbGVjdGVkUHJvZmlsZSwgJ2M4eV9EZXZpY2VQcm9maWxlLnNvZnR3YXJlJyk7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlUHJvZmlsZUNvbXBhcmlzb24oZGV2aWNlU29mdHdhcmUsIHByb2ZpbGVTb2Z0d2FyZSwgJ25hbWUnLCAndmVyc2lvbicsIHRoaXMuZ2V0QWxlcnQoJ3NvZnR3YXJlJykpO1xuICB9XG5cbiAgZ2V0Q29uZmlndXJhdGlvbkl0ZW1zKFxuICAgIGRldmljZTogSU1hbmFnZWRPYmplY3QsXG4gICAgc2VsZWN0ZWRQcm9maWxlOiBQYXJ0aWFsPERldmljZVByb2ZpbGU+XG4gICk6IENvbXBhcmlzb25SZXN1bHRbXSB7XG4gICAgY29uc3QgZGV2aWNlQ29uZmlndXJhdGlvbiA9IFtdO1xuICAgIE9iamVjdC5rZXlzKGRldmljZSkuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgaWYgKGtleS5zbGljZSgwLCAxOCkgPT09ICdjOHlfQ29uZmlndXJhdGlvbl8nKSB7XG4gICAgICAgIGRldmljZUNvbmZpZ3VyYXRpb24ucHVzaChkZXZpY2Vba2V5XSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgY29uc3QgcHJvZmlsZUNvbmZpZ3VyYXRpb24gPSBnZXQoc2VsZWN0ZWRQcm9maWxlLCAnYzh5X0RldmljZVByb2ZpbGUuY29uZmlndXJhdGlvbicpO1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZVByb2ZpbGVDb21wYXJpc29uKGRldmljZUNvbmZpZ3VyYXRpb24sIHByb2ZpbGVDb25maWd1cmF0aW9uLCAndXJsJywgJ3R5cGUnLCB0aGlzLmdldEFsZXJ0KCdjb25maWd1cmF0aW9uJykpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRBbGVydChpdGVtVHlwZTogc3RyaW5nKTogKGNvbXBhcmlzaW9uUmVzdWx0OiBDb21wYXJpc29uUmVzdWx0KSA9PiBzdHJpbmcgIHtcbiAgICBjb25zdCBub3RJbnN0YWxsZWQgPSAoY29tcGFyaXNpb25SZXN1bHQ6IENvbXBhcmlzb25SZXN1bHQpID0+IHtcbiAgICAgIHJldHVybiAhY29tcGFyaXNpb25SZXN1bHQuZGV2aWNlID8gdGhpcy5OT1RfSU5TVEFMTEVEX1dBUk5JTkcgOiAnJztcbiAgICB9O1xuXG4gICAgc3dpdGNoIChpdGVtVHlwZSkge1xuICAgICAgY2FzZSAnZmlybXdhcmUnOlxuICAgICAgY2FzZSAnc29mdHdhcmUnOlxuICAgICAgICByZXR1cm4gKGNvbXBhcmlzaW9uUmVzdWx0OiBDb21wYXJpc29uUmVzdWx0KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGNvbXBhcmlzaW9uUmVzdWx0LmRldmljZSAmJiBjb21wYXJpc2lvblJlc3VsdC5wcm9maWxlICYmIGNvbXBhcmlzaW9uUmVzdWx0LmRldmljZS5pdGVtRGV0YWlscyAhPT0gY29tcGFyaXNpb25SZXN1bHQucHJvZmlsZS5pdGVtRGV0YWlscyA/XG4gICAgICAgICAgICB0aGlzLlZFUlNJT05fTUlTU01BVENIX1dBUk5JTkcgOiBub3RJbnN0YWxsZWQoY29tcGFyaXNpb25SZXN1bHQpO1xuICAgICAgICB9O1xuICAgICAgY2FzZSAnY29uZmlndXJhdGlvbic6XG4gICAgICAgIHJldHVybiAoY29tcGFyaXNpb25SZXN1bHQ6IENvbXBhcmlzb25SZXN1bHQpID0+IHtcbiAgICAgICAgICByZXR1cm4gY29tcGFyaXNpb25SZXN1bHQuZGV2aWNlICYmIGNvbXBhcmlzaW9uUmVzdWx0LnByb2ZpbGUgJiZcbiAgICAgICAgICAgICgoY29tcGFyaXNpb25SZXN1bHQuZGV2aWNlLml0ZW1OYW1lICE9PSBjb21wYXJpc2lvblJlc3VsdC5wcm9maWxlLml0ZW1OYW1lKSB8fFxuICAgICAgICAgICAgKGNvbXBhcmlzaW9uUmVzdWx0LmRldmljZS5pdGVtRGV0YWlscyAhPT0gY29tcGFyaXNpb25SZXN1bHQucHJvZmlsZS5pdGVtRGV0YWlscykpID9cbiAgICAgICAgICAgIHRoaXMuU0FNRV9VUkxfV0FSTklORyA6IG5vdEluc3RhbGxlZChjb21wYXJpc2lvblJlc3VsdCk7XG4gICAgICAgIH07XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gbm90SW5zdGFsbGVkO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUHJvZmlsZUNvbXBhcmlzb24oXG4gICAgZGV2aWNlSXRlbXM6IGFueVtdID0gW10sXG4gICAgcHJvZmlsZUl0ZW1zOiBBcnJheTxEZXZpY2VQcm9maWxlU29mdHdhcmUgfCBEZXZpY2VQcm9maWxlRmlybXdhcmU+ID0gW10sXG4gICAgbWVyZ2VCeVByb3BlcnR5OiBzdHJpbmcsXG4gICAgcHJvcGVydHlOYW1lV2l0aERldGFpbHM6IHN0cmluZyxcbiAgICBnZXRBbGVydDogKCBjb21wYXJpc2lvblJlc3VsdDogQ29tcGFyaXNvblJlc3VsdCApID0+IHN0cmluZ1xuICApOiBDb21wYXJpc29uUmVzdWx0W10ge1xuICAgIGNvbnN0IGNvbXBhcmlzb25PYmogPSB0aGlzLmNyZWF0ZVByb2ZpbGVDb21wYXJpc29uRnJvbURldmljZUl0ZW1zKGRldmljZUl0ZW1zLCBtZXJnZUJ5UHJvcGVydHksIHByb3BlcnR5TmFtZVdpdGhEZXRhaWxzKTtcbiAgICBjb25zdCBleHRlbmRlZENvbXBhcmlzb25PYmogPSB0aGlzLmV4dGVuZFByb2ZpbGVDb21wYXJpc29uV2l0aFByb2ZpbGVJdGVtcyhcbiAgICAgIGNvbXBhcmlzb25PYmosXG4gICAgICBwcm9maWxlSXRlbXMsXG4gICAgICBtZXJnZUJ5UHJvcGVydHksXG4gICAgICBwcm9wZXJ0eU5hbWVXaXRoRGV0YWlscyxcbiAgICAgIGdldEFsZXJ0XG4gICAgKTtcbiAgICByZXR1cm4gc29ydEJ5KHRvQXJyYXkoZXh0ZW5kZWRDb21wYXJpc29uT2JqKSwgJ25hbWUnKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUHJvZmlsZUNvbXBhcmlzb25Gcm9tRGV2aWNlSXRlbXMoXG4gICAgZGV2aWNlSXRlbXM6IGFueVtdLFxuICAgIG1lcmdlQnlQcm9wZXJ0eTogc3RyaW5nLFxuICAgIHByb3BlcnR5TmFtZVdpdGhEZXRhaWxzOiBzdHJpbmdcbiAgKTogYW55IHtcbiAgICByZXR1cm4gZGV2aWNlSXRlbXMucmVkdWNlKFxuICAgICAgKGNvbWFwcml0aW9uSXRlbSwgZGV2aWNlSXRlbSkgPT5cbiAgICAgICAgT2JqZWN0LmFzc2lnbihjb21hcHJpdGlvbkl0ZW0sIHtcbiAgICAgICAgICBbZGV2aWNlSXRlbVttZXJnZUJ5UHJvcGVydHldXToge1xuICAgICAgICAgICAgZGV2aWNlOiB7XG4gICAgICAgICAgICAgIGl0ZW1OYW1lOiBkZXZpY2VJdGVtLm5hbWUsXG4gICAgICAgICAgICAgIGl0ZW1EZXRhaWxzOiBkZXZpY2VJdGVtW3Byb3BlcnR5TmFtZVdpdGhEZXRhaWxzXSxcbiAgICAgICAgICAgICAgaXRlbVVybDogZGV2aWNlSXRlbS51cmxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwcm9maWxlOiB1bmRlZmluZWQsXG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgIHt9XG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZXh0ZW5kUHJvZmlsZUNvbXBhcmlzb25XaXRoUHJvZmlsZUl0ZW1zKFxuICAgIGNvbXBhcmlzb25PYmo6IG9iamVjdCxcbiAgICBwcm9maWxlSXRlbXM6IEFycmF5PERldmljZVByb2ZpbGVTb2Z0d2FyZSB8IERldmljZVByb2ZpbGVGaXJtd2FyZT4sXG4gICAgbWVyZ2VCeVByb3BlcnR5OiBzdHJpbmcsXG4gICAgcHJvcGVydHlOYW1lV2l0aERldGFpbHM6IHN0cmluZyxcbiAgICBnZXRBbGVydDogKCBjb21wYXJpc2lvblJlc3VsdDogQ29tcGFyaXNvblJlc3VsdCApID0+IHN0cmluZ1xuICApIHtcbiAgICBwcm9maWxlSXRlbXMuZm9yRWFjaChwcm9maWxlSXRlbSA9PiB7XG4gICAgICBjb25zdCBjb21wYXJpc2lvblJlc3VsdDogQ29tcGFyaXNvblJlc3VsdCA9IHtcbiAgICAgICAgcHJvZmlsZToge1xuICAgICAgICAgIGl0ZW1OYW1lOiBwcm9maWxlSXRlbS5uYW1lLFxuICAgICAgICAgIGl0ZW1EZXRhaWxzOiBwcm9maWxlSXRlbVtwcm9wZXJ0eU5hbWVXaXRoRGV0YWlsc10sXG4gICAgICAgICAgaXRlbVVybDogcHJvZmlsZUl0ZW0udXJsXG4gICAgICAgIH0sXG4gICAgICAgIGRldmljZTogY29tcGFyaXNvbk9ialtwcm9maWxlSXRlbVttZXJnZUJ5UHJvcGVydHldXSA/IGNvbXBhcmlzb25PYmpbcHJvZmlsZUl0ZW1bbWVyZ2VCeVByb3BlcnR5XV0uZGV2aWNlIDogdW5kZWZpbmVkLFxuICAgICAgfTtcbiAgICAgIGNvbXBhcmlzaW9uUmVzdWx0LmNvbXBhcmlzb25BbGVydCA9IGdldEFsZXJ0KGNvbXBhcmlzaW9uUmVzdWx0KTtcbiAgICAgIGNvbXBhcmlzb25PYmpbcHJvZmlsZUl0ZW1bbWVyZ2VCeVByb3BlcnR5XV0gPSBjb21wYXJpc2lvblJlc3VsdDtcbiAgICB9KTtcbiAgICByZXR1cm4gY29tcGFyaXNvbk9iajtcbiAgfVxufVxuIl19