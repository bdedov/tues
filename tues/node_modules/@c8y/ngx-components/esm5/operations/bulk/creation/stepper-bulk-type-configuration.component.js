import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { gettext } from '@c8y/ngx-components';
import { RepositoryService, RepositoryType } from '@c8y/ngx-components/repository';
import { TranslateService } from '@ngx-translate/core';
import { get, isEqual, uniqWith } from 'lodash-es';
import { BehaviorSubject, combineLatest, from } from 'rxjs';
import { debounceTime, distinctUntilChanged, shareReplay, switchMap } from 'rxjs/operators';
import { BaseStepperComponent } from '../base-stepper.component';
import { BulkOperationsService, OperationDetails } from '@c8y/ngx-components/operations/bulk-operations-service';
var StepperBulkTypeConfiguration = /** @class */ (function (_super) {
    tslib_1.__extends(StepperBulkTypeConfiguration, _super);
    function StepperBulkTypeConfiguration(bulkOperationService, repositoryService, translate) {
        var _this = _super.call(this) || this;
        _this.bulkOperationService = bulkOperationService;
        _this.repositoryService = repositoryService;
        _this.translate = translate;
        _this.NO_DEVICE_TYPE_AVAILABLE = gettext('Undefined`device type`');
        _this.elementCount = 0;
        _this.DD_LOW_COUNT = 10;
        _this.textFilter$ = new BehaviorSubject('');
        _this.configType$ = new BehaviorSubject('');
        _this.configTypes = [];
        _this.selectedConfigType = { name: '' };
        _this.configurations$ = combineLatest(_this.textFilter$, _this.configType$).pipe(switchMap(function (_a) {
            var _b = tslib_1.__read(_a, 2), name = _b[0], configType = _b[1];
            return _this.getConfiguration(name, configType);
        }), shareReplay(1));
        _this.DD_LOW_COUNT = _this.bulkOperationService.DD_LOW_COUNT;
        _this.loadConfigurationTypes();
        return _this;
    }
    StepperBulkTypeConfiguration.prototype.loadConfigurationTypes = function () {
        var _this = this;
        this.configTypeSubscription = this.configType$
            .pipe(debounceTime(300), distinctUntilChanged(), switchMap(function (searchStr) {
            var query = { configurationType: "*" + searchStr + "*" };
            return from(_this.repositoryService.listRepositoryEntries(RepositoryType.CONFIGURATION, { query: query }));
        }))
            .subscribe(function (result) {
            var data = result.data;
            _this.configTypes = uniqWith(data.map(function (val) { return ({ name: val.configurationType }); }), isEqual);
        });
    };
    StepperBulkTypeConfiguration.prototype.ngOnDestroy = function () {
        this.configTypeSubscription.unsubscribe();
    };
    StepperBulkTypeConfiguration.prototype.selectConfiguration = function (configuration) {
        this.selectedConfiguration = configuration;
    };
    StepperBulkTypeConfiguration.prototype.goToSecondStep = function ($event) {
        $event.stepper.next();
        this.getConfigBinary();
        this.deviceTypes = this.selectedConfiguration.deviceType;
    };
    StepperBulkTypeConfiguration.prototype.getConfigBinary = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        if (!this.selectedConfiguration.url) return [3 /*break*/, 2];
                        _a = this.selectedConfiguration;
                        return [4 /*yield*/, this.repositoryService.getBinaryText(this.selectedConfiguration.url, { allowExternal: true, noAlerts: true })];
                    case 1:
                        _a.binary = _b.sent();
                        _b.label = 2;
                    case 2: return [2 /*return*/];
                }
            });
        });
    };
    StepperBulkTypeConfiguration.prototype.getDeviceTypeTitle = function (configuration) {
        return get(configuration, 'deviceType', this.translate.instant(this.NO_DEVICE_TYPE_AVAILABLE));
    };
    StepperBulkTypeConfiguration.prototype.retrieveOperationPrototype = function () {
        var configuration = {
            type: this.selectedConfiguration.configurationType,
            url: this.selectedConfiguration.url
        };
        return {
            name: gettext('Configuration update'),
            description: get(this.selectedConfiguration, 'name'),
            prototype: {
                description: "Update configuration to: " + this.selectedConfiguration.name + ".",
                c8y_DownloadConfigFile: configuration
            }
        };
    };
    StepperBulkTypeConfiguration.prototype.getConfiguration = function (name, configurationType) {
        var query = name ? { name: "*" + name + "*" } : {};
        if (configurationType) {
            query.__or = [{ configurationType: configurationType }, { __not: { __has: "configurationType" } }];
        }
        return this.repositoryService.listRepositoryEntries(RepositoryType.CONFIGURATION, { query: query });
    };
    StepperBulkTypeConfiguration.ctorParameters = function () { return [
        { type: BulkOperationsService },
        { type: RepositoryService },
        { type: TranslateService }
    ]; };
    StepperBulkTypeConfiguration = tslib_1.__decorate([
        Component({
            selector: 'c8y-stepper-bulk-type-configuration',
            template: "<c8y-bulk-operation-stepper>\n  <ng-container\n    *customStep=\"\n      'Select configuration' | translate;\n      completed: !!selectedConfiguration;\n      buttonsDisabled: !selectedConfiguration;\n      onNext: goToSecondStep.bind(this)\"\n  >\n    <div class=\"card-block p-t-0 overflow-visible flex-no-shrink separator-bottom col-xs-12\">\n      <div class=\"row p-b-16\">\n        <div class=\"col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3\">\n          <h4 class=\"text-center m-b-16\">{{ 'Select configuration' | translate }}</h4>\n          <div class=\"row\">\n            <div class=\"col-md-6\">\n              <div class=\"input-group input-group-search\">\n                <input\n                  type=\"search\"\n                  class=\"form-control\"\n                  title=\"{{ 'Filter\u2026' | translate }}\"\n                  placeholder=\"{{ 'Filter\u2026' | translate }}\"\n                  [ngModel]=\"textFilter$ | async\"\n                  (ngModelChange)=\"textFilter$.next($event)\"\n                />\n                <span class=\"input-group-addon\">\n                  <i c8yIcon=\"filter\" *ngIf=\"(textFilter$ | async).length === 0\"></i>\n                  <i\n                    c8yIcon=\"times\"\n                    class=\"text-muted\"\n                    *ngIf=\"(textFilter$ | async).length > 0\"\n                    (click)=\"textFilter$.next('')\"\n                  ></i>\n                </span>\n              </div>\n            </div>\n            <div class=\"col-xs-12 p-b-8 visible-xs visible-sm\"></div>\n            <div class=\"col-md-6\">\n              <c8y-form-group class=\"m-0\">\n                <c8y-typeahead\n                  name=\"configType\"\n                  [(ngModel)]=\"selectedConfigType\"\n                  placeholder=\"{{ 'Type to filter configuration types\u2026' | translate }}\"\n                  (onSearch)=\"configType$.next($event)\"\n                >\n                  <c8y-li\n                    class=\"p-l-8 p-r-8 c8y-list__item--link\"\n                    (click)=\"selectedConfigType = { name: '' }; configType$.next('')\"\n                  >\n                    <span>{{ 'All configuration types' | translate }}</span>\n                  </c8y-li>\n                  <c8y-li\n                    *ngFor=\"let configType of configTypes\"\n                    class=\"p-l-8 p-r-8 c8y-list__item--link\"\n                    (click)=\"selectedConfigType = configType; configType$.next(configType.name)\"\n                    [active]=\"selectedConfigType === configType\"\n                  >\n                    <c8y-highlight\n                      [text]=\"configType.name\"\n                      [pattern]=\"configType$ | async\"\n                    ></c8y-highlight>\n                  </c8y-li>\n                </c8y-typeahead>\n              </c8y-form-group>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n    <div class=\"col-xs-12 flex-grow no-gutter\">\n      <div class=\"card-inner-scroll fit-v\">\n        <div class=\"card-block p-t-0 p-b-0\">\n          <c8y-list-group [ngClass]=\"{ 'dd-low': elementCount < DD_LOW_COUNT }\">\n            <c8y-li #listItem *c8yFor=\"let configuration of configurations$ | async\">\n              <c8y-li-radio (onSelect)=\"selectConfiguration(configuration)\"></c8y-li-radio>\n              <c8y-li-icon icon=\"gears\"></c8y-li-icon>\n              <c8y-li-body class=\"content-flex-60\">\n                <div class=\"col-5\">\n                  <div class=\"text-truncate\" title=\"{{ configuration.name || '-' }}\">\n                    <c8y-highlight\n                      [text]=\"configuration.name || '-'\"\n                      [pattern]=\"textFilter$ | async\"\n                    ></c8y-highlight>\n                  </div>\n                </div>\n                <div class=\"col-4\">\n                  <div\n                    class=\"text-truncate\"\n                    title=\"{{ 'Device type' | translate }}: {{ getDeviceTypeTitle(configuration) }}\"\n                  >\n                    <span translate class=\"text-label-small m-r-4\">Device type</span>\n                    {{ configuration.deviceType }}\n                    <em class=\"text-muted\" *ngIf=\"!configuration.deviceType\">\n                      {{ 'Undefined`device type`' | translate }}\n                    </em>\n                  </div>\n                </div>\n                <div class=\"col-3\">\n                  <span\n                    class=\"label label-info\"\n                    *ngIf=\"configuration.configurationType\"\n                    title=\"{{ 'Configuration type' | translate }}: {{\n                      configuration.configurationType\n                    }}\"\n                  >\n                    <c8y-highlight\n                      [text]=\"configuration.configurationType\"\n                      elementClass=\"text-gray-lighter\"\n                      [pattern]=\"configType$ | async\"\n                    ></c8y-highlight>\n                  </span>\n                  <span\n                    class=\"label label-default\"\n                    *ngIf=\"!configuration.configurationType\"\n                    title=\"{{ 'Configuration type' | translate }}: {{ 'Undefined' | translate }}\"\n                  >\n                    {{ 'Undefined' | translate }}\n                  </span>\n                </div>\n              </c8y-li-body>\n            </c8y-li>\n          </c8y-list-group>\n        </div>\n      </div>\n    </div>\n  </ng-container>\n  <ng-container *customStep=\"'Preview configuration' | translate\">\n    <div class=\"d-contents\">\n      <div class=\"card-block p-t-0 flex-no-shrink separator-bottom\">\n        <div class=\"row\">\n          <div class=\"col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3\">\n            <h4 class=\"text-center m-b-16\">\n              {{ 'Preview configuration' | translate }}\n            </h4>\n            <div class=\"row no-gutter\">\n              <div class=\"col-xs-6\">\n                <div class=\"text-right text-truncate\" title=\"{{ selectedConfiguration?.name }}\">\n                  <strong>{{ selectedConfiguration?.name }}</strong>\n                </div>\n                <span class=\"label label-primary\" *ngIf=\"selectedConfiguration?.configurationType\">\n                  {{ selectedConfiguration.configurationType }}\n                </span>\n                <span class=\"label label-default\" *ngIf=\"!selectedConfiguration?.configurationType\">\n                  {{ 'Undefined' | translate }}\n                </span>\n              </div>\n              <div class=\"col-xs-6 text-right\">\n                <div class=\"text-truncate\" title=\"{{ 'Device type' | translate }}: {{ getDeviceTypeTitle(selectedConfiguration) }}\">\n                  <span translate class=\"text-label-small m-r-4\">\n                    Device type\n                  </span>\n                  {{ selectedConfiguration?.deviceType }}\n                  <em class=\"text-muted\" *ngIf=\"!selectedConfiguration?.deviceType\" translate>\n                    Undefined`device type`\n                  </em>\n                </div>\n                <p>\n                  <span translate class=\"text-label-small m-r-4\">Updated</span>\n                  <small>{{ selectedConfiguration?.lastUpdated | c8yDate }}</small>\n                </p>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class=\"col-xs-12 flex-grow no-gutter\">\n        <div class=\"card-inner-scroll fit-v\">\n          <div class=\"card-block p-t-0\">\n            <div class=\"row\">\n              <div class=\"col-md-8 col-md-offset-2\">\n                <div class=\"legend form-block\" translate>Preview</div>\n                <div\n                  class=\"c8y-empty-state text-left\"\n                  *ngIf=\"!this.selectedConfiguration?.binary; else binaryPreview\"\n                >\n                  <h1 [c8yIcon]=\"'file-code-o'\"></h1>\n                  <p>\n                    <strong translate>No preview available.</strong><br />\n                    <small translate>Could not fetch the file.</small>\n                  </p>\n                </div>\n                <ng-template #binaryPreview>\n                  <pre\n                    style=\"min-height: 98px;\"\n                  ><code>{{ this.selectedConfiguration?.binary }}</code></pre>\n                </ng-template>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </ng-container>\n</c8y-bulk-operation-stepper>\n"
        })
    ], StepperBulkTypeConfiguration);
    return StepperBulkTypeConfiguration;
}(BaseStepperComponent));
export { StepperBulkTypeConfiguration };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RlcHBlci1idWxrLXR5cGUtY29uZmlndXJhdGlvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL29wZXJhdGlvbnMvIiwic291cmNlcyI6WyJidWxrL2NyZWF0aW9uL3N0ZXBwZXItYnVsay10eXBlLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTFDLE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsY0FBYyxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDbkYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ25ELE9BQU8sRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBNEIsTUFBTSxNQUFNLENBQUM7QUFDdEYsT0FBTyxFQUFFLFlBQVksRUFBRSxvQkFBb0IsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUYsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDakUsT0FBTyxFQUNMLHFCQUFxQixFQUNyQixnQkFBZ0IsRUFDakIsTUFBTSx3REFBd0QsQ0FBQztBQU1oRTtJQUFrRCx3REFBb0I7SUFrQnBFLHNDQUNVLG9CQUEyQyxFQUMzQyxpQkFBb0MsRUFDcEMsU0FBMkI7UUFIckMsWUFLRSxpQkFBTyxTQUdSO1FBUFMsMEJBQW9CLEdBQXBCLG9CQUFvQixDQUF1QjtRQUMzQyx1QkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLGVBQVMsR0FBVCxTQUFTLENBQWtCO1FBcEI1Qiw4QkFBd0IsR0FBRyxPQUFP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QkFBaUI7Z0JBQ3pCLGdCQUFnQjs7SUFyQjFCLDRCQUE0QjtRQUp4QyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUscUNBQXFDO1lBQy9DLHlnUkFBNkQ7U0FDOUQsQ0FBQztPQUNXLDRCQUE0QixDQStGeEM7SUFBRCxtQ0FBQztDQUFBLEFBL0ZELENBQWtELG9CQUFvQixHQStGckU7U0EvRlksNEJBQTRCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2RrU3RlcCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9zdGVwcGVyJztcbmltcG9ydCB7IENvbXBvbmVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSU1hbmFnZWRPYmplY3QsIElPcGVyYXRpb24sIElSZXN1bHRMaXN0IH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQzh5U3RlcHBlciwgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgUmVwb3NpdG9yeVNlcnZpY2UsIFJlcG9zaXRvcnlUeXBlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9yZXBvc2l0b3J5JztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IGdldCwgaXNFcXVhbCwgdW5pcVdpdGggfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBjb21iaW5lTGF0ZXN0LCBmcm9tLCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgZGlzdGluY3RVbnRpbENoYW5nZWQsIHNoYXJlUmVwbGF5LCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBCYXNlU3RlcHBlckNvbXBvbmVudCB9IGZyb20gJy4uL2Jhc2Utc3RlcHBlci5jb21wb25lbnQnO1xuaW1wb3J0IHtcbiAgQnVsa09wZXJhdGlvbnNTZXJ2aWNlLFxuICBPcGVyYXRpb25EZXRhaWxzXG59IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMvb3BlcmF0aW9ucy9idWxrLW9wZXJhdGlvbnMtc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1zdGVwcGVyLWJ1bGstdHlwZS1jb25maWd1cmF0aW9uJyxcbiAgdGVtcGxhdGVVcmw6ICdzdGVwcGVyLWJ1bGstdHlwZS1jb25maWd1cmF0aW9uLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBTdGVwcGVyQnVsa1R5cGVDb25maWd1cmF0aW9uIGV4dGVuZHMgQmFzZVN0ZXBwZXJDb21wb25lbnQge1xuICByZWFkb25seSBOT19ERVZJQ0VfVFlQRV9BVkFJTEFCTEUgPSBnZXR0ZXh0KCdVbmRlZmluZWRgZGV2aWNlIHR5cGVgJyk7XG4gIHNlbGVjdGVkQ29uZmlndXJhdGlvbjogSU1hbmFnZWRPYmplY3Q7XG4gIGVsZW1lbnRDb3VudDogbnVtYmVyID0gMDtcbiAgRERfTE9XX0NPVU5UOiBudW1iZXIgPSAxMDtcbiAgdGV4dEZpbHRlciQ6IEJlaGF2aW9yU3ViamVjdDxzdHJpbmc+ID0gbmV3IEJlaGF2aW9yU3ViamVjdCgnJyk7XG4gIGNvbmZpZ1R5cGUkOiBCZWhhdmlvclN1YmplY3Q8c3RyaW5nPiA9IG5ldyBCZWhhdmlvclN1YmplY3QoJycpO1xuICBjb25maWdUeXBlcyA9IFtdO1xuICBzZWxlY3RlZENvbmZpZ1R5cGUgPSB7IG5hbWU6ICcnIH07XG4gIGNvbmZpZ3VyYXRpb25zJDogT2JzZXJ2YWJsZTxJUmVzdWx0TGlzdDxJTWFuYWdlZE9iamVjdD4+ID0gY29tYmluZUxhdGVzdChcbiAgICB0aGlzLnRleHRGaWx0ZXIkLFxuICAgIHRoaXMuY29uZmlnVHlwZSRcbiAgKS5waXBlKFxuICAgIHN3aXRjaE1hcCgoW25hbWUsIGNvbmZpZ1R5cGVdKSA9PiB0aGlzLmdldENvbmZpZ3VyYXRpb24obmFtZSwgY29uZmlnVHlwZSkpLFxuICAgIHNoYXJlUmVwbGF5KDEpXG4gICk7XG4gIHByaXZhdGUgY29uZmlnVHlwZVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYnVsa09wZXJhdGlvblNlcnZpY2U6IEJ1bGtPcGVyYXRpb25zU2VydmljZSxcbiAgICBwcml2YXRlIHJlcG9zaXRvcnlTZXJ2aWNlOiBSZXBvc2l0b3J5U2VydmljZSxcbiAgICBwcml2YXRlIHRyYW5zbGF0ZTogVHJhbnNsYXRlU2VydmljZVxuICApIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuRERfTE9XX0NPVU5UID0gdGhpcy5idWxrT3BlcmF0aW9uU2VydmljZS5ERF9MT1dfQ09VTlQ7XG4gICAgdGhpcy5sb2FkQ29uZmlndXJhdGlvblR5cGVzKCk7XG4gIH1cblxuICBsb2FkQ29uZmlndXJhdGlvblR5cGVzKCkge1xuICAgIHRoaXMuY29uZmlnVHlwZVN1YnNjcmlwdGlvbiA9IHRoaXMuY29uZmlnVHlwZSRcbiAgICAgIC5waXBlKFxuICAgICAgICBkZWJvdW5jZVRpbWUoMzAwKSxcbiAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgICAgc3dpdGNoTWFwKHNlYXJjaFN0ciA9PiB7XG4gICAgICAgICAgY29uc3QgcXVlcnkgPSB7IGNvbmZpZ3VyYXRpb25UeXBlOiBgKiR7c2VhcmNoU3RyfSpgIH07XG4gICAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgICB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmxpc3RSZXBvc2l0b3J5RW50cmllcyhSZXBvc2l0b3J5VHlwZS5DT05GSUdVUkFUSU9OLCB7IHF1ZXJ5IH0pXG4gICAgICAgICAgKTtcbiAgICAgICAgfSlcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUocmVzdWx0ID0+IHtcbiAgICAgICAgY29uc3QgeyBkYXRhIH0gPSByZXN1bHQ7XG4gICAgICAgIHRoaXMuY29uZmlnVHlwZXMgPSB1bmlxV2l0aChkYXRhLm1hcCh2YWwgPT4gKHsgbmFtZTogdmFsLmNvbmZpZ3VyYXRpb25UeXBlIH0pKSwgaXNFcXVhbCk7XG4gICAgICB9KTtcbiAgfVxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmNvbmZpZ1R5cGVTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIHNlbGVjdENvbmZpZ3VyYXRpb24oY29uZmlndXJhdGlvbjogSU1hbmFnZWRPYmplY3QpIHtcbiAgICB0aGlzLnNlbGVjdGVkQ29uZmlndXJhdGlvbiA9IGNvbmZpZ3VyYXRpb247XG4gIH1cblxuICBnb1RvU2Vjb25kU3RlcCgkZXZlbnQ6IHsgc3RlcHBlcjogQzh5U3RlcHBlcjsgc3RlcDogQ2RrU3RlcCB9KSB7XG4gICAgJGV2ZW50LnN0ZXBwZXIubmV4dCgpO1xuICAgIHRoaXMuZ2V0Q29uZmlnQmluYXJ5KCk7XG4gICAgdGhpcy5kZXZpY2VUeXBlcyA9IHRoaXMuc2VsZWN0ZWRDb25maWd1cmF0aW9uLmRldmljZVR5cGU7XG4gIH1cblxuICBhc3luYyBnZXRDb25maWdCaW5hcnkoKSB7XG4gICAgaWYgKHRoaXMuc2VsZWN0ZWRDb25maWd1cmF0aW9uLnVybCkge1xuICAgICAgdGhpcy5zZWxlY3RlZENvbmZpZ3VyYXRpb24uYmluYXJ5ID0gYXdhaXQgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5nZXRCaW5hcnlUZXh0KFxuICAgICAgICB0aGlzLnNlbGVjdGVkQ29uZmlndXJhdGlvbi51cmwsXG4gICAgICAgIHsgYWxsb3dFeHRlcm5hbDogdHJ1ZSwgbm9BbGVydHM6IHRydWUgfVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBnZXREZXZpY2VUeXBlVGl0bGUoY29uZmlndXJhdGlvbjogSU1hbmFnZWRPYmplY3QpOiBzdHJpbmcge1xuICAgIHJldHVybiBnZXQoY29uZmlndXJhdGlvbiwgJ2RldmljZVR5cGUnLCB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KHRoaXMuTk9fREVWSUNFX1RZUEVfQVZBSUxBQkxFKSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgcmV0cmlldmVPcGVyYXRpb25Qcm90b3R5cGUoKTogT3BlcmF0aW9uRGV0YWlscyB7XG4gICAgY29uc3QgY29uZmlndXJhdGlvbiA9IHtcbiAgICAgIHR5cGU6IHRoaXMuc2VsZWN0ZWRDb25maWd1cmF0aW9uLmNvbmZpZ3VyYXRpb25UeXBlLFxuICAgICAgdXJsOiB0aGlzLnNlbGVjdGVkQ29uZmlndXJhdGlvbi51cmxcbiAgICB9O1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6IGdldHRleHQoJ0NvbmZpZ3VyYXRpb24gdXBkYXRlJyksXG4gICAgICBkZXNjcmlwdGlvbjogZ2V0KHRoaXMuc2VsZWN0ZWRDb25maWd1cmF0aW9uLCAnbmFtZScpLFxuICAgICAgcHJvdG90eXBlOiAoe1xuICAgICAgICBkZXNjcmlwdGlvbjogYFVwZGF0ZSBjb25maWd1cmF0aW9uIHRvOiAke3RoaXMuc2VsZWN0ZWRDb25maWd1cmF0aW9uLm5hbWV9LmAsXG4gICAgICAgIGM4eV9Eb3dubG9hZENvbmZpZ0ZpbGU6IGNvbmZpZ3VyYXRpb25cbiAgICAgIH0gYXMgdW5rbm93bikgYXMgSU9wZXJhdGlvblxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGdldENvbmZpZ3VyYXRpb24obmFtZT86IHN0cmluZywgY29uZmlndXJhdGlvblR5cGU/OiBzdHJpbmcpIHtcbiAgICBjb25zdCBxdWVyeTogYW55ID0gbmFtZSA/IHsgbmFtZTogYCoke25hbWV9KmAgfSA6IHt9O1xuICAgIGlmIChjb25maWd1cmF0aW9uVHlwZSkge1xuICAgICAgcXVlcnkuX19vciA9IFt7IGNvbmZpZ3VyYXRpb25UeXBlIH0sIHsgX19ub3Q6IHsgX19oYXM6IGBjb25maWd1cmF0aW9uVHlwZWAgfSB9XTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucmVwb3NpdG9yeVNlcnZpY2UubGlzdFJlcG9zaXRvcnlFbnRyaWVzKFJlcG9zaXRvcnlUeXBlLkNPTkZJR1VSQVRJT04sIHsgcXVlcnkgfSk7XG4gIH1cbn1cbiJdfQ==