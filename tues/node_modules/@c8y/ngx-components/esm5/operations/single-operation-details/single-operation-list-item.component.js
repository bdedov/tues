import * as tslib_1 from "tslib";
import { Component, Input, ViewChild } from '@angular/core';
import { Router } from '@angular/router';
import { assign, get } from 'lodash-es';
import { IOperation, OperationService, OperationStatus } from '@c8y/client';
import { AlertService, ListItemComponent, Tab, gettext, operationStatusClasses, operationStatusIcons } from '@c8y/ngx-components';
var SingleOperationListItemComponent = /** @class */ (function () {
    function SingleOperationListItemComponent(router, operationService, alertService) {
        this.router = router;
        this.operationService = operationService;
        this.alertService = alertService;
        this.collapsed = true;
        this.readOnly = false;
        this.tabs = [];
        this.statusIcons = operationStatusIcons;
        this.statusClasses = operationStatusClasses;
        this.OperationStatus = OperationStatus;
    }
    Object.defineProperty(SingleOperationListItemComponent.prototype, "displayedDescription", {
        get: function () {
            var commandText = get(this.operation, 'c8y_Command.text');
            var opDescription = get(this.operation, 'description');
            return commandText || opDescription || gettext('(no command text or description available)');
        },
        enumerable: true,
        configurable: true
    });
    SingleOperationListItemComponent.prototype.ngOnInit = function () {
        this.statusIcons = operationStatusIcons;
        this.statusClasses = operationStatusClasses;
        this.tabs = [
            {
                label: gettext('Details'),
                icon: 'asterisk',
                template: this.detailsTabTemplate
            },
            {
                label: gettext('History of changes'),
                icon: 'archive',
                template: this.historyOfChangesTabTemplate
            }
        ];
        this.selectedTab = this.tabs[0];
    };
    SingleOperationListItemComponent.prototype.scheduleAsBulkOperation = function () {
        this.router.navigateByUrl("/devicecontrol/single/create-bulk/" + this.operation.id);
    };
    SingleOperationListItemComponent.prototype.cancel = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var operationAfterUpdate, ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, this.operationService.update({
                                id: this.operation.id,
                                status: OperationStatus.FAILED,
                                failureReason: gettext('Operation cancelled by user.')
                            })];
                    case 1:
                        operationAfterUpdate = (_a.sent()).data;
                        assign(this.operation, operationAfterUpdate);
                        this.alertService.success(gettext('Operation cancelled.'));
                        return [3 /*break*/, 3];
                    case 2:
                        ex_1 = _a.sent();
                        this.alertService.addServerFailure(ex_1);
                        return [3 /*break*/, 3];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    SingleOperationListItemComponent.ctorParameters = function () { return [
        { type: Router },
        { type: OperationService },
        { type: AlertService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], SingleOperationListItemComponent.prototype, "operation", void 0);
    tslib_1.__decorate([
        Input()
    ], SingleOperationListItemComponent.prototype, "collapsed", void 0);
    tslib_1.__decorate([
        Input()
    ], SingleOperationListItemComponent.prototype, "readOnly", void 0);
    tslib_1.__decorate([
        ViewChild('listItem', { static: true })
    ], SingleOperationListItemComponent.prototype, "listItem", void 0);
    tslib_1.__decorate([
        ViewChild('details', { static: true })
    ], SingleOperationListItemComponent.prototype, "detailsTabTemplate", void 0);
    tslib_1.__decorate([
        ViewChild('historyOfChanges', { static: true })
    ], SingleOperationListItemComponent.prototype, "historyOfChangesTabTemplate", void 0);
    SingleOperationListItemComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-single-operation-list-item',
            template: "<c8y-li\n  class=\"c8y-list__item--double-actions\"\n  [ngClass]=\"{ 'c8y-list__item--no-expand': !collapsed }\"\n  [collapsed]=\"collapsed\"\n  #listItem\n  id=\"single-operation-{{ operation.id }}\"\n>\n  <c8y-li-icon>\n    <i [c8yIcon]=\"statusIcons[operation.status]\" [ngClass]=\"statusClasses[operation.status]\"></i>\n  </c8y-li-icon>\n  <div [ngClass]=\"{ 'content-flex-80': !readOnly, 'content-flex-50': readOnly }\">\n    <div class=\"col-6\">\n      <span class=\"text-truncate\" title=\"{{ displayedDescription | translate }}\">\n        {{ displayedDescription | translate }}\n      </span>\n    </div>\n    <div class=\"flex-grow\"></div>\n    <div class=\"col-3\">\n      <div class=\"m-r-16\">\n        <small class=\"icon-flex\">\n          <i c8yIcon=\"calendar\" class=\"m-r-4\"></i>\n          <span>\n            {{ operation.creationTime | c8yDate }}\n          </span>\n        </small>\n      </div>\n    </div>\n  </div>\n  <div class=\"c8y-list__item__footer\">\n    <div class=\"m-r-16\">\n      <small class=\"icon-flex\">\n        <i c8yIcon=\"exchange\" class=\"m-r-4\"></i>\n        <span>\n          <a href=\"#/device/{{ operation.deviceId }}\">{{ operation.deviceName }}</a>\n        </span>\n      </small>\n    </div>\n  </div>\n  <ng-container>\n    <c8y-li-action\n      label=\"{{ 'Schedule as bulk operation' | translate }}\"\n      (click)=\"scheduleAsBulkOperation()\"\n      icon=\"c8y-energy\"\n    >\n    </c8y-li-action>\n    <c8y-li-action\n      *ngIf=\"!readOnly && operation.status === OperationStatus.PENDING\"\n      label=\"{{ 'Cancel`operation`' | translate }}\"\n      (click)=\"cancel()\"\n      icon=\"times\"\n    >\n    </c8y-li-action>\n  </ng-container>\n  <c8y-li-collapse class=\"m-b-16\">\n    <div class=\"tabContainer\">\n      <ul class=\"nav nav-tabs nav-tabsc8y\">\n        <li [ngClass]=\"{ active: selectedTab === tab }\" *ngFor=\"let tab of tabs\">\n          <button [title]=\"tab.label | translate\" (click)=\"selectedTab = tab\" class=\"btn-clean\">\n            <i [c8yIcon]=\"tab.icon\"></i>\n            <span class=\"txt\">{{ tab.label | translate }}</span>\n          </button>\n        </li>\n      </ul>\n    </div>\n\n    <ng-container *ngTemplateOutlet=\"selectedTab.template\"></ng-container>\n\n    <ng-template #details>\n      <c8y-single-operation-details [operation]=\"operation\" [readOnly]=\"readOnly\">\n      </c8y-single-operation-details>\n    </ng-template>\n\n    <ng-template #historyOfChanges>\n      <c8y-audit-log [source]=\"operation.id\"></c8y-audit-log>\n    </ng-template>\n  </c8y-li-collapse>\n</c8y-li>\n"
        })
    ], SingleOperationListItemComponent);
    return SingleOperationListItemComponent;
}());
export { SingleOperationListItemComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2luZ2xlLW9wZXJhdGlvbi1saXN0LWl0ZW0uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9vcGVyYXRpb25zLyIsInNvdXJjZXMiOlsic2luZ2xlLW9wZXJhdGlvbi1kZXRhaWxzL3NpbmdsZS1vcGVyYXRpb24tbGlzdC1pdGVtLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQVUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN4QyxPQUFPLEVBQUUsVUFBVSxFQUFFLGdCQUFnQixFQUFFLGVBQWUsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUM1RSxPQUFPLEVBQ0wsWUFBWSxFQUNaLGlCQUFpQixFQUNqQixHQUFHLEVBQ0gsT0FBTyxFQUNQLHNCQUFzQixFQUN0QixvQkFBb0IsRUFDckIsTUFBTSxxQkFBcUIsQ0FBQztBQU03QjtJQXFCRSwwQ0FDVSxNQUFjLEVBQ2QsZ0JBQWtDLEVBQ2xDLFlBQTBCO1FBRjFCLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBdEIzQixjQUFTLEdBQVksSUFBSSxDQUFDO1FBQzFCLGFBQVEsR0FBWSxLQUFLLENBQUM7UUFNbkMsU0FBSSxHQUFVLEVBQUUsQ0FBQztRQUVqQixnQkFBVyxHQUFHLG9CQUFvQixDQUFDO1FBQ25DLGtCQUFhLEdBQUcsc0JBQXNCLENBQUM7UUFDdkMsb0JBQWUsR0FBRyxlQUFlLENBQUM7SUFZL0IsQ0FBQztJQVZKLHNCQUFJLGtFQUFvQjthQUF4QjtZQUNFLElBQU0sV0FBVyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLGtCQUFrQixDQUFDLENBQUM7WUFDNUQsSUFBTSxhQUFhLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsYUFBYSxDQUFDLENBQUM7WUFDekQsT0FBTyxXQUFXLElBQUksYUFBYSxJQUFJLE9BQU8sQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO1FBQy9GLENBQUM7OztPQUFBO0lBUUQsbURBQVEsR0FBUjtRQUNFLElBQUksQ0FBQyxXQUFXLEdBQUcsb0JBQW9CLENBQUM7UUFDeEMsSUFBSSxDQUFDLGFBQWEsR0FBRyxzQkFBc0IsQ0FBQztRQUU1QyxJQUFJLENBQUMsSUFBSSxHQUFHO1lBQ1Y7Z0JBQ0UsS0FBSyxFQUFFLE9BQU8sQ0FBQyxTQUFTLENBQUM7Z0JBQ3pCLElBQUksRUFBRSxVQUFVO2dCQUNoQixRQUFRLEVBQUUsSUFBSSxDQUFDLGtCQUFrQjthQUMzQjtZQUNSO2dCQUNFLEtBQUssRUFBRSxPQUFPLENBQUMsb0JBQW9CLENBQUM7Z0JBQ3BDLElBQUksRUFBRSxTQUFTO2dCQUNmLFFBQVEsRUFBRSxJQUFJLENBQUMsMkJBQTJCO2FBQ3BDO1NBQ1QsQ0FBQztRQUNGLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRUQsa0VBQXVCLEdBQXZCO1FBQ0UsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsdUNBQXFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBSSxDQUFDLENBQUM7SUFDdEYsQ0FBQztJQUVLLGlEQUFNLEdBQVo7Ozs7Ozs7d0JBRWtDLHFCQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUM7Z0NBQy9ELEVBQUUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUU7Z0NBQ3JCLE1BQU0sRUFBRSxlQUFlLENBQUMsTUFBTTtnQ0FDOUIsYUFBYSxFQUFFLE9BQU8sQ0FBQyw4QkFBOEIsQ0FBQzs2QkFDdkQsQ0FBQyxFQUFBOzt3QkFKSSxvQkFBb0IsR0FBRyxDQUFDLFNBSTVCLENBQUMsQ0FBQyxJQUFJO3dCQUNSLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLG9CQUFvQixDQUFDLENBQUM7d0JBQzdDLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUM7Ozs7d0JBRTNELElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsSUFBRSxDQUFDLENBQUM7Ozs7OztLQUUxQzs7Z0JBeENpQixNQUFNO2dCQUNJLGdCQUFnQjtnQkFDcEIsWUFBWTs7SUF2QjNCO1FBQVIsS0FBSyxFQUFFO3VFQUFnQztJQUMvQjtRQUFSLEtBQUssRUFBRTt1RUFBMkI7SUFDMUI7UUFBUixLQUFLLEVBQUU7c0VBQTJCO0lBRU07UUFBeEMsU0FBUyxDQUFDLFVBQVUsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQztzRUFBNkI7SUFDN0I7UUFBdkMsU0FBUyxDQUFDLFNBQVMsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQztnRkFBeUI7SUFDZjtRQUFoRCxTQUFTLENBQUMsa0JBQWtCLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUM7eUZBQWtDO0lBUHZFLGdDQUFnQztRQUo1QyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsZ0NBQWdDO1lBQzFDLGlrRkFBMEQ7U0FDM0QsQ0FBQztPQUNXLGdDQUFnQyxDQStENUM7SUFBRCx1Q0FBQztDQUFBLEFBL0RELElBK0RDO1NBL0RZLGdDQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE9uSW5pdCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgYXNzaWduLCBnZXQgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgSU9wZXJhdGlvbiwgT3BlcmF0aW9uU2VydmljZSwgT3BlcmF0aW9uU3RhdHVzIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHtcbiAgQWxlcnRTZXJ2aWNlLFxuICBMaXN0SXRlbUNvbXBvbmVudCxcbiAgVGFiLFxuICBnZXR0ZXh0LFxuICBvcGVyYXRpb25TdGF0dXNDbGFzc2VzLFxuICBvcGVyYXRpb25TdGF0dXNJY29uc1xufSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXNpbmdsZS1vcGVyYXRpb24tbGlzdC1pdGVtJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3NpbmdsZS1vcGVyYXRpb24tbGlzdC1pdGVtLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBTaW5nbGVPcGVyYXRpb25MaXN0SXRlbUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIEBJbnB1dCgpIG9wZXJhdGlvbjogUGFydGlhbDxJT3BlcmF0aW9uPjtcbiAgQElucHV0KCkgY29sbGFwc2VkOiBib29sZWFuID0gdHJ1ZTtcbiAgQElucHV0KCkgcmVhZE9ubHk6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBAVmlld0NoaWxkKCdsaXN0SXRlbScsIHsgc3RhdGljOiB0cnVlIH0pIGxpc3RJdGVtOiBMaXN0SXRlbUNvbXBvbmVudDtcbiAgQFZpZXdDaGlsZCgnZGV0YWlscycsIHsgc3RhdGljOiB0cnVlIH0pIGRldGFpbHNUYWJUZW1wbGF0ZTogYW55O1xuICBAVmlld0NoaWxkKCdoaXN0b3J5T2ZDaGFuZ2VzJywgeyBzdGF0aWM6IHRydWUgfSkgaGlzdG9yeU9mQ2hhbmdlc1RhYlRlbXBsYXRlOiBhbnk7XG5cbiAgdGFiczogVGFiW10gPSBbXTtcbiAgc2VsZWN0ZWRUYWI6IFRhYjtcbiAgc3RhdHVzSWNvbnMgPSBvcGVyYXRpb25TdGF0dXNJY29ucztcbiAgc3RhdHVzQ2xhc3NlcyA9IG9wZXJhdGlvblN0YXR1c0NsYXNzZXM7XG4gIE9wZXJhdGlvblN0YXR1cyA9IE9wZXJhdGlvblN0YXR1cztcblxuICBnZXQgZGlzcGxheWVkRGVzY3JpcHRpb24oKSB7XG4gICAgY29uc3QgY29tbWFuZFRleHQgPSBnZXQodGhpcy5vcGVyYXRpb24sICdjOHlfQ29tbWFuZC50ZXh0Jyk7XG4gICAgY29uc3Qgb3BEZXNjcmlwdGlvbiA9IGdldCh0aGlzLm9wZXJhdGlvbiwgJ2Rlc2NyaXB0aW9uJyk7XG4gICAgcmV0dXJuIGNvbW1hbmRUZXh0IHx8IG9wRGVzY3JpcHRpb24gfHwgZ2V0dGV4dCgnKG5vIGNvbW1hbmQgdGV4dCBvciBkZXNjcmlwdGlvbiBhdmFpbGFibGUpJyk7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgb3BlcmF0aW9uU2VydmljZTogT3BlcmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlXG4gICkge31cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnN0YXR1c0ljb25zID0gb3BlcmF0aW9uU3RhdHVzSWNvbnM7XG4gICAgdGhpcy5zdGF0dXNDbGFzc2VzID0gb3BlcmF0aW9uU3RhdHVzQ2xhc3NlcztcblxuICAgIHRoaXMudGFicyA9IFtcbiAgICAgIHtcbiAgICAgICAgbGFiZWw6IGdldHRleHQoJ0RldGFpbHMnKSxcbiAgICAgICAgaWNvbjogJ2FzdGVyaXNrJyxcbiAgICAgICAgdGVtcGxhdGU6IHRoaXMuZGV0YWlsc1RhYlRlbXBsYXRlXG4gICAgICB9IGFzIFRhYixcbiAgICAgIHtcbiAgICAgICAgbGFiZWw6IGdldHRleHQoJ0hpc3Rvcnkgb2YgY2hhbmdlcycpLFxuICAgICAgICBpY29uOiAnYXJjaGl2ZScsXG4gICAgICAgIHRlbXBsYXRlOiB0aGlzLmhpc3RvcnlPZkNoYW5nZXNUYWJUZW1wbGF0ZVxuICAgICAgfSBhcyBUYWJcbiAgICBdO1xuICAgIHRoaXMuc2VsZWN0ZWRUYWIgPSB0aGlzLnRhYnNbMF07XG4gIH1cblxuICBzY2hlZHVsZUFzQnVsa09wZXJhdGlvbigpIHtcbiAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKGAvZGV2aWNlY29udHJvbC9zaW5nbGUvY3JlYXRlLWJ1bGsvJHt0aGlzLm9wZXJhdGlvbi5pZH1gKTtcbiAgfVxuXG4gIGFzeW5jIGNhbmNlbCgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgb3BlcmF0aW9uQWZ0ZXJVcGRhdGUgPSAoYXdhaXQgdGhpcy5vcGVyYXRpb25TZXJ2aWNlLnVwZGF0ZSh7XG4gICAgICAgIGlkOiB0aGlzLm9wZXJhdGlvbi5pZCxcbiAgICAgICAgc3RhdHVzOiBPcGVyYXRpb25TdGF0dXMuRkFJTEVELFxuICAgICAgICBmYWlsdXJlUmVhc29uOiBnZXR0ZXh0KCdPcGVyYXRpb24gY2FuY2VsbGVkIGJ5IHVzZXIuJylcbiAgICAgIH0pKS5kYXRhO1xuICAgICAgYXNzaWduKHRoaXMub3BlcmF0aW9uLCBvcGVyYXRpb25BZnRlclVwZGF0ZSk7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5zdWNjZXNzKGdldHRleHQoJ09wZXJhdGlvbiBjYW5jZWxsZWQuJykpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGV4KTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==