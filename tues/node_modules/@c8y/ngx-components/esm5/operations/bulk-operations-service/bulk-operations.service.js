import * as tslib_1 from "tslib";
import { Location } from '@angular/common';
import { Inject, Injectable, InjectionToken } from '@angular/core';
import { has, isUndefined } from 'lodash-es';
import { Subject } from 'rxjs';
import { IdReference, IManagedObject, InventoryService, IOperation, IOperationBulk, IResult, OperationBulkService, OperationService } from '@c8y/client';
import { gettext } from '@c8y/ngx-components';
import { BulkOperationType } from './bulk-operation.model';
export var baseUrl = 'devicecontrol/bulk/creation/';
export var HOOK_LIST_BULK_TYPE = new InjectionToken('LIST_BULK_TYPE');
export var C8Y_BULK_TYPES = [
    {
        type: BulkOperationType.CONFIGURATION,
        c8yIcon: 'cogs',
        name: gettext('Configuration update'),
        path: baseUrl + "configuration",
        component: undefined,
        fragments: ['c8y_DownloadConfigFile', 'c8y_Configuration'],
        selected: false
    },
    {
        type: BulkOperationType.FIRMWARE,
        c8yIcon: 'c8y-firmware',
        name: gettext('Firmware update'),
        path: baseUrl + "firmware",
        component: undefined,
        fragments: ['c8y_Firmware'],
        selected: false
    },
    {
        type: BulkOperationType.SOFTWARE,
        c8yIcon: 'c8y-tools',
        name: gettext('Software update'),
        path: baseUrl + "software",
        component: undefined,
        fragments: ['c8y_SoftwareList', 'c8y_SoftwareUpdate'],
        selected: false
    },
    {
        type: BulkOperationType.DEVICE_PROFILE,
        c8yIcon: 'c8y-device-profile',
        name: gettext('Apply device profile'),
        path: baseUrl + "device-profile",
        component: undefined,
        fragments: ['c8y_DeviceProfile'],
        selected: false
    }
];
var ɵ0 = function (flattened, current) { return flattened.concat(current.fragments); };
export var C8Y_BULK_TYPE_FRAGMENTS = C8Y_BULK_TYPES.reduce(ɵ0, []);
var BulkOperationsService = /** @class */ (function () {
    function BulkOperationsService(operationBulkService, operationService, inventoryService, location, bulkTypes) {
        this.operationBulkService = operationBulkService;
        this.operationService = operationService;
        this.inventoryService = inventoryService;
        this.location = location;
        this.bulkTypes = bulkTypes;
        this.DD_LOW_COUNT = 10;
        this.firmwareId = new Subject();
        if (bulkTypes && bulkTypes.length > 0) {
            this.bulkTypes = bulkTypes.map(function (type) {
                if (isUndefined(type.selected)) {
                    type.selected = false;
                }
                return type;
            });
        }
    }
    BulkOperationsService.prototype.getBulkOperations = function (customFilter) {
        if (customFilter === void 0) { customFilter = {}; }
        var filter = tslib_1.__assign({ withTotalPages: true, withDeleted: true, pageSize: 50 }, customFilter);
        return this.operationBulkService.list(filter);
    };
    BulkOperationsService.prototype.getBulkOperationById = function (bulkOperationId) {
        return this.operationBulkService.detail(bulkOperationId);
    };
    BulkOperationsService.prototype.createBulkOperation = function (bulkOperation) {
        return this.operationBulkService.create(bulkOperation);
    };
    BulkOperationsService.prototype.deleteBulkOperation = function (bulkOperationId) {
        return this.operationBulkService.delete(bulkOperationId);
    };
    BulkOperationsService.prototype.updateBulkOperation = function (bulkOperation) {
        return this.operationBulkService.update(bulkOperation);
    };
    BulkOperationsService.prototype.getOperation = function (id) {
        return this.operationService.detail(id);
    };
    BulkOperationsService.prototype.returnToBulkOperationOverview = function () {
        this.location.back();
    };
    BulkOperationsService.prototype.setBulkTypes = function (list) {
        this.bulkTypes = list;
    };
    BulkOperationsService.prototype.getBulkTypes = function () {
        return this.bulkTypes;
    };
    BulkOperationsService.prototype.setFirmwareId = function (id) {
        this.firmwareId.next(id);
    };
    BulkOperationsService.prototype.createGroup = function (deviceQueryDataString) {
        var dynamicGroup = {
            name: 'Bulk operations group',
            type: 'c8y_DynamicGroup',
            c8y_IsDynamicGroup: { invisible: {} },
            c8y_DeviceQueryString: deviceQueryDataString
        };
        return this.inventoryService.create(dynamicGroup);
    };
    BulkOperationsService.prototype.scheduleBulkOperation = function (deviceQueryString, details) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var dynamicGroup, bulkOperation;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.createGroup(deviceQueryString)];
                    case 1:
                        dynamicGroup = _a.sent();
                        bulkOperation = {
                            groupId: dynamicGroup.data.id,
                            operationPrototype: details.prototype,
                            creationRamp: details.schedule.delayInSeconds,
                            startDate: details.schedule.scheduledDate.toISOString(),
                            note: details.note
                        };
                        return [4 /*yield*/, this.createBulkOperation(bulkOperation)];
                    case 2:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    BulkOperationsService.prototype.getSingleOperationsByStatus = function (status, bulkOperationId) {
        var filter = {
            withTotalPages: true,
            bulkOperationId: bulkOperationId,
            status: (status && status.toUpperCase()) || ''
        };
        return this.operationService.list(filter);
    };
    BulkOperationsService.prototype.createSingleOperation = function (operation) {
        return this.operationService.create(operation);
    };
    BulkOperationsService.prototype.updateSingleOperation = function (partialUpdateObject) {
        return this.operationService.update(partialUpdateObject);
    };
    BulkOperationsService.prototype.getManagedObject = function (deviceId) {
        return this.inventoryService.detail(deviceId);
    };
    BulkOperationsService.prototype.retrieveBulkOperationType = function (operation) {
        var type;
        C8Y_BULK_TYPES.some(function (t) {
            if (t.fragments.some(function (fragment) { return has(operation, fragment); })) {
                type = t.type;
                return true;
            }
        });
        return type;
    };
    BulkOperationsService.ctorParameters = function () { return [
        { type: OperationBulkService },
        { type: OperationService },
        { type: InventoryService },
        { type: Location },
        { type: Array, decorators: [{ type: Inject, args: [HOOK_LIST_BULK_TYPE,] }] }
    ]; };
    BulkOperationsService = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(4, Inject(HOOK_LIST_BULK_TYPE))
    ], BulkOperationsService);
    return BulkOperationsService;
}());
export { BulkOperationsService };
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL29wZXJhdGlvbnMvIiwic291cmNlcyI6WyJidWxrLW9wZXJhdGlvbnMtc2VydmljZS9idWxrLW9wZXJhdGlvbnMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUM3QyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRS9CLE9BQU8sRUFDTCxXQUFXLEVBQ1gsY0FBYyxFQUNkLGdCQUFnQixFQUNoQixVQUFVLEVBQ1YsY0FBYyxFQUNkLE9BQU8sRUFDUCxvQkFBb0IsRUFDcEIsZ0JBQWdCLEVBQ2pCLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUk5QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUUzRCxNQUFNLENBQUMsSUFBTSxPQUFPLEdBQUcsOEJBQThCLENBQUM7QUFDdEQsTUFBTSxDQUFDLElBQU0sbUJBQW1CLEdBQUcsSUFBSSxjQUFjLENBQWtCLGdCQUFnQixDQUFDLENBQUM7QUFDekYsTUFBTSxDQUFDLElBQU0sY0FBYyxHQUFvQjtJQUM3QztRQUNFLElBQUksRUFBRSxpQkFBaUIsQ0FBQyxhQUFhO1FBQ3JDLE9BQU8sRUFBRSxNQUFNO1FBQ2YsSUFBSSxFQUFFLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQztRQUNyQyxJQUFJLEVBQUssT0FBTyxrQkFBZTtRQUMvQixTQUFTLEVBQUUsU0FBUztRQUNwQixTQUFTLEVBQUUsQ0FBQyx3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LHlEQUF5QixHQUF6QixVQUEwQixTQUFxQjtRQUM3QyxJQUFJLElBQXVCLENBQUM7UUFFNUIsY0FBYyxDQUFDLElBQUksQ0FBQyxVQUFBLENBQUM7WUFDbkIsSUFBSSxDQUFDLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxVQUFBLFFBQVEsSUFBSSxPQUFBLEdBQUcsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLEVBQXhCLENBQXdCLENBQUMsRUFBRTtnQkFDMUQsSUFBSSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ2QsT0FBTyxJQUFJLENBQUM7YUFDYjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDOztnQkExSCtCLG9CQUFvQjtnQkFDeEIsZ0JBQWdCO2dCQUNoQixnQkFBZ0I7Z0JBQ3hCLFFBQVE7NENBRXpCLE1BQU0sU0FBQyxtQkFBbUI7O0lBVmxCLHFCQUFxQjtRQURqQyxVQUFVLEVBQUU7UUFXUixtQkFBQSxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQTtPQVZuQixxQkFBcUIsQ0FnSWpDO0lBQUQsNEJBQUM7Q0FBQSxBQWhJRCxJQWdJQztTQWhJWSxxQkFBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMb2NhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBoYXMsIGlzVW5kZWZpbmVkIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHtcbiAgSWRSZWZlcmVuY2UsXG4gIElNYW5hZ2VkT2JqZWN0LFxuICBJbnZlbnRvcnlTZXJ2aWNlLFxuICBJT3BlcmF0aW9uLFxuICBJT3BlcmF0aW9uQnVsayxcbiAgSVJlc3VsdCxcbiAgT3BlcmF0aW9uQnVsa1NlcnZpY2UsXG4gIE9wZXJhdGlvblNlcnZpY2Vcbn0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuXG5pbXBvcnQgeyBPcGVyYXRpb25EZXRhaWxzIH0gZnJvbSAnLi9vcGVyYXRpb24tZGV0YWlscy5tb2RlbCc7XG5pbXBvcnQgeyBPcGVyYXRpb25UeXBlIH0gZnJvbSAnLi9vcGVyYXRpb24tdHlwZS5tb2RlbCc7XG5pbXBvcnQgeyBCdWxrT3BlcmF0aW9uVHlwZSB9IGZyb20gJy4vYnVsay1vcGVyYXRpb24ubW9kZWwnO1xuXG5leHBvcnQgY29uc3QgYmFzZVVybCA9ICdkZXZpY2Vjb250cm9sL2J1bGsvY3JlYXRpb24vJztcbmV4cG9ydCBjb25zdCBIT09LX0xJU1RfQlVMS19UWVBFID0gbmV3IEluamVjdGlvblRva2VuPE9wZXJhdGlvblR5cGVbXT4oJ0xJU1RfQlVMS19UWVBFJyk7XG5leHBvcnQgY29uc3QgQzhZX0JVTEtfVFlQRVM6IE9wZXJhdGlvblR5cGVbXSA9IFtcbiAge1xuICAgIHR5cGU6IEJ1bGtPcGVyYXRpb25UeXBlLkNPTkZJR1VSQVRJT04sXG4gICAgYzh5SWNvbjogJ2NvZ3MnLFxuICAgIG5hbWU6IGdldHRleHQoJ0NvbmZpZ3VyYXRpb24gdXBkYXRlJyksXG4gICAgcGF0aDogYCR7YmFzZVVybH1jb25maWd1cmF0aW9uYCxcbiAgICBjb21wb25lbnQ6IHVuZGVmaW5lZCxcbiAgICBmcmFnbWVudHM6IFsnYzh5X0Rvd25sb2FkQ29uZmlnRmlsZScsICdjOHlfQ29uZmlndXJhdGlvbiddLFxuICAgIHNlbGVjdGVkOiBmYWxzZVxuICB9LFxuICB7XG4gICAgdHlwZTogQnVsa09wZXJhdGlvblR5cGUuRklSTVdBUkUsXG4gICAgYzh5SWNvbjogJ2M4eS1maXJtd2FyZScsXG4gICAgbmFtZTogZ2V0dGV4dCgnRmlybXdhcmUgdXBkYXRlJyksXG4gICAgcGF0aDogYCR7YmFzZVVybH1maXJtd2FyZWAsXG4gICAgY29tcG9uZW50OiB1bmRlZmluZWQsXG4gICAgZnJhZ21lbnRzOiBbJ2M4eV9GaXJtd2FyZSddLFxuICAgIHNlbGVjdGVkOiBmYWxzZVxuICB9LFxuICB7XG4gICAgdHlwZTogQnVsa09wZXJhdGlvblR5cGUuU09GVFdBUkUsXG4gICAgYzh5SWNvbjogJ2M4eS10b29scycsXG4gICAgbmFtZTogZ2V0dGV4dCgnU29mdHdhcmUgdXBkYXRlJyksXG4gICAgcGF0aDogYCR7YmFzZVVybH1zb2Z0d2FyZWAsXG4gICAgY29tcG9uZW50OiB1bmRlZmluZWQsXG4gICAgZnJhZ21lbnRzOiBbJ2M4eV9Tb2Z0d2FyZUxpc3QnLCAnYzh5X1NvZnR3YXJlVXBkYXRlJ10sXG4gICAgc2VsZWN0ZWQ6IGZhbHNlXG4gIH0sXG4gIHtcbiAgICB0eXBlOiBCdWxrT3BlcmF0aW9uVHlwZS5ERVZJQ0VfUFJPRklMRSxcbiAgICBjOHlJY29uOiAnYzh5LWRldmljZS1wcm9maWxlJyxcbiAgICBuYW1lOiBnZXR0ZXh0KCdBcHBseSBkZXZpY2UgcHJvZmlsZScpLFxuICAgIHBhdGg6IGAke2Jhc2VVcmx9ZGV2aWNlLXByb2ZpbGVgLFxuICAgIGNvbXBvbmVudDogdW5kZWZpbmVkLFxuICAgIGZyYWdtZW50czogWydjOHlfRGV2aWNlUHJvZmlsZSddLFxuICAgIHNlbGVjdGVkOiBmYWxzZVxuICB9XG5dO1xuZXhwb3J0IGNvbnN0IEM4WV9CVUxLX1RZUEVfRlJBR01FTlRTOiBzdHJpbmdbXSA9IEM4WV9CVUxLX1RZUEVTLnJlZHVjZShcbiAgKGZsYXR0ZW5lZCwgY3VycmVudCkgPT4gZmxhdHRlbmVkLmNvbmNhdChjdXJyZW50LmZyYWdtZW50cyksXG4gIFtdXG4pO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQnVsa09wZXJhdGlvbnNTZXJ2aWNlIHtcbiAgcmVhZG9ubHkgRERfTE9XX0NPVU5UOiBudW1iZXIgPSAxMDtcbiAgZmlybXdhcmVJZDogU3ViamVjdDxJZFJlZmVyZW5jZT4gPSBuZXcgU3ViamVjdDxJZFJlZmVyZW5jZT4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG9wZXJhdGlvbkJ1bGtTZXJ2aWNlOiBPcGVyYXRpb25CdWxrU2VydmljZSxcbiAgICBwcml2YXRlIG9wZXJhdGlvblNlcnZpY2U6IE9wZXJhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgbG9jYXRpb246IExvY2F0aW9uLFxuXG4gICAgQEluamVjdChIT09LX0xJU1RfQlVMS19UWVBFKSBwcml2YXRlIGJ1bGtUeXBlczogT3BlcmF0aW9uVHlwZVtdXG4gICkge1xuICAgIGlmIChidWxrVHlwZXMgJiYgYnVsa1R5cGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuYnVsa1R5cGVzID0gYnVsa1R5cGVzLm1hcCh0eXBlID0+IHtcbiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHR5cGUuc2VsZWN0ZWQpKSB7XG4gICAgICAgICAgdHlwZS5zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0eXBlO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0QnVsa09wZXJhdGlvbnMoY3VzdG9tRmlsdGVyID0ge30pIHtcbiAgICBjb25zdCBmaWx0ZXIgPSB7XG4gICAgICB3aXRoVG90YWxQYWdlczogdHJ1ZSxcbiAgICAgIHdpdGhEZWxldGVkOiB0cnVlLFxuICAgICAgcGFnZVNpemU6IDUwLFxuICAgICAgLi4uY3VzdG9tRmlsdGVyXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbkJ1bGtTZXJ2aWNlLmxpc3QoZmlsdGVyKTtcbiAgfVxuXG4gIGdldEJ1bGtPcGVyYXRpb25CeUlkKGJ1bGtPcGVyYXRpb25JZDogc3RyaW5nIHwgbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UuZGV0YWlsKGJ1bGtPcGVyYXRpb25JZCk7XG4gIH1cblxuICBjcmVhdGVCdWxrT3BlcmF0aW9uKGJ1bGtPcGVyYXRpb246IFBhcnRpYWw8SU9wZXJhdGlvbkJ1bGs+KSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UuY3JlYXRlKGJ1bGtPcGVyYXRpb24pO1xuICB9XG5cbiAgZGVsZXRlQnVsa09wZXJhdGlvbihidWxrT3BlcmF0aW9uSWQpIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS5kZWxldGUoYnVsa09wZXJhdGlvbklkKTtcbiAgfVxuXG4gIHVwZGF0ZUJ1bGtPcGVyYXRpb24oYnVsa09wZXJhdGlvbjogUGFydGlhbDxJT3BlcmF0aW9uQnVsaz4pIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS51cGRhdGUoYnVsa09wZXJhdGlvbik7XG4gIH1cblxuICBnZXRPcGVyYXRpb24oaWQ6IHN0cmluZyk6IFByb21pc2U8SVJlc3VsdDxJT3BlcmF0aW9uPj4ge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvblNlcnZpY2UuZGV0YWlsKGlkKTtcbiAgfVxuXG4gIHJldHVyblRvQnVsa09wZXJhdGlvbk92ZXJ2aWV3KCkge1xuICAgIHRoaXMubG9jYXRpb24uYmFjaygpO1xuICB9XG5cbiAgc2V0QnVsa1R5cGVzKGxpc3Q6IE9wZXJhdGlvblR5cGVbXSkge1xuICAgIHRoaXMuYnVsa1R5cGVzID0gbGlzdDtcbiAgfVxuXG4gIGdldEJ1bGtUeXBlcygpOiBPcGVyYXRpb25UeXBlW10ge1xuICAgIHJldHVybiB0aGlzLmJ1bGtUeXBlcztcbiAgfVxuXG4gIHNldEZpcm13YXJlSWQoaWQ6IElkUmVmZXJlbmNlKSB7XG4gICAgdGhpcy5maXJtd2FyZUlkLm5leHQoaWQpO1xuICB9XG5cbiAgY3JlYXRlR3JvdXAoZGV2aWNlUXVlcnlEYXRhU3RyaW5nOiBzdHJpbmcpIHtcbiAgICBjb25zdCBkeW5hbWljR3JvdXA6IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+ID0ge1xuICAgICAgbmFtZTogJ0J1bGsgb3BlcmF0aW9ucyBncm91cCcsXG4gICAgICB0eXBlOiAnYzh5X0R5bmFtaWNHcm91cCcsXG4gICAgICBjOHlfSXNEeW5hbWljR3JvdXA6IHsgaW52aXNpYmxlOiB7fSB9LFxuICAgICAgYzh5X0RldmljZVF1ZXJ5U3RyaW5nOiBkZXZpY2VRdWVyeURhdGFTdHJpbmdcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5U2VydmljZS5jcmVhdGUoZHluYW1pY0dyb3VwKTtcbiAgfVxuXG4gIGFzeW5jIHNjaGVkdWxlQnVsa09wZXJhdGlvbihkZXZpY2VRdWVyeVN0cmluZzogc3RyaW5nLCBkZXRhaWxzOiBPcGVyYXRpb25EZXRhaWxzKSB7XG4gICAgY29uc3QgZHluYW1pY0dyb3VwID0gYXdhaXQgdGhpcy5jcmVhdGVHcm91cChkZXZpY2VRdWVyeVN0cmluZyk7XG5cbiAgICBjb25zdCBidWxrT3BlcmF0aW9uOiBJT3BlcmF0aW9uQnVsayA9IHtcbiAgICAgIGdyb3VwSWQ6IGR5bmFtaWNHcm91cC5kYXRhLmlkLFxuICAgICAgb3BlcmF0aW9uUHJvdG90eXBlOiBkZXRhaWxzLnByb3RvdHlwZSxcbiAgICAgIGNyZWF0aW9uUmFtcDogZGV0YWlscy5zY2hlZHVsZS5kZWxheUluU2Vjb25kcyxcbiAgICAgIHN0YXJ0RGF0ZTogZGV0YWlscy5zY2hlZHVsZS5zY2hlZHVsZWREYXRlLnRvSVNPU3RyaW5nKCksXG4gICAgICBub3RlOiBkZXRhaWxzLm5vdGVcbiAgICB9O1xuXG4gICAgYXdhaXQgdGhpcy5jcmVhdGVCdWxrT3BlcmF0aW9uKGJ1bGtPcGVyYXRpb24pO1xuICB9XG5cbiAgZ2V0U2luZ2xlT3BlcmF0aW9uc0J5U3RhdHVzKHN0YXR1cywgYnVsa09wZXJhdGlvbklkKSB7XG4gICAgY29uc3QgZmlsdGVyID0ge1xuICAgICAgd2l0aFRvdGFsUGFnZXM6IHRydWUsXG4gICAgICBidWxrT3BlcmF0aW9uSWQsXG4gICAgICBzdGF0dXM6IChzdGF0dXMgJiYgc3RhdHVzLnRvVXBwZXJDYXNlKCkpIHx8ICcnXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvblNlcnZpY2UubGlzdChmaWx0ZXIpO1xuICB9XG5cbiAgY3JlYXRlU2luZ2xlT3BlcmF0aW9uKG9wZXJhdGlvbjogSU9wZXJhdGlvbikge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvblNlcnZpY2UuY3JlYXRlKG9wZXJhdGlvbik7XG4gIH1cblxuICB1cGRhdGVTaW5nbGVPcGVyYXRpb24ocGFydGlhbFVwZGF0ZU9iamVjdDogUGFydGlhbDxJT3BlcmF0aW9uPikge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvblNlcnZpY2UudXBkYXRlKHBhcnRpYWxVcGRhdGVPYmplY3QpO1xuICB9XG5cbiAgZ2V0TWFuYWdlZE9iamVjdChkZXZpY2VJZDogSWRSZWZlcmVuY2UpIHtcbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmRldGFpbChkZXZpY2VJZCk7XG4gIH1cblxuICByZXRyaWV2ZUJ1bGtPcGVyYXRpb25UeXBlKG9wZXJhdGlvbjogSU9wZXJhdGlvbik6IEJ1bGtPcGVyYXRpb25UeXBlIHtcbiAgICBsZXQgdHlwZTogQnVsa09wZXJhdGlvblR5cGU7XG5cbiAgICBDOFlfQlVMS19UWVBFUy5zb21lKHQgPT4ge1xuICAgICAgaWYgKHQuZnJhZ21lbnRzLnNvbWUoZnJhZ21lbnQgPT4gaGFzKG9wZXJhdGlvbiwgZnJhZ21lbnQpKSkge1xuICAgICAgICB0eXBlID0gdC50eXBlO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiB0eXBlO1xuICB9XG59XG4iXX0=