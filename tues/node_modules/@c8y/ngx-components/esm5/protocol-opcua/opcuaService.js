import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { FetchClient, IFetchOptions, InventoryService, InventoryBinaryService } from '@c8y/client';
import { Router } from '@angular/router';
import { AlertService } from '@c8y/ngx-components';
var OpcuaService = /** @class */ (function () {
    function OpcuaService(client, inventoryService, router, alertService) {
        this.client = client;
        this.inventoryService = inventoryService;
        this.router = router;
        this.alertService = alertService;
        this.microserviceUrl = '/service/opcua-mgmt-service/server';
        this.deviceTypeProtocolUrl = '/service/opcua-mgmt-service/deviceTypes';
        this.header = { 'Content-Type': 'application/json' };
        this.binaryService = inventoryService.binary;
    }
    OpcuaService.prototype.getServers = function (id) {
        if (id && id.length > 0) {
            var options = {
                method: 'GET',
                headers: this.header
            };
            return this.client.fetch(this.microserviceUrl + "/" + id, options);
        }
    };
    OpcuaService.prototype.createServer = function (data) {
        if (this.doesGatewayIdExist(data)) {
            this.cleanUpPayload(data);
            var options = {
                method: 'POST',
                headers: this.header,
                body: JSON.stringify(data)
            };
            return this.client.fetch("" + this.microserviceUrl, options);
        }
    };
    OpcuaService.prototype.updateServer = function (server) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var options, res, data, e_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!(this.doesGatewayIdExist(server) && this.doesIdExist(server))) return [3 /*break*/, 6];
                        this.cleanUpPayload(server);
                        options = {
                            method: 'POST',
                            headers: this.header,
                            body: JSON.stringify(server)
                        };
                        return [4 /*yield*/, this.client.fetch("" + this.microserviceUrl, options)];
                    case 1:
                        res = _a.sent();
                        data = void 0;
                        _a.label = 2;
                    case 2:
                        _a.trys.push([2, 4, , 5]);
                        return [4 /*yield*/, res.json()];
                    case 3:
                        data = _a.sent();
                        return [3 /*break*/, 5];
                    case 4:
                        e_1 = _a.sent();
                        return [3 /*break*/, 5];
                    case 5:
                        if (res.status !== 200) {
                            this.alertService.addServerFailure({ data: data, res: res });
                        }
                        else {
                            return [2 /*return*/, data];
                        }
                        _a.label = 6;
                    case 6: return [2 /*return*/];
                }
            });
        });
    };
    OpcuaService.prototype.removeServer = function (data) {
        if (this.doesGatewayIdExist(data) && this.doesIdExist(data)) {
            var options = {
                method: 'DELETE'
            };
            return this.client.fetch(this.microserviceUrl + "/" + data.gatewayId + "/" + data.id, options);
        }
    };
    OpcuaService.prototype.getKeystore = function (binaryId) {
        if (binaryId && binaryId.length > 0) {
            return this.inventoryService.detail(binaryId);
        }
        return null;
    };
    OpcuaService.prototype.uploadKeystore = function (file) {
        if (file && file.size > 0) {
            return this.binaryService.create(file);
        }
        return Promise.reject('Invalid file');
    };
    OpcuaService.prototype.updateKeystore = function (id, file) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var res;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!(id && id.length > 0 && file && file.size > 0)) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.removeKeystore(id)];
                    case 1:
                        res = (_a.sent()).res;
                        if (res && res.status === 204) {
                            return [2 /*return*/, this.uploadKeystore(file)];
                        }
                        _a.label = 2;
                    case 2: return [2 /*return*/, Promise.reject('Invalid file')];
                }
            });
        });
    };
    OpcuaService.prototype.removeKeystore = function (id) {
        if (id && id.length > 0) {
            return this.binaryService.delete(id);
        }
    };
    OpcuaService.prototype.getMoId = function () {
        var currentUrl = this.router.routerState.snapshot.url;
        var isDevice = new RegExp(/device\/\d+/).test(currentUrl);
        if (isDevice) {
            return currentUrl.match(/\d+/)[0];
        }
        return '';
    };
    OpcuaService.prototype.getId = function () {
        var currentUrl = this.router.routerState.snapshot.url;
        var isDeviceprotocol = new RegExp(/deviceprotocols/).test(currentUrl);
        if (isDeviceprotocol && RegExp(/\d+$/).test(currentUrl)) {
            return currentUrl.match(/\d+$/)[0];
        }
    };
    OpcuaService.prototype.getDeviceProtocol = function (id) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var options;
            return tslib_1.__generator(this, function (_a) {
                options = {
                    method: 'GET',
                    headers: this.header,
                };
                return [2 /*return*/, this.client.fetch(this.deviceTypeProtocolUrl + "/" + id, options)];
            });
        });
    };
    OpcuaService.prototype.updateDeviceProtocol = function (data) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var options;
            return tslib_1.__generator(this, function (_a) {
                options = {
                    method: 'PUT',
                    headers: this.header,
                    body: JSON.stringify(data)
                };
                return [2 /*return*/, this.client.fetch(this.deviceTypeProtocolUrl + "/" + data.id, options)];
            });
        });
    };
    OpcuaService.prototype.createDeviceProtocol = function (data) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var options;
            return tslib_1.__generator(this, function (_a) {
                options = {
                    method: 'POST',
                    headers: this.header,
                    body: JSON.stringify(data)
                };
                return [2 /*return*/, this.client.fetch("" + this.deviceTypeProtocolUrl, options)];
            });
        });
    };
    OpcuaService.prototype.doesGatewayIdExist = function (data) {
        return data && data.gatewayId && data.gatewayId.length > 0;
    };
    OpcuaService.prototype.doesIdExist = function (data) {
        return data && data.id && data.id.length > 0 && data.id !== 'new';
    };
    OpcuaService.prototype.cleanUpPayload = function (data) {
        if (data) {
            if (data.id && data.id === 'new') {
                delete data.id;
            }
            if (data.quickInfo) {
                delete data.quickInfo;
            }
        }
    };
    OpcuaService.ctorParameters = function () { return [
        { type: FetchClient },
        { type: InventoryService },
        { type: Router },
        { type: AlertService }
    ]; };
    OpcuaService = tslib_1.__decorate([
        Injectable()
    ], OpcuaService);
    return OpcuaService;
}());
export { OpcuaService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWFTZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9wcm90b2NvbC1vcGN1YS8iLCJzb3VyY2VzIjpbIm9wY3VhU2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxnQkFBZ0IsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUVuRyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBR25EO0lBTUUsc0JBQ1UsTUFBbUIsRUFDbkIsZ0JBQWtDLEVBQ2xDLE1BQWMsRUFDZCxZQUEwQjtRQUgxQixXQUFNLEdBQU4sTUFBTSxDQUFhO1FBQ25CLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBRWxDLElBQUksQ0FBQyxlQUFlLEdBQUcsb0NBQW9DLENBQUM7UUFDNUQsSUFBSSxDQUFDLHFCQUFxQixHQUFHLHlDQUF5QyxDQUFDO1FBQ3ZFLElBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQztRQUNyRCxJQUFJLENBQUMsYUFBYSxHQUFHLGdCQUFnQixDQUFDLE1BQU0sQ0FBQztJQUMvQyxDQUFDO0lBRUQsaUNBQVUsR0FBVixVQUFXLEVBQVU7UUFDbkIsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDdkIsSUFBTSxPQUFPLEdBQWtCO2dCQUM3QixNQUFNLEVBQUUsS0FBSztnQkFDYixPQUFPLEVBQUUsSUFBSSxDQUFDLE1BQU07YUFDckIsQ0FBQztZQUNGLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUksSUFBSSxDQUFDLGVBQWUsU0FBSSxFQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDcEU7SUFDSCxDQUFDO0lBRUQsbUNBQVksR0FBWixVQUFhLElBQWlCO1FBQzVCLElBQUksSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ2pDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDMUIsSUFBTSxPQUFPLEdBQWtCO2dCQUM3QixNQUFNLEVBQUUsTUFBTTtnQkFDZCxPQUFPLEVBQUUsSUFBSSxDQUFDLE1BQU07Z0JBQ3BCLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQzthQUMzQixDQUFDO1lBQ0YsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFHLElBQUksQ0FBQyxlQUFpQixFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQzlEO0lBQ0gsQ0FBQztJQUVLLG1DQUFZLEdBQWxCLFVBQW1CLE1BQW1COzs7Ozs7NkJBQ2hDLENBQUEsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUEsRUFBM0Qsd0JBQTJEO3dCQUM3RCxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO3dCQUN0QixPQUFPLEdBQWtCOzRCQUM3QixNQUFNLEVBQUUsTUFBTTs0QkFDZCxPQUFPLEVBQUUsSUFBSSxDQUFDLE1BQU07NEJBQ3BCLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQzt5QkFDN0IsQ0FBQzt3QkFDVSxxQkFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFHLElBQUksQ0FBQyxlQUFpQixFQUFFLE9BQU8sQ0FBQyxFQUFBOzt3QkFBakUsR0FBRyxHQUFHLFNBQTJEO3dCQUNuRSxJQUFJLFNBQUEsQ0FBQzs7Ozt3QkFFQSxxQkFBTSxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQUE7O3dCQUF2QixJQUFJLEdBQUcsU0FBZ0IsQ0FBQzs7Ozs7O3dCQUsxQixJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssR0FBRyxFQUFFOzRCQUN0QixJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsSUFBSSxNQUFBLEVBQUUsR0FBRyxLQUFBLEVBQUUsQ0FBQyxDQUFDO3lCQUNuRDs2QkFBTTs0QkFDTCxzQkFBTyxJQUFJLEVBQUM7eUJBQ2I7Ozs7OztLQUVKO0lBRUQsbUNBQVksR0FBWixVQUFhLElBQWlCO1FBQzVCLElBQUksSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDM0QsSUFBTSxPQUFPLEdBQWtCO2dCQUM3QixNQUFNLEVBQUUsUUFBUTthQUNqQixDQUFDO1lBQ0YsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBSSxJQUFJLENBQUMsZUFBZSxTQUFJLElBQUksQ0FBQyxTQUFTLFNBQUksSUFBSSxDQUFDLEVBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztTQUMzRjtJQUNILENBQUM7SUFFRCxrQ0FBVyxHQUFYLFVBQVksUUFBZ0I7UUFDMUIsSUFBSSxRQUFRLElBQUksUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDbkMsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQy9DO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQscUNBQWMsR0FBZCxVQUFlLElBQVU7UUFDdkIsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLEVBQUU7WUFDekIsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN4QztRQUNELE9BQU8sT0FBTyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRUsscUNBQWMsR0FBcEIsVUFBcUIsRUFBVSxFQUFFLElBQVU7Ozs7Ozs2QkFDckMsQ0FBQSxFQUFFLElBQUksRUFBRSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFBLEVBQTVDLHdCQUE0Qzt3QkFDOUIscUJBQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUMsRUFBQTs7d0JBQXJDLEdBQUcsR0FBSyxDQUFBLFNBQTZCLENBQUEsSUFBbEM7d0JBQ1gsSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7NEJBQzdCLHNCQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEVBQUM7eUJBQ2xDOzs0QkFFSCxzQkFBTyxPQUFPLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxFQUFDOzs7O0tBQ3ZDO0lBRUQscUNBQWMsR0FBZCxVQUFlLEVBQVU7UUFDdkIsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDdkIsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUN0QztJQUNILENBQUM7SUFFRCw4QkFBTyxHQUFQO1FBQ0UsSUFBTSxVQUFVLEdBQVcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQztRQUNoRSxJQUFNLFFBQVEsR0FBWSxJQUFJLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDckUsSUFBSSxRQUFRLEVBQUU7WUFDWixPQUFPLFVBQVUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDbkM7UUFDRCxPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7SUFFRCw0QkFBSyxHQUFMO1FBQ0UsSUFBTSxVQUFVLEdBQVcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQztRQUNoRSxJQUFNLGdCQUFnQixHQUFZLElBQUksTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ2pGLElBQUksZ0JBQWdCLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUN2RCxPQUFPLFVBQVUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDcEM7SUFDSCxDQUFDO0lBRUssd0NBQWlCLEdBQXZCLFVBQXdCLEVBQVU7Ozs7Z0JBQzFCLE9BQU8sR0FBa0I7b0JBQzdCLE1BQU0sRUFBRSxLQUFLO29CQUNiLE9BQU8sRUFBRSxJQUFJLENBQUMsTUFBTTtpQkFDbkIsQ0FBQztnQkFDSixzQkFBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBSSxJQUFJLENBQUMscUJBQXFCLFNBQUksRUFBSSxFQUFFLE9BQU8sQ0FBQyxFQUFDOzs7S0FFMUU7SUFFSywyQ0FBb0IsR0FBMUIsVUFBMkIsSUFBSTs7OztnQkFDdkIsT0FBTyxHQUFrQjtvQkFDN0IsTUFBTSxFQUFFLEtBQUs7b0JBQ2IsT0FBTyxFQUFFLElBQUksQ0FBQyxNQUFNO29CQUNwQixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7aUJBQzNCLENBQUM7Z0JBQ0Ysc0JBQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUksSUFBSSxDQUFDLHFCQUFxQixTQUFJLElBQUksQ0FBQyxFQUFJLEVBQUUsT0FBTyxDQUFDLEVBQUM7OztLQUUvRTtJQUVLLDJDQUFvQixHQUExQixVQUEyQixJQUFJOzs7O2dCQUN2QixPQUFPLEdBQWtCO29CQUM3QixNQUFNLEVBQUUsTUFBTTtvQkFDZCxPQUFPLEVBQUUsSUFBSSxDQUFDLE1BQU07b0JBQ3BCLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQztpQkFDM0IsQ0FBQztnQkFDRixzQkFBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFHLElBQUksQ0FBQyxxQkFBdUIsRUFBRSxPQUFPLENBQUMsRUFBQzs7O0tBQ3BFO0lBRU8seUNBQWtCLEdBQTFCLFVBQTJCLElBQWlCO1FBQzFDLE9BQU8sSUFBSSxJQUFJLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFTyxrQ0FBVyxHQUFuQixVQUFvQixJQUFpQjtRQUNuQyxPQUFPLElBQUksSUFBSSxJQUFJLENBQUMsRUFBRSxJQUFJLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsRUFBRSxLQUFLLEtBQUssQ0FBQztJQUNwRSxDQUFDO0lBRU8scUNBQWMsR0FBdEIsVUFBdUIsSUFBaUI7UUFDdEMsSUFBSSxJQUFJLEVBQUU7WUFDUixJQUFJLElBQUksQ0FBQyxFQUFFLElBQUksSUFBSSxDQUFDLEVBQUUsS0FBSyxLQUFLLEVBQUU7Z0JBQUUsT0FBTyxJQUFJLENBQUMsRUFBRSxDQUFDO2FBQUU7WUFDckQsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO2dCQUFFLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQzthQUFFO1NBQy9DO0lBQ0gsQ0FBQzs7Z0JBMUppQixXQUFXO2dCQUNELGdCQUFnQjtnQkFDMUIsTUFBTTtnQkFDQSxZQUFZOztJQVZ6QixZQUFZO1FBRHhCLFVBQVUsRUFBRTtPQUNBLFlBQVksQ0FrS3hCO0lBQUQsbUJBQUM7Q0FBQSxBQWxLRCxJQWtLQztTQWxLWSxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRmV0Y2hDbGllbnQsIElGZXRjaE9wdGlvbnMsIEludmVudG9yeVNlcnZpY2UsIEludmVudG9yeUJpbmFyeVNlcnZpY2UgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBPcGN1YVNlcnZlciB9IGZyb20gJy4vb3BjdWEtc2VydmVyLmludGVyZmFjZSc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBPcGN1YVNlcnZpY2Uge1xuICBwcml2YXRlIGJpbmFyeVNlcnZpY2U6IEludmVudG9yeUJpbmFyeVNlcnZpY2U7XG4gIHByaXZhdGUgbWljcm9zZXJ2aWNlVXJsOiBzdHJpbmc7XG4gIHByaXZhdGUgZGV2aWNlVHlwZVByb3RvY29sVXJsOiBzdHJpbmc7XG4gIHByaXZhdGUgaGVhZGVyOiBhbnk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjbGllbnQ6IEZldGNoQ2xpZW50LFxuICAgIHByaXZhdGUgaW52ZW50b3J5U2VydmljZTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2VcbiAgICApIHtcbiAgICB0aGlzLm1pY3Jvc2VydmljZVVybCA9ICcvc2VydmljZS9vcGN1YS1tZ210LXNlcnZpY2Uvc2VydmVyJztcbiAgICB0aGlzLmRldmljZVR5cGVQcm90b2NvbFVybCA9ICcvc2VydmljZS9vcGN1YS1tZ210LXNlcnZpY2UvZGV2aWNlVHlwZXMnO1xuICAgIHRoaXMuaGVhZGVyID0geyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH07XG4gICAgdGhpcy5iaW5hcnlTZXJ2aWNlID0gaW52ZW50b3J5U2VydmljZS5iaW5hcnk7XG4gIH1cblxuICBnZXRTZXJ2ZXJzKGlkOiBzdHJpbmcpIHtcbiAgICBpZiAoaWQgJiYgaWQubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3Qgb3B0aW9uczogSUZldGNoT3B0aW9ucyA9IHtcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXJcbiAgICAgIH07XG4gICAgICByZXR1cm4gdGhpcy5jbGllbnQuZmV0Y2goYCR7dGhpcy5taWNyb3NlcnZpY2VVcmx9LyR7aWR9YCwgb3B0aW9ucyk7XG4gICAgfVxuICB9XG5cbiAgY3JlYXRlU2VydmVyKGRhdGE6IE9wY3VhU2VydmVyKSB7XG4gICAgaWYgKHRoaXMuZG9lc0dhdGV3YXlJZEV4aXN0KGRhdGEpKSB7XG4gICAgICB0aGlzLmNsZWFuVXBQYXlsb2FkKGRhdGEpO1xuICAgICAgY29uc3Qgb3B0aW9uczogSUZldGNoT3B0aW9ucyA9IHtcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVyLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShkYXRhKVxuICAgICAgfTtcbiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5mZXRjaChgJHt0aGlzLm1pY3Jvc2VydmljZVVybH1gLCBvcHRpb25zKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyB1cGRhdGVTZXJ2ZXIoc2VydmVyOiBPcGN1YVNlcnZlcikge1xuICAgIGlmICh0aGlzLmRvZXNHYXRld2F5SWRFeGlzdChzZXJ2ZXIpICYmIHRoaXMuZG9lc0lkRXhpc3Qoc2VydmVyKSkge1xuICAgICAgdGhpcy5jbGVhblVwUGF5bG9hZChzZXJ2ZXIpO1xuICAgICAgY29uc3Qgb3B0aW9uczogSUZldGNoT3B0aW9ucyA9IHtcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVyLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShzZXJ2ZXIpXG4gICAgICB9O1xuICAgICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5jbGllbnQuZmV0Y2goYCR7dGhpcy5taWNyb3NlcnZpY2VVcmx9YCwgb3B0aW9ucyk7XG4gICAgICBsZXQgZGF0YTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGRhdGEgPSBhd2FpdCByZXMuanNvbigpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAvLyBub3RoaW5nXG4gICAgICB9XG5cbiAgICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZSh7IGRhdGEsIHJlcyB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJlbW92ZVNlcnZlcihkYXRhOiBPcGN1YVNlcnZlcikge1xuICAgIGlmICh0aGlzLmRvZXNHYXRld2F5SWRFeGlzdChkYXRhKSAmJiB0aGlzLmRvZXNJZEV4aXN0KGRhdGEpKSB7XG4gICAgICBjb25zdCBvcHRpb25zOiBJRmV0Y2hPcHRpb25zID0ge1xuICAgICAgICBtZXRob2Q6ICdERUxFVEUnXG4gICAgICB9O1xuICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmZldGNoKGAke3RoaXMubWljcm9zZXJ2aWNlVXJsfS8ke2RhdGEuZ2F0ZXdheUlkfS8ke2RhdGEuaWR9YCwgb3B0aW9ucyk7XG4gICAgfVxuICB9XG5cbiAgZ2V0S2V5c3RvcmUoYmluYXJ5SWQ6IHN0cmluZykge1xuICAgIGlmIChiaW5hcnlJZCAmJiBiaW5hcnlJZC5sZW5ndGggPiAwKSB7XG4gICAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmRldGFpbChiaW5hcnlJZCk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgdXBsb2FkS2V5c3RvcmUoZmlsZTogRmlsZSkge1xuICAgIGlmIChmaWxlICYmIGZpbGUuc2l6ZSA+IDApIHtcbiAgICAgIHJldHVybiB0aGlzLmJpbmFyeVNlcnZpY2UuY3JlYXRlKGZpbGUpO1xuICAgIH1cbiAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoJ0ludmFsaWQgZmlsZScpO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlS2V5c3RvcmUoaWQ6IHN0cmluZywgZmlsZTogRmlsZSkge1xuICAgIGlmIChpZCAmJiBpZC5sZW5ndGggPiAwICYmIGZpbGUgJiYgZmlsZS5zaXplID4gMCkge1xuICAgICAgY29uc3QgeyByZXMgfSA9IGF3YWl0IHRoaXMucmVtb3ZlS2V5c3RvcmUoaWQpO1xuICAgICAgaWYgKHJlcyAmJiByZXMuc3RhdHVzID09PSAyMDQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudXBsb2FkS2V5c3RvcmUoZmlsZSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgnSW52YWxpZCBmaWxlJyk7XG4gIH1cblxuICByZW1vdmVLZXlzdG9yZShpZDogc3RyaW5nKSB7XG4gICAgaWYgKGlkICYmIGlkLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiB0aGlzLmJpbmFyeVNlcnZpY2UuZGVsZXRlKGlkKTtcbiAgICB9XG4gIH1cblxuICBnZXRNb0lkKCkge1xuICAgIGNvbnN0IGN1cnJlbnRVcmw6IHN0cmluZyA9IHRoaXMucm91dGVyLnJvdXRlclN0YXRlLnNuYXBzaG90LnVybDtcbiAgICBjb25zdCBpc0RldmljZTogYm9vbGVhbiA9IG5ldyBSZWdFeHAoL2RldmljZVxcL1xcZCsvKS50ZXN0KGN1cnJlbnRVcmwpO1xuICAgIGlmIChpc0RldmljZSkge1xuICAgICAgcmV0dXJuIGN1cnJlbnRVcmwubWF0Y2goL1xcZCsvKVswXTtcbiAgICB9XG4gICAgcmV0dXJuICcnO1xuICB9XG5cbiAgZ2V0SWQoKSB7XG4gICAgY29uc3QgY3VycmVudFVybDogc3RyaW5nID0gdGhpcy5yb3V0ZXIucm91dGVyU3RhdGUuc25hcHNob3QudXJsO1xuICAgIGNvbnN0IGlzRGV2aWNlcHJvdG9jb2w6IGJvb2xlYW4gPSBuZXcgUmVnRXhwKC9kZXZpY2Vwcm90b2NvbHMvKS50ZXN0KGN1cnJlbnRVcmwpO1xuICAgIGlmIChpc0RldmljZXByb3RvY29sICYmIFJlZ0V4cCgvXFxkKyQvKS50ZXN0KGN1cnJlbnRVcmwpKSB7XG4gICAgICByZXR1cm4gY3VycmVudFVybC5tYXRjaCgvXFxkKyQvKVswXTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXREZXZpY2VQcm90b2NvbChpZDogc3RyaW5nKSB7XG4gICAgY29uc3Qgb3B0aW9uczogSUZldGNoT3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcixcbiAgICAgIH07XG4gICAgcmV0dXJuIHRoaXMuY2xpZW50LmZldGNoKGAke3RoaXMuZGV2aWNlVHlwZVByb3RvY29sVXJsfS8ke2lkfWAsIG9wdGlvbnMpO1xuXG4gIH1cblxuICBhc3luYyB1cGRhdGVEZXZpY2VQcm90b2NvbChkYXRhKSB7XG4gICAgY29uc3Qgb3B0aW9uczogSUZldGNoT3B0aW9ucyA9IHtcbiAgICAgIG1ldGhvZDogJ1BVVCcsXG4gICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcixcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KGRhdGEpXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5jbGllbnQuZmV0Y2goYCR7dGhpcy5kZXZpY2VUeXBlUHJvdG9jb2xVcmx9LyR7ZGF0YS5pZH1gLCBvcHRpb25zKTtcblxuICB9XG5cbiAgYXN5bmMgY3JlYXRlRGV2aWNlUHJvdG9jb2woZGF0YSkge1xuICAgIGNvbnN0IG9wdGlvbnM6IElGZXRjaE9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVyLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoZGF0YSlcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLmNsaWVudC5mZXRjaChgJHt0aGlzLmRldmljZVR5cGVQcm90b2NvbFVybH1gLCBvcHRpb25zKTtcbiAgfVxuXG4gIHByaXZhdGUgZG9lc0dhdGV3YXlJZEV4aXN0KGRhdGE6IE9wY3VhU2VydmVyKSB7XG4gICAgcmV0dXJuIGRhdGEgJiYgZGF0YS5nYXRld2F5SWQgJiYgZGF0YS5nYXRld2F5SWQubGVuZ3RoID4gMDtcbiAgfVxuXG4gIHByaXZhdGUgZG9lc0lkRXhpc3QoZGF0YTogT3BjdWFTZXJ2ZXIpIHtcbiAgICByZXR1cm4gZGF0YSAmJiBkYXRhLmlkICYmIGRhdGEuaWQubGVuZ3RoID4gMCAmJiBkYXRhLmlkICE9PSAnbmV3JztcbiAgfVxuXG4gIHByaXZhdGUgY2xlYW5VcFBheWxvYWQoZGF0YTogT3BjdWFTZXJ2ZXIpIHtcbiAgICBpZiAoZGF0YSkge1xuICAgICAgaWYgKGRhdGEuaWQgJiYgZGF0YS5pZCA9PT0gJ25ldycpIHsgZGVsZXRlIGRhdGEuaWQ7IH1cbiAgICAgIGlmIChkYXRhLnF1aWNrSW5mbykgeyBkZWxldGUgZGF0YS5xdWlja0luZm87IH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==