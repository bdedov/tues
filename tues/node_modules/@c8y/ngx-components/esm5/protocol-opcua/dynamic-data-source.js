import * as tslib_1 from "tslib";
import { BehaviorSubject, merge } from 'rxjs';
import { map } from 'rxjs/operators';
var DynamicDataSource = /** @class */ (function () {
    function DynamicDataSource(treeControl, addressSpaceService, serverId) {
        this.treeControl = treeControl;
        this.addressSpaceService = addressSpaceService;
        this.serverId = serverId;
        this.dataChange = new BehaviorSubject([]);
        this.treeControl.isExpanded = function (node) { return node.expanded; };
    }
    Object.defineProperty(DynamicDataSource.prototype, "data", {
        get: function () {
            return this.dataChange.value;
        },
        set: function (value) {
            this.treeControl.dataNodes = value;
            this.dataChange.next(value);
        },
        enumerable: true,
        configurable: true
    });
    DynamicDataSource.prototype.connect = function (collectionViewer) {
        var _this = this;
        this.treeControl.expansionModel.onChange.subscribe(function (change) {
            if (change.added || change.removed) {
                _this.handleTreeControl(change);
            }
        });
        return merge(collectionViewer.viewChange, this.dataChange).pipe(map(function () { return _this.data; }));
    };
    /** Handle expand/collapse behaviors */
    DynamicDataSource.prototype.handleTreeControl = function (change) {
        var _this = this;
        if (change.added) {
            change.added.forEach(function (node) { return _this.toggleNode(node, true); });
        }
        if (change.removed) {
            change.removed
                .slice()
                .reverse()
                .forEach(function (node) { return _this.toggleNode(node, false); });
        }
    };
    /**
     * Toggle the node, remove from display list
     */
    DynamicDataSource.prototype.toggleNode = function (addressSpaceNode, expand) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var res, children;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!(!addressSpaceNode.children || addressSpaceNode.children.length === 0)) return [3 /*break*/, 3];
                        addressSpaceNode.currentlyLoadingChildren = true;
                        return [4 /*yield*/, this.addressSpaceService.getChildrenOf(addressSpaceNode, this.serverId)];
                    case 1:
                        res = _a.sent();
                        return [4 /*yield*/, res.json()];
                    case 2:
                        children = (_a.sent());
                        addressSpaceNode.children = children || [];
                        addressSpaceNode.children = addressSpaceNode.children.map(function (node) {
                            node.parentNode = addressSpaceNode;
                            return node;
                        });
                        addressSpaceNode.currentlyLoadingChildren = false;
                        this.treeControl.expand(addressSpaceNode);
                        _a.label = 3;
                    case 3:
                        addressSpaceNode.expanded = expand && addressSpaceNode.children.length > 0;
                        this.refreshNestedTree(this.data);
                        return [2 /*return*/, Promise.resolve(addressSpaceNode)];
                }
            });
        });
    };
    DynamicDataSource.prototype.catch = function () {
        // do nothing
    };
    DynamicDataSource.prototype.refreshNestedTree = function (treeData) {
        // necessary to rerender tree, otherwise new nodes will not
        // appear, but they are added to the list.
        this.data = [];
        this.dataChange.next(treeData);
        this.triggerResize(); // to resize the modal window when creating a new device protocol
    };
    DynamicDataSource.prototype.triggerResize = function () {
        setTimeout(function () {
            try {
                window.dispatchEvent(new Event('resize'));
            }
            catch (error) {
                // do nothing
            }
        }, 200);
    };
    return DynamicDataSource;
}());
export { DynamicDataSource };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1kYXRhLXNvdXJjZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvcHJvdG9jb2wtb3BjdWEvIiwic291cmNlcyI6WyJkeW5hbWljLWRhdGEtc291cmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsZUFBZSxFQUFjLEtBQUssRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFJeEUsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXJDO0lBV0UsMkJBQ1MsV0FBZ0QsRUFDL0MsbUJBQXdDLEVBQ3hDLFFBQWdCO1FBRmpCLGdCQUFXLEdBQVgsV0FBVyxDQUFxQztRQUMvQyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLGFBQVEsR0FBUixRQUFRLENBQVE7UUFiMUIsZUFBVSxHQUFHLElBQUksZUFBZSxDQUFxQixFQUFFLENBQUMsQ0FBQztRQWV2RCxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsR0FBRyxVQUFDLElBQXNCLElBQUssT0FBQSxJQUFJLENBQUMsUUFBUSxFQUFiLENBQWEsQ0FBQztJQUMxRSxDQUFDO0lBZEQsc0JBQUksbUNBQUk7YUFBUjtZQUNFLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUM7UUFDL0IsQ0FBQzthQUNELFVBQVMsS0FBeUI7WUFDaEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1lBQ25DLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzlCLENBQUM7OztPQUpBO0lBY0QsbUNBQU8sR0FBUCxVQUFRLGdCQUFrQztRQUExQyxpQkFTQztRQVJDLElBQUksQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQ2hELFVBQUMsTUFBeUM7WUFDeEMsSUFBSSxNQUFNLENBQUMsS0FBSyxJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUU7Z0JB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QUFRLENBQUMsQ0FBQyxDQUFDO2FBQzNDO1lBQUMsT0FBTyxLQUFLLEVBQUU7Z0JBQ2QsYUFBYTthQUNkO1FBQ0gsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ1YsQ0FBQztJQUNILHdCQUFDO0FBQUQsQ0FBQyxBQXpGRCxJQXlGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSwgbWVyZ2UsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgTmVzdGVkVHJlZUNvbnRyb2wgfSBmcm9tICdAYW5ndWxhci9jZGsvdHJlZSc7XG5pbXBvcnQgeyBDb2xsZWN0aW9uVmlld2VyLCBTZWxlY3Rpb25DaGFuZ2UgfSBmcm9tICdAYW5ndWxhci9jZGsvY29sbGVjdGlvbnMnO1xuaW1wb3J0IHsgQWRkcmVzc1NwYWNlU2VydmljZSwgQWRkcmVzc1NwYWNlTm9kZSB9IGZyb20gJy4vYWRkcmVzcy1zcGFjZS5zZXJ2aWNlJztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuZXhwb3J0IGNsYXNzIER5bmFtaWNEYXRhU291cmNlIHtcbiAgZGF0YUNoYW5nZSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8QWRkcmVzc1NwYWNlTm9kZVtdPihbXSk7XG5cbiAgZ2V0IGRhdGEoKTogQWRkcmVzc1NwYWNlTm9kZVtdIHtcbiAgICByZXR1cm4gdGhpcy5kYXRhQ2hhbmdlLnZhbHVlO1xuICB9XG4gIHNldCBkYXRhKHZhbHVlOiBBZGRyZXNzU3BhY2VOb2RlW10pIHtcbiAgICB0aGlzLnRyZWVDb250cm9sLmRhdGFOb2RlcyA9IHZhbHVlO1xuICAgIHRoaXMuZGF0YUNoYW5nZS5uZXh0KHZhbHVlKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyB0cmVlQ29udHJvbDogTmVzdGVkVHJlZUNvbnRyb2w8QWRkcmVzc1NwYWNlTm9kZT4sXG4gICAgcHJpdmF0ZSBhZGRyZXNzU3BhY2VTZXJ2aWNlOiBBZGRyZXNzU3BhY2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgc2VydmVySWQ6IHN0cmluZ1xuICApIHtcbiAgICB0aGlzLnRyZWVDb250cm9sLmlzRXhwYW5kZWQgPSAobm9kZTogQWRkcmVzc1NwYWNlTm9kZSkgPT4gbm9kZS5leHBhbmRlZDtcbiAgfVxuXG4gIGNvbm5lY3QoY29sbGVjdGlvblZpZXdlcjogQ29sbGVjdGlvblZpZXdlcik6IE9ic2VydmFibGU8QWRkcmVzc1NwYWNlTm9kZVtdPiB7XG4gICAgdGhpcy50cmVlQ29udHJvbC5leHBhbnNpb25Nb2RlbC5vbkNoYW5nZS5zdWJzY3JpYmUoXG4gICAgICAoY2hhbmdlOiBTZWxlY3Rpb25DaGFuZ2U8QWRkcmVzc1NwYWNlTm9kZT4pID0+IHtcbiAgICAgICAgaWYgKGNoYW5nZS5hZGRlZCB8fCBjaGFuZ2UucmVtb3ZlZCkge1xuICAgICAgICAgIHRoaXMuaGFuZGxlVHJlZUNvbnRyb2woY2hhbmdlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICk7XG4gICAgcmV0dXJuIG1lcmdlKGNvbGxlY3Rpb25WaWV3ZXIudmlld0NoYW5nZSwgdGhpcy5kYXRhQ2hhbmdlKS5waXBlKG1hcCgoKSA9PiB0aGlzLmRhdGEpKTtcbiAgfVxuXG4gIC8qKiBIYW5kbGUgZXhwYW5kL2NvbGxhcHNlIGJlaGF2aW9ycyAqL1xuICBoYW5kbGVUcmVlQ29udHJvbChjaGFuZ2U6IFNlbGVjdGlvbkNoYW5nZTxBZGRyZXNzU3BhY2VOb2RlPikge1xuICAgIGlmIChjaGFuZ2UuYWRkZWQpIHtcbiAgICAgIGNoYW5nZS5hZGRlZC5mb3JFYWNoKG5vZGUgPT4gdGhpcy50b2dnbGVOb2RlKG5vZGUsIHRydWUpKTtcbiAgICB9XG4gICAgaWYgKGNoYW5nZS5yZW1vdmVkKSB7XG4gICAgICBjaGFuZ2UucmVtb3ZlZFxuICAgICAgICAuc2xpY2UoKVxuICAgICAgICAucmV2ZXJzZSgpXG4gICAgICAgIC5mb3JFYWNoKG5vZGUgPT4gdGhpcy50b2dnbGVOb2RlKG5vZGUsIGZhbHNlKSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRvZ2dsZSB0aGUgbm9kZSwgcmVtb3ZlIGZyb20gZGlzcGxheSBsaXN0XG4gICAqL1xuICBhc3luYyB0b2dnbGVOb2RlKGFkZHJlc3NTcGFjZU5vZGU6IEFkZHJlc3NTcGFjZU5vZGUsIGV4cGFuZDogYm9vbGVhbikge1xuICAgIGlmICghYWRkcmVzc1NwYWNlTm9kZS5jaGlsZHJlbiB8fCBhZGRyZXNzU3BhY2VOb2RlLmNoaWxkcmVuLmxlbmd0aCA9PT0gMCkge1xuICAgICAgYWRkcmVzc1NwYWNlTm9kZS5jdXJyZW50bHlMb2FkaW5nQ2hpbGRyZW4gPSB0cnVlO1xuXG4gICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2UuZ2V0Q2hpbGRyZW5PZihhZGRyZXNzU3BhY2VOb2RlLCB0aGlzLnNlcnZlcklkKTtcbiAgICAgIGNvbnN0IGNoaWxkcmVuID0gKGF3YWl0IHJlcy5qc29uKCkpIGFzIEFkZHJlc3NTcGFjZU5vZGVbXTtcblxuICAgICAgYWRkcmVzc1NwYWNlTm9kZS5jaGlsZHJlbiA9IGNoaWxkcmVuIHx8IFtdO1xuICAgICAgYWRkcmVzc1NwYWNlTm9kZS5jaGlsZHJlbiA9IGFkZHJlc3NTcGFjZU5vZGUuY2hpbGRyZW4ubWFwKChub2RlOiBBZGRyZXNzU3BhY2VOb2RlKSA9PiB7XG4gICAgICAgIG5vZGUucGFyZW50Tm9kZSA9IGFkZHJlc3NTcGFjZU5vZGU7XG4gICAgICAgIHJldHVybiBub2RlO1xuICAgICAgfSk7XG4gICAgICBhZGRyZXNzU3BhY2VOb2RlLmN1cnJlbnRseUxvYWRpbmdDaGlsZHJlbiA9IGZhbHNlO1xuXG4gICAgICB0aGlzLnRyZWVDb250cm9sLmV4cGFuZChhZGRyZXNzU3BhY2VOb2RlKTtcbiAgICB9XG5cbiAgICBhZGRyZXNzU3BhY2VOb2RlLmV4cGFuZGVkID0gZXhwYW5kICYmIGFkZHJlc3NTcGFjZU5vZGUuY2hpbGRyZW4ubGVuZ3RoID4gMDtcbiAgICB0aGlzLnJlZnJlc2hOZXN0ZWRUcmVlKHRoaXMuZGF0YSk7XG5cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGFkZHJlc3NTcGFjZU5vZGUpO1xuICB9XG4gIGNhdGNoKCkge1xuICAgIC8vIGRvIG5vdGhpbmdcbiAgfVxuXG4gIHByaXZhdGUgcmVmcmVzaE5lc3RlZFRyZWUodHJlZURhdGE6IEFkZHJlc3NTcGFjZU5vZGVbXSkge1xuICAgIC8vIG5lY2Vzc2FyeSB0byByZXJlbmRlciB0cmVlLCBvdGhlcndpc2UgbmV3IG5vZGVzIHdpbGwgbm90XG4gICAgLy8gYXBwZWFyLCBidXQgdGhleSBhcmUgYWRkZWQgdG8gdGhlIGxpc3QuXG4gICAgdGhpcy5kYXRhID0gW107XG4gICAgdGhpcy5kYXRhQ2hhbmdlLm5leHQodHJlZURhdGEpO1xuICAgIHRoaXMudHJpZ2dlclJlc2l6ZSgpOyAvLyB0byByZXNpemUgdGhlIG1vZGFsIHdpbmRvdyB3aGVuIGNyZWF0aW5nIGEgbmV3IGRldmljZSBwcm90b2NvbFxuICB9XG5cbiAgcHJpdmF0ZSB0cmlnZ2VyUmVzaXplKCkge1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgd2luZG93LmRpc3BhdGNoRXZlbnQobmV3IEV2ZW50KCdyZXNpemUnKSk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAvLyBkbyBub3RoaW5nXG4gICAgICB9XG4gICAgfSwgMjAwKTtcbiAgfVxufVxuIl19