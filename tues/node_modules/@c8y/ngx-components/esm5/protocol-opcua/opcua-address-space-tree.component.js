import * as tslib_1 from "tslib";
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { AddressSpaceNode, AddressSpaceService, NodeNavigationData } from './address-space.service';
import { OpcuaService } from './opcuaService';
import { AlertService } from '@c8y/ngx-components';
import { DynamicDataSource } from './dynamic-data-source';
import { NestedTreeControl } from '@angular/cdk/tree';
import { clone } from 'lodash';
var OpcuaAddressSpaceTreeComponent = /** @class */ (function () {
    function OpcuaAddressSpaceTreeComponent(addressSpaceService, opcuaService, alertService) {
        var _this = this;
        this.addressSpaceService = addressSpaceService;
        this.opcuaService = opcuaService;
        this.alertService = alertService;
        this.focusEmitter = new EventEmitter();
        this.selectedNode = new EventEmitter();
        this.dataSource = null;
        this.loading = false;
        this.getChildren = function (node) { return (node.expanded ? node.children : []); };
        this.hasChild = function (_, _nodeData) {
            return _this.addressSpaceService.childrenAvailable(_nodeData.references);
        };
    }
    Object.defineProperty(OpcuaAddressSpaceTreeComponent.prototype, "moId", {
        set: function (id) {
            this._moId = id || undefined;
        },
        enumerable: true,
        configurable: true
    });
    OpcuaAddressSpaceTreeComponent.prototype.ngOnInit = function () {
        this.initializeDataSet();
    };
    OpcuaAddressSpaceTreeComponent.prototype.ngOnChanges = function (changes) {
        if (changes.moId && (changes.moId.currentValue !== changes.moId.previousValue)) {
            this.initializeDataSet();
        }
    };
    OpcuaAddressSpaceTreeComponent.prototype.initializeDataSet = function () {
        var _this = this;
        this.nodeNavDataSubscription = this.addressSpaceService
            .getNodeNavData$()
            .subscribe(function (nodeNavData) { return _this.openNode(nodeNavData); });
        this.subscriptionRef = this.focusEmitter.subscribe(function (node) {
            _this.focused = _this.isFocusedNode(node) ? undefined : node;
        });
    };
    OpcuaAddressSpaceTreeComponent.prototype.ngOnDestroy = function () {
        // clean up the address-space-tree
        this.addressSpaceService.resetTreeToRootNode();
        if (this.nodeNavDataSubscription && !this.nodeNavDataSubscription.closed) {
            this.nodeNavDataSubscription.unsubscribe();
        }
        if (this.subscriptionRef && !this.subscriptionRef.closed) {
            this.subscriptionRef.unsubscribe();
        }
    };
    OpcuaAddressSpaceTreeComponent.prototype.openNode = function (nodeNavData) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var node, selectedAncestorIds, nodeId, clonedAncestors, n;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        node = nodeNavData.node, selectedAncestorIds = nodeNavData.selectedAncestorIds;
                        // We just set the nodeId when the selectedAncestorIds variable an empty array.
                        // If selectedAncestorIds contain any id we assume that the tree should be travsersed beginning
                        // from the root node.
                        if (node && node.nodeId && selectedAncestorIds && selectedAncestorIds.length === 0) {
                            nodeId = node.nodeId;
                        }
                        // Always recreate the tree when routing to a specific nested node,
                        // because previous modifications to the tree-structure could cause errors
                        // while traversing with 'old' tree-data
                        // -----------------
                        // setupTree is able to handle nodeId = undefined
                        return [4 /*yield*/, this.setupTree(nodeId)];
                    case 1:
                        // Always recreate the tree when routing to a specific nested node,
                        // because previous modifications to the tree-structure could cause errors
                        // while traversing with 'old' tree-data
                        // -----------------
                        // setupTree is able to handle nodeId = undefined
                        _a.sent();
                        if (!selectedAncestorIds || selectedAncestorIds.length === 0) {
                            return [2 /*return*/];
                        }
                        if (!(nodeNavData && this.dataSource)) return [3 /*break*/, 3];
                        clonedAncestors = clone(selectedAncestorIds);
                        clonedAncestors.shift();
                        return [4 /*yield*/, this.dataSource.toggleNode(this.dataSource.data[0], true)];
                    case 2:
                        n = _a.sent();
                        this.setChildNodes(n.children, clonedAncestors);
                        this.toggleFocusedNode(node);
                        _a.label = 3;
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    OpcuaAddressSpaceTreeComponent.prototype.setChildNodes = function (nodes, ids) {
        var _this = this;
        if (nodes) {
            ids.forEach(function (id) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
                var match, idx, toggledNode;
                return tslib_1.__generator(this, function (_a) {
                    switch (_a.label) {
                        case 0:
                            match = nodes.find(function (n) { return n.nodeId === id; });
                            if (!(match && ids.length > 0)) return [3 /*break*/, 2];
                            idx = ids.findIndex(function (value) { return value === id; });
                            if (idx >= 0) {
                                ids.splice(idx, 1);
                            }
                            return [4 /*yield*/, this.dataSource.toggleNode(match, true)];
                        case 1:
                            toggledNode = _a.sent();
                            this.setChildNodes(toggledNode.children, ids);
                            _a.label = 2;
                        case 2: return [2 /*return*/];
                    }
                });
            }); });
        }
    };
    OpcuaAddressSpaceTreeComponent.prototype.setupTree = function (nodeId) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var res, data, _a, rootNode;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        this.loading = true;
                        if (!this._moId || this._moId.length === 0) {
                            this._moId = this.opcuaService.getMoId();
                        }
                        return [4 /*yield*/, this.addressSpaceService.getNode(this._moId, nodeId)];
                    case 1:
                        res = _b.sent();
                        if (!res) return [3 /*break*/, 8];
                        if (!(res.status !== 200)) return [3 /*break*/, 5];
                        if (!res.json) return [3 /*break*/, 3];
                        return [4 /*yield*/, res.json()];
                    case 2:
                        _a = _b.sent();
                        return [3 /*break*/, 4];
                    case 3:
                        _a = undefined;
                        _b.label = 4;
                    case 4:
                        data = _a;
                        this.alertService.addServerFailure({ data: data, res: res });
                        this.dataSource = undefined;
                        return [3 /*break*/, 7];
                    case 5: return [4 /*yield*/, res.json()];
                    case 6:
                        rootNode = (_b.sent());
                        this.nestedTreeControl = new NestedTreeControl(this.getChildren);
                        this.dataSource = new DynamicDataSource(this.nestedTreeControl, this.addressSpaceService, this._moId);
                        this.dataSource.data = [rootNode];
                        _b.label = 7;
                    case 7:
                        this.loading = false;
                        return [3 /*break*/, 9];
                    case 8:
                        this.loading = false;
                        _b.label = 9;
                    case 9: return [2 /*return*/];
                }
            });
        });
    };
    OpcuaAddressSpaceTreeComponent.prototype.getMoId = function () {
        if (!this._moId || this._moId.length === 0) {
            return this.opcuaService.getMoId();
        }
        return this._moId;
    };
    OpcuaAddressSpaceTreeComponent.prototype.getIcon = function (nodeClassName) {
        return this.addressSpaceService.getIcon(nodeClassName);
    };
    OpcuaAddressSpaceTreeComponent.prototype.toggleFocusedNode = function (node) {
        var relativePath = [];
        this.getRelativePath(node, relativePath);
        node.relativePath = relativePath;
        this.selectedNode.emit(node);
        this.focused = this.isFocusedNode(node) ? undefined : node;
    };
    OpcuaAddressSpaceTreeComponent.prototype.isFocusedNode = function (node) {
        if (this.focused) {
            return node.nodeId === this.focused.nodeId;
        }
        return false;
    };
    OpcuaAddressSpaceTreeComponent.prototype.getRelativePath = function (node, relativePath) {
        if (node.parentNode) {
            relativePath.unshift(node.browseName);
            this.getRelativePath(node.parentNode, relativePath);
        }
    };
    OpcuaAddressSpaceTreeComponent.ctorParameters = function () { return [
        { type: AddressSpaceService },
        { type: OpcuaService },
        { type: AlertService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], OpcuaAddressSpaceTreeComponent.prototype, "moId", null);
    tslib_1.__decorate([
        Input()
    ], OpcuaAddressSpaceTreeComponent.prototype, "node", void 0);
    tslib_1.__decorate([
        Input()
    ], OpcuaAddressSpaceTreeComponent.prototype, "focusEmitter", void 0);
    tslib_1.__decorate([
        Output()
    ], OpcuaAddressSpaceTreeComponent.prototype, "selectedNode", void 0);
    OpcuaAddressSpaceTreeComponent = tslib_1.__decorate([
        Component({
            selector: 'opcua-address-space-tree',
            template: "<div class=\"card-block\" *ngIf=\"dataSource && !loading\">\n  <cdk-tree [dataSource]=\"dataSource\" [treeControl]=\"nestedTreeControl\">\n    <!-- This is the tree node template for leaf nodes -->\n    <cdk-nested-tree-node *cdkTreeNodeDef=\"let node\" (click)=\"toggleFocusedNode(node)\"\n    [ngClass]=\"{'strong':isFocusedNode(node)}\" style=\"cursor: pointer\">\n      <span>\n        <i class=\"right-m-xs\" \n        [c8yIcon]=\"getIcon(node.nodeClassName)\" \n        [ngClass]=\"{'strong':isFocusedNode(node)}\" \n        style=\"cursor: pointer\"></i>\n        {{node.displayName}}\n      </span>\n    </cdk-nested-tree-node>\n    <!-- This is the tree node template for expandable nodes -->\n    <cdk-nested-tree-node *cdkTreeNodeDef=\"let node; when: hasChild\">\n      <div class=\"flex-row\">\n        <button cdkTreeNodeToggle class=\"btn-clean text-primary right-m-xs\" [disabled]=\"node.currentlyLoadingChildren\">\n          <i class=\"fa\" [ngClass]=\"{'fa-plus-square': !node.expanded, 'fa-minus-square': node.expanded}\"></i>\n        </button>\n        <i class=\"right-m-xs\" [c8yIcon]=\"getIcon(node.nodeClassName)\" [ngClass]=\"{'strong':isFocusedNode(node)}\" style=\"cursor: pointer\"></i>\n        <span (click)=\"toggleFocusedNode(node)\" [ngClass]=\"{'strong':isFocusedNode(node)}\" style=\"cursor: pointer\"> {{node.displayName}} </span>\n        <span class=\"left-m-xs\" [style.visibility]=\"node.currentlyLoadingChildren ? 'visible': 'hidden'\">\n          <i class=\"fa fa-circle-o-notch fa-spin\"></i>\n        </span>\n      </div>\n      <ng-container cdkTreeNodeOutlet></ng-container>\n    </cdk-nested-tree-node>\n  </cdk-tree>\n</div>\n<div style=\"padding: 8px;\" *ngIf=\"loading\">\n  <div class=\"spinner\" style=\"position: relative\">\n    <div class=\"rect1\"></div>\n    <div class=\"rect2\"></div>\n    <div class=\"rect3\"></div>\n    <div class=\"rect4\"></div>\n    <div class=\"rect5\"></div>\n  </div>\n</div>\n<div class=\"alert alert-info m-t-16\" *ngIf=\"!dataSource && !loading\" translate>\n  No source data available to fetch address space.\n</div>"
        })
    ], OpcuaAddressSpaceTreeComponent);
    return OpcuaAddressSpaceTreeComponent;
}());
export { OpcuaAddressSpaceTreeComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtYWRkcmVzcy1zcGFjZS10cmVlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvcHJvdG9jb2wtb3BjdWEvIiwic291cmNlcyI6WyJvcGN1YS1hZGRyZXNzLXNwYWNlLXRyZWUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULEtBQUssRUFDTCxNQUFNLEVBRU4sWUFBWSxFQUliLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxtQkFBbUIsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3BHLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDdEQsT0FBTyxFQUFFLEtBQUssRUFBYSxNQUFNLFFBQVEsQ0FBQztBQVExQztJQWdCRSx3Q0FDVSxtQkFBd0MsRUFDeEMsWUFBMEIsRUFDMUIsWUFBMEI7UUFIcEMsaUJBSUk7UUFITSx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBWjNCLGlCQUFZLEdBQW1DLElBQUksWUFBWSxFQUFvQixDQUFDO1FBQ25GLGlCQUFZLEdBQW1DLElBQUksWUFBWSxFQUFvQixDQUFDO1FBRTlGLGVBQVUsR0FBc0IsSUFBSSxDQUFDO1FBRXJDLFlBQU8sR0FBWSxLQUFLLENBQUM7UUFVekIsZ0JBQVcsR0FBRyxVQUFDLElBQXNCLElBQUssT0FBQSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElB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SSxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztTQUM1QztRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVPLHdEQUFlLEdBQXZCLFVBQXdCLElBQXNCLEVBQUUsWUFBc0I7UUFDcEUsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ25CLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3RDLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxZQUFZLENBQUMsQ0FBQztTQUNyRDtJQUNILENBQUM7O2dCQXhKOEIsbUJBQW1CO2dCQUMxQixZQUFZO2dCQUNaLFlBQVk7O0lBakJwQztRQURDLEtBQUssRUFBRTs4REFHUDtJQUVRO1FBQVIsS0FBSyxFQUFFO2dFQUFNO0lBQ0w7UUFBUixLQUFLLEVBQUU7d0VBQXFGO0lBQ25GO1FBQVQsTUFBTSxFQUFFO3dFQUFxRjtJQVJuRiw4QkFBOEI7UUFKMUMsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLDBCQUEwQjtZQUNwQyx3a0VBQXdEO1NBQ3pELENBQUM7T0FDVyw4QkFBOEIsQ0EwSzFDO0lBQUQscUNBQUM7Q0FBQSxBQTFLRCxJQTBLQztTQTFLWSw4QkFBOEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIElucHV0LFxuICBPdXRwdXQsXG4gIE9uSW5pdCxcbiAgRXZlbnRFbWl0dGVyLFxuICBPbkRlc3Ryb3ksXG4gIE9uQ2hhbmdlcyxcbiAgU2ltcGxlQ2hhbmdlc1xufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFkZHJlc3NTcGFjZU5vZGUsIEFkZHJlc3NTcGFjZVNlcnZpY2UsIE5vZGVOYXZpZ2F0aW9uRGF0YSB9IGZyb20gJy4vYWRkcmVzcy1zcGFjZS5zZXJ2aWNlJztcbmltcG9ydCB7IE9wY3VhU2VydmljZSB9IGZyb20gJy4vb3BjdWFTZXJ2aWNlJztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgRHluYW1pY0RhdGFTb3VyY2UgfSBmcm9tICcuL2R5bmFtaWMtZGF0YS1zb3VyY2UnO1xuaW1wb3J0IHsgTmVzdGVkVHJlZUNvbnRyb2wgfSBmcm9tICdAYW5ndWxhci9jZGsvdHJlZSc7XG5pbXBvcnQgeyBjbG9uZSwgY2xvbmVEZWVwIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgcmVsYXRpdmUgfSBmcm9tICdwYXRoJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnb3BjdWEtYWRkcmVzcy1zcGFjZS10cmVlJyxcbiAgdGVtcGxhdGVVcmw6ICcuL29wY3VhLWFkZHJlc3Mtc3BhY2UtdHJlZS5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgT3BjdWFBZGRyZXNzU3BhY2VUcmVlQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIE9uQ2hhbmdlcyB7XG4gIEBJbnB1dCgpXG4gIHNldCBtb0lkKGlkOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9tb0lkID0gaWQgfHwgdW5kZWZpbmVkO1xuICB9XG5cbiAgQElucHV0KCkgbm9kZTtcbiAgQElucHV0KCkgZm9jdXNFbWl0dGVyOiBFdmVudEVtaXR0ZXI8QWRkcmVzc1NwYWNlTm9kZT4gPSBuZXcgRXZlbnRFbWl0dGVyPEFkZHJlc3NTcGFjZU5vZGU+KCk7XG4gIEBPdXRwdXQoKSBzZWxlY3RlZE5vZGU6IEV2ZW50RW1pdHRlcjxBZGRyZXNzU3BhY2VOb2RlPiA9IG5ldyBFdmVudEVtaXR0ZXI8QWRkcmVzc1NwYWNlTm9kZT4oKTtcbiAgbmVzdGVkVHJlZUNvbnRyb2w6IE5lc3RlZFRyZWVDb250cm9sPEFkZHJlc3NTcGFjZU5vZGU+O1xuICBkYXRhU291cmNlOiBEeW5hbWljRGF0YVNvdXJjZSA9IG51bGw7XG4gIGZvY3VzZWQ6IEFkZHJlc3NTcGFjZU5vZGU7XG4gIGxvYWRpbmc6IGJvb2xlYW4gPSBmYWxzZTtcbiAgc3Vic2NyaXB0aW9uUmVmOiBTdWJzY3JpcHRpb247XG4gIG5vZGVOYXZEYXRhU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgX21vSWQ6IHN0cmluZztcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhZGRyZXNzU3BhY2VTZXJ2aWNlOiBBZGRyZXNzU3BhY2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgb3BjdWFTZXJ2aWNlOiBPcGN1YVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhbGVydFNlcnZpY2U6IEFsZXJ0U2VydmljZVxuICApIHt9XG5cbiAgZ2V0Q2hpbGRyZW4gPSAobm9kZTogQWRkcmVzc1NwYWNlTm9kZSkgPT4gKG5vZGUuZXhwYW5kZWQgPyBub2RlLmNoaWxkcmVuIDogW10pO1xuICBoYXNDaGlsZCA9IChfOiBudW1iZXIsIF9ub2RlRGF0YTogQWRkcmVzc1NwYWNlTm9kZSkgPT5cbiAgICB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2UuY2hpbGRyZW5BdmFpbGFibGUoX25vZGVEYXRhLnJlZmVyZW5jZXMpXG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5pbml0aWFsaXplRGF0YVNldCgpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGlmIChjaGFuZ2VzLm1vSWQgJiYgKGNoYW5nZXMubW9JZC5jdXJyZW50VmFsdWUgIT09IGNoYW5nZXMubW9JZC5wcmV2aW91c1ZhbHVlKSkge1xuICAgICAgdGhpcy5pbml0aWFsaXplRGF0YVNldCgpO1xuICAgIH1cbiAgfVxuXG4gIGluaXRpYWxpemVEYXRhU2V0KCkge1xuICAgIHRoaXMubm9kZU5hdkRhdGFTdWJzY3JpcHRpb24gPSB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2VcbiAgICAgIC5nZXROb2RlTmF2RGF0YSQoKVxuICAgICAgLnN1YnNjcmliZShub2RlTmF2RGF0YSA9PiB0aGlzLm9wZW5Ob2RlKG5vZGVOYXZEYXRhKSk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25SZWYgPSB0aGlzLmZvY3VzRW1pdHRlci5zdWJzY3JpYmUobm9kZSA9PiB7XG4gICAgICB0aGlzLmZvY3VzZWQgPSB0aGlzLmlzRm9jdXNlZE5vZGUobm9kZSkgPyB1bmRlZmluZWQgOiBub2RlO1xuICAgIH0pO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgLy8gY2xlYW4gdXAgdGhlIGFkZHJlc3Mtc3BhY2UtdHJlZVxuICAgIHRoaXMuYWRkcmVzc1NwYWNlU2VydmljZS5yZXNldFRyZWVUb1Jvb3ROb2RlKCk7XG5cbiAgICBpZiAodGhpcy5ub2RlTmF2RGF0YVN1YnNjcmlwdGlvbiAmJiAhdGhpcy5ub2RlTmF2RGF0YVN1YnNjcmlwdGlvbi5jbG9zZWQpIHtcbiAgICAgIHRoaXMubm9kZU5hdkRhdGFTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zdWJzY3JpcHRpb25SZWYgJiYgIXRoaXMuc3Vic2NyaXB0aW9uUmVmLmNsb3NlZCkge1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb25SZWYudW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBvcGVuTm9kZShub2RlTmF2RGF0YTogTm9kZU5hdmlnYXRpb25EYXRhKSB7XG4gICAgY29uc3QgeyBub2RlLCBzZWxlY3RlZEFuY2VzdG9ySWRzIH0gPSBub2RlTmF2RGF0YTtcbiAgICBsZXQgbm9kZUlkO1xuXG4gICAgLy8gV2UganVzdCBzZXQgdGhlIG5vZGVJZCB3aGVuIHRoZSBzZWxlY3RlZEFuY2VzdG9ySWRzIHZhcmlhYmxlIGFuIGVtcHR5IGFycmF5LlxuICAgIC8vIElmIHNlbGVjdGVkQW5jZXN0b3JJZHMgY29udGFpbiBhbnkgaWQgd2UgYXNzdW1lIHRoYXQgdGhlIHRyZWUgc2hvdWxkIGJlIHRyYXZzZXJzZWQgYmVnaW5uaW5nXG4gICAgLy8gZnJvbSB0aGUgcm9vdCBub2RlLlxuICAgIGlmIChub2RlICYmIG5vZGUubm9kZUlkICYmIHNlbGVjdGVkQW5jZXN0b3JJZHMgJiYgc2VsZWN0ZWRBbmNlc3Rvcklkcy5sZW5ndGggPT09IDApIHtcbiAgICAgIG5vZGVJZCA9IG5vZGUubm9kZUlkO1xuICAgIH1cbiAgICAvLyBBbHdheXMgcmVjcmVhdGUgdGhlIHRyZWUgd2hlbiByb3V0aW5nIHRvIGEgc3BlY2lmaWMgbmVzdGVkIG5vZGUsXG4gICAgLy8gYmVjYXVzZSBwcmV2aW91cyBtb2RpZmljYXRpb25zIHRvIHRoZSB0cmVlLXN0cnVjdHVyZSBjb3VsZCBjYXVzZSBlcnJvcnNcbiAgICAvLyB3aGlsZSB0cmF2ZXJzaW5nIHdpdGggJ29sZCcgdHJlZS1kYXRhXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBzZXR1cFRyZWUgaXMgYWJsZSB0byBoYW5kbGUgbm9kZUlkID0gdW5kZWZpbmVkXG4gICAgYXdhaXQgdGhpcy5zZXR1cFRyZWUobm9kZUlkKTtcblxuICAgIGlmICghc2VsZWN0ZWRBbmNlc3RvcklkcyB8fCBzZWxlY3RlZEFuY2VzdG9ySWRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChub2RlTmF2RGF0YSAmJiB0aGlzLmRhdGFTb3VyY2UpIHtcbiAgICAgIGNvbnN0IGNsb25lZEFuY2VzdG9ycyA9IGNsb25lKHNlbGVjdGVkQW5jZXN0b3JJZHMpO1xuICAgICAgY2xvbmVkQW5jZXN0b3JzLnNoaWZ0KCk7XG5cbiAgICAgIGNvbnN0IG4gPSBhd2FpdCB0aGlzLmRhdGFTb3VyY2UudG9nZ2xlTm9kZSh0aGlzLmRhdGFTb3VyY2UuZGF0YVswXSwgdHJ1ZSk7XG4gICAgICB0aGlzLnNldENoaWxkTm9kZXMobi5jaGlsZHJlbiwgY2xvbmVkQW5jZXN0b3JzKTtcblxuICAgICAgdGhpcy50b2dnbGVGb2N1c2VkTm9kZShub2RlKTtcbiAgICB9XG4gIH1cblxuICBzZXRDaGlsZE5vZGVzKG5vZGVzOiBBZGRyZXNzU3BhY2VOb2RlW10sIGlkczogc3RyaW5nW10pIHtcbiAgICBpZiAobm9kZXMpIHtcbiAgICAgIGlkcy5mb3JFYWNoKGFzeW5jIGlkID0+IHtcbiAgICAgICAgY29uc3QgbWF0Y2ggPSBub2Rlcy5maW5kKG4gPT4gbi5ub2RlSWQgPT09IGlkKTtcbiAgICAgICAgaWYgKG1hdGNoICYmIGlkcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgY29uc3QgaWR4ID0gaWRzLmZpbmRJbmRleCh2YWx1ZSA9PiB2YWx1ZSA9PT0gaWQpO1xuICAgICAgICAgIGlmIChpZHggPj0gMCkge1xuICAgICAgICAgICAgaWRzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCB0b2dnbGVkTm9kZSA9IGF3YWl0IHRoaXMuZGF0YVNvdXJjZS50b2dnbGVOb2RlKG1hdGNoLCB0cnVlKTtcbiAgICAgICAgICB0aGlzLnNldENoaWxkTm9kZXModG9nZ2xlZE5vZGUuY2hpbGRyZW4sIGlkcyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNldHVwVHJlZShub2RlSWQ/OiBzdHJpbmcpIHtcbiAgICB0aGlzLmxvYWRpbmcgPSB0cnVlO1xuXG4gICAgaWYgKCF0aGlzLl9tb0lkIHx8IHRoaXMuX21vSWQubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLl9tb0lkID0gdGhpcy5vcGN1YVNlcnZpY2UuZ2V0TW9JZCgpO1xuICAgIH1cblxuICAgIC8vIGFkZHJlc3NTcGFjZVNlcnZpY2UuZ2V0Tm9kZSByZXR1cm5zIGVpdGhlciB0aGUgcm9vdCBub2RlIG9mIHRoZSBzZXJ2ZXIgKG1vSWQpXG4gICAgLy8gb3IgaWYgbm9kZUlkICE9PSB1bmRlZmluZWQgdGhlIG5vZGUgd2l0aCBnaXZlbiBub2RlSWRcbiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2UuZ2V0Tm9kZSh0aGlzLl9tb0lkLCBub2RlSWQpO1xuICAgIGlmIChyZXMpIHtcbiAgICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgY29uc3QgZGF0YSA9IHJlcy5qc29uID8gYXdhaXQgcmVzLmpzb24oKSA6IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZSh7IGRhdGEsIHJlcyB9KTtcbiAgICAgICAgdGhpcy5kYXRhU291cmNlID0gdW5kZWZpbmVkO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3Qgcm9vdE5vZGUgPSAoYXdhaXQgcmVzLmpzb24oKSkgYXMgQWRkcmVzc1NwYWNlTm9kZTtcbiAgICAgICAgdGhpcy5uZXN0ZWRUcmVlQ29udHJvbCA9IG5ldyBOZXN0ZWRUcmVlQ29udHJvbDxBZGRyZXNzU3BhY2VOb2RlPih0aGlzLmdldENoaWxkcmVuKTtcbiAgICAgICAgdGhpcy5kYXRhU291cmNlID0gbmV3IER5bmFtaWNEYXRhU291cmNlKFxuICAgICAgICAgIHRoaXMubmVzdGVkVHJlZUNvbnRyb2wsXG4gICAgICAgICAgdGhpcy5hZGRyZXNzU3BhY2VTZXJ2aWNlLFxuICAgICAgICAgIHRoaXMuX21vSWRcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5kYXRhU291cmNlLmRhdGEgPSBbcm9vdE5vZGVdO1xuICAgICAgfVxuICAgICAgdGhpcy5sb2FkaW5nID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubG9hZGluZyA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIGdldE1vSWQoKSB7XG4gICAgaWYgKCF0aGlzLl9tb0lkIHx8IHRoaXMuX21vSWQubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gdGhpcy5vcGN1YVNlcnZpY2UuZ2V0TW9JZCgpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fbW9JZDtcbiAgfVxuXG4gIGdldEljb24obm9kZUNsYXNzTmFtZSkge1xuICAgIHJldHVybiB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2UuZ2V0SWNvbihub2RlQ2xhc3NOYW1lKTtcbiAgfVxuXG4gIHRvZ2dsZUZvY3VzZWROb2RlKG5vZGUpIHtcbiAgICBjb25zdCByZWxhdGl2ZVBhdGggPSBbXTtcbiAgICB0aGlzLmdldFJlbGF0aXZlUGF0aChub2RlLCByZWxhdGl2ZVBhdGgpO1xuICAgIG5vZGUucmVsYXRpdmVQYXRoID0gcmVsYXRpdmVQYXRoO1xuXG4gICAgdGhpcy5zZWxlY3RlZE5vZGUuZW1pdChub2RlKTtcbiAgICB0aGlzLmZvY3VzZWQgPSB0aGlzLmlzRm9jdXNlZE5vZGUobm9kZSkgPyB1bmRlZmluZWQgOiBub2RlO1xuICB9XG5cbiAgaXNGb2N1c2VkTm9kZShub2RlOiBBZGRyZXNzU3BhY2VOb2RlKSB7XG4gICAgaWYgKHRoaXMuZm9jdXNlZCkge1xuICAgICAgcmV0dXJuIG5vZGUubm9kZUlkID09PSB0aGlzLmZvY3VzZWQubm9kZUlkO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGdldFJlbGF0aXZlUGF0aChub2RlOiBBZGRyZXNzU3BhY2VOb2RlLCByZWxhdGl2ZVBhdGg6IHN0cmluZ1tdKSB7XG4gICAgaWYgKG5vZGUucGFyZW50Tm9kZSkge1xuICAgICAgcmVsYXRpdmVQYXRoLnVuc2hpZnQobm9kZS5icm93c2VOYW1lKTtcbiAgICAgIHRoaXMuZ2V0UmVsYXRpdmVQYXRoKG5vZGUucGFyZW50Tm9kZSwgcmVsYXRpdmVQYXRoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==