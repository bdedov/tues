import * as tslib_1 from "tslib";
import { Component, Output, EventEmitter, Input } from '@angular/core';
import { ControlContainer, NgForm } from '@angular/forms';
import { LoginService } from '../login/login.service';
import { UserService, ICredentials } from '@c8y/client';
import { AlertService } from '../alert/alert.service';
var TotpChallengeComponent = /** @class */ (function () {
    function TotpChallengeComponent(loginService, users, alert) {
        this.loginService = loginService;
        this.users = users;
        this.alert = alert;
        /**
         * Calls the verify endpoint if set to true (default true)
         */
        this.verify = true;
        /**
         * Emits the token on success.
         */
        this.onSuccess = new EventEmitter();
        this.model = {
            token: ''
        };
        this.loading = false;
        this.hasError = false;
    }
    TotpChallengeComponent.prototype.verifyCode = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var e_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 3, , 4]);
                        this.loading = true;
                        this.hasError = false;
                        if (!this.verify) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.users.verifyTotpCode(this.model.token)];
                    case 1:
                        _a.sent();
                        _a.label = 2;
                    case 2:
                        this.onSuccess.emit(this.model.token);
                        return [3 /*break*/, 4];
                    case 3:
                        e_1 = _a.sent();
                        this.hasError = true;
                        this.alert.removeLastDanger();
                        this.loading = false;
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    TotpChallengeComponent.ctorParameters = function () { return [
        { type: LoginService },
        { type: UserService },
        { type: AlertService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], TotpChallengeComponent.prototype, "verify", void 0);
    tslib_1.__decorate([
        Output()
    ], TotpChallengeComponent.prototype, "onSuccess", void 0);
    tslib_1.__decorate([
        Input()
    ], TotpChallengeComponent.prototype, "loading", void 0);
    tslib_1.__decorate([
        Input()
    ], TotpChallengeComponent.prototype, "hasError", void 0);
    TotpChallengeComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-totp-challenge',
            template: "<form\n  #totpForm=\"ngForm\"\n  role=\"form\"\n  class=\"loginForm\"\n  (ngSubmit)=\"verifyCode()\"\n  novalidate\n>\n\n  <c8y-form-group\n    [hasError]=\"hasError\"\n    [novalidation]=\"true\"\n  >\n    <label\n      translate\n      for=\"totpToken\"\n    >Verification code</label>\n    <input\n      id=\"totpToken\"\n      [(ngModel)]=\"model.token\"\n      name=\"totpToken\"\n      type=\"text\"\n      autocapitalize=\"off\"\n      autocorrect=\"off\"\n      autocomplete=\"off\"\n      class=\"form-control\"\n      placeholder=\"{{'Verification code' | translate}}\"\n      required\n    >\n    <c8y-messages>\n      <c8y-message *ngIf=\"hasError\" translate>\n        Invalid verification code. In case of key loss, please contact your platform administrator.\n      </c8y-message>\n    </c8y-messages>\n    <p id=\"helpinput\" *ngIf=\"!hasError\" class=\"help-block\" translate>\n      In case of key loss, please contact your platform administrator.\n    </p>\n  </c8y-form-group>\n\n  <button\n    title=\"{{ 'Verify' | translate }}\" \n    [disabled]=\"!totpForm.form.valid || loading\"\n    type=\"submit\"\n    class=\"btn btn-primary btn-lg btn-block form-group\"\n    translate\n  >Verify</button>\n\n</form>\n",
            viewProviders: [{ provide: ControlContainer, useExisting: NgForm }]
        })
    ], TotpChallengeComponent);
    return TotpChallengeComponent;
}());
export { TotpChallengeComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG90cC1jaGFsbGVuZ2UuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImNvcmUvYXV0aGVudGljYXRpb24vdG90cC1jaGFsbGVuZ2UuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXZFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxZQUFZLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDeEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBU3REO0lBa0JFLGdDQUNTLFlBQTBCLEVBQ3pCLEtBQWtCLEVBQ2xCLEtBQW1CO1FBRnBCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQ3pCLFVBQUssR0FBTCxLQUFLLENBQWE7UUFDbEIsVUFBSyxHQUFMLEtBQUssQ0FBYztRQXBCN0I7O1dBRUc7UUFDTSxXQUFNLEdBQUcsSUFBSSxDQUFDO1FBQ3ZCOztXQUVHO1FBQ08sY0FBUyxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFFekMsVUFBSyxHQUFHO1lBQ04sS0FBSyxFQUFFLEVBQUU7U0FDVixDQUFDO1FBRUYsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUVoQixhQUFRLEdBQUcsS0FBSyxDQUFDO0lBTWQsQ0FBQztJQUVFLDJDQUFVLEdBQWhCOzs7Ozs7O3dCQUVJLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO3dCQUNwQixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQzs2QkFDbEIsSUFBSSxDQUFDLE1BQU0sRUFBWCx3QkFBVzt3QkFDYixxQkFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFBOzt3QkFBakQsU0FBaUQsQ0FBQzs7O3dCQUVwRCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDOzs7O3dCQUV0QyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQzt3QkFDckIsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO3dCQUM5QixJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQzs7Ozs7O0tBRXhCOztnQkFsQnNCLFlBQVk7Z0JBQ2xCLFdBQVc7Z0JBQ1gsWUFBWTs7SUFqQnBCO1FBQVIsS0FBSyxFQUFFOzBEQUFlO0lBSWI7UUFBVCxNQUFNLEVBQUU7NkRBQWdDO0lBTXpDO1FBREMsS0FBSyxFQUFFOzJEQUNRO0lBRWhCO1FBREMsS0FBSyxFQUFFOzREQUNTO0lBaEJOLHNCQUFzQjtRQU5sQyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsb0JBQW9CO1lBQzlCLDR0Q0FBOEM7WUFDOUMsYUFBYSxFQUFFLENBQUUsRUFBRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxDQUFFO1NBQ3RFLENBQUM7T0FFVyxzQkFBc0IsQ0FzQ2xDO0lBQUQsNkJBQUM7Q0FBQSxBQXRDRCxJQXNDQztTQXRDWSxzQkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE91dHB1dCwgRXZlbnRFbWl0dGVyLCBJbnB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTmV3UGFzc3dvcmQgfSBmcm9tICcuL3Bhc3N3b3JkLm1vZGVsJztcbmltcG9ydCB7IENvbnRyb2xDb250YWluZXIsIE5nRm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IExvZ2luU2VydmljZSB9IGZyb20gJy4uL2xvZ2luL2xvZ2luLnNlcnZpY2UnO1xuaW1wb3J0IHsgVXNlclNlcnZpY2UsIElDcmVkZW50aWFscyB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSB9IGZyb20gJy4uL2FsZXJ0L2FsZXJ0LnNlcnZpY2UnO1xuaW1wb3J0IHsgTG9naW5WaWV3cyB9IGZyb20gJy4uL2xvZ2luL2xvZ2luLm1vZGVsJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXRvdHAtY2hhbGxlbmdlJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3RvdHAtY2hhbGxlbmdlLmNvbXBvbmVudC5odG1sJyxcbiAgdmlld1Byb3ZpZGVyczogWyB7IHByb3ZpZGU6IENvbnRyb2xDb250YWluZXIsIHVzZUV4aXN0aW5nOiBOZ0Zvcm0gfSBdXG59KVxuXG5leHBvcnQgY2xhc3MgVG90cENoYWxsZW5nZUNvbXBvbmVudCB7XG4gIC8qKlxuICAgKiBDYWxscyB0aGUgdmVyaWZ5IGVuZHBvaW50IGlmIHNldCB0byB0cnVlIChkZWZhdWx0IHRydWUpXG4gICAqL1xuICBASW5wdXQoKSB2ZXJpZnkgPSB0cnVlO1xuICAvKipcbiAgICogRW1pdHMgdGhlIHRva2VuIG9uIHN1Y2Nlc3MuXG4gICAqL1xuICBAT3V0cHV0KCkgb25TdWNjZXNzID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIG1vZGVsID0ge1xuICAgIHRva2VuOiAnJ1xuICB9O1xuICBASW5wdXQoKVxuICBsb2FkaW5nID0gZmFsc2U7XG4gIEBJbnB1dCgpXG4gIGhhc0Vycm9yID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGxvZ2luU2VydmljZTogTG9naW5TZXJ2aWNlLFxuICAgIHByaXZhdGUgdXNlcnM6IFVzZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWxlcnQ6IEFsZXJ0U2VydmljZVxuICApIHt9XG5cbiAgYXN5bmMgdmVyaWZ5Q29kZSgpIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5sb2FkaW5nID0gdHJ1ZTtcbiAgICAgIHRoaXMuaGFzRXJyb3IgPSBmYWxzZTtcbiAgICAgIGlmICh0aGlzLnZlcmlmeSkge1xuICAgICAgICBhd2FpdCB0aGlzLnVzZXJzLnZlcmlmeVRvdHBDb2RlKHRoaXMubW9kZWwudG9rZW4pO1xuICAgICAgfVxuICAgICAgdGhpcy5vblN1Y2Nlc3MuZW1pdCh0aGlzLm1vZGVsLnRva2VuKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aGlzLmhhc0Vycm9yID0gdHJ1ZTtcbiAgICAgIHRoaXMuYWxlcnQucmVtb3ZlTGFzdERhbmdlcigpO1xuICAgICAgdGhpcy5sb2FkaW5nID0gZmFsc2U7XG4gICAgfVxuICB9XG59XG4iXX0=