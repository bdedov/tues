import * as tslib_1 from "tslib";
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { IUser, UserService, TenantLoginOptionsService, TenantService } from '@c8y/client';
import { clone } from 'lodash-es';
import { AppStateService } from '../common/ui-state.service';
import { TranslateService } from '../i18n/translate.service';
import { BsModalService } from 'ngx-bootstrap/modal';
import { PasswordService } from '../authentication/password.service';
import { UserTotpSetupComponent } from './user-totp-setup.component';
import { AlertService } from '../alert/alert.service';
import { ModalService } from '../modal/modal.service';
var UserEditComponent = /** @class */ (function () {
    function UserEditComponent(state, translate, passwordService, modalConfirmService, bsModalService, alert, userService, tenantLoginOptionsService, tenantService) {
        this.state = state;
        this.translate = translate;
        this.passwordService = passwordService;
        this.modalConfirmService = modalConfirmService;
        this.bsModalService = bsModalService;
        this.alert = alert;
        this.userService = userService;
        this.tenantLoginOptionsService = tenantLoginOptionsService;
        this.tenantService = tenantService;
        this.loading = false;
        this.onUser = new EventEmitter();
        this.onLanguage = new EventEmitter();
        this.onCancel = new EventEmitter();
        this.userHasActiveTotp = false;
        this.userCanSetupTotp = false;
        this.isPhoneRequired = false;
    }
    Object.defineProperty(UserEditComponent.prototype, "user", {
        get: function () { return this._user; },
        set: function (u) {
            this._user = clone(u);
            this.userIsExternal = u.customProperties.userOrigin === 'OAUTH2';
            this.isPhoneRequired = this.isPhoneRequired && u.twoFactorAuthenticationEnabled;
        },
        enumerable: true,
        configurable: true
    });
    UserEditComponent.prototype.ngOnInit = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var currentTenant, _a, enabledOnSystemLevel, enabledOnTenantLevel;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0: return [4 /*yield*/, this.tenantService.current()];
                    case 1:
                        currentTenant = (_b.sent()).data;
                        return [4 /*yield*/, this.tenantService.getTfaSettings(currentTenant)];
                    case 2:
                        _a = _b.sent(), enabledOnSystemLevel = _a.enabledOnSystemLevel, enabledOnTenantLevel = _a.enabledOnTenantLevel;
                        this.isTfaEnabled = enabledOnSystemLevel || enabledOnTenantLevel;
                        return [4 /*yield*/, this.initializeTotpSettings()];
                    case 3:
                        _b.sent();
                        if (this.user.twoFactorAuthenticationEnabled && !this.userCanSetupTotp) {
                            this.isPhoneRequired = true;
                        }
                        return [2 /*return*/];
                }
            });
        });
    };
    Object.defineProperty(UserEditComponent.prototype, "langs", {
        get: function () {
            return this.state.state.langs;
        },
        enumerable: true,
        configurable: true
    });
    UserEditComponent.prototype.setupTotp = function () {
        this.bsModalService.show(UserTotpSetupComponent, { class: 'modal-sm' });
        this.cancel(); // to close the user edit modal and prevent console errors on logout
    };
    UserEditComponent.prototype.cancel = function () {
        this.onCancel.emit();
    };
    UserEditComponent.prototype.save = function () {
        if (!this.loading) {
            this._user.password ? this.saveAfterPasswordConfirmation() : this.onUser.emit(this._user);
        }
    };
    UserEditComponent.prototype.onNewPasswordChanged = function (newPassword) {
        this._user.password = newPassword.password;
    };
    UserEditComponent.prototype.initializeTotpSettings = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a, totpActivity, ex_1;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        _b.trys.push([0, 4, , 5]);
                        _a = this;
                        return [4 /*yield*/, this.canUserSetupTotp()];
                    case 1:
                        _a.userCanSetupTotp = _b.sent();
                        if (!this.userCanSetupTotp) return [3 /*break*/, 3];
                        return [4 /*yield*/, this.userService.getActivityTotp()];
                    case 2:
                        totpActivity = (_b.sent()).data;
                        this.userHasActiveTotp = totpActivity.isActive;
                        _b.label = 3;
                    case 3: return [3 /*break*/, 5];
                    case 4:
                        ex_1 = _b.sent();
                        this.alert.removeLastDanger();
                        return [3 /*break*/, 5];
                    case 5: return [2 /*return*/];
                }
            });
        });
    };
    UserEditComponent.prototype.canUserSetupTotp = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var loginOptions;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.tenantLoginOptionsService.detail()];
                    case 1:
                        loginOptions = (_a.sent()).data.loginOptions;
                        return [2 /*return*/, loginOptions.some(function (_a) {
                                var _b = _a.tfaStrategy, tfaStrategy = _b === void 0 ? '' : _b;
                                return tfaStrategy.toLowerCase() === 'totp';
                            })];
                }
            });
        });
    };
    UserEditComponent.prototype.saveAfterPasswordConfirmation = function () {
        var _this = this;
        this.passwordService.confirmPassword().subscribe(function (confirmed) {
            if (confirmed) {
                _this.onUser.emit(_this._user);
            }
        });
    };
    UserEditComponent.ctorParameters = function () { return [
        { type: AppStateService },
        { type: TranslateService },
        { type: PasswordService },
        { type: ModalService },
        { type: BsModalService },
        { type: AlertService },
        { type: UserService },
        { type: TenantLoginOptionsService },
        { type: TenantService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], UserEditComponent.prototype, "lang", void 0);
    tslib_1.__decorate([
        Input()
    ], UserEditComponent.prototype, "loading", void 0);
    tslib_1.__decorate([
        Input()
    ], UserEditComponent.prototype, "user", null);
    tslib_1.__decorate([
        Output()
    ], UserEditComponent.prototype, "onUser", void 0);
    tslib_1.__decorate([
        Output()
    ], UserEditComponent.prototype, "onLanguage", void 0);
    tslib_1.__decorate([
        Output()
    ], UserEditComponent.prototype, "onCancel", void 0);
    UserEditComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-user-edit',
            template: "<form #userForm=\"ngForm\" (ngSubmit)=\"userForm.form.valid && save()\">\n  <div class=\"alert alert-warning\" role=\"alert\" *ngIf=\"userIsExternal\" translate>\n    You cannot edit the user since it is managed via your authorization server.\n  </div>\n  <c8y-form-group>\n    <label translate for=\"userName\">Username (e.g. email)</label>\n    <input\n      id=\"userName\"\n      class=\"form-control\"\n      [(ngModel)]=\"user.userName\"\n      name=\"userName\"\n      autocomplete=\"off\"\n      required\n      maxlength=\"254\"\n      placeholder=\"{{ 'e.g. joe.doe@example.com`LOCALIZE`' | translate }}\"\n      [disabled]=\"user.id\"\n      c8yDefaultValidation=\"user\"\n    />\n  </c8y-form-group>\n\n  <c8y-form-group>\n    <label translate for=\"displayName\">Login alias</label>\n    <input\n      id=\"displayName\"\n      class=\"form-control\"\n      [(ngModel)]=\"user.displayName\"\n      name=\"displayName\"\n      autocomplete=\"off\"\n      maxlength=\"254\"\n      placeholder=\"{{ 'e.g. joe.doe`LOCALIZE`' | translate }}\"\n      [disabled]=\"userIsExternal\"\n      c8yDefaultValidation=\"loginAlias\"\n    />\n  </c8y-form-group>\n\n  <c8y-form-group [hasWarning]=\"!user.email\">\n    <label translate for=\"userEmail\">Email</label>\n    <input\n      id=\"userEmail\"\n      class=\"form-control\"\n      type=\"email\"\n      name=\"email\"\n      [maxlength]=\"254\"\n      autocomplete=\"off\"\n      placeholder=\"{{ 'e.g. joe.doe@example.com`LOCALIZE`' | translate }}\"\n      [(ngModel)]=\"user.email\"\n      email\n      [required]=\"user.newsletter\"\n      [disabled]=\"userIsExternal\"\n    />\n    <c8y-messages>\n      <c8y-message *ngIf=\"!user.email\" translate\n        >Note that email is required to reset password.</c8y-message\n      >\n    </c8y-messages>\n  </c8y-form-group>\n\n  <div class=\"row\" style=\"margin-left:-15px; margin-right:-15px\">\n    <div class=\"col-sm-6\">\n      <c8y-form-group>\n        <label translate for=\"userFirstName\">First name</label>\n        <input\n          id=\"userFirstName\"\n          class=\"form-control\"\n          autocomplete=\"off\"\n          maxlength=\"50\"\n          name=\"firstName\"\n          [(ngModel)]=\"user.firstName\"\n          [disabled]=\"userIsExternal\"\n        />\n      </c8y-form-group>\n    </div>\n    <div class=\"col-sm-6\">\n      <c8y-form-group>\n        <label translate for=\"userLastName\">Last name</label>\n        <input\n          id=\"userLastName\"\n          class=\"form-control\"\n          autocomplete=\"off\"\n          maxlength=\"50\"\n          name=\"lastName\"\n          [(ngModel)]=\"user.lastName\"\n          [disabled]=\"userIsExternal\"\n        />\n      </c8y-form-group>\n    </div>\n  </div>\n\n  <c8y-form-group>\n    <label translate for=\"userTelephone\">Telephone</label>\n    <input\n      id=\"userTelephone\"\n      class=\"form-control\"\n      autocomplete=\"off\"\n      name=\"phone\"\n      maxlength=\"254\"\n      [(ngModel)]=\"user.phone\"\n      placeholder=\"{{ 'e.g. +49 9 876 543 210`LOCALIZE`' | translate }}\"\n      c8yPhoneValidation\n      c8yDefaultValidation=\"phoneNumber\"\n      [required]=\"isPhoneRequired\"\n      [disabled]=\"userIsExternal\"\n    />\n  </c8y-form-group>\n\n  <c8y-form-group>\n    <label translate for=\"userLang\">Language</label>\n    <div class=\"c8y-select-wrapper\">\n      <select\n        id=\"userLang\"\n        class=\"form-control\"\n        #selectLang\n        name=\"lang\"\n        [(ngModel)]=\"lang\"\n        (change)=\"onLanguage.emit(selectLang.value)\"\n        [disabled]=\"userIsExternal\"\n      >\n        <option *ngFor=\"let lang of langs\" [value]=\"lang\">{{\n          translate.getNativeLanguage(lang)\n        }}</option>\n      </select>\n      <span></span>\n    </div>\n  </c8y-form-group>\n\n  <div class=\"form-group\" *ngIf=\"!userIsExternal\">\n    <label class=\"control-label\">{{ 'Login options' | translate }}</label>\n    <c8y-new-password (password)=\"onNewPasswordChanged($event)\"></c8y-new-password>\n    <button\n      title=\"{{ 'Set up two-factor authentication' | translate }}\"\n      class=\"btn btn-default\"\n      type=\"button\"\n      (click)=\"setupTotp()\"\n      *ngIf=\"userCanSetupTotp && !userHasActiveTotp && isTfaEnabled\"\n    >\n      {{ 'Set up two-factor authentication' | translate }}\n    </button>\n  </div>\n\n  <c8y-form-group *ngIf=\"!!(state.state$ | async).newsletter\">\n    <label translate>Newsletter</label>\n    <label\n      title=\"{{ 'Send me information about outages, maintenance or updates.' | translate }}\"\n      class=\"c8y-checkbox\"\n    >\n      <input\n        type=\"checkbox\"\n        name=\"newsletter\"\n        [(ngModel)]=\"user.newsletter\"\n        [disabled]=\"userIsExternal\"\n      />\n      <span></span>\n      <span>\n        {{ 'Send me information about outages, maintenance or updates.' | translate }}\n      </span>\n    </label>\n  </c8y-form-group>\n\n  <div class=\"modal-footer\">\n    <button\n      title=\"{{ 'Cancel' | translate }}\"\n      class=\"btn btn-default\"\n      type=\"button\"\n      (click)=\"cancel()\"\n    >\n      {{ 'Cancel' | translate }}\n    </button>\n    <button\n      title=\"{{ 'Save' | translate }}\"\n      class=\"btn btn-primary\"\n      type=\"submit\"\n      [disabled]=\"!userForm.form.valid || userForm.form.pristine || loading || userIsExternal\"\n    >\n      {{ 'Save' | translate }}\n    </button>\n  </div>\n</form>\n"
        })
    ], UserEditComponent);
    return UserEditComponent;
}());
export { UserEditComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci1lZGl0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL3VzZXIvdXNlci1lZGl0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBVSxNQUFNLGVBQWUsQ0FBQztBQUMvRSxPQUFPLEVBQ0wsS0FBSyxFQUNMLFdBQVcsRUFDWCx5QkFBeUIsRUFDekIsYUFBYSxFQUNkLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbEMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzdELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBRTdELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDckUsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDckUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3RELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQVl0RDtJQW1CRSwyQkFDUyxLQUFzQixFQUN0QixTQUEyQixFQUMzQixlQUFnQyxFQUNoQyxtQkFBaUMsRUFDaEMsY0FBOEIsRUFDOUIsS0FBbUIsRUFDbkIsV0FBd0IsRUFDeEIseUJBQW9ELEVBQ3BELGFBQTRCO1FBUjdCLFVBQUssR0FBTCxLQUFLLENBQWlCO1FBQ3RCLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQzNCLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUNoQyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQWM7UUFDaEMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLFVBQUssR0FBTCxLQUFLLENBQWM7UUFDbkIsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFDeEIsOEJBQXlCLEdBQXpCLHlCQUF5QixDQUEyQjtRQUNwRCxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQTFCN0IsWUFBTyxHQUFZLEtBQUssQ0FBQztRQU94QixXQUFNLEdBQXVCLElBQUksWUFBWSxFQUFFLENBQUM7UUFDaEQsZUFBVSxHQUF5QixJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ3RELGFBQVEsR0FBdUIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUM1RCxzQkFBaUIsR0FBRyxLQUFLLENBQUM7UUFDMUIscUJBQWdCLEdBQUcsS0FBSyxDQUFDO1FBQ3pCLG9CQUFlLEdBQUcsS0FBSyxDQUFDO0lBZXJCLENBQUM7SUExQkssc0JBQUksbUNBQUk7YUFLakIsY0FBYSxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2FBTHhCLFVBQVMsQ0FBTztZQUN2QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN0QixJQUFJLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEtBQUssUUFBUSxDQUFDO1lBQ2pFLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsSUFBSSxDQUFDLENBQUMsOEJBQThCLENBQUM7UUFDbEYsQ0FBQzs7O09BQUE7SUF3Qkssb0NBQVEsR0FBZDs7Ozs7NEJBQ3lCLHFCQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLEVBQUE7O3dCQUFuRCxhQUFhLEdBQUcsQ0FBQyxTQUFrQyxDQUFDLENBQUMsSUFBSTt3QkFDUixxQkFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsRUFBQTs7d0JBQXZHLEtBQWlELFNBQXNELEVBQXJHLG9CQUFvQiwwQkFBQSxFQUFFLG9CQUFvQiwwQkFBQTt3QkFDbEQsSUFBSSxDQUFDLFlBQVksR0FBRyxvQkFBb0IsSUFBSSxvQkFBb0IsQ0FBQzt3QkFFakUscUJBQU0sSUFBSSxDQUFDLHNCQUFzQixFQUFFLEVBQUE7O3dCQUFuQyxTQUFtQyxDQUFDO3dCQUNwQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsOEJBQThCLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7NEJBQ3RFLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO3lCQUM3Qjs7Ozs7S0FDRjtJQUVELHNCQUFJLG9DQUFLO2FBQVQ7WUFDRSxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztRQUNoQyxDQUFDOzs7T0FBQTtJQUVELHFDQUFTLEdBQVQ7UUFDRSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBQ3hFLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLG9FQUFvRTtJQUNyRixDQUFDO0lBRUQsa0NBQU0sR0FBTjtRQUNFLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVELGdDQUFJLEdBQUo7UUFDRSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNqQixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLDZCQUE2QixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUMzRjtJQUNILENBQUM7SUFFRCxnREFBb0IsR0FBcEIsVUFBcUIsV0FBd0I7UUFDM0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQztJQUM3QyxDQUFDO0lBRWEsa0RBQXNCLEdBQXBDOzs7Ozs7O3dCQUVJLEtBQUEsSUFBSSxDQUFBO3dCQUFvQixxQkFBTSxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsRUFBQTs7d0JBQXJELEdBQUssZ0JBQWdCLEdBQUcsU0FBNkIsQ0FBQzs2QkFDbEQsSUFBSSxDQUFDLGdCQUFnQixFQUFyQix3QkFBcUI7d0JBQ1EscUJBQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxlQUFlLEVBQUUsRUFBQTs7d0JBQXpELFlBQVksR0FBSyxDQUFBLFNBQXdDLENBQUEsS0FBN0M7d0JBQzFCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxZQUFZLENBQUMsUUFBUSxDQUFDOzs7Ozt3QkFHakQsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDOzs7Ozs7S0FFakM7SUFFYSw0Q0FBZ0IsR0FBOUI7Ozs7OzRCQUU0QixxQkFBTSxJQUFJLENBQUMseUJBQXlCLENBQUMsTUFBTSxFQUFFLEVBQUE7O3dCQUEvRCxZQUFZLEdBQUssQ0FBQyxTQUE2QyxDQUFDLENBQUMsSUFBSSxhQUF6RDt3QkFDcEIsc0JBQU8sWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFDLEVBQW9CO29DQUFsQixtQkFBZ0IsRUFBaEIscUNBQWdCO2dDQUFRLE9BQUEsV0FBVyxDQUFDLFdBQVcsRUFBRSxLQUFLLE1BQU07NEJBQXBDLENBQW9DLENBQUMsRUFBQzs7OztLQUMzRjtJQUVPLHlEQUE2QixHQUFyQztRQUFBLGlCQU1DO1FBTEMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxTQUFTLENBQUMsVUFBQyxTQUFTO1lBQ3pELElBQUksU0FBUyxFQUFFO2dCQUNiLEtBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUM5QjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQzs7Z0JBckVlLGVBQWU7Z0JBQ1gsZ0JBQWdCO2dCQUNWLGVBQWU7Z0JBQ1gsWUFBWTtnQkFDaEIsY0FBYztnQkFDdkIsWUFBWTtnQkFDTixXQUFXO2dCQUNHLHlCQUF5QjtnQkFDckMsYUFBYTs7SUEzQjdCO1FBQVIsS0FBSyxFQUFFO21EQUFjO0lBQ2I7UUFBUixLQUFLLEVBQUU7c0RBQTBCO0lBQ3pCO1FBQVIsS0FBSyxFQUFFO2lEQUlQO0lBRVM7UUFBVCxNQUFNLEVBQUU7cURBQWlEO0lBQ2hEO1FBQVQsTUFBTSxFQUFFO3lEQUF1RDtJQUN0RDtRQUFULE1BQU0sRUFBRTt1REFBbUQ7SUFYakQsaUJBQWlCO1FBSjdCLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxlQUFlO1lBQ3pCLHk0S0FBeUM7U0FDMUMsQ0FBQztPQUNXLGlCQUFpQixDQTBGN0I7SUFBRCx3QkFBQztDQUFBLEFBMUZELElBMEZDO1NBMUZZLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyLCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIElVc2VyLFxuICBVc2VyU2VydmljZSxcbiAgVGVuYW50TG9naW5PcHRpb25zU2VydmljZSxcbiAgVGVuYW50U2VydmljZVxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBjbG9uZSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBBcHBTdGF0ZVNlcnZpY2UgfSBmcm9tICcuLi9jb21tb24vdWktc3RhdGUuc2VydmljZSc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vaTE4bi90cmFuc2xhdGUuc2VydmljZSc7XG5pbXBvcnQgeyBOZXdQYXNzd29yZCB9IGZyb20gJy4uL2F1dGhlbnRpY2F0aW9uL3Bhc3N3b3JkLm1vZGVsJztcbmltcG9ydCB7IEJzTW9kYWxTZXJ2aWNlIH0gZnJvbSAnbmd4LWJvb3RzdHJhcC9tb2RhbCc7XG5pbXBvcnQgeyBQYXNzd29yZFNlcnZpY2UgfSBmcm9tICcuLi9hdXRoZW50aWNhdGlvbi9wYXNzd29yZC5zZXJ2aWNlJztcbmltcG9ydCB7IFVzZXJUb3RwU2V0dXBDb21wb25lbnQgfSBmcm9tICcuL3VzZXItdG90cC1zZXR1cC5jb21wb25lbnQnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlIH0gZnJvbSAnLi4vYWxlcnQvYWxlcnQuc2VydmljZSc7XG5pbXBvcnQgeyBNb2RhbFNlcnZpY2UgfSBmcm9tICcuLi9tb2RhbC9tb2RhbC5zZXJ2aWNlJztcblxuZXhwb3J0IGludGVyZmFjZSBVc2VyIGV4dGVuZHMgSVVzZXIge1xuICBwaG9uZTogc3RyaW5nO1xuICBzZW5kUGFzc3dvcmRSZXNldEVtYWlsOiBib29sZWFuO1xuICBuZXdzbGV0dGVyPzogYm9vbGVhbjtcbn1cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXVzZXItZWRpdCcsXG4gIHRlbXBsYXRlVXJsOiAnLi91c2VyLWVkaXQuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFVzZXJFZGl0Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgQElucHV0KCkgbGFuZzogc3RyaW5nO1xuICBASW5wdXQoKSBsb2FkaW5nOiBib29sZWFuID0gZmFsc2U7XG4gIEBJbnB1dCgpIHNldCB1c2VyKHU6IFVzZXIpIHtcbiAgICB0aGlzLl91c2VyID0gY2xvbmUodSk7XG4gICAgdGhpcy51c2VySXNFeHRlcm5hbCA9IHUuY3VzdG9tUHJvcGVydGllcy51c2VyT3JpZ2luID09PSAnT0FVVEgyJztcbiAgICB0aGlzLmlzUGhvbmVSZXF1aXJlZCA9IHRoaXMuaXNQaG9uZVJlcXVpcmVkICYmIHUudHdvRmFjdG9yQXV0aGVudGljYXRpb25FbmFibGVkO1xuICB9XG4gIGdldCB1c2VyKCkgeyByZXR1cm4gdGhpcy5fdXNlcjsgfVxuICBAT3V0cHV0KCkgb25Vc2VyOiBFdmVudEVtaXR0ZXI8VXNlcj4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBvbkxhbmd1YWdlOiBFdmVudEVtaXR0ZXI8c3RyaW5nPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpIG9uQ2FuY2VsOiBFdmVudEVtaXR0ZXI8dm9pZD4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIHVzZXJIYXNBY3RpdmVUb3RwID0gZmFsc2U7XG4gIHVzZXJDYW5TZXR1cFRvdHAgPSBmYWxzZTtcbiAgaXNQaG9uZVJlcXVpcmVkID0gZmFsc2U7XG4gIHVzZXJJc0V4dGVybmFsO1xuICBpc1RmYUVuYWJsZWQ6IGJvb2xlYW47XG4gIHByaXZhdGUgX3VzZXI6IFVzZXI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIHN0YXRlOiBBcHBTdGF0ZVNlcnZpY2UsXG4gICAgcHVibGljIHRyYW5zbGF0ZTogVHJhbnNsYXRlU2VydmljZSxcbiAgICBwdWJsaWMgcGFzc3dvcmRTZXJ2aWNlOiBQYXNzd29yZFNlcnZpY2UsXG4gICAgcHVibGljIG1vZGFsQ29uZmlybVNlcnZpY2U6IE1vZGFsU2VydmljZSxcbiAgICBwcml2YXRlIGJzTW9kYWxTZXJ2aWNlOiBCc01vZGFsU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0OiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSB1c2VyU2VydmljZTogVXNlclNlcnZpY2UsXG4gICAgcHJpdmF0ZSB0ZW5hbnRMb2dpbk9wdGlvbnNTZXJ2aWNlOiBUZW5hbnRMb2dpbk9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgdGVuYW50U2VydmljZTogVGVuYW50U2VydmljZSxcbiAgKSB7fVxuXG4gIGFzeW5jIG5nT25Jbml0KCkge1xuICAgIGNvbnN0IGN1cnJlbnRUZW5hbnQgPSAoYXdhaXQgdGhpcy50ZW5hbnRTZXJ2aWNlLmN1cnJlbnQoKSkuZGF0YTtcbiAgICBjb25zdCB7IGVuYWJsZWRPblN5c3RlbUxldmVsLCBlbmFibGVkT25UZW5hbnRMZXZlbCB9ID0gYXdhaXQgdGhpcy50ZW5hbnRTZXJ2aWNlLmdldFRmYVNldHRpbmdzKGN1cnJlbnRUZW5hbnQpO1xuICAgIHRoaXMuaXNUZmFFbmFibGVkID0gZW5hYmxlZE9uU3lzdGVtTGV2ZWwgfHwgZW5hYmxlZE9uVGVuYW50TGV2ZWw7XG5cbiAgICBhd2FpdCB0aGlzLmluaXRpYWxpemVUb3RwU2V0dGluZ3MoKTtcbiAgICBpZiAodGhpcy51c2VyLnR3b0ZhY3RvckF1dGhlbnRpY2F0aW9uRW5hYmxlZCAmJiAhdGhpcy51c2VyQ2FuU2V0dXBUb3RwKSB7XG4gICAgICB0aGlzLmlzUGhvbmVSZXF1aXJlZCA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgZ2V0IGxhbmdzKCkge1xuICAgIHJldHVybiB0aGlzLnN0YXRlLnN0YXRlLmxhbmdzO1xuICB9XG5cbiAgc2V0dXBUb3RwKCkge1xuICAgIHRoaXMuYnNNb2RhbFNlcnZpY2Uuc2hvdyhVc2VyVG90cFNldHVwQ29tcG9uZW50LCB7IGNsYXNzOiAnbW9kYWwtc20nIH0pO1xuICAgIHRoaXMuY2FuY2VsKCk7IC8vIHRvIGNsb3NlIHRoZSB1c2VyIGVkaXQgbW9kYWwgYW5kIHByZXZlbnQgY29uc29sZSBlcnJvcnMgb24gbG9nb3V0XG4gIH1cblxuICBjYW5jZWwoKSB7XG4gICAgdGhpcy5vbkNhbmNlbC5lbWl0KCk7XG4gIH1cblxuICBzYXZlKCkge1xuICAgIGlmICghdGhpcy5sb2FkaW5nKSB7XG4gICAgICB0aGlzLl91c2VyLnBhc3N3b3JkID8gdGhpcy5zYXZlQWZ0ZXJQYXNzd29yZENvbmZpcm1hdGlvbigpIDogdGhpcy5vblVzZXIuZW1pdCh0aGlzLl91c2VyKTtcbiAgICB9XG4gIH1cblxuICBvbk5ld1Bhc3N3b3JkQ2hhbmdlZChuZXdQYXNzd29yZDogTmV3UGFzc3dvcmQpIHtcbiAgICB0aGlzLl91c2VyLnBhc3N3b3JkID0gbmV3UGFzc3dvcmQucGFzc3dvcmQ7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGluaXRpYWxpemVUb3RwU2V0dGluZ3MoKSB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMudXNlckNhblNldHVwVG90cCA9IGF3YWl0IHRoaXMuY2FuVXNlclNldHVwVG90cCgpO1xuICAgICAgaWYgKHRoaXMudXNlckNhblNldHVwVG90cCkge1xuICAgICAgICBjb25zdCB7IGRhdGE6IHRvdHBBY3Rpdml0eSB9ID0gYXdhaXQgdGhpcy51c2VyU2VydmljZS5nZXRBY3Rpdml0eVRvdHAoKTtcbiAgICAgICAgdGhpcy51c2VySGFzQWN0aXZlVG90cCA9IHRvdHBBY3Rpdml0eS5pc0FjdGl2ZTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydC5yZW1vdmVMYXN0RGFuZ2VyKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjYW5Vc2VyU2V0dXBUb3RwKCkge1xuICAgIC8vIHdlIGRvbid0IGNoZWNrIGZvciB0ZW5hbnQgb3B0aW9ucyBoZXJlIGR1ZSB0byBwZXJtaXNzaW9uIHJlc3RyaWN0aW9ucyBvbiB0aGF0IGVuZC1wb2ludFxuICAgIGNvbnN0IHsgbG9naW5PcHRpb25zIH0gPSAoYXdhaXQgdGhpcy50ZW5hbnRMb2dpbk9wdGlvbnNTZXJ2aWNlLmRldGFpbCgpKS5kYXRhO1xuICAgIHJldHVybiBsb2dpbk9wdGlvbnMuc29tZSgoeyB0ZmFTdHJhdGVneSA9ICcnIH0pID0+ICB0ZmFTdHJhdGVneS50b0xvd2VyQ2FzZSgpID09PSAndG90cCcpO1xuICB9XG5cbiAgcHJpdmF0ZSBzYXZlQWZ0ZXJQYXNzd29yZENvbmZpcm1hdGlvbigpIHtcbiAgICB0aGlzLnBhc3N3b3JkU2VydmljZS5jb25maXJtUGFzc3dvcmQoKS5zdWJzY3JpYmUoKGNvbmZpcm1lZCkgPT4ge1xuICAgICAgaWYgKGNvbmZpcm1lZCkge1xuICAgICAgICB0aGlzLm9uVXNlci5lbWl0KHRoaXMuX3VzZXIpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG59XG4iXX0=