import * as tslib_1 from "tslib";
import { Component, Input } from '@angular/core';
import { TenantService, UserService } from '@c8y/client';
import { AlertService } from '../alert/alert.service';
import { AppStateService } from '../common/ui-state.service';
import { BsModalService } from 'ngx-bootstrap/modal';
import { LoginService } from '../login/login.service';
import { ModalService } from '../modal/modal.service';
import { OptionsService } from '../common/options.service';
import { Status } from '../common/status.model';
import { TranslateService } from '@ngx-translate/core';
import { UserEditModalComponent } from './user-edit-modal.component';
import { gettext } from '../i18n/gettext';
import { sortBy } from 'lodash-es';
var UserMenuOutletComponent = /** @class */ (function () {
    function UserMenuOutletComponent(ui, bsModalService, modalService, loginService, translateService, tenantService, alertService, user, optionsService) {
        this.ui = ui;
        this.bsModalService = bsModalService;
        this.modalService = modalService;
        this.loginService = loginService;
        this.translateService = translateService;
        this.tenantService = tenantService;
        this.alertService = alertService;
        this.user = user;
        this.optionsService = optionsService;
    }
    UserMenuOutletComponent.prototype.copyIt = function (text) {
        var handler = {
            handleEvent: function (e) {
                e.clipboardData.setData('text/plain', text);
                e.preventDefault();
            }
        };
        document.addEventListener('copy', handler);
        var copied;
        try {
            copied = document.execCommand('copy');
        }
        catch (e) {
            copied = false;
        }
        if (copied) {
            this.alertService.addByText('success', gettext('Copied to clipboard.'));
        }
        else {
            this.alertService.addByText('danger', gettext('Could not copy to clipboard.'));
        }
        document.removeEventListener('copy', handler);
    };
    UserMenuOutletComponent.prototype.editUser = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                this.bsModalService.show(UserEditModalComponent);
                return [2 /*return*/];
            });
        });
    };
    UserMenuOutletComponent.prototype.logout = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.loginService.logout()];
                    case 1:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    UserMenuOutletComponent.prototype.activateSupportAccess = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var title, companyName, textWithCompany, textWithoutCompany, finalQuestion, body, labels, successMsg, ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        title = gettext('Activate support user access');
                        companyName = this.optionsService.get('companyName', 'Cumulocity');
                        textWithCompany = gettext(
                        // tslint:disable-next-line:max-line-length
                        'You are about to allow a support user from {{companyName}} to access your tenant to help you with your issue.');
                        textWithoutCompany = gettext(
                        // tslint:disable-next-line:max-line-length
                        'You are about to allow a support user to access your tenant to help you with your issue.');
                        finalQuestion = gettext('Do you want to proceed?');
                        body = [
                            this.translateService.instant(companyName ? textWithCompany : textWithoutCompany, {
                                companyName: companyName
                            }),
                            this.translateService.instant(finalQuestion)
                        ].join(' ');
                        labels = {
                            ok: gettext('Activate access'),
                            cancel: gettext('Cancel')
                        };
                        successMsg = gettext('Support user access activated.');
                        _a.label = 1;
                    case 1:
                        _a.trys.push([1, 5, , 6]);
                        return [4 /*yield*/, this.modalService.confirm(title, body, Status.DANGER, labels)];
                    case 2:
                        _a.sent();
                        return [4 /*yield*/, this.tenantService.enableSupportUser()];
                    case 3:
                        _a.sent();
                        return [4 /*yield*/, this.refreshCurrentUser()];
                    case 4:
                        _a.sent();
                        this.alertService.success(successMsg);
                        return [3 /*break*/, 6];
                    case 5:
                        ex_1 = _a.sent();
                        return [3 /*break*/, 6];
                    case 6: return [2 /*return*/];
                }
            });
        });
    };
    UserMenuOutletComponent.prototype.deactivateSupportAccess = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var title, companyName, textWithCompany, textWithoutCompany, currentUser, isTenantAdmin, tenantAdminNote, finalQuestion, body, labels, successMsg, ex_2;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        title = gettext('Deactivate support user access');
                        companyName = this.optionsService.get('companyName', 'Cumulocity');
                        textWithCompany = gettext(
                        // tslint:disable-next-line:max-line-length
                        'You are about to block a support user from {{companyName}} from accessing your tenant to help you with your issue.');
                        textWithoutCompany = gettext(
                        // tslint:disable-next-line:max-line-length
                        'You are about to block a support user from accessing your tenant to help you with your issue.');
                        return [4 /*yield*/, this.user.current()];
                    case 1:
                        currentUser = (_a.sent()).data;
                        return [4 /*yield*/, this.user.hasRole(currentUser, 'ROLE_TENANT_ADMIN')];
                    case 2:
                        isTenantAdmin = _a.sent();
                        tenantAdminNote = gettext(
                        // tslint:disable-next-line:max-line-length
                        'Deactivating support access as tenant admin will disable all other support requests on your tenant.');
                        finalQuestion = gettext('Do you want to proceed?');
                        body = [
                            this.translateService.instant(companyName ? textWithCompany : textWithoutCompany, {
                                companyName: companyName
                            }),
                            isTenantAdmin ? this.translateService.instant(tenantAdminNote) : '',
                            this.translateService.instant(finalQuestion)
                        ]
                            .filter(Boolean)
                            .join(' ');
                        labels = {
                            ok: gettext('Deactivate access'),
                            cancel: gettext('Cancel')
                        };
                        successMsg = gettext('Support user access deactivated.');
                        _a.label = 3;
                    case 3:
                        _a.trys.push([3, 7, , 8]);
                        return [4 /*yield*/, this.modalService.confirm(title, body, Status.DANGER, labels)];
                    case 4:
                        _a.sent();
                        return [4 /*yield*/, this.tenantService.disableSupportUser()];
                    case 5:
                        _a.sent();
                        return [4 /*yield*/, this.refreshCurrentUser()];
                    case 6:
                        _a.sent();
                        this.alertService.success(successMsg);
                        return [3 /*break*/, 8];
                    case 7:
                        ex_2 = _a.sent();
                        return [3 /*break*/, 8];
                    case 8: return [2 /*return*/];
                }
            });
        });
    };
    UserMenuOutletComponent.prototype.getSortedItems = function () {
        return sortBy(Array.from(this.items), this.byPriority);
    };
    UserMenuOutletComponent.prototype.refreshCurrentUser = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var currentUserResult;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.user.current()];
                    case 1:
                        currentUserResult = _a.sent();
                        this.ui.currentUser.next(currentUserResult.data);
                        return [2 /*return*/];
                }
            });
        });
    };
    UserMenuOutletComponent.prototype.byPriority = function (item) {
        return -item.priority;
    };
    UserMenuOutletComponent.ctorParameters = function () { return [
        { type: AppStateService },
        { type: BsModalService },
        { type: ModalService },
        { type: LoginService },
        { type: TranslateService },
        { type: TenantService },
        { type: AlertService },
        { type: UserService },
        { type: OptionsService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], UserMenuOutletComponent.prototype, "items", void 0);
    UserMenuOutletComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-user-menu-outlet',
            template: "<div\n  dropdown\n  class=\"dropdown\"\n>\n  <button\n    class=\"main-header-button c8y-dropdown dropdown-toggle\"\n    dropdownToggle\n    style=\"white-space: nowrap\"\n  >\n    <span\n      class=\"hidden-xs text-truncate right-m\"\n      style=\"vertical-align: text-bottom; max-width: 104px; display: inline-block\"\n      title=\"{{ui.currentUser | async | shortenUserName}}\"\n    >\n      {{ui.currentUser | async | shortenUserName}}\n    </span>\n    <i\n      [c8yIcon]=\"'c8y-user'\"\n      class=\"fa-2x\"\n    ></i>\n  </button>\n  <ul\n    *dropdownMenu\n    class=\"dropdown-menu dropdown-menu-right\"\n    style=\"max-width: 240px;\"\n  >\n    <ng-container *ngFor=\"let item of getSortedItems()\">\n      <ng-container *ngIf=\"item.template\">\n        <ng-container *c8yOutlet=\"item.template\"></ng-container>\n      </ng-container>\n      <ng-container *ngIf=\"!item.template\">\n        <li (click)=\"item.click()\">\n          <a style=\"cursor: pointer\" [attr.href]=\"item.link\" [attr.target]=\"item.target\">\n            <i [c8yIcon]=\"item.icon\"></i>\n            {{item.label | translate}}\n          </a>\n        </li>\n      </ng-container>\n    </ng-container>\n    <li\n      *ngIf=\"!(ui.state$ | async).hidePowered\"\n      role=\"separator\"\n      class=\"divider\"\n    ></li>\n    <li\n      class=\"dropdown-header bg-gray-white\"\n      style=\"white-space: normal; margin-top: -1px;\"\n      *ngIf=\"!(ui.state$ | async).hidePowered\"\n    >\n      <div class=\"flex-row\">\n        <i\n          [c8yIcon]=\"'info-circle'\"\n          class=\"text-info flex-item-v-start\"\n          style=\"margin: 1px 6px 0 -3px; font-size: 14px;\"\n        ></i>\n        <span class=\"text-muted text-truncate\">\n          {{'Tenant ID' | translate}}: <strong>\n            <span class=\"text-primary\" (click)=\"$event.stopPropagation(); copyIt(ui.currentTenant.value.name)\"\n              style=\"cursor: pointer\">\n              {{ui.currentTenant.value.name}}&nbsp;<i [c8yIcon]=\"'clipboard'\"></i></span>\n            </strong><br>\n          {{'Backend' | translate}}: <strong>{{(ui.state$ | async).versions.backend}}</strong><br>\n          {{'UI' | translate }}: <strong>{{ui.uiVersion}}</strong>\n        </span>\n      </div>\n    </li>\n  </ul>\n</div>\n\n<!-- the default items -->\n<c8y-user-menu-item\n  [icon]=\"'user'\"\n  [label]=\"'User settings' | translate\"\n  [priority]=\"20\"\n  (click)=\"editUser()\"\n></c8y-user-menu-item>\n<c8y-user-menu-item\n  [icon]=\"'sign-out'\"\n  [label]=\"'Logout' | translate\"\n  (click)=\"logout()\"\n></c8y-user-menu-item>\n<c8y-user-menu-item\n  *ngIf=\"!(ui.currentUser | async).supportUserEnabled && ((ui.state$ | async).activateSupportUserAvailable)\"\n  [icon]=\"'phone'\"\n  [label]=\"'Activate support' | translate\"\n  (click)=\"activateSupportAccess()\"\n></c8y-user-menu-item>\n<c8y-user-menu-item\n  *ngIf=\"(ui.currentUser | async).supportUserEnabled && ((ui.state$ | async).activateSupportUserAvailable)\"\n  [icon]=\"'phone'\"\n  [label]=\"'Deactivate support' | translate\"\n  (click)=\"deactivateSupportAccess()\"\n></c8y-user-menu-item>\n<c8y-user-menu-item\n  *ngIf=\"(ui.state$ | async).supportUrl\"\n  [icon]=\"'question-circle'\"\n  [link]=\"(ui.state$ | async).supportUrl\"\n  [target]=\"'_blank'\"\n  [label]=\"'Request support' | translate\"\n></c8y-user-menu-item>\n"
        })
    ], UserMenuOutletComponent);
    return UserMenuOutletComponent;
}());
export { UserMenuOutletComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci1tZW51LW91dGxldC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiY29yZS91c2VyL3VzZXItbWVudS1vdXRsZXQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNqRCxPQUFPLEVBQUUsYUFBYSxFQUFFLFdBQVcsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUV6RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzdELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRXRELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDaEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFFckUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRTFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFNbkM7SUFLRSxpQ0FDUyxFQUFtQixFQUNsQixjQUE4QixFQUM5QixZQUEwQixFQUMxQixZQUEwQixFQUMxQixnQkFBa0MsRUFDbEMsYUFBNEIsRUFDNUIsWUFBMEIsRUFDMUIsSUFBaUIsRUFDakIsY0FBOEI7UUFSL0IsT0FBRSxHQUFGLEVBQUUsQ0FBaUI7UUFDbEIs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QyxXQUFXLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDOzs7OztLQUNsRDtJQUVPLDRDQUFVLEdBQWxCLFVBQW1CLElBQUk7UUFDckIsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDeEIsQ0FBQzs7Z0JBMUlZLGVBQWU7Z0JBQ0YsY0FBYztnQkFDaEIsWUFBWTtnQkFDWixZQUFZO2dCQUNSLGdCQUFnQjtnQkFDbkIsYUFBYTtnQkFDZCxZQUFZO2dCQUNwQixXQUFXO2dCQUNELGNBQWM7O0lBWnhDO1FBREMsS0FBSyxFQUFFOzBEQUNjO0lBRlgsdUJBQXVCO1FBSm5DLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxzQkFBc0I7WUFDaEMscTBHQUFnRDtTQUNqRCxDQUFDO09BQ1csdUJBQXVCLENBaUpuQztJQUFELDhCQUFDO0NBQUEsQUFqSkQsSUFpSkM7U0FqSlksdUJBQXVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVGVuYW50U2VydmljZSwgVXNlclNlcnZpY2UgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5cbmltcG9ydCB7IEFsZXJ0U2VydmljZSB9IGZyb20gJy4uL2FsZXJ0L2FsZXJ0LnNlcnZpY2UnO1xuaW1wb3J0IHsgQXBwU3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL3VpLXN0YXRlLnNlcnZpY2UnO1xuaW1wb3J0IHsgQnNNb2RhbFNlcnZpY2UgfSBmcm9tICduZ3gtYm9vdHN0cmFwL21vZGFsJztcbmltcG9ydCB7IExvZ2luU2VydmljZSB9IGZyb20gJy4uL2xvZ2luL2xvZ2luLnNlcnZpY2UnO1xuaW1wb3J0IHsgTW9kYWxTZXJ2aWNlIH0gZnJvbSAnLi4vbW9kYWwvbW9kYWwuc2VydmljZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBPcHRpb25zU2VydmljZSB9IGZyb20gJy4uL2NvbW1vbi9vcHRpb25zLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3RhdHVzIH0gZnJvbSAnLi4vY29tbW9uL3N0YXR1cy5tb2RlbCc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQgeyBVc2VyRWRpdE1vZGFsQ29tcG9uZW50IH0gZnJvbSAnLi91c2VyLWVkaXQtbW9kYWwuY29tcG9uZW50JztcbmltcG9ydCB7IFVzZXJNZW51SXRlbSB9IGZyb20gJy4vdXNlci5tb2RlbCc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnLi4vaTE4bi9nZXR0ZXh0JztcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IHNvcnRCeSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS11c2VyLW1lbnUtb3V0bGV0JyxcbiAgdGVtcGxhdGVVcmw6ICcuL3VzZXItbWVudS1vdXRsZXQuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFVzZXJNZW51T3V0bGV0Q29tcG9uZW50IHtcbiAgQElucHV0KClcbiAgaXRlbXM6IFVzZXJNZW51SXRlbVtdO1xuICBvcGVuOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyB1aTogQXBwU3RhdGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgYnNNb2RhbFNlcnZpY2U6IEJzTW9kYWxTZXJ2aWNlLFxuICAgIHByaXZhdGUgbW9kYWxTZXJ2aWNlOiBNb2RhbFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBsb2dpblNlcnZpY2U6IExvZ2luU2VydmljZSxcbiAgICBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSB0ZW5hbnRTZXJ2aWNlOiBUZW5hbnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSB1c2VyOiBVc2VyU2VydmljZSxcbiAgICBwcml2YXRlIG9wdGlvbnNTZXJ2aWNlOiBPcHRpb25zU2VydmljZVxuICApIHt9XG5cbiAgY29weUl0KHRleHQ6IHN0cmluZykge1xuICAgIGNvbnN0IGhhbmRsZXI6IEV2ZW50TGlzdGVuZXJPYmplY3QgPSB7XG4gICAgICBoYW5kbGVFdmVudDogKGU6IENsaXBib2FyZEV2ZW50KSA9PiB7XG4gICAgICAgIGUuY2xpcGJvYXJkRGF0YS5zZXREYXRhKCd0ZXh0L3BsYWluJywgdGV4dCk7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NvcHknLCBoYW5kbGVyKTtcblxuICAgIGxldCBjb3BpZWQ7XG4gICAgdHJ5IHtcbiAgICAgIGNvcGllZCA9IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdjb3B5Jyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgY29waWVkID0gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKGNvcGllZCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkQnlUZXh0KCdzdWNjZXNzJywgZ2V0dGV4dCgnQ29waWVkIHRvIGNsaXBib2FyZC4nKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZEJ5VGV4dCgnZGFuZ2VyJywgZ2V0dGV4dCgnQ291bGQgbm90IGNvcHkgdG8gY2xpcGJvYXJkLicpKTtcbiAgICB9XG5cbiAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdjb3B5JywgaGFuZGxlcik7XG4gIH1cblxuICBhc3luYyBlZGl0VXNlcigpIHtcbiAgICB0aGlzLmJzTW9kYWxTZXJ2aWNlLnNob3coVXNlckVkaXRNb2RhbENvbXBvbmVudCk7XG4gIH1cblxuICBhc3luYyBsb2dvdXQoKSB7XG4gICAgYXdhaXQgdGhpcy5sb2dpblNlcnZpY2UubG9nb3V0KCk7XG4gIH1cblxuICBhc3luYyBhY3RpdmF0ZVN1cHBvcnRBY2Nlc3MoKSB7XG4gICAgY29uc3QgdGl0bGUgPSBnZXR0ZXh0KCdBY3RpdmF0ZSBzdXBwb3J0IHVzZXIgYWNjZXNzJyk7XG5cbiAgICBjb25zdCBjb21wYW55TmFtZSA9IHRoaXMub3B0aW9uc1NlcnZpY2UuZ2V0KCdjb21wYW55TmFtZScsICdDdW11bG9jaXR5Jyk7XG4gICAgY29uc3QgdGV4dFdpdGhDb21wYW55ID0gZ2V0dGV4dChcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgICdZb3UgYXJlIGFib3V0IHRvIGFsbG93IGEgc3VwcG9ydCB1c2VyIGZyb20ge3tjb21wYW55TmFtZX19IHRvIGFjY2VzcyB5b3VyIHRlbmFudCB0byBoZWxwIHlvdSB3aXRoIHlvdXIgaXNzdWUuJ1xuICAgICk7XG4gICAgY29uc3QgdGV4dFdpdGhvdXRDb21wYW55ID0gZ2V0dGV4dChcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgICdZb3UgYXJlIGFib3V0IHRvIGFsbG93IGEgc3VwcG9ydCB1c2VyIHRvIGFjY2VzcyB5b3VyIHRlbmFudCB0byBoZWxwIHlvdSB3aXRoIHlvdXIgaXNzdWUuJ1xuICAgICk7XG4gICAgY29uc3QgZmluYWxRdWVzdGlvbiA9IGdldHRleHQoJ0RvIHlvdSB3YW50IHRvIHByb2NlZWQ/Jyk7XG4gICAgY29uc3QgYm9keSA9IFtcbiAgICAgIHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KGNvbXBhbnlOYW1lID8gdGV4dFdpdGhDb21wYW55IDogdGV4dFdpdGhvdXRDb21wYW55LCB7XG4gICAgICAgIGNvbXBhbnlOYW1lXG4gICAgICB9KSxcbiAgICAgIHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KGZpbmFsUXVlc3Rpb24pXG4gICAgXS5qb2luKCcgJyk7XG5cbiAgICBjb25zdCBsYWJlbHMgPSB7XG4gICAgICBvazogZ2V0dGV4dCgnQWN0aXZhdGUgYWNjZXNzJyksXG4gICAgICBjYW5jZWw6IGdldHRleHQoJ0NhbmNlbCcpXG4gICAgfTtcblxuICAgIGNvbnN0IHN1Y2Nlc3NNc2cgPSBnZXR0ZXh0KCdTdXBwb3J0IHVzZXIgYWNjZXNzIGFjdGl2YXRlZC4nKTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLm1vZGFsU2VydmljZS5jb25maXJtKHRpdGxlLCBib2R5LCBTdGF0dXMuREFOR0VSLCBsYWJlbHMpO1xuICAgICAgYXdhaXQgdGhpcy50ZW5hbnRTZXJ2aWNlLmVuYWJsZVN1cHBvcnRVc2VyKCk7XG4gICAgICBhd2FpdCB0aGlzLnJlZnJlc2hDdXJyZW50VXNlcigpO1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2Uuc3VjY2VzcyhzdWNjZXNzTXNnKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgLy8gaW50ZW5kZWQgZW1wdHlcbiAgICB9XG4gIH1cblxuICBhc3luYyBkZWFjdGl2YXRlU3VwcG9ydEFjY2VzcygpIHtcbiAgICBjb25zdCB0aXRsZSA9IGdldHRleHQoJ0RlYWN0aXZhdGUgc3VwcG9ydCB1c2VyIGFjY2VzcycpO1xuXG4gICAgY29uc3QgY29tcGFueU5hbWUgPSB0aGlzLm9wdGlvbnNTZXJ2aWNlLmdldCgnY29tcGFueU5hbWUnLCAnQ3VtdWxvY2l0eScpO1xuICAgIGNvbnN0IHRleHRXaXRoQ29tcGFueSA9IGdldHRleHQoXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICAnWW91IGFyZSBhYm91dCB0byBibG9jayBhIHN1cHBvcnQgdXNlciBmcm9tIHt7Y29tcGFueU5hbWV9fSBmcm9tIGFjY2Vzc2luZyB5b3VyIHRlbmFudCB0byBoZWxwIHlvdSB3aXRoIHlvdXIgaXNzdWUuJ1xuICAgICk7XG4gICAgY29uc3QgdGV4dFdpdGhvdXRDb21wYW55ID0gZ2V0dGV4dChcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgICdZb3UgYXJlIGFib3V0IHRvIGJsb2NrIGEgc3VwcG9ydCB1c2VyIGZyb20gYWNjZXNzaW5nIHlvdXIgdGVuYW50IHRvIGhlbHAgeW91IHdpdGggeW91ciBpc3N1ZS4nXG4gICAgKTtcbiAgICBjb25zdCB7IGRhdGE6IGN1cnJlbnRVc2VyIH0gPSBhd2FpdCB0aGlzLnVzZXIuY3VycmVudCgpO1xuICAgIGNvbnN0IGlzVGVuYW50QWRtaW4gPSBhd2FpdCB0aGlzLnVzZXIuaGFzUm9sZShjdXJyZW50VXNlciwgJ1JPTEVfVEVOQU5UX0FETUlOJyk7XG4gICAgY29uc3QgdGVuYW50QWRtaW5Ob3RlID0gZ2V0dGV4dChcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgICdEZWFjdGl2YXRpbmcgc3VwcG9ydCBhY2Nlc3MgYXMgdGVuYW50IGFkbWluIHdpbGwgZGlzYWJsZSBhbGwgb3RoZXIgc3VwcG9ydCByZXF1ZXN0cyBvbiB5b3VyIHRlbmFudC4nXG4gICAgKTtcbiAgICBjb25zdCBmaW5hbFF1ZXN0aW9uID0gZ2V0dGV4dCgnRG8geW91IHdhbnQgdG8gcHJvY2VlZD8nKTtcbiAgICBjb25zdCBib2R5ID0gW1xuICAgICAgdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoY29tcGFueU5hbWUgPyB0ZXh0V2l0aENvbXBhbnkgOiB0ZXh0V2l0aG91dENvbXBhbnksIHtcbiAgICAgICAgY29tcGFueU5hbWVcbiAgICAgIH0pLFxuICAgICAgaXNUZW5hbnRBZG1pbiA/IHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KHRlbmFudEFkbWluTm90ZSkgOiAnJyxcbiAgICAgIHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KGZpbmFsUXVlc3Rpb24pXG4gICAgXVxuICAgICAgLmZpbHRlcihCb29sZWFuKVxuICAgICAgLmpvaW4oJyAnKTtcblxuICAgIGNvbnN0IGxhYmVscyA9IHtcbiAgICAgIG9rOiBnZXR0ZXh0KCdEZWFjdGl2YXRlIGFjY2VzcycpLFxuICAgICAgY2FuY2VsOiBnZXR0ZXh0KCdDYW5jZWwnKVxuICAgIH07XG5cbiAgICBjb25zdCBzdWNjZXNzTXNnID0gZ2V0dGV4dCgnU3VwcG9ydCB1c2VyIGFjY2VzcyBkZWFjdGl2YXRlZC4nKTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLm1vZGFsU2VydmljZS5jb25maXJtKHRpdGxlLCBib2R5LCBTdGF0dXMuREFOR0VSLCBsYWJlbHMpO1xuICAgICAgYXdhaXQgdGhpcy50ZW5hbnRTZXJ2aWNlLmRpc2FibGVTdXBwb3J0VXNlcigpO1xuICAgICAgYXdhaXQgdGhpcy5yZWZyZXNoQ3VycmVudFVzZXIoKTtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnN1Y2Nlc3Moc3VjY2Vzc01zZyk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIC8vIGludGVuZGVkIGVtcHR5XG4gICAgfVxuICB9XG5cbiAgZ2V0U29ydGVkSXRlbXMoKSB7XG4gICAgcmV0dXJuIHNvcnRCeShBcnJheS5mcm9tKHRoaXMuaXRlbXMpLCB0aGlzLmJ5UHJpb3JpdHkpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyByZWZyZXNoQ3VycmVudFVzZXIoKSB7XG4gICAgY29uc3QgY3VycmVudFVzZXJSZXN1bHQgPSBhd2FpdCB0aGlzLnVzZXIuY3VycmVudCgpO1xuICAgIHRoaXMudWkuY3VycmVudFVzZXIubmV4dChjdXJyZW50VXNlclJlc3VsdC5kYXRhKTtcbiAgfVxuXG4gIHByaXZhdGUgYnlQcmlvcml0eShpdGVtKSB7XG4gICAgcmV0dXJuIC1pdGVtLnByaW9yaXR5O1xuICB9XG59XG4iXX0=