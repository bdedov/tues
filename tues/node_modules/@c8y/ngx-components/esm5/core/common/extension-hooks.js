import * as tslib_1 from "tslib";
import { NavigationEnd } from '@angular/router';
import { flatten, isFunction, sortBy } from 'lodash-es';
import { combineLatest, defer, from, isObservable, of, race } from 'rxjs';
import { filter, map, merge, startWith, switchMap } from 'rxjs/operators';
export function fromTrigger(router, refresh, factories) {
    return router.events.pipe(filter(function (evt) { return evt instanceof NavigationEnd; }), merge(refresh), startWith(1), switchMap(function () { return fromFactories(factories, router); }));
}
export function fromFactories(factories, router, withFirstEmpty) {
    if (withFirstEmpty === void 0) { withFirstEmpty = true; }
    return !Array.isArray(factories) || factories.length < 1
        ? of([])
        : defer(function () {
            var factoryObservables = resolveInjectedFactories(factories).map(function (f) {
                return toObservable(Array.isArray(f) ? f : f && isFunction(f.get) ? f.get(getActivatedRoute(router)) : [f], withFirstEmpty);
            });
            return combineLatest.apply(void 0, tslib_1.__spread(factoryObservables));
        }).pipe(map(function (results) { return sortByPriority([].concat.apply([], tslib_1.__spread(results))); }));
}
export function resolveInjectedFactories(factories) {
    return flatten(factories.map(function (f) { return (isFunction(f) ? f() : [f]); }));
}
export function stateToFactory(componentsState) {
    var components$ = componentsState.pipe(map(function (componentSet) { return Array.from(componentSet); }));
    return { get: function () { return components$; } };
}
export function sortByPriority(items) {
    return sortBy(items, 'priority');
}
function toObservable(factoryResult, withFirstEmpty) {
    var observable;
    if (!factoryResult) {
        return of([]);
    }
    else if (typeof factoryResult.then === 'function' || isObservable(factoryResult)) {
        if (withFirstEmpty) {
            var forceObservable = from(factoryResult);
            var withEmptyFirst = forceObservable.pipe(startWith([]));
            observable = race(forceObservable, withEmptyFirst);
        }
        else {
            observable = from(factoryResult);
        }
    }
    else {
        observable = of(factoryResult);
    }
    return observable.pipe(map(function (result) { return (Array.isArray(result) ? result : [result]).filter(function (item) { return !!item; }); }));
}
/**
 * Helper function to get the activated route in
 * a service (as ActivatedRoute injection only
 * works in components). Works as long as we only use
 * a tree and no child is active at the same time.
 *
 * @param router The current router
 */
export function getActivatedRoute(router) {
    if (router && router.routerState && router.routerState.root) {
        var route = router.routerState.root;
        while (route.firstChild) {
            route = route.firstChild;
        }
        return route;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5zaW9uLWhvb2tzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImNvcmUvY29tbW9uL2V4dGVuc2lvbi1ob29rcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFrQixhQUFhLEVBQVUsTUFBTSxpQkFBaUIsQ0FBQztBQUN4RSxPQUFPLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBYyxFQUFFLEVBQUUsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RGLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFMUUsTUFBTSxVQUFVLFdBQVcsQ0FBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLFNBQVM7SUFDcEQsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDdkIsTUFBTSxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxZQUFZLGFBQWEsRUFBNUIsQ0FBNEIsQ0FBQyxFQUMzQyxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQ2QsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUNaLFNBQVMsQ0FBQyxjQUFNLE9BQUEsYUFBYSxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsRUFBaEMsQ0FBZ0MsQ0FBQyxDQUNsRCxDQUFDO0FBQ0osQ0FBQztBQUNELE1BQU0sVUFBVSxhQUFhLENBQzNCLFNBQVUsRUFDVixNQUFlLEVBQ2YsY0FBcUI7SUFBckIsK0JBQUEsRUFBQSxxQkFBcUI7SUFFckIsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDO1FBQ3RELENBQUMsQ0FBQyxFQUFF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QWxFLENBQWtFLENBQUMsQ0FDbEYsQ0FBQztBQUNKLENBQUM7QUErQkQ7Ozs7Ozs7R0FPRztBQUNILE1BQU0sVUFBVSxpQkFBaUIsQ0FBQyxNQUFjO0lBQzlDLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxXQUFXLElBQUksTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUU7UUFDM0QsSUFBSSxLQUFLLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUM7UUFDcEMsT0FBTyxLQUFLLENBQUMsVUFBVSxFQUFFO1lBQ3ZCLEtBQUssR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDO1NBQzFCO1FBQ0QsT0FBTyxLQUFLLENBQUM7S0FDZDtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgTmF2aWdhdGlvbkVuZCwgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IGZsYXR0ZW4sIGlzRnVuY3Rpb24sIHNvcnRCeSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBkZWZlciwgZnJvbSwgaXNPYnNlcnZhYmxlLCBPYnNlcnZhYmxlLCBvZiwgcmFjZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAsIG1lcmdlLCBzdGFydFdpdGgsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuZXhwb3J0IGZ1bmN0aW9uIGZyb21UcmlnZ2VyKHJvdXRlciwgcmVmcmVzaCwgZmFjdG9yaWVzKSB7XG4gIHJldHVybiByb3V0ZXIuZXZlbnRzLnBpcGUoXG4gICAgZmlsdGVyKGV2dCA9PiBldnQgaW5zdGFuY2VvZiBOYXZpZ2F0aW9uRW5kKSxcbiAgICBtZXJnZShyZWZyZXNoKSxcbiAgICBzdGFydFdpdGgoMSksXG4gICAgc3dpdGNoTWFwKCgpID0+IGZyb21GYWN0b3JpZXMoZmFjdG9yaWVzLCByb3V0ZXIpKVxuICApO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGZyb21GYWN0b3JpZXM8VD4oXG4gIGZhY3Rvcmllcz8sXG4gIHJvdXRlcj86IFJvdXRlcixcbiAgd2l0aEZpcnN0RW1wdHkgPSB0cnVlXG4pOiBPYnNlcnZhYmxlPFRbXT4ge1xuICByZXR1cm4gIUFycmF5LmlzQXJyYXkoZmFjdG9yaWVzKSB8fCBmYWN0b3JpZXMubGVuZ3RoIDwgMVxuICAgID8gb2YoW10pXG4gICAgOiBkZWZlcigoKSA9PiB7XG4gICAgICAgIGNvbnN0IGZhY3RvcnlPYnNlcnZhYmxlcyA9IHJlc29sdmVJbmplY3RlZEZhY3RvcmllcyhmYWN0b3JpZXMpLm1hcChmID0+IHtcbiAgICAgICAgICByZXR1cm4gdG9PYnNlcnZhYmxlKFxuICAgICAgICAgICAgQXJyYXkuaXNBcnJheShmKSA/IGYgOiBmICYmIGlzRnVuY3Rpb24oZi5nZXQpID8gZi5nZXQoZ2V0QWN0aXZhdGVkUm91dGUocm91dGVyKSkgOiBbZl0sXG4gICAgICAgICAgICB3aXRoRmlyc3RFbXB0eVxuICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gY29tYmluZUxhdGVzdCguLi5mYWN0b3J5T2JzZXJ2YWJsZXMpO1xuICAgICAgfSkucGlwZShtYXAocmVzdWx0cyA9PiBzb3J0QnlQcmlvcml0eShbXS5jb25jYXQoLi4ucmVzdWx0cykpKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZXNvbHZlSW5qZWN0ZWRGYWN0b3JpZXMoZmFjdG9yaWVzKSB7XG4gIHJldHVybiBmbGF0dGVuKGZhY3Rvcmllcy5tYXAoZiA9PiAoaXNGdW5jdGlvbihmKSA/IGYoKSA6IFtmXSkpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN0YXRlVG9GYWN0b3J5PFQ+KGNvbXBvbmVudHNTdGF0ZSk6IEV4dGVuc2lvbkZhY3Rvcnk8VD4ge1xuICBjb25zdCBjb21wb25lbnRzJCA9IGNvbXBvbmVudHNTdGF0ZS5waXBlKG1hcCgoY29tcG9uZW50U2V0OiBTZXQ8VD4pID0+IEFycmF5LmZyb20oY29tcG9uZW50U2V0KSkpO1xuICByZXR1cm4geyBnZXQ6ICgpID0+IGNvbXBvbmVudHMkIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzb3J0QnlQcmlvcml0eShpdGVtcykge1xuICByZXR1cm4gc29ydEJ5KGl0ZW1zLCAncHJpb3JpdHknKTtcbn1cblxuZnVuY3Rpb24gdG9PYnNlcnZhYmxlKGZhY3RvcnlSZXN1bHQsIHdpdGhGaXJzdEVtcHR5KSB7XG4gIGxldCBvYnNlcnZhYmxlO1xuICBpZiAoIWZhY3RvcnlSZXN1bHQpIHtcbiAgICByZXR1cm4gb2YoW10pO1xuICB9IGVsc2UgaWYgKHR5cGVvZiBmYWN0b3J5UmVzdWx0LnRoZW4gPT09ICdmdW5jdGlvbicgfHwgaXNPYnNlcnZhYmxlKGZhY3RvcnlSZXN1bHQpKSB7XG4gICAgaWYgKHdpdGhGaXJzdEVtcHR5KSB7XG4gICAgICBjb25zdCBmb3JjZU9ic2VydmFibGUgPSBmcm9tKGZhY3RvcnlSZXN1bHQpO1xuICAgICAgY29uc3Qgd2l0aEVtcHR5Rmlyc3QgPSBmb3JjZU9ic2VydmFibGUucGlwZShzdGFydFdpdGgoW10pKTtcbiAgICAgIG9ic2VydmFibGUgPSByYWNlKGZvcmNlT2JzZXJ2YWJsZSwgd2l0aEVtcHR5Rmlyc3QpO1xuICAgIH0gZWxzZSB7XG4gICAgICBvYnNlcnZhYmxlID0gZnJvbShmYWN0b3J5UmVzdWx0KTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgb2JzZXJ2YWJsZSA9IG9mKGZhY3RvcnlSZXN1bHQpO1xuICB9XG4gIHJldHVybiBvYnNlcnZhYmxlLnBpcGUoXG4gICAgbWFwKHJlc3VsdCA9PiAoQXJyYXkuaXNBcnJheShyZXN1bHQpID8gcmVzdWx0IDogW3Jlc3VsdF0pLmZpbHRlcihpdGVtID0+ICEhaXRlbSkpXG4gICk7XG59XG5cbi8qKlxuICogQWxsb3dzIHRvIGV4dGVuZCB0aGUgZXhpc3RpbmcgYXBwbGljYXRpb25zIGZyb20gYSBtb2R1bGUuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRXh0ZW5zaW9uRmFjdG9yeTxUPiB7XG4gIC8qKlxuICAgKiBBbGxvd3MgdG8gcmVzb2x2ZSB0aGUgZGF0YSBvZiBhbiBleHRlbnNpb24gcG9pbnQuXG4gICAqIFRoZSByZXR1cm4gdmFsdWUgY2FuIGJlIGEgUHJvbWlzZSBvciBPYnNlcnZhYmxlXG4gICAqIChhbGxvd2luZyBmb3IgYXN5bmNocm9ub3VzIGRhdGEgcmVzb2x1dGlvbikuXG4gICAqXG4gICAqIEBwYXJhbSBhY3RpdmF0ZWRSb3V0ZSBUaGUgY3VycmVudCBhY3RpdmF0ZWQgcm91dGUgKGlmIHBvc3NpYmxlIHRvIHJlc29sdmUpLlxuICAgKi9cbiAgZ2V0KGFjdGl2YXRlZFJvdXRlPzogQWN0aXZhdGVkUm91dGUpOiBPYnNlcnZhYmxlPFRbXSB8IFQ+IHwgUHJvbWlzZTxUW10gfCBUPiB8IFRbXSB8IFQ7XG59XG5cbi8qKlxuICogRXh0ZW5zaW9uIHBvaW50cyBhbGxvdyB0byBleHRlbmQgdGhlIGFwcGxpY2F0aW9uIGZyb21cbiAqIGFueSBtb2R1bGVcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFeHRlbnNpb25Qb2ludDxUPiB7XG4gIC8qKlxuICAgKiBPYnNlcnZhYmxlIHRoYXQgZW1pdHMgb2YgYXJyYXkgb2YgZXh0ZW5zaW9ucyBhY3RpdmUgYXQgYW55IGdpdmUgdGltZVxuICAgKi9cbiAgcmVhZG9ubHkgaXRlbXMkOiBPYnNlcnZhYmxlPFRbXT47XG4gIC8qKlxuICAgKiBDYWxsIHRoZSBleHRlbnNpb24gZmFjdG9yaWVzIHRvIHJlZnJlc2ggdGhlbS5cbiAgICovXG4gIHJlZnJlc2goKTtcbn1cblxuLyoqXG4gKiBIZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IHRoZSBhY3RpdmF0ZWQgcm91dGUgaW5cbiAqIGEgc2VydmljZSAoYXMgQWN0aXZhdGVkUm91dGUgaW5qZWN0aW9uIG9ubHlcbiAqIHdvcmtzIGluIGNvbXBvbmVudHMpLiBXb3JrcyBhcyBsb25nIGFzIHdlIG9ubHkgdXNlXG4gKiBhIHRyZWUgYW5kIG5vIGNoaWxkIGlzIGFjdGl2ZSBhdCB0aGUgc2FtZSB0aW1lLlxuICpcbiAqIEBwYXJhbSByb3V0ZXIgVGhlIGN1cnJlbnQgcm91dGVyXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRBY3RpdmF0ZWRSb3V0ZShyb3V0ZXI6IFJvdXRlcikge1xuICBpZiAocm91dGVyICYmIHJvdXRlci5yb3V0ZXJTdGF0ZSAmJiByb3V0ZXIucm91dGVyU3RhdGUucm9vdCkge1xuICAgIGxldCByb3V0ZSA9IHJvdXRlci5yb3V0ZXJTdGF0ZS5yb290O1xuICAgIHdoaWxlIChyb3V0ZS5maXJzdENoaWxkKSB7XG4gICAgICByb3V0ZSA9IHJvdXRlLmZpcnN0Q2hpbGQ7XG4gICAgfVxuICAgIHJldHVybiByb3V0ZTtcbiAgfVxufVxuIl19