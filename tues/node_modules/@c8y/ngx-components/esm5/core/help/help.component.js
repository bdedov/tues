import * as tslib_1 from "tslib";
import { Component, ElementRef, Input, ViewChild } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { AppStateService } from '../common/ui-state.service';
import { DocsService } from '../docs/docs.service';
/**
 * A component which shows a context help in
 * the action bar.
 *
 * @example
 * ```html
 * <c8y-help src="/users-guide/cockpit/#dashboards"></c8y-help>
 * ```
 */
var HelpComponent = /** @class */ (function () {
    /**
     * @ignore Only private DI
     */
    function HelpComponent(docsService, appState, translateService) {
        this.docsService = docsService;
        this.appState = appState;
        this.translateService = translateService;
        /**
         * The source of the documentation. Used to link to the documentation as well as
         * to parse the source to display.
         */
        this.src = '';
        /**
         * Indicates if the help dialog is collapsed.
         */
        this.isCollapsed = true;
        /**
         * The priority where the help icon should be shown in the action bar
         */
        this.priority = Infinity;
        /**
         * An title. Set in open by passing the source.
         */
        this.title = '';
        /**
         * The content. Set in open by passing the source.
         */
        this.content = [];
        /**
         * Indicates if the component is loading.
         */
        this.isLoading = true;
        /**
         * Indicates if the component failed loading the source.
         */
        this.hasError = false;
        this.SUPPORTED_LANGUAGES = ['en'];
    }
    Object.defineProperty(HelpComponent.prototype, "isSupportedLanguage", {
        /**
         * Identifies if the current user language is supported
         * Currently only English is supported.
         */
        get: function () {
            return this.SUPPORTED_LANGUAGES.indexOf(this.translateService.currentLang) > -1;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * Builds the URL based on the src. The Base URL can be set in the application options docBaseUrl.
     * @param src The source of the help on the guide.
     */
    HelpComponent.prototype.getUrl = function (src) {
        if (src === void 0) { src = ''; }
        var version = this.parseVersion(this.appState.uiVersion);
        var url = this.docsService.getBaseUrl();
        return "" + url + (url.endsWith('/') ? '' : '/') + version + (src.startsWith('/') ? src : "/" + src);
    };
    /**
     * Toggles the visibility of the help dialog.
     */
    HelpComponent.prototype.toggle = function () {
        if (this.isCollapsed) {
            this.open();
            return;
        }
        this.close();
    };
    /**
     * Closes the help dialog.
     */
    HelpComponent.prototype.close = function () {
        this.isCollapsed = true;
        this.clean();
    };
    /**
     * Opens the help dialog.
     */
    HelpComponent.prototype.open = function () {
        this.isCollapsed = false;
        this.isLoading = true;
        this.requestContent();
        if (!this.icon) {
            this.icon = this.resolveIcon();
        }
    };
    /**
     * @ignore
     */
    HelpComponent.prototype.ngAfterContentChecked = function () {
        var _this = this;
        if (this.content.length > 0 && this.helpContent) {
            this.content.forEach(function (ele) {
                _this.helpContent.nativeElement.append(ele);
            });
        }
    };
    HelpComponent.prototype.requestContent = function () {
        var _this = this;
        var req = new XMLHttpRequest();
        req.onreadystatechange = function () { return _this.render(req); };
        req.addEventListener('load', function () { return _this.render(req); });
        req.open('GET', this.getUrl(this.src));
        req.responseType = 'document';
        req.setRequestHeader('Accept', 'text/html');
        req.send();
    };
    HelpComponent.prototype.clean = function () {
        this.title = '';
        this.isLoading = true;
        this.hasError = false;
        this.content = [];
        if (this.helpContent) {
            this.helpContent.nativeElement.innerHTML = '';
        }
    };
    HelpComponent.prototype.parseVersion = function (uiVersion) {
        var version = uiVersion.split('.')[0];
        var majorNumber = Math.floor(parseInt(version, 10) / 100);
        var minorNumber = parseInt(version, 10) - majorNumber * 100;
        return majorNumber + "." + minorNumber + ".0";
    };
    HelpComponent.prototype.resolveIcon = function () {
        try {
            var icon = Array.from(document.querySelector('nav .active i').classList).find(function (classes) { return classes.startsWith('c8y-') || classes.startsWith('fa-'); });
            return icon.replace('fa-', '');
        }
        catch (ex) {
            return 'question-circle-o';
        }
    };
    HelpComponent.prototype.render = function (req) {
        var e_1, _a;
        if (req.readyState === 4) {
            this.isLoading = false;
            if (req.status === 200) {
                var sectionSplit = this.src.split('#');
                // TODO: change here the selectors when DOC team defined the section element
                var sectionQuery = "#" + sectionSplit[sectionSplit.length - 1] + " h2";
                var sectionNode = req.response.querySelector(sectionQuery);
                var allPossibleElementsToAttach = Array.from(sectionNode.parentElement.children).slice(1);
                this.title = sectionNode.innerText.trim();
                try {
                    for (var allPossibleElementsToAttach_1 = tslib_1.__values(allPossibleElementsToAttach), allPossibleElementsToAttach_1_1 = allPossibleElementsToAttach_1.next(); !allPossibleElementsToAttach_1_1.done; allPossibleElementsToAttach_1_1 = allPossibleElementsToAttach_1.next()) {
                        var ele = allPossibleElementsToAttach_1_1.value;
                        if (ele.tagName.toLowerCase() === 'h3') {
                            break;
                        }
                        this.content.push(ele);
                    }
                }
                catch (e_1_1) { e_1 = { error: e_1_1 }; }
                finally {
                    try {
                        if (allPossibleElementsToAttach_1_1 && !allPossibleElementsToAttach_1_1.done && (_a = allPossibleElementsToAttach_1.return)) _a.call(allPossibleElementsToAttach_1);
                    }
                    finally { if (e_1) throw e_1.error; }
                }
            }
            else {
                this.hasError = true;
            }
        }
    };
    HelpComponent.ctorParameters = function () { return [
        { type: DocsService },
        { type: AppStateService },
        { type: TranslateService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], HelpComponent.prototype, "src", void 0);
    tslib_1.__decorate([
        Input()
    ], HelpComponent.prototype, "isCollapsed", void 0);
    tslib_1.__decorate([
        Input()
    ], HelpComponent.prototype, "priority", void 0);
    tslib_1.__decorate([
        Input()
    ], HelpComponent.prototype, "icon", void 0);
    tslib_1.__decorate([
        ViewChild('helpContent', { static: false, read: ElementRef })
    ], HelpComponent.prototype, "helpContent", void 0);
    HelpComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-help',
            template: "<c8y-action-bar-item\n  [placement]=\"'right'\"\n  itemClass=\"pull-right\"\n  [priority]=\"priority\"\n  *ngIf=\"isSupportedLanguage\"\n>\n  <button\n    class=\"btn btn-help\"\n    [title]=\"'Open help' | translate\"\n    (click)=\"toggle()\"\n    [attr.aria-expanded]=\"!isCollapsed\"\n    aria-controls=\"collapseHelp\"\n  >\n    <i\n      [c8yIcon]=\"'question-circle-o'\"\n      class=\"text-info text-16\"\n    ></i>\n  </button>\n</c8y-action-bar-item>\n\n<div\n  id=\"collapseHelp\"\n  class=\"c8y-help-drawer\"\n  [collapse]=\"isCollapsed\"\n  [isAnimated]=\"true\"\n>\n  <div\n    class=\"p-24\"\n    #docOutlet\n  >\n    <div\n      *ngIf=\"isLoading\"\n    >\n      <c8y-loading></c8y-loading>\n    </div>\n\n    <div *ngIf=\"!isLoading\">\n      <div class=\"d-flex\">\n        <i\n          [c8yIcon]=\"icon\"\n          class=\"c8y-icon-duocolor icon-48\"\n        ></i>\n        <div\n          class=\"p-l-16 flex-grow\"\n          *ngIf=\"!hasError\"\n        >\n          <h3 class=\"text-light m-b-16\">{{title}}</h3>\n          <div\n            id=\"helpContent\"\n            class=\"help-content\"\n            #helpContent\n          ></div>\n\n          <button\n            class=\"btn btn-default\"\n            (click)=\"toggle()\"\n            [title]=\"'Close help' | translate\"\n            [attr.aria-expanded]=\"!isCollapsed\"\n            aria-controls=\"collapseHelp\"\n          >Close</button>\n          <a\n            href=\"{{getUrl(src)}}\"\n            class=\"btn btn-primary\"\n            target=\"_blank\"\n            translate\n          >\n            Check the User guide\n          </a>\n        </div>\n\n        <div\n          class=\"p-l-16 flex-grow\"\n          *ngIf=\"hasError\"\n        >\n          <h3\n            class=\"text-light m-b-16\"\n            translate\n          >Sorry, that didn't work</h3>\n          <div class=\"help-content\">\n            <p translate>The content couldn't be loaded.</p>\n          </div>\n\n          <button\n            class=\"btn btn-default\"\n            (click)=\"toggle()\"\n            [title]=\"'Close help' | translate\"\n            [attr.aria-expanded]=\"!isCollapsed\"\n            aria-controls=\"collapseHelp\"\n            translate\n          >Close</button>\n          <a\n            href=\"{{getUrl()}}\"\n            class=\"btn btn-primary\"\n            target=\"_blank\"\n            translate\n          >\n            Open the User guide\n          </a>\n\n        </div>\n      </div>\n    </div>\n\n  </div>\n</div>\n"
        })
    ], HelpComponent);
    return HelpComponent;
}());
export { HelpComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVscC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiY29yZS9oZWxwL2hlbHAuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFbkQ7Ozs7Ozs7O0dBUUc7QUFLSDtJQThERTs7T0FFRztJQUNILHVCQUNVLFdBQXdCLEVBQ3hCLFFBQXlCLEVBQ3pCLGdCQUFrQztRQUZsQyxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQUN6QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBbkU1Qzs7O1dBR0c7UUFFSCxRQUFHLEdBQVcsRUFBRSxDQUFDO1FBRWpCOztXQUVHO1FBRUgsZ0JBQVcsR0FBRyxJQUFJLENBQUM7UUFFbkI7O1dBRUc7UUFFSCxhQUFRLEdBQUcsUUFBUSxDQUFDO1FBUXBCOztXQUVHO1FBQ0gsVUFBSyxHQUFHLEVBQUUsQ0FBQztRQUVYOztXQUVHO1FBQ0gsWUFBTyxHQUFHLEVBQUUsQ0FBQztRQUViOztXQUVHO1FBQ0gsY0FBUyxHQUFHLElBQUksQ0FBQztRQUVqQjs7V0FFRztRQUNILGFBQVEsR0FBRyxLQUFLLENBQUM7UUFRQSx3QkFBbUIsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBaUIzQyxDQUFDO0lBWEosc0JBQUksOENBQW1CO1FBSnZCOzs7V0FHRzthQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLElB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RUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsQ0FBQztzREFDdEM7SUFsRGIsYUFBYTtRQUp6QixTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsVUFBVTtZQUNwQixtZ0ZBQW9DO1NBQ3JDLENBQUM7T0FDVyxhQUFhLENBMEx6QjtJQUFELG9CQUFDO0NBQUEsQUExTEQsSUEwTEM7U0ExTFksYUFBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRWxlbWVudFJlZiwgSW5wdXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHsgQXBwU3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL3VpLXN0YXRlLnNlcnZpY2UnO1xuaW1wb3J0IHsgRG9jc1NlcnZpY2UgfSBmcm9tICcuLi9kb2NzL2RvY3Muc2VydmljZSc7XG5cbi8qKlxuICogQSBjb21wb25lbnQgd2hpY2ggc2hvd3MgYSBjb250ZXh0IGhlbHAgaW5cbiAqIHRoZSBhY3Rpb24gYmFyLlxuICpcbiAqIEBleGFtcGxlXG4gKiBgYGBodG1sXG4gKiA8Yzh5LWhlbHAgc3JjPVwiL3VzZXJzLWd1aWRlL2NvY2twaXQvI2Rhc2hib2FyZHNcIj48L2M4eS1oZWxwPlxuICogYGBgXG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1oZWxwJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2hlbHAuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIEhlbHBDb21wb25lbnQge1xuICAvKipcbiAgICogVGhlIHNvdXJjZSBvZiB0aGUgZG9jdW1lbnRhdGlvbi4gVXNlZCB0byBsaW5rIHRvIHRoZSBkb2N1bWVudGF0aW9uIGFzIHdlbGwgYXNcbiAgICogdG8gcGFyc2UgdGhlIHNvdXJjZSB0byBkaXNwbGF5LlxuICAgKi9cbiAgQElucHV0KClcbiAgc3JjOiBzdHJpbmcgPSAnJztcblxuICAvKipcbiAgICogSW5kaWNhdGVzIGlmIHRoZSBoZWxwIGRpYWxvZyBpcyBjb2xsYXBzZWQuXG4gICAqL1xuICBASW5wdXQoKVxuICBpc0NvbGxhcHNlZCA9IHRydWU7XG5cbiAgLyoqXG4gICAqIFRoZSBwcmlvcml0eSB3aGVyZSB0aGUgaGVscCBpY29uIHNob3VsZCBiZSBzaG93biBpbiB0aGUgYWN0aW9uIGJhclxuICAgKi9cbiAgQElucHV0KClcbiAgcHJpb3JpdHkgPSBJbmZpbml0eTtcblxuICAvKipcbiAgICogQW4gY3VzdG9tIGljb24uIElmIG5vdCBzZXQsIHRoZSBuYXZpZ2F0b3IgaWNvbiBpcyByZXNvbHZlZFxuICAgKi9cbiAgQElucHV0KClcbiAgaWNvbjtcblxuICAvKipcbiAgICogQW4gdGl0bGUuIFNldCBpbiBvcGVuIGJ5IHBhc3NpbmcgdGhlIHNvdXJjZS5cbiAgICovXG4gIHRpdGxlID0gJyc7XG5cbiAgLyoqXG4gICAqIFRoZSBjb250ZW50LiBTZXQgaW4gb3BlbiBieSBwYXNzaW5nIHRoZSBzb3VyY2UuXG4gICAqL1xuICBjb250ZW50ID0gW107XG5cbiAgLyoqXG4gICAqIEluZGljYXRlcyBpZiB0aGUgY29tcG9uZW50IGlzIGxvYWRpbmcuXG4gICAqL1xuICBpc0xvYWRpbmcgPSB0cnVlO1xuXG4gIC8qKlxuICAgKiBJbmRpY2F0ZXMgaWYgdGhlIGNvbXBvbmVudCBmYWlsZWQgbG9hZGluZyB0aGUgc291cmNlLlxuICAgKi9cbiAgaGFzRXJyb3IgPSBmYWxzZTtcblxuICAvKipcbiAgICogQW4gdmlldyBjaGlsZCB0byB3aGljaCB0aGUgcGFyc2VkIGNvbnRlbnQgaXMgYXBwZW5kZWQuXG4gICAqL1xuICBAVmlld0NoaWxkKCdoZWxwQ29udGVudCcsIHsgc3RhdGljOiBmYWxzZSwgcmVhZDogRWxlbWVudFJlZiB9KVxuICBoZWxwQ29udGVudDogRWxlbWVudFJlZjtcblxuICBwcml2YXRlIHJlYWRvbmx5IFNVUFBPUlRFRF9MQU5HVUFHRVMgPSBbJ2VuJ107XG5cbiAgLyoqXG4gICAqIElkZW50aWZpZXMgaWYgdGhlIGN1cnJlbnQgdXNlciBsYW5ndWFnZSBpcyBzdXBwb3J0ZWRcbiAgICogQ3VycmVudGx5IG9ubHkgRW5nbGlzaCBpcyBzdXBwb3J0ZWQuXG4gICAqL1xuICBnZXQgaXNTdXBwb3J0ZWRMYW5ndWFnZSgpIHtcbiAgICByZXR1cm4gdGhpcy5TVVBQT1JURURfTEFOR1VBR0VTLmluZGV4T2YodGhpcy50cmFuc2xhdGVTZXJ2aWNlLmN1cnJlbnRMYW5nKSA+IC0xO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpZ25vcmUgT25seSBwcml2YXRlIERJXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGRvY3NTZXJ2aWNlOiBEb2NzU2VydmljZSxcbiAgICBwcml2YXRlIGFwcFN0YXRlOiBBcHBTdGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSB0cmFuc2xhdGVTZXJ2aWNlOiBUcmFuc2xhdGVTZXJ2aWNlXG4gICkge31cblxuICAvKipcbiAgICogQnVpbGRzIHRoZSBVUkwgYmFzZWQgb24gdGhlIHNyYy4gVGhlIEJhc2UgVVJMIGNhbiBiZSBzZXQgaW4gdGhlIGFwcGxpY2F0aW9uIG9wdGlvbnMgZG9jQmFzZVVybC5cbiAgICogQHBhcmFtIHNyYyBUaGUgc291cmNlIG9mIHRoZSBoZWxwIG9uIHRoZSBndWlkZS5cbiAgICovXG4gIGdldFVybChzcmMgPSAnJykge1xuICAgIGNvbnN0IHZlcnNpb24gPSB0aGlzLnBhcnNlVmVyc2lvbih0aGlzLmFwcFN0YXRlLnVpVmVyc2lvbik7XG4gICAgY29uc3QgdXJsID0gdGhpcy5kb2NzU2VydmljZS5nZXRCYXNlVXJsKCk7XG4gICAgcmV0dXJuIGAke3VybH0ke3VybC5lbmRzV2l0aCgnLycpID8gJycgOiAnLyd9JHt2ZXJzaW9ufSR7XG4gICAgICBzcmMuc3RhcnRzV2l0aCgnLycpID8gc3JjIDogYC8ke3NyY31gXG4gICAgfWA7XG4gIH1cblxuICAvKipcbiAgICogVG9nZ2xlcyB0aGUgdmlzaWJpbGl0eSBvZiB0aGUgaGVscCBkaWFsb2cuXG4gICAqL1xuICB0b2dnbGUoKSB7XG4gICAgaWYgKHRoaXMuaXNDb2xsYXBzZWQpIHtcbiAgICAgIHRoaXMub3BlbigpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmNsb3NlKCk7XG4gIH1cblxuICAvKipcbiAgICogQ2xvc2VzIHRoZSBoZWxwIGRpYWxvZy5cbiAgICovXG4gIGNsb3NlKCkge1xuICAgIHRoaXMuaXNDb2xsYXBzZWQgPSB0cnVlO1xuICAgIHRoaXMuY2xlYW4oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVucyB0aGUgaGVscCBkaWFsb2cuXG4gICAqL1xuICBvcGVuKCkge1xuICAgIHRoaXMuaXNDb2xsYXBzZWQgPSBmYWxzZTtcbiAgICB0aGlzLmlzTG9hZGluZyA9IHRydWU7XG4gICAgdGhpcy5yZXF1ZXN0Q29udGVudCgpO1xuICAgIGlmICghdGhpcy5pY29uKSB7XG4gICAgICB0aGlzLmljb24gPSB0aGlzLnJlc29sdmVJY29uKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIG5nQWZ0ZXJDb250ZW50Q2hlY2tlZCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jb250ZW50Lmxlbmd0aCA+IDAgJiYgdGhpcy5oZWxwQ29udGVudCkge1xuICAgICAgdGhpcy5jb250ZW50LmZvckVhY2goZWxlID0+IHtcbiAgICAgICAgdGhpcy5oZWxwQ29udGVudC5uYXRpdmVFbGVtZW50LmFwcGVuZChlbGUpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZXF1ZXN0Q29udGVudCgpIHtcbiAgICBjb25zdCByZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICByZXEub25yZWFkeXN0YXRlY2hhbmdlID0gKCkgPT4gdGhpcy5yZW5kZXIocmVxKTtcbiAgICByZXEuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsICgpID0+IHRoaXMucmVuZGVyKHJlcSkpO1xuICAgIHJlcS5vcGVuKCdHRVQnLCB0aGlzLmdldFVybCh0aGlzLnNyYykpO1xuICAgIHJlcS5yZXNwb25zZVR5cGUgPSAnZG9jdW1lbnQnO1xuICAgIHJlcS5zZXRSZXF1ZXN0SGVhZGVyKCdBY2NlcHQnLCAndGV4dC9odG1sJyk7XG4gICAgcmVxLnNlbmQoKTtcbiAgfVxuXG4gIHByaXZhdGUgY2xlYW4oKSB7XG4gICAgdGhpcy50aXRsZSA9ICcnO1xuICAgIHRoaXMuaXNMb2FkaW5nID0gdHJ1ZTtcbiAgICB0aGlzLmhhc0Vycm9yID0gZmFsc2U7XG4gICAgdGhpcy5jb250ZW50ID0gW107XG4gICAgaWYgKHRoaXMuaGVscENvbnRlbnQpIHtcbiAgICAgICh0aGlzLmhlbHBDb250ZW50Lm5hdGl2ZUVsZW1lbnQgYXMgSFRNTEVsZW1lbnQpLmlubmVySFRNTCA9ICcnO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VWZXJzaW9uKHVpVmVyc2lvbikge1xuICAgIGNvbnN0IHZlcnNpb24gPSB1aVZlcnNpb24uc3BsaXQoJy4nKVswXTtcbiAgICBjb25zdCBtYWpvck51bWJlciA9IE1hdGguZmxvb3IocGFyc2VJbnQodmVyc2lvbiwgMTApIC8gMTAwKTtcbiAgICBjb25zdCBtaW5vck51bWJlciA9IHBhcnNlSW50KHZlcnNpb24sIDEwKSAtIG1ham9yTnVtYmVyICogMTAwO1xuICAgIHJldHVybiBgJHttYWpvck51bWJlcn0uJHttaW5vck51bWJlcn0uMGA7XG4gIH1cblxuICBwcml2YXRlIHJlc29sdmVJY29uKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBpY29uID0gQXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCduYXYgLmFjdGl2ZSBpJykuY2xhc3NMaXN0KS5maW5kKFxuICAgICAgICBjbGFzc2VzID0+IGNsYXNzZXMuc3RhcnRzV2l0aCgnYzh5LScpIHx8IGNsYXNzZXMuc3RhcnRzV2l0aCgnZmEtJylcbiAgICAgICk7XG4gICAgICByZXR1cm4gaWNvbi5yZXBsYWNlKCdmYS0nLCAnJyk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHJldHVybiAncXVlc3Rpb24tY2lyY2xlLW8nO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVuZGVyKHJlcTogWE1MSHR0cFJlcXVlc3QpIHtcbiAgICBpZiAocmVxLnJlYWR5U3RhdGUgPT09IDQpIHtcbiAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7XG4gICAgICBpZiAocmVxLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICAgIGNvbnN0IHNlY3Rpb25TcGxpdCA9IHRoaXMuc3JjLnNwbGl0KCcjJyk7XG5cbiAgICAgICAgLy8gVE9ETzogY2hhbmdlIGhlcmUgdGhlIHNlbGVjdG9ycyB3aGVuIERPQyB0ZWFtIGRlZmluZWQgdGhlIHNlY3Rpb24gZWxlbWVudFxuICAgICAgICBjb25zdCBzZWN0aW9uUXVlcnkgPSBgIyR7c2VjdGlvblNwbGl0W3NlY3Rpb25TcGxpdC5sZW5ndGggLSAxXX0gaDJgO1xuICAgICAgICBjb25zdCBzZWN0aW9uTm9kZSA9IHJlcS5yZXNwb25zZS5xdWVyeVNlbGVjdG9yKHNlY3Rpb25RdWVyeSkgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICAgIGNvbnN0IGFsbFBvc3NpYmxlRWxlbWVudHNUb0F0dGFjaCA9IEFycmF5LmZyb20oc2VjdGlvbk5vZGUucGFyZW50RWxlbWVudC5jaGlsZHJlbikuc2xpY2UoMSk7XG4gICAgICAgIHRoaXMudGl0bGUgPSBzZWN0aW9uTm9kZS5pbm5lclRleHQudHJpbSgpO1xuXG4gICAgICAgIGZvciAoY29uc3QgZWxlIG9mIGFsbFBvc3NpYmxlRWxlbWVudHNUb0F0dGFjaCkge1xuICAgICAgICAgIGlmIChlbGUudGFnTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnaDMnKSB7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5jb250ZW50LnB1c2goZWxlKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5oYXNFcnJvciA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=