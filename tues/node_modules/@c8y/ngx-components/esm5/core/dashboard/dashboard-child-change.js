import * as tslib_1 from "tslib";
import { sortBy } from 'lodash-es';
import { pipe } from 'rxjs';
import { distinctUntilChanged, expand, filter, map, tap } from 'rxjs/operators';
var DashboardChildChange = /** @class */ (function () {
    function DashboardChildChange(childToChange) {
        this.MIN_WIDTH = 2;
        this.MIN_HEIGHT = 1;
        this.PIXEL_SIZE_THRESHOLD = 10;
        this.diffX = 0;
        this.diffY = 0;
        this.dashboard = childToChange.dashboard;
        this.children = childToChange.dashboard.children
            ? childToChange.dashboard.children.filter(function (child) { return childToChange !== child; })
            : [];
        this.child = childToChange;
    }
    Object.defineProperty(DashboardChildChange.prototype, "resize$", {
        get: function () {
            var _this = this;
            return this.child.dragSource.moved.pipe(map(function (move) { return _this.getPixelSize(move); }), tap(function (resizeDimension) { return _this.setPixelSize(resizeDimension); }), map(function (resizeDimension) { return _this.getDimensionSize(resizeDimension); }), distinctUntilChanged(function (prev, next) { return prev.width === next.width && prev.height === next.height; }), map(function (dimension) { return _this.setDimension(dimension); }), this.arrangePipe());
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DashboardChildChange.prototype, "drag$", {
        get: function () {
            var _this = this;
            return this.child.dragSource.moved.pipe(map(function (move) { return _this.getDimensionPosition(move); }), filter(function (dimension) {
                return dimension.x >= 0 &&
                    dimension.x <= _this.dashboard.columns - _this.child.width &&
                    dimension.y >= 0;
            }), distinctUntilChanged(function (prev, next) { return prev.x === next.x && prev.y === next.y; }), this.arrangePipe());
        },
        enumerable: true,
        configurable: true
    });
    DashboardChildChange.prototype.findFreeDimension = function () {
        var y = -1;
        var x = 0;
        var found = false;
        var _a = this.child, width = _a.width, height = _a.height;
        if (width > this.dashboard.columns) {
            throw new Error('The child does not fit on the current dashboard.');
        }
        do {
            x = 0;
            y++;
            while (x + width <= this.dashboard.columns) {
                if (this.getCollided({ x: x, y: y, width: width, height: height }).length === 0) {
                    found = true;
                    break;
                }
                x++;
            }
        } while (!found);
        return { x: x, y: y, width: width, height: height };
    };
    DashboardChildChange.prototype.collapseUpAll = function () {
        return sortBy(tslib_1.__spread([this.child], this.children), ['y']).forEach(function (w) {
            var ds = new DashboardChildChange(w);
            var newPosition = ds.collapseUp(w);
            ds.setDimension(newPosition);
        });
    };
    DashboardChildChange.prototype.arrangeAll = function (arrange) {
        var current = arrange.current, scan = arrange.scan, spacing = arrange.spacing, origin = arrange.origin;
        var collided = this.getCollided(current, sortBy(scan, ['y']));
        return collided.map(function (child) {
            var ds = new DashboardChildChange(child);
            ds.setDimension(tslib_1.__assign({}, child, { y: spacing }));
            return {
                current: child,
                scan: scan.filter(function (w) { return w !== child; }),
                spacing: child.y + child.height,
                origin: origin
            };
        });
    };
    DashboardChildChange.prototype.arrangePipe = function () {
        var _this = this;
        return pipe(map(function (dimension) {
            return ({
                current: dimension,
                scan: _this.children,
                spacing: dimension.y + dimension.height,
                origin: tslib_1.__assign({}, dimension)
            });
        }), expand(function (dimensions) { return _this.arrangeAll(dimensions); }), map(function (_a) {
            var origin = _a.origin;
            return origin;
        }), map(function (dimension) { return _this.setDimension(dimension, true); }), tap(function () { return _this.collapseUpAll(); }), tap(function () { return _this.dashboard.getLastRow(); }));
    };
    DashboardChildChange.prototype.collapseUp = function (dimension) {
        var y = dimension.y;
        while (y > 0) {
            if (this.getCollided(tslib_1.__assign({}, dimension, { y: y - 1 })).length !== 0) {
                break;
            }
            y--;
        }
        return tslib_1.__assign({}, dimension, { y: y });
    };
    DashboardChildChange.prototype.setDimension = function (dimension, notIfColliding) {
        if (notIfColliding === void 0) { notIfColliding = false; }
        if (notIfColliding && this.getCollided(dimension).length > 0) {
            return;
        }
        this.child.x = dimension.x;
        this.child.y = dimension.y;
        if (dimension.width >= this.MIN_WIDTH &&
            dimension.x + dimension.width <= this.dashboard.columns) {
            this.child.width = dimension.width;
        }
        else if (dimension.width < this.MIN_WIDTH) {
            dimension.width = this.MIN_WIDTH;
        }
        else {
            dimension.width = this.dashboard.columns - dimension.x;
        }
        if (dimension.height >= this.MIN_HEIGHT) {
            this.child.height = dimension.height;
        }
        else {
            dimension.height = this.MIN_WIDTH;
        }
        return dimension;
    };
    DashboardChildChange.prototype.setPixelSize = function (_a) {
        var width = _a.width, height = _a.height;
        if (width >= this.dashboard.columnSize * this.MIN_WIDTH - this.dashboard.gap) {
            this.child.pxWidth = width + this.PIXEL_SIZE_THRESHOLD;
        }
        if (height >= this.dashboard.rowSize * this.MIN_HEIGHT - this.dashboard.gap) {
            this.child.pxHeight = height + this.PIXEL_SIZE_THRESHOLD;
        }
    };
    DashboardChildChange.prototype.getPixelSize = function (moveEvent) {
        var draggedElement = moveEvent.source.element.nativeElement.parentNode;
        if (!this.diffX) {
            var rect = draggedElement.getBoundingClientRect();
            this.diffX = rect.left;
            this.diffY = rect.top;
        }
        var _a = moveEvent.pointerPosition, x = _a.x, y = _a.y;
        var width = Math.round(x - this.diffX);
        var height = Math.round(y - this.diffY);
        return { width: width, height: height, pointer: { x: x, y: y } };
    };
    DashboardChildChange.prototype.getDimensionSize = function (resizePosition) {
        var _a = this.child, x = _a.x, y = _a.y;
        var ds = this.dashboard.dashboardRect;
        var column = this.dashboard.columnSize;
        var row = this.dashboard.rowSize + this.dashboard.gap;
        var width = Math.round((resizePosition.pointer.x - ds.left + this.dashboard.gap) / column) - x;
        var height = Math.round((resizePosition.pointer.y - ds.top + this.dashboard.gap) / row) - y;
        return { x: x, y: y, width: width, height: height };
    };
    DashboardChildChange.prototype.getDimensionPosition = function (moveEvent) {
        var draggedElement = moveEvent.source.element.nativeElement.nextElementSibling;
        if (!this.diffX) {
            var rect = draggedElement.getBoundingClientRect();
            this.diffX = moveEvent.pointerPosition.x - rect.left;
            this.diffY = moveEvent.pointerPosition.y - rect.top;
        }
        var left = moveEvent.pointerPosition.x - this.diffX;
        var top = moveEvent.pointerPosition.y - this.diffY;
        var _a = this.child, width = _a.width, height = _a.height;
        var ds = this.dashboard.dashboardRect;
        var column = this.dashboard.columnSize;
        var row = this.dashboard.rowSize + this.dashboard.gap / 2;
        var x = Math.round((left - ds.left) / column);
        var y = Math.round((top - ds.top) / row);
        return { x: x, y: y, width: width, height: height };
    };
    DashboardChildChange.prototype.doesCollide = function (a, b) {
        if (b.x === undefined) {
            return false;
        }
        return !(a.y + a.height - 1 < b.y ||
            a.y > b.y + b.height - 1 ||
            a.x + a.width - 1 < b.x ||
            a.x > b.x + b.width - 1);
    };
    DashboardChildChange.prototype.getCollided = function (currentDimension, dimensions) {
        var _this = this;
        if (dimensions === void 0) { dimensions = this.children; }
        var collided = dimensions.filter(function (dimension) { return _this.doesCollide(currentDimension, dimension); });
        return collided;
    };
    return DashboardChildChange;
}());
export { DashboardChildChange };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzaGJvYXJkLWNoaWxkLWNoYW5nZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJjb3JlL2Rhc2hib2FyZC9kYXNoYm9hcmQtY2hpbGQtY2hhbmdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ25DLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDNUIsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBU2hGO0lBWUUsOEJBQVksYUFBc0M7UUFQakMsY0FBUyxHQUFHLENBQUMsQ0FBQztRQUN2QixlQUFVLEdBQUcsQ0FBQyxDQUFDO1FBQ04seUJBQW9CLEdBQUcsRUFBRSxDQUFDO1FBRW5DLFVBQUssR0FBRyxDQUFDLENBQUM7UUFDVixVQUFLLEdBQUcsQ0FBQyxDQUFDO1FBR2hCLElBQUksQ0FBQyxTQUFTLEdBQUcsYUFBYSxDQUFDLFNBQVMsQ0FBQztRQUN6QyxJQUFJLENBQUMsUUFBUSxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUMsUUFBUTtZQUM5QyxDQUFDLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFVBQUEsS0FBSyxJQUFJLE9BQUEsYUFBYSxLQUFLLEtBQUssRUFBdkIsQ0FBdUIsQ0FBQztZQUMzRSxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ1AsSUFBSSxDQUFDLEtBQUssR0FBRyxhQUFhLENBQUM7SUFDN0IsQ0FBQztJQUVELHNCQUFJLHlDQUFPO2FBQVg7WUFBQSxpQkFXQztZQVZDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUksQ0FDckMsR0FBRyxDQUFDLFVBQUEsSUFBSSxJQUFJLE9BQUEsS0FBSSxDQUFDLFlB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Q0FBQyxDQUFDLENBQUM7WUFDeEIsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQztZQUN4QixDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3ZCLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FDeEIsQ0FBQztJQUNKLENBQUM7SUFFTywwQ0FBVyxHQUFuQixVQUFvQixnQkFBeUMsRUFBRSxVQUEwQjtRQUF6RixpQkFHQztRQUg4RCwyQkFBQSxFQUFBLGFBQWEsSUFBSSxDQUFDLFFBQVE7UUFDdkYsSUFBTSxRQUFRLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxVQUFBLFNBQVMsSUFBSSxPQUFBLEtBQUksQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLEVBQUUsU0FBUyxDQUFDLEVBQTdDLENBQTZDLENBQUMsQ0FBQztRQUMvRixPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBQ0gsMkJBQUM7QUFBRCxDQUFDLEFBdk5ELElBdU5DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2RrRHJhZ01vdmUgfSBmcm9tICdAYW5ndWxhci9jZGsvZHJhZy1kcm9wJztcbmltcG9ydCB7IHNvcnRCeSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBwaXBlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgZXhwYW5kLCBmaWx0ZXIsIG1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRGFzaGJvYXJkQ29tcG9uZW50IH0gZnJvbSAnLi9kYXNoYm9hcmQuY29tcG9uZW50JztcbmltcG9ydCB7XG4gIERhc2hib2FyZENoaWxkRGltZW5zaW9uLFxuICBEYXNoYm9hcmRDaGlsZFJlc2l6ZURpbWVuc2lvbixcbiAgRGFzaGJvYXJkQ2hpbGRBcnJhbmdlbWVudFxufSBmcm9tICcuL2Rhc2hib2FyZC5tb2RlbCc7XG5pbXBvcnQgeyBEYXNoYm9hcmRDaGlsZENvbXBvbmVudCB9IGZyb20gJy4vZGFzaGJvYXJkLWNoaWxkLmNvbXBvbmVudCc7XG5cbmV4cG9ydCBjbGFzcyBEYXNoYm9hcmRDaGlsZENoYW5nZSB7XG4gIGNoaWxkOiBEYXNoYm9hcmRDaGlsZENvbXBvbmVudDtcbiAgY2hpbGRyZW46IERhc2hib2FyZENoaWxkQ29tcG9uZW50W107XG4gIHByaXZhdGUgZGFzaGJvYXJkOiBEYXNoYm9hcmRDb21wb25lbnQ7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBNSU5fV0lEVEggPSAyO1xuICBwcml2YXRlIE1JTl9IRUlHSFQgPSAxO1xuICBwcml2YXRlIHJlYWRvbmx5IFBJWEVMX1NJWkVfVEhSRVNIT0xEID0gMTA7XG5cbiAgcHJpdmF0ZSBkaWZmWCA9IDA7XG4gIHByaXZhdGUgZGlmZlkgPSAwO1xuXG4gIGNvbnN0cnVjdG9yKGNoaWxkVG9DaGFuZ2U6IERhc2hib2FyZENoaWxkQ29tcG9uZW50KSB7XG4gICAgdGhpcy5kYXNoYm9hcmQgPSBjaGlsZFRvQ2hhbmdlLmRhc2hib2FyZDtcbiAgICB0aGlzLmNoaWxkcmVuID0gY2hpbGRUb0NoYW5nZS5kYXNoYm9hcmQuY2hpbGRyZW5cbiAgICAgID8gY2hpbGRUb0NoYW5nZS5kYXNoYm9hcmQuY2hpbGRyZW4uZmlsdGVyKGNoaWxkID0+IGNoaWxkVG9DaGFuZ2UgIT09IGNoaWxkKVxuICAgICAgOiBbXTtcbiAgICB0aGlzLmNoaWxkID0gY2hpbGRUb0NoYW5nZTtcbiAgfVxuXG4gIGdldCByZXNpemUkKCkge1xuICAgIHJldHVybiB0aGlzLmNoaWxkLmRyYWdTb3VyY2UubW92ZWQucGlwZShcbiAgICAgIG1hcChtb3ZlID0+IHRoaXMuZ2V0UGl4ZWxTaXplKG1vdmUpKSxcbiAgICAgIHRhcChyZXNpemVEaW1lbnNpb24gPT4gdGhpcy5zZXRQaXhlbFNpemUocmVzaXplRGltZW5zaW9uKSksXG4gICAgICBtYXAocmVzaXplRGltZW5zaW9uID0+IHRoaXMuZ2V0RGltZW5zaW9uU2l6ZShyZXNpemVEaW1lbnNpb24pKSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKFxuICAgICAgICAocHJldiwgbmV4dCkgPT4gcHJldi53aWR0aCA9PT0gbmV4dC53aWR0aCAmJiBwcmV2LmhlaWdodCA9PT0gbmV4dC5oZWlnaHRcbiAgICAgICksXG4gICAgICBtYXAoZGltZW5zaW9uID0+IHRoaXMuc2V0RGltZW5zaW9uKGRpbWVuc2lvbikpLFxuICAgICAgdGhpcy5hcnJhbmdlUGlwZSgpXG4gICAgKTtcbiAgfVxuXG4gIGdldCBkcmFnJCgpIHtcbiAgICByZXR1cm4gdGhpcy5jaGlsZC5kcmFnU291cmNlLm1vdmVkLnBpcGUoXG4gICAgICBtYXAobW92ZSA9PiB0aGlzLmdldERpbWVuc2lvblBvc2l0aW9uKG1vdmUpKSxcbiAgICAgIGZpbHRlcihcbiAgICAgICAgZGltZW5zaW9uID0+XG4gICAgICAgICAgZGltZW5zaW9uLnggPj0gMCAmJlxuICAgICAgICAgIGRpbWVuc2lvbi54IDw9IHRoaXMuZGFzaGJvYXJkLmNvbHVtbnMgLSB0aGlzLmNoaWxkLndpZHRoICYmXG4gICAgICAgICAgZGltZW5zaW9uLnkgPj0gMFxuICAgICAgKSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKChwcmV2LCBuZXh0KSA9PiBwcmV2LnggPT09IG5leHQueCAmJiBwcmV2LnkgPT09IG5leHQueSksXG4gICAgICB0aGlzLmFycmFuZ2VQaXBlKClcbiAgICApO1xuICB9XG5cbiAgZmluZEZyZWVEaW1lbnNpb24oKSB7XG4gICAgbGV0IHkgPSAtMTtcbiAgICBsZXQgeCA9IDA7XG4gICAgbGV0IGZvdW5kID0gZmFsc2U7XG4gICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSB0aGlzLmNoaWxkO1xuICAgIGlmICh3aWR0aCA+IHRoaXMuZGFzaGJvYXJkLmNvbHVtbnMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIGNoaWxkIGRvZXMgbm90IGZpdCBvbiB0aGUgY3VycmVudCBkYXNoYm9hcmQuJyk7XG4gICAgfVxuICAgIGRvIHtcbiAgICAgIHggPSAwO1xuICAgICAgeSsrO1xuICAgICAgd2hpbGUgKHggKyB3aWR0aCA8PSB0aGlzLmRhc2hib2FyZC5jb2x1bW5zKSB7XG4gICAgICAgIGlmICh0aGlzLmdldENvbGxpZGVkKHsgeCwgeSwgd2lkdGgsIGhlaWdodCB9KS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgeCsrO1xuICAgICAgfVxuICAgIH0gd2hpbGUgKCFmb3VuZCk7XG4gICAgcmV0dXJuIHsgeCwgeSwgd2lkdGgsIGhlaWdodCB9IGFzIERhc2hib2FyZENoaWxkRGltZW5zaW9uO1xuICB9XG5cbiAgY29sbGFwc2VVcEFsbCgpOiB2b2lkIHtcbiAgICByZXR1cm4gc29ydEJ5KFt0aGlzLmNoaWxkLCAuLi50aGlzLmNoaWxkcmVuXSwgWyd5J10pLmZvckVhY2godyA9PiB7XG4gICAgICBjb25zdCBkcyA9IG5ldyBEYXNoYm9hcmRDaGlsZENoYW5nZSh3KTtcbiAgICAgIGNvbnN0IG5ld1Bvc2l0aW9uID0gZHMuY29sbGFwc2VVcCh3KTtcbiAgICAgIGRzLnNldERpbWVuc2lvbihuZXdQb3NpdGlvbik7XG4gICAgfSk7XG4gIH1cblxuICBhcnJhbmdlQWxsKGFycmFuZ2U6IERhc2hib2FyZENoaWxkQXJyYW5nZW1lbnQpIHtcbiAgICBjb25zdCB7IGN1cnJlbnQsIHNjYW4sIHNwYWNpbmcsIG9yaWdpbiB9ID0gYXJyYW5nZTtcbiAgICBjb25zdCBjb2xsaWRlZCA9IHRoaXMuZ2V0Q29sbGlkZWQoY3VycmVudCwgc29ydEJ5KHNjYW4sIFsneSddKSk7XG4gICAgcmV0dXJuIGNvbGxpZGVkLm1hcChjaGlsZCA9PiB7XG4gICAgICBjb25zdCBkcyA9IG5ldyBEYXNoYm9hcmRDaGlsZENoYW5nZShjaGlsZCk7XG4gICAgICBkcy5zZXREaW1lbnNpb24oeyAuLi5jaGlsZCwgeTogc3BhY2luZyB9KTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGN1cnJlbnQ6IGNoaWxkLFxuICAgICAgICBzY2FuOiBzY2FuLmZpbHRlcih3ID0+IHcgIT09IGNoaWxkKSxcbiAgICAgICAgc3BhY2luZzogY2hpbGQueSArIGNoaWxkLmhlaWdodCxcbiAgICAgICAgb3JpZ2luXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhcnJhbmdlUGlwZSgpIHtcbiAgICByZXR1cm4gcGlwZShcbiAgICAgIG1hcChcbiAgICAgICAgKGRpbWVuc2lvbjogRGFzaGJvYXJkQ2hpbGREaW1lbnNpb24pID0+XG4gICAgICAgICAgKHtcbiAgICAgICAgICAgIGN1cnJlbnQ6IGRpbWVuc2lvbixcbiAgICAgICAgICAgIHNjYW46IHRoaXMuY2hpbGRyZW4sXG4gICAgICAgICAgICBzcGFjaW5nOiBkaW1lbnNpb24ueSArIGRpbWVuc2lvbi5oZWlnaHQsXG4gICAgICAgICAgICBvcmlnaW46IHsgLi4uZGltZW5zaW9uIH1cbiAgICAgICAgICB9IGFzIERhc2hib2FyZENoaWxkQXJyYW5nZW1lbnQpXG4gICAgICApLFxuICAgICAgZXhwYW5kKChkaW1lbnNpb25zOiBEYXNoYm9hcmRDaGlsZEFycmFuZ2VtZW50KSA9PiB0aGlzLmFycmFuZ2VBbGwoZGltZW5zaW9ucykpLFxuICAgICAgbWFwKCh7IG9yaWdpbiB9KSA9PiBvcmlnaW4pLFxuICAgICAgbWFwKGRpbWVuc2lvbiA9PiB0aGlzLnNldERpbWVuc2lvbihkaW1lbnNpb24sIHRydWUpKSxcbiAgICAgIHRhcCgoKSA9PiB0aGlzLmNvbGxhcHNlVXBBbGwoKSksXG4gICAgICB0YXAoKCkgPT4gdGhpcy5kYXNoYm9hcmQuZ2V0TGFzdFJvdygpKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNvbGxhcHNlVXAoZGltZW5zaW9uOiBEYXNoYm9hcmRDaGlsZERpbWVuc2lvbikge1xuICAgIGxldCB7IHkgfSA9IGRpbWVuc2lvbjtcbiAgICB3aGlsZSAoeSA+IDApIHtcbiAgICAgIGlmICh0aGlzLmdldENvbGxpZGVkKHsgLi4uZGltZW5zaW9uLCB5OiB5IC0gMSB9KS5sZW5ndGggIT09IDApIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICB5LS07XG4gICAgfVxuICAgIHJldHVybiB7IC4uLmRpbWVuc2lvbiwgeSB9O1xuICB9XG5cbiAgcHJpdmF0ZSBzZXREaW1lbnNpb24oZGltZW5zaW9uOiBEYXNoYm9hcmRDaGlsZERpbWVuc2lvbiwgbm90SWZDb2xsaWRpbmcgPSBmYWxzZSkge1xuICAgIGlmIChub3RJZkNvbGxpZGluZyAmJiB0aGlzLmdldENvbGxpZGVkKGRpbWVuc2lvbikubGVuZ3RoID4gMCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuY2hpbGQueCA9IGRpbWVuc2lvbi54O1xuICAgIHRoaXMuY2hpbGQueSA9IGRpbWVuc2lvbi55O1xuICAgIGlmIChcbiAgICAgIGRpbWVuc2lvbi53aWR0aCA+PSB0aGlzLk1JTl9XSURUSCAmJlxuICAgICAgZGltZW5zaW9uLnggKyBkaW1lbnNpb24ud2lkdGggPD0gdGhpcy5kYXNoYm9hcmQuY29sdW1uc1xuICAgICkge1xuICAgICAgdGhpcy5jaGlsZC53aWR0aCA9IGRpbWVuc2lvbi53aWR0aDtcbiAgICB9IGVsc2UgaWYgKGRpbWVuc2lvbi53aWR0aCA8IHRoaXMuTUlOX1dJRFRIKSB7XG4gICAgICBkaW1lbnNpb24ud2lkdGggPSB0aGlzLk1JTl9XSURUSDtcbiAgICB9IGVsc2Uge1xuICAgICAgZGltZW5zaW9uLndpZHRoID0gdGhpcy5kYXNoYm9hcmQuY29sdW1ucyAtIGRpbWVuc2lvbi54O1xuICAgIH1cbiAgICBpZiAoZGltZW5zaW9uLmhlaWdodCA+PSB0aGlzLk1JTl9IRUlHSFQpIHtcbiAgICAgIHRoaXMuY2hpbGQuaGVpZ2h0ID0gZGltZW5zaW9uLmhlaWdodDtcbiAgICB9IGVsc2Uge1xuICAgICAgZGltZW5zaW9uLmhlaWdodCA9IHRoaXMuTUlOX1dJRFRIO1xuICAgIH1cbiAgICByZXR1cm4gZGltZW5zaW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRQaXhlbFNpemUoeyB3aWR0aCwgaGVpZ2h0IH0pIHtcbiAgICBpZiAod2lkdGggPj0gdGhpcy5kYXNoYm9hcmQuY29sdW1uU2l6ZSAqIHRoaXMuTUlOX1dJRFRIIC0gdGhpcy5kYXNoYm9hcmQuZ2FwKSB7XG4gICAgICB0aGlzLmNoaWxkLnB4V2lkdGggPSB3aWR0aCArIHRoaXMuUElYRUxfU0laRV9USFJFU0hPTEQ7XG4gICAgfVxuICAgIGlmIChoZWlnaHQgPj0gdGhpcy5kYXNoYm9hcmQucm93U2l6ZSAqIHRoaXMuTUlOX0hFSUdIVCAtIHRoaXMuZGFzaGJvYXJkLmdhcCkge1xuICAgICAgdGhpcy5jaGlsZC5weEhlaWdodCA9IGhlaWdodCArIHRoaXMuUElYRUxfU0laRV9USFJFU0hPTEQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRQaXhlbFNpemUobW92ZUV2ZW50OiBDZGtEcmFnTW92ZSkge1xuICAgIGNvbnN0IGRyYWdnZWRFbGVtZW50ID0gbW92ZUV2ZW50LnNvdXJjZS5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQucGFyZW50Tm9kZSBhcyBIVE1MRWxlbWVudDtcbiAgICBpZiAoIXRoaXMuZGlmZlgpIHtcbiAgICAgIGNvbnN0IHJlY3QgPSBkcmFnZ2VkRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgIHRoaXMuZGlmZlggPSAgcmVjdC5sZWZ0O1xuICAgICAgdGhpcy5kaWZmWSA9ICByZWN0LnRvcDtcbiAgICB9XG4gICAgY29uc3QgeyB4LCB5IH0gPSBtb3ZlRXZlbnQucG9pbnRlclBvc2l0aW9uO1xuICAgIGNvbnN0IHdpZHRoID0gTWF0aC5yb3VuZCh4IC0gdGhpcy5kaWZmWCk7XG4gICAgY29uc3QgaGVpZ2h0ID0gTWF0aC5yb3VuZCh5IC0gdGhpcy5kaWZmWSk7XG4gICAgcmV0dXJuIHsgd2lkdGgsIGhlaWdodCwgcG9pbnRlcjogeyB4LCB5IH0gfSBhcyBEYXNoYm9hcmRDaGlsZFJlc2l6ZURpbWVuc2lvbjtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGltZW5zaW9uU2l6ZShyZXNpemVQb3NpdGlvbjogRGFzaGJvYXJkQ2hpbGRSZXNpemVEaW1lbnNpb24pIHtcbiAgICBjb25zdCB7IHgsIHkgfSA9IHRoaXMuY2hpbGQ7XG4gICAgY29uc3QgZHMgPSB0aGlzLmRhc2hib2FyZC5kYXNoYm9hcmRSZWN0O1xuICAgIGNvbnN0IGNvbHVtbiA9IHRoaXMuZGFzaGJvYXJkLmNvbHVtblNpemU7XG4gICAgY29uc3Qgcm93ID0gdGhpcy5kYXNoYm9hcmQucm93U2l6ZSArIHRoaXMuZGFzaGJvYXJkLmdhcDtcbiAgICBjb25zdCB3aWR0aCA9XG4gICAgICBNYXRoLnJvdW5kKChyZXNpemVQb3NpdGlvbi5wb2ludGVyLnggLSBkcy5sZWZ0ICsgdGhpcy5kYXNoYm9hcmQuZ2FwKSAvIGNvbHVtbikgLSB4O1xuICAgIGNvbnN0IGhlaWdodCA9IE1hdGgucm91bmQoKHJlc2l6ZVBvc2l0aW9uLnBvaW50ZXIueSAtIGRzLnRvcCArIHRoaXMuZGFzaGJvYXJkLmdhcCkgLyByb3cpIC0geTtcbiAgICByZXR1cm4geyB4LCB5LCB3aWR0aCwgaGVpZ2h0IH0gYXMgRGFzaGJvYXJkQ2hpbGREaW1lbnNpb247XG4gIH1cblxuICBwcml2YXRlIGdldERpbWVuc2lvblBvc2l0aW9uKG1vdmVFdmVudDogQ2RrRHJhZ01vdmUpIHtcbiAgICBjb25zdCBkcmFnZ2VkRWxlbWVudCA9IG1vdmVFdmVudC5zb3VyY2UuZWxlbWVudC5uYXRpdmVFbGVtZW50Lm5leHRFbGVtZW50U2libGluZztcbiAgICBpZiAoIXRoaXMuZGlmZlgpIHtcbiAgICAgIGNvbnN0IHJlY3QgPSBkcmFnZ2VkRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgIHRoaXMuZGlmZlggPSAgbW92ZUV2ZW50LnBvaW50ZXJQb3NpdGlvbi54IC0gcmVjdC5sZWZ0O1xuICAgICAgdGhpcy5kaWZmWSA9ICBtb3ZlRXZlbnQucG9pbnRlclBvc2l0aW9uLnkgLSByZWN0LnRvcDtcbiAgICB9XG5cbiAgICBjb25zdCBsZWZ0ID0gbW92ZUV2ZW50LnBvaW50ZXJQb3NpdGlvbi54IC0gdGhpcy5kaWZmWDtcbiAgICBjb25zdCB0b3AgPSBtb3ZlRXZlbnQucG9pbnRlclBvc2l0aW9uLnkgLSB0aGlzLmRpZmZZO1xuICAgIGNvbnN0IHsgd2lkdGgsIGhlaWdodCB9ID0gdGhpcy5jaGlsZDtcbiAgICBjb25zdCBkcyA9IHRoaXMuZGFzaGJvYXJkLmRhc2hib2FyZFJlY3Q7XG4gICAgY29uc3QgY29sdW1uID0gdGhpcy5kYXNoYm9hcmQuY29sdW1uU2l6ZTtcbiAgICBjb25zdCByb3cgPSB0aGlzLmRhc2hib2FyZC5yb3dTaXplICsgdGhpcy5kYXNoYm9hcmQuZ2FwIC8gMjtcbiAgICBjb25zdCB4ID0gTWF0aC5yb3VuZCgobGVmdCAtIGRzLmxlZnQpIC8gY29sdW1uKTtcbiAgICBjb25zdCB5ID0gTWF0aC5yb3VuZCgodG9wIC0gZHMudG9wKSAvIHJvdyk7XG4gICAgcmV0dXJuIHsgeCwgeSwgd2lkdGgsIGhlaWdodCB9IGFzIERhc2hib2FyZENoaWxkRGltZW5zaW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBkb2VzQ29sbGlkZShhOiBEYXNoYm9hcmRDaGlsZERpbWVuc2lvbiwgYjogRGFzaGJvYXJkQ2hpbGREaW1lbnNpb24pIHtcbiAgICBpZiAoYi54ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuICEoXG4gICAgICBhLnkgKyBhLmhlaWdodCAtIDEgPCBiLnkgfHxcbiAgICAgIGEueSA+IGIueSArIGIuaGVpZ2h0IC0gMSB8fFxuICAgICAgYS54ICsgYS53aWR0aCAtIDEgPCBiLnggfHxcbiAgICAgIGEueCA+IGIueCArIGIud2lkdGggLSAxXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q29sbGlkZWQoY3VycmVudERpbWVuc2lvbjogRGFzaGJvYXJkQ2hpbGREaW1lbnNpb24sIGRpbWVuc2lvbnMgPSB0aGlzLmNoaWxkcmVuKSB7XG4gICAgY29uc3QgY29sbGlkZWQgPSBkaW1lbnNpb25zLmZpbHRlcihkaW1lbnNpb24gPT4gdGhpcy5kb2VzQ29sbGlkZShjdXJyZW50RGltZW5zaW9uLCBkaW1lbnNpb24pKTtcbiAgICByZXR1cm4gY29sbGlkZWQ7XG4gIH1cbn1cbiJdfQ==