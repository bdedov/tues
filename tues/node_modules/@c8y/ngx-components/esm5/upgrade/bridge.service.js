import * as tslib_1 from "tslib";
import { ActionService, AppStateService, EmptyComponent, RouterService, ViewContext, gettext } from '@c8y/ngx-components';
import { BehaviorSubject, combineLatest, from, fromEventPattern, of } from 'rxjs';
import { debounceTime, filter, map, merge, startWith, switchMap } from 'rxjs/operators';
import { isArray } from 'lodash-es';
import { ActivationEnd } from '@angular/router';
import { NgZone } from '@angular/core';
import { Router } from '@angular/router';
import { ViewContextLegacyParameter } from './ng1/views.provider';
var BridgeService = /** @class */ (function () {
    function BridgeService(injector, appState, router, ngZone, routerService, actionService) {
        this.injector = injector;
        this.appState = appState;
        this.router = router;
        this.ngZone = ngZone;
        this.routerService = routerService;
        this.actionService = actionService;
        this.$liveTabs = new BehaviorSubject([]);
        this.fixE2eIssues();
        this.$ng1RouteChangeSuccess = this.fromNg1Event(this.injector.get('$rootScope'), '$routeChangeSuccess');
        this.$ng1RouteChangeStart = this.fromNg1Event(this.injector.get('$rootScope'), '$routeChangeStart');
        this.hookLanguage();
        this.hookTabs();
        this.hookNavigator();
        this.hookUserMenu();
        this.hookViewProvider();
        this.router.initialNavigation();
        this.ng1Routes();
    }
    BridgeService.prototype.hookViewProvider = function () {
        var _this = this;
        var c8yViews = this.injector.get('c8yViews');
        // fix to trigger an angularjs route change success
        // event on context route match to make legacy
        // view-providers resolve.
        c8yViews.when('/device/:id', {
            template: ''
        });
        c8yViews.when('/group/:id', {
            template: ''
        });
        c8yViews.contextViews.subscribe(function (cfg) { return _this.addRoute(cfg); });
    };
    BridgeService.prototype.addRoute = function (cfg) {
        var _this = this;
        this.routerService.addRoute({
            label: cfg.label || cfg.name,
            path: cfg.path,
            icon: cfg.icon,
            context: ViewContext[cfg.contextKey],
            priority: cfg.priority,
            component: EmptyComponent,
            data: {
                showIf: cfg.showIf
                    ? function (ngxRoute) {
                        var _a;
                        var params = tslib_1.__assign({}, ngxRoute.params, (_a = {}, _a[ViewContextLegacyParameter[cfg.contextKey]] = ngxRoute.params.id, _a));
                        var showIfResult = _this.injector.invoke(cfg.showIf, undefined, {
                            $routeParams: params
                        });
                        // make sure showIf result is a promise with boolean result:
                        return _this.injector
                            .get('$q')
                            .when(showIfResult)
                            .then(Boolean);
                    }
                    : undefined
            }
        });
        if (cfg.runPhase) {
            this.routerService.refresh();
        }
    };
    BridgeService.prototype.ng1Routes = function () {
        var template = '';
        var fallbackRoutes = [];
        // tslint:disable-next-line: forin
        for (var context in ViewContext) {
            var path = ViewContext[context].match(/(\w+)\//)[1];
            var regexp = new RegExp("^/" + path + "/(?:([^/]+)).*$");
            fallbackRoutes.push({
                keys: [{ name: ViewContextLegacyParameter[context], optional: false }],
                regexp: regexp,
                template: template
            });
        }
        /**
         * When asset detail routes (/device/:id,  /group/:id) are matched in Angular Router, ngRoute in
         * angular.js must also have matching generic routes so that the ids can be extracted from the paths and
         * injected in multiple calls (showIf, c8yActions, etc) as properties of $routeParams.
         *
         * The function in src/ngRoute/route.js (angular.js) where the routes are matched is called parseRoute(). This
         * function calls angular.forEach and in turn this function checks for the presence of a forEach method before
         * trying object key iteration.
         * By attaching a non enumerable forEach method to the routes object we guarantee that the fallback generic routes
         * are only matched after any other registered through $routeProvider.when.
         */
        var $route = this.injector.get('$route');
        Object.defineProperty($route.routes, 'forEach', {
            // make non enumerable
            value: function forEach(iterator, context) {
                // tslint:disable-next-line: forin
                for (var key in this) {
                    iterator.call(context, this[key], key, this);
                }
                fallbackRoutes.forEach(function (r) { return iterator.call(context, r); });
            }
        });
        /**
         * Some functions use the current context. As some parts are upgraded and some not, the following updates the
         * angularjs getContext function to resolve always the right context.
         */
        var c8yUiUtil = this.injector.get('c8yUiUtil');
        var _getContext = c8yUiUtil.getContext;
        this.router.events
            .pipe(filter(function (event) { return event instanceof ActivationEnd; }))
            .subscribe(function (event) {
            if (event.snapshot.routeConfig.path === '**') {
                c8yUiUtil.getContext = _getContext;
            }
            else if (event.snapshot.data && event.snapshot.data.context) {
                c8yUiUtil.getContext = function () {
                    return {
                        context: event.snapshot.data.context.replace('/:id', ''),
                        id: event.snapshot.data.contextData.id
                    };
                };
            }
            else {
                c8yUiUtil.getContext = function () { return ({ context: null, id: null }); };
            }
        });
    };
    BridgeService.prototype.fixE2eIssues = function () {
        try {
            var ngZone_1 = this.ngZone;
            var Utils_1 = window.org.cometd.Utils;
            var timeoutFn_1 = Utils_1.setTimeout;
            // tslint:disable-next-line:only-arrow-functions
            Utils_1.setTimeout = function () {
                var args = [];
                for (var _i = 0; _i < arguments.length; _i++) {
                    args[_i] = arguments[_i];
                }
                return ngZone_1.runOutsideAngular(function () { return timeoutFn_1.apply(Utils_1, args); });
            };
        }
        catch (e) {
            // do nothing
        }
        try {
            var ace_1 = window.ace;
            var editFn_1 = ace_1.edit;
            var ngZone_2 = this.ngZone;
            // tslint:disable-next-line:only-arrow-functions
            ace_1.edit = function () {
                var args = [];
                for (var _i = 0; _i < arguments.length; _i++) {
                    args[_i] = arguments[_i];
                }
                return ngZone_2.runOutsideAngular(function () { return editFn_1.apply(ace_1, args); });
            };
        }
        catch (e) {
            // do nothing
        }
    };
    BridgeService.prototype.hookLanguage = function () {
        var _this = this;
        var first = true;
        this.appState
            .map(function (store) { return store.lang; })
            .subscribe(function (lang) {
            _this.injector.get('c8yLocales').switchToLanguage(lang);
            if (!first) {
                _this.injector.get('$rootScope').$apply();
            }
            first = false;
        });
    };
    BridgeService.prototype.hookTabs = function () {
        var _this = this;
        // Just for instantiation of the c8yAction service
        this.injector.get('c8yActions');
        var $location = this.injector.get('$location');
        var c8yTabs = this.injector.get('c8yTabs');
        var liveTabs = [];
        c8yTabs.addTab = function (tab) {
            liveTabs.push(tslib_1.__assign({}, tab, { label: tab.label || tab.name, path: decodeURIComponent(tab.path) }));
            _this.$liveTabs.next(liveTabs);
        };
        this.$ng1RouteChangeStart.subscribe(function (e) {
            liveTabs = [];
            _this.$liveTabs.next(liveTabs);
        });
        this.$ng1RouteChangeSuccess.subscribe(function (e) {
            var path = $location.path();
            if (_this.router.url !== path) {
                _this.router.navigate(path === '/' ? '' : path.split('/'), {
                    queryParams: $location.search(),
                    skipLocationChange: true
                });
            }
            if (_this.actionService) {
                _this.actionService.refresh();
            }
        });
        this.$routeChanges = this.$ng1RouteChangeSuccess.pipe(merge(this.fromNg1Event(c8yTabs, c8yTabs.EVENT_UPDATE), of(1)), debounceTime(100));
    };
    BridgeService.prototype.hookNavigator = function () {
        this.navigationNodes$ = this.injector.get('c8yNavigator').rootNodes$;
    };
    BridgeService.prototype.getTabs = function () {
        var _this = this;
        var onlyVisible = function (_a) {
            var show = _a.show;
            return show;
        };
        var upgradeTab = function (tab) { return (tslib_1.__assign({}, tab, { label: tab.label || tab.name, path: decodeURIComponent(tab.path) })); };
        var routeTabs = this.$routeChanges.pipe(switchMap(function () {
            var routes = _this.injector.get('c8yTabs').routeTabs;
            var visibilityPromise = Promise.all(routes.map(function (_a) {
                var checkingVisibility = _a.checkingVisibility;
                return checkingVisibility;
            }));
            return visibilityPromise.then(function () { return routes.filter(onlyVisible).map(upgradeTab); });
        }), startWith([]));
        return combineLatest(routeTabs, this.$liveTabs).pipe(map(function (_a) {
            var _b = tslib_1.__read(_a, 2), route = _b[0], live = _b[1];
            return route.concat(live);
        }));
    };
    BridgeService.prototype.getQuickLinks = function () {
        var c8yQuickLinks = this.injector.get('c8yQuickLinks');
        return c8yQuickLinks.list();
    };
    BridgeService.prototype.getActionBarItems = function () {
        var c8yActionBar = this.injector.get('c8yActionBar');
        var $rootScope = this.injector.get('$rootScope');
        var getActionBarElements = function () {
            return c8yActionBar.elements.map(function (element) { return ({
                priority: element.getAttribute('action-bar-priority') || 0,
                template: element,
                placement: element.getAttribute('action-bar-position') || 'right'
            }); });
        };
        return this.fromNg1Event($rootScope, 'c8yActionBarChanged').pipe(startWith(1), map(getActionBarElements));
    };
    BridgeService.prototype.getBreadcrumbs = function () {
        var $location = this.injector.get('$location');
        var path = $location.path();
        var c8yBreadcrumbs = this.injector.get('c8yBreadcrumbs');
        var breadcrumbs = c8yBreadcrumbs.get(path) || {};
        var breadcrumbsData = this.resolveBreadcrumbsData(breadcrumbs.data);
        return from(breadcrumbsData).pipe(map(function (value) {
            var liveBreadcrumbs = c8yBreadcrumbs.getLiveBreadcrumbs();
            value = value.concat(liveBreadcrumbs);
            return value.map(function (items) { return ({ items: items }); });
        }));
    };
    BridgeService.prototype.resolveBreadcrumbsData = function (data) {
        try {
            return this.injector.invoke(data);
        }
        catch (ex) {
            // empty
        }
        if (isArray(data)) {
            return of([data]);
        }
        return of([]);
    };
    BridgeService.prototype.getSearch = function () {
        var c8ySearch = this.injector.get('c8ySearch');
        return c8ySearch.list().map(function (item) {
            return {
                icon: 'search',
                name: item.name,
                term: '',
                onSearch: function () {
                    if (this.term) {
                        c8ySearch.search(this.term);
                    }
                }
            };
        });
    };
    BridgeService.prototype.getActions = function () {
        var _this = this;
        var registeredActions = this.injector.get('c8yActions').registeredActions;
        return of(registeredActions
            .filter(function (action) { return !action.hidden; })
            .map(function (action) { return ({
            // The priority was reversed: Aligned it to dashboard, high first, low last.
            priority: (action.priority || 0) * -1,
            label: action.text,
            icon: action.icon,
            disabled: action.disabled,
            action: function () {
                _this.injector.invoke(action.action, action);
            }
        }); }));
    };
    BridgeService.prototype.fromNg1Event = function (obj, evt) {
        var stopListening;
        function add(handler) {
            stopListening = obj.$on(evt, handler);
        }
        return fromEventPattern(add, function () { return stopListening(); });
    };
    BridgeService.prototype.hookUserMenu = function () {
        var userMenuService = this.injector.get('c8yUserMenuService');
        var c8yAccessDenied = this.injector.get('c8yAccessDenied');
        userMenuService.add({
            icon: 'exclamation-triangle',
            priority: 10,
            label: gettext('Access denied requests'),
            click: c8yAccessDenied.showAccessDeniedRequestsList
        });
    };
    return BridgeService;
}());
export { BridgeService };
export function bridgeServiceFactory(injector, appState, router, ngZone, routerService, actionService) {
    return new BridgeService(injector, appState, router, ngZone, routerService, actionService);
}
export var bridgeServiceProvider = {
    provide: BridgeService,
    useFactory: bridgeServiceFactory,
    deps: ['$injector', AppStateService, Router, NgZone, RouterService, ActionService]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnJpZGdlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL3VwZ3JhZGUvIiwic291cmNlcyI6WyJicmlkZ2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUdMLGFBQWEsRUFDYixlQUFlLEVBR2YsY0FBYyxFQUNkLGFBQWEsRUFHYixXQUFXLEVBQ1gsT0FBTyxFQUVSLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUNMLGVBQWUsRUFHZixhQUFhLEVBQ2IsSUFBSSxFQUNKLGdCQUFnQixFQUNoQixFQUFFLEVBQ0gsTUFBTSxNQUFNLENBQUM7QUFDZCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFRLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5RixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRXBDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNoRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUVsRTtJQU1FLHVCQUNTLFFBQWEsRUFDWixRQUF5QixFQUMxQixNQUFjLEVBQ2IsTUFBYyxFQUNkLGFBQTRCLEVBQzVCLGFBQTRCO1FBTDdCLGFBQVEsR0FBUixRQUFRLENBQUs7UUFDWixhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQUMxQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2IsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBUnRDLGNBQVMsR0FBbUIsSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFD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LEVBQUUsRUFBRTtZQUNaLEtBQUssRUFBRSxPQUFPLENBQUMsd0JBQXdCLENBQUM7WUFDeEMsS0FBSyxFQUFFLGVBQWUsQ0FBQyw0QkFBNEI7U0FDcEQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNILG9CQUFDO0FBQUQsQ0FBQyxBQXZWRCxJQXVWQzs7QUFFRCxNQUFNLFVBQVUsb0JBQW9CLENBQ2xDLFFBQWEsRUFDYixRQUF5QixFQUN6QixNQUFjLEVBQ2QsTUFBYyxFQUNkLGFBQTRCLEVBQzVCLGFBQTRCO0lBRTVCLE9BQU8sSUFBSSxhQUFhLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBRSxhQUFhLENBQUMsQ0FBQztBQUM3RixDQUFDO0FBRUQsTUFBTSxDQUFDLElBQU0scUJBQXFCLEdBQUc7SUFDbkMsT0FBTyxFQUFFLGFBQWE7SUFDdEIsVUFBVSxFQUFFLG9CQUFvQjtJQUNoQyxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsZUFBZSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsYUFBYSxFQUFFLGFBQWEsQ0FBQztDQUNuRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWN0aW9uLFxuICBBY3Rpb25CYXJJdGVtLFxuICBBY3Rpb25TZXJ2aWNlLFxuICBBcHBTdGF0ZVNlcnZpY2UsXG4gIEJyZWFkY3J1bWIsXG4gIEJyZWFkY3J1bWJJdGVtLFxuICBFbXB0eUNvbXBvbmVudCxcbiAgUm91dGVyU2VydmljZSxcbiAgU2VhcmNoLFxuICBUYWIsXG4gIFZpZXdDb250ZXh0LFxuICBnZXR0ZXh0LFxuICBEb2NMaW5rXG59IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHtcbiAgQmVoYXZpb3JTdWJqZWN0LFxuICBPYnNlcnZhYmxlLFxuICBTdWJqZWN0LFxuICBjb21iaW5lTGF0ZXN0LFxuICBmcm9tLFxuICBmcm9tRXZlbnRQYXR0ZXJuLFxuICBvZlxufSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgZmlsdGVyLCBtYXAsIG1lcmdlLCBza2lwLCBzdGFydFdpdGgsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IGlzQXJyYXkgfSBmcm9tICdsb2Rhc2gtZXMnO1xuXG5pbXBvcnQgeyBBY3RpdmF0aW9uRW5kIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IFZpZXdDb250ZXh0TGVnYWN5UGFyYW1ldGVyIH0gZnJvbSAnLi9uZzEvdmlld3MucHJvdmlkZXInO1xuXG5leHBvcnQgY2xhc3MgQnJpZGdlU2VydmljZSB7XG4gICRyb3V0ZUNoYW5nZXM6IE9ic2VydmFibGU8YW55PjtcbiAgJG5nMVJvdXRlQ2hhbmdlU3VjY2VzczogT2JzZXJ2YWJsZTxhbnk+O1xuICAkbmcxUm91dGVDaGFuZ2VTdGFydDogT2JzZXJ2YWJsZTxhbnk+O1xuICAkbGl2ZVRhYnM6IFN1YmplY3Q8VGFiW10+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChbXSk7XG4gIG5hdmlnYXRpb25Ob2RlcyQ6IE9ic2VydmFibGU8YW55PjtcbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGluamVjdG9yOiBhbnksXG4gICAgcHJpdmF0ZSBhcHBTdGF0ZTogQXBwU3RhdGVTZXJ2aWNlLFxuICAgIHB1YmxpYyByb3V0ZXI6IFJvdXRlcixcbiAgICBwcml2YXRlIG5nWm9uZTogTmdab25lLFxuICAgIHByaXZhdGUgcm91dGVyU2VydmljZTogUm91dGVyU2VydmljZSxcbiAgICBwcml2YXRlIGFjdGlvblNlcnZpY2U6IEFjdGlvblNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5maXhFMmVJc3N1ZXMoKTtcbiAgICB0aGlzLiRuZzFSb3V0ZUNoYW5nZVN1Y2Nlc3MgPSB0aGlzLmZyb21OZzFFdmVudChcbiAgICAgIHRoaXMuaW5qZWN0b3IuZ2V0KCckcm9vdFNjb3BlJyksXG4gICAgICAnJHJvdXRlQ2hhbmdlU3VjY2VzcydcbiAgICApO1xuICAgIHRoaXMuJG5nMVJvdXRlQ2hhbmdlU3RhcnQgPSB0aGlzLmZyb21OZzFFdmVudChcbiAgICAgIHRoaXMuaW5qZWN0b3IuZ2V0KCckcm9vdFNjb3BlJyksXG4gICAgICAnJHJvdXRlQ2hhbmdlU3RhcnQnXG4gICAgKTtcbiAgICB0aGlzLmhvb2tMYW5ndWFnZSgpO1xuICAgIHRoaXMuaG9va1RhYnMoKTtcbiAgICB0aGlzLmhvb2tOYXZpZ2F0b3IoKTtcbiAgICB0aGlzLmhvb2tVc2VyTWVudSgpO1xuICAgIHRoaXMuaG9va1ZpZXdQcm92aWRlcigpO1xuICAgIHRoaXMucm91dGVyLmluaXRpYWxOYXZpZ2F0aW9uKCk7XG4gICAgdGhpcy5uZzFSb3V0ZXMoKTtcbiAgfVxuXG4gIGhvb2tWaWV3UHJvdmlkZXIoKSB7XG4gICAgY29uc3QgYzh5Vmlld3MgPSB0aGlzLmluamVjdG9yLmdldCgnYzh5Vmlld3MnKTtcbiAgICAvLyBmaXggdG8gdHJpZ2dlciBhbiBhbmd1bGFyanMgcm91dGUgY2hhbmdlIHN1Y2Nlc3NcbiAgICAvLyBldmVudCBvbiBjb250ZXh0IHJvdXRlIG1hdGNoIHRvIG1ha2UgbGVnYWN5XG4gICAgLy8gdmlldy1wcm92aWRlcnMgcmVzb2x2ZS5cbiAgICBjOHlWaWV3cy53aGVuKCcvZGV2aWNlLzppZCcsIHtcbiAgICAgIHRlbXBsYXRlOiAnJ1xuICAgIH0pO1xuICAgIGM4eVZpZXdzLndoZW4oJy9ncm91cC86aWQnLCB7XG4gICAgICB0ZW1wbGF0ZTogJydcbiAgICB9KTtcbiAgICBjOHlWaWV3cy5jb250ZXh0Vmlld3Muc3Vic2NyaWJlKGNmZyA9PiB0aGlzLmFkZFJvdXRlKGNmZykpO1xuICB9XG5cbiAgYWRkUm91dGUoY2ZnKSB7XG4gICAgdGhpcy5yb3V0ZXJTZXJ2aWNlLmFkZFJvdXRlKHtcbiAgICAgIGxhYmVsOiBjZmcubGFiZWwgfHwgY2ZnLm5hbWUsXG4gICAgICBwYXRoOiBjZmcucGF0aCxcbiAgICAgIGljb246IGNmZy5pY29uLFxuICAgICAgY29udGV4dDogVmlld0NvbnRleHRbY2ZnLmNvbnRleHRLZXldIGFzIFZpZXdDb250ZXh0LFxuICAgICAgcHJpb3JpdHk6IGNmZy5wcmlvcml0eSxcbiAgICAgIGNvbXBvbmVudDogRW1wdHlDb21wb25lbnQsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIHNob3dJZjogY2ZnLnNob3dJZlxuICAgICAgICAgID8gbmd4Um91dGUgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICAgICAgICAgICAgLi4ubmd4Um91dGUucGFyYW1zLFxuICAgICAgICAgICAgICAgIFtWaWV3Q29udGV4dExlZ2FjeVBhcmFtZXRlcltjZmcuY29udGV4dEtleV1dOiBuZ3hSb3V0ZS5wYXJhbXMuaWRcbiAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgY29uc3Qgc2hvd0lmUmVzdWx0ID0gdGhpcy5pbmplY3Rvci5pbnZva2UoY2ZnLnNob3dJZiwgdW5kZWZpbmVkLCB7XG4gICAgICAgICAgICAgICAgJHJvdXRlUGFyYW1zOiBwYXJhbXNcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSBzaG93SWYgcmVzdWx0IGlzIGEgcHJvbWlzZSB3aXRoIGJvb2xlYW4gcmVzdWx0OlxuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbmplY3RvclxuICAgICAgICAgICAgICAgIC5nZXQoJyRxJylcbiAgICAgICAgICAgICAgICAud2hlbihzaG93SWZSZXN1bHQpXG4gICAgICAgICAgICAgICAgLnRoZW4oQm9vbGVhbik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgOiB1bmRlZmluZWRcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmIChjZmcucnVuUGhhc2UpIHtcbiAgICAgIHRoaXMucm91dGVyU2VydmljZS5yZWZyZXNoKCk7XG4gICAgfVxuICB9XG5cbiAgbmcxUm91dGVzKCkge1xuICAgIGNvbnN0IHRlbXBsYXRlID0gJyc7XG4gICAgY29uc3QgZmFsbGJhY2tSb3V0ZXMgPSBbXTtcblxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogZm9yaW5cbiAgICBmb3IgKGNvbnN0IGNvbnRleHQgaW4gVmlld0NvbnRleHQpIHtcbiAgICAgIGNvbnN0IHBhdGggPSBWaWV3Q29udGV4dFtjb250ZXh0XS5tYXRjaCgvKFxcdyspXFwvLylbMV07XG4gICAgICBjb25zdCByZWdleHAgPSBuZXcgUmVnRXhwKGBeLyR7cGF0aH0vKD86KFteL10rKSkuKiRgKTtcbiAgICAgIGZhbGxiYWNrUm91dGVzLnB1c2goe1xuICAgICAgICBrZXlzOiBbeyBuYW1lOiBWaWV3Q29udGV4dExlZ2FjeVBhcmFtZXRlcltjb250ZXh0XSwgb3B0aW9uYWw6IGZhbHNlIH1dLFxuICAgICAgICByZWdleHAsXG4gICAgICAgIHRlbXBsYXRlXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBXaGVuIGFzc2V0IGRldGFpbCByb3V0ZXMgKC9kZXZpY2UvOmlkLCAgL2dyb3VwLzppZCkgYXJlIG1hdGNoZWQgaW4gQW5ndWxhciBSb3V0ZXIsIG5nUm91dGUgaW5cbiAgICAgKiBhbmd1bGFyLmpzIG11c3QgYWxzbyBoYXZlIG1hdGNoaW5nIGdlbmVyaWMgcm91dGVzIHNvIHRoYXQgdGhlIGlkcyBjYW4gYmUgZXh0cmFjdGVkIGZyb20gdGhlIHBhdGhzIGFuZFxuICAgICAqIGluamVjdGVkIGluIG11bHRpcGxlIGNhbGxzIChzaG93SWYsIGM4eUFjdGlvbnMsIGV0YykgYXMgcHJvcGVydGllcyBvZiAkcm91dGVQYXJhbXMuXG4gICAgICpcbiAgICAgKiBUaGUgZnVuY3Rpb24gaW4gc3JjL25nUm91dGUvcm91dGUuanMgKGFuZ3VsYXIuanMpIHdoZXJlIHRoZSByb3V0ZXMgYXJlIG1hdGNoZWQgaXMgY2FsbGVkIHBhcnNlUm91dGUoKS4gVGhpc1xuICAgICAqIGZ1bmN0aW9uIGNhbGxzIGFuZ3VsYXIuZm9yRWFjaCBhbmQgaW4gdHVybiB0aGlzIGZ1bmN0aW9uIGNoZWNrcyBmb3IgdGhlIHByZXNlbmNlIG9mIGEgZm9yRWFjaCBtZXRob2QgYmVmb3JlXG4gICAgICogdHJ5aW5nIG9iamVjdCBrZXkgaXRlcmF0aW9uLlxuICAgICAqIEJ5IGF0dGFjaGluZyBhIG5vbiBlbnVtZXJhYmxlIGZvckVhY2ggbWV0aG9kIHRvIHRoZSByb3V0ZXMgb2JqZWN0IHdlIGd1YXJhbnRlZSB0aGF0IHRoZSBmYWxsYmFjayBnZW5lcmljIHJvdXRlc1xuICAgICAqIGFyZSBvbmx5IG1hdGNoZWQgYWZ0ZXIgYW55IG90aGVyIHJlZ2lzdGVyZWQgdGhyb3VnaCAkcm91dGVQcm92aWRlci53aGVuLlxuICAgICAqL1xuICAgIGNvbnN0ICRyb3V0ZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KCckcm91dGUnKTtcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoJHJvdXRlLnJvdXRlcywgJ2ZvckVhY2gnLCB7XG4gICAgICAvLyBtYWtlIG5vbiBlbnVtZXJhYmxlXG4gICAgICB2YWx1ZTogZnVuY3Rpb24gZm9yRWFjaChpdGVyYXRvciwgY29udGV4dCkge1xuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGZvcmluXG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMpIHtcbiAgICAgICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHRoaXNba2V5XSwga2V5LCB0aGlzKTtcbiAgICAgICAgfVxuICAgICAgICBmYWxsYmFja1JvdXRlcy5mb3JFYWNoKHIgPT4gaXRlcmF0b3IuY2FsbChjb250ZXh0LCByKSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvKipcbiAgICAgKiBTb21lIGZ1bmN0aW9ucyB1c2UgdGhlIGN1cnJlbnQgY29udGV4dC4gQXMgc29tZSBwYXJ0cyBhcmUgdXBncmFkZWQgYW5kIHNvbWUgbm90LCB0aGUgZm9sbG93aW5nIHVwZGF0ZXMgdGhlXG4gICAgICogYW5ndWxhcmpzIGdldENvbnRleHQgZnVuY3Rpb24gdG8gcmVzb2x2ZSBhbHdheXMgdGhlIHJpZ2h0IGNvbnRleHQuXG4gICAgICovXG4gICAgY29uc3QgYzh5VWlVdGlsID0gdGhpcy5pbmplY3Rvci5nZXQoJ2M4eVVpVXRpbCcpO1xuICAgIGNvbnN0IF9nZXRDb250ZXh0ID0gYzh5VWlVdGlsLmdldENvbnRleHQ7XG4gICAgdGhpcy5yb3V0ZXIuZXZlbnRzXG4gICAgICAucGlwZShmaWx0ZXIoZXZlbnQgPT4gZXZlbnQgaW5zdGFuY2VvZiBBY3RpdmF0aW9uRW5kKSlcbiAgICAgIC5zdWJzY3JpYmUoKGV2ZW50OiBBY3RpdmF0aW9uRW5kKSA9PiB7XG4gICAgICAgIGlmIChldmVudC5zbmFwc2hvdC5yb3V0ZUNvbmZpZy5wYXRoID09PSAnKionKSB7XG4gICAgICAgICAgYzh5VWlVdGlsLmdldENvbnRleHQgPSBfZ2V0Q29udGV4dDtcbiAgICAgICAgfSBlbHNlIGlmIChldmVudC5zbmFwc2hvdC5kYXRhICYmIGV2ZW50LnNuYXBzaG90LmRhdGEuY29udGV4dCkge1xuICAgICAgICAgIGM4eVVpVXRpbC5nZXRDb250ZXh0ID0gKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgY29udGV4dDogZXZlbnQuc25hcHNob3QuZGF0YS5jb250ZXh0LnJlcGxhY2UoJy86aWQnLCAnJyksXG4gICAgICAgICAgICAgIGlkOiBldmVudC5zbmFwc2hvdC5kYXRhLmNvbnRleHREYXRhLmlkXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYzh5VWlVdGlsLmdldENvbnRleHQgPSAoKSA9PiAoeyBjb250ZXh0OiBudWxsLCBpZDogbnVsbCB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICBmaXhFMmVJc3N1ZXMoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgbmdab25lIH0gPSB0aGlzO1xuICAgICAgY29uc3QgeyBVdGlscyB9ID0gKHdpbmRvdyBhcyBhbnkpLm9yZy5jb21ldGQ7XG4gICAgICBjb25zdCB0aW1lb3V0Rm4gPSBVdGlscy5zZXRUaW1lb3V0O1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm9ubHktYXJyb3ctZnVuY3Rpb25zXG4gICAgICBVdGlscy5zZXRUaW1lb3V0ID0gZnVuY3Rpb24oLi4uYXJncykge1xuICAgICAgICByZXR1cm4gbmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHRpbWVvdXRGbi5hcHBseShVdGlscywgYXJncykpO1xuICAgICAgfTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAvLyBkbyBub3RoaW5nXG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgYWNlIH0gPSB3aW5kb3cgYXMgYW55O1xuICAgICAgY29uc3QgZWRpdEZuID0gYWNlLmVkaXQ7XG4gICAgICBjb25zdCB7IG5nWm9uZSB9ID0gdGhpcztcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpvbmx5LWFycm93LWZ1bmN0aW9uc1xuICAgICAgYWNlLmVkaXQgPSBmdW5jdGlvbiguLi5hcmdzKSB7XG4gICAgICAgIHJldHVybiBuZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4gZWRpdEZuLmFwcGx5KGFjZSwgYXJncykpO1xuICAgICAgfTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAvLyBkbyBub3RoaW5nXG4gICAgfVxuICB9XG5cbiAgaG9va0xhbmd1YWdlKCkge1xuICAgIGxldCBmaXJzdCA9IHRydWU7XG4gICAgdGhpcy5hcHBTdGF0ZVxuICAgICAgLm1hcChzdG9yZSA9PiBzdG9yZS5sYW5nKVxuICAgICAgLnN1YnNjcmliZShsYW5nID0+IHtcbiAgICAgICAgdGhpcy5pbmplY3Rvci5nZXQoJ2M4eUxvY2FsZXMnKS5zd2l0Y2hUb0xhbmd1YWdlKGxhbmcpO1xuICAgICAgICBpZiAoIWZpcnN0KSB7XG4gICAgICAgICAgdGhpcy5pbmplY3Rvci5nZXQoJyRyb290U2NvcGUnKS4kYXBwbHkoKTtcbiAgICAgICAgfVxuICAgICAgICBmaXJzdCA9IGZhbHNlO1xuICAgICAgfSk7XG4gIH1cblxuICBob29rVGFicygpIHtcbiAgICAvLyBKdXN0IGZvciBpbnN0YW50aWF0aW9uIG9mIHRoZSBjOHlBY3Rpb24gc2VydmljZVxuICAgIHRoaXMuaW5qZWN0b3IuZ2V0KCdjOHlBY3Rpb25zJyk7XG4gICAgY29uc3QgJGxvY2F0aW9uID0gdGhpcy5pbmplY3Rvci5nZXQoJyRsb2NhdGlvbicpO1xuICAgIGNvbnN0IGM4eVRhYnMgPSB0aGlzLmluamVjdG9yLmdldCgnYzh5VGFicycpO1xuICAgIGxldCBsaXZlVGFicyA9IFtdO1xuICAgIGM4eVRhYnMuYWRkVGFiID0gdGFiID0+IHtcbiAgICAgIGxpdmVUYWJzLnB1c2goe1xuICAgICAgICAuLi50YWIsXG4gICAgICAgIGxhYmVsOiB0YWIubGFiZWwgfHwgdGFiLm5hbWUsXG4gICAgICAgIHBhdGg6IGRlY29kZVVSSUNvbXBvbmVudCh0YWIucGF0aClcbiAgICAgIH0pO1xuICAgICAgdGhpcy4kbGl2ZVRhYnMubmV4dChsaXZlVGFicyk7XG4gICAgfTtcbiAgICB0aGlzLiRuZzFSb3V0ZUNoYW5nZVN0YXJ0LnN1YnNjcmliZShlID0+IHtcbiAgICAgIGxpdmVUYWJzID0gW107XG4gICAgICB0aGlzLiRsaXZlVGFicy5uZXh0KGxpdmVUYWJzKTtcbiAgICB9KTtcbiAgICB0aGlzLiRuZzFSb3V0ZUNoYW5nZVN1Y2Nlc3Muc3Vic2NyaWJlKGUgPT4ge1xuICAgICAgY29uc3QgcGF0aCA9ICRsb2NhdGlvbi5wYXRoKCk7XG4gICAgICBpZiAodGhpcy5yb3V0ZXIudXJsICE9PSBwYXRoKSB7XG4gICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKHBhdGggPT09ICcvJyA/ICcnIDogcGF0aC5zcGxpdCgnLycpLCB7XG4gICAgICAgICAgcXVlcnlQYXJhbXM6ICRsb2NhdGlvbi5zZWFyY2goKSxcbiAgICAgICAgICBza2lwTG9jYXRpb25DaGFuZ2U6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5hY3Rpb25TZXJ2aWNlKSB7XG4gICAgICAgIHRoaXMuYWN0aW9uU2VydmljZS5yZWZyZXNoKCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy4kcm91dGVDaGFuZ2VzID0gdGhpcy4kbmcxUm91dGVDaGFuZ2VTdWNjZXNzLnBpcGUoXG4gICAgICBtZXJnZSh0aGlzLmZyb21OZzFFdmVudChjOHlUYWJzLCBjOHlUYWJzLkVWRU5UX1VQREFURSksIG9mKDEpKSxcbiAgICAgIGRlYm91bmNlVGltZSgxMDApXG4gICAgKTtcbiAgfVxuXG4gIGhvb2tOYXZpZ2F0b3IoKSB7XG4gICAgdGhpcy5uYXZpZ2F0aW9uTm9kZXMkID0gdGhpcy5pbmplY3Rvci5nZXQoJ2M4eU5hdmlnYXRvcicpLnJvb3ROb2RlcyQ7XG4gIH1cblxuICBnZXRUYWJzKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3Qgb25seVZpc2libGUgPSAoeyBzaG93IH0pID0+IHNob3c7XG4gICAgY29uc3QgdXBncmFkZVRhYiA9IHRhYiA9PiAoe1xuICAgICAgLi4udGFiLFxuICAgICAgbGFiZWw6IHRhYi5sYWJlbCB8fCB0YWIubmFtZSxcbiAgICAgIHBhdGg6IGRlY29kZVVSSUNvbXBvbmVudCh0YWIucGF0aClcbiAgICB9KTtcbiAgICBjb25zdCByb3V0ZVRhYnMgPSB0aGlzLiRyb3V0ZUNoYW5nZXMucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XG4gICAgICAgIGNvbnN0IHJvdXRlcyA9IHRoaXMuaW5qZWN0b3IuZ2V0KCdjOHlUYWJzJykucm91dGVUYWJzO1xuICAgICAgICBjb25zdCB2aXNpYmlsaXR5UHJvbWlzZSA9IFByb21pc2UuYWxsKFxuICAgICAgICAgIHJvdXRlcy5tYXAoKHsgY2hlY2tpbmdWaXNpYmlsaXR5IH0pID0+IGNoZWNraW5nVmlzaWJpbGl0eSlcbiAgICAgICAgKTtcbiAgICAgICAgcmV0dXJuIHZpc2liaWxpdHlQcm9taXNlLnRoZW4oKCkgPT4gcm91dGVzLmZpbHRlcihvbmx5VmlzaWJsZSkubWFwKHVwZ3JhZGVUYWIpKTtcbiAgICAgIH0pLFxuICAgICAgc3RhcnRXaXRoKFtdKVxuICAgICk7XG4gICAgcmV0dXJuIGNvbWJpbmVMYXRlc3Qocm91dGVUYWJzLCB0aGlzLiRsaXZlVGFicykucGlwZShcbiAgICAgIG1hcCgoW3JvdXRlLCBsaXZlXSkgPT4gcm91dGUuY29uY2F0KGxpdmUpKVxuICAgICk7XG4gIH1cblxuICBnZXRRdWlja0xpbmtzKCk6IFByb21pc2U8RG9jTGlua1tdPiB7XG4gICAgY29uc3QgYzh5UXVpY2tMaW5rcyA9IHRoaXMuaW5qZWN0b3IuZ2V0KCdjOHlRdWlja0xpbmtzJyk7XG4gICAgcmV0dXJuIGM4eVF1aWNrTGlua3MubGlzdCgpO1xuICB9XG5cbiAgZ2V0QWN0aW9uQmFySXRlbXMoKTogT2JzZXJ2YWJsZTxBY3Rpb25CYXJJdGVtPiB7XG4gICAgY29uc3QgYzh5QWN0aW9uQmFyID0gdGhpcy5pbmplY3Rvci5nZXQoJ2M4eUFjdGlvbkJhcicpO1xuICAgIGNvbnN0ICRyb290U2NvcGUgPSB0aGlzLmluamVjdG9yLmdldCgnJHJvb3RTY29wZScpO1xuICAgIGNvbnN0IGdldEFjdGlvbkJhckVsZW1lbnRzID0gKCkgPT5cbiAgICAgIGM4eUFjdGlvbkJhci5lbGVtZW50cy5tYXAoZWxlbWVudCA9PiAoe1xuICAgICAgICBwcmlvcml0eTogZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2FjdGlvbi1iYXItcHJpb3JpdHknKSB8fCAwLFxuICAgICAgICB0ZW1wbGF0ZTogZWxlbWVudCxcbiAgICAgICAgcGxhY2VtZW50OiBlbGVtZW50LmdldEF0dHJpYnV0ZSgnYWN0aW9uLWJhci1wb3NpdGlvbicpIHx8ICdyaWdodCdcbiAgICAgIH0pKTtcbiAgICByZXR1cm4gdGhpcy5mcm9tTmcxRXZlbnQoJHJvb3RTY29wZSwgJ2M4eUFjdGlvbkJhckNoYW5nZWQnKS5waXBlKFxuICAgICAgc3RhcnRXaXRoKDEpLFxuICAgICAgbWFwKGdldEFjdGlvbkJhckVsZW1lbnRzKVxuICAgICk7XG4gIH1cblxuICBnZXRCcmVhZGNydW1icygpOiBPYnNlcnZhYmxlPEJyZWFkY3J1bWJbXT4ge1xuICAgIGNvbnN0ICRsb2NhdGlvbiA9IHRoaXMuaW5qZWN0b3IuZ2V0KCckbG9jYXRpb24nKTtcbiAgICBjb25zdCBwYXRoID0gJGxvY2F0aW9uLnBhdGgoKTtcbiAgICBjb25zdCBjOHlCcmVhZGNydW1icyA9IHRoaXMuaW5qZWN0b3IuZ2V0KCdjOHlCcmVhZGNydW1icycpO1xuICAgIGNvbnN0IGJyZWFkY3J1bWJzID0gYzh5QnJlYWRjcnVtYnMuZ2V0KHBhdGgpIHx8IHt9O1xuICAgIGNvbnN0IGJyZWFkY3J1bWJzRGF0YSA9IHRoaXMucmVzb2x2ZUJyZWFkY3J1bWJzRGF0YShicmVhZGNydW1icy5kYXRhKTtcbiAgICByZXR1cm4gZnJvbShicmVhZGNydW1ic0RhdGEpLnBpcGUoXG4gICAgICBtYXAoKHZhbHVlOiBhbnlbXSkgPT4ge1xuICAgICAgICBjb25zdCBsaXZlQnJlYWRjcnVtYnMgPSBjOHlCcmVhZGNydW1icy5nZXRMaXZlQnJlYWRjcnVtYnMoKTtcbiAgICAgICAgdmFsdWUgPSB2YWx1ZS5jb25jYXQobGl2ZUJyZWFkY3J1bWJzKTtcbiAgICAgICAgcmV0dXJuIHZhbHVlLm1hcChcbiAgICAgICAgICBpdGVtcyA9PiAoeyBpdGVtczogaXRlbXMgYXMgQnJlYWRjcnVtYkl0ZW1bXSB9IGFzIEJyZWFkY3J1bWIpXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICByZXNvbHZlQnJlYWRjcnVtYnNEYXRhKGRhdGEpOiBPYnNlcnZhYmxlPGFueVtdPiB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiB0aGlzLmluamVjdG9yLmludm9rZShkYXRhKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgLy8gZW1wdHlcbiAgICB9XG4gICAgaWYgKGlzQXJyYXkoZGF0YSkpIHtcbiAgICAgIHJldHVybiBvZihbZGF0YV0pO1xuICAgIH1cbiAgICByZXR1cm4gb2YoW10pO1xuICB9XG5cbiAgZ2V0U2VhcmNoKCk6IFNlYXJjaFtdIHtcbiAgICBjb25zdCBjOHlTZWFyY2ggPSB0aGlzLmluamVjdG9yLmdldCgnYzh5U2VhcmNoJyk7XG4gICAgcmV0dXJuIGM4eVNlYXJjaC5saXN0KCkubWFwKGl0ZW0gPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaWNvbjogJ3NlYXJjaCcsXG4gICAgICAgIG5hbWU6IGl0ZW0ubmFtZSxcbiAgICAgICAgdGVybTogJycsXG4gICAgICAgIG9uU2VhcmNoKCkge1xuICAgICAgICAgIGlmICh0aGlzLnRlcm0pIHtcbiAgICAgICAgICAgIGM4eVNlYXJjaC5zZWFyY2godGhpcy50ZXJtKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gYXMgU2VhcmNoO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0QWN0aW9ucygpOiBPYnNlcnZhYmxlPEFjdGlvbj4ge1xuICAgIGNvbnN0IHJlZ2lzdGVyZWRBY3Rpb25zID0gdGhpcy5pbmplY3Rvci5nZXQoJ2M4eUFjdGlvbnMnKS5yZWdpc3RlcmVkQWN0aW9ucztcbiAgICByZXR1cm4gb2YoXG4gICAgICByZWdpc3RlcmVkQWN0aW9uc1xuICAgICAgICAuZmlsdGVyKGFjdGlvbiA9PiAhYWN0aW9uLmhpZGRlbilcbiAgICAgICAgLm1hcChhY3Rpb24gPT4gKHtcbiAgICAgICAgICAvLyBUaGUgcHJpb3JpdHkgd2FzIHJldmVyc2VkOiBBbGlnbmVkIGl0IHRvIGRhc2hib2FyZCwgaGlnaCBmaXJzdCwgbG93IGxhc3QuXG4gICAgICAgICAgcHJpb3JpdHk6IChhY3Rpb24ucHJpb3JpdHkgfHwgMCkgKiAtMSxcbiAgICAgICAgICBsYWJlbDogYWN0aW9uLnRleHQsXG4gICAgICAgICAgaWNvbjogYWN0aW9uLmljb24sXG4gICAgICAgICAgZGlzYWJsZWQ6IGFjdGlvbi5kaXNhYmxlZCxcbiAgICAgICAgICBhY3Rpb246ICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuaW5qZWN0b3IuaW52b2tlKGFjdGlvbi5hY3Rpb24sIGFjdGlvbik7XG4gICAgICAgICAgfVxuICAgICAgICB9KSlcbiAgICApO1xuICB9XG5cbiAgZnJvbU5nMUV2ZW50KG9iaiwgZXZ0KSB7XG4gICAgbGV0IHN0b3BMaXN0ZW5pbmc7XG4gICAgZnVuY3Rpb24gYWRkKGhhbmRsZXIpIHtcbiAgICAgIHN0b3BMaXN0ZW5pbmcgPSBvYmouJG9uKGV2dCwgaGFuZGxlcik7XG4gICAgfVxuICAgIHJldHVybiBmcm9tRXZlbnRQYXR0ZXJuKGFkZCwgKCkgPT4gc3RvcExpc3RlbmluZygpKTtcbiAgfVxuXG4gIHByaXZhdGUgaG9va1VzZXJNZW51KCkge1xuICAgIGNvbnN0IHVzZXJNZW51U2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KCdjOHlVc2VyTWVudVNlcnZpY2UnKTtcbiAgICBjb25zdCBjOHlBY2Nlc3NEZW5pZWQgPSB0aGlzLmluamVjdG9yLmdldCgnYzh5QWNjZXNzRGVuaWVkJyk7XG4gICAgdXNlck1lbnVTZXJ2aWNlLmFkZCh7XG4gICAgICBpY29uOiAnZXhjbGFtYXRpb24tdHJpYW5nbGUnLFxuICAgICAgcHJpb3JpdHk6IDEwLFxuICAgICAgbGFiZWw6IGdldHRleHQoJ0FjY2VzcyBkZW5pZWQgcmVxdWVzdHMnKSxcbiAgICAgIGNsaWNrOiBjOHlBY2Nlc3NEZW5pZWQuc2hvd0FjY2Vzc0RlbmllZFJlcXVlc3RzTGlzdFxuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBicmlkZ2VTZXJ2aWNlRmFjdG9yeShcbiAgaW5qZWN0b3I6IGFueSxcbiAgYXBwU3RhdGU6IEFwcFN0YXRlU2VydmljZSxcbiAgcm91dGVyOiBSb3V0ZXIsXG4gIG5nWm9uZTogTmdab25lLFxuICByb3V0ZXJTZXJ2aWNlOiBSb3V0ZXJTZXJ2aWNlLFxuICBhY3Rpb25TZXJ2aWNlOiBBY3Rpb25TZXJ2aWNlXG4pIHtcbiAgcmV0dXJuIG5ldyBCcmlkZ2VTZXJ2aWNlKGluamVjdG9yLCBhcHBTdGF0ZSwgcm91dGVyLCBuZ1pvbmUsIHJvdXRlclNlcnZpY2UsIGFjdGlvblNlcnZpY2UpO1xufVxuXG5leHBvcnQgY29uc3QgYnJpZGdlU2VydmljZVByb3ZpZGVyID0ge1xuICBwcm92aWRlOiBCcmlkZ2VTZXJ2aWNlLFxuICB1c2VGYWN0b3J5OiBicmlkZ2VTZXJ2aWNlRmFjdG9yeSxcbiAgZGVwczogWyckaW5qZWN0b3InLCBBcHBTdGF0ZVNlcnZpY2UsIFJvdXRlciwgTmdab25lLCBSb3V0ZXJTZXJ2aWNlLCBBY3Rpb25TZXJ2aWNlXVxufTtcbiJdfQ==