import * as tslib_1 from "tslib";
import { startsWith, unary, map, find, forEach } from 'lodash-es';
import { ViewContext } from '@c8y/ngx-components';
import { ReplaySubject } from 'rxjs';
export var ViewContextLegacyParameter;
(function (ViewContextLegacyParameter) {
    ViewContextLegacyParameter["Device"] = "deviceId";
    ViewContextLegacyParameter["Group"] = "groupId";
    ViewContextLegacyParameter["User"] = "userId";
    ViewContextLegacyParameter["Application"] = "applicationId";
    ViewContextLegacyParameter["SubscribedApplications"] = "applicationId";
    ViewContextLegacyParameter["Tenant"] = "tenantId";
})(ViewContextLegacyParameter || (ViewContextLegacyParameter = {}));
function c8yViewsProvider($routeProvider, c8yTabsProvider, c8yPathUtils) {
    'ngInject';
    var viewMap = {};
    var contextViews = new ReplaySubject();
    return {
        when: when,
        $get: function () {
            return {
                contextViews: contextViews,
                when: function (path, cfg) {
                    return when(path, cfg, true);
                },
                getByPath: getByPath,
                prefixWithSlash: prefixWithSlash
            };
        }
    };
    /**
     * @ngdoc function
     * @name when
     * @methodOf c8y.ui.provider:c8yViewsProvider
     *
     * @description
     * Defines a view for given route.
     * If multiple views are defined for a single route then there will be a separate tab for each view available when user visits that route.
     *
     * @param path Target route.
     * @param cfg View configuration object with the following properties:
     *
     * - **name** - `string` - View's name (in case of multiple views at single route this will be displayed as tab's title).
     * - **priority** - `integer` - View's priority (in case of multiple views at single route this will determine the position of view's tab in the tabs stack).
     * - **icon** - `string` - Font Awesome icon name for the view (displayed on the tab's header).
     * - **showIf** - `function` - Function returning boolean value indicating whether to show a tab for the view or not.
     * - **templateUrl** - `string` - Path to the template to use for displaying the view.
     *
     * You can also provide other view options - the same as available for standard {@link https://docs.angularjs.org/api/ngRoute/provider/$routeProvider $routeProvider} in AngularJS.
     *
     * @example
     * The following example demonstrates how to add a new view to device details route
     * (which will be displayed as a tab if other views are assigned to the same route):
     * <pre>
     *   c8yViewsProvider.when('/device/:deviceId', {
     *     name: 'Tracking',
     *     templateUrl: ':::PLUGIN_PATH:::/views/index.html',
     *     icon: 'crosshairs',
     *     showIf: ['$routeParams', 'c8yDevices', function ($routeParams, c8yDevices) {
     *       var deviceId = $routeParams.deviceId;
     *       return c8yDevices.detailCached(deviceId).then(function (res) {
     *         var device = res.data;
     *         return device && (device.c8y_MotionTracking || device.c8y_Geofence);
     *       });
     *     }]
     *   });
     * </pre>
     */
    function when(path, cfg, runPhase) {
        var newPath = prefixWithSlash(path);
        cfg.resolve = cfg.resolve || {};
        // eslint-disable-next-line no-underscore-dangle
        cfg.resolve.__c8y_locales = [
            'c8yLocales',
            function (c8yLocales) {
                return c8yLocales.initDone;
            }
        ];
        var currentCfg = viewMap[newPath];
        var originalPath = newPath;
        if (!cfg.name) {
            // console.warn('View name not defined');
        }
        if (!currentCfg) {
            viewMap[newPath] = [];
            currentCfg = viewMap[newPath];
        }
        var upgradedContext = Object.keys(ViewContext)
            .map(function (key) { return ({
            key: key,
            isUpgrade: prefixWithSlash(ViewContext[key].replace('id', ViewContextLegacyParameter[key])) === path
        }); })
            .find(function (_a) {
            var isUpgrade = _a.isUpgrade;
            return isUpgrade;
        });
        if (upgradedContext) {
            currentCfg.push(cfg);
            cfg.path = newPath;
            var p = c8yPathUtils.appendSegment(originalPath.replace(path, ''), cfg.name);
            contextViews.next(tslib_1.__assign({}, cfg, { path: cfg.name ? p.substring(1) : '', contextKey: upgradedContext.key, runPhase: runPhase }));
            cfg.showIf = undefined;
            if (cfg.name) {
                cfg.path = c8yPathUtils.appendSegment(originalPath, cfg.name);
            }
        }
        else {
            if (currentCfg.length === 1) {
                var _a = tslib_1.__read(currentCfg, 1), existingConfig = _a[0];
                existingConfig.path = c8yPathUtils.appendSegment(originalPath, existingConfig.name);
                existingConfig.tab = createTab(originalPath, existingConfig);
                $routeProvider.when(existingConfig.path, existingConfig);
            }
            currentCfg.push(cfg);
            cfg.path = newPath;
            if (currentCfg.length > 1) {
                cfg.path = c8yPathUtils.appendSegment(originalPath, cfg.name);
                createTab(originalPath, cfg);
                $routeProvider.when(prefixWithSlash(originalPath), {
                    resolveRedirectTo: function ($route, $q, c8yUiUtil, c8yTabs, gettextCatalog) {
                        'ngInject';
                        var sortedCurrentCfg = c8yTabsProvider.sortTabsViews(currentCfg, gettextCatalog);
                        var params = $route.current.pathParams;
                        return $q
                            .all(map(sortedCurrentCfg, unary(c8yUiUtil.configureVisibility)))
                            .then(function (views) {
                            var first = find(views, 'show');
                            var url = first.path;
                            forEach(params, function (val, key) {
                                url = url.replace(":" + key, val);
                            });
                            c8yTabs.redirectedViewPath = url;
                            return url;
                        });
                    }
                });
            }
        }
        return $routeProvider.when(prefixWithSlash(cfg.path), cfg);
    }
    function getByPath(path) {
        return viewMap[prefixWithSlash(path)];
    }
    function createTab(path, cfg) {
        c8yTabsProvider.addTab(path, cfg);
    }
    function prefixWithSlash(path) {
        var prefix = startsWith(path, '/') ? '' : '/';
        return prefix + path;
    }
}
export { c8yViewsProvider };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld3MucHJvdmlkZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL3VwZ3JhZGUvIiwic291cmNlcyI6WyJuZzEvdmlld3MucHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2xFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRXJDLE1BQU0sQ0FBTixJQUFZLDBCQU9YO0FBUEQsV0FBWSwwQkFBMEI7SUFDcEMsaURBQW1CLENBQUE7SUFDbkIsK0NBQWlCLENBQUE7SUFDakIsNkNBQWUsQ0FBQTtJQUNmLDJEQUE2QixDQUFBO0lBQzdCLHNFQUF3QyxDQUFBO0lBQ3hDLGlEQUFtQixDQUFBO0FBQ3JCLENBQUMsRUFQVywwQkFBMEIsS0FBMUIsMEJBQTBCLFFBT3JDO0FBRUQsU0FBUyxnQkFBZ0IsQ0FBQyxjQUFjLEVBQUUsZUFBZSxFQUFFLFlBQVk7SUFDckUsVUFBVSxDQUFDO0lBRVgsSUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDO0lBQ25CLElBQU0sWUFBWSxHQUFHLElBQUksYUFBYSxFQUFFLENBQUM7SUFFekMsT0FBTztRQUNMLElBQUksTUFBQTtRQUNKLElBQUk7WUFDRixPQUFPO2dCQUNMLFlBQVksY0FBQTtnQkFDWixJQUFJLFlBQUMsSUFBSSxFQUFFLEdBQUc7b0JBQ1osT0FBTyxJQUFJLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDL0IsQ0FBQztnQkFDRCxTQUFTLFdBQUE7Z0JBQ1QsZUFBZSxpQkFBQTthQUNoQixDQUFDO1FBQ0osQ0FBQztLQUNGLENBQUM7SUFFRjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztPQXFDRztJQUNILFNBQVMsSUFBSSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsUUFBUTtRQUMvQixJQUFNLE9BQU8sR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEMsR0FBRyxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQztRQUNoQyxnREFBZ0Q7UUFDaEQsR0FBRyxDQUFDLE9BQU8sQ0FBQyxhQUFhLEdBQUc7WUFDMUIsWUFBWTtZQUNaLFVBQUEsVUFBVTtnQkFDUixPQUFPLFVBQVUsQ0FBQyxRQUFRLENBQUM7WUFDN0IsQ0FBQztTQUNGLENBQUM7UUFFRixJQUFJLFVBQVUsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbEMsSUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDO1FBRTdCLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFO1lBQ2IseUNBQXlDO1NBQzFDO1FBRUQsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNmLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDdEIsVUFBVSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUMvQjtRQUVELElBQU0sZUFBZSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDO2FBQzdDLEdBQUcsQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLENBQUM7WUFDWCxHQUFHLEtBQUE7WUFDSCxTQUFTLEVBQ1AsZUFBZSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLDBCQUEwQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJO1NBQzVGLENBQUMsRUFKVSxDQUlWLENBQUM7YUFDRixJQUFJLENBQUMsVUFBQyxFQUFhO2dCQUFYLHdCQUFTO1lBQU8sT0FBQSxTQUFTO1FBQVQsQ0FBUyxDQUFDLENBQUM7UUFFdEMsSUFBSSxlQUFlLEVBQUU7WUFDbkIsVUFBVSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNyQixHQUFHLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQztZQUVuQixJQUFNLENBQUMsR0FBRyxZQUFZLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMvRSxZQUFZLENBQUMsSUFBSSxzQkFDWixHQUFHLElBQ04sSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFDcEMsVUFBVSxFQUFFLGVBQWUsQ0FBQyxHQUFHLEVBQy9CLFFBQVEsVUFBQSxJQUNSLENBQUM7WUFDSCxHQUFHLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQztZQUN2QixJQUFJLEdBQUcsQ0FBQyxJQUFJLEVBQUU7Z0JBQ1osR0FBRyxDQUFDLElBQUksR0FBRyxZQUFZLENBQUMsYUFBYSxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDL0Q7U0FDRjthQUFNO1lBQ0wsSUFBSSxVQUFVLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtnQkFDckIsSUFBQSxrQ0FBNkIsRUFBNUIsc0JBQTRCLENBQUM7Z0JBQ3BDLGNBQWMsQ0FBQyxJQUFJLEdBQUcsWUFBWSxDQUFDLGFBQWEsQ0FBQyxZQUFZLEVBQUUsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNwRixjQUFjLENBQUMsR0FBRyxHQUFHLFNBQVMsQ0FBQyxZQUFZLEVBQUUsY0FBYyxDQUFDLENBQUM7Z0JBQzdELGNBQWMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxjQUFjLENBQUMsQ0FBQzthQUMxRDtZQUVELFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDckIsR0FBRyxDQUFDLElBQUksR0FBRyxPQUFPLENBQUM7WUFFbkIsSUFBSSxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDekIsR0FBRyxDQUFDLElBQUksR0FBRyxZQUFZLENBQUMsYUFBYSxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzlELFNBQVMsQ0FBQyxZQUFZLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBRTdCLGNBQWMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLFlBQVksQ0FBQyxFQUFFO29CQUNqRCxpQkFBaUIsWUFBQyxNQUFNLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsY0FBYzt3QkFDOUQsVUFBVSxDQUFDO3dCQUVYLElBQU0sZ0JBQWdCLEdBQUcsZUFBZSxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUUsY0FBYyxDQUFDLENBQUM7d0JBQ25GLElBQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDO3dCQUV6QyxPQUFPLEVBQUU7NkJBQ04sR0FBRyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxLQUFLLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQzs2QkFDaEUsSUFBSSxDQUFDLFVBQUEsS0FBSzs0QkFDVCxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDOzRCQUNsQyxJQUFJLEdBQUcsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDOzRCQUNyQixPQUFPLENBQUMsTUFBTSxFQUFFLFVBQUMsR0FBRyxFQUFFLEdBQUc7Z0NBQ3ZCLEdBQUcsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQUksR0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDOzRCQUNwQyxDQUFDLENBQUMsQ0FBQzs0QkFDSCxPQUFPLENBQUMsa0JBQWtCLEdBQUcsR0FBRyxDQUFDOzRCQUNqQyxPQUFPLEdBQUcsQ0FBQzt3QkFDYixDQUFDLENBQUMsQ0FBQztvQkFDUCxDQUFDO2lCQUNGLENBQUMsQ0FBQzthQUNKO1NBQ0Y7UUFDRCxPQUFPLGNBQWMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBRUQsU0FBUyxTQUFTLENBQUMsSUFBSTtRQUNyQixPQUFPLE9BQU8sQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRUQsU0FBUyxTQUFTLENBQUMsSUFBSSxFQUFFLEdBQUc7UUFDMUIsZUFBZSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELFNBQVMsZUFBZSxDQUFDLElBQUk7UUFDM0IsSUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7UUFDaEQsT0FBTyxNQUFNLEdBQUcsSUFBSSxDQUFDO0lBQ3ZCLENBQUM7QUFDSCxDQUFDO0FBRUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBzdGFydHNXaXRoLCB1bmFyeSwgbWFwLCBmaW5kLCBmb3JFYWNoIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IFZpZXdDb250ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmV4cG9ydCBlbnVtIFZpZXdDb250ZXh0TGVnYWN5UGFyYW1ldGVyIHtcbiAgRGV2aWNlID0gJ2RldmljZUlkJyxcbiAgR3JvdXAgPSAnZ3JvdXBJZCcsXG4gIFVzZXIgPSAndXNlcklkJyxcbiAgQXBwbGljYXRpb24gPSAnYXBwbGljYXRpb25JZCcsXG4gIFN1YnNjcmliZWRBcHBsaWNhdGlvbnMgPSAnYXBwbGljYXRpb25JZCcsXG4gIFRlbmFudCA9ICd0ZW5hbnRJZCdcbn1cblxuZnVuY3Rpb24gYzh5Vmlld3NQcm92aWRlcigkcm91dGVQcm92aWRlciwgYzh5VGFic1Byb3ZpZGVyLCBjOHlQYXRoVXRpbHMpIHtcbiAgJ25nSW5qZWN0JztcblxuICBjb25zdCB2aWV3TWFwID0ge307XG4gIGNvbnN0IGNvbnRleHRWaWV3cyA9IG5ldyBSZXBsYXlTdWJqZWN0KCk7XG5cbiAgcmV0dXJuIHtcbiAgICB3aGVuLFxuICAgICRnZXQoKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBjb250ZXh0Vmlld3MsXG4gICAgICAgIHdoZW4ocGF0aCwgY2ZnKSB7XG4gICAgICAgICAgcmV0dXJuIHdoZW4ocGF0aCwgY2ZnLCB0cnVlKTtcbiAgICAgICAgfSxcbiAgICAgICAgZ2V0QnlQYXRoLFxuICAgICAgICBwcmVmaXhXaXRoU2xhc2hcbiAgICAgIH07XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBAbmdkb2MgZnVuY3Rpb25cbiAgICogQG5hbWUgd2hlblxuICAgKiBAbWV0aG9kT2YgYzh5LnVpLnByb3ZpZGVyOmM4eVZpZXdzUHJvdmlkZXJcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqIERlZmluZXMgYSB2aWV3IGZvciBnaXZlbiByb3V0ZS5cbiAgICogSWYgbXVsdGlwbGUgdmlld3MgYXJlIGRlZmluZWQgZm9yIGEgc2luZ2xlIHJvdXRlIHRoZW4gdGhlcmUgd2lsbCBiZSBhIHNlcGFyYXRlIHRhYiBmb3IgZWFjaCB2aWV3IGF2YWlsYWJsZSB3aGVuIHVzZXIgdmlzaXRzIHRoYXQgcm91dGUuXG4gICAqXG4gICAqIEBwYXJhbSBwYXRoIFRhcmdldCByb3V0ZS5cbiAgICogQHBhcmFtIGNmZyBWaWV3IGNvbmZpZ3VyYXRpb24gb2JqZWN0IHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOlxuICAgKlxuICAgKiAtICoqbmFtZSoqIC0gYHN0cmluZ2AgLSBWaWV3J3MgbmFtZSAoaW4gY2FzZSBvZiBtdWx0aXBsZSB2aWV3cyBhdCBzaW5nbGUgcm91dGUgdGhpcyB3aWxsIGJlIGRpc3BsYXllZCBhcyB0YWIncyB0aXRsZSkuXG4gICAqIC0gKipwcmlvcml0eSoqIC0gYGludGVnZXJgIC0gVmlldydzIHByaW9yaXR5IChpbiBjYXNlIG9mIG11bHRpcGxlIHZpZXdzIGF0IHNpbmdsZSByb3V0ZSB0aGlzIHdpbGwgZGV0ZXJtaW5lIHRoZSBwb3NpdGlvbiBvZiB2aWV3J3MgdGFiIGluIHRoZSB0YWJzIHN0YWNrKS5cbiAgICogLSAqKmljb24qKiAtIGBzdHJpbmdgIC0gRm9udCBBd2Vzb21lIGljb24gbmFtZSBmb3IgdGhlIHZpZXcgKGRpc3BsYXllZCBvbiB0aGUgdGFiJ3MgaGVhZGVyKS5cbiAgICogLSAqKnNob3dJZioqIC0gYGZ1bmN0aW9uYCAtIEZ1bmN0aW9uIHJldHVybmluZyBib29sZWFuIHZhbHVlIGluZGljYXRpbmcgd2hldGhlciB0byBzaG93IGEgdGFiIGZvciB0aGUgdmlldyBvciBub3QuXG4gICAqIC0gKip0ZW1wbGF0ZVVybCoqIC0gYHN0cmluZ2AgLSBQYXRoIHRvIHRoZSB0ZW1wbGF0ZSB0byB1c2UgZm9yIGRpc3BsYXlpbmcgdGhlIHZpZXcuXG4gICAqXG4gICAqIFlvdSBjYW4gYWxzbyBwcm92aWRlIG90aGVyIHZpZXcgb3B0aW9ucyAtIHRoZSBzYW1lIGFzIGF2YWlsYWJsZSBmb3Igc3RhbmRhcmQge0BsaW5rIGh0dHBzOi8vZG9jcy5hbmd1bGFyanMub3JnL2FwaS9uZ1JvdXRlL3Byb3ZpZGVyLyRyb3V0ZVByb3ZpZGVyICRyb3V0ZVByb3ZpZGVyfSBpbiBBbmd1bGFySlMuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIFRoZSBmb2xsb3dpbmcgZXhhbXBsZSBkZW1vbnN0cmF0ZXMgaG93IHRvIGFkZCBhIG5ldyB2aWV3IHRvIGRldmljZSBkZXRhaWxzIHJvdXRlXG4gICAqICh3aGljaCB3aWxsIGJlIGRpc3BsYXllZCBhcyBhIHRhYiBpZiBvdGhlciB2aWV3cyBhcmUgYXNzaWduZWQgdG8gdGhlIHNhbWUgcm91dGUpOlxuICAgKiA8cHJlPlxuICAgKiAgIGM4eVZpZXdzUHJvdmlkZXIud2hlbignL2RldmljZS86ZGV2aWNlSWQnLCB7XG4gICAqICAgICBuYW1lOiAnVHJhY2tpbmcnLFxuICAgKiAgICAgdGVtcGxhdGVVcmw6ICc6OjpQTFVHSU5fUEFUSDo6Oi92aWV3cy9pbmRleC5odG1sJyxcbiAgICogICAgIGljb246ICdjcm9zc2hhaXJzJyxcbiAgICogICAgIHNob3dJZjogWyckcm91dGVQYXJhbXMnLCAnYzh5RGV2aWNlcycsIGZ1bmN0aW9uICgkcm91dGVQYXJhbXMsIGM4eURldmljZXMpIHtcbiAgICogICAgICAgdmFyIGRldmljZUlkID0gJHJvdXRlUGFyYW1zLmRldmljZUlkO1xuICAgKiAgICAgICByZXR1cm4gYzh5RGV2aWNlcy5kZXRhaWxDYWNoZWQoZGV2aWNlSWQpLnRoZW4oZnVuY3Rpb24gKHJlcykge1xuICAgKiAgICAgICAgIHZhciBkZXZpY2UgPSByZXMuZGF0YTtcbiAgICogICAgICAgICByZXR1cm4gZGV2aWNlICYmIChkZXZpY2UuYzh5X01vdGlvblRyYWNraW5nIHx8IGRldmljZS5jOHlfR2VvZmVuY2UpO1xuICAgKiAgICAgICB9KTtcbiAgICogICAgIH1dXG4gICAqICAgfSk7XG4gICAqIDwvcHJlPlxuICAgKi9cbiAgZnVuY3Rpb24gd2hlbihwYXRoLCBjZmcsIHJ1blBoYXNlKSB7XG4gICAgY29uc3QgbmV3UGF0aCA9IHByZWZpeFdpdGhTbGFzaChwYXRoKTtcbiAgICBjZmcucmVzb2x2ZSA9IGNmZy5yZXNvbHZlIHx8IHt9O1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bmRlcnNjb3JlLWRhbmdsZVxuICAgIGNmZy5yZXNvbHZlLl9fYzh5X2xvY2FsZXMgPSBbXG4gICAgICAnYzh5TG9jYWxlcycsXG4gICAgICBjOHlMb2NhbGVzID0+IHtcbiAgICAgICAgcmV0dXJuIGM4eUxvY2FsZXMuaW5pdERvbmU7XG4gICAgICB9XG4gICAgXTtcblxuICAgIGxldCBjdXJyZW50Q2ZnID0gdmlld01hcFtuZXdQYXRoXTtcbiAgICBjb25zdCBvcmlnaW5hbFBhdGggPSBuZXdQYXRoO1xuXG4gICAgaWYgKCFjZmcubmFtZSkge1xuICAgICAgLy8gY29uc29sZS53YXJuKCdWaWV3IG5hbWUgbm90IGRlZmluZWQnKTtcbiAgICB9XG5cbiAgICBpZiAoIWN1cnJlbnRDZmcpIHtcbiAgICAgIHZpZXdNYXBbbmV3UGF0aF0gPSBbXTtcbiAgICAgIGN1cnJlbnRDZmcgPSB2aWV3TWFwW25ld1BhdGhdO1xuICAgIH1cblxuICAgIGNvbnN0IHVwZ3JhZGVkQ29udGV4dCA9IE9iamVjdC5rZXlzKFZpZXdDb250ZXh0KVxuICAgICAgLm1hcChrZXkgPT4gKHtcbiAgICAgICAga2V5LFxuICAgICAgICBpc1VwZ3JhZGU6XG4gICAgICAgICAgcHJlZml4V2l0aFNsYXNoKFZpZXdDb250ZXh0W2tleV0ucmVwbGFjZSgnaWQnLCBWaWV3Q29udGV4dExlZ2FjeVBhcmFtZXRlcltrZXldKSkgPT09IHBhdGhcbiAgICAgIH0pKVxuICAgICAgLmZpbmQoKHsgaXNVcGdyYWRlIH0pID0+IGlzVXBncmFkZSk7XG5cbiAgICBpZiAodXBncmFkZWRDb250ZXh0KSB7XG4gICAgICBjdXJyZW50Q2ZnLnB1c2goY2ZnKTtcbiAgICAgIGNmZy5wYXRoID0gbmV3UGF0aDtcblxuICAgICAgY29uc3QgcCA9IGM4eVBhdGhVdGlscy5hcHBlbmRTZWdtZW50KG9yaWdpbmFsUGF0aC5yZXBsYWNlKHBhdGgsICcnKSwgY2ZnLm5hbWUpO1xuICAgICAgY29udGV4dFZpZXdzLm5leHQoe1xuICAgICAgICAuLi5jZmcsXG4gICAgICAgIHBhdGg6IGNmZy5uYW1lID8gcC5zdWJzdHJpbmcoMSkgOiAnJyxcbiAgICAgICAgY29udGV4dEtleTogdXBncmFkZWRDb250ZXh0LmtleSxcbiAgICAgICAgcnVuUGhhc2VcbiAgICAgIH0pO1xuICAgICAgY2ZnLnNob3dJZiA9IHVuZGVmaW5lZDtcbiAgICAgIGlmIChjZmcubmFtZSkge1xuICAgICAgICBjZmcucGF0aCA9IGM4eVBhdGhVdGlscy5hcHBlbmRTZWdtZW50KG9yaWdpbmFsUGF0aCwgY2ZnLm5hbWUpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoY3VycmVudENmZy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgY29uc3QgW2V4aXN0aW5nQ29uZmlnXSA9IGN1cnJlbnRDZmc7XG4gICAgICAgIGV4aXN0aW5nQ29uZmlnLnBhdGggPSBjOHlQYXRoVXRpbHMuYXBwZW5kU2VnbWVudChvcmlnaW5hbFBhdGgsIGV4aXN0aW5nQ29uZmlnLm5hbWUpO1xuICAgICAgICBleGlzdGluZ0NvbmZpZy50YWIgPSBjcmVhdGVUYWIob3JpZ2luYWxQYXRoLCBleGlzdGluZ0NvbmZpZyk7XG4gICAgICAgICRyb3V0ZVByb3ZpZGVyLndoZW4oZXhpc3RpbmdDb25maWcucGF0aCwgZXhpc3RpbmdDb25maWcpO1xuICAgICAgfVxuXG4gICAgICBjdXJyZW50Q2ZnLnB1c2goY2ZnKTtcbiAgICAgIGNmZy5wYXRoID0gbmV3UGF0aDtcblxuICAgICAgaWYgKGN1cnJlbnRDZmcubGVuZ3RoID4gMSkge1xuICAgICAgICBjZmcucGF0aCA9IGM4eVBhdGhVdGlscy5hcHBlbmRTZWdtZW50KG9yaWdpbmFsUGF0aCwgY2ZnLm5hbWUpO1xuICAgICAgICBjcmVhdGVUYWIob3JpZ2luYWxQYXRoLCBjZmcpO1xuXG4gICAgICAgICRyb3V0ZVByb3ZpZGVyLndoZW4ocHJlZml4V2l0aFNsYXNoKG9yaWdpbmFsUGF0aCksIHtcbiAgICAgICAgICByZXNvbHZlUmVkaXJlY3RUbygkcm91dGUsICRxLCBjOHlVaVV0aWwsIGM4eVRhYnMsIGdldHRleHRDYXRhbG9nKSB7XG4gICAgICAgICAgICAnbmdJbmplY3QnO1xuXG4gICAgICAgICAgICBjb25zdCBzb3J0ZWRDdXJyZW50Q2ZnID0gYzh5VGFic1Byb3ZpZGVyLnNvcnRUYWJzVmlld3MoY3VycmVudENmZywgZ2V0dGV4dENhdGFsb2cpO1xuICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gJHJvdXRlLmN1cnJlbnQucGF0aFBhcmFtcztcblxuICAgICAgICAgICAgcmV0dXJuICRxXG4gICAgICAgICAgICAgIC5hbGwobWFwKHNvcnRlZEN1cnJlbnRDZmcsIHVuYXJ5KGM4eVVpVXRpbC5jb25maWd1cmVWaXNpYmlsaXR5KSkpXG4gICAgICAgICAgICAgIC50aGVuKHZpZXdzID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaXJzdCA9IGZpbmQodmlld3MsICdzaG93Jyk7XG4gICAgICAgICAgICAgICAgbGV0IHVybCA9IGZpcnN0LnBhdGg7XG4gICAgICAgICAgICAgICAgZm9yRWFjaChwYXJhbXMsICh2YWwsIGtleSkgPT4ge1xuICAgICAgICAgICAgICAgICAgdXJsID0gdXJsLnJlcGxhY2UoYDoke2tleX1gLCB2YWwpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGM4eVRhYnMucmVkaXJlY3RlZFZpZXdQYXRoID0gdXJsO1xuICAgICAgICAgICAgICAgIHJldHVybiB1cmw7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiAkcm91dGVQcm92aWRlci53aGVuKHByZWZpeFdpdGhTbGFzaChjZmcucGF0aCksIGNmZyk7XG4gIH1cblxuICBmdW5jdGlvbiBnZXRCeVBhdGgocGF0aCkge1xuICAgIHJldHVybiB2aWV3TWFwW3ByZWZpeFdpdGhTbGFzaChwYXRoKV07XG4gIH1cblxuICBmdW5jdGlvbiBjcmVhdGVUYWIocGF0aCwgY2ZnKSB7XG4gICAgYzh5VGFic1Byb3ZpZGVyLmFkZFRhYihwYXRoLCBjZmcpO1xuICB9XG5cbiAgZnVuY3Rpb24gcHJlZml4V2l0aFNsYXNoKHBhdGgpIHtcbiAgICBjb25zdCBwcmVmaXggPSBzdGFydHNXaXRoKHBhdGgsICcvJykgPyAnJyA6ICcvJztcbiAgICByZXR1cm4gcHJlZml4ICsgcGF0aDtcbiAgfVxufVxuXG5leHBvcnQgeyBjOHlWaWV3c1Byb3ZpZGVyIH07XG4iXX0=