import { Subject, defer, of } from 'rxjs';
import { merge } from 'rxjs/operators';
import { pick, map, property, some, every } from 'lodash-es';
import { NavigatorNodeRootLegacy } from './navigator-node-root-legacy';
// Just to hook into the bridge service
export function c8yNavigatorProvider() {
    var root = new NavigatorNodeRootLegacy();
    var rootNodesSubject = new Subject();
    var conditionalNodes = [];
    var rootNodes$ = rootNodesSubject.pipe(merge(defer(function () { return of(root.children); })));
    function addNavigation(nodes) {
        var nodeList = (Array.isArray(nodes) ? nodes : [nodes]);
        nodeList.forEach(function (node) {
            if (isConditional(node)) {
                node.hidden = undefined;
                conditionalNodes.push(node);
            }
            node.navNode = root.addRoot(node);
        });
        rootNodesSubject.next(root.children);
    }
    function removeNavigation(node) {
        var found = root.find(function (n) { return n === node; });
        if (found) {
            found.parents.forEach(function (p) { return p.remove(found); });
            rootNodesSubject.next(root.children);
        }
    }
    function findNode(node) {
        return root.find(node);
    }
    function isConditional(node) {
        return node.showIf || node.showIfPermissions || node.showIfContainsVisibleViews;
    }
    function $get($q, $injector) {
        'ngInject';
        // This avoids the circular dependency
        setTimeout(function () { return conditionalNodes.forEach(processShowIf); });
        function processShowIf(node) {
            var c8yUiUtil = $injector.get('c8yUiUtil');
            var visibilityPromises = [];
            var showIf = node.showIf, showIfPermissions = node.showIfPermissions, showIfContainsVisibleViews = node.showIfContainsVisibleViews;
            if (showIf) {
                visibilityPromises.push($injector.invoke(showIf));
            }
            if (showIfContainsVisibleViews) {
                visibilityPromises.push(viewsConditionalVisibility(node));
            }
            c8yUiUtil.configureVisibility({
                showIf: function () { return $q.all(visibilityPromises).then(every); },
                showIfPermissions: showIfPermissions
            }, 'visible')
                .then(function (_a) {
                var visible = _a.visible;
                if (visible) {
                    node.navNode.update({
                        hidden: false,
                        showIf: null,
                        showIfPermission: null,
                        showIfContainsVisibleViews: null
                    });
                }
                else {
                    node.navNode.update({
                        hidden: true
                    });
                }
            });
        }
        function viewsConditionalVisibility(node) {
            var c8yUiUtil = $injector.get('c8yUiUtil');
            var c8yViews = $injector.get('c8yViews');
            var views = c8yViews.getByPath(node.path);
            return $q.all(map(views, function (view) { return c8yUiUtil
                .configureVisibility(pick(view, ['showIf', 'showIfPermissions']), 'show', false)
                .then(property('show')); }))
                .then(some);
        }
        return {
            rootNodes: function () {
                return root.children;
            },
            findNode: findNode,
            addNavigation: addNavigation,
            removeNavigation: removeNavigation,
            rootNodes$: rootNodes$
        };
    }
    return {
        $get: $get,
        addNavigation: addNavigation,
        removeNavigation: removeNavigation
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdG9yLnByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy91cGdyYWRlLyIsInNvdXJjZXMiOlsibmcxL25hdmlnYXRvci5wcm92aWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQWMsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxJQUFJLEVBQUcsR0FBRyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzlELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRXZFLHVDQUF1QztBQUN2QyxNQUFNLFVBQVUsb0JBQW9CO0lBQ2xDLElBQU0sSUFBSSxHQUFHLElBQUksdUJBQXVCLEVBQUUsQ0FBQztJQUMzQyxJQUFNLGdCQUFnQixHQUE2QixJQUFJLE9BQU8sRUFBRSxDQUFDO0lBQ2pFLElBQU0sZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO0lBQzVCLElBQU0sVUFBVSxHQUFnQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQ25FLEtBQUssQ0FBQyxLQUFLLENBQUMsY0FBTSxPQUFBLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQWpCLENBQWlCLENBQUMsQ0FBQyxDQUN0QyxDQUFDO0lBRUYsU0FBUyxhQUFhLENBQUMsS0FBSztRQUMxQixJQUFNLFFBQVEsR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQzFELFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBQyxJQUFJO1lBQ3BCLElBQUksYUFBYSxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUN2QixJ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SUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUMzQyxJQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM1QyxPQUFPLEVBQUUsQ0FBQyxHQUFHLENBQ1gsR0FBRyxDQUFDLEtBQUssRUFBRSxVQUFDLElBQUksSUFBSyxPQUFBLFNBQVM7aUJBQzNCLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxRQUFRLEVBQUUsbUJBQW1CLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxLQUFLLENBQUM7aUJBQy9FLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsRUFGSixDQUVJLENBQ3hCLENBQ0Y7aUJBQ0EsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2QsQ0FBQztRQUVELE9BQU87WUFDTCxTQUFTO2dCQUNQLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztZQUN2QixDQUFDO1lBQ0QsUUFBUSxVQUFBO1lBQ1IsYUFBYSxlQUFBO1lBQ2IsZ0JBQWdCLGtCQUFBO1lBQ2hCLFVBQVUsWUFBQTtTQUNYLENBQUM7SUFDSixDQUFDO0lBRUQsT0FBTztRQUNMLElBQUksTUFBQTtRQUNKLGFBQWEsZUFBQTtRQUNiLGdCQUFnQixrQkFBQTtLQUNqQixDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5hdmlnYXRvck5vZGUgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIGRlZmVyLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWVyZ2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBwaWNrLCAgbWFwLCBwcm9wZXJ0eSwgc29tZSwgZXZlcnkgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgTmF2aWdhdG9yTm9kZVJvb3RMZWdhY3kgfSBmcm9tICcuL25hdmlnYXRvci1ub2RlLXJvb3QtbGVnYWN5JztcblxuLy8gSnVzdCB0byBob29rIGludG8gdGhlIGJyaWRnZSBzZXJ2aWNlXG5leHBvcnQgZnVuY3Rpb24gYzh5TmF2aWdhdG9yUHJvdmlkZXIoKSB7XG4gIGNvbnN0IHJvb3QgPSBuZXcgTmF2aWdhdG9yTm9kZVJvb3RMZWdhY3koKTtcbiAgY29uc3Qgcm9vdE5vZGVzU3ViamVjdDogU3ViamVjdDxOYXZpZ2F0b3JOb2RlW10+ID0gbmV3IFN1YmplY3QoKTtcbiAgY29uc3QgY29uZGl0aW9uYWxOb2RlcyA9IFtdO1xuICBjb25zdCByb290Tm9kZXMkOiBPYnNlcnZhYmxlPE5hdmlnYXRvck5vZGVbXT4gPSByb290Tm9kZXNTdWJqZWN0LnBpcGUoXG4gICAgbWVyZ2UoZGVmZXIoKCkgPT4gb2Yocm9vdC5jaGlsZHJlbikpKSxcbiAgKTtcblxuICBmdW5jdGlvbiBhZGROYXZpZ2F0aW9uKG5vZGVzKSB7XG4gICAgY29uc3Qgbm9kZUxpc3QgPSAoQXJyYXkuaXNBcnJheShub2RlcykgPyBub2RlcyA6IFtub2Rlc10pO1xuICAgIG5vZGVMaXN0LmZvckVhY2goKG5vZGUpID0+IHtcbiAgICAgIGlmIChpc0NvbmRpdGlvbmFsKG5vZGUpKSB7XG4gICAgICAgIG5vZGUuaGlkZGVuID0gdW5kZWZpbmVkO1xuICAgICAgICBjb25kaXRpb25hbE5vZGVzLnB1c2gobm9kZSk7XG4gICAgICB9XG4gICAgICBub2RlLm5hdk5vZGUgPSByb290LmFkZFJvb3Qobm9kZSk7XG4gICAgfSk7XG4gICAgcm9vdE5vZGVzU3ViamVjdC5uZXh0KHJvb3QuY2hpbGRyZW4pO1xuICB9XG5cbiAgZnVuY3Rpb24gcmVtb3ZlTmF2aWdhdGlvbihub2RlKSB7XG4gICAgY29uc3QgZm91bmQgPSByb290LmZpbmQoKG4pID0+IG4gPT09IG5vZGUpO1xuICAgIGlmIChmb3VuZCkge1xuICAgICAgZm91bmQucGFyZW50cy5mb3JFYWNoKChwKSA9PiBwLnJlbW92ZShmb3VuZCkpO1xuICAgICAgcm9vdE5vZGVzU3ViamVjdC5uZXh0KHJvb3QuY2hpbGRyZW4pO1xuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIGZpbmROb2RlKG5vZGUpIHtcbiAgICByZXR1cm4gcm9vdC5maW5kKG5vZGUpO1xuICB9XG5cbiAgZnVuY3Rpb24gaXNDb25kaXRpb25hbChub2RlKSB7XG4gICAgcmV0dXJuIG5vZGUuc2hvd0lmIHx8IG5vZGUuc2hvd0lmUGVybWlzc2lvbnMgfHwgbm9kZS5zaG93SWZDb250YWluc1Zpc2libGVWaWV3cztcbiAgfVxuXG4gIGZ1bmN0aW9uICRnZXQoJHEsICRpbmplY3Rvcikge1xuICAgICduZ0luamVjdCc7XG5cbiAgICAvLyBUaGlzIGF2b2lkcyB0aGUgY2lyY3VsYXIgZGVwZW5kZW5jeVxuICAgIHNldFRpbWVvdXQoKCkgPT4gY29uZGl0aW9uYWxOb2Rlcy5mb3JFYWNoKHByb2Nlc3NTaG93SWYpKTtcblxuICAgIGZ1bmN0aW9uIHByb2Nlc3NTaG93SWYobm9kZSkge1xuICAgICAgY29uc3QgYzh5VWlVdGlsID0gJGluamVjdG9yLmdldCgnYzh5VWlVdGlsJyk7XG4gICAgICBjb25zdCB2aXNpYmlsaXR5UHJvbWlzZXMgPSBbXTtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgc2hvd0lmLFxuICAgICAgICBzaG93SWZQZXJtaXNzaW9ucyxcbiAgICAgICAgc2hvd0lmQ29udGFpbnNWaXNpYmxlVmlld3NcbiAgICAgIH0gPSBub2RlO1xuXG4gICAgICBpZiAoc2hvd0lmKSB7XG4gICAgICAgIHZpc2liaWxpdHlQcm9taXNlcy5wdXNoKCRpbmplY3Rvci5pbnZva2Uoc2hvd0lmKSk7XG4gICAgICB9XG4gICAgICBpZiAoc2hvd0lmQ29udGFpbnNWaXNpYmxlVmlld3MpIHtcbiAgICAgICAgdmlzaWJpbGl0eVByb21pc2VzLnB1c2godmlld3NDb25kaXRpb25hbFZpc2liaWxpdHkobm9kZSkpO1xuICAgICAgfVxuXG4gICAgICBjOHlVaVV0aWwuY29uZmlndXJlVmlzaWJpbGl0eSh7XG4gICAgICAgIHNob3dJZjogKCkgPT4gJHEuYWxsKHZpc2liaWxpdHlQcm9taXNlcykudGhlbihldmVyeSksXG4gICAgICAgIHNob3dJZlBlcm1pc3Npb25zXG4gICAgICB9LCAndmlzaWJsZScpXG4gICAgICAgIC50aGVuKCh7IHZpc2libGUgfSkgPT4ge1xuICAgICAgICAgIGlmICh2aXNpYmxlKSB7XG4gICAgICAgICAgICBub2RlLm5hdk5vZGUudXBkYXRlKHtcbiAgICAgICAgICAgICAgaGlkZGVuOiBmYWxzZSxcbiAgICAgICAgICAgICAgc2hvd0lmOiBudWxsLFxuICAgICAgICAgICAgICBzaG93SWZQZXJtaXNzaW9uOiBudWxsLFxuICAgICAgICAgICAgICBzaG93SWZDb250YWluc1Zpc2libGVWaWV3czogbnVsbFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5vZGUubmF2Tm9kZS51cGRhdGUoe1xuICAgICAgICAgICAgICBoaWRkZW46IHRydWVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gdmlld3NDb25kaXRpb25hbFZpc2liaWxpdHkobm9kZSkge1xuICAgICAgY29uc3QgYzh5VWlVdGlsID0gJGluamVjdG9yLmdldCgnYzh5VWlVdGlsJyk7XG4gICAgICBjb25zdCBjOHlWaWV3cyA9ICRpbmplY3Rvci5nZXQoJ2M4eVZpZXdzJyk7XG4gICAgICBjb25zdCB2aWV3cyA9IGM4eVZpZXdzLmdldEJ5UGF0aChub2RlLnBhdGgpO1xuICAgICAgcmV0dXJuICRxLmFsbChcbiAgICAgICAgbWFwKHZpZXdzLCAodmlldykgPT4gYzh5VWlVdGlsXG4gICAgICAgICAgLmNvbmZpZ3VyZVZpc2liaWxpdHkocGljayh2aWV3LCBbJ3Nob3dJZicsICdzaG93SWZQZXJtaXNzaW9ucyddKSwgJ3Nob3cnLCBmYWxzZSlcbiAgICAgICAgICAudGhlbihwcm9wZXJ0eSgnc2hvdycpKVxuICAgICAgICApXG4gICAgICApXG4gICAgICAudGhlbihzb21lKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgcm9vdE5vZGVzKCkge1xuICAgICAgICByZXR1cm4gcm9vdC5jaGlsZHJlbjtcbiAgICAgIH0sXG4gICAgICBmaW5kTm9kZSxcbiAgICAgIGFkZE5hdmlnYXRpb24sXG4gICAgICByZW1vdmVOYXZpZ2F0aW9uLFxuICAgICAgcm9vdE5vZGVzJFxuICAgIH07XG4gIH1cblxuICByZXR1cm4ge1xuICAgICRnZXQsXG4gICAgYWRkTmF2aWdhdGlvbixcbiAgICByZW1vdmVOYXZpZ2F0aW9uXG4gIH07XG59XG4iXX0=