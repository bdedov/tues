import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { isUndefined, sortBy } from 'lodash-es';
import { debounceTime, take } from 'rxjs/operators';
import { IApplication, ApplicationType, ApplicationService, ISystemOption, TenantService, TenantOptionsService } from '@c8y/client';
import { HumanizeAppNamePipe } from '@c8y/ngx-components';
import { DefaultSubscriptionsContext as DefaultSubscriptionsContextTenant } from './default-subscriptions.model';
var DefaultSubscriptionsService = /** @class */ (function () {
    function DefaultSubscriptionsService(applicationService, tenantService, tenantOptionsService, humanizeAppNamePipe) {
        this.applicationService = applicationService;
        this.tenantService = tenantService;
        this.tenantOptionsService = tenantOptionsService;
        this.humanizeAppNamePipe = humanizeAppNamePipe;
    }
    /**
     * Gets the list of applications which can be used in default subscriptions, i.e.:
     * - current tenant's all own applications,
     * - inherited applications, which do not have the same names as current tenant's own apps.
     * The list is sorted alphabetically by humanized app name and contains up to 2000 items.
     * @returns The list of applications, which can be used in default subscriptions.
     */
    DefaultSubscriptionsService.prototype.getSubscribableTenantApps = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var currentTenant, allApps, ownApps, inheritedApps, filteredApps, filteredAppsWithHumanizedNames, sortedAppsWithHumanizedNames, sortedApps;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.tenantService.current()];
                    case 1:
                        currentTenant = (_a.sent()).data;
                        return [4 /*yield*/, this.applicationService.listByTenant(null, { pageSize: 2000 })];
                    case 2:
                        allApps = (_a.sent()).data;
                        ownApps = allApps.filter(function (app) { return app.owner.tenant.id === currentTenant.name; });
                        inheritedApps = allApps.filter(function (app) { return app.owner.tenant.id !== currentTenant.name; });
                        filteredApps = tslib_1.__spread(ownApps);
                        inheritedApps.forEach(function (inheritedApp) {
                            if (!filteredApps.some(function (filteredApp) { return filteredApp.name === inheritedApp.name; })) {
                                filteredApps.push(inheritedApp);
                            }
                        });
                        return [4 /*yield*/, Promise.all(filteredApps.map(function (app) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
                                var humanizedName;
                                return tslib_1.__generator(this, function (_a) {
                                    switch (_a.label) {
                                        case 0: return [4 /*yield*/, this.humanizeAppNamePipe
                                                .transform(app.name)
                                                .pipe(debounceTime(250), take(1))
                                                .toPromise()];
                                        case 1:
                                            humanizedName = _a.sent();
                                            return [2 /*return*/, { app: app, humanizedName: humanizedName }];
                                    }
                                });
                            }); }))];
                    case 3:
                        filteredAppsWithHumanizedNames = _a.sent();
                        sortedAppsWithHumanizedNames = sortBy(filteredAppsWithHumanizedNames, ['humanizedName']);
                        sortedApps = sortedAppsWithHumanizedNames.map(function (_a) {
                            var app = _a.app;
                            return app;
                        });
                        return [2 /*return*/, sortedApps];
                }
            });
        });
    };
    /**
     * Gets the default subscriptions configuration inherited from parent tenant.
     * @returns The default subscriptions object with settings from parent tenant.
     */
    DefaultSubscriptionsService.prototype.getDefaultSubscriptionsEvaluatedFromParentTenant = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, this.getDefaultSubscriptions(DefaultSubscriptionsContextTenant.PARENT_TENANT)];
            });
        });
    };
    /**
     * Gets the default subscriptions configuration from the current tenant.
     * @returns The default subscriptions object with settings from the current tenant.
     */
    DefaultSubscriptionsService.prototype.getDefaultSubscriptionsFromCurrentTenant = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, this.getDefaultSubscriptions(DefaultSubscriptionsContextTenant.CURRENT_TENANT)];
            });
        });
    };
    /**
     * Saves given default subscriptions configuration to the current tenant
     * (either sets, updates, or deletes corresponding tenant options).
     * @param defaultSubscriptions The default subscriptions configuration to be saved.
     */
    DefaultSubscriptionsService.prototype.saveDefaultSubscriptionsToCurrentTenant = function (defaultSubscriptions) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.saveOnCreationSubscriptions(defaultSubscriptions)];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.saveOnUpgradeSubscriptions(defaultSubscriptions)];
                    case 2:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Gets default subscriptions in the context of current or parent tenant.
     * @param contextTenant Tells whether to use current or parent tenant as context.
     */
    DefaultSubscriptionsService.prototype.getDefaultSubscriptions = function (contextTenant) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var tenantOptionsParams, overridable, _a, onCreationApps, onCreationMicroservices, onUpgradeAppsEnabled, onUpgradeApps, onUpgradeMicroservicesEnabled, onUpgradeMicroservices, onCreationSubscriptions, onUpgradeAppsDefault, onUpgradeMicroservicesDefault, onUpgradeSubscriptions, defaultSubscriptions;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        switch (contextTenant) {
                            case DefaultSubscriptionsContextTenant.CURRENT_TENANT:
                                tenantOptionsParams = { evaluate: 'current' };
                                overridable = true;
                                break;
                            case DefaultSubscriptionsContextTenant.PARENT_TENANT:
                                tenantOptionsParams = { evaluate: 'inherited' };
                                overridable = false;
                                break;
                        }
                        return [4 /*yield*/, this.getTenantOptions(tenantOptionsParams)];
                    case 1:
                        _a = _b.sent(), onCreationApps = _a.onCreationApps, onCreationMicroservices = _a.onCreationMicroservices, onUpgradeAppsEnabled = _a.onUpgradeAppsEnabled, onUpgradeApps = _a.onUpgradeApps, onUpgradeMicroservicesEnabled = _a.onUpgradeMicroservicesEnabled, onUpgradeMicroservices = _a.onUpgradeMicroservices;
                        onCreationSubscriptions = this.namesToPartialApps({
                            appsNamesStr: onCreationApps,
                            microservicesNamesStr: onCreationMicroservices
                        });
                        onUpgradeAppsDefault = overridable ? null : onCreationApps;
                        onUpgradeMicroservicesDefault = overridable ? null : onCreationMicroservices;
                        onUpgradeSubscriptions = this.namesToPartialApps({
                            appsNamesStr: onUpgradeAppsEnabled ? onUpgradeApps : onUpgradeAppsDefault,
                            microservicesNamesStr: onUpgradeMicroservicesEnabled
                                ? onUpgradeMicroservices
                                : onUpgradeMicroservicesDefault
                        });
                        defaultSubscriptions = {
                            onCreationSubscriptions: onCreationSubscriptions,
                            onUpgradeSubscriptions: onUpgradeSubscriptions
                        };
                        if (overridable) {
                            defaultSubscriptions.overrideOnCreationSubscriptions =
                                onCreationApps !== null || onCreationMicroservices !== null;
                            defaultSubscriptions.overrideOnUpgradeSubscriptions =
                                onUpgradeAppsEnabled || onUpgradeMicroservicesEnabled;
                        }
                        return [2 /*return*/, defaultSubscriptions];
                }
            });
        });
    };
    DefaultSubscriptionsService.prototype.getTenantOptions = function (params) {
        if (params === void 0) { params = {}; }
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a;
            return tslib_1.__generator(this, function (_b) {
                switch (_b.label) {
                    case 0:
                        _a = {};
                        return [4 /*yield*/, this.getTenantOption({
                                category: 'configuration',
                                key: 'default.tenant.applications'
                            }, null, params)];
                    case 1:
                        _a.onCreationApps = _b.sent();
                        return [4 /*yield*/, this.getTenantOption({
                                category: 'configuration',
                                key: 'default.tenant.microservices'
                            }, null, params)];
                    case 2:
                        _a.onCreationMicroservices = _b.sent();
                        return [4 /*yield*/, this.getTenantOption({
                                category: 'configuration',
                                key: 'on-update.tenant.applications.enabled'
                            }, false, params)];
                    case 3:
                        _a.onUpgradeAppsEnabled = _b.sent();
                        return [4 /*yield*/, this.getTenantOption({
                                category: 'configuration',
                                key: 'on-update.tenant.applications'
                            }, null, params)];
                    case 4:
                        _a.onUpgradeApps = _b.sent();
                        return [4 /*yield*/, this.getTenantOption({
                                category: 'configuration',
                                key: 'on-update.tenant.microservices.enabled'
                            }, false, params)];
                    case 5:
                        _a.onUpgradeMicroservicesEnabled = _b.sent();
                        return [4 /*yield*/, this.getTenantOption({
                                category: 'configuration',
                                key: 'on-update.tenant.microservices'
                            }, null, params)];
                    case 6: return [2 /*return*/, (_a.onUpgradeMicroservices = _b.sent(),
                            _a)];
                }
            });
        });
    };
    DefaultSubscriptionsService.prototype.saveOnCreationSubscriptions = function (defaultSubscriptions) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!defaultSubscriptions.overrideOnCreationSubscriptions) return [3 /*break*/, 3];
                        return [4 /*yield*/, this.setTenantOption({
                                category: 'configuration',
                                key: 'default.tenant.applications',
                                value: this.partialAppsListToAppsNames(defaultSubscriptions.onCreationSubscriptions)
                            })];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.setTenantOption({
                                category: 'configuration',
                                key: 'default.tenant.microservices',
                                value: this.partialAppsToMicroservicesNames(defaultSubscriptions.onCreationSubscriptions)
                            })];
                    case 2:
                        _a.sent();
                        return [3 /*break*/, 6];
                    case 3: return [4 /*yield*/, this.unsetTenantOption({
                            category: 'configuration',
                            key: 'default.tenant.applications'
                        })];
                    case 4:
                        _a.sent();
                        return [4 /*yield*/, this.unsetTenantOption({
                                category: 'configuration',
                                key: 'default.tenant.microservices'
                            })];
                    case 5:
                        _a.sent();
                        _a.label = 6;
                    case 6: return [2 /*return*/];
                }
            });
        });
    };
    DefaultSubscriptionsService.prototype.saveOnUpgradeSubscriptions = function (defaultSubscriptions) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!defaultSubscriptions.overrideOnUpgradeSubscriptions) return [3 /*break*/, 5];
                        return [4 /*yield*/, this.setTenantOption({
                                category: 'configuration',
                                key: 'on-update.tenant.applications.enabled',
                                value: 'true'
                            })];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.setTenantOption({
                                category: 'configuration',
                                key: 'on-update.tenant.microservices.enabled',
                                value: 'true'
                            })];
                    case 2:
                        _a.sent();
                        return [4 /*yield*/, this.setTenantOption({
                                category: 'configuration',
                                key: 'on-update.tenant.applications',
                                value: this.partialAppsListToAppsNames(defaultSubscriptions.onUpgradeSubscriptions)
                            })];
                    case 3:
                        _a.sent();
                        return [4 /*yield*/, this.setTenantOption({
                                category: 'configuration',
                                key: 'on-update.tenant.microservices',
                                value: this.partialAppsToMicroservicesNames(defaultSubscriptions.onUpgradeSubscriptions)
                            })];
                    case 4:
                        _a.sent();
                        return [3 /*break*/, 10];
                    case 5: return [4 /*yield*/, this.unsetTenantOption({
                            category: 'configuration',
                            key: 'on-update.tenant.applications.enabled'
                        })];
                    case 6:
                        _a.sent();
                        return [4 /*yield*/, this.unsetTenantOption({
                                category: 'configuration',
                                key: 'on-update.tenant.microservices.enabled'
                            })];
                    case 7:
                        _a.sent();
                        return [4 /*yield*/, this.unsetTenantOption({
                                category: 'configuration',
                                key: 'on-update.tenant.applications'
                            })];
                    case 8:
                        _a.sent();
                        return [4 /*yield*/, this.unsetTenantOption({
                                category: 'configuration',
                                key: 'on-update.tenant.microservices'
                            })];
                    case 9:
                        _a.sent();
                        _a.label = 10;
                    case 10: return [2 /*return*/];
                }
            });
        });
    };
    DefaultSubscriptionsService.prototype.getTenantOption = function (option, defaultValue, params) {
        if (defaultValue === void 0) { defaultValue = null; }
        if (params === void 0) { params = {}; }
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var value, ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, this.tenantOptionsService.detail(option, params)];
                    case 1:
                        value = (_a.sent()).data.value;
                        value = JSON.parse(value);
                        return [3 /*break*/, 3];
                    case 2:
                        ex_1 = _a.sent();
                        value = !isUndefined(value) ? value : defaultValue;
                        return [3 /*break*/, 3];
                    case 3: return [2 /*return*/, value];
                }
            });
        });
    };
    DefaultSubscriptionsService.prototype.setTenantOption = function (option) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                return [2 /*return*/, this.tenantOptionsService.update(option)];
            });
        });
    };
    DefaultSubscriptionsService.prototype.unsetTenantOption = function (option) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var ex_2;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, this.tenantOptionsService.delete(option)];
                    case 1:
                        _a.sent();
                        return [3 /*break*/, 3];
                    case 2:
                        ex_2 = _a.sent();
                        if (!ex_2 || !ex_2.res || ex_2.res.status !== 404) {
                            throw ex_2;
                        }
                        return [3 /*break*/, 3];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    DefaultSubscriptionsService.prototype.namesToPartialApps = function (_a) {
        var appsNamesStr = _a.appsNamesStr, microservicesNamesStr = _a.microservicesNamesStr;
        if (appsNamesStr === null && microservicesNamesStr === null) {
            return null;
        }
        return tslib_1.__spread((appsNamesStr || '')
            .split(',')
            .filter(function (name) { return name.length; })
            .map(function (name) { return ({ name: name.trim() }); }), (microservicesNamesStr || '')
            .split(',')
            .filter(function (name) { return name.length; })
            .map(function (name) { return ({
            name: name.trim(),
            type: ApplicationType.MICROSERVICE
        }); }));
    };
    DefaultSubscriptionsService.prototype.partialAppsListToAppsNames = function (apps) {
        return apps
            .filter(function (app) { return app.type !== ApplicationType.MICROSERVICE; })
            .map(function (app) { return app.name; })
            .join(',');
    };
    DefaultSubscriptionsService.prototype.partialAppsToMicroservicesNames = function (apps) {
        return apps
            .filter(function (app) { return app.type === ApplicationType.MICROSERVICE; })
            .map(function (app) { return app.name; })
            .join(',');
    };
    DefaultSubscriptionsService.ctorParameters = function () { return [
        { type: ApplicationService },
        { type: TenantService },
        { type: TenantOptionsService },
        { type: HumanizeAppNamePipe }
    ]; };
    DefaultSubscriptionsService = tslib_1.__decorate([
        Injectable()
    ], DefaultSubscriptionsService);
    return DefaultSubscriptionsService;
}());
export { DefaultSubscriptionsService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1zdWJzY3JpcHRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL2RlZmF1bHQtc3Vic2NyaXB0aW9ucy8iLCJzb3VyY2VzIjpbImRlZmF1bHQtc3Vic2NyaXB0aW9ucy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2hELE9BQU8sRUFBRSxZQUFZLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFcEQsT0FBTyxFQUNMLFlBQVksRUFDWixlQUFlLEVBQ2Ysa0JBQWtCLEVBQ2xCLGFBQWEsRUFDYixhQUFhLEVBQ2Isb0JBQW9CLEVBQ3JCLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRTFELE9BQU8sRUFHTCwyQkFBMkIsSUFBSSxpQ0FBaUMsRUFDakUsTUFBTSwrQkFBK0IsQ0FBQztBQUd2QztJQUNFLHFDQUNVLGtCQUFzQyxFQUN0QyxhQUE0QixFQUM1QixvQkFBMEMsRUFDMUMsbUJBQXdDO1FBSHhDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQUMxQyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO0lBQy9DLENBQUM7SUFFSjs7Ozs7O09BTUc7SUFDRywrREFBeUIsR0FBL0I7Ozs7Ozs0QkFDeUIscUJBQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsRUFBQTs7d0JBQW5ELGFBQWEsR0FBRyxDQUFDLFNBQWtDLENBQUMsQ0FBQyxJQUFJO3dCQUU5QyxxQkFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsWUFBWSxD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QUMsSUFBSSxLQUFLLGVBQWUsQ0FBQyxZQUFZLEVBQXpDLENBQXlDLENBQUM7YUFDeEQsR0FBRyxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxDQUFDLElBQUksRUFBUixDQUFRLENBQUM7YUFDcEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2YsQ0FBQzs7Z0JBelQ2QixrQkFBa0I7Z0JBQ3ZCLGFBQWE7Z0JBQ04sb0JBQW9CO2dCQUNyQixtQkFBbUI7O0lBTHZDLDJCQUEyQjtRQUR2QyxVQUFVLEVBQUU7T0FDQSwyQkFBMkIsQ0E0VHZDO0lBQUQsa0NBQUM7Q0FBQSxBQTVURCxJQTRUQztTQTVUWSwyQkFBMkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBpc1VuZGVmaW5lZCwgc29ydEJ5IH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHtcbiAgSUFwcGxpY2F0aW9uLFxuICBBcHBsaWNhdGlvblR5cGUsXG4gIEFwcGxpY2F0aW9uU2VydmljZSxcbiAgSVN5c3RlbU9wdGlvbixcbiAgVGVuYW50U2VydmljZSxcbiAgVGVuYW50T3B0aW9uc1NlcnZpY2Vcbn0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgSHVtYW5pemVBcHBOYW1lUGlwZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuXG5pbXBvcnQge1xuICBQYXJ0aWFsQXBwc0xpc3QsXG4gIERlZmF1bHRTdWJzY3JpcHRpb25zLFxuICBEZWZhdWx0U3Vic2NyaXB0aW9uc0NvbnRleHQgYXMgRGVmYXVsdFN1YnNjcmlwdGlvbnNDb250ZXh0VGVuYW50XG59IGZyb20gJy4vZGVmYXVsdC1zdWJzY3JpcHRpb25zLm1vZGVsJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIERlZmF1bHRTdWJzY3JpcHRpb25zU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYXBwbGljYXRpb25TZXJ2aWNlOiBBcHBsaWNhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSB0ZW5hbnRTZXJ2aWNlOiBUZW5hbnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgdGVuYW50T3B0aW9uc1NlcnZpY2U6IFRlbmFudE9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgaHVtYW5pemVBcHBOYW1lUGlwZTogSHVtYW5pemVBcHBOYW1lUGlwZVxuICApIHt9XG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIGxpc3Qgb2YgYXBwbGljYXRpb25zIHdoaWNoIGNhbiBiZSB1c2VkIGluIGRlZmF1bHQgc3Vic2NyaXB0aW9ucywgaS5lLjpcbiAgICogLSBjdXJyZW50IHRlbmFudCdzIGFsbCBvd24gYXBwbGljYXRpb25zLFxuICAgKiAtIGluaGVyaXRlZCBhcHBsaWNhdGlvbnMsIHdoaWNoIGRvIG5vdCBoYXZlIHRoZSBzYW1lIG5hbWVzIGFzIGN1cnJlbnQgdGVuYW50J3Mgb3duIGFwcHMuXG4gICAqIFRoZSBsaXN0IGlzIHNvcnRlZCBhbHBoYWJldGljYWxseSBieSBodW1hbml6ZWQgYXBwIG5hbWUgYW5kIGNvbnRhaW5zIHVwIHRvIDIwMDAgaXRlbXMuXG4gICAqIEByZXR1cm5zIFRoZSBsaXN0IG9mIGFwcGxpY2F0aW9ucywgd2hpY2ggY2FuIGJlIHVzZWQgaW4gZGVmYXVsdCBzdWJzY3JpcHRpb25zLlxuICAgKi9cbiAgYXN5bmMgZ2V0U3Vic2NyaWJhYmxlVGVuYW50QXBwcygpOiBQcm9taXNlPElBcHBsaWNhdGlvbltdPiB7XG4gICAgY29uc3QgY3VycmVudFRlbmFudCA9IChhd2FpdCB0aGlzLnRlbmFudFNlcnZpY2UuY3VycmVudCgpKS5kYXRhO1xuXG4gICAgY29uc3QgYWxsQXBwcyA9IChhd2FpdCB0aGlzLmFwcGxpY2F0aW9uU2VydmljZS5saXN0QnlUZW5hbnQobnVsbCwgeyBwYWdlU2l6ZTogMjAwMCB9KSkuZGF0YTtcbiAgICBjb25zdCBvd25BcHBzID0gYWxsQXBwcy5maWx0ZXIoYXBwID0+IGFwcC5vd25lci50ZW5hbnQuaWQgPT09IGN1cnJlbnRUZW5hbnQubmFtZSk7XG4gICAgY29uc3QgaW5oZXJpdGVkQXBwcyA9IGFsbEFwcHMuZmlsdGVyKGFwcCA9PiBhcHAub3duZXIudGVuYW50LmlkICE9PSBjdXJyZW50VGVuYW50Lm5hbWUpO1xuXG4gICAgY29uc3QgZmlsdGVyZWRBcHBzOiBJQXBwbGljYXRpb25bXSA9IFsuLi5vd25BcHBzXTtcbiAgICBpbmhlcml0ZWRBcHBzLmZvckVhY2goaW5oZXJpdGVkQXBwID0+IHtcbiAgICAgIGlmICghZmlsdGVyZWRBcHBzLnNvbWUoZmlsdGVyZWRBcHAgPT4gZmlsdGVyZWRBcHAubmFtZSA9PT0gaW5oZXJpdGVkQXBwLm5hbWUpKSB7XG4gICAgICAgIGZpbHRlcmVkQXBwcy5wdXNoKGluaGVyaXRlZEFwcCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCBmaWx0ZXJlZEFwcHNXaXRoSHVtYW5pemVkTmFtZXMgPSBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgIGZpbHRlcmVkQXBwcy5tYXAoYXN5bmMgYXBwID0+IHtcbiAgICAgICAgY29uc3QgaHVtYW5pemVkTmFtZSA9IGF3YWl0IHRoaXMuaHVtYW5pemVBcHBOYW1lUGlwZVxuICAgICAgICAgIC50cmFuc2Zvcm0oYXBwLm5hbWUpXG4gICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICBkZWJvdW5jZVRpbWUoMjUwKSxcbiAgICAgICAgICAgIHRha2UoMSlcbiAgICAgICAgICApXG4gICAgICAgICAgLnRvUHJvbWlzZSgpO1xuICAgICAgICByZXR1cm4geyBhcHAsIGh1bWFuaXplZE5hbWUgfTtcbiAgICAgIH0pXG4gICAgKTtcbiAgICBjb25zdCBzb3J0ZWRBcHBzV2l0aEh1bWFuaXplZE5hbWVzID0gc29ydEJ5KGZpbHRlcmVkQXBwc1dpdGhIdW1hbml6ZWROYW1lcywgWydodW1hbml6ZWROYW1lJ10pO1xuICAgIGNvbnN0IHNvcnRlZEFwcHMgPSBzb3J0ZWRBcHBzV2l0aEh1bWFuaXplZE5hbWVzLm1hcCgoeyBhcHAgfSkgPT4gYXBwKTtcblxuICAgIHJldHVybiBzb3J0ZWRBcHBzO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIGRlZmF1bHQgc3Vic2NyaXB0aW9ucyBjb25maWd1cmF0aW9uIGluaGVyaXRlZCBmcm9tIHBhcmVudCB0ZW5hbnQuXG4gICAqIEByZXR1cm5zIFRoZSBkZWZhdWx0IHN1YnNjcmlwdGlvbnMgb2JqZWN0IHdpdGggc2V0dGluZ3MgZnJvbSBwYXJlbnQgdGVuYW50LlxuICAgKi9cbiAgYXN5bmMgZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbnNFdmFsdWF0ZWRGcm9tUGFyZW50VGVuYW50KCk6IFByb21pc2U8RGVmYXVsdFN1YnNjcmlwdGlvbnM+IHtcbiAgICByZXR1cm4gdGhpcy5nZXREZWZhdWx0U3Vic2NyaXB0aW9ucyhEZWZhdWx0U3Vic2NyaXB0aW9uc0NvbnRleHRUZW5hbnQuUEFSRU5UX1RFTkFOVCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyB0aGUgZGVmYXVsdCBzdWJzY3JpcHRpb25zIGNvbmZpZ3VyYXRpb24gZnJvbSB0aGUgY3VycmVudCB0ZW5hbnQuXG4gICAqIEByZXR1cm5zIFRoZSBkZWZhdWx0IHN1YnNjcmlwdGlvbnMgb2JqZWN0IHdpdGggc2V0dGluZ3MgZnJvbSB0aGUgY3VycmVudCB0ZW5hbnQuXG4gICAqL1xuICBhc3luYyBnZXREZWZhdWx0U3Vic2NyaXB0aW9uc0Zyb21DdXJyZW50VGVuYW50KCk6IFByb21pc2U8RGVmYXVsdFN1YnNjcmlwdGlvbnM+IHtcbiAgICByZXR1cm4gdGhpcy5nZXREZWZhdWx0U3Vic2NyaXB0aW9ucyhEZWZhdWx0U3Vic2NyaXB0aW9uc0NvbnRleHRUZW5hbnQuQ1VSUkVOVF9URU5BTlQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNhdmVzIGdpdmVuIGRlZmF1bHQgc3Vic2NyaXB0aW9ucyBjb25maWd1cmF0aW9uIHRvIHRoZSBjdXJyZW50IHRlbmFudFxuICAgKiAoZWl0aGVyIHNldHMsIHVwZGF0ZXMsIG9yIGRlbGV0ZXMgY29ycmVzcG9uZGluZyB0ZW5hbnQgb3B0aW9ucykuXG4gICAqIEBwYXJhbSBkZWZhdWx0U3Vic2NyaXB0aW9ucyBUaGUgZGVmYXVsdCBzdWJzY3JpcHRpb25zIGNvbmZpZ3VyYXRpb24gdG8gYmUgc2F2ZWQuXG4gICAqL1xuICBhc3luYyBzYXZlRGVmYXVsdFN1YnNjcmlwdGlvbnNUb0N1cnJlbnRUZW5hbnQoZGVmYXVsdFN1YnNjcmlwdGlvbnM6IERlZmF1bHRTdWJzY3JpcHRpb25zKSB7XG4gICAgYXdhaXQgdGhpcy5zYXZlT25DcmVhdGlvblN1YnNjcmlwdGlvbnMoZGVmYXVsdFN1YnNjcmlwdGlvbnMpO1xuICAgIGF3YWl0IHRoaXMuc2F2ZU9uVXBncmFkZVN1YnNjcmlwdGlvbnMoZGVmYXVsdFN1YnNjcmlwdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgZGVmYXVsdCBzdWJzY3JpcHRpb25zIGluIHRoZSBjb250ZXh0IG9mIGN1cnJlbnQgb3IgcGFyZW50IHRlbmFudC5cbiAgICogQHBhcmFtIGNvbnRleHRUZW5hbnQgVGVsbHMgd2hldGhlciB0byB1c2UgY3VycmVudCBvciBwYXJlbnQgdGVuYW50IGFzIGNvbnRleHQuXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGdldERlZmF1bHRTdWJzY3JpcHRpb25zKFxuICAgIGNvbnRleHRUZW5hbnQ6IERlZmF1bHRTdWJzY3JpcHRpb25zQ29udGV4dFRlbmFudFxuICApOiBQcm9taXNlPERlZmF1bHRTdWJzY3JpcHRpb25zPiB7XG4gICAgbGV0IHRlbmFudE9wdGlvbnNQYXJhbXM6IG9iamVjdDtcbiAgICBsZXQgb3ZlcnJpZGFibGU6IGJvb2xlYW47XG5cbiAgICBzd2l0Y2ggKGNvbnRleHRUZW5hbnQpIHtcbiAgICAgIGNhc2UgRGVmYXVsdFN1YnNjcmlwdGlvbnNDb250ZXh0VGVuYW50LkNVUlJFTlRfVEVOQU5UOlxuICAgICAgICB0ZW5hbnRPcHRpb25zUGFyYW1zID0geyBldmFsdWF0ZTogJ2N1cnJlbnQnIH07XG4gICAgICAgIG92ZXJyaWRhYmxlID0gdHJ1ZTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgRGVmYXVsdFN1YnNjcmlwdGlvbnNDb250ZXh0VGVuYW50LlBBUkVOVF9URU5BTlQ6XG4gICAgICAgIHRlbmFudE9wdGlvbnNQYXJhbXMgPSB7IGV2YWx1YXRlOiAnaW5oZXJpdGVkJyB9O1xuICAgICAgICBvdmVycmlkYWJsZSA9IGZhbHNlO1xuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICBjb25zdCB7XG4gICAgICBvbkNyZWF0aW9uQXBwcyxcbiAgICAgIG9uQ3JlYXRpb25NaWNyb3NlcnZpY2VzLFxuICAgICAgb25VcGdyYWRlQXBwc0VuYWJsZWQsXG4gICAgICBvblVwZ3JhZGVBcHBzLFxuICAgICAgb25VcGdyYWRlTWljcm9zZXJ2aWNlc0VuYWJsZWQsXG4gICAgICBvblVwZ3JhZGVNaWNyb3NlcnZpY2VzXG4gICAgfSA9IGF3YWl0IHRoaXMuZ2V0VGVuYW50T3B0aW9ucyh0ZW5hbnRPcHRpb25zUGFyYW1zKTtcblxuICAgIGNvbnN0IG9uQ3JlYXRpb25TdWJzY3JpcHRpb25zID0gdGhpcy5uYW1lc1RvUGFydGlhbEFwcHMoe1xuICAgICAgYXBwc05hbWVzU3RyOiBvbkNyZWF0aW9uQXBwcyxcbiAgICAgIG1pY3Jvc2VydmljZXNOYW1lc1N0cjogb25DcmVhdGlvbk1pY3Jvc2VydmljZXNcbiAgICB9KTtcblxuICAgIGNvbnN0IG9uVXBncmFkZUFwcHNEZWZhdWx0ID0gb3ZlcnJpZGFibGUgPyBudWxsIDogb25DcmVhdGlvbkFwcHM7XG4gICAgY29uc3Qgb25VcGdyYWRlTWljcm9zZXJ2aWNlc0RlZmF1bHQgPSBvdmVycmlkYWJsZSA/IG51bGwgOiBvbkNyZWF0aW9uTWljcm9zZXJ2aWNlcztcbiAgICBjb25zdCBvblVwZ3JhZGVTdWJzY3JpcHRpb25zID0gdGhpcy5uYW1lc1RvUGFydGlhbEFwcHMoe1xuICAgICAgYXBwc05hbWVzU3RyOiBvblVwZ3JhZGVBcHBzRW5hYmxlZCA/IG9uVXBncmFkZUFwcHMgOiBvblVwZ3JhZGVBcHBzRGVmYXVsdCxcbiAgICAgIG1pY3Jvc2VydmljZXNOYW1lc1N0cjogb25VcGdyYWRlTWljcm9zZXJ2aWNlc0VuYWJsZWRcbiAgICAgICAgPyBvblVwZ3JhZGVNaWNyb3NlcnZpY2VzXG4gICAgICAgIDogb25VcGdyYWRlTWljcm9zZXJ2aWNlc0RlZmF1bHRcbiAgICB9KTtcblxuICAgIGNvbnN0IGRlZmF1bHRTdWJzY3JpcHRpb25zOiBEZWZhdWx0U3Vic2NyaXB0aW9ucyA9IHtcbiAgICAgIG9uQ3JlYXRpb25TdWJzY3JpcHRpb25zLFxuICAgICAgb25VcGdyYWRlU3Vic2NyaXB0aW9uc1xuICAgIH07XG5cbiAgICBpZiAob3ZlcnJpZGFibGUpIHtcbiAgICAgIGRlZmF1bHRTdWJzY3JpcHRpb25zLm92ZXJyaWRlT25DcmVhdGlvblN1YnNjcmlwdGlvbnMgPVxuICAgICAgICBvbkNyZWF0aW9uQXBwcyAhPT0gbnVsbCB8fCBvbkNyZWF0aW9uTWljcm9zZXJ2aWNlcyAhPT0gbnVsbDtcbiAgICAgIGRlZmF1bHRTdWJzY3JpcHRpb25zLm92ZXJyaWRlT25VcGdyYWRlU3Vic2NyaXB0aW9ucyA9XG4gICAgICAgIG9uVXBncmFkZUFwcHNFbmFibGVkIHx8IG9uVXBncmFkZU1pY3Jvc2VydmljZXNFbmFibGVkO1xuICAgIH1cblxuICAgIHJldHVybiBkZWZhdWx0U3Vic2NyaXB0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0VGVuYW50T3B0aW9ucyhwYXJhbXMgPSB7fSkge1xuICAgIHJldHVybiB7XG4gICAgICBvbkNyZWF0aW9uQXBwczogYXdhaXQgdGhpcy5nZXRUZW5hbnRPcHRpb24oXG4gICAgICAgIHtcbiAgICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICAgIGtleTogJ2RlZmF1bHQudGVuYW50LmFwcGxpY2F0aW9ucydcbiAgICAgICAgfSxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgcGFyYW1zXG4gICAgICApLFxuICAgICAgb25DcmVhdGlvbk1pY3Jvc2VydmljZXM6IGF3YWl0IHRoaXMuZ2V0VGVuYW50T3B0aW9uKFxuICAgICAgICB7XG4gICAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAgICBrZXk6ICdkZWZhdWx0LnRlbmFudC5taWNyb3NlcnZpY2VzJ1xuICAgICAgICB9LFxuICAgICAgICBudWxsLFxuICAgICAgICBwYXJhbXNcbiAgICAgICksXG4gICAgICBvblVwZ3JhZGVBcHBzRW5hYmxlZDogYXdhaXQgdGhpcy5nZXRUZW5hbnRPcHRpb24oXG4gICAgICAgIHtcbiAgICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQuYXBwbGljYXRpb25zLmVuYWJsZWQnXG4gICAgICAgIH0sXG4gICAgICAgIGZhbHNlLFxuICAgICAgICBwYXJhbXNcbiAgICAgICksXG4gICAgICBvblVwZ3JhZGVBcHBzOiBhd2FpdCB0aGlzLmdldFRlbmFudE9wdGlvbihcbiAgICAgICAge1xuICAgICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5hcHBsaWNhdGlvbnMnXG4gICAgICAgIH0sXG4gICAgICAgIG51bGwsXG4gICAgICAgIHBhcmFtc1xuICAgICAgKSxcbiAgICAgIG9uVXBncmFkZU1pY3Jvc2VydmljZXNFbmFibGVkOiBhd2FpdCB0aGlzLmdldFRlbmFudE9wdGlvbihcbiAgICAgICAge1xuICAgICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5taWNyb3NlcnZpY2VzLmVuYWJsZWQnXG4gICAgICAgIH0sXG4gICAgICAgIGZhbHNlLFxuICAgICAgICBwYXJhbXNcbiAgICAgICksXG4gICAgICBvblVwZ3JhZGVNaWNyb3NlcnZpY2VzOiBhd2FpdCB0aGlzLmdldFRlbmFudE9wdGlvbihcbiAgICAgICAge1xuICAgICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5taWNyb3NlcnZpY2VzJ1xuICAgICAgICB9LFxuICAgICAgICBudWxsLFxuICAgICAgICBwYXJhbXNcbiAgICAgIClcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzYXZlT25DcmVhdGlvblN1YnNjcmlwdGlvbnMoZGVmYXVsdFN1YnNjcmlwdGlvbnM6IERlZmF1bHRTdWJzY3JpcHRpb25zKSB7XG4gICAgaWYgKGRlZmF1bHRTdWJzY3JpcHRpb25zLm92ZXJyaWRlT25DcmVhdGlvblN1YnNjcmlwdGlvbnMpIHtcbiAgICAgIGF3YWl0IHRoaXMuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnZGVmYXVsdC50ZW5hbnQuYXBwbGljYXRpb25zJyxcbiAgICAgICAgdmFsdWU6IHRoaXMucGFydGlhbEFwcHNMaXN0VG9BcHBzTmFtZXMoZGVmYXVsdFN1YnNjcmlwdGlvbnMub25DcmVhdGlvblN1YnNjcmlwdGlvbnMpXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHRoaXMuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnZGVmYXVsdC50ZW5hbnQubWljcm9zZXJ2aWNlcycsXG4gICAgICAgIHZhbHVlOiB0aGlzLnBhcnRpYWxBcHBzVG9NaWNyb3NlcnZpY2VzTmFtZXMoZGVmYXVsdFN1YnNjcmlwdGlvbnMub25DcmVhdGlvblN1YnNjcmlwdGlvbnMpXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy51bnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ2RlZmF1bHQudGVuYW50LmFwcGxpY2F0aW9ucydcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgdGhpcy51bnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ2RlZmF1bHQudGVuYW50Lm1pY3Jvc2VydmljZXMnXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNhdmVPblVwZ3JhZGVTdWJzY3JpcHRpb25zKGRlZmF1bHRTdWJzY3JpcHRpb25zOiBEZWZhdWx0U3Vic2NyaXB0aW9ucykge1xuICAgIGlmIChkZWZhdWx0U3Vic2NyaXB0aW9ucy5vdmVycmlkZU9uVXBncmFkZVN1YnNjcmlwdGlvbnMpIHtcbiAgICAgIGF3YWl0IHRoaXMuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5hcHBsaWNhdGlvbnMuZW5hYmxlZCcsXG4gICAgICAgIHZhbHVlOiAndHJ1ZSdcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgdGhpcy5zZXRUZW5hbnRPcHRpb24oe1xuICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICBrZXk6ICdvbi11cGRhdGUudGVuYW50Lm1pY3Jvc2VydmljZXMuZW5hYmxlZCcsXG4gICAgICAgIHZhbHVlOiAndHJ1ZSdcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgdGhpcy5zZXRUZW5hbnRPcHRpb24oe1xuICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICBrZXk6ICdvbi11cGRhdGUudGVuYW50LmFwcGxpY2F0aW9ucycsXG4gICAgICAgIHZhbHVlOiB0aGlzLnBhcnRpYWxBcHBzTGlzdFRvQXBwc05hbWVzKGRlZmF1bHRTdWJzY3JpcHRpb25zLm9uVXBncmFkZVN1YnNjcmlwdGlvbnMpXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHRoaXMuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5taWNyb3NlcnZpY2VzJyxcbiAgICAgICAgdmFsdWU6IHRoaXMucGFydGlhbEFwcHNUb01pY3Jvc2VydmljZXNOYW1lcyhkZWZhdWx0U3Vic2NyaXB0aW9ucy5vblVwZ3JhZGVTdWJzY3JpcHRpb25zKVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMudW5zZXRUZW5hbnRPcHRpb24oe1xuICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICBrZXk6ICdvbi11cGRhdGUudGVuYW50LmFwcGxpY2F0aW9ucy5lbmFibGVkJ1xuICAgICAgfSk7XG4gICAgICBhd2FpdCB0aGlzLnVuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5taWNyb3NlcnZpY2VzLmVuYWJsZWQnXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHRoaXMudW5zZXRUZW5hbnRPcHRpb24oe1xuICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICBrZXk6ICdvbi11cGRhdGUudGVuYW50LmFwcGxpY2F0aW9ucydcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgdGhpcy51bnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQubWljcm9zZXJ2aWNlcydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0VGVuYW50T3B0aW9uKG9wdGlvbjogSVN5c3RlbU9wdGlvbiwgZGVmYXVsdFZhbHVlID0gbnVsbCwgcGFyYW1zID0ge30pIHtcbiAgICBsZXQgdmFsdWU7XG4gICAgdHJ5IHtcbiAgICAgIHZhbHVlID0gKGF3YWl0IHRoaXMudGVuYW50T3B0aW9uc1NlcnZpY2UuZGV0YWlsKG9wdGlvbiwgcGFyYW1zKSkuZGF0YS52YWx1ZTtcbiAgICAgIHZhbHVlID0gSlNPTi5wYXJzZSh2YWx1ZSk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHZhbHVlID0gIWlzVW5kZWZpbmVkKHZhbHVlKSA/IHZhbHVlIDogZGVmYXVsdFZhbHVlO1xuICAgIH1cbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNldFRlbmFudE9wdGlvbihvcHRpb246IElTeXN0ZW1PcHRpb24pIHtcbiAgICByZXR1cm4gdGhpcy50ZW5hbnRPcHRpb25zU2VydmljZS51cGRhdGUob3B0aW9uKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdW5zZXRUZW5hbnRPcHRpb24ob3B0aW9uOiBJU3lzdGVtT3B0aW9uKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMudGVuYW50T3B0aW9uc1NlcnZpY2UuZGVsZXRlKG9wdGlvbik7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIGlmICghZXggfHwgIWV4LnJlcyB8fCBleC5yZXMuc3RhdHVzICE9PSA0MDQpIHtcbiAgICAgICAgdGhyb3cgZXg7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBuYW1lc1RvUGFydGlhbEFwcHMoe1xuICAgIGFwcHNOYW1lc1N0cixcbiAgICBtaWNyb3NlcnZpY2VzTmFtZXNTdHJcbiAgfToge1xuICAgIGFwcHNOYW1lc1N0cj86IHN0cmluZztcbiAgICBtaWNyb3NlcnZpY2VzTmFtZXNTdHI/OiBzdHJpbmc7XG4gIH0pOiBQYXJ0aWFsQXBwc0xpc3Qge1xuICAgIGlmIChhcHBzTmFtZXNTdHIgPT09IG51bGwgJiYgbWljcm9zZXJ2aWNlc05hbWVzU3RyID09PSBudWxsKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gW1xuICAgICAgLi4uKGFwcHNOYW1lc1N0ciB8fCAnJylcbiAgICAgICAgLnNwbGl0KCcsJylcbiAgICAgICAgLmZpbHRlcihuYW1lID0+IG5hbWUubGVuZ3RoKVxuICAgICAgICAubWFwKG5hbWUgPT4gKHsgbmFtZTogbmFtZS50cmltKCkgfSkpLFxuICAgICAgLi4uKG1pY3Jvc2VydmljZXNOYW1lc1N0ciB8fCAnJylcbiAgICAgICAgLnNwbGl0KCcsJylcbiAgICAgICAgLmZpbHRlcihuYW1lID0+IG5hbWUubGVuZ3RoKVxuICAgICAgICAubWFwKG5hbWUgPT4gKHtcbiAgICAgICAgICBuYW1lOiBuYW1lLnRyaW0oKSxcbiAgICAgICAgICB0eXBlOiBBcHBsaWNhdGlvblR5cGUuTUlDUk9TRVJWSUNFXG4gICAgICAgIH0pKVxuICAgIF07XG4gIH1cblxuICBwcml2YXRlIHBhcnRpYWxBcHBzTGlzdFRvQXBwc05hbWVzKGFwcHM6IFBhcnRpYWxBcHBzTGlzdCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGFwcHNcbiAgICAgIC5maWx0ZXIoYXBwID0+IGFwcC50eXBlICE9PSBBcHBsaWNhdGlvblR5cGUuTUlDUk9TRVJWSUNFKVxuICAgICAgLm1hcChhcHAgPT4gYXBwLm5hbWUpXG4gICAgICAuam9pbignLCcpO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJ0aWFsQXBwc1RvTWljcm9zZXJ2aWNlc05hbWVzKGFwcHM6IFBhcnRpYWxBcHBzTGlzdCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGFwcHNcbiAgICAgIC5maWx0ZXIoYXBwID0+IGFwcC50eXBlID09PSBBcHBsaWNhdGlvblR5cGUuTUlDUk9TRVJWSUNFKVxuICAgICAgLm1hcChhcHAgPT4gYXBwLm5hbWUpXG4gICAgICAuam9pbignLCcpO1xuICB9XG59XG4iXX0=