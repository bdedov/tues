import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { FormArray, FormBuilder, FormGroup } from '@angular/forms';
import { AlertService, gettext } from '@c8y/ngx-components';
import { DefaultSubscriptionsService } from './default-subscriptions.service';
/**
 * The component shows the main view for managing default subscriptions configuration.
 */
var DefaultSubscriptionsComponent = /** @class */ (function () {
    function DefaultSubscriptionsComponent(fb, defaultSubscriptionsService, alertService) {
        this.fb = fb;
        this.defaultSubscriptionsService = defaultSubscriptionsService;
        this.alertService = alertService;
    }
    /** Initializes the loading of the form and the current settings. */
    DefaultSubscriptionsComponent.prototype.ngOnInit = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.loading = true;
                        return [4 /*yield*/, this.initForm()];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.loadDefaultSubscriptions()];
                    case 2:
                        _a.sent();
                        this.loading = false;
                        return [2 /*return*/];
                }
            });
        });
    };
    /** Loads the list of apps, builds the form and hooks value change events for override switches. */
    DefaultSubscriptionsComponent.prototype.initForm = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var apps, appRows;
            var _this = this;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.form = this.fb.group({
                            overrideOnCreationSubscriptions: [''],
                            overrideOnUpgradeSubscriptions: [''],
                            appRows: this.fb.array([])
                        });
                        return [4 /*yield*/, this.defaultSubscriptionsService.getSubscribableTenantApps()];
                    case 1:
                        apps = _a.sent();
                        appRows = this.form.controls.appRows;
                        apps.forEach(function (app) {
                            appRows.push(_this.fb.group({
                                app: [app],
                                subscribedOnCreation: [''],
                                subscribedOnUpgrade: ['']
                            }));
                        });
                        this.form
                            .get('overrideOnCreationSubscriptions')
                            .valueChanges.subscribe(function (value) { return _this.onOverrideOnCreationSubscriptionsChange(value); });
                        this.form
                            .get('overrideOnUpgradeSubscriptions')
                            .valueChanges.subscribe(function (value) { return _this.onOverrideOnUpgradeSubscriptionsChange(value); });
                        return [2 /*return*/];
                }
            });
        });
    };
    /**
     * Checks if given application row should be displayed.
     * The row is displayed when any of its checkboxes is selected or any of the lists is being overridden.
     */
    DefaultSubscriptionsComponent.prototype.shouldShowAppRow = function (appRowRawValue) {
        var subscribedOnCreation = appRowRawValue.subscribedOnCreation, subscribedOnUpgrade = appRowRawValue.subscribedOnUpgrade;
        var _a = this.form.value, overrideOnCreationSubscriptions = _a.overrideOnCreationSubscriptions, overrideOnUpgradeSubscriptions = _a.overrideOnUpgradeSubscriptions;
        return (subscribedOnCreation ||
            subscribedOnUpgrade ||
            overrideOnCreationSubscriptions ||
            overrideOnUpgradeSubscriptions);
    };
    /** Checks if there are no application rows to be displayed. */
    DefaultSubscriptionsComponent.prototype.isEmptyView = function () {
        var _this = this;
        return !this.form
            .getRawValue()
            .appRows.some(function (appRowRawValue) { return _this.shouldShowAppRow(appRowRawValue); });
    };
    /**
     * Checks if given application is subscribed (present in the given list of applications).
     * @param app Application object to check.
     * @param subscribedApps The list of application objects to check against.
     * @returns True, if the application is present in the list.
     */
    DefaultSubscriptionsComponent.prototype.isSubscribed = function (app, subscribedApps) {
        return subscribedApps && subscribedApps.some(function (subscribedApp) { return subscribedApp.name === app.name; });
    };
    /** Saves the current value of form object to backend. */
    DefaultSubscriptionsComponent.prototype.save = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var defaultSubscriptions, ex_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        defaultSubscriptions = this.getDefaultSubscriptionsForSave();
                        return [4 /*yield*/, this.defaultSubscriptionsService.saveDefaultSubscriptionsToCurrentTenant(defaultSubscriptions)];
                    case 1:
                        _a.sent();
                        this.alertService.success(gettext('Saved.'));
                        return [3 /*break*/, 3];
                    case 2:
                        ex_1 = _a.sent();
                        this.alertService.addServerFailure(ex_1);
                        return [3 /*break*/, 3];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    DefaultSubscriptionsComponent.prototype.onOverrideOnCreationSubscriptionsChange = function (overrideOnCreationSubscriptions) {
        var appRowsControls = this.form.controls.appRows.controls;
        if (overrideOnCreationSubscriptions) {
            this.enableSubscribeOnCreationCheckboxes();
            return;
        }
        this.disableSubscribeOnCreationCheckboxes();
        this.restoreSubscribeOnCreationFromParent();
    };
    DefaultSubscriptionsComponent.prototype.enableSubscribeOnCreationCheckboxes = function () {
        var appRowsControls = this.form.controls.appRows.controls;
        appRowsControls.forEach(function (appRowControl) {
            appRowControl.get('subscribedOnCreation').enable({ emitEvent: false });
        });
    };
    DefaultSubscriptionsComponent.prototype.disableSubscribeOnCreationCheckboxes = function () {
        var appRowsControls = this.form.controls.appRows.controls;
        appRowsControls.forEach(function (appRowControl) {
            appRowControl.get('subscribedOnCreation').disable({ emitEvent: false });
        });
    };
    DefaultSubscriptionsComponent.prototype.restoreSubscribeOnCreationFromParent = function () {
        var _this = this;
        var appRowsControls = this.form.controls.appRows.controls;
        appRowsControls.forEach(function (appRowControl) {
            appRowControl.patchValue({
                subscribedOnCreation: _this.isSubscribed(appRowControl.value.app, _this.parentDefaultSubscriptions.onCreationSubscriptions)
            });
        });
    };
    DefaultSubscriptionsComponent.prototype.onOverrideOnUpgradeSubscriptionsChange = function (overrideOnUpgradeSubscriptions) {
        var appRowsControls = this.form.controls.appRows.controls;
        if (overrideOnUpgradeSubscriptions) {
            this.enableSubscribeOnUpgradeCheckboxes();
            return;
        }
        this.disableSubscribeOnUpgradeCheckboxes();
        this.restoreSubscribeOnUpgradeFromParent();
    };
    DefaultSubscriptionsComponent.prototype.enableSubscribeOnUpgradeCheckboxes = function () {
        var appRowsControls = this.form.controls.appRows.controls;
        appRowsControls.forEach(function (appRowControl) {
            appRowControl.get('subscribedOnUpgrade').enable({ emitEvent: false });
        });
    };
    DefaultSubscriptionsComponent.prototype.disableSubscribeOnUpgradeCheckboxes = function () {
        var appRowsControls = this.form.controls.appRows.controls;
        appRowsControls.forEach(function (appRowControl) {
            appRowControl.get('subscribedOnUpgrade').disable({ emitEvent: false });
        });
    };
    DefaultSubscriptionsComponent.prototype.restoreSubscribeOnUpgradeFromParent = function () {
        var _this = this;
        var appRowsControls = this.form.controls.appRows.controls;
        appRowsControls.forEach(function (appRowControl) {
            appRowControl.patchValue({
                subscribedOnUpgrade: _this.isSubscribed(appRowControl.value.app, _this.parentDefaultSubscriptions.onUpgradeSubscriptions)
            });
        });
    };
    DefaultSubscriptionsComponent.prototype.loadDefaultSubscriptions = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a, _b, _c, overrideOnCreationSubscriptions, overrideOnUpgradeSubscriptions, onCreationSubscriptions, onUpgradeSubscriptions;
            var _this = this;
            return tslib_1.__generator(this, function (_d) {
                switch (_d.label) {
                    case 0:
                        _a = this;
                        return [4 /*yield*/, this.defaultSubscriptionsService.getDefaultSubscriptionsEvaluatedFromParentTenant()];
                    case 1:
                        _a.parentDefaultSubscriptions = _d.sent();
                        _b = this;
                        return [4 /*yield*/, this.defaultSubscriptionsService.getDefaultSubscriptionsFromCurrentTenant()];
                    case 2:
                        _b.currentDefaultSubscriptions = _d.sent();
                        _c = this.currentDefaultSubscriptions, overrideOnCreationSubscriptions = _c.overrideOnCreationSubscriptions, overrideOnUpgradeSubscriptions = _c.overrideOnUpgradeSubscriptions;
                        onCreationSubscriptions = overrideOnCreationSubscriptions
                            ? this.currentDefaultSubscriptions.onCreationSubscriptions
                            : this.parentDefaultSubscriptions.onCreationSubscriptions;
                        onUpgradeSubscriptions = overrideOnUpgradeSubscriptions
                            ? this.currentDefaultSubscriptions.onUpgradeSubscriptions
                            : this.parentDefaultSubscriptions.onUpgradeSubscriptions;
                        this.form.patchValue({
                            overrideOnCreationSubscriptions: overrideOnCreationSubscriptions,
                            overrideOnUpgradeSubscriptions: overrideOnUpgradeSubscriptions
                        });
                        this.form.controls.appRows.controls.forEach(function (appRowControl) {
                            appRowControl.patchValue({
                                subscribedOnCreation: _this.isSubscribed(appRowControl.value.app, onCreationSubscriptions),
                                subscribedOnUpgrade: _this.isSubscribed(appRowControl.value.app, onUpgradeSubscriptions)
                            });
                        });
                        return [2 /*return*/];
                }
            });
        });
    };
    DefaultSubscriptionsComponent.prototype.getDefaultSubscriptionsForSave = function () {
        var value = this.form.value;
        return {
            overrideOnCreationSubscriptions: value.overrideOnCreationSubscriptions,
            onCreationSubscriptions: value.overrideOnCreationSubscriptions
                ? value.appRows.filter(function (app) { return app.subscribedOnCreation; }).map(function (app) { return app.app; })
                : null,
            overrideOnUpgradeSubscriptions: value.overrideOnUpgradeSubscriptions,
            onUpgradeSubscriptions: value.overrideOnUpgradeSubscriptions
                ? value.appRows.filter(function (app) { return app.subscribedOnUpgrade; }).map(function (app) { return app.app; })
                : null
        };
    };
    DefaultSubscriptionsComponent.ctorParameters = function () { return [
        { type: FormBuilder },
        { type: DefaultSubscriptionsService },
        { type: AlertService }
    ]; };
    DefaultSubscriptionsComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-default-subscriptions',
            template: "<c8y-title>{{ 'Default subscriptions' | translate }}</c8y-title>\n\n<form [formGroup]=\"form\" (ngSubmit)=\"save()\">\n  <div class=\"card card--fullpage\">\n    <div class=\"card-header separator\">\n      <h4 class=\"card-title\" translate>Default subscriptions</h4>\n    </div>\n    <div class=\"inner-scroll\">\n      <div class=\"card--grid grid__col--2-8-2--md grid__col--3-6-3\">\n        <div class=\"card-block large-padding bg-gray-white sticky-top separator-bottom p-b-0\">\n          <p><strong translate>Applications subscribed to a tenant on creation</strong></p>\n          <div class=\"text-center\">\n            <label class=\"c8y-switch\">\n              <input type=\"checkbox\" formControlName=\"overrideOnCreationSubscriptions\" />\n              <span></span> {{ 'Override inherited' | translate }}\n            </label>\n          </div>\n        </div>\n        <div class=\"card-block bg-white sticky-top separator-bottom\">\n          <p><b translate>Applications</b></p>\n          <p translate>\n            Configure default subscriptions in the platform, both for tenant creation\n            and for platform upgrade. To display a full list of available applications, override\n            inherited settings.\n          </p>\n        </div>\n        <div class=\"card-block large-padding bg-gray-white sticky-top separator-bottom p-b-0\">\n          <p><strong translate>Applications subscribed to a tenant on platform upgrade</strong></p>\n          <div class=\"text-center\">\n            <label class=\"c8y-switch\">\n              <input type=\"checkbox\" formControlName=\"overrideOnUpgradeSubscriptions\" />\n              <span></span> {{ 'Override inherited' | translate }}\n            </label>\n          </div>\n        </div>\n        <div class=\"card-block bg-gray-white\" *ngIf=\"loading\"></div>\n        <div class=\"card-block bg-white\" *ngIf=\"loading\">\n          <div class=\"p-r-48 p-b-24 d-inline-block\" style=\"position:relative;\">\n            <div class=\"spinner\">\n              <div class=\"rect1\"></div>\n              <div class=\"rect2\"></div>\n              <div class=\"rect3\"></div>\n              <div class=\"rect4\"></div>\n              <div class=\"rect5\"></div>\n            </div>\n          </div>\n          <span translate>Loading application subscriptions\u2026</span>\n        </div>\n        <div class=\"card-block bg-gray-white\" *ngIf=\"loading\"></div>\n        <ng-container formArrayName=\"appRows\" class=\"d-contents\">\n          <div class=\"bg-gray-white\" *ngIf=\"!loading && isEmptyView()\"></div>\n          <div class=\"card-block bg-white\" *ngIf=\"!loading && isEmptyView()\">\n            <div class=\"c8y-empty-state\">\n              <h1 class=\"c8y-icon c8y-icon-c8y-data c8y-icon-duocolor\"></h1>\n              <h3 translate>No application subscriptions yet.</h3>\n              <p translate>\n                Select \"Override inherited\" to define the list of subscribed applications.\n              </p>\n            </div>\n          </div>\n          <div class=\"bg-gray-white\" *ngIf=\"!loading && isEmptyView()\"></div>\n\n          <div\n            *ngFor=\"let appRowControl of form.get('appRows')['controls']; let i = index\"\n            class=\"d-contents\"\n          >\n            <ng-container\n              *ngIf=\"shouldShowAppRow(appRowControl.getRawValue())\"\n              formArrayName=\"{{ i }}\"\n              class=\"d-contents\"\n            >\n              <div class=\"c8y-list__item d-flex d-col bg-gray-white text-center\">\n                <div class=\"flex-item-middle\">\n                  <label\n                    class=\"c8y-checkbox d-inline-block\"\n                    [ngClass]=\"{ disabled: appRowControl.controls.subscribedOnCreation.disabled }\"\n                  >\n                    <input type=\"checkbox\" formControlName=\"subscribedOnCreation\" />\n                    <span></span>\n                  </label>\n                </div>\n              </div>\n\n              <div class=\"c8y-list__item bg-white\">\n                <div class=\"c8y-list__item__block\">\n                  <div class=\"c8y-list__item__appicon\">\n                    <c8y-app-icon\n                      [app]=\"appRowControl.value.app\"\n                      [name]=\"appRowControl.value.app.name\"\n                      [contextPath]=\"appRowControl.value.app.contextPath\"\n                    ></c8y-app-icon>\n                  </div>\n                  <div class=\"c8y-list__item__body\">\n                    <div class=\"content-flex-50\">\n                      <div class=\"col-6\">\n                        <p\n                          class=\"text-truncate\"\n                          title=\"{{ appRowControl.value.app | humanizeAppName | async }}\"\n                        >\n                          {{ appRowControl.value.app | humanizeAppName | async }}\n                        </p>\n                        <small class=\"text-muted\">{{ appRowControl.value.app.contextPath }}</small>\n                      </div>\n                      <div class=\"col-6\">\n                        <p>\n                          <span class=\"text-label-small m-r-4\" translate>Tenant ID</span> \n                          {{ appRowControl.value.app.owner.tenant.id }}\n                        </p>\n                        <!-- TODO: uncomment when company name is available\n                          <p>\n                          <span class=\"text-label-small m-r-4\" translate>Company</span>\n                          <small class=\"text-muted\">company name</small>\n                        </p> -->\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n              <div class=\"c8y-list__item d-flex d-col bg-gray-white text-center\">\n                <div class=\"flex-item-middle\">\n                  <label\n                    class=\"c8y-checkbox d-inline-block\"\n                    [ngClass]=\"{ disabled: appRowControl.controls.subscribedOnUpgrade.disabled }\"\n                  >\n                    <input type=\"checkbox\" formControlName=\"subscribedOnUpgrade\" />\n                    <span></span>\n                  </label>\n                </div>\n              </div>\n            </ng-container>\n          </div>\n        </ng-container>\n      </div>\n    </div>\n    <div class=\"card-footer separator\">\n      <button\n        type=\"submit\"\n        class=\"btn btn-primary\"\n        [disabled]=\"form.invalid || form.pristine\"\n        title=\"{{ 'Save default subscriptions' | translate }}\"\n      >\n        {{ 'Save' | translate }}\n      </button>\n    </div>\n  </div>\n</form>\n"
        })
    ], DefaultSubscriptionsComponent);
    return DefaultSubscriptionsComponent;
}());
export { DefaultSubscriptionsComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1zdWJzY3JpcHRpb25zLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvZGVmYXVsdC1zdWJzY3JpcHRpb25zLyIsInNvdXJjZXMiOlsiZGVmYXVsdC1zdWJzY3JpcHRpb25zLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxQyxPQUFPLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVuRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRTVELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBRTlFOztHQUVHO0FBS0g7SUFVRSx1Q0FDVSxFQUFlLEVBQ2YsMkJBQXdELEVBQ3hELFlBQTBCO1FBRjFCLE9BQUUsR0FBRixFQUFFLENBQWE7UUFDZixnQ0FBMkIsR0FBM0IsMkJBQTJCLENBQTZCO1FBQ3hELGlCQUFZLEdBQVosWUFBWSxDQUFjO0lBQ2pDLENBQUM7SUFFSixvRUFBb0U7SUFDOUQsZ0RBQVEsR0FBZDs7Ozs7d0JBQ0UsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7d0JBQ3BCLHFCQUFNLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBQTs7d0JBQXJCLFNBQXFCLENBQUM7d0JBQ3RCLHFCQUFNLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxFQUFBOzt3QkFBckMsU0FBcUMsQ0FBQzt3QkFDdEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7Ozs7O0tBQ3RCO0lBRUQsbUdBQW1HO0lBQzdGLGdEQUFRLEdBQWQ7Ozs7Ozs7d0JBQ0UsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQzs0QkFDeEIsK0JBQStCLEVBQUUsQ0FBQyxFQUFFLENB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QUFRLEVBQUUsMkJBQTJCO1lBQ3JDLG1vTkFBcUQ7U0FDdEQsQ0FBQztPQUNXLDZCQUE2QixDQW1OekM7SUFBRCxvQ0FBQztDQUFBLEFBbk5ELElBbU5DO1NBbk5ZLDZCQUE2QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm9ybUFycmF5LCBGb3JtQnVpbGRlciwgRm9ybUdyb3VwIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgSUFwcGxpY2F0aW9uIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlLCBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBEZWZhdWx0U3Vic2NyaXB0aW9ucywgUGFydGlhbEFwcHNMaXN0IH0gZnJvbSAnLi9kZWZhdWx0LXN1YnNjcmlwdGlvbnMubW9kZWwnO1xuaW1wb3J0IHsgRGVmYXVsdFN1YnNjcmlwdGlvbnNTZXJ2aWNlIH0gZnJvbSAnLi9kZWZhdWx0LXN1YnNjcmlwdGlvbnMuc2VydmljZSc7XG5cbi8qKlxuICogVGhlIGNvbXBvbmVudCBzaG93cyB0aGUgbWFpbiB2aWV3IGZvciBtYW5hZ2luZyBkZWZhdWx0IHN1YnNjcmlwdGlvbnMgY29uZmlndXJhdGlvbi5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWRlZmF1bHQtc3Vic2NyaXB0aW9ucycsXG4gIHRlbXBsYXRlVXJsOiAnLi9kZWZhdWx0LXN1YnNjcmlwdGlvbnMuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIERlZmF1bHRTdWJzY3JpcHRpb25zQ29tcG9uZW50IHtcbiAgLyoqIERlZmF1bHQgc3Vic2NyaXB0aW9ucyBpbmhlcml0ZWQgZnJvbSBwYXJlbnQgdGVuYW50LiAqL1xuICBwYXJlbnREZWZhdWx0U3Vic2NyaXB0aW9uczogRGVmYXVsdFN1YnNjcmlwdGlvbnM7XG4gIC8qKiBEZWZhdWx0IHN1YnNjcmlwdGlvbnMgZGVmaW5lZCBpbiB0aGUgY3VycmVudCB0ZW5hbnQuICovXG4gIGN1cnJlbnREZWZhdWx0U3Vic2NyaXB0aW9uczogRGVmYXVsdFN1YnNjcmlwdGlvbnM7XG4gIC8qKiBGb3JtIG9iamVjdC4gKi9cbiAgZm9ybTogRm9ybUdyb3VwO1xuICAvKiogV2hldGhlciB0aGUgY29uZmlndXJhdGlvbiBpcyBiZWluZyBsb2FkZWQuICovXG4gIGxvYWRpbmc6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBmYjogRm9ybUJ1aWxkZXIsXG4gICAgcHJpdmF0ZSBkZWZhdWx0U3Vic2NyaXB0aW9uc1NlcnZpY2U6IERlZmF1bHRTdWJzY3JpcHRpb25zU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlXG4gICkge31cblxuICAvKiogSW5pdGlhbGl6ZXMgdGhlIGxvYWRpbmcgb2YgdGhlIGZvcm0gYW5kIHRoZSBjdXJyZW50IHNldHRpbmdzLiAqL1xuICBhc3luYyBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmxvYWRpbmcgPSB0cnVlO1xuICAgIGF3YWl0IHRoaXMuaW5pdEZvcm0oKTtcbiAgICBhd2FpdCB0aGlzLmxvYWREZWZhdWx0U3Vic2NyaXB0aW9ucygpO1xuICAgIHRoaXMubG9hZGluZyA9IGZhbHNlO1xuICB9XG5cbiAgLyoqIExvYWRzIHRoZSBsaXN0IG9mIGFwcHMsIGJ1aWxkcyB0aGUgZm9ybSBhbmQgaG9va3MgdmFsdWUgY2hhbmdlIGV2ZW50cyBmb3Igb3ZlcnJpZGUgc3dpdGNoZXMuICovXG4gIGFzeW5jIGluaXRGb3JtKCkge1xuICAgIHRoaXMuZm9ybSA9IHRoaXMuZmIuZ3JvdXAoe1xuICAgICAgb3ZlcnJpZGVPbkNyZWF0aW9uU3Vic2NyaXB0aW9uczogWycnXSxcbiAgICAgIG92ZXJyaWRlT25VcGdyYWRlU3Vic2NyaXB0aW9uczogWycnXSxcbiAgICAgIGFwcFJvd3M6IHRoaXMuZmIuYXJyYXkoW10pXG4gICAgfSk7XG5cbiAgICBjb25zdCBhcHBzID0gYXdhaXQgdGhpcy5kZWZhdWx0U3Vic2NyaXB0aW9uc1NlcnZpY2UuZ2V0U3Vic2NyaWJhYmxlVGVuYW50QXBwcygpO1xuICAgIGNvbnN0IGFwcFJvd3MgPSB0aGlzLmZvcm0uY29udHJvbHMuYXBwUm93cyBhcyBGb3JtQXJyYXk7XG4gICAgYXBwcy5mb3JFYWNoKGFwcCA9PiB7XG4gICAgICBhcHBSb3dzLnB1c2goXG4gICAgICAgIHRoaXMuZmIuZ3JvdXAoe1xuICAgICAgICAgIGFwcDogW2FwcF0sXG4gICAgICAgICAgc3Vic2NyaWJlZE9uQ3JlYXRpb246IFsnJ10sXG4gICAgICAgICAgc3Vic2NyaWJlZE9uVXBncmFkZTogWycnXVxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIHRoaXMuZm9ybVxuICAgICAgLmdldCgnb3ZlcnJpZGVPbkNyZWF0aW9uU3Vic2NyaXB0aW9ucycpXG4gICAgICAudmFsdWVDaGFuZ2VzLnN1YnNjcmliZSh2YWx1ZSA9PiB0aGlzLm9uT3ZlcnJpZGVPbkNyZWF0aW9uU3Vic2NyaXB0aW9uc0NoYW5nZSh2YWx1ZSkpO1xuXG4gICAgdGhpcy5mb3JtXG4gICAgICAuZ2V0KCdvdmVycmlkZU9uVXBncmFkZVN1YnNjcmlwdGlvbnMnKVxuICAgICAgLnZhbHVlQ2hhbmdlcy5zdWJzY3JpYmUodmFsdWUgPT4gdGhpcy5vbk92ZXJyaWRlT25VcGdyYWRlU3Vic2NyaXB0aW9uc0NoYW5nZSh2YWx1ZSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrcyBpZiBnaXZlbiBhcHBsaWNhdGlvbiByb3cgc2hvdWxkIGJlIGRpc3BsYXllZC5cbiAgICogVGhlIHJvdyBpcyBkaXNwbGF5ZWQgd2hlbiBhbnkgb2YgaXRzIGNoZWNrYm94ZXMgaXMgc2VsZWN0ZWQgb3IgYW55IG9mIHRoZSBsaXN0cyBpcyBiZWluZyBvdmVycmlkZGVuLlxuICAgKi9cbiAgc2hvdWxkU2hvd0FwcFJvdyhhcHBSb3dSYXdWYWx1ZSk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHsgc3Vic2NyaWJlZE9uQ3JlYXRpb24sIHN1YnNjcmliZWRPblVwZ3JhZGUgfSA9IGFwcFJvd1Jhd1ZhbHVlO1xuICAgIGNvbnN0IHsgb3ZlcnJpZGVPbkNyZWF0aW9uU3Vic2NyaXB0aW9ucywgb3ZlcnJpZGVPblVwZ3JhZGVTdWJzY3JpcHRpb25zIH0gPSB0aGlzLmZvcm0udmFsdWU7XG5cbiAgICByZXR1cm4gKFxuICAgICAgc3Vic2NyaWJlZE9uQ3JlYXRpb24gfHxcbiAgICAgIHN1YnNjcmliZWRPblVwZ3JhZGUgfHxcbiAgICAgIG92ZXJyaWRlT25DcmVhdGlvblN1YnNjcmlwdGlvbnMgfHxcbiAgICAgIG92ZXJyaWRlT25VcGdyYWRlU3Vic2NyaXB0aW9uc1xuICAgICk7XG4gIH1cblxuICAvKiogQ2hlY2tzIGlmIHRoZXJlIGFyZSBubyBhcHBsaWNhdGlvbiByb3dzIHRvIGJlIGRpc3BsYXllZC4gKi9cbiAgaXNFbXB0eVZpZXcoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICF0aGlzLmZvcm1cbiAgICAgIC5nZXRSYXdWYWx1ZSgpXG4gICAgICAuYXBwUm93cy5zb21lKGFwcFJvd1Jhd1ZhbHVlID0+IHRoaXMuc2hvdWxkU2hvd0FwcFJvdyhhcHBSb3dSYXdWYWx1ZSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrcyBpZiBnaXZlbiBhcHBsaWNhdGlvbiBpcyBzdWJzY3JpYmVkIChwcmVzZW50IGluIHRoZSBnaXZlbiBsaXN0IG9mIGFwcGxpY2F0aW9ucykuXG4gICAqIEBwYXJhbSBhcHAgQXBwbGljYXRpb24gb2JqZWN0IHRvIGNoZWNrLlxuICAgKiBAcGFyYW0gc3Vic2NyaWJlZEFwcHMgVGhlIGxpc3Qgb2YgYXBwbGljYXRpb24gb2JqZWN0cyB0byBjaGVjayBhZ2FpbnN0LlxuICAgKiBAcmV0dXJucyBUcnVlLCBpZiB0aGUgYXBwbGljYXRpb24gaXMgcHJlc2VudCBpbiB0aGUgbGlzdC5cbiAgICovXG4gIGlzU3Vic2NyaWJlZChhcHA6IElBcHBsaWNhdGlvbiwgc3Vic2NyaWJlZEFwcHM6IFBhcnRpYWxBcHBzTGlzdCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBzdWJzY3JpYmVkQXBwcyAmJiBzdWJzY3JpYmVkQXBwcy5zb21lKHN1YnNjcmliZWRBcHAgPT4gc3Vic2NyaWJlZEFwcC5uYW1lID09PSBhcHAubmFtZSk7XG4gIH1cblxuICAvKiogU2F2ZXMgdGhlIGN1cnJlbnQgdmFsdWUgb2YgZm9ybSBvYmplY3QgdG8gYmFja2VuZC4gKi9cbiAgYXN5bmMgc2F2ZSgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGVmYXVsdFN1YnNjcmlwdGlvbnMgPSB0aGlzLmdldERlZmF1bHRTdWJzY3JpcHRpb25zRm9yU2F2ZSgpO1xuICAgICAgYXdhaXQgdGhpcy5kZWZhdWx0U3Vic2NyaXB0aW9uc1NlcnZpY2Uuc2F2ZURlZmF1bHRTdWJzY3JpcHRpb25zVG9DdXJyZW50VGVuYW50KFxuICAgICAgICBkZWZhdWx0U3Vic2NyaXB0aW9uc1xuICAgICAgKTtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnN1Y2Nlc3MoZ2V0dGV4dCgnU2F2ZWQuJykpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGV4KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uT3ZlcnJpZGVPbkNyZWF0aW9uU3Vic2NyaXB0aW9uc0NoYW5nZShvdmVycmlkZU9uQ3JlYXRpb25TdWJzY3JpcHRpb25zOiBib29sZWFuKSB7XG4gICAgY29uc3QgYXBwUm93c0NvbnRyb2xzID0gKHRoaXMuZm9ybS5jb250cm9scy5hcHBSb3dzIGFzIEZvcm1BcnJheSkuY29udHJvbHM7XG4gICAgaWYgKG92ZXJyaWRlT25DcmVhdGlvblN1YnNjcmlwdGlvbnMpIHtcbiAgICAgIHRoaXMuZW5hYmxlU3Vic2NyaWJlT25DcmVhdGlvbkNoZWNrYm94ZXMoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5kaXNhYmxlU3Vic2NyaWJlT25DcmVhdGlvbkNoZWNrYm94ZXMoKTtcbiAgICB0aGlzLnJlc3RvcmVTdWJzY3JpYmVPbkNyZWF0aW9uRnJvbVBhcmVudCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBlbmFibGVTdWJzY3JpYmVPbkNyZWF0aW9uQ2hlY2tib3hlcygpIHtcbiAgICBjb25zdCBhcHBSb3dzQ29udHJvbHMgPSAodGhpcy5mb3JtLmNvbnRyb2xzLmFwcFJvd3MgYXMgRm9ybUFycmF5KS5jb250cm9scztcbiAgICBhcHBSb3dzQ29udHJvbHMuZm9yRWFjaChhcHBSb3dDb250cm9sID0+IHtcbiAgICAgIGFwcFJvd0NvbnRyb2wuZ2V0KCdzdWJzY3JpYmVkT25DcmVhdGlvbicpLmVuYWJsZSh7IGVtaXRFdmVudDogZmFsc2UgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGRpc2FibGVTdWJzY3JpYmVPbkNyZWF0aW9uQ2hlY2tib3hlcygpIHtcbiAgICBjb25zdCBhcHBSb3dzQ29udHJvbHMgPSAodGhpcy5mb3JtLmNvbnRyb2xzLmFwcFJvd3MgYXMgRm9ybUFycmF5KS5jb250cm9scztcbiAgICBhcHBSb3dzQ29udHJvbHMuZm9yRWFjaChhcHBSb3dDb250cm9sID0+IHtcbiAgICAgIGFwcFJvd0NvbnRyb2wuZ2V0KCdzdWJzY3JpYmVkT25DcmVhdGlvbicpLmRpc2FibGUoeyBlbWl0RXZlbnQ6IGZhbHNlIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSByZXN0b3JlU3Vic2NyaWJlT25DcmVhdGlvbkZyb21QYXJlbnQoKSB7XG4gICAgY29uc3QgYXBwUm93c0NvbnRyb2xzID0gKHRoaXMuZm9ybS5jb250cm9scy5hcHBSb3dzIGFzIEZvcm1BcnJheSkuY29udHJvbHM7XG4gICAgYXBwUm93c0NvbnRyb2xzLmZvckVhY2goYXBwUm93Q29udHJvbCA9PiB7XG4gICAgICBhcHBSb3dDb250cm9sLnBhdGNoVmFsdWUoe1xuICAgICAgICBzdWJzY3JpYmVkT25DcmVhdGlvbjogdGhpcy5pc1N1YnNjcmliZWQoXG4gICAgICAgICAgYXBwUm93Q29udHJvbC52YWx1ZS5hcHAsXG4gICAgICAgICAgdGhpcy5wYXJlbnREZWZhdWx0U3Vic2NyaXB0aW9ucy5vbkNyZWF0aW9uU3Vic2NyaXB0aW9uc1xuICAgICAgICApXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgb25PdmVycmlkZU9uVXBncmFkZVN1YnNjcmlwdGlvbnNDaGFuZ2Uob3ZlcnJpZGVPblVwZ3JhZGVTdWJzY3JpcHRpb25zOiBib29sZWFuKSB7XG4gICAgY29uc3QgYXBwUm93c0NvbnRyb2xzID0gKHRoaXMuZm9ybS5jb250cm9scy5hcHBSb3dzIGFzIEZvcm1BcnJheSkuY29udHJvbHM7XG4gICAgaWYgKG92ZXJyaWRlT25VcGdyYWRlU3Vic2NyaXB0aW9ucykge1xuICAgICAgdGhpcy5lbmFibGVTdWJzY3JpYmVPblVwZ3JhZGVDaGVja2JveGVzKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuZGlzYWJsZVN1YnNjcmliZU9uVXBncmFkZUNoZWNrYm94ZXMoKTtcbiAgICB0aGlzLnJlc3RvcmVTdWJzY3JpYmVPblVwZ3JhZGVGcm9tUGFyZW50KCk7XG4gIH1cblxuICBwcml2YXRlIGVuYWJsZVN1YnNjcmliZU9uVXBncmFkZUNoZWNrYm94ZXMoKSB7XG4gICAgY29uc3QgYXBwUm93c0NvbnRyb2xzID0gKHRoaXMuZm9ybS5jb250cm9scy5hcHBSb3dzIGFzIEZvcm1BcnJheSkuY29udHJvbHM7XG4gICAgYXBwUm93c0NvbnRyb2xzLmZvckVhY2goYXBwUm93Q29udHJvbCA9PiB7XG4gICAgICBhcHBSb3dDb250cm9sLmdldCgnc3Vic2NyaWJlZE9uVXBncmFkZScpLmVuYWJsZSh7IGVtaXRFdmVudDogZmFsc2UgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGRpc2FibGVTdWJzY3JpYmVPblVwZ3JhZGVDaGVja2JveGVzKCkge1xuICAgIGNvbnN0IGFwcFJvd3NDb250cm9scyA9ICh0aGlzLmZvcm0uY29udHJvbHMuYXBwUm93cyBhcyBGb3JtQXJyYXkpLmNvbnRyb2xzO1xuICAgIGFwcFJvd3NDb250cm9scy5mb3JFYWNoKGFwcFJvd0NvbnRyb2wgPT4ge1xuICAgICAgYXBwUm93Q29udHJvbC5nZXQoJ3N1YnNjcmliZWRPblVwZ3JhZGUnKS5kaXNhYmxlKHsgZW1pdEV2ZW50OiBmYWxzZSB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcmVzdG9yZVN1YnNjcmliZU9uVXBncmFkZUZyb21QYXJlbnQoKSB7XG4gICAgY29uc3QgYXBwUm93c0NvbnRyb2xzID0gKHRoaXMuZm9ybS5jb250cm9scy5hcHBSb3dzIGFzIEZvcm1BcnJheSkuY29udHJvbHM7XG4gICAgYXBwUm93c0NvbnRyb2xzLmZvckVhY2goYXBwUm93Q29udHJvbCA9PiB7XG4gICAgICBhcHBSb3dDb250cm9sLnBhdGNoVmFsdWUoe1xuICAgICAgICBzdWJzY3JpYmVkT25VcGdyYWRlOiB0aGlzLmlzU3Vic2NyaWJlZChcbiAgICAgICAgICBhcHBSb3dDb250cm9sLnZhbHVlLmFwcCxcbiAgICAgICAgICB0aGlzLnBhcmVudERlZmF1bHRTdWJzY3JpcHRpb25zLm9uVXBncmFkZVN1YnNjcmlwdGlvbnNcbiAgICAgICAgKVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGxvYWREZWZhdWx0U3Vic2NyaXB0aW9ucygpIHtcbiAgICB0aGlzLnBhcmVudERlZmF1bHRTdWJzY3JpcHRpb25zID0gYXdhaXQgdGhpcy5kZWZhdWx0U3Vic2NyaXB0aW9uc1NlcnZpY2UuZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbnNFdmFsdWF0ZWRGcm9tUGFyZW50VGVuYW50KCk7XG4gICAgdGhpcy5jdXJyZW50RGVmYXVsdFN1YnNjcmlwdGlvbnMgPSBhd2FpdCB0aGlzLmRlZmF1bHRTdWJzY3JpcHRpb25zU2VydmljZS5nZXREZWZhdWx0U3Vic2NyaXB0aW9uc0Zyb21DdXJyZW50VGVuYW50KCk7XG5cbiAgICBjb25zdCB7XG4gICAgICBvdmVycmlkZU9uQ3JlYXRpb25TdWJzY3JpcHRpb25zLFxuICAgICAgb3ZlcnJpZGVPblVwZ3JhZGVTdWJzY3JpcHRpb25zXG4gICAgfSA9IHRoaXMuY3VycmVudERlZmF1bHRTdWJzY3JpcHRpb25zO1xuICAgIGNvbnN0IG9uQ3JlYXRpb25TdWJzY3JpcHRpb25zID0gb3ZlcnJpZGVPbkNyZWF0aW9uU3Vic2NyaXB0aW9uc1xuICAgICAgPyB0aGlzLmN1cnJlbnREZWZhdWx0U3Vic2NyaXB0aW9ucy5vbkNyZWF0aW9uU3Vic2NyaXB0aW9uc1xuICAgICAgOiB0aGlzLnBhcmVudERlZmF1bHRTdWJzY3JpcHRpb25zLm9uQ3JlYXRpb25TdWJzY3JpcHRpb25zO1xuICAgIGNvbnN0IG9uVXBncmFkZVN1YnNjcmlwdGlvbnMgPSBvdmVycmlkZU9uVXBncmFkZVN1YnNjcmlwdGlvbnNcbiAgICAgID8gdGhpcy5jdXJyZW50RGVmYXVsdFN1YnNjcmlwdGlvbnMub25VcGdyYWRlU3Vic2NyaXB0aW9uc1xuICAgICAgOiB0aGlzLnBhcmVudERlZmF1bHRTdWJzY3JpcHRpb25zLm9uVXBncmFkZVN1YnNjcmlwdGlvbnM7XG5cbiAgICB0aGlzLmZvcm0ucGF0Y2hWYWx1ZSh7XG4gICAgICBvdmVycmlkZU9uQ3JlYXRpb25TdWJzY3JpcHRpb25zLFxuICAgICAgb3ZlcnJpZGVPblVwZ3JhZGVTdWJzY3JpcHRpb25zXG4gICAgfSk7XG4gICAgKHRoaXMuZm9ybS5jb250cm9scy5hcHBSb3dzIGFzIEZvcm1BcnJheSkuY29udHJvbHMuZm9yRWFjaChhcHBSb3dDb250cm9sID0+IHtcbiAgICAgIGFwcFJvd0NvbnRyb2wucGF0Y2hWYWx1ZSh7XG4gICAgICAgIHN1YnNjcmliZWRPbkNyZWF0aW9uOiB0aGlzLmlzU3Vic2NyaWJlZChhcHBSb3dDb250cm9sLnZhbHVlLmFwcCwgb25DcmVhdGlvblN1YnNjcmlwdGlvbnMpLFxuICAgICAgICBzdWJzY3JpYmVkT25VcGdyYWRlOiB0aGlzLmlzU3Vic2NyaWJlZChhcHBSb3dDb250cm9sLnZhbHVlLmFwcCwgb25VcGdyYWRlU3Vic2NyaXB0aW9ucylcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREZWZhdWx0U3Vic2NyaXB0aW9uc0ZvclNhdmUoKTogRGVmYXVsdFN1YnNjcmlwdGlvbnMge1xuICAgIGNvbnN0IHsgdmFsdWUgfSA9IHRoaXMuZm9ybTtcbiAgICByZXR1cm4ge1xuICAgICAgb3ZlcnJpZGVPbkNyZWF0aW9uU3Vic2NyaXB0aW9uczogdmFsdWUub3ZlcnJpZGVPbkNyZWF0aW9uU3Vic2NyaXB0aW9ucyxcbiAgICAgIG9uQ3JlYXRpb25TdWJzY3JpcHRpb25zOiB2YWx1ZS5vdmVycmlkZU9uQ3JlYXRpb25TdWJzY3JpcHRpb25zXG4gICAgICAgID8gdmFsdWUuYXBwUm93cy5maWx0ZXIoYXBwID0+IGFwcC5zdWJzY3JpYmVkT25DcmVhdGlvbikubWFwKGFwcCA9PiBhcHAuYXBwKVxuICAgICAgICA6IG51bGwsXG4gICAgICBvdmVycmlkZU9uVXBncmFkZVN1YnNjcmlwdGlvbnM6IHZhbHVlLm92ZXJyaWRlT25VcGdyYWRlU3Vic2NyaXB0aW9ucyxcbiAgICAgIG9uVXBncmFkZVN1YnNjcmlwdGlvbnM6IHZhbHVlLm92ZXJyaWRlT25VcGdyYWRlU3Vic2NyaXB0aW9uc1xuICAgICAgICA/IHZhbHVlLmFwcFJvd3MuZmlsdGVyKGFwcCA9PiBhcHAuc3Vic2NyaWJlZE9uVXBncmFkZSkubWFwKGFwcCA9PiBhcHAuYXBwKVxuICAgICAgICA6IG51bGxcbiAgICB9O1xuICB9XG59XG4iXX0=