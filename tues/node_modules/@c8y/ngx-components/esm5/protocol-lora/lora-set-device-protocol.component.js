import * as tslib_1 from "tslib";
import { Component, ViewChild } from '@angular/core';
import { LoraSetDeviceProtocolService } from './lora-set-device-protocol.service';
import { AlertService, gettext } from '@c8y/ngx-components';
import { IManagedObject, InventoryService, IResultList } from '@c8y/client';
import { Router } from '@angular/router';
import { pipe } from 'rxjs';
import { map } from 'rxjs/operators';
var LoraAssignDeviceProtocolComponent = /** @class */ (function () {
    function LoraAssignDeviceProtocolComponent(loraService, alertService, router, inventoryService) {
        var _this = this;
        this.loraService = loraService;
        this.alertService = alertService;
        this.router = router;
        this.inventoryService = inventoryService;
        this.filterCurrentProtocol = pipe(map(function (protocols) {
            return protocols.filter(function (protocol) { return !_this.currentProtocol || _this.currentProtocol.id !== protocol.id; });
        }));
    }
    LoraAssignDeviceProtocolComponent.prototype.ngOnInit = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.reload()];
                    case 1:
                        _a.sent();
                        return [2 /*return*/];
                }
            });
        });
    };
    LoraAssignDeviceProtocolComponent.prototype.reload = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var _a, _b, ex_1;
            return tslib_1.__generator(this, function (_c) {
                switch (_c.label) {
                    case 0:
                        this.loading = true;
                        this.newProtocol = null;
                        _c.label = 1;
                    case 1:
                        _c.trys.push([1, 5, 6, 7]);
                        return [4 /*yield*/, this.loadDevice()];
                    case 2:
                        _c.sent();
                        _a = this;
                        return [4 /*yield*/, this.loraService.getAvailableProtocols()];
                    case 3:
                        _a.availableProtocols = _c.sent();
                        _b = this;
                        return [4 /*yield*/, this.loraService.getCurrentProtocol(this.device)];
                    case 4:
                        _b.currentProtocol = _c.sent();
                        return [3 /*break*/, 7];
                    case 5:
                        ex_1 = _c.sent();
                        this.alertService.addServerFailure(ex_1);
                        return [3 /*break*/, 7];
                    case 6:
                        this.loading = false;
                        return [7 /*endfinally*/];
                    case 7: return [2 /*return*/];
                }
            });
        });
    };
    LoraAssignDeviceProtocolComponent.prototype.loadDevice = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var deviceId, data;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        deviceId = this.router.routerState.snapshot.url.match(/\d+/)[0];
                        return [4 /*yield*/, this.inventoryService.detail(deviceId)];
                    case 1:
                        data = (_a.sent()).data;
                        this.device = data;
                        return [2 /*return*/];
                }
            });
        });
    };
    LoraAssignDeviceProtocolComponent.prototype.apply = function (selectedProtocol) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var ex_2;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 3, , 4]);
                        return [4 /*yield*/, this.loraService.applyProtocol(this.device, selectedProtocol)];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.reload()];
                    case 2:
                        _a.sent();
                        this.alertService.success(gettext('Device protocol set.'));
                        this.loraSetDeviceProtocolForm.reset('dirty');
                        return [3 /*break*/, 4];
                    case 3:
                        ex_2 = _a.sent();
                        this.alertService.danger(gettext('Could not set device protocol.'));
                        return [3 /*break*/, 4];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    LoraAssignDeviceProtocolComponent.ctorParameters = function () { return [
        { type: LoraSetDeviceProtocolService },
        { type: AlertService },
        { type: Router },
        { type: InventoryService }
    ]; };
    tslib_1.__decorate([
        ViewChild('loraSetDeviceProtocolForm', { static: false })
    ], LoraAssignDeviceProtocolComponent.prototype, "loraSetDeviceProtocolForm", void 0);
    LoraAssignDeviceProtocolComponent = tslib_1.__decorate([
        Component({
            selector: 'set-device-protocol',
            template: "<form #loraSetDeviceProtocolForm=\"ngForm\" class=\"row\">\n  <div class=\"col-md-6\">\n    <div class=\"card\">\n      <div class=\"card-header separator\">\n        <h4 class=\"card-title\">{{ 'LoRa device protocol' | translate }}</h4>\n      </div>\n      <div *ngIf=\"loading\" class=\"card-block\">\n        <div style=\"position: relative; min-height: 40px;min-width: 55px;\">\n          <div class=\"spinner\">\n            <div class=\"rect1\"></div>\n            <div class=\"rect2\"></div>\n            <div class=\"rect3\"></div>\n            <div class=\"rect4\"></div>\n          </div>\n        </div>\n        <span translate>Loading</span>\n      </div>\n      <div *ngIf=\"!loading\">\n        <div class=\"card-block\">\n          <div class=\"form-group\">\n            <label translate>Current device protocol</label>\n            <p class=\"form-control-static\" *ngIf=\"!currentProtocol\">\n              {{ 'c8y_LoriotLora' }}\n            </p>\n            <p class=\"form-control-static\" *ngIf=\"currentProtocol\">\n              {{ currentProtocol.name }}\n            </p>\n          </div>\n          <div class=\"form-group\">\n            <label translate>New device protocol</label>\n            <div class=\"c8y-select-wrapper\">\n              <select class=\"form-control\" [(ngModel)]=\"newProtocol\" name=\"newProtocol\" required>\n                <option *ngIf=\"!newProtocol\" [ngValue]=\"null\">\n                  {{ 'Select device protocol' | translate }}\n                </option>\n                <option\n                  *c8yFor=\"let protocol of availableProtocols; pipe: filterCurrentProtocol\"\n                  [ngValue]=\"protocol\"\n                >\n                  {{ protocol.name }}\n                </option>\n              </select>\n            </div>\n          </div>\n        </div>\n        <div class=\"card-footer separator\">\n          <button\n            title=\"{{ 'Apply' | translate }}\"\n            class=\"btn btn-primary\"\n            (click)=\"apply(newProtocol)\"\n            translate\n            [disabled]=\"!loraSetDeviceProtocolForm.dirty\"\n          >\n            Apply\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n</form>\n\u200C\n"
        })
    ], LoraAssignDeviceProtocolComponent);
    return LoraAssignDeviceProtocolComponent;
}());
export { LoraAssignDeviceProtocolComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9yYS1zZXQtZGV2aWNlLXByb3RvY29sLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvcHJvdG9jb2wtbG9yYS8iLCJzb3VyY2VzIjpbImxvcmEtc2V0LWRldmljZS1wcm90b2NvbC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQ2xGLE9BQU8sRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGNBQWMsRUFBRSxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDNUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDNUIsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBT3JDO0lBY0UsMkNBQ1UsV0FBeUMsRUFDekMsWUFBMEIsRUFDMUIsTUFBYyxFQUNkLGdCQUFrQztRQUo1QyxpQkFLSztRQUpLLGdCQUFXLEdBQVgsV0FBVyxDQUE4QjtRQUN6QyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQVg1QywwQkFBcUIsR0FBRyxJQUFJLENBQzFCLEdBQUcsQ0FBQyxVQUFDLFNBQTJCO1lBQzlCLE9BQUEsU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFBLFFBQVEsSUFBSSxPQUFBLENBQUMsS0FBSSxDQUFDLGVBQWUsSUFBSSxLQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsS0FBSyxRQUFRLENBQUMsRUFBRSxFQUFoRSxDQUFnRSxDQUFDO1FBQTlGLENBQThGLENBQy9GLENBQ0YsQ0FBQztJQVFFLENBQUM7SUFDQyxvREFBUSxHQUFkOzs7OzRCQUNFLHFCQUFNLElBQUksQ0FBQyxNQUFNLEVBQUUsRUFBQTs7d0JBQW5CLFNBQW1CLENBQUM7Ozs7O0tBQ3JCO0lBRUssa0RBQU0sR0FBWjs7Ozs7O3dCQUNFLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO3dCQUNwQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQzs7Ozt3QkFFdEIscUJBQU0sSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFBOzt3QkFBdkIsU0FBdUIsQ0FBQzt3QkFDeEIsS0FBQSxJQUFJLENBQUE7d0JBQXNCLHFCQUFNLElBQUksQ0FBQyxXQUFXLENBQUMscUJBQXFCLEVBQUUsRUFBQTs7d0JBQXhFLEdBQUssa0JBQWtCLEdBQUcsU0FBOEMsQ0FBQzt3QkFDekUsS0FBQSxJQUFJLENBQUE7d0JBQW1CLHFCQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFBOzt3QkFBN0UsR0FBSyxlQUFlLEdBQUcsU0FBc0QsQ0FBQzs7Ozt3QkFFOUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFFLENBQUMsQ0FBQzs7O3dCQUV2QyxJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQzs7Ozs7O0tBRXhCO0lBRUssc0RBQVUsR0FBaEI7Ozs7Ozt3QkFDUSxRQUFRLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ3JELHFCQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEVBQUE7O3dCQUFyRCxJQUFJLEdBQUssQ0FBQSxTQUE0QyxDQUFBLEtBQWpEO3dCQUNaLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDOzs7OztLQUNwQjtJQUVLLGlEQUFLLEdBQVgsVUFBWSxnQkFBZ0I7Ozs7Ozs7d0JBRXhCLHFCQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsZ0JBQWdCLENBQUMsRUFBQTs7d0JBQW5FLFNBQW1FLENBQUM7d0JBQ3BFLHFCQUFNLElBQUksQ0FBQyxNQUFNLEVBQUUsRUFBQTs7d0JBQW5CLFNBQW1CLENBQUM7d0JBQ3BCLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUM7d0JBQzNELElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7Ozs7d0JBRTlDLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDLENBQUM7Ozs7OztLQUV2RTs7Z0JBdENzQiw0QkFBNEI7Z0JBQzNCLFlBQVk7Z0JBQ2xCLE1BQU07Z0JBQ0ksZ0JBQWdCOztJQU5lO1FBQTFELFNBQVMsQ0FBQywyQkFBMkIsRUFBRSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQzt3RkFBZ0M7SUFaL0UsaUNBQWlDO1FBTDdDLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxxQkFBcUI7WUFDL0IsNHRFQUF3RDtTQUN6RCxDQUFDO09BRVcsaUNBQWlDLENBc0Q3QztJQUFELHdDQUFDO0NBQUEsQUF0REQsSUFzREM7U0F0RFksaUNBQWlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTG9yYVNldERldmljZVByb3RvY29sU2VydmljZSB9IGZyb20gJy4vbG9yYS1zZXQtZGV2aWNlLXByb3RvY29sLnNlcnZpY2UnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlLCBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBJTWFuYWdlZE9iamVjdCwgSW52ZW50b3J5U2VydmljZSwgSVJlc3VsdExpc3QgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgcGlwZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdzZXQtZGV2aWNlLXByb3RvY29sJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2xvcmEtc2V0LWRldmljZS1wcm90b2NvbC5jb21wb25lbnQuaHRtbCdcbn0pXG5cbmV4cG9ydCBjbGFzcyBMb3JhQXNzaWduRGV2aWNlUHJvdG9jb2xDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICBsb2FkaW5nOiBib29sZWFuO1xuICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0O1xuICBjdXJyZW50UHJvdG9jb2w6IElNYW5hZ2VkT2JqZWN0O1xuICBhdmFpbGFibGVQcm90b2NvbHM6IElSZXN1bHRMaXN0PElNYW5hZ2VkT2JqZWN0PjtcbiAgbmV3UHJvdG9jb2w6IElNYW5hZ2VkT2JqZWN0O1xuXG4gIGZpbHRlckN1cnJlbnRQcm90b2NvbCA9IHBpcGUoXG4gICAgbWFwKChwcm90b2NvbHM6IElNYW5hZ2VkT2JqZWN0W10pID0+XG4gICAgICBwcm90b2NvbHMuZmlsdGVyKHByb3RvY29sID0+ICF0aGlzLmN1cnJlbnRQcm90b2NvbCB8fCB0aGlzLmN1cnJlbnRQcm90b2NvbC5pZCAhPT0gcHJvdG9jb2wuaWQpXG4gICAgKVxuICApO1xuICBAVmlld0NoaWxkKCdsb3JhU2V0RGV2aWNlUHJvdG9jb2xGb3JtJywgeyBzdGF0aWM6IGZhbHNlIH0pIGxvcmFTZXREZXZpY2VQcm90b2NvbEZvcm06IGFueTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGxvcmFTZXJ2aWNlOiBMb3JhU2V0RGV2aWNlUHJvdG9jb2xTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICBwcml2YXRlIGludmVudG9yeVNlcnZpY2U6IEludmVudG9yeVNlcnZpY2VcbiAgKSB7IH1cbiAgYXN5bmMgbmdPbkluaXQoKSB7XG4gICAgYXdhaXQgdGhpcy5yZWxvYWQoKTtcbiAgfVxuXG4gIGFzeW5jIHJlbG9hZCgpIHtcbiAgICB0aGlzLmxvYWRpbmcgPSB0cnVlO1xuICAgIHRoaXMubmV3UHJvdG9jb2wgPSBudWxsO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmxvYWREZXZpY2UoKTtcbiAgICAgIHRoaXMuYXZhaWxhYmxlUHJvdG9jb2xzID0gYXdhaXQgdGhpcy5sb3JhU2VydmljZS5nZXRBdmFpbGFibGVQcm90b2NvbHMoKTtcbiAgICAgIHRoaXMuY3VycmVudFByb3RvY29sID0gYXdhaXQgdGhpcy5sb3JhU2VydmljZS5nZXRDdXJyZW50UHJvdG9jb2wodGhpcy5kZXZpY2UpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGV4KTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy5sb2FkaW5nID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbG9hZERldmljZSgpIHtcbiAgICBjb25zdCBkZXZpY2VJZCA9IHRoaXMucm91dGVyLnJvdXRlclN0YXRlLnNuYXBzaG90LnVybC5tYXRjaCgvXFxkKy8pWzBdO1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmRldGFpbChkZXZpY2VJZCk7XG4gICAgdGhpcy5kZXZpY2UgPSBkYXRhO1xuICB9XG5cbiAgYXN5bmMgYXBwbHkoc2VsZWN0ZWRQcm90b2NvbCkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmxvcmFTZXJ2aWNlLmFwcGx5UHJvdG9jb2wodGhpcy5kZXZpY2UsIHNlbGVjdGVkUHJvdG9jb2wpO1xuICAgICAgYXdhaXQgdGhpcy5yZWxvYWQoKTtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnN1Y2Nlc3MoZ2V0dGV4dCgnRGV2aWNlIHByb3RvY29sIHNldC4nKSk7XG4gICAgICB0aGlzLmxvcmFTZXREZXZpY2VQcm90b2NvbEZvcm0ucmVzZXQoJ2RpcnR5Jyk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmRhbmdlcihnZXR0ZXh0KCdDb3VsZCBub3Qgc2V0IGRldmljZSBwcm90b2NvbC4nKSk7XG4gICAgfVxuICB9XG59XG4iXX0=