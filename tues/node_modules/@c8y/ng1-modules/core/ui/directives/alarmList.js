"use strict";function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}}function _iterableToArray(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?Object(arguments[t]):{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(t){return Object.getOwnPropertyDescriptor(r,t).enumerable}))),n.forEach(function(t){_defineProperty(e,t,r[t])})}return e}function _defineProperty(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}!function(){t.$inject=["$q","$injector","$window","c8yAlarms","c8yAlert","c8yInventory","c8yBase","c8yRealtime","c8yUser","c8yConfig","c8ySmartRulesAvailability","gettextCatalog"];var Q="c8yAlarmList";function t(x,P,U,K,z,B,G,V,H,M,q,J){return{restrict:"EA",scope:{severities:"=?activeSeverities",options:"=?filter",realtime:"=?",hideHeaderActions:"=?",title:"=?",unresolved:"=?",paginate:"=?",refreshLoading:"=?",hideDevice:"=?"},templateUrl:":::PLUGIN_PATH:::/ui/views/alarmList.html",link:function(a,t,i){var n={};function o(t){K.detail(t).then(_.partial(e,t))}function e(t,e){var r=x.when(t);return n[t.id]&&(r=r.then(a.auditRefresh[t.id])),r.then(function(){_.assign(t,e.data)})}function r(t){if(!a.auditList||!a.auditList[t.id])return J.getString("ACKNOWLEDGED");var e=a.auditList[t.id],r=K.ackTime(t,e),n={ackBy:K.acknowledgedBy(t,e),ackTimeFromNow:moment(r).fromNow()};return J.getString("ACKNOWLEDGED by: {{ackBy}} {{ackTimeFromNow}}",n)}function u(t){if(!a.auditList||!a.auditList[t.id])return J.getString("CLEARED");var e={alarmDuration:K.alarmDuration(t,a.auditList[t.id])};return J.getString("CLEARED: was active for {{alarmDuration}}",e)}function s(t){var e={alarmTimeFromNow:moment(t.time).fromNow()};return J.getString("ACTIVE: triggered {{alarmTimeFromNow}}",e)}function c(t){var e=!0;return i.activeSeverities&&(e=_.isEmpty(a.severities)||a.severities[t.severity]),e&&!((a.unresolved||!1===(a.options&&a.options.resolved))&&"CLEARED"===t.status)}function l(t){var e=!0,r=_.get(a.options,"status");return _.isUndefined(r)||(e=Boolean(r[t.status])),e}function f(){return a.refreshLoading?x.resolve():(a.refreshLoading=!0,a.alarms=[],a.auditList={},n={},a.options=a.options||{},a.options.type&&(a.options.types=[a.options.type]),function(){if(!S(a.options).byDevices())return x.reject();var t=W();if(t.length<=0)return x.reject();var e=_.map(t,function(t){return K.list(_objectSpread({source:t,withSourceDevices:!0,withSourceAssets:!0,resolved:a.options.resolved,pageSize:I()},v()))});return x.all(e).then(G.combineLists)}().catch(h).catch(p).catch(y).catch(d).then(g).finally(function(){a.refreshLoading=!1}))}function d(){var t={pageSize:I()};return K.list(t)}a.refreshLoading=!1;var m=_.throttle(function(){a.refreshLoading||(a.paging.loading=!0,a.refreshLoading=!0,a.realtimeAnimation=!1,a.paging.next().then(function(t){_.forEach(t,function(t){a.alarms.push(t)}),a.paging.loading=!1,a.refreshLoading=!1,a.paging=t.paging}))},300,{trailing:!0});function y(){if(!S(a.options).bySeverity())return x.reject();var t={severity:a.options.severity,resolved:a.options.resolved,pageSize:I()};return G.timeOrderFilter(t),K.list(t)}function p(){return S(a.options).byStatus()?K.listByStatus(a.options.status,_objectSpread({pageSize:I()},v())):x.reject()}function v(){var t=_.reduce(a.severities,function(t,e,r){return e?[].concat(_toConsumableArray(t),[r]):t},[]);return 1===t.length?{severity:_.head(t)}:{}}function h(){if(!S(a.options).byType())return x.reject();var e=a.options.types,t=_objectSpread({pageSize:I()},v());return 1===e.length&&(t.type=e[0]),K.list(t).then(function(t){return _.filter(t,function(t){return _.includes(e,t.type)})})}function g(t){var e=t;(function(){if(i.paginate&&!a.paginate)return!1;if(void 0!==a.unresolved||i.severities)return!1;var t=a.options;if(!t)return!0;if(t.source)return!0;var e=S(t),r=[e.byType()?1:0,e.byStatus()&&function(t){return _.reduce(t,function(t,e){return e?t+1:t},0)}(_.values(t.status))||0,e.bySeverity()?1:0];return _.sum(r)<=1})()&&(a.paging=e.paging);var r=a.options;if(r){var n=S(r);e=_.filter(e,function(t){return(!n.byType()||_.includes(r.types,t.type))&&(!n.byStatus()||r.status[t.status])&&(!n.bySeverity()||r.severity===t.severity)})}return a.alarms=e}function b(t){var e=[["severity","time"],["asc","desc"]];if("ACTIVE_FIRST"===a.options.orderMode){var r={ACTIVE:1,ACKNOWLEDGED:0,CLEARED:-1};e=[[function(t){return r[t.status]},"severity","time"],["desc","asc","desc"]]}var n=_(t).filter(c).filter(l).orderBy(e[0],e[1]).value(),i=_.get(a,"options.displayFilter");return i&&(n=_.filter(n,i)),a.filteredAlarms=n}function S(e){function t(t){return function(){return e&&!!t}}var r=e||{};return{byType:t(!_.isEmpty(r.types)),byStatus:t(r.status&&!_.isEmpty(r.status)&&function(t){return _.some(t,function(t){return!0===t})}(r.status)),bySeverity:t(r.severity),byDevices:function(){return t(!_.isEmpty(W()))}}}function A(){a.realtimeAnimation=!1,f()}function L(t,e){if(a.realtimeAnimation=!0,j(e,a.options)){var r=_.find(a.alarms,{id:e.id});r?w(e,r):E(e)}}function E(t){var e=E._executing;if(e)return e.creating=!0,x.reject(e);var r=R(t).then(function(t){a.alarms.unshift(t)}).finally(function(){E._executing=null});return E._executing=r}function w(e,t){var r=R(e,t.source.name);return n[e.id]&&(r=r.then(a.auditRefresh[e.id])),r.then(function(){a.realtimeAnimation=!0;var t=_.findIndex(a.alarms,{id:e.id});a.alarms[t]=e})}function D(t){_.remove(a.alarms,{id:t.id}),delete a.auditList[t.id],delete n[t.id]}function T(t,r){a.realtimeAnimation=!0,!_.some(a.alarms,function(t){var e;return t.id===r.id&&(j(r,a.options)?w(r,t):D(r),e=!0),e})&&j(r,a.options)&&E(r).catch(function(e,r){return function(t){return t&&t.creating&&_.isFunction(t.then)?t.then(_.partial(T,e,r)):x.reject(t)}}(t,r))}function C(t,e){var r;return a.realtimeAnimation=!0,_.forEach(a.alarms,function(t){t.id===e.id&&(D(e),r=!1)}),r}function R(e,t){var r=x.resolve(e);return _.defaultsDeep(e,{source:{name:t}}),!e.source.name&&e.source.id&&(r=function(t){return B.detail(t).then(G.getResData).then(function(t){return t.name})}(e.source.id).then(function(t){e.source.name=t}).then(function(){return e})),r}function j(t,e){return function(r,t){return!t||_.some(t,function(t,e){return t&&e===r.status})}(t,e.status)&&function(t,e){return _.isEmpty(e)||_.includes(e,t.type)}(t,e.types)&&function(t,e){return!e||e===t.severity}(t,e.severity)}function I(){return a.options&&Number(a.options.pageSize)||20}function k(){V.switchRealtime(a.$id,a.realtimeChannel)}function O(){return V.getStatus(a.$id,a.realtimeChannel)}function $(t,e){V.addListener(a.$id,a.realtimeChannel,t,e)}function N(){var t=a.realtimeChannel,e=function(){var t=W();return"/alarmsWithChildren/".concat(t.length?t.join(","):"*")}();if(t){if(e===t)return;V.removeSubscriber(a.$id,t),a.cancelDestroyRemoveSubscriber(),a.stopWatchingRealtime()}a.realtimeChannel=e,$("".concat(a.$id,"-subscribed"),A),$("CREATE",L),$("UPDATE",T),$("DELETE",C),a.cancelDestroyRemoveSubscriber=a.$on("$destroy",function(){return V.removeSubscriber(a.$id,a.realtimeChannel)}),a.stopWatchingRealtime=a.$watch("realtime",F),a.realtime&&k()}function W(){var t=a.options,e=t.source,r=t.sources,n=_.concat(r,e);return _(n).map(function(t){return G.hasId(t)&&G.getId(t)}).compact().value()}function F(){a.realtime&&f(),a.realtime!==O()&&k()}a.auditRefresh={},a.statusText=function(t){var e;switch((t.status||"").toUpperCase()){case K.status.ACKNOWLEDGED:e=r;break;case K.status.CLEARED:e=u;break;case K.status.ACTIVE:e=s;break;default:e=function(){return""}}return e(t)},a.isActive=function(t){return t.status===K.status.ACTIVE},a.toggle=function(t){n[t.id]=!n[t.id]},a.isOpen=function(t){return!0===n[t.id]},a.isNarrow=function(){return a.containerWidth<=991},a.changeStatus=function(t,e){a.changingStatus=!0;var r=J.getString('Alarm status changed to "{{status | translate}}".',{status:e}),n=K.update({id:t.id,status:e});return O()||(n=n.then(_.partial(o,t))),(n=n.then(function(){z.success(r)})).finally(function(){a.changingStatus=!1})},a.isFitSeverity=c,a.icon=K.icon,a.getStandardKeys=K.getStandardKeys.bind(K),a.getNonStandardKeys=K.getNonStandardKeys.bind(K),a.alarmDuration=function(t){return a.auditList&&a.auditList[t.id]?K.alarmDuration(t,a.auditList[t.id]):""},a.refresh=f,a.loadNext=m,a.createSmartRule=function(e){var t;return a.smartRules&&(t=H.current().then(function(t){return a.smartRulesSvc.addNewForInputAlarmAndOutputUserWithUI(e,t)})),t},a.translateAlarmText=function(t){return J.getString(t.text)},a.getDeviceLinkFromAlarm=_.memoize(function(t){var e=M[Q]||{};return e.getDeviceLinkFromAlarm?e.getDeviceLinkFromAlarm(t):["#","device",t.source.id].join("/")},function(t){return t.id}),a.$watch(function(){return{containerWidth:t.parent().width(),windowWidth:U.innerWidth}},function(t){a.containerWidth=t.containerWidth||t.windowWidth},!0),a.$watch("alarms",b,!0),a.$watch("severities",function(){f().then(function(){return b(a.alarms)})},!0),a.$on("alarmListRefresh",f),i.filter?a.$watch("options",function(){f().then(N)},!0):a.realtime||f(),q.shouldShowGlobalSmartRules().then(function(t){a.smartRules=t&&G.checkIfModulesExist(["c8y.cockpit.config"])}).then(function(){a.smartRules&&(a.smartRulesSvc=P.get("smartRulesSvc"))})}}}angular.module("c8y.ui").directive(Q,t)}();